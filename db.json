{"meta":{"version":1,"warehouse":"4.0.2"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":1,"renderable":0},{"_id":"themes/hexo-theme-matery/source/favicon.png","path":"favicon.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/barrager.css","path":"css/barrager.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/bb.css","path":"css/bb.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/dark.css","path":"css/dark.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/gallery.css","path":"css/gallery.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/gitment.css","path":"css/gitment.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/indexcover.css","path":"css/indexcover.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/matery.css","path":"css/matery.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/my-gitalk.css","path":"css/my-gitalk.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/my.css","path":"css/my.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/post.css","path":"css/post.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/css/reward.css","path":"css/reward.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/js/crypto-js.js","path":"js/crypto-js.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/js/gallery-encrypt.js","path":"js/gallery-encrypt.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/js/jquery.barrager.js","path":"js/jquery.barrager.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/js/matery.js","path":"js/matery.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/js/search.js","path":"js/search.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/js/tw_cn.js","path":"js/tw_cn.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/avatar.jpg","path":"medias/avatar.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/comment_bg.png","path":"medias/comment_bg.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/cover.jpg","path":"medias/cover.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/icp.png","path":"medias/icp.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/logo.png","path":"medias/logo.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/animate/animate.min.css","path":"libs/animate/animate.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/aos/aos.css","path":"libs/aos/aos.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/aos/aos.js","path":"libs/aos/aos.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/APlayer.min.css","path":"libs/aplayer/APlayer.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/APlayer.min.js","path":"libs/aplayer/APlayer.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/Meting.min.js","path":"libs/aplayer/Meting.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/background/canvas-nest.js","path":"libs/background/canvas-nest.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/background/ribbon-dynamic.js","path":"libs/background/ribbon-dynamic.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/background/ribbon-refresh.min.js","path":"libs/background/ribbon-refresh.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/background/ribbon.min.js","path":"libs/background/ribbon.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/codeBlock/codeBlockFuction.js","path":"libs/codeBlock/codeBlockFuction.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/codeBlock/codeCopy.js","path":"libs/codeBlock/codeCopy.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/codeBlock/codeLang.js","path":"libs/codeBlock/codeLang.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/codeBlock/codeShrink.js","path":"libs/codeBlock/codeShrink.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/cryptojs/crypto-js.min.js","path":"libs/cryptojs/crypto-js.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/dplayer/DPlayer.min.css","path":"libs/dplayer/DPlayer.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/dplayer/DPlayer.min.js","path":"libs/dplayer/DPlayer.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/echarts/echarts.min.js","path":"libs/echarts/echarts.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/fancybox/fancybox.js","path":"libs/fancybox/fancybox.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/fancybox/jquery.fancybox.css","path":"libs/fancybox/jquery.fancybox.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/gitalk/gitalk.css","path":"libs/gitalk/gitalk.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/gitalk/gitalk.min.js","path":"libs/gitalk/gitalk.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/gitment/gitment-default.css","path":"libs/gitment/gitment-default.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/gitment/gitment.js","path":"libs/gitment/gitment.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/instantpage/instantpage.js","path":"libs/instantpage/instantpage.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/jqcloud/jqcloud-1.0.4.min.js","path":"libs/jqcloud/jqcloud-1.0.4.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/jqcloud/jqcloud.css","path":"libs/jqcloud/jqcloud.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/jquery/jquery-3.6.0.min.js","path":"libs/jquery/jquery-3.6.0.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/justifiedGallery/justifiedGallery.min.css","path":"libs/justifiedGallery/justifiedGallery.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/justifiedGallery/justifiedGallery.min.js","path":"libs/justifiedGallery/justifiedGallery.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/masonry/masonry.pkgd.min.js","path":"libs/masonry/masonry.pkgd.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/materialize/materialize.min.css","path":"libs/materialize/materialize.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/materialize/materialize.min.js","path":"libs/materialize/materialize.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/mermaid/mermaid.js","path":"libs/mermaid/mermaid.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/mermaid/mermaid.min.css","path":"libs/mermaid/mermaid.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/mermaid/mermaid.min.js","path":"libs/mermaid/mermaid.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/minivaline/MiniValine.js","path":"libs/minivaline/MiniValine.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/TencentCaptcha.js","path":"libs/others/TencentCaptcha.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/busuanzi.pure.mini.js","path":"libs/others/busuanzi.pure.mini.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/clicklove.js","path":"libs/others/clicklove.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/sakura-half.js","path":"libs/others/sakura-half.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/sakura-reduce.js","path":"libs/others/sakura-reduce.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/sakura-small.js","path":"libs/others/sakura-small.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/sakura.js","path":"libs/others/sakura.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/snow.js","path":"libs/others/snow.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/others/star.js","path":"libs/others/star.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/prism/prism.min.css","path":"libs/prism/prism.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/prism/prism.min.js","path":"libs/prism/prism.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/scrollprogress/scrollProgress.min.js","path":"libs/scrollprogress/scrollProgress.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/tocbot/tocbot.css","path":"libs/tocbot/tocbot.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/tocbot/tocbot.min.js","path":"libs/tocbot/tocbot.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/twikoo/twikoo.all.min.js","path":"libs/twikoo/twikoo.all.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/twikoo/twikoo.all.min.js.LICENSE.txt","path":"libs/twikoo/twikoo.all.min.js.LICENSE.txt","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/typed/typed.js","path":"libs/typed/typed.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/valine/Valine.min.js","path":"libs/valine/Valine.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/valine/av-min.js","path":"libs/valine/av-min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/waline/Waline.min.js","path":"libs/waline/Waline.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/0.jpg","path":"medias/banner/0.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/1.jpg","path":"medias/banner/1.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/2.jpg","path":"medias/banner/2.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/3.jpg","path":"medias/banner/3.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/4.jpg","path":"medias/banner/4.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/5.jpg","path":"medias/banner/5.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/banner/6.jpg","path":"medias/banner/6.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/barrager/0.png","path":"medias/barrager/0.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/barrager/1.png","path":"medias/barrager/1.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/barrager/2.png","path":"medias/barrager/2.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/barrager/close.png","path":"medias/barrager/close.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/0.jpg","path":"medias/featureimages/0.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/1.jpg","path":"medias/featureimages/1.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/10.jpg","path":"medias/featureimages/10.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/11.jpg","path":"medias/featureimages/11.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/12.jpg","path":"medias/featureimages/12.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/13.jpg","path":"medias/featureimages/13.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/14.jpg","path":"medias/featureimages/14.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/15.jpg","path":"medias/featureimages/15.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/16.jpg","path":"medias/featureimages/16.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/17.jpg","path":"medias/featureimages/17.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/18.jpg","path":"medias/featureimages/18.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/19.jpg","path":"medias/featureimages/19.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/2.jpg","path":"medias/featureimages/2.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/20.jpg","path":"medias/featureimages/20.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/21.jpg","path":"medias/featureimages/21.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/22.jpg","path":"medias/featureimages/22.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/23.jpg","path":"medias/featureimages/23.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/3.jpg","path":"medias/featureimages/3.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/4.jpg","path":"medias/featureimages/4.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/5.jpg","path":"medias/featureimages/5.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/6.jpg","path":"medias/featureimages/6.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/7.jpg","path":"medias/featureimages/7.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/8.jpg","path":"medias/featureimages/8.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/9.jpg","path":"medias/featureimages/9.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/images/01.jpg","path":"medias/images/01.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/images/02.jpg","path":"medias/images/02.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/images/03.jpg","path":"medias/images/03.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/reward/alipay.jpg","path":"medias/reward/alipay.jpg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/medias/reward/wechat.png","path":"medias/reward/wechat.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/css/all.css","path":"libs/awesome/css/all.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/css/all.min.css","path":"libs/awesome/css/all.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-brands-400.ttf","path":"libs/awesome/webfonts/fa-brands-400.ttf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-brands-400.woff2","path":"libs/awesome/webfonts/fa-brands-400.woff2","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-regular-400.ttf","path":"libs/awesome/webfonts/fa-regular-400.ttf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-regular-400.woff2","path":"libs/awesome/webfonts/fa-regular-400.woff2","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-solid-900.ttf","path":"libs/awesome/webfonts/fa-solid-900.ttf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-solid-900.woff2","path":"libs/awesome/webfonts/fa-solid-900.woff2","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-v4compatibility.ttf","path":"libs/awesome/webfonts/fa-v4compatibility.ttf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-v4compatibility.woff2","path":"libs/awesome/webfonts/fa-v4compatibility.woff2","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/css/lightgallery.min.css","path":"libs/lightGallery/css/lightgallery.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.svg","path":"libs/lightGallery/fonts/lg.svg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.ttf","path":"libs/lightGallery/fonts/lg.ttf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.woff","path":"libs/lightGallery/fonts/lg.woff","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/loading.gif","path":"libs/lightGallery/img/loading.gif","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/video-play.png","path":"libs/lightGallery/img/video-play.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/vimeo-play.png","path":"libs/lightGallery/img/vimeo-play.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/youtube-play.png","path":"libs/lightGallery/img/youtube-play.png","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/js/lightgallery-all.min.js","path":"libs/lightGallery/js/lightgallery-all.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/css/share.min.css","path":"libs/share/css/share.min.css","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.eot","path":"libs/share/fonts/iconfont.eot","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.svg","path":"libs/share/fonts/iconfont.svg","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.ttf","path":"libs/share/fonts/iconfont.ttf","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.woff","path":"libs/share/fonts/iconfont.woff","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/js/jquery.share.min.js","path":"libs/share/js/jquery.share.min.js","modified":1,"renderable":1},{"_id":"themes/hexo-theme-matery/source/libs/share/js/social-share.min.js","path":"libs/share/js/social-share.min.js","modified":1,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"8ba167d170d161a56ba83aa66f4d4e009821b26f","modified":1714180505198},{"_id":"source/_data/friends.json","hash":"04ea2cc6260af85d16b00a3f7c5a6c83d61d0421","modified":1713583117501},{"_id":"source/_posts/At-the-end-of-2023.md","hash":"131978a83d09638dc35cdd70ec9d6b4f5445e25f","modified":1713583117501},{"_id":"source/_posts/DNS-server.md","hash":"71fd28b370ad640e9ea1417ebb7940dca08f70de","modified":1713583117501},{"_id":"source/_posts/FRP 穿透并代理到ingressroute.md","hash":"f8013dfea75b59534a0b63d539cb392aa6130a2b","modified":1713583117501},{"_id":"source/_posts/Failed-to-Post-Blog.md","hash":"7db27c6df8e929fe5739afe15254b738baaef6d5","modified":1713583117501},{"_id":"source/_posts/Instantbox-Customize.md","hash":"cf1fd35707804b587a2452fd1e885ee6ec8aee21","modified":1713583117501},{"_id":"source/_posts/Multiple-Domians-in-OpenLDAP-Use-Case.md","hash":"109ee8133234bb08fce323ce8956b990493b7638","modified":1713583117501},{"_id":"source/_posts/Overleaf-self-hosted.md","hash":"0ae3ec1e30a9da6a5aeb1051a2729ac164b1708e","modified":1713583117501},{"_id":"source/_posts/The-First-time-using-Helm-Charts.md","hash":"472f785c2fe0bf64b89eac50669700ec6c6a5e75","modified":1713583117501},{"_id":"source/_posts/blog-with-cdn.md","hash":"6aef3a7671ed23e11390437f77648355a2b1055e","modified":1714182236256},{"_id":"source/_posts/cert-manager.md","hash":"e73bab55143d397372302d24a8dcc2ce155217e4","modified":1714494400775},{"_id":"source/_posts/clickhouse.md","hash":"e11b48bb5da154bcfaa967856f7138bb67fb06e0","modified":1714495420402},{"_id":"source/_posts/deploy-hexo.md","hash":"5d29470ee8060fe5ae550ff4e32402b20aaa312a","modified":1714028891498},{"_id":"source/_posts/domain-management.md","hash":"c0aef1e1badf32ba99b8fb1fe4e38148a0c72132","modified":1714490401112},{"_id":"source/_posts/homelab-pc.md","hash":"ff9e533b56985f2d92727b0860b85180dffbd945","modified":1713583117505},{"_id":"source/_posts/instant-box.md","hash":"e6791997225fbf7749c628db38fc21a43c7a9db2","modified":1713583117505},{"_id":"source/_posts/kube-Prometheus-stack.md","hash":"4d2836915e54ebaca12665f81250bda07ed652a2","modified":1714497029901},{"_id":"source/_posts/post-img.md","hash":"3986caee90f0692c287d3194384aeaa958582b60","modified":1713583117505},{"_id":"source/_posts/在hexo中展示思维导图.md","hash":"e4bc9a0a54da7dd3ed15264dc9cbb11028b3d59c","modified":1713583117505},{"_id":"source/_posts/这是一封信.md","hash":"7badd27189ab6150eba71480f237ed5b47ab73fb","modified":1714795006552},{"_id":"source/about/index.md","hash":"c5fb0a7d39856f05dc82f9e3540a7629067161bb","modified":1713583117505},{"_id":"source/categories/index.md","hash":"cbed6c3c8cbdbb293e36ad373595879611cd2d3b","modified":1713583117505},{"_id":"source/contact/index.md","hash":"adc8dfbc68c1c15aae44c6ebe6981f93c452664e","modified":1713583117505},{"_id":"source/friends/index.md","hash":"7442003203b8a461d205694fcddee9bbe4700d8e","modified":1713583117505},{"_id":"source/tags/index.md","hash":"ff4acd728cd336417c119f39582dc57a1df583f6","modified":1713583117505},{"_id":"source/_posts/metrics/bind-exporter.md","hash":"5fa88fb27d8cf5442709afab3e8758e12baae2ba","modified":1714494091448},{"_id":"source/_posts/metrics/kafka-exporter.md","hash":"3f564d99404bfcdc29a3c92ba79e17eed20ccdb5","modified":1714494388695},{"_id":"source/_posts/metrics/mysqld-exporter.md","hash":"e3c71b797fb06ec5fa997b68f7e517dcd3aafee9","modified":1714494372675},{"_id":"source/_posts/metrics/redis-exporter.md","hash":"adf60d391df2790315a6d97827a8ec305aa31c47","modified":1714494515975},{"_id":"source/_posts/metrics/vault.md","hash":"8d89d173ed0135a5d2441179a1f5b965eb2eac87","modified":1714496155751},{"_id":"source/_posts/四千周/四千周.md","hash":"1ec227d9c18e5f046ddf9d16b4c2135fb2c72513","modified":1714743979907},{"_id":"themes/hexo-theme-matery/CHANGELOG.md","hash":"e0ecf288c534613fc37c957a9886e95ebdd015db","modified":1713583117505},{"_id":"themes/hexo-theme-matery/LICENSE","hash":"7df059597099bb7dcf25d2a9aedfaf4465f72d8d","modified":1713583117505},{"_id":"themes/hexo-theme-matery/README.md","hash":"9d98fe84a60bd6b222740f238d83f0999eaa77a3","modified":1713583117505},{"_id":"themes/hexo-theme-matery/README_CN.md","hash":"497c6645c55dce9f190ec7625de76083262e1707","modified":1713583117505},{"_id":"themes/hexo-theme-matery/_config.yml","hash":"d7812f8bbd99eea2e960370e6193d2457c26e299","modified":1714028813872},{"_id":"themes/hexo-theme-matery/languages/default.yml","hash":"2ed57824573d7bed71e56023ed92500734a8886d","modified":1713583117505},{"_id":"themes/hexo-theme-matery/languages/jp.yml","hash":"a811cec0b6d91f405e8c7386a57039cd8c3448bb","modified":1713583117505},{"_id":"themes/hexo-theme-matery/languages/zh-CN.yml","hash":"a2695fdb7579a77daec7773a9bb8e71b9edbf16b","modified":1713583117505},{"_id":"themes/hexo-theme-matery/languages/zh-HK.yml","hash":"51c06005927e8bde5b3e23353d2bf2c32ed855f3","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/404.ejs","hash":"36f8d3e530e8144bf80d0772284edd9b0da362fe","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/about.ejs","hash":"99a74316aed478efb0db823c4460ee2e660f101c","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/archive.ejs","hash":"cdac701de8370f9f3794a0eed4165983993a1ca7","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/bb.ejs","hash":"21959d702f17a3d98b716daf44c8b5eecd59c7c5","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/categories.ejs","hash":"8e54665cc25d7c333da7d9f312987190be6215da","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/category.ejs","hash":"00019bca11fb46477f22017cb1f5ad8444da0580","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/contact.ejs","hash":"71ef2540fa586cd0c3b1f216f59fa9ec85fc6a38","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/friends.ejs","hash":"534511d9f38f281b531e24c19d9c1526cc7e5e27","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/galleries.ejs","hash":"85b8b9e583ffa7a4ee6d0c2be4779cb2f7d91777","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/gallery.ejs","hash":"fcc7364b03329148ba4920cddb0d34d5b7410788","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/index.ejs","hash":"1656c2db90e24a360282d15c71144b4f14edb43d","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/layout.ejs","hash":"94c2fee85418370ca8f7d54050c852267e924eb7","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/movies.ejs","hash":"abce85ffdd99e787e3652fbd466447e032b626bd","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/musics.ejs","hash":"9ac6053e09ed2c8a844d7e93c3fdce4ded95248a","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/post.ejs","hash":"3d4f40121dbb75bcb71837c35ec5ee17cdffae31","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/tag.ejs","hash":"85a4b05bd8a6ad0f17ff2e97dae56949b379c204","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/tags.ejs","hash":"cf9517aa6a0111355121f44615d6923e312283c7","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/favicon.png","hash":"42e062af5524c84f6246cc3988a090a722b72bf1","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/back-top.ejs","hash":"47ee36a042bb6d52bbe1d0f329637e8ffcf1d0aa","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/background.ejs","hash":"12350c0d366141b5c27792bb414d4adc303b0a9f","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/baidu-analytics.ejs","hash":"3bbcdb474ca1dcad514bdc4b7763e17c55df04fd","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/baidu-push.ejs","hash":"2cebcc5ea3614d7f76ec36670e68050cbe611202","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/bg-cover-content.ejs","hash":"c7d922da21cfe970634ab912b958d7d1e9f06f9e","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/bg-cover.ejs","hash":"02191109712f61c0e487b8f0b8466597181a9004","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/bg-video.ejs","hash":"963422029eb5158eb5f5bc97ce19b66e5399db97","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/changyan.ejs","hash":"cd919d31564e118c2ee8d5cbfb7d51ee6da15d82","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/codeblock.ejs","hash":"086a06863a0f88888707409936aa06a09ff50e3a","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/cover-style.ejs","hash":"4288b9d91b2d71404e7a509a81a5d7f7a4b8b5e8","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/disqus.ejs","hash":"b2dc2c8b5ed56815e55cc2ea54a6dc4eeba2375d","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/footer.ejs","hash":"e8958bc066b3c2fcd4152604cc12f30020106848","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/gitalk.ejs","hash":"2aa8fbb04b046fa7679092a48372d7e036835dff","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/github-link.ejs","hash":"3aeb581bd78ab8e15b858e4c44c03bcf92f20b9e","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/gitment.ejs","hash":"90f6218512ef2eab63ada7ad2fc766ae635a2297","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/google-analytics.ejs","hash":"5f4992205617da5f8cc5863c62b5ec46e414e2fb","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/head.ejs","hash":"f5c00f21af281a09dc7de89e82a3b442903451a7","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/header.ejs","hash":"59e38c70f3d8e7165e686e5e84a627835f4321b0","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/index-cover.ejs","hash":"e8b44268b59add61af44b7338527523d10d9d742","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/livere.ejs","hash":"9c3401b42ea7f26410a5593bae93ada7e57b43be","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/main-style.ejs","hash":"8819b334509682355a5e53fa0f307f90166d175c","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/mobile-nav.ejs","hash":"52de0cf3ce13a3477b0a1659d2b8aa41db1f622d","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/navigation.ejs","hash":"0953217f4e19a51dfc5a0ffc7d066406df18060b","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/paging.ejs","hash":"e2df12cf92a82b1a7a7add2eac1db1d954bc5511","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/post-cover.ejs","hash":"d1c873c5de54498c722e155aadb8c0ec39485dfa","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/post-detail-toc.ejs","hash":"70fccaea75ce48364222c4e5de0496e556b01cb1","modified":1713583117505},{"_id":"themes/hexo-theme-matery/layout/_partial/post-detail.ejs","hash":"6261f8191c3c1159f63ec7f9293bb93f7d2a3dbb","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/post-statis.ejs","hash":"04889f9031743c6b081d02fa4027b0dbfcc45ecf","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/post-style.ejs","hash":"243c3ba783553f25955d524fd47a5bb59a5e732b","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/prev-next.ejs","hash":"c76b78782ea82340104fccc089417572e0adece4","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/reprint-statement.ejs","hash":"0ce3f9361f558b99cc2f059c5e50b0e2a152ae38","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/reward-style.ejs","hash":"8256ed940c0185ccf01890d59fb4262f196e2323","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/reward.ejs","hash":"236668e72b01db91f5bf29eec4c79e34e2746d98","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/search.ejs","hash":"150529c9fb9aa8ddb42ec3e02645d301faa2503b","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/share.ejs","hash":"c941730a2471d6aab367cbb6e09ed08b56c83143","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/social-link.ejs","hash":"21d69b74e923183933baedfc1c5d9c17b81cc68a","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/twikoo.ejs","hash":"f9cb8c82b9d2a7cdb644e10718f1cdeb9400414c","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/valine.ejs","hash":"2ac48566bb806336f1e5bc5c66fc816a580d63c3","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_partial/waline.ejs","hash":"2658cb73ef984a30b248351d7858ee15596a6e7a","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/artitalk.ejs","hash":"b14e486f12b9ac42a273b80e4d785fcb94cf04b2","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/category-cloud.ejs","hash":"1b3df1009234c0112424b497b18b4ad8240b3bc7","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/category-radar.ejs","hash":"1d8747fda89a0b2ca3c7008867cbfeecad0578a6","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/day-night.ejs","hash":"ff21dd5e49e1fc9a9ab8c7d164fd4b32a8265ea2","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/dream.ejs","hash":"9a472ad5591100cdb65d0df9d01034163bd6dd9d","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/music.ejs","hash":"bb25a6fa51eb5ebfba687b2cbadff6c7a4b4bfef","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/musics.ejs","hash":"bfebdf0731fee0cd4fd51efa0da1d0184565ae25","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/my-gallery.ejs","hash":"65a2d2f9722f84c7fd98f6bdf79087a14848ebd8","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/my-projects.ejs","hash":"ef60b64021fa349b0048425d858dfcf6c906fede","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/my-skills.ejs","hash":"89a0092df72d23093128f2fbbdc8ca7f83ebcfd9","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/post-calendar.ejs","hash":"48821e644bc73553d7c5c56d2e8ee111a70cd776","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/post-charts.ejs","hash":"ab5f986f428215941aeaa0c88aefd440c47d3bcf","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/recommend.ejs","hash":"8551137e94ca4e2e3b8b63d5626255884cb60cb5","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/tag-cloud.ejs","hash":"fc42b72cddc231f7485cdc1fd6852b66be6add26","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/tag-wordcloud.ejs","hash":"487aacb2454d6bf0d21cdb07ddd1fd5ddbca9038","modified":1713583117509},{"_id":"themes/hexo-theme-matery/layout/_widget/video.ejs","hash":"5e5ec78f8ab229d54786ef2e0ea2864af2dc459f","modified":1713583117509},{"_id":"themes/hexo-theme-matery/scripts/tags/button.js","hash":"ab02fb2da648f4f7afa0c2381aaca334bdeb54e6","modified":1713583117509},{"_id":"themes/hexo-theme-matery/scripts/tags/index.js","hash":"223a31ea3aa4a689d45a033c7d680cb4fff8d8af","modified":1713583117509},{"_id":"themes/hexo-theme-matery/scripts/tags/note.js","hash":"84b0122b92342834540f69b19600cb54c50ab69e","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/barrager.css","hash":"862879d9313ed8d4c721fa32ef8f94ac2f0a28ae","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/bb.css","hash":"aa15633888c7cf9baea8bb48d796c68b57cf14bf","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/dark.css","hash":"be4ef08494f3c965d513d9413685c0e723f671cd","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/gallery.css","hash":"015097ca1271dd44e6d663332587dbe58ae2ade8","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/gitment.css","hash":"2bd15cc17dca35ac3ecc0acf167a23a1dd362acd","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/indexcover.css","hash":"00f4f498ae8514022004f2281cab8ff304cd0f37","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/matery.css","hash":"d5436e7e7f8c55027d555f1aed8f568b32c82331","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/my-gitalk.css","hash":"af18dd29e58642c18bab9b89541767b494c468dd","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/my.css","hash":"497e50351f7838f8546cac76850a42e7e380a110","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/post.css","hash":"1ebbf9ddee7db4b3039d8d4e25f2605072ab6e24","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/css/reward.css","hash":"56f8d21c3bb1dc57c762a63d13b08161d8260738","modified":1713583117509},{"_id":"themes/hexo-theme-matery/source/js/gallery-encrypt.js","hash":"f611a391d62da17b71f75577a72ad246ef6c5a71","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/js/jquery.barrager.js","hash":"19c8b2498ca1083e537f7f443172970912107f83","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/js/matery.js","hash":"aa957ea8cf6787f0ed6095fedc6cb9d7d1bf3522","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/js/search.js","hash":"5caa2d6e3d34c334ac68dfaafc81a583d6123382","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/js/tw_cn.js","hash":"29157cdfa87aec28e56d3d5717d486bf4de07db6","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/medias/avatar.jpg","hash":"2a6287308628881ce27b9a7de53ba15c2be00d02","modified":1713583117569},{"_id":"themes/hexo-theme-matery/source/medias/comment_bg.png","hash":"dfc93d24081884fbc58cab0f8fd19e77d31d6123","modified":1713583117601},{"_id":"themes/hexo-theme-matery/source/medias/icp.png","hash":"27a96f31f7d0413c6ade6f40e06f021f501151c7","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/logo.png","hash":"42e062af5524c84f6246cc3988a090a722b72bf1","modified":1713583117693},{"_id":"themes/hexo-theme-matery/source/libs/animate/animate.min.css","hash":"97afa151569f046b2e01f27c1871646e9cd87caf","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/libs/aos/aos.css","hash":"191a3705a8f63e589a50a0ff2f2c5559f1a1b6b2","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/libs/aos/aos.js","hash":"02bfb40b0c4b6e9b0b4081218357145cbb327d74","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/APlayer.min.css","hash":"07372a2ba507388d0fed166d761b1c2c2a659dce","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/libs/aplayer/Meting.min.js","hash":"f2b3d20b8bd64ccd031c64628f2b1323078ae324","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/libs/background/canvas-nest.js","hash":"65333d0dbb9c1173a1b13031b230161fc42c8b2f","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/background/ribbon-dynamic.js","hash":"052b80c29e6bc585aa28d4504b743bdbac220a88","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/background/ribbon-refresh.min.js","hash":"6d98692b2cad8c746a562db18b170b35c24402f4","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/background/ribbon.min.js","hash":"6a99d494c030388f96f6086a7aaa0f03f3fe532e","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/codeBlock/codeBlockFuction.js","hash":"c7ab06d27a525b15b1eb69027135269e9b9132fb","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/codeBlock/codeCopy.js","hash":"6d39a766af62e625f177c4d5cf3adc35eed71e61","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/codeBlock/codeLang.js","hash":"bac88b4d4e3679732d29bd037c34f089cf27cf05","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/codeBlock/codeShrink.js","hash":"201e8cd761b4be557247bdaf1ebc7c11c83194f6","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/cryptojs/crypto-js.min.js","hash":"5989527a378b55011a59522f41eeb3981518325c","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/dplayer/DPlayer.min.css","hash":"e44f03f2396a17923cda5cd57fa90f62474de42d","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/fancybox/jquery.fancybox.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1713583117533},{"_id":"themes/hexo-theme-matery/source/libs/gitalk/gitalk.css","hash":"61d71cb30f5f34cbb1f2b5bc469784d6cb908c22","modified":1713583117533},{"_id":"themes/hexo-theme-matery/source/libs/gitment/gitment-default.css","hash":"2903c59ee06b965bef32e937bd69f5b0b2190717","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/instantpage/instantpage.js","hash":"83ce8919b1a69b2f1809ffaf99b52a8627e650e9","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/jqcloud/jqcloud-1.0.4.min.js","hash":"257eaae3020599e4939f50d5008a743827f25b8c","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/jqcloud/jqcloud.css","hash":"20d9f11a19d95c70e27cb922e0d6dccbec4eae89","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/justifiedGallery/justifiedGallery.min.css","hash":"b9323091d50785ad6c617d7cae76a41a89eb44b3","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/justifiedGallery/justifiedGallery.min.js","hash":"6f5433cc9f19ce2403e903e5d01a4c7b38f0969b","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/masonry/masonry.pkgd.min.js","hash":"d20252cf76c3be8af37a8415d13ad368c762b4d8","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/mermaid/mermaid.min.css","hash":"1dbcd9312e57f2a0b569451d0028d88316614481","modified":1713583117557},{"_id":"themes/hexo-theme-matery/source/libs/minivaline/MiniValine.js","hash":"f7f6cdc1b22297e02334e304444e9a8351acb455","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/others/TencentCaptcha.js","hash":"fb4d34c48567b7b992aac1c75f0d24c3eb2cc3fa","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/others/busuanzi.pure.mini.js","hash":"6e41f31100ae7eb3a6f23f2c168f6dd56e7f7a9a","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/others/clicklove.js","hash":"6a39b8c683ba5dcd92f70c6ab45d1cfac3213e8e","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/others/sakura-half.js","hash":"a41b64af88fdd0e2d3502752d059661c1bc743dc","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/others/sakura-reduce.js","hash":"f7527e9fb4e6fe2cc7c8880692d77bcda95900c7","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/others/sakura-small.js","hash":"3284a9ab71454e574d80663f3a05735cd12a6a05","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/others/sakura.js","hash":"b6ebe8f040c84f067300996a5f377846f01605fa","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/others/snow.js","hash":"02b1eeaca737c47be637b304feb3d36d792ee0c4","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/others/star.js","hash":"cf32f8ce2a1a51ba65d3b6063fe2ee1482550190","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/prism/prism.min.css","hash":"ed3896649670cf142e514685da2b060cca5fd43a","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/scrollprogress/scrollProgress.min.js","hash":"777ffe5d07e85a14fbe97d846f45ffc0087251cc","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/tocbot/tocbot.css","hash":"15601837bf8557c2fd111e4450ed4c8495fd11a0","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/tocbot/tocbot.min.js","hash":"39055053a477e7d54b46cfb46591f84cc3818eeb","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/twikoo/twikoo.all.min.js.LICENSE.txt","hash":"1e286a31ef472fb864fe2b9502e87df9242df56b","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/typed/typed.js","hash":"eaf2798298790ec3fad17f6c68b5d3b02dfd069c","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/medias/barrager/0.png","hash":"b30416fd3b3aec5af3fa90823a7e2e9c0af4cda8","modified":1713583117601},{"_id":"themes/hexo-theme-matery/source/medias/barrager/1.png","hash":"b8c211690dba3addedfe7b928e3936cd487df0d6","modified":1713583117601},{"_id":"themes/hexo-theme-matery/source/medias/barrager/2.png","hash":"52b2b13373fe611ad2327b9b40426d6dc05b69cd","modified":1713583117601},{"_id":"themes/hexo-theme-matery/source/medias/barrager/close.png","hash":"045346df61ee01abe5018c5d9ba805d2831ce7b1","modified":1713583117601},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/10.jpg","hash":"98e7f6fd9c97d4de9044b6871ca08ebf14db11b9","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/13.jpg","hash":"35a320174f8e316e3eadaec658024276b651c6e9","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/15.jpg","hash":"da0fbee3b7bde1607eace377ddf834c0be99edfe","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/16.jpg","hash":"97a829c4bc94f9d2929b20a1a9b798c57b9f7205","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/2.jpg","hash":"4bba691cf71a517ecaeaf42afd3e8f8b31e346c1","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/21.jpg","hash":"b26edb128bb0bf58b23fd2f014e9555e89a2ca3b","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/22.jpg","hash":"754579747a3e99747d890fca3162f370b96a7941","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/23.jpg","hash":"7d7f37da3fa7128343adac23866449eb2c6a549a","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/3.jpg","hash":"6ec646c2a70f5f11edacf225c1477f2200a37a96","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/5.jpg","hash":"41ca20129a37fedc573eec28dd7d7b9e5b09228a","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/7.jpg","hash":"7975141cd64e875122c0ea33daaca1a06bf00b8e","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/8.jpg","hash":"8e4b7186352085483ca1174c7c0800114c48df8b","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/reward/alipay.jpg","hash":"1abc719b95d1b26f1f898e6b0a9b7609146e332f","modified":1713583117693},{"_id":"themes/hexo-theme-matery/source/medias/reward/wechat.png","hash":"fe93385aa92fe328e01c8221a80b039be9e4e140","modified":1713583117693},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-regular-400.ttf","hash":"9b26d745a1e69b23d71b7ea36d5de1209c997901","modified":1713583117517},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-regular-400.woff2","hash":"f7a09bcbd996fd634045d4e79b6504c945730686","modified":1713583117517},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-v4compatibility.ttf","hash":"3fc15c8154f8bd2d7bd1dfe55ae5ab1c33e5e40f","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-v4compatibility.woff2","hash":"37ab2a6a0810d5a6c10a355fe1d7af0042bd6a2a","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/css/lightgallery.min.css","hash":"7873d80020ae04955bb57521bd249a6974d1180f","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.svg","hash":"509c56c80732a1cd80df8f2b4b0ac1128c31999f","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.ttf","hash":"49693fa946534a56d7e5d4274e1ce55b05d782c3","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/fonts/lg.woff","hash":"04f09ad797ced119d6608909d06e500f16a03bbb","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/loading.gif","hash":"15a76af2739482d8de7354abc6d8dc4fca8d145e","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/video-play.png","hash":"2962e03ddbe04d7e201a5acccac531a2bbccddfc","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/vimeo-play.png","hash":"9b72fc0f86a01467ed0b68c9cc4d604ec316d517","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/img/youtube-play.png","hash":"f8d11384d33b7a79ee2ba8d522844f14d5067a80","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/lightGallery/js/lightgallery-all.min.js","hash":"aab2633f69581c2e26e22a23712f1501d7fcec18","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/share/css/share.min.css","hash":"8a778a86f3ce9a042df6be63a9f1039631e351a5","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.eot","hash":"00ff749c8e202401190cc98d56087cdda716abe4","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.svg","hash":"1d56c9d5db0273f07c43cc1397e440f98ba7827a","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.ttf","hash":"afd898f59d363887418669520b24d175f966a083","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/share/fonts/iconfont.woff","hash":"2e3fce1dcfbd6e2114e7bfbeaf72d3c62e15a1bd","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/share/js/jquery.share.min.js","hash":"41367dcb857e02e3c417ebe68a554ce1d4430806","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/share/js/social-share.min.js","hash":"a3090a02786dcd4efc6355c1c1dc978add8d6827","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/fancybox/fancybox.js","hash":"eef46b6fb2e460838cd7328a6e13ecda0cb1e194","modified":1713583117533},{"_id":"themes/hexo-theme-matery/source/libs/gitment/gitment.js","hash":"28c02c45ce568e084cd1041dc493f83f9c6c88c6","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/jquery/jquery-3.6.0.min.js","hash":"b82d238d4e31fdf618bae8ac11a6c812c03dd0d4","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/medias/banner/0.jpg","hash":"69ec96cd9b4bc3aa631adc9da61353f50c39f031","modified":1713583117569},{"_id":"themes/hexo-theme-matery/source/medias/banner/2.jpg","hash":"39fb2535460ce66cc0b34e07ffb9411db1405f09","modified":1713583117569},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/0.jpg","hash":"1c3300f029fc85d6dda6fa4f1d699551034cdaf7","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/1.jpg","hash":"684ae89de8cb7acefae19f5aee6c612037c46393","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/11.jpg","hash":"f55972ce7175684f2b11c3c9fc2b5b14bccbfae8","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/12.jpg","hash":"8a4b2e7d92ae95c3b0c921db23c35aa9a41a7d58","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/14.jpg","hash":"38e11221406785bcd93aa9cd23e568e164630ef1","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/17.jpg","hash":"42d47903551ee81885c1386022982cae165841c5","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/18.jpg","hash":"64829272ec85bb819d55ff89e5b5fd6f64aa436b","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/19.jpg","hash":"eb250906fdbc0c408f42ae9933725bc1a05d79fb","modified":1713583117605},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/20.jpg","hash":"3b11f9b461168d907073f793190865fe621a8573","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/4.jpg","hash":"e06c47de27619984be9d5d02947f8370a432dfea","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/6.jpg","hash":"c8f2aa4bbb041158b4e73733a341e6a77c8583f7","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/medias/featureimages/9.jpg","hash":"b956a2291a04b2132366b53666cf34858b8bdb1f","modified":1713583117609},{"_id":"themes/hexo-theme-matery/source/libs/awesome/css/all.min.css","hash":"0ae47fa834fb55de7b50c79021aeabecfae50c9c","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-brands-400.woff2","hash":"e219af1e3bbc2219359d3d0916e263b279c4abfd","modified":1713583117517},{"_id":"themes/hexo-theme-matery/source/medias/cover.jpg","hash":"d4957ff7cc5e88555cd840f2956ab0561e6f1ccf","modified":1713583117601},{"_id":"themes/hexo-theme-matery/source/libs/dplayer/DPlayer.min.js","hash":"0dd260503b7bd03cf8a2b1192d3cac54037d112c","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/materialize/materialize.min.css","hash":"d1328a7872827bc63e7cc4d33745397681accda8","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/materialize/materialize.min.js","hash":"8eee32acbfac59744b4053a7290f503ef623d3ab","modified":1713583117537},{"_id":"themes/hexo-theme-matery/source/libs/valine/Valine.min.js","hash":"d081a412c63411a75a3a880ddece65335d1c3ee8","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/waline/Waline.min.js","hash":"94f70e622e2a1ab05adb205033a9ddf371c61534","modified":1713583117569},{"_id":"themes/hexo-theme-matery/source/medias/banner/1.jpg","hash":"ab122a36998a4f62a61e61a4fc5e00248113413b","modified":1713583117569},{"_id":"themes/hexo-theme-matery/source/medias/banner/5.jpg","hash":"852418f4f09e796e12bc3bab7a1488d3f37d6486","modified":1713583117581},{"_id":"themes/hexo-theme-matery/source/libs/awesome/css/all.css","hash":"8d63fa8b0f60a50b07ac0f7e751f6f5e02ecdc44","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-brands-400.ttf","hash":"fa5745d421c0fc90928626be98e9f8cf7580b327","modified":1713583117517},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-solid-900.woff2","hash":"1979128e8ba1517d85f5e4ee505abf486c51557c","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/js/crypto-js.js","hash":"ddacd177f23f65ff97b93b0417048f51928ee17e","modified":1713583117513},{"_id":"themes/hexo-theme-matery/source/libs/valine/av-min.js","hash":"db56ef6acb789da00d39bd6b97c1b09c2d429195","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/medias/banner/4.jpg","hash":"e5ac5033678afa9d69edffe9a61004f836cb5734","modified":1713583117581},{"_id":"themes/hexo-theme-matery/source/libs/awesome/webfonts/fa-solid-900.ttf","hash":"e3339400ef6214cfa077d003daed2bfa659e2956","modified":1713583117521},{"_id":"themes/hexo-theme-matery/source/libs/twikoo/twikoo.all.min.js","hash":"ef3df94e37942d87ab937c8e34e3c20b162324a3","modified":1713583117565},{"_id":"themes/hexo-theme-matery/source/libs/prism/prism.min.js","hash":"05870d7dd627c6ef5ffff5c607bc5a4ff9c84afd","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/libs/echarts/echarts.min.js","hash":"9496f386a0da4601cad22c479cc5543913a4d67f","modified":1713583117533},{"_id":"themes/hexo-theme-matery/source/libs/gitalk/gitalk.min.js","hash":"564fc7c731d05fa70d71ef853a2c8cc7725739e2","modified":1713583117533},{"_id":"themes/hexo-theme-matery/source/libs/mermaid/mermaid.min.js","hash":"6bee48c26c32b90f50519f125890fcbb04779da6","modified":1713583117561},{"_id":"themes/hexo-theme-matery/source/medias/banner/3.jpg","hash":"e3ec7f8488f1fcbd91e0e31d1430a0e470db2496","modified":1713583117577},{"_id":"themes/hexo-theme-matery/source/libs/mermaid/mermaid.js","hash":"a7933bef8aba190825ba7716497209187ac1de5d","modified":1713583117557},{"_id":"themes/hexo-theme-matery/source/medias/images/01.jpg","hash":"18f26efc76f6ab3b7a9b94238db1183e8faf9a39","modified":1713583117629},{"_id":"themes/hexo-theme-matery/source/medias/banner/6.jpg","hash":"0fbb9f5015e7806dc9c39d2d004c01b583966857","modified":1713583117601},{"_id":"themes/hexo-theme-matery/source/medias/images/02.jpg","hash":"fce7a8cbf6c61c4d9e68dc87881570be14cdb1de","modified":1713583117661},{"_id":"themes/hexo-theme-matery/source/medias/images/03.jpg","hash":"6fdb986b1d31d6644c59b1a676a4c2b8270ded94","modified":1713583117693},{"_id":"public/search.xml","hash":"e2a6dfa094ecd72adc2a6ef00f1b045c71e48203","modified":1714795013842},{"_id":"public/js/markmap.js","hash":"a8484baa1bf9eabeff2bcd84e79e4591d9b967ad","modified":1714795013842},{"_id":"public/about/index.html","hash":"cf0121aa5173a7bc1a42a45e3127620afc7b4638","modified":1714795013842},{"_id":"public/categories/index.html","hash":"1a0fc25710e3a6c65200440635e96acf515107ec","modified":1714795013842},{"_id":"public/contact/index.html","hash":"25a2a69a9da660390f192a844bd0740ba9a0b7be","modified":1714795013842},{"_id":"public/friends/index.html","hash":"cb286c770669bb9f89e21f4571c6332e82173112","modified":1714795013842},{"_id":"public/tags/index.html","hash":"ea4ed2a7128019c7ac01d62bc182b1bfe3ae9d71","modified":1714795013842},{"_id":"public/2024/05/03/si-qian-zhou/si-qian-zhou/index.html","hash":"0c93ae49303feab57c33ebae72daeb80758bd3a7","modified":1714795013842},{"_id":"public/2024/04/30/clickhouse/index.html","hash":"db53f9b84c593e4a8b9f344d9fc4e46c63fc19fe","modified":1714795013842},{"_id":"public/2024/04/30/metrics/bind-exporter/index.html","hash":"4dba33a124b7c544d5d7fd8edd9d70e9e3f2924e","modified":1714795013842},{"_id":"public/2024/04/30/metrics/kafka-exporter/index.html","hash":"c26e7891cf9f9ca16a6342f087dbbcd30d85a342","modified":1714795013842},{"_id":"public/2024/04/30/metrics/mysqld-exporter/index.html","hash":"cf6175ab61d1d815b8284d198488ca5a90e74046","modified":1714795013842},{"_id":"public/2024/04/30/metrics/redis-exporter/index.html","hash":"8aebcb1aa75bfb90d0be0ef5973ddaf601fd70fa","modified":1714795013842},{"_id":"public/2024/04/30/domain-management/index.html","hash":"3ab5b48b70d6804ea7f124d714398cbb6095c2ab","modified":1714795013842},{"_id":"public/2024/04/30/cert-manager/index.html","hash":"a131c0cc82c8001307b944219ab125fe2f462cc8","modified":1714795013842},{"_id":"public/2024/04/30/kube-prometheus-stack/index.html","hash":"79f179b119ac3b4d95fb9c1410fc77efec8c3f5c","modified":1714795013842},{"_id":"public/2024/04/30/metrics/vault/index.html","hash":"1be50f51b8ab78be69ca2ce5926c2d304c58631d","modified":1714795013842},{"_id":"public/2024/04/24/blog-with-cdn/index.html","hash":"875c559ef19d48f2bef29a35b05f0d3b9501a7d8","modified":1714795013842},{"_id":"public/2024/04/16/frp-chuan-tou-bing-dai-li-dao-ingressroute/index.html","hash":"6d20f3a9804fa46fa0e07e0739981e3d70862558","modified":1714795013842},{"_id":"public/2024/03/09/post-img/index.html","hash":"2f4b8fdba6db28175ef35a28a7e21c1963ebe3c6","modified":1714795013842},{"_id":"public/2024/03/09/zai-hexo-zhong-zhan-shi-si-wei-dao-tu/index.html","hash":"a6b7b6cae6928b1a81abd8bc76deea35e939c52b","modified":1714795013842},{"_id":"public/2024/02/22/overleaf-self-hosted/index.html","hash":"5917847eb8311a86a2252aa29c14a8cb368dae90","modified":1714795013842},{"_id":"public/2024/02/17/instantbox-customize/index.html","hash":"2bbfa17fc44161ec63180131df06efb0e56924fc","modified":1714795013842},{"_id":"public/2024/01/02/instant-box/index.html","hash":"d332337362bbdee30c08cd27b5e87ddb416c16b9","modified":1714795013842},{"_id":"public/2024/01/01/at-the-end-of-2023/index.html","hash":"fbd674bf74be18100daecb2219fdc55e41533e02","modified":1714795013842},{"_id":"public/2023/12/25/dns-server/index.html","hash":"110d9c63fdb2dcc86e16a0eb1a5115b730806948","modified":1714795013842},{"_id":"public/2023/12/04/the-first-time-using-helm-charts/index.html","hash":"0e9e9891f2430967fa29647b768ae30fe6eacb3c","modified":1714795013842},{"_id":"public/2023/12/01/failed-to-post-blog/index.html","hash":"63cb4a9f4d951c2bb58bb219218706522561cc4f","modified":1714795013842},{"_id":"public/2023/11/27/homelab-pc/index.html","hash":"7c192560c6aa81c1000273f3b01009e7237a284c","modified":1714795013842},{"_id":"public/2023/10/24/multiple-domians-in-openldap-use-case/index.html","hash":"f9f1dfae2b7fbe0968bb2846225f54344a03b97a","modified":1714795013842},{"_id":"public/2023/10/18/zhe-shi-yi-feng-xin/index.html","hash":"691302de1f2a58df7a9ffda7cd7c66dee5573b5f","modified":1714795013842},{"_id":"public/2023/10/15/deploy-hexo/index.html","hash":"f5e8e21cc3fd080cf6a01da24c3e0dea06dd06b1","modified":1714795013842},{"_id":"public/archives/index.html","hash":"cb6b59eb85abf8ae905f2f574ca92b50a0d3ffa2","modified":1714795013842},{"_id":"public/archives/page/2/index.html","hash":"55aa31695ab4c229a1f7150292c51effef4a3ca8","modified":1714795013842},{"_id":"public/archives/page/3/index.html","hash":"6d00debd4b87819b63ade75afa700b630982302a","modified":1714795013842},{"_id":"public/archives/2023/index.html","hash":"0ffab41224d96fc24d94c51b40af9c7639eef02e","modified":1714795013842},{"_id":"public/archives/2023/10/index.html","hash":"094d93fa5972f3aa4543b878f4420b88c838b19b","modified":1714795013842},{"_id":"public/archives/2023/11/index.html","hash":"51abf1fbec3d9b7afd14cf266ba4a2d6a57164f1","modified":1714795013842},{"_id":"public/archives/2023/12/index.html","hash":"e25b11a81018d8eecd60a3f7cb37d19183cac1ba","modified":1714795013842},{"_id":"public/archives/2024/index.html","hash":"78d48d25d1a3294cc25e2782c4ecfcb008916127","modified":1714795013842},{"_id":"public/archives/2024/page/2/index.html","hash":"ee380019ab7291ca2eeeef7acacb28b8d15a345f","modified":1714795013842},{"_id":"public/archives/2024/01/index.html","hash":"973465f265a5e2df7781625c21787efc3f864324","modified":1714795013842},{"_id":"public/archives/2024/02/index.html","hash":"792abac106c73369252dba62d1d8444b541b79a4","modified":1714795013842},{"_id":"public/archives/2024/03/index.html","hash":"5b7ec86768627d695496a9c19e61b339306b103e","modified":1714795013842},{"_id":"public/archives/2024/04/index.html","hash":"6710b6a4635daacf6f10ed1cab0dfe31e142c2fa","modified":1714795013842},{"_id":"public/archives/2024/05/index.html","hash":"faa8cd86050ba927b95b13c32e81327173ec263c","modified":1714795013842},{"_id":"public/categories/summary/index.html","hash":"3e8174e64897f69dbd999af602def194a59fdd70","modified":1714795013842},{"_id":"public/categories/ops/index.html","hash":"30c6c10f4670579c3370392cc558f16a09177169","modified":1714795013842},{"_id":"public/categories/Kubernetes/index.html","hash":"c57f634d720eea1ee0abc332479d4da3e8d8cc62","modified":1714795013842},{"_id":"public/categories/kubernetes/index.html","hash":"5569c89dd31ace0097088591160663a588d17084","modified":1714795013842},{"_id":"public/categories/Database/index.html","hash":"f794979815b61518e9a85a14b928ac0a00c0175f","modified":1714795013842},{"_id":"public/categories/hexo/index.html","hash":"dca24504213275842d23300fd7079174229f1983","modified":1714795013842},{"_id":"public/categories/DNS/index.html","hash":"0a19fe8f88b4c07a7bbb207ad8a8348dd0a7213c","modified":1714795013842},{"_id":"public/categories/Hardware/index.html","hash":"1fc163bc6fd2971c5fa84ee8d7668b00d3637195","modified":1714795013842},{"_id":"public/categories/Personal/index.html","hash":"70d0aeacb20865a78fdb4659936e62b0d278e967","modified":1714795013842},{"_id":"public/categories/Opentelemetry/index.html","hash":"5a348d086a93f3814e4a916b89be0acd61ad8874","modified":1714795013842},{"_id":"public/categories/personal/index.html","hash":"2b9df41d2c74ffd6955f85d909851f18c459d88a","modified":1714795013842},{"_id":"public/index.html","hash":"135a274d97b482575916a0d5c1f1e95e27e9a958","modified":1714795013842},{"_id":"public/page/2/index.html","hash":"d6d314ef5a1cea3826f8d576b0332d36bf03f581","modified":1714795013842},{"_id":"public/page/3/index.html","hash":"0d4e8d1e81714726839b8d43e23d9d7ce3fce30e","modified":1714795013842},{"_id":"public/tags/personal/index.html","hash":"23e71d06d75edebd33d2a6ae5c636f4654c5a4a3","modified":1714795013842},{"_id":"public/tags/DNS/index.html","hash":"b7a4201bb1237f550f374b144f99819405932b60","modified":1714795013842},{"_id":"public/tags/Ubuntu/index.html","hash":"49e4481ac9cabfef5440a1d9d8bb54463bdff51a","modified":1714795013842},{"_id":"public/tags/FRP/index.html","hash":"2b60e15f45e4321fac1ab15b496361dbdb1f5bb2","modified":1714795013842},{"_id":"public/tags/IngressRoute/index.html","hash":"5a00a7b50c0502653d348bb82a4b957fefb48e18","modified":1714795013842},{"_id":"public/tags/debug/index.html","hash":"bf0fec039fdaf61cc877199444a54aa575c8ac92","modified":1714795013842},{"_id":"public/tags/Virtualization/index.html","hash":"565f43f12a1ecf5df6255485c5d27420b90995f4","modified":1714795013842},{"_id":"public/tags/Docker/index.html","hash":"82b4b50e359d51ea3fd5038dd2ca667fde4fdc96","modified":1714795013842},{"_id":"public/tags/OpenLDAP/index.html","hash":"67e44a42ef8cd9d40bc3751249e248b51453cc43","modified":1714795013842},{"_id":"public/tags/Overleaf/index.html","hash":"4b8d5bd37658d14745fa06f80e7ea284483cd4ef","modified":1714795013842},{"_id":"public/tags/helm/index.html","hash":"2a64b88494b63cc05404db610c3af787beb37feb","modified":1714795013842},{"_id":"public/tags/cert-manager/index.html","hash":"0836943170da179d6e0dbe2a8188450851ad3a45","modified":1714795013842},{"_id":"public/tags/clickhouse/index.html","hash":"19118f7c3b3888be5a4b2def3c8a845cfa7fafc9","modified":1714795013842},{"_id":"public/tags/hexo/index.html","hash":"a7d53f69bfc8fac0ddb4cc56b27c038f651ce37f","modified":1714795013842},{"_id":"public/tags/blog/index.html","hash":"892a973e11bcdac1220069ccc21382bed1e2b9bd","modified":1714795013842},{"_id":"public/tags/DIY/index.html","hash":"d88ae46b704550887495d5848edb18be37186380","modified":1714795013842},{"_id":"public/tags/demo-test/index.html","hash":"81d5be6e5a90e8e290a22771ce0b2ba3d2289ddf","modified":1714795013842},{"_id":"public/tags/prometheus/index.html","hash":"49918fc56c54993dae68c25c52e971d49a9d7b21","modified":1714795013842},{"_id":"public/tags/Personal/index.html","hash":"06170146869adf24d58f094bdb34d82cc9b52686","modified":1714795013842},{"_id":"public/tags/metrics/index.html","hash":"cf71a9f4bfcad473c93672e78edad9c661bbf641","modified":1714795013842},{"_id":"public/tags/vault/index.html","hash":"35b9336f0f841bcdf9627802d6568298f5671f55","modified":1714795013842},{"_id":"public/tags/excerpts/index.html","hash":"48705f848fc565cfe12cf272661b51addea0551c","modified":1714795013842},{"_id":"public/CNAME","hash":"8ba167d170d161a56ba83aa66f4d4e009821b26f","modified":1714795013842},{"_id":"public/favicon.png","hash":"42e062af5524c84f6246cc3988a090a722b72bf1","modified":1714795013842},{"_id":"public/medias/avatar.jpg","hash":"2a6287308628881ce27b9a7de53ba15c2be00d02","modified":1714795013842},{"_id":"public/medias/comment_bg.png","hash":"dfc93d24081884fbc58cab0f8fd19e77d31d6123","modified":1714795013842},{"_id":"public/medias/icp.png","hash":"27a96f31f7d0413c6ade6f40e06f021f501151c7","modified":1714795013842},{"_id":"public/medias/logo.png","hash":"42e062af5524c84f6246cc3988a090a722b72bf1","modified":1714795013842},{"_id":"public/libs/twikoo/twikoo.all.min.js.LICENSE.txt","hash":"1e286a31ef472fb864fe2b9502e87df9242df56b","modified":1714795013842},{"_id":"public/medias/barrager/0.png","hash":"b30416fd3b3aec5af3fa90823a7e2e9c0af4cda8","modified":1714795013842},{"_id":"public/medias/barrager/1.png","hash":"b8c211690dba3addedfe7b928e3936cd487df0d6","modified":1714795013842},{"_id":"public/medias/barrager/2.png","hash":"52b2b13373fe611ad2327b9b40426d6dc05b69cd","modified":1714795013842},{"_id":"public/medias/barrager/close.png","hash":"045346df61ee01abe5018c5d9ba805d2831ce7b1","modified":1714795013842},{"_id":"public/medias/featureimages/10.jpg","hash":"98e7f6fd9c97d4de9044b6871ca08ebf14db11b9","modified":1714795013842},{"_id":"public/medias/featureimages/13.jpg","hash":"35a320174f8e316e3eadaec658024276b651c6e9","modified":1714795013842},{"_id":"public/medias/featureimages/15.jpg","hash":"da0fbee3b7bde1607eace377ddf834c0be99edfe","modified":1714795013842},{"_id":"public/medias/featureimages/16.jpg","hash":"97a829c4bc94f9d2929b20a1a9b798c57b9f7205","modified":1714795013842},{"_id":"public/medias/featureimages/2.jpg","hash":"4bba691cf71a517ecaeaf42afd3e8f8b31e346c1","modified":1714795013842},{"_id":"public/medias/featureimages/21.jpg","hash":"b26edb128bb0bf58b23fd2f014e9555e89a2ca3b","modified":1714795013842},{"_id":"public/medias/featureimages/22.jpg","hash":"754579747a3e99747d890fca3162f370b96a7941","modified":1714795013842},{"_id":"public/medias/featureimages/23.jpg","hash":"7d7f37da3fa7128343adac23866449eb2c6a549a","modified":1714795013842},{"_id":"public/medias/featureimages/3.jpg","hash":"6ec646c2a70f5f11edacf225c1477f2200a37a96","modified":1714795013842},{"_id":"public/medias/featureimages/5.jpg","hash":"41ca20129a37fedc573eec28dd7d7b9e5b09228a","modified":1714795013842},{"_id":"public/medias/featureimages/7.jpg","hash":"7975141cd64e875122c0ea33daaca1a06bf00b8e","modified":1714795013842},{"_id":"public/medias/featureimages/8.jpg","hash":"8e4b7186352085483ca1174c7c0800114c48df8b","modified":1714795013842},{"_id":"public/medias/reward/alipay.jpg","hash":"1abc719b95d1b26f1f898e6b0a9b7609146e332f","modified":1714795013842},{"_id":"public/medias/reward/wechat.png","hash":"fe93385aa92fe328e01c8221a80b039be9e4e140","modified":1714795013842},{"_id":"public/libs/awesome/webfonts/fa-regular-400.ttf","hash":"9b26d745a1e69b23d71b7ea36d5de1209c997901","modified":1714795013842},{"_id":"public/libs/awesome/webfonts/fa-regular-400.woff2","hash":"f7a09bcbd996fd634045d4e79b6504c945730686","modified":1714795013842},{"_id":"public/libs/awesome/webfonts/fa-v4compatibility.ttf","hash":"3fc15c8154f8bd2d7bd1dfe55ae5ab1c33e5e40f","modified":1714795013842},{"_id":"public/libs/awesome/webfonts/fa-v4compatibility.woff2","hash":"37ab2a6a0810d5a6c10a355fe1d7af0042bd6a2a","modified":1714795013842},{"_id":"public/libs/lightGallery/fonts/lg.svg","hash":"509c56c80732a1cd80df8f2b4b0ac1128c31999f","modified":1714795013842},{"_id":"public/libs/lightGallery/fonts/lg.ttf","hash":"49693fa946534a56d7e5d4274e1ce55b05d782c3","modified":1714795013842},{"_id":"public/libs/lightGallery/fonts/lg.woff","hash":"04f09ad797ced119d6608909d06e500f16a03bbb","modified":1714795013842},{"_id":"public/libs/lightGallery/img/loading.gif","hash":"15a76af2739482d8de7354abc6d8dc4fca8d145e","modified":1714795013842},{"_id":"public/libs/lightGallery/img/video-play.png","hash":"2962e03ddbe04d7e201a5acccac531a2bbccddfc","modified":1714795013842},{"_id":"public/libs/lightGallery/img/vimeo-play.png","hash":"9b72fc0f86a01467ed0b68c9cc4d604ec316d517","modified":1714795013842},{"_id":"public/libs/lightGallery/img/youtube-play.png","hash":"f8d11384d33b7a79ee2ba8d522844f14d5067a80","modified":1714795013842},{"_id":"public/libs/share/fonts/iconfont.eot","hash":"00ff749c8e202401190cc98d56087cdda716abe4","modified":1714795013842},{"_id":"public/libs/share/fonts/iconfont.svg","hash":"1d56c9d5db0273f07c43cc1397e440f98ba7827a","modified":1714795013842},{"_id":"public/libs/share/fonts/iconfont.ttf","hash":"afd898f59d363887418669520b24d175f966a083","modified":1714795013842},{"_id":"public/libs/share/fonts/iconfont.woff","hash":"2e3fce1dcfbd6e2114e7bfbeaf72d3c62e15a1bd","modified":1714795013842},{"_id":"public/medias/banner/0.jpg","hash":"69ec96cd9b4bc3aa631adc9da61353f50c39f031","modified":1714795013842},{"_id":"public/medias/banner/2.jpg","hash":"39fb2535460ce66cc0b34e07ffb9411db1405f09","modified":1714795013842},{"_id":"public/medias/featureimages/0.jpg","hash":"1c3300f029fc85d6dda6fa4f1d699551034cdaf7","modified":1714795013842},{"_id":"public/medias/featureimages/1.jpg","hash":"684ae89de8cb7acefae19f5aee6c612037c46393","modified":1714795013842},{"_id":"public/medias/featureimages/11.jpg","hash":"f55972ce7175684f2b11c3c9fc2b5b14bccbfae8","modified":1714795013842},{"_id":"public/medias/featureimages/12.jpg","hash":"8a4b2e7d92ae95c3b0c921db23c35aa9a41a7d58","modified":1714795013842},{"_id":"public/medias/featureimages/14.jpg","hash":"38e11221406785bcd93aa9cd23e568e164630ef1","modified":1714795013842},{"_id":"public/medias/featureimages/17.jpg","hash":"42d47903551ee81885c1386022982cae165841c5","modified":1714795013842},{"_id":"public/medias/featureimages/18.jpg","hash":"64829272ec85bb819d55ff89e5b5fd6f64aa436b","modified":1714795013842},{"_id":"public/medias/featureimages/19.jpg","hash":"eb250906fdbc0c408f42ae9933725bc1a05d79fb","modified":1714795013842},{"_id":"public/medias/featureimages/20.jpg","hash":"3b11f9b461168d907073f793190865fe621a8573","modified":1714795013842},{"_id":"public/medias/featureimages/4.jpg","hash":"e06c47de27619984be9d5d02947f8370a432dfea","modified":1714795013842},{"_id":"public/medias/featureimages/6.jpg","hash":"c8f2aa4bbb041158b4e73733a341e6a77c8583f7","modified":1714795013842},{"_id":"public/medias/featureimages/9.jpg","hash":"b956a2291a04b2132366b53666cf34858b8bdb1f","modified":1714795013842},{"_id":"public/libs/awesome/webfonts/fa-brands-400.woff2","hash":"e219af1e3bbc2219359d3d0916e263b279c4abfd","modified":1714795013842},{"_id":"public/css/barrager.css","hash":"862879d9313ed8d4c721fa32ef8f94ac2f0a28ae","modified":1714795013842},{"_id":"public/css/bb.css","hash":"aa15633888c7cf9baea8bb48d796c68b57cf14bf","modified":1714795013842},{"_id":"public/css/gallery.css","hash":"79dfdf68d675c17782271647283c568d086e4b98","modified":1714795013842},{"_id":"public/css/gitment.css","hash":"2bd15cc17dca35ac3ecc0acf167a23a1dd362acd","modified":1714795013842},{"_id":"public/css/indexcover.css","hash":"bd027eb8192b4d1b0dc9b4f965fa264e8437f847","modified":1714795013842},{"_id":"public/css/my-gitalk.css","hash":"af18dd29e58642c18bab9b89541767b494c468dd","modified":1714795013842},{"_id":"public/css/my.css","hash":"497e50351f7838f8546cac76850a42e7e380a110","modified":1714795013842},{"_id":"public/css/post.css","hash":"d38c71eddb8af1752c48eb48595fbaf89450ff40","modified":1714795013842},{"_id":"public/css/reward.css","hash":"98b32aabeb908727844af04c31f08da6cab08335","modified":1714795013842},{"_id":"public/js/gallery-encrypt.js","hash":"18dcfa4a8da8847b64be75f287f45c0e830bbcab","modified":1714795013842},{"_id":"public/js/jquery.barrager.js","hash":"19c8b2498ca1083e537f7f443172970912107f83","modified":1714795013842},{"_id":"public/js/matery.js","hash":"aa957ea8cf6787f0ed6095fedc6cb9d7d1bf3522","modified":1714795013842},{"_id":"public/js/search.js","hash":"5caa2d6e3d34c334ac68dfaafc81a583d6123382","modified":1714795013842},{"_id":"public/libs/aos/aos.js","hash":"02bfb40b0c4b6e9b0b4081218357145cbb327d74","modified":1714795013842},{"_id":"public/libs/aplayer/APlayer.min.css","hash":"07372a2ba507388d0fed166d761b1c2c2a659dce","modified":1714795013842},{"_id":"public/libs/aplayer/Meting.min.js","hash":"f2b3d20b8bd64ccd031c64628f2b1323078ae324","modified":1714795013842},{"_id":"public/libs/background/canvas-nest.js","hash":"65333d0dbb9c1173a1b13031b230161fc42c8b2f","modified":1714795013842},{"_id":"public/libs/background/ribbon-dynamic.js","hash":"052b80c29e6bc585aa28d4504b743bdbac220a88","modified":1714795013842},{"_id":"public/libs/background/ribbon-refresh.min.js","hash":"6d98692b2cad8c746a562db18b170b35c24402f4","modified":1714795013842},{"_id":"public/libs/background/ribbon.min.js","hash":"6a99d494c030388f96f6086a7aaa0f03f3fe532e","modified":1714795013842},{"_id":"public/libs/codeBlock/codeBlockFuction.js","hash":"c7ab06d27a525b15b1eb69027135269e9b9132fb","modified":1714795013842},{"_id":"public/libs/codeBlock/codeCopy.js","hash":"6d39a766af62e625f177c4d5cf3adc35eed71e61","modified":1714795013842},{"_id":"public/libs/codeBlock/codeLang.js","hash":"bac88b4d4e3679732d29bd037c34f089cf27cf05","modified":1714795013842},{"_id":"public/libs/codeBlock/codeShrink.js","hash":"201e8cd761b4be557247bdaf1ebc7c11c83194f6","modified":1714795013842},{"_id":"public/libs/fancybox/jquery.fancybox.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1714795013842},{"_id":"public/libs/instantpage/instantpage.js","hash":"83ce8919b1a69b2f1809ffaf99b52a8627e650e9","modified":1714795013842},{"_id":"public/libs/jqcloud/jqcloud-1.0.4.min.js","hash":"257eaae3020599e4939f50d5008a743827f25b8c","modified":1714795013842},{"_id":"public/libs/jqcloud/jqcloud.css","hash":"20d9f11a19d95c70e27cb922e0d6dccbec4eae89","modified":1714795013842},{"_id":"public/libs/justifiedGallery/justifiedGallery.min.css","hash":"89fb099880771c23dce3005a87db36053c8c491c","modified":1714795013842},{"_id":"public/libs/mermaid/mermaid.min.css","hash":"1dbcd9312e57f2a0b569451d0028d88316614481","modified":1714795013842},{"_id":"public/libs/minivaline/MiniValine.js","hash":"f7f6cdc1b22297e02334e304444e9a8351acb455","modified":1714795013842},{"_id":"public/libs/others/TencentCaptcha.js","hash":"10a034ac0b4ebe97ec5916b092b36fa2d6e9edd0","modified":1714795013842},{"_id":"public/libs/others/busuanzi.pure.mini.js","hash":"6e41f31100ae7eb3a6f23f2c168f6dd56e7f7a9a","modified":1714795013842},{"_id":"public/libs/others/clicklove.js","hash":"6a39b8c683ba5dcd92f70c6ab45d1cfac3213e8e","modified":1714795013842},{"_id":"public/libs/others/snow.js","hash":"02b1eeaca737c47be637b304feb3d36d792ee0c4","modified":1714795013842},{"_id":"public/libs/others/star.js","hash":"cf32f8ce2a1a51ba65d3b6063fe2ee1482550190","modified":1714795013842},{"_id":"public/libs/prism/prism.min.css","hash":"ed3896649670cf142e514685da2b060cca5fd43a","modified":1714795013842},{"_id":"public/libs/scrollprogress/scrollProgress.min.js","hash":"777ffe5d07e85a14fbe97d846f45ffc0087251cc","modified":1714795013842},{"_id":"public/libs/tocbot/tocbot.css","hash":"15601837bf8557c2fd111e4450ed4c8495fd11a0","modified":1714795013842},{"_id":"public/libs/tocbot/tocbot.min.js","hash":"39055053a477e7d54b46cfb46591f84cc3818eeb","modified":1714795013842},{"_id":"public/libs/typed/typed.js","hash":"eaf2798298790ec3fad17f6c68b5d3b02dfd069c","modified":1714795013842},{"_id":"public/libs/share/css/share.min.css","hash":"8a778a86f3ce9a042df6be63a9f1039631e351a5","modified":1714795013842},{"_id":"public/css/dark.css","hash":"be4ef08494f3c965d513d9413685c0e723f671cd","modified":1714795013842},{"_id":"public/css/matery.css","hash":"d5436e7e7f8c55027d555f1aed8f568b32c82331","modified":1714795013842},{"_id":"public/js/crypto-js.js","hash":"3dd73b6f13dc818a3a9c5c7424c1c4a9649b00a2","modified":1714795013842},{"_id":"public/js/tw_cn.js","hash":"29157cdfa87aec28e56d3d5717d486bf4de07db6","modified":1714795013842},{"_id":"public/libs/animate/animate.min.css","hash":"97afa151569f046b2e01f27c1871646e9cd87caf","modified":1714795013842},{"_id":"public/libs/aos/aos.css","hash":"191a3705a8f63e589a50a0ff2f2c5559f1a1b6b2","modified":1714795013842},{"_id":"public/libs/aplayer/APlayer.min.js","hash":"22caa28ff6b41a16ff40f15d38f1739e22359478","modified":1714795013842},{"_id":"public/libs/cryptojs/crypto-js.min.js","hash":"5989527a378b55011a59522f41eeb3981518325c","modified":1714795013842},{"_id":"public/libs/dplayer/DPlayer.min.css","hash":"e44f03f2396a17923cda5cd57fa90f62474de42d","modified":1714795013842},{"_id":"public/libs/dplayer/DPlayer.min.js","hash":"0dd260503b7bd03cf8a2b1192d3cac54037d112c","modified":1714795013842},{"_id":"public/libs/fancybox/fancybox.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1714795013842},{"_id":"public/libs/gitalk/gitalk.css","hash":"61d71cb30f5f34cbb1f2b5bc469784d6cb908c22","modified":1714795013842},{"_id":"public/libs/gitment/gitment-default.css","hash":"2903c59ee06b965bef32e937bd69f5b0b2190717","modified":1714795013842},{"_id":"public/libs/gitment/gitment.js","hash":"28c02c45ce568e084cd1041dc493f83f9c6c88c6","modified":1714795013842},{"_id":"public/libs/jquery/jquery-3.6.0.min.js","hash":"b82d238d4e31fdf618bae8ac11a6c812c03dd0d4","modified":1714795013842},{"_id":"public/libs/justifiedGallery/justifiedGallery.min.js","hash":"82ab395176c927ffbb2f7c95132ee0a06cd5d64a","modified":1714795013842},{"_id":"public/libs/masonry/masonry.pkgd.min.js","hash":"d20252cf76c3be8af37a8415d13ad368c762b4d8","modified":1714795013842},{"_id":"public/libs/materialize/materialize.min.css","hash":"d1328a7872827bc63e7cc4d33745397681accda8","modified":1714795013842},{"_id":"public/libs/materialize/materialize.min.js","hash":"8eee32acbfac59744b4053a7290f503ef623d3ab","modified":1714795013842},{"_id":"public/libs/others/sakura-half.js","hash":"a41b64af88fdd0e2d3502752d059661c1bc743dc","modified":1714795013842},{"_id":"public/libs/others/sakura-reduce.js","hash":"f7527e9fb4e6fe2cc7c8880692d77bcda95900c7","modified":1714795013842},{"_id":"public/libs/others/sakura-small.js","hash":"3284a9ab71454e574d80663f3a05735cd12a6a05","modified":1714795013842},{"_id":"public/libs/others/sakura.js","hash":"9e196ab241799126e6a2dd23ee1708b1505ccbf0","modified":1714795013842},{"_id":"public/libs/twikoo/twikoo.all.min.js","hash":"ef3df94e37942d87ab937c8e34e3c20b162324a3","modified":1714795013842},{"_id":"public/libs/valine/Valine.min.js","hash":"d081a412c63411a75a3a880ddece65335d1c3ee8","modified":1714795013842},{"_id":"public/libs/valine/av-min.js","hash":"db56ef6acb789da00d39bd6b97c1b09c2d429195","modified":1714795013842},{"_id":"public/libs/waline/Waline.min.js","hash":"94f70e622e2a1ab05adb205033a9ddf371c61534","modified":1714795013842},{"_id":"public/libs/awesome/css/all.css","hash":"8d63fa8b0f60a50b07ac0f7e751f6f5e02ecdc44","modified":1714795013842},{"_id":"public/libs/awesome/css/all.min.css","hash":"0ae47fa834fb55de7b50c79021aeabecfae50c9c","modified":1714795013842},{"_id":"public/libs/lightGallery/css/lightgallery.min.css","hash":"7873d80020ae04955bb57521bd249a6974d1180f","modified":1714795013842},{"_id":"public/libs/lightGallery/js/lightgallery-all.min.js","hash":"aab2633f69581c2e26e22a23712f1501d7fcec18","modified":1714795013842},{"_id":"public/libs/share/js/jquery.share.min.js","hash":"41367dcb857e02e3c417ebe68a554ce1d4430806","modified":1714795013842},{"_id":"public/libs/share/js/social-share.min.js","hash":"a3090a02786dcd4efc6355c1c1dc978add8d6827","modified":1714795013842},{"_id":"public/medias/cover.jpg","hash":"d4957ff7cc5e88555cd840f2956ab0561e6f1ccf","modified":1714795013842},{"_id":"public/medias/banner/1.jpg","hash":"ab122a36998a4f62a61e61a4fc5e00248113413b","modified":1714795013842},{"_id":"public/medias/banner/5.jpg","hash":"852418f4f09e796e12bc3bab7a1488d3f37d6486","modified":1714795013842},{"_id":"public/libs/awesome/webfonts/fa-brands-400.ttf","hash":"fa5745d421c0fc90928626be98e9f8cf7580b327","modified":1714795013842},{"_id":"public/libs/awesome/webfonts/fa-solid-900.woff2","hash":"1979128e8ba1517d85f5e4ee505abf486c51557c","modified":1714795013842},{"_id":"public/libs/echarts/echarts.min.js","hash":"9496f386a0da4601cad22c479cc5543913a4d67f","modified":1714795013842},{"_id":"public/libs/gitalk/gitalk.min.js","hash":"564fc7c731d05fa70d71ef853a2c8cc7725739e2","modified":1714795013842},{"_id":"public/libs/prism/prism.min.js","hash":"05870d7dd627c6ef5ffff5c607bc5a4ff9c84afd","modified":1714795013842},{"_id":"public/libs/mermaid/mermaid.min.js","hash":"6bee48c26c32b90f50519f125890fcbb04779da6","modified":1714795013842},{"_id":"public/medias/banner/4.jpg","hash":"e5ac5033678afa9d69edffe9a61004f836cb5734","modified":1714795013842},{"_id":"public/libs/awesome/webfonts/fa-solid-900.ttf","hash":"e3339400ef6214cfa077d003daed2bfa659e2956","modified":1714795013842},{"_id":"public/libs/mermaid/mermaid.js","hash":"a7933bef8aba190825ba7716497209187ac1de5d","modified":1714795013842},{"_id":"public/medias/banner/3.jpg","hash":"e3ec7f8488f1fcbd91e0e31d1430a0e470db2496","modified":1714795013842},{"_id":"public/medias/images/01.jpg","hash":"18f26efc76f6ab3b7a9b94238db1183e8faf9a39","modified":1714795013842},{"_id":"public/medias/banner/6.jpg","hash":"0fbb9f5015e7806dc9c39d2d004c01b583966857","modified":1714795013842},{"_id":"public/medias/images/02.jpg","hash":"fce7a8cbf6c61c4d9e68dc87881570be14cdb1de","modified":1714795013842},{"_id":"public/medias/images/03.jpg","hash":"6fdb986b1d31d6644c59b1a676a4c2b8270ded94","modified":1714795013842}],"Category":[{"name":"summary","_id":"clvrkodgx000480rvcmmchmtj"},{"name":"ops","_id":"clvrkodhg000c80rvhjb3gcbg"},{"name":"Kubernetes","_id":"clvrkodj3000t80rv6h2waavy"},{"name":"kubernetes","_id":"clvrkodj8001080rv75ae7lzg"},{"name":"Database","_id":"clvrkodji001780rv6i13f4pz"},{"name":"hexo","_id":"clvrkodjr001f80rv6mp1fzpm"},{"name":"DNS","_id":"clvrkodjy001l80rvd72f2wlq"},{"name":"Hardware","_id":"clvrkodk4001r80rvcih20c9k"},{"name":"Personal","_id":"clvrkodka001y80rvgas160rs"},{"name":"Opentelemetry","_id":"clvrkodke002280rv5rgi9beh"},{"name":"personal","_id":"clvrkodkt002j80rv4hwc8086"}],"Data":[{"_id":"friends","data":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}],"Page":[{"title":"about","date":"2023-10-14T12:36:58.000Z","type":"about","layout":"about","_content":"","source":"about/index.md","raw":"---\ntitle: about\ndate: 2023-10-14 20:36:58\ntype: \"about\"\nlayout: \"about\"\n---\n","updated":"2024-04-20T03:18:37.505Z","path":"about/index.html","comments":1,"_id":"clvrkodfu000080rv4ol60l7t","content":"","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":""},{"title":"categories","date":"2023-10-07T15:14:34.000Z","type":"categories","layout":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2023-10-07 23:14:34\ntype: \"categories\"\nlayout: \"categories\"\n---\n","updated":"2024-04-20T03:18:37.505Z","path":"categories/index.html","comments":1,"_id":"clvrkodgn000280rveruoetnv","content":"","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":""},{"title":"contact","date":"2023-10-14T12:43:39.000Z","type":"contact","layout":"contact","_content":"","source":"contact/index.md","raw":"---\ntitle: contact\ndate: 2023-10-14 20:43:39\ntype: \"contact\"\nlayout: \"contact\"\n---\n","updated":"2024-04-20T03:18:37.505Z","path":"contact/index.html","comments":1,"_id":"clvrkodh1000680rveu2137au","content":"","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":""},{"title":"friends","date":"2023-10-08T12:50:13.000Z","type":"friends","layout":"friends","_content":"","source":"friends/index.md","raw":"---\ntitle: friends\ndate: 2023-10-08 20:50:13\ntype: \"friends\"\nlayout: \"friends\"\n---\n","updated":"2024-04-20T03:18:37.505Z","path":"friends/index.html","comments":1,"_id":"clvrkodh8000880rv0gkncj00","content":"","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":""},{"title":"tags","date":"2023-10-08T12:48:21.000Z","type":"tags","layout":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2023-10-08 20:48:21\ntype: \"tags\"\nlayout: \"tags\"\n---\n","updated":"2024-04-20T03:18:37.505Z","path":"tags/index.html","comments":1,"_id":"clvrkodhc000a80rv5sdgeuuo","content":"","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":""}],"Post":[{"title":"At the end of 2023","date":"2024-01-01T08:56:20.000Z","toc":true,"summary":"2023记录","_content":"# 2023 的结束\n\n1. 失：2023-10-2 和邹漂亮分开了，2018-1-13 我们在一起。很想念，很亏欠，很遗憾，自己不够优秀，落下太远了。她确实值得更优秀的人生。\n2. 得：一份工作, 在云原生入门的机会，重拾学习习惯的氛围。 \n3. 坚持一些标准线：月薪1w+，存款，换房。\n4. 培养一些习惯：练字，赵孟頫、欧阳询的小楷；锻炼身体，不要长胖或者虚弱。\n------\n\n|时间|计划|\n|:---:|:---:|\n|1月|结束k8s基础部分|\n|2月|monitor|\n|3月|cicd|\n|4月|简历投递并约面试|\n|5月|主要找工作|\n|6月|找到工作！！！|\n|1-6|如果辞职就一定要先拿到驾照|","source":"_posts/At-the-end-of-2023.md","raw":"---\ntitle: At the end of 2023\ndate: 2024-01-01 16:56:20\ntags:\n  - personal\ncategories:\n  - summary\ntoc: true\nsummary: 2023记录\n---\n# 2023 的结束\n\n1. 失：2023-10-2 和邹漂亮分开了，2018-1-13 我们在一起。很想念，很亏欠，很遗憾，自己不够优秀，落下太远了。她确实值得更优秀的人生。\n2. 得：一份工作, 在云原生入门的机会，重拾学习习惯的氛围。 \n3. 坚持一些标准线：月薪1w+，存款，换房。\n4. 培养一些习惯：练字，赵孟頫、欧阳询的小楷；锻炼身体，不要长胖或者虚弱。\n------\n\n|时间|计划|\n|:---:|:---:|\n|1月|结束k8s基础部分|\n|2月|monitor|\n|3月|cicd|\n|4月|简历投递并约面试|\n|5月|主要找工作|\n|6月|找到工作！！！|\n|1-6|如果辞职就一定要先拿到驾照|","slug":"At-the-end-of-2023","published":1,"updated":"2024-04-20T03:18:37.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodg4000180rv2a3n85rn","content":"<h1 id=\"2023-的结束\"><a href=\"#2023-的结束\" class=\"headerlink\" title=\"2023 的结束\"></a>2023 的结束</h1><ol>\n<li>失：2023-10-2 和邹漂亮分开了，2018-1-13 我们在一起。很想念，很亏欠，很遗憾，自己不够优秀，落下太远了。她确实值得更优秀的人生。</li>\n<li>得：一份工作, 在云原生入门的机会，重拾学习习惯的氛围。 </li>\n<li>坚持一些标准线：月薪1w+，存款，换房。</li>\n<li>培养一些习惯：练字，赵孟頫、欧阳询的小楷；锻炼身体，不要长胖或者虚弱。</li>\n</ol>\n<hr>\n<table>\n<thead>\n<tr>\n<th align=\"center\">时间</th>\n<th align=\"center\">计划</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1月</td>\n<td align=\"center\">结束k8s基础部分</td>\n</tr>\n<tr>\n<td align=\"center\">2月</td>\n<td align=\"center\">monitor</td>\n</tr>\n<tr>\n<td align=\"center\">3月</td>\n<td align=\"center\">cicd</td>\n</tr>\n<tr>\n<td align=\"center\">4月</td>\n<td align=\"center\">简历投递并约面试</td>\n</tr>\n<tr>\n<td align=\"center\">5月</td>\n<td align=\"center\">主要找工作</td>\n</tr>\n<tr>\n<td align=\"center\">6月</td>\n<td align=\"center\">找到工作！！！</td>\n</tr>\n<tr>\n<td align=\"center\">1-6</td>\n<td align=\"center\">如果辞职就一定要先拿到驾照</td>\n</tr>\n</tbody></table>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"2023-的结束\"><a href=\"#2023-的结束\" class=\"headerlink\" title=\"2023 的结束\"></a>2023 的结束</h1><ol>\n<li>失：2023-10-2 和邹漂亮分开了，2018-1-13 我们在一起。很想念，很亏欠，很遗憾，自己不够优秀，落下太远了。她确实值得更优秀的人生。</li>\n<li>得：一份工作, 在云原生入门的机会，重拾学习习惯的氛围。 </li>\n<li>坚持一些标准线：月薪1w+，存款，换房。</li>\n<li>培养一些习惯：练字，赵孟頫、欧阳询的小楷；锻炼身体，不要长胖或者虚弱。</li>\n</ol>\n<hr>\n<table>\n<thead>\n<tr>\n<th align=\"center\">时间</th>\n<th align=\"center\">计划</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">1月</td>\n<td align=\"center\">结束k8s基础部分</td>\n</tr>\n<tr>\n<td align=\"center\">2月</td>\n<td align=\"center\">monitor</td>\n</tr>\n<tr>\n<td align=\"center\">3月</td>\n<td align=\"center\">cicd</td>\n</tr>\n<tr>\n<td align=\"center\">4月</td>\n<td align=\"center\">简历投递并约面试</td>\n</tr>\n<tr>\n<td align=\"center\">5月</td>\n<td align=\"center\">主要找工作</td>\n</tr>\n<tr>\n<td align=\"center\">6月</td>\n<td align=\"center\">找到工作！！！</td>\n</tr>\n<tr>\n<td align=\"center\">1-6</td>\n<td align=\"center\">如果辞职就一定要先拿到驾照</td>\n</tr>\n</tbody></table>\n"},{"title":"DNS server","date":"2023-12-25T13:37:15.000Z","summary":"记录内网 DNS 的搭建，比较重要的是视图功能的使用、DNS Over Https、DNS Over TLS.","_content":"# 一、DNS 主服务器  \n- 手动更新源，并安装bind9.18  \n```\nsudo add-apt-repository ppa:isc/bind\napt update\nsudo apt install -y  bind9 bind9-utils\n```\n## 1.1 相关文件  \n[references](https://cshihong.github.io/2018/10/15/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E4%B8%8E%E9%85%8D%E7%BD%AE/)  \n`/etc/bind/named.conf`:  主配置文件，包含 bind 服务器的全局设置和引用其他配置文件的指令  \n`/etc/bind/named.conf.default-zones`:  定义了默认的区域（zone），如  localhost 、反向解析等  \n`/etc/bind/named.conf.local`:  用于配置本地区域（zone）和其他定制区域的文件  \n`/etc/bind/named.conf.options`:  包含bind服务器的全局选项设置，如监听地址、转发器等  \n\n## 1.2 配置  \n### 1.2.1  解析方式  \n\n   |方式|作用|\n   |:--:|:--:|\n   |正向|域名-->IP|\n   |反向|IP-->域名|\n\n### 1.2.2  DNS记录类型  \n- A 记录：将域名指向一个 ipv4  \n- AAAA 记录：将主机名解析到一个指定的 IPv6  \n- CNAME 记录：别名解析，指将不同的域名都转到一个域名记录上，由这个域名记录统一解析管理，即当前解析的域名是另一个域名的跳转  \n- NS 记录：域名服务记录，用来指定该域名由哪个 DNS 服务器来解析，一般设置为多个，一个为主，其余为辅，且只能写域名的形式  \n- PTR 记录：反向解析，主要用于 IP 解析为 FQDN  \n- MX 记录： 邮件交换记录  \n- TXT 记录： 指某个主机名或域名的说明，通常用来做SPF记录（反垃圾邮件）  \n\n### 1.2.3  目录结构（需要修改部分）   \n/etc/bind  \n├── example  \n│   ├── db.zones  \n│   └── reverse.zones  \n├── named.conf  \n└──named.conf.options   \n### 1.2.4  配置文件  \n- /etc/bind/named.conf  \n```\ninclude \"/etc/bind/named.conf.options\";\ninclude \"/etc/bind/named.conf.local\";\n# include \"/etc/bind/named.conf.default-zones\";       # 在视图使用时注释掉的\ninclude \"/etc/bind/example/sec-trust-anchors.conf\";     #  在 dnssec 功能中需要做的引入\n```\n- /etc/bind/named.conf.options  \n\n```bash\ntls doh {\n   key-file \"/etc/bind/example/cert/key.pem\";\n   cert-file \"/etc/bind/example/cert/ca.pem\";\n};\n\nhttp dns-over-https {\n    endpoints {\"/dns-query\";};\n};\n\noptions {\n        directory \"/var/cache/bind\";\n        listen-on port 53 { localhost; };\n        listen-on port 443 tls doh http dns-over-https  { localhost; };     # 配合上述 tls  http 开启 DOH\n        recursion true;                # 否则会出现不能解析 wan 网域名\n        forwarders {\n            8.8.8.8;\n            223.5.5.5;\n        };\n        forward  first;\n        version  \"hiden version\";\n        allow-transfer { 10.13.3.107; };\n        allow-query {\n          example;\n          company;\n        };\n        auth-nxdomain true;\n        dnssec-validation false;\n};\n\nacl \"example\" {\n    10.10.6.0/24;\n    10.13.3.0/24;\n};\n\nacl \"company\" {\n    10.10.6.0/24;\n};\n\nview \"example\" {\n  match-clients { example; };\n  zone \"example.net\" IN  {\n       type master;\n       file \"/etc/bind/example/example.db.zones\";\n  };\n  zone \"13.10.in-addr.arpa.\" IN  {\n       type master;\n       file \"/etc/bind/example/example.reverse.zones\";\n  };\n};\n\nview \"company\" {\n  match-clients { company; };\n  zone \"company.com\" IN  {\n       type master;\n       file \"/etc/bind/example/company.db.zones\";\n  };\n};\n```\n\n视图使用主要参考本章[智能视图使用](##)\n\n- /etc/bind/example/example.db.zones  \n\n```\n$TTL 10M\n@       IN      SOA     example.top. admin.example.top. (\n                                   1   ; serial\n                                1200   ; refresh \n                                900    ; retry \n                                900    ; expire\n                               1200 )  ; minimum \n@        IN      NS      nameserver\nnameserver   IN  A       10.13.3.107\nnameserver  IN  A       10.13.3.109    \ntest         IN  A       10.13.3.109\nk8s          IN  A       10.13.3.110\n```\n\n- 反向区域解析文件 /etc/bind/example/example.reverse.zones  \n```\n$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n)\n       IN      NS      nameserver.      # 不能缺省这个\".\"\n\n107.3  IN    PTR    ldap.example.net.\n```\n\n- 测试  \n```\ndig   目标域名   @namserver    +short\ndig   目标ip   -x   +short\nnslookup\n```\n\n### 1.2.5  参数介绍  \n\nallow-update { none; };  定义允许执行动态 DNS 更新的客户端  \nallow-transfer { xx ; } 允许 xx 地址从您的 DNS 服务器复制数据  \nforward first; 优先选择转发到的 DNS 服务器  \nforwarders {}; 转发器，转发到另外的 DNS  \nrecursion yes; 启用递归查询  \ndnssec-validation no; 禁用 BIND9 服务器上的 DNSSEC 验证，此时返回的数据或许有准确度的问题  \nauth-nxdomain no; 符合 RFC1035  \n\n1. Refresh（刷新）：Refresh 指定了 DNS 服务器应从主服务器获取区域数据的频率。最佳的 Refresh 时间取决于你的特定需求，通常在几小时到一天之间。较短的 Refresh 时间可以更快地更新数据，但会增加主服务器的负载。  \n2. Retry（重试）：Retry 指定了 DNS 服务器在未能联系到主服务器时应进行的重试间隔。最佳的 Retry 时间通常在几分钟到一小时之间，取决于网络的可靠性和延迟。较短的 Retry 时间可以更快地恢复到主服务器，但会增加 DNS 查询负载。  \n3. Expire（过期）：Expire 指定了区域数据在主服务器不可用时的最大存储时间。最佳的 Expire 时间通常在几天到一周之间。较短的 Expire 时间可以更快地更新过期的数据，但会增加 DNS 查询的负载。  \n4. Minimum TTL（最小生存时间）：Minimum TTL 指定了 DNS 解析器或缓存服务器应保留解析结果的最小时间。最佳的 Minimum TTL 时间取决于你的特定需求，通常在几分钟到一天之间。较短的 Minimum TTL 时间可以更快地更新解析结果，但会增加 DNS 查询的负载。  \n\n----------------\n# 二、DNS 从服务器  \n## 2.1  配置  \n```\n/etc/bind/named.conf\n\t同于 master 即可\n```\n\n- /etc/bind/named.conf.options\n```\ntls doh {\n   key-file \"/etc/bind/example/cert/key.pem\";\n   cert-file \"/etc/bind/example/cert/ca.pem\";\n};\n\nhttp dns-over-https {\n    endpoints {\"/dns-query\";};\n};\n\noptions {\n        directory \"/var/cache/bind\";\n        listen-on port 53 { localhost; };\n        listen-on port 443 tls doh http default { localhost; };\n        recursion true;\n        forwarders {\n            8.8.8.8;\n            223.5.5.5;\n        };\n        forward  first;\n        version  \"hiden version\";\n        allow-query {\n          example;\n          company;\n        };\n        auth-nxdomain true;\n        dnssec-validation false;\n};\n\nacl \"example\" {\n    10.10.6.0/24;\n    10.13.3.0/24;\n};\n\nacl \"company\" {\n    10.10.6.0/24;\n};\n\nview \"example\" {\n  match-clients { example; };\n  zone \"example.net\" IN  {\n       type slave;\n       file \"/etc/bind/example/example.db.zones.signed\";\n       masters { 10.13.3.106; };\n  };\n  zone \"3.13.10.in-addr.arpa.\" IN  {\n       type slave;\n       masters { 10.13.3.106; };\n       file \"/etc/bind/example/example.reverse.zones\";\n  };\n};\n\nview \"company\" {\n  match-clients { company; };\n  zone \"company.com\" IN  {\n       type slave;\n       masters { 10.13.3.106; };\n       file \"/etc/bind/example/company.db.zones\";\n  };\n};\n```\n\n- /etc/ apparmor.d/usr.sbin.named  设置可写。dumping master file: /etc/bind/example/tmp-80LUGLiqE4: open: permission denied  \n```\n/etc/bind/example/** rw,\n\nsystemctl reload apparmor.service\n```\n\n## 2.2 测试记录同步  \n- 修改主服务器，解析记录，测试从服务器的同步情况  \n```\n$TTL 10M\n@       IN      SOA     example.top.  admin.example.top. (\n                                   2   ; serial   [[每次需要修改版本号]]\n                                1200   ; refresh \n                                900    ; retry \n                                900    ; expire\n                               1200 )  ; minimum \n@        IN      NS      nameserver\n@        IN      NS      nameserver2              [[较版本1新增]]\nnameserver   IN  A       10.13.3.107\nnameserver2  IN  A       10.13.3.109              [[较版本1新增]]\ntest         IN  A       10.13.3.109\nk8s          IN  A       10.13.3.110\nme           IN  A       10.10.6.1               [[较版本1新增]]\n```\n\n**热加载**新增的配置，每次修改记录时，需要同步修改***版本号***，slave 才能同步成功  \n```\nsudo rndc reload     # 主服务器执行即可\ndig -t a me.example.top @10.13.3.109\n```\n\n- 当从服务器有解析文件的，解析记录仍会向主服务器请求，主服务器宕机，从服务器缓存过期之后，也仍不能加载并实施解析区域记录文件  \n- 同一个网段在多个acl下，将不能正常解析。  \n\n## 2.3 测试公网域名  \n- 此時公网域名成功解析得到的是保留ip地址，ping 域名不能成功----因为公司的 ip 做了加密  \n- 不能成功解析则无记录返回  \n\n-------------\n# 三、 安全  \n## 3.1 功能同于bind-chroot  \n```\nvi /etc/apparmor.d/usr.sbin.named\n# 检查是否存在，否则增加以下内容\n  /etc/bind/** r,\n  /var/lib/bind/** rw,\n  /var/lib/bind/ rw,\n  /var/cache/bind/** lrw,\n  /var/cache/bind/ rw,\n  /var/log/named/** rw,\n  /var/log/named/ rw,\n```\n\n## 3.2 开启DNSSEC验证，[参考](https://www.cnblogs.com/anpengapple/p/5879363.html)  \n- 作用：对域名进行签名认证，保证域名的完整性和正确性，不会被修改  \n- 在新增的 dnssec_keys 目录中生成密钥  \n```\nsudo dnssec-keygen -f KSK -a RSASHA256 -b 2048 -n ZONE example.net.\nsudo dnssec-keygen -a RSASHA256  -b 2048 -n ZONE example.net.\n\n# 查看本域应用所需的密钥文件  \nls \nKexample.net.+008+16296.key   Kexample.net.+008+16296.private   Kexample.net.+008+23579.key  Kexample.net.+008+23579.private\n```\n\n- 将前面生成的两个公钥添加到区域配置文件末尾  \n```\n$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m )  ; minimum\n\n@        IN      NS      nameserver\n\nnameserver       IN      A       10.13.3.106\nldap   IN  A   10.13.3.107\ntest   IN  A   10.13.3.105\n\n$INCLUDE  \"/etc/bind/example/dnssec_keys/Kexample.net.+008+23579.key\"\n$INCLUDE  \"/etc/bind/example/dnssec_keys/Kexample.net.+008+16296.key\"\n```\n\n- 对区域文件签名，会生成一个新的zones.sigend. 如果新增了解析记录，需要再次加密  \n```\nsudo dnssec-signzone -K /etc/bind/example/dnssec_keys/ -o example.net. /etc/bind/example/example.db.zones\n -K  指定密钥文件路径    -o  域名   路径是区域解析文件路径\n```\n\n- 改动引用解析文件路径的位置  \n```shell\nview \"example\" {\n  match-clients { example; };\n  zone \"example.net\" IN  {\n       type master;\n       file \"/etc/bind/example/example.db.zones.signed\";\n  };\n};\n```\n\n- 生成信任锚文件 /etc/bind/example/sec-trust-anchors.conf  \n- 这里面的两条内容是刚才生成的两个密钥的内容。用公钥比较方便（也就是.key的文件）。注意复制的时候去掉“IN”和“DNSKEY”这两个词，以及后面的key要加引号  \n```bash\ntrusted-keys {\n   example.net.   256 3 8  \"AwEAAb+3BGqXqE/WwDICGRONYv1w4savuaD4cJ/VRL6xGg2b54OilEWE WMzUAOw4B/sPyKZDG/XTnaW4mD756l/swRuq9kO/sktgu4ZP4onmqeFM sdMTTmxesp6Q6ebqAPNzQfKyZwqX6Iq00qGslUmxr5FSOLWjGoze8afm TxbPW6Hi7JQ85mJ+TkpUNa+ymDS4qKi87rSi8NQTDbsZ0wH7+zX1TBOP jeUI/JsxD/bu1kD97AP9u2Sd4D8U0vyN8fN4LIIKfA5vurPaWPfQIM8r I0KQueAHdNLOPjaEWcKg/rBHFWZPxIeQGM8D2VXwkdPL5fefC59wONhK ys2RMqv3DIM=\";\n  example.net.   257 3 8 \"AwEAAbZo3hpm+0+32jgrTXog3CCUTTctP3LoBx1F0nbpoEBkWN1CA//O 7fzNY08pwblkKKW/LkYiQNQEQq50ThouV9UJ+CFRf/Fju6ggIpWpNjsu 8c2+zROZdJ9d2T6JnVTYPo1Iyn8ufn0hFjPRrwdvfQKSmnI9ZRx2eRFc ZFJpqNTj2LwzqoEKrbOn4oywqTWJL1Hyjv8e/kBojy7BghKWYnTGlpha 9CSin17qUQCY+o0qMzmezq+/AbxhdJwV9KYHWzWvNZjyyjBLyxwwsV4F shgmXm2tTuW5gPrnbfzaP+R/cElzl03mtjmJ//g5wWMMV8QKemBpbNoR ajzYYhhocWk=\";\n};\n```\n\n- 引入此信任锚文件 /etc/bind/name.conf  \n```\ninclude \"/etc/bind/example/sec-trust-anchors.conf\";\n```\n\n- 重启服务  \n- 验证  \n```shell\ndig +dnssec  test.example.net  @10.13.3.106\n\n; <<>> DiG 9.16.1-Ubuntu <<>> +dnssec test.example.net @10.13.3.106\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 28767\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags: do; udp: 1232\n; COOKIE: 0d6b52d25063b09401000000655592b51d0f8f6c0b072961 (good)\n;; QUESTION SECTION:\n;test.example.net.                        IN      A\n\n;; ANSWER SECTION:\ntest.example.net.         600     IN      A       10.13.3.105\ntest.example.net.         600     IN      RRSIG   A 8 3 600 20231216022642 20231116022642 16296 example.net. iUSB+maT6y22ySZdEZHElShHCVDbmjnHez39eosniP1wqvquyadVydlT lZ3XZbUMNTV3WrZhLEjuGaVwNajvAqeY07IPCivpr+VCuIPXccONBwZE 3ZRX5B2PcGnrhMWupH+jcoT5NTy5pAEdm5JXbtJljFyJk1XxQVhanzJO /TY7YMJWWDbj3WnywkEPQyP5UYExl4Y0E3BPUX/J4xuCspTovQhqo6BM HaC3XFMG1Li9CbHcfNkUjVtdi8oQmAdM6lMqFTz5KNpIRppqhEukcD9o w9slLc1vpjDwqzO7xPls8S9WbzMeHzHNbIrPcv88MQWUAIVyqodbhOvj 8ZKlgg==\n\n;; Query time: 0 msec\n;; SERVER: 10.13.3.106#53(10.13.3.106)\n;; WHEN: Thu Nov 16 11:55:33 CST 2023\n;; MSG SIZE  rcvd: 384\n```\n\n- 问题：  \n- 配置后，每个客户端需要添加信任锚文件以作签名验证  \n- 这个签名后的zone可以被伪造，使用dig命令输出的文件修改伪造  \n\n## 3.3 创建视图管理，智能DNS  \n[参考1](https://www.cnblogs.com/anpengapple/p/5879350.html)  \n[参考2](https://www.cnblogs.com/etangyushan/p/4335521.html)  \n[参考3](http://www.hangdaowangluo.com/archives/1633)  \n[ubuntu案例](https://www.server-world.info/en/note?os=Ubuntu_20.04&p=dns&f=5)  \n- vim  /etc/bind/named.conf  \n\n```bash\ninclude \"/etc/bind/named.conf.options\";\ninclude \"/etc/bind/named.conf.local\";\n# include \"/etc/bind/named.conf.default-zones\";\n```\n\n- cat  /etc/bind/named.conf.options  \n\n```\noptions {\n        directory \"/var/cache/bind\";\n        listen-on port 53 { localhost; };\n        recursion yes;        # 允许递归才能在智能dns解析万网域名\n        forwarders {\n          223.5.5.5;\n        };\n        forward  first;\n        version  \"hiden version\";   # 隐藏版本\n        allow-transfer { 10.13.3.106; };\n        allow-query { \n          example;\n          company;\n        };\n        auth-nxdomain true;\n        dnssec-validation false; # dns安全拓展的选项\n};\n# 此处定义目标ip地址段，划分可访问的域\nacl \"example\" {\n    10.13.3.0/24;\n    10.10.6.0/24;\n};\n\nacl \"company\" {\n    10.10.6.0/24;\n};\n# 此处制定目标ip可以访问的域名的解析区域\nview \"example\" {\n  match-clients { example; };\n  include \"/etc/bind/example/example.views\";\n};\n\nview \"company\" {\n  match-clients { company; };\n  include \"/etc/bind/example/company.views\";\n};\n```\n- views 文件中指定区域解析文件，eg：\n\n```bash\nzone \"example.net\" IN {                                          # 此处域名和 zones 文件中的域名一致\n      type master;\n      file \"/etc/bind/example/example.net.zones\";\n   };\nzone \"3.13.10.in-addr.arpa.\" IN {                         # 此处格式固定，设计反向解析的ip的网络位，和zones文件中的主机位结合成为完整ip地址\n      type master;\n      file \"/etc/bind/example/example.net.reverse.zones\";\n};\n\nzone \"example.top\" IN {                              # 配置此 dns 向 10.13.3.101 这个转发器请求解析 example.top 的域名。在全局 options 配置转发没有成功，选择了此方案。\n      type forward;\n      forwarders {10.13.3.101;};\n};\n```\n\n- 正向区域解析文件  \n```\n$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n) \n@        IN      NS      nameserver\n\nnameserver       IN      A       10.13.3.106\n\nldap   IN  A   10.13.3.107\ntest   IN  A   10.13.3.105\n```\n\n- 反向区域解析文件  \n```\n$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n)\n       IN      NS      nameserver.      # 不能缺省这个\".\"\n\n107  IN    PTR    ldap.example.net.\n```\n\n- 测试   \n```\ndig   目标域名   @namserver    +short\ndig   目标ip   -x   +short\nnslookup\n```\n\n## 3.4 加密  \n[知名公共DoT/DoH加密DNS服务器](https://runtufenxiang.com/6186/)   \n[配置](https://devblog.rayonnant.net/creating-a-dot-and-doh-server-using-nginx-and-bind/)    \n[bind9 tls / https](https://dididudu998.github.io/2022/02/15/configure-doh-bind.html)网络层的问题是DoT使用853的端口，很容易被封锁，而DoH使用443端口，一般不会被封锁    \n### 3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）   \n```\ntls mycert {\n    cert-file \"/etc/bind/example/cert.pem\";\n    key-file \"/etc/bind/example/key.pem\";\n};\n\noptions {\n    directory \"/var/cache/bind\";\n    listen-on port 853 tls mycert { localhost; };\n    forward  first;\n    forwarders {\n            223.5.5.5;\n            120.53.53.53;\n    };\n    allow-query { 10.13.3.0/24;};\n    auth-nxdomain true;\n    allow-update { none; };\n  //  allow-transfer { 10.13.3.106; };\n    version  \"hiden version\";\n    recursion false;\n};\n\nzone \"example.net\"{\n   type master;\n   file \"/etc/bind/example/example.net.zones\";\n};\n```\n\n- 客户端修改dns地址步骤如下：  \n- /etc/resolv.conf  是软链接，指向了/run/systemd/resolve/stub-resolv.conf。直接修改内容会被覆盖，没有意义  \n- vim /etc/systemd/resolved.conf  \n```\n[Resolve]\nDNS=10.13.3.106\n[[FallbackDNS]]=\nDNSOverTLS=opportunistic  # 或者yes\n```\n- systemctl restart systemd-resolved.service   \n- mv /etc/resolv.conf   /etc/resolv.conf.bak  \n- ln -s /run/systemd/resolve/resolv.conf /etc/  \n\n### 3.4.2 问题  \n- 以上配置之后，使用特定命令发现 DOT 是成功的，例如  \n```\nresolvectl query mee.example.net\n\tmee.example.net: 10.10.6.1                       -- link: ens160\n\t\n\t-- Information acquired via protocol DNS in 1.7ms.\n\t-- Data is authenticated: no\n\ndig +tls mee.example.net\n\t; <<>> DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu <<>> +tls mee.example.net\n\t;; global options: +cmd\n\t;; Got answer:\n\t;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 52275\n\t;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\t;; WARNING: recursion requested but not available\n\t\n\t;; OPT PSEUDOSECTION:\n\t; EDNS: version: 0, flags:; udp: 1232\n\t; COOKIE: 174ae084d3aed77f01000000655474d3fbb4902501bc69cb (good)\n\t;; QUESTION SECTION:\n\t;mee.example.net.                 IN      A\n\t\n\t;; ANSWER SECTION:\n\tmee.example.net.          600     IN      A       10.10.6.1\n\t\n\t;; Query time: 0 msec\n\t;; SERVER: 10.13.3.106#853(10.13.3.106) (TLS)\n\t;; WHEN: Wed Nov 15 15:35:47 CST 2023\n\t;; MSG SIZE  rcvd: 86\n以上访问了dns服务器853端口，所以返回正常解析\n```\n\n- 普通解析会失败  \n```\ndig mee.example.net  （nslookup ssh  ping）\n\t;; communications error to 10.13.3.106#53: connection refused\n\t;; communications error to 10.13.3.106#53: connection refused\n\t;; communications error to 10.13.3.106#53: connection refused\n\t\n\t; <<>> DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu <<>> mee.example.net\n\t;; global options: +cmd\n\t;; no servers could be reached\n```\n\n- 因此，仍然开启 53 端口，二者同时可以使用，但是如果需要特定的方式使用DNSOverTLS ，那么以目前在服务器上的使用上来看，使用是没有意义的。  \n- 在服务器使用 53，在浏览器使用自建 DOH，是适宜的  \n\n### 3.4.3  DOH 加密和转发  \n- 配置  \n```shell\ntls doh {\n   key-file \"/etc/bind/example/cert/key.pem\";\n   cert-file \"/etc/bind/example/cert/ca.pem\";\n};\n\nhttp dns-over-https {\n    endpoints {\"/dns-query\";};\n};\n\noptions {\n        listen-on port 443 tls doh http default { localhost; };\n\t\t......\n};\n```\n\n- 检测  \n```shell\ndig +https  test.example.net  @10.13.3.106 A\n\n; <<>> DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu <<>> +https test.example.net @10.13.3.106 A\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 15036\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; COOKIE: dcdab07360fe04b2010000006555c9c6572491f7e49a2f35 (good)\n;; QUESTION SECTION:\n;test.example.net.                        IN      A\n\n;; ANSWER SECTION:\ntest.example.net.         600     IN      A       10.13.3.105\n\n;; Query time: 0 msec\n;; SERVER: 10.13.3.106#443(10.13.3.106) (HTTPS)\n;; WHEN: Thu Nov 16 15:50:30 CST 2023\n;; MSG SIZE  rcvd: 87\n```\n\n- 使用  \n此时在客户端使用 DOH ，浏览器设置 use secure dns ，custom url ： https://nameserver.example.net/dns-query  \n在客户端其他程序的使用中，仍然会访问 dns 的 53 端口  \n\n## 3.5 其他安全实践  \n- 下列参考[来源](https://www.secpulse.com/archives/52634.html)  \n```\n隐藏BIND版本号\n限定哪台主机能够发起区域传输\n```\n\n```\nversion  \"hiden version\";                             #  隐藏版本信息\nallow-transfer { 221.236.9.9; };    #  指定允许某从服务器进行区域传输到该服务器，此配置一般在主服务器配置\n```\n\n# 四、web 管理以及反向代理  \n[安装 webmin工具](https://www.mmcloud.com/2863.html)  \n[使用ngingx反代](https://devpress.csdn.net/cloud/6304db5f7e6682346619cf4b.html)  \n- 路径nginx/conf.d/webmin.conf   （检查443、80端口，确认dns地址和解析记录）  \n```\nupstream webmin {\n  server 10.13.3.107:10000;\n}\n\nserver {\n  listen 80;\n  server_name webmin.example.net;\n  return 301 https://$server_name$request_uri;\n}\n\nserver {\n  server_name webmin.example.net;\n  listen 443 ssl;\n  ssl_certificate webmin/tls_ca.pem;\n  ssl_certificate_key webmin/tls_key.pem;\n\n  location / {\n    proxy_pass      https://webmin;\n    proxy_redirect  off;\n    proxy_set_header   Host             $host:$server_port;\n    proxy_set_header   X-Real-IP        $remote_addr;\n    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto \"https\";\n    proxy_connect_timeout      10;\n    proxy_send_timeout         10;\n    proxy_read_timeout         10;\n    proxy_buffer_size          128k;\n    proxy_buffers              32 32k;\n    proxy_busy_buffers_size    256k;\n    proxy_temp_file_write_size 256k;\n  }\n}\n```\n# 五、bind9.18  nginx 反向代理  \n[反向代理参考](https://www.infvie.com/ops-notes/nginx-udp-dns.html)  \n\n\n\n[def]: DNS%20Server.md#3.3%20创建视图管理，智能DNS","source":"_posts/DNS-server.md","raw":"---\ntitle: DNS server\ndate: 2023-12-25 21:37:15\ntags:\n - DNS\n - Ubuntu\ncategories:\n  - ops\nsummary: 记录内网 DNS 的搭建，比较重要的是视图功能的使用、DNS Over Https、DNS Over TLS.\n---\n# 一、DNS 主服务器  \n- 手动更新源，并安装bind9.18  \n```\nsudo add-apt-repository ppa:isc/bind\napt update\nsudo apt install -y  bind9 bind9-utils\n```\n## 1.1 相关文件  \n[references](https://cshihong.github.io/2018/10/15/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E4%B8%8E%E9%85%8D%E7%BD%AE/)  \n`/etc/bind/named.conf`:  主配置文件，包含 bind 服务器的全局设置和引用其他配置文件的指令  \n`/etc/bind/named.conf.default-zones`:  定义了默认的区域（zone），如  localhost 、反向解析等  \n`/etc/bind/named.conf.local`:  用于配置本地区域（zone）和其他定制区域的文件  \n`/etc/bind/named.conf.options`:  包含bind服务器的全局选项设置，如监听地址、转发器等  \n\n## 1.2 配置  \n### 1.2.1  解析方式  \n\n   |方式|作用|\n   |:--:|:--:|\n   |正向|域名-->IP|\n   |反向|IP-->域名|\n\n### 1.2.2  DNS记录类型  \n- A 记录：将域名指向一个 ipv4  \n- AAAA 记录：将主机名解析到一个指定的 IPv6  \n- CNAME 记录：别名解析，指将不同的域名都转到一个域名记录上，由这个域名记录统一解析管理，即当前解析的域名是另一个域名的跳转  \n- NS 记录：域名服务记录，用来指定该域名由哪个 DNS 服务器来解析，一般设置为多个，一个为主，其余为辅，且只能写域名的形式  \n- PTR 记录：反向解析，主要用于 IP 解析为 FQDN  \n- MX 记录： 邮件交换记录  \n- TXT 记录： 指某个主机名或域名的说明，通常用来做SPF记录（反垃圾邮件）  \n\n### 1.2.3  目录结构（需要修改部分）   \n/etc/bind  \n├── example  \n│   ├── db.zones  \n│   └── reverse.zones  \n├── named.conf  \n└──named.conf.options   \n### 1.2.4  配置文件  \n- /etc/bind/named.conf  \n```\ninclude \"/etc/bind/named.conf.options\";\ninclude \"/etc/bind/named.conf.local\";\n# include \"/etc/bind/named.conf.default-zones\";       # 在视图使用时注释掉的\ninclude \"/etc/bind/example/sec-trust-anchors.conf\";     #  在 dnssec 功能中需要做的引入\n```\n- /etc/bind/named.conf.options  \n\n```bash\ntls doh {\n   key-file \"/etc/bind/example/cert/key.pem\";\n   cert-file \"/etc/bind/example/cert/ca.pem\";\n};\n\nhttp dns-over-https {\n    endpoints {\"/dns-query\";};\n};\n\noptions {\n        directory \"/var/cache/bind\";\n        listen-on port 53 { localhost; };\n        listen-on port 443 tls doh http dns-over-https  { localhost; };     # 配合上述 tls  http 开启 DOH\n        recursion true;                # 否则会出现不能解析 wan 网域名\n        forwarders {\n            8.8.8.8;\n            223.5.5.5;\n        };\n        forward  first;\n        version  \"hiden version\";\n        allow-transfer { 10.13.3.107; };\n        allow-query {\n          example;\n          company;\n        };\n        auth-nxdomain true;\n        dnssec-validation false;\n};\n\nacl \"example\" {\n    10.10.6.0/24;\n    10.13.3.0/24;\n};\n\nacl \"company\" {\n    10.10.6.0/24;\n};\n\nview \"example\" {\n  match-clients { example; };\n  zone \"example.net\" IN  {\n       type master;\n       file \"/etc/bind/example/example.db.zones\";\n  };\n  zone \"13.10.in-addr.arpa.\" IN  {\n       type master;\n       file \"/etc/bind/example/example.reverse.zones\";\n  };\n};\n\nview \"company\" {\n  match-clients { company; };\n  zone \"company.com\" IN  {\n       type master;\n       file \"/etc/bind/example/company.db.zones\";\n  };\n};\n```\n\n视图使用主要参考本章[智能视图使用](##)\n\n- /etc/bind/example/example.db.zones  \n\n```\n$TTL 10M\n@       IN      SOA     example.top. admin.example.top. (\n                                   1   ; serial\n                                1200   ; refresh \n                                900    ; retry \n                                900    ; expire\n                               1200 )  ; minimum \n@        IN      NS      nameserver\nnameserver   IN  A       10.13.3.107\nnameserver  IN  A       10.13.3.109    \ntest         IN  A       10.13.3.109\nk8s          IN  A       10.13.3.110\n```\n\n- 反向区域解析文件 /etc/bind/example/example.reverse.zones  \n```\n$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n)\n       IN      NS      nameserver.      # 不能缺省这个\".\"\n\n107.3  IN    PTR    ldap.example.net.\n```\n\n- 测试  \n```\ndig   目标域名   @namserver    +short\ndig   目标ip   -x   +short\nnslookup\n```\n\n### 1.2.5  参数介绍  \n\nallow-update { none; };  定义允许执行动态 DNS 更新的客户端  \nallow-transfer { xx ; } 允许 xx 地址从您的 DNS 服务器复制数据  \nforward first; 优先选择转发到的 DNS 服务器  \nforwarders {}; 转发器，转发到另外的 DNS  \nrecursion yes; 启用递归查询  \ndnssec-validation no; 禁用 BIND9 服务器上的 DNSSEC 验证，此时返回的数据或许有准确度的问题  \nauth-nxdomain no; 符合 RFC1035  \n\n1. Refresh（刷新）：Refresh 指定了 DNS 服务器应从主服务器获取区域数据的频率。最佳的 Refresh 时间取决于你的特定需求，通常在几小时到一天之间。较短的 Refresh 时间可以更快地更新数据，但会增加主服务器的负载。  \n2. Retry（重试）：Retry 指定了 DNS 服务器在未能联系到主服务器时应进行的重试间隔。最佳的 Retry 时间通常在几分钟到一小时之间，取决于网络的可靠性和延迟。较短的 Retry 时间可以更快地恢复到主服务器，但会增加 DNS 查询负载。  \n3. Expire（过期）：Expire 指定了区域数据在主服务器不可用时的最大存储时间。最佳的 Expire 时间通常在几天到一周之间。较短的 Expire 时间可以更快地更新过期的数据，但会增加 DNS 查询的负载。  \n4. Minimum TTL（最小生存时间）：Minimum TTL 指定了 DNS 解析器或缓存服务器应保留解析结果的最小时间。最佳的 Minimum TTL 时间取决于你的特定需求，通常在几分钟到一天之间。较短的 Minimum TTL 时间可以更快地更新解析结果，但会增加 DNS 查询的负载。  \n\n----------------\n# 二、DNS 从服务器  \n## 2.1  配置  \n```\n/etc/bind/named.conf\n\t同于 master 即可\n```\n\n- /etc/bind/named.conf.options\n```\ntls doh {\n   key-file \"/etc/bind/example/cert/key.pem\";\n   cert-file \"/etc/bind/example/cert/ca.pem\";\n};\n\nhttp dns-over-https {\n    endpoints {\"/dns-query\";};\n};\n\noptions {\n        directory \"/var/cache/bind\";\n        listen-on port 53 { localhost; };\n        listen-on port 443 tls doh http default { localhost; };\n        recursion true;\n        forwarders {\n            8.8.8.8;\n            223.5.5.5;\n        };\n        forward  first;\n        version  \"hiden version\";\n        allow-query {\n          example;\n          company;\n        };\n        auth-nxdomain true;\n        dnssec-validation false;\n};\n\nacl \"example\" {\n    10.10.6.0/24;\n    10.13.3.0/24;\n};\n\nacl \"company\" {\n    10.10.6.0/24;\n};\n\nview \"example\" {\n  match-clients { example; };\n  zone \"example.net\" IN  {\n       type slave;\n       file \"/etc/bind/example/example.db.zones.signed\";\n       masters { 10.13.3.106; };\n  };\n  zone \"3.13.10.in-addr.arpa.\" IN  {\n       type slave;\n       masters { 10.13.3.106; };\n       file \"/etc/bind/example/example.reverse.zones\";\n  };\n};\n\nview \"company\" {\n  match-clients { company; };\n  zone \"company.com\" IN  {\n       type slave;\n       masters { 10.13.3.106; };\n       file \"/etc/bind/example/company.db.zones\";\n  };\n};\n```\n\n- /etc/ apparmor.d/usr.sbin.named  设置可写。dumping master file: /etc/bind/example/tmp-80LUGLiqE4: open: permission denied  \n```\n/etc/bind/example/** rw,\n\nsystemctl reload apparmor.service\n```\n\n## 2.2 测试记录同步  \n- 修改主服务器，解析记录，测试从服务器的同步情况  \n```\n$TTL 10M\n@       IN      SOA     example.top.  admin.example.top. (\n                                   2   ; serial   [[每次需要修改版本号]]\n                                1200   ; refresh \n                                900    ; retry \n                                900    ; expire\n                               1200 )  ; minimum \n@        IN      NS      nameserver\n@        IN      NS      nameserver2              [[较版本1新增]]\nnameserver   IN  A       10.13.3.107\nnameserver2  IN  A       10.13.3.109              [[较版本1新增]]\ntest         IN  A       10.13.3.109\nk8s          IN  A       10.13.3.110\nme           IN  A       10.10.6.1               [[较版本1新增]]\n```\n\n**热加载**新增的配置，每次修改记录时，需要同步修改***版本号***，slave 才能同步成功  \n```\nsudo rndc reload     # 主服务器执行即可\ndig -t a me.example.top @10.13.3.109\n```\n\n- 当从服务器有解析文件的，解析记录仍会向主服务器请求，主服务器宕机，从服务器缓存过期之后，也仍不能加载并实施解析区域记录文件  \n- 同一个网段在多个acl下，将不能正常解析。  \n\n## 2.3 测试公网域名  \n- 此時公网域名成功解析得到的是保留ip地址，ping 域名不能成功----因为公司的 ip 做了加密  \n- 不能成功解析则无记录返回  \n\n-------------\n# 三、 安全  \n## 3.1 功能同于bind-chroot  \n```\nvi /etc/apparmor.d/usr.sbin.named\n# 检查是否存在，否则增加以下内容\n  /etc/bind/** r,\n  /var/lib/bind/** rw,\n  /var/lib/bind/ rw,\n  /var/cache/bind/** lrw,\n  /var/cache/bind/ rw,\n  /var/log/named/** rw,\n  /var/log/named/ rw,\n```\n\n## 3.2 开启DNSSEC验证，[参考](https://www.cnblogs.com/anpengapple/p/5879363.html)  \n- 作用：对域名进行签名认证，保证域名的完整性和正确性，不会被修改  \n- 在新增的 dnssec_keys 目录中生成密钥  \n```\nsudo dnssec-keygen -f KSK -a RSASHA256 -b 2048 -n ZONE example.net.\nsudo dnssec-keygen -a RSASHA256  -b 2048 -n ZONE example.net.\n\n# 查看本域应用所需的密钥文件  \nls \nKexample.net.+008+16296.key   Kexample.net.+008+16296.private   Kexample.net.+008+23579.key  Kexample.net.+008+23579.private\n```\n\n- 将前面生成的两个公钥添加到区域配置文件末尾  \n```\n$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m )  ; minimum\n\n@        IN      NS      nameserver\n\nnameserver       IN      A       10.13.3.106\nldap   IN  A   10.13.3.107\ntest   IN  A   10.13.3.105\n\n$INCLUDE  \"/etc/bind/example/dnssec_keys/Kexample.net.+008+23579.key\"\n$INCLUDE  \"/etc/bind/example/dnssec_keys/Kexample.net.+008+16296.key\"\n```\n\n- 对区域文件签名，会生成一个新的zones.sigend. 如果新增了解析记录，需要再次加密  \n```\nsudo dnssec-signzone -K /etc/bind/example/dnssec_keys/ -o example.net. /etc/bind/example/example.db.zones\n -K  指定密钥文件路径    -o  域名   路径是区域解析文件路径\n```\n\n- 改动引用解析文件路径的位置  \n```shell\nview \"example\" {\n  match-clients { example; };\n  zone \"example.net\" IN  {\n       type master;\n       file \"/etc/bind/example/example.db.zones.signed\";\n  };\n};\n```\n\n- 生成信任锚文件 /etc/bind/example/sec-trust-anchors.conf  \n- 这里面的两条内容是刚才生成的两个密钥的内容。用公钥比较方便（也就是.key的文件）。注意复制的时候去掉“IN”和“DNSKEY”这两个词，以及后面的key要加引号  \n```bash\ntrusted-keys {\n   example.net.   256 3 8  \"AwEAAb+3BGqXqE/WwDICGRONYv1w4savuaD4cJ/VRL6xGg2b54OilEWE WMzUAOw4B/sPyKZDG/XTnaW4mD756l/swRuq9kO/sktgu4ZP4onmqeFM sdMTTmxesp6Q6ebqAPNzQfKyZwqX6Iq00qGslUmxr5FSOLWjGoze8afm TxbPW6Hi7JQ85mJ+TkpUNa+ymDS4qKi87rSi8NQTDbsZ0wH7+zX1TBOP jeUI/JsxD/bu1kD97AP9u2Sd4D8U0vyN8fN4LIIKfA5vurPaWPfQIM8r I0KQueAHdNLOPjaEWcKg/rBHFWZPxIeQGM8D2VXwkdPL5fefC59wONhK ys2RMqv3DIM=\";\n  example.net.   257 3 8 \"AwEAAbZo3hpm+0+32jgrTXog3CCUTTctP3LoBx1F0nbpoEBkWN1CA//O 7fzNY08pwblkKKW/LkYiQNQEQq50ThouV9UJ+CFRf/Fju6ggIpWpNjsu 8c2+zROZdJ9d2T6JnVTYPo1Iyn8ufn0hFjPRrwdvfQKSmnI9ZRx2eRFc ZFJpqNTj2LwzqoEKrbOn4oywqTWJL1Hyjv8e/kBojy7BghKWYnTGlpha 9CSin17qUQCY+o0qMzmezq+/AbxhdJwV9KYHWzWvNZjyyjBLyxwwsV4F shgmXm2tTuW5gPrnbfzaP+R/cElzl03mtjmJ//g5wWMMV8QKemBpbNoR ajzYYhhocWk=\";\n};\n```\n\n- 引入此信任锚文件 /etc/bind/name.conf  \n```\ninclude \"/etc/bind/example/sec-trust-anchors.conf\";\n```\n\n- 重启服务  \n- 验证  \n```shell\ndig +dnssec  test.example.net  @10.13.3.106\n\n; <<>> DiG 9.16.1-Ubuntu <<>> +dnssec test.example.net @10.13.3.106\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 28767\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags: do; udp: 1232\n; COOKIE: 0d6b52d25063b09401000000655592b51d0f8f6c0b072961 (good)\n;; QUESTION SECTION:\n;test.example.net.                        IN      A\n\n;; ANSWER SECTION:\ntest.example.net.         600     IN      A       10.13.3.105\ntest.example.net.         600     IN      RRSIG   A 8 3 600 20231216022642 20231116022642 16296 example.net. iUSB+maT6y22ySZdEZHElShHCVDbmjnHez39eosniP1wqvquyadVydlT lZ3XZbUMNTV3WrZhLEjuGaVwNajvAqeY07IPCivpr+VCuIPXccONBwZE 3ZRX5B2PcGnrhMWupH+jcoT5NTy5pAEdm5JXbtJljFyJk1XxQVhanzJO /TY7YMJWWDbj3WnywkEPQyP5UYExl4Y0E3BPUX/J4xuCspTovQhqo6BM HaC3XFMG1Li9CbHcfNkUjVtdi8oQmAdM6lMqFTz5KNpIRppqhEukcD9o w9slLc1vpjDwqzO7xPls8S9WbzMeHzHNbIrPcv88MQWUAIVyqodbhOvj 8ZKlgg==\n\n;; Query time: 0 msec\n;; SERVER: 10.13.3.106#53(10.13.3.106)\n;; WHEN: Thu Nov 16 11:55:33 CST 2023\n;; MSG SIZE  rcvd: 384\n```\n\n- 问题：  \n- 配置后，每个客户端需要添加信任锚文件以作签名验证  \n- 这个签名后的zone可以被伪造，使用dig命令输出的文件修改伪造  \n\n## 3.3 创建视图管理，智能DNS  \n[参考1](https://www.cnblogs.com/anpengapple/p/5879350.html)  \n[参考2](https://www.cnblogs.com/etangyushan/p/4335521.html)  \n[参考3](http://www.hangdaowangluo.com/archives/1633)  \n[ubuntu案例](https://www.server-world.info/en/note?os=Ubuntu_20.04&p=dns&f=5)  \n- vim  /etc/bind/named.conf  \n\n```bash\ninclude \"/etc/bind/named.conf.options\";\ninclude \"/etc/bind/named.conf.local\";\n# include \"/etc/bind/named.conf.default-zones\";\n```\n\n- cat  /etc/bind/named.conf.options  \n\n```\noptions {\n        directory \"/var/cache/bind\";\n        listen-on port 53 { localhost; };\n        recursion yes;        # 允许递归才能在智能dns解析万网域名\n        forwarders {\n          223.5.5.5;\n        };\n        forward  first;\n        version  \"hiden version\";   # 隐藏版本\n        allow-transfer { 10.13.3.106; };\n        allow-query { \n          example;\n          company;\n        };\n        auth-nxdomain true;\n        dnssec-validation false; # dns安全拓展的选项\n};\n# 此处定义目标ip地址段，划分可访问的域\nacl \"example\" {\n    10.13.3.0/24;\n    10.10.6.0/24;\n};\n\nacl \"company\" {\n    10.10.6.0/24;\n};\n# 此处制定目标ip可以访问的域名的解析区域\nview \"example\" {\n  match-clients { example; };\n  include \"/etc/bind/example/example.views\";\n};\n\nview \"company\" {\n  match-clients { company; };\n  include \"/etc/bind/example/company.views\";\n};\n```\n- views 文件中指定区域解析文件，eg：\n\n```bash\nzone \"example.net\" IN {                                          # 此处域名和 zones 文件中的域名一致\n      type master;\n      file \"/etc/bind/example/example.net.zones\";\n   };\nzone \"3.13.10.in-addr.arpa.\" IN {                         # 此处格式固定，设计反向解析的ip的网络位，和zones文件中的主机位结合成为完整ip地址\n      type master;\n      file \"/etc/bind/example/example.net.reverse.zones\";\n};\n\nzone \"example.top\" IN {                              # 配置此 dns 向 10.13.3.101 这个转发器请求解析 example.top 的域名。在全局 options 配置转发没有成功，选择了此方案。\n      type forward;\n      forwarders {10.13.3.101;};\n};\n```\n\n- 正向区域解析文件  \n```\n$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n) \n@        IN      NS      nameserver\n\nnameserver       IN      A       10.13.3.106\n\nldap   IN  A   10.13.3.107\ntest   IN  A   10.13.3.105\n```\n\n- 反向区域解析文件  \n```\n$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n)\n       IN      NS      nameserver.      # 不能缺省这个\".\"\n\n107  IN    PTR    ldap.example.net.\n```\n\n- 测试   \n```\ndig   目标域名   @namserver    +short\ndig   目标ip   -x   +short\nnslookup\n```\n\n## 3.4 加密  \n[知名公共DoT/DoH加密DNS服务器](https://runtufenxiang.com/6186/)   \n[配置](https://devblog.rayonnant.net/creating-a-dot-and-doh-server-using-nginx-and-bind/)    \n[bind9 tls / https](https://dididudu998.github.io/2022/02/15/configure-doh-bind.html)网络层的问题是DoT使用853的端口，很容易被封锁，而DoH使用443端口，一般不会被封锁    \n### 3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）   \n```\ntls mycert {\n    cert-file \"/etc/bind/example/cert.pem\";\n    key-file \"/etc/bind/example/key.pem\";\n};\n\noptions {\n    directory \"/var/cache/bind\";\n    listen-on port 853 tls mycert { localhost; };\n    forward  first;\n    forwarders {\n            223.5.5.5;\n            120.53.53.53;\n    };\n    allow-query { 10.13.3.0/24;};\n    auth-nxdomain true;\n    allow-update { none; };\n  //  allow-transfer { 10.13.3.106; };\n    version  \"hiden version\";\n    recursion false;\n};\n\nzone \"example.net\"{\n   type master;\n   file \"/etc/bind/example/example.net.zones\";\n};\n```\n\n- 客户端修改dns地址步骤如下：  \n- /etc/resolv.conf  是软链接，指向了/run/systemd/resolve/stub-resolv.conf。直接修改内容会被覆盖，没有意义  \n- vim /etc/systemd/resolved.conf  \n```\n[Resolve]\nDNS=10.13.3.106\n[[FallbackDNS]]=\nDNSOverTLS=opportunistic  # 或者yes\n```\n- systemctl restart systemd-resolved.service   \n- mv /etc/resolv.conf   /etc/resolv.conf.bak  \n- ln -s /run/systemd/resolve/resolv.conf /etc/  \n\n### 3.4.2 问题  \n- 以上配置之后，使用特定命令发现 DOT 是成功的，例如  \n```\nresolvectl query mee.example.net\n\tmee.example.net: 10.10.6.1                       -- link: ens160\n\t\n\t-- Information acquired via protocol DNS in 1.7ms.\n\t-- Data is authenticated: no\n\ndig +tls mee.example.net\n\t; <<>> DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu <<>> +tls mee.example.net\n\t;; global options: +cmd\n\t;; Got answer:\n\t;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 52275\n\t;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\t;; WARNING: recursion requested but not available\n\t\n\t;; OPT PSEUDOSECTION:\n\t; EDNS: version: 0, flags:; udp: 1232\n\t; COOKIE: 174ae084d3aed77f01000000655474d3fbb4902501bc69cb (good)\n\t;; QUESTION SECTION:\n\t;mee.example.net.                 IN      A\n\t\n\t;; ANSWER SECTION:\n\tmee.example.net.          600     IN      A       10.10.6.1\n\t\n\t;; Query time: 0 msec\n\t;; SERVER: 10.13.3.106#853(10.13.3.106) (TLS)\n\t;; WHEN: Wed Nov 15 15:35:47 CST 2023\n\t;; MSG SIZE  rcvd: 86\n以上访问了dns服务器853端口，所以返回正常解析\n```\n\n- 普通解析会失败  \n```\ndig mee.example.net  （nslookup ssh  ping）\n\t;; communications error to 10.13.3.106#53: connection refused\n\t;; communications error to 10.13.3.106#53: connection refused\n\t;; communications error to 10.13.3.106#53: connection refused\n\t\n\t; <<>> DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu <<>> mee.example.net\n\t;; global options: +cmd\n\t;; no servers could be reached\n```\n\n- 因此，仍然开启 53 端口，二者同时可以使用，但是如果需要特定的方式使用DNSOverTLS ，那么以目前在服务器上的使用上来看，使用是没有意义的。  \n- 在服务器使用 53，在浏览器使用自建 DOH，是适宜的  \n\n### 3.4.3  DOH 加密和转发  \n- 配置  \n```shell\ntls doh {\n   key-file \"/etc/bind/example/cert/key.pem\";\n   cert-file \"/etc/bind/example/cert/ca.pem\";\n};\n\nhttp dns-over-https {\n    endpoints {\"/dns-query\";};\n};\n\noptions {\n        listen-on port 443 tls doh http default { localhost; };\n\t\t......\n};\n```\n\n- 检测  \n```shell\ndig +https  test.example.net  @10.13.3.106 A\n\n; <<>> DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu <<>> +https test.example.net @10.13.3.106 A\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 15036\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; COOKIE: dcdab07360fe04b2010000006555c9c6572491f7e49a2f35 (good)\n;; QUESTION SECTION:\n;test.example.net.                        IN      A\n\n;; ANSWER SECTION:\ntest.example.net.         600     IN      A       10.13.3.105\n\n;; Query time: 0 msec\n;; SERVER: 10.13.3.106#443(10.13.3.106) (HTTPS)\n;; WHEN: Thu Nov 16 15:50:30 CST 2023\n;; MSG SIZE  rcvd: 87\n```\n\n- 使用  \n此时在客户端使用 DOH ，浏览器设置 use secure dns ，custom url ： https://nameserver.example.net/dns-query  \n在客户端其他程序的使用中，仍然会访问 dns 的 53 端口  \n\n## 3.5 其他安全实践  \n- 下列参考[来源](https://www.secpulse.com/archives/52634.html)  \n```\n隐藏BIND版本号\n限定哪台主机能够发起区域传输\n```\n\n```\nversion  \"hiden version\";                             #  隐藏版本信息\nallow-transfer { 221.236.9.9; };    #  指定允许某从服务器进行区域传输到该服务器，此配置一般在主服务器配置\n```\n\n# 四、web 管理以及反向代理  \n[安装 webmin工具](https://www.mmcloud.com/2863.html)  \n[使用ngingx反代](https://devpress.csdn.net/cloud/6304db5f7e6682346619cf4b.html)  \n- 路径nginx/conf.d/webmin.conf   （检查443、80端口，确认dns地址和解析记录）  \n```\nupstream webmin {\n  server 10.13.3.107:10000;\n}\n\nserver {\n  listen 80;\n  server_name webmin.example.net;\n  return 301 https://$server_name$request_uri;\n}\n\nserver {\n  server_name webmin.example.net;\n  listen 443 ssl;\n  ssl_certificate webmin/tls_ca.pem;\n  ssl_certificate_key webmin/tls_key.pem;\n\n  location / {\n    proxy_pass      https://webmin;\n    proxy_redirect  off;\n    proxy_set_header   Host             $host:$server_port;\n    proxy_set_header   X-Real-IP        $remote_addr;\n    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto \"https\";\n    proxy_connect_timeout      10;\n    proxy_send_timeout         10;\n    proxy_read_timeout         10;\n    proxy_buffer_size          128k;\n    proxy_buffers              32 32k;\n    proxy_busy_buffers_size    256k;\n    proxy_temp_file_write_size 256k;\n  }\n}\n```\n# 五、bind9.18  nginx 反向代理  \n[反向代理参考](https://www.infvie.com/ops-notes/nginx-udp-dns.html)  \n\n\n\n[def]: DNS%20Server.md#3.3%20创建视图管理，智能DNS","slug":"DNS-server","published":1,"updated":"2024-04-20T03:18:37.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodgq000380rv7i7oe3sm","content":"<h1 id=\"一、DNS-主服务器\"><a href=\"#一、DNS-主服务器\" class=\"headerlink\" title=\"一、DNS 主服务器\"></a>一、DNS 主服务器</h1><ul>\n<li>手动更新源，并安装bind9.18  <pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo add-apt-repository ppa:isc&#x2F;bind\napt update\nsudo apt install -y  bind9 bind9-utils<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"1-1-相关文件\"><a href=\"#1-1-相关文件\" class=\"headerlink\" title=\"1.1 相关文件\"></a>1.1 相关文件</h2><p><a href=\"https://cshihong.github.io/2018/10/15/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E4%B8%8E%E9%85%8D%E7%BD%AE/\">references</a><br><code>/etc/bind/named.conf</code>:  主配置文件，包含 bind 服务器的全局设置和引用其他配置文件的指令<br><code>/etc/bind/named.conf.default-zones</code>:  定义了默认的区域（zone），如  localhost 、反向解析等<br><code>/etc/bind/named.conf.local</code>:  用于配置本地区域（zone）和其他定制区域的文件<br><code>/etc/bind/named.conf.options</code>:  包含bind服务器的全局选项设置，如监听地址、转发器等  </p>\n<h2 id=\"1-2-配置\"><a href=\"#1-2-配置\" class=\"headerlink\" title=\"1.2 配置\"></a>1.2 配置</h2><h3 id=\"1-2-1-解析方式\"><a href=\"#1-2-1-解析方式\" class=\"headerlink\" title=\"1.2.1  解析方式\"></a>1.2.1  解析方式</h3><table>\n<thead>\n<tr>\n<th align=\"center\">方式</th>\n<th align=\"center\">作用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">正向</td>\n<td align=\"center\">域名–&gt;IP</td>\n</tr>\n<tr>\n<td align=\"center\">反向</td>\n<td align=\"center\">IP–&gt;域名</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-2-2-DNS记录类型\"><a href=\"#1-2-2-DNS记录类型\" class=\"headerlink\" title=\"1.2.2  DNS记录类型\"></a>1.2.2  DNS记录类型</h3><ul>\n<li>A 记录：将域名指向一个 ipv4  </li>\n<li>AAAA 记录：将主机名解析到一个指定的 IPv6  </li>\n<li>CNAME 记录：别名解析，指将不同的域名都转到一个域名记录上，由这个域名记录统一解析管理，即当前解析的域名是另一个域名的跳转  </li>\n<li>NS 记录：域名服务记录，用来指定该域名由哪个 DNS 服务器来解析，一般设置为多个，一个为主，其余为辅，且只能写域名的形式  </li>\n<li>PTR 记录：反向解析，主要用于 IP 解析为 FQDN  </li>\n<li>MX 记录： 邮件交换记录  </li>\n<li>TXT 记录： 指某个主机名或域名的说明，通常用来做SPF记录（反垃圾邮件）</li>\n</ul>\n<h3 id=\"1-2-3-目录结构（需要修改部分）\"><a href=\"#1-2-3-目录结构（需要修改部分）\" class=\"headerlink\" title=\"1.2.3  目录结构（需要修改部分）\"></a>1.2.3  目录结构（需要修改部分）</h3><p>&#x2F;etc&#x2F;bind<br>├── example<br>│   ├── db.zones<br>│   └── reverse.zones<br>├── named.conf<br>└──named.conf.options   </p>\n<h3 id=\"1-2-4-配置文件\"><a href=\"#1-2-4-配置文件\" class=\"headerlink\" title=\"1.2.4  配置文件\"></a>1.2.4  配置文件</h3><ul>\n<li>&#x2F;etc&#x2F;bind&#x2F;named.conf  <pre class=\"line-numbers language-none\"><code class=\"language-none\">include &quot;&#x2F;etc&#x2F;bind&#x2F;named.conf.options&quot;;\ninclude &quot;&#x2F;etc&#x2F;bind&#x2F;named.conf.local&quot;;\n# include &quot;&#x2F;etc&#x2F;bind&#x2F;named.conf.default-zones&quot;;       # 在视图使用时注释掉的\ninclude &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf&quot;;     #  在 dnssec 功能中需要做的引入<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>&#x2F;etc&#x2F;bind&#x2F;named.conf.options</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">tls doh <span class=\"token punctuation\">&#123;</span>\n   key-file <span class=\"token string\">\"/etc/bind/example/cert/key.pem\"</span><span class=\"token punctuation\">;</span>\n   cert-file <span class=\"token string\">\"/etc/bind/example/cert/ca.pem\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nhttp dns-over-https <span class=\"token punctuation\">&#123;</span>\n    endpoints <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"/dns-query\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\noptions <span class=\"token punctuation\">&#123;</span>\n        directory <span class=\"token string\">\"/var/cache/bind\"</span><span class=\"token punctuation\">;</span>\n        listen-on port <span class=\"token number\">53</span> <span class=\"token punctuation\">&#123;</span> localhost<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n        listen-on port <span class=\"token number\">443</span> tls doh http dns-over-https  <span class=\"token punctuation\">&#123;</span> localhost<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\"># 配合上述 tls  http 开启 DOH</span>\n        recursion <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>                <span class=\"token comment\"># 否则会出现不能解析 wan 网域名</span>\n        forwarders <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token number\">8.8</span>.8.8<span class=\"token punctuation\">;</span>\n            <span class=\"token number\">223.5</span>.5.5<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n        forward  first<span class=\"token punctuation\">;</span>\n        version  <span class=\"token string\">\"hiden version\"</span><span class=\"token punctuation\">;</span>\n        allow-transfer <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">10.13</span>.3.107<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n        allow-query <span class=\"token punctuation\">&#123;</span>\n          example<span class=\"token punctuation\">;</span>\n          company<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n        auth-nxdomain <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        dnssec-validation <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nacl <span class=\"token string\">\"example\"</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token number\">10.10</span>.6.0/24<span class=\"token punctuation\">;</span>\n    <span class=\"token number\">10.13</span>.3.0/24<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nacl <span class=\"token string\">\"company\"</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token number\">10.10</span>.6.0/24<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nview <span class=\"token string\">\"example\"</span> <span class=\"token punctuation\">&#123;</span>\n  match-clients <span class=\"token punctuation\">&#123;</span> example<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n  zone <span class=\"token string\">\"example.net\"</span> IN  <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n       <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.db.zones\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n  zone <span class=\"token string\">\"13.10.in-addr.arpa.\"</span> IN  <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n       <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.reverse.zones\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nview <span class=\"token string\">\"company\"</span> <span class=\"token punctuation\">&#123;</span>\n  match-clients <span class=\"token punctuation\">&#123;</span> company<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n  zone <span class=\"token string\">\"company.com\"</span> IN  <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n       <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/company.db.zones\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>视图使用主要参考本章<a href=\"##\">智能视图使用</a></p>\n<ul>\n<li>&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.top. admin.example.top. (\n                                   1   ; serial\n                                1200   ; refresh \n                                900    ; retry \n                                900    ; expire\n                               1200 )  ; minimum \n@        IN      NS      nameserver\nnameserver   IN  A       10.13.3.107\nnameserver  IN  A       10.13.3.109    \ntest         IN  A       10.13.3.109\nk8s          IN  A       10.13.3.110<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li><p>反向区域解析文件 &#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.reverse.zones  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n)\n       IN      NS      nameserver.      # 不能缺省这个&quot;.&quot;\n\n107.3  IN    PTR    ldap.example.net.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>测试  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dig   目标域名   @namserver    +short\ndig   目标ip   -x   +short\nnslookup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"1-2-5-参数介绍\"><a href=\"#1-2-5-参数介绍\" class=\"headerlink\" title=\"1.2.5  参数介绍\"></a>1.2.5  参数介绍</h3><p>allow-update { none; };  定义允许执行动态 DNS 更新的客户端<br>allow-transfer { xx ; } 允许 xx 地址从您的 DNS 服务器复制数据<br>forward first; 优先选择转发到的 DNS 服务器<br>forwarders {}; 转发器，转发到另外的 DNS<br>recursion yes; 启用递归查询<br>dnssec-validation no; 禁用 BIND9 服务器上的 DNSSEC 验证，此时返回的数据或许有准确度的问题<br>auth-nxdomain no; 符合 RFC1035  </p>\n<ol>\n<li>Refresh（刷新）：Refresh 指定了 DNS 服务器应从主服务器获取区域数据的频率。最佳的 Refresh 时间取决于你的特定需求，通常在几小时到一天之间。较短的 Refresh 时间可以更快地更新数据，但会增加主服务器的负载。  </li>\n<li>Retry（重试）：Retry 指定了 DNS 服务器在未能联系到主服务器时应进行的重试间隔。最佳的 Retry 时间通常在几分钟到一小时之间，取决于网络的可靠性和延迟。较短的 Retry 时间可以更快地恢复到主服务器，但会增加 DNS 查询负载。  </li>\n<li>Expire（过期）：Expire 指定了区域数据在主服务器不可用时的最大存储时间。最佳的 Expire 时间通常在几天到一周之间。较短的 Expire 时间可以更快地更新过期的数据，但会增加 DNS 查询的负载。  </li>\n<li>Minimum TTL（最小生存时间）：Minimum TTL 指定了 DNS 解析器或缓存服务器应保留解析结果的最小时间。最佳的 Minimum TTL 时间取决于你的特定需求，通常在几分钟到一天之间。较短的 Minimum TTL 时间可以更快地更新解析结果，但会增加 DNS 查询的负载。</li>\n</ol>\n<hr>\n<h1 id=\"二、DNS-从服务器\"><a href=\"#二、DNS-从服务器\" class=\"headerlink\" title=\"二、DNS 从服务器\"></a>二、DNS 从服务器</h1><h2 id=\"2-1-配置\"><a href=\"#2-1-配置\" class=\"headerlink\" title=\"2.1  配置\"></a>2.1  配置</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;bind&#x2F;named.conf\n\t同于 master 即可<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<ul>\n<li><p>&#x2F;etc&#x2F;bind&#x2F;named.conf.options</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">tls doh &#123;\n   key-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;cert&#x2F;key.pem&quot;;\n   cert-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;cert&#x2F;ca.pem&quot;;\n&#125;;\n\nhttp dns-over-https &#123;\n    endpoints &#123;&quot;&#x2F;dns-query&quot;;&#125;;\n&#125;;\n\noptions &#123;\n        directory &quot;&#x2F;var&#x2F;cache&#x2F;bind&quot;;\n        listen-on port 53 &#123; localhost; &#125;;\n        listen-on port 443 tls doh http default &#123; localhost; &#125;;\n        recursion true;\n        forwarders &#123;\n            8.8.8.8;\n            223.5.5.5;\n        &#125;;\n        forward  first;\n        version  &quot;hiden version&quot;;\n        allow-query &#123;\n          example;\n          company;\n        &#125;;\n        auth-nxdomain true;\n        dnssec-validation false;\n&#125;;\n\nacl &quot;example&quot; &#123;\n    10.10.6.0&#x2F;24;\n    10.13.3.0&#x2F;24;\n&#125;;\n\nacl &quot;company&quot; &#123;\n    10.10.6.0&#x2F;24;\n&#125;;\n\nview &quot;example&quot; &#123;\n  match-clients &#123; example; &#125;;\n  zone &quot;example.net&quot; IN  &#123;\n       type slave;\n       file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones.signed&quot;;\n       masters &#123; 10.13.3.106; &#125;;\n  &#125;;\n  zone &quot;3.13.10.in-addr.arpa.&quot; IN  &#123;\n       type slave;\n       masters &#123; 10.13.3.106; &#125;;\n       file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.reverse.zones&quot;;\n  &#125;;\n&#125;;\n\nview &quot;company&quot; &#123;\n  match-clients &#123; company; &#125;;\n  zone &quot;company.com&quot; IN  &#123;\n       type slave;\n       masters &#123; 10.13.3.106; &#125;;\n       file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;company.db.zones&quot;;\n  &#125;;\n&#125;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>&#x2F;etc&#x2F; apparmor.d&#x2F;usr.sbin.named  设置可写。dumping master file: &#x2F;etc&#x2F;bind&#x2F;example&#x2F;tmp-80LUGLiqE4: open: permission denied  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;bind&#x2F;example&#x2F;** rw,\n\nsystemctl reload apparmor.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"2-2-测试记录同步\"><a href=\"#2-2-测试记录同步\" class=\"headerlink\" title=\"2.2 测试记录同步\"></a>2.2 测试记录同步</h2><ul>\n<li>修改主服务器，解析记录，测试从服务器的同步情况  <pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.top.  admin.example.top. (\n                                   2   ; serial   [[每次需要修改版本号]]\n                                1200   ; refresh \n                                900    ; retry \n                                900    ; expire\n                               1200 )  ; minimum \n@        IN      NS      nameserver\n@        IN      NS      nameserver2              [[较版本1新增]]\nnameserver   IN  A       10.13.3.107\nnameserver2  IN  A       10.13.3.109              [[较版本1新增]]\ntest         IN  A       10.13.3.109\nk8s          IN  A       10.13.3.110\nme           IN  A       10.10.6.1               [[较版本1新增]]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<p><strong>热加载</strong>新增的配置，每次修改记录时，需要同步修改<em><strong>版本号</strong></em>，slave 才能同步成功  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo rndc reload     # 主服务器执行即可\ndig -t a me.example.top @10.13.3.109<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<ul>\n<li>当从服务器有解析文件的，解析记录仍会向主服务器请求，主服务器宕机，从服务器缓存过期之后，也仍不能加载并实施解析区域记录文件  </li>\n<li>同一个网段在多个acl下，将不能正常解析。</li>\n</ul>\n<h2 id=\"2-3-测试公网域名\"><a href=\"#2-3-测试公网域名\" class=\"headerlink\" title=\"2.3 测试公网域名\"></a>2.3 测试公网域名</h2><ul>\n<li>此時公网域名成功解析得到的是保留ip地址，ping 域名不能成功—-因为公司的 ip 做了加密  </li>\n<li>不能成功解析则无记录返回</li>\n</ul>\n<hr>\n<h1 id=\"三、-安全\"><a href=\"#三、-安全\" class=\"headerlink\" title=\"三、 安全\"></a>三、 安全</h1><h2 id=\"3-1-功能同于bind-chroot\"><a href=\"#3-1-功能同于bind-chroot\" class=\"headerlink\" title=\"3.1 功能同于bind-chroot\"></a>3.1 功能同于bind-chroot</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">vi &#x2F;etc&#x2F;apparmor.d&#x2F;usr.sbin.named\n# 检查是否存在，否则增加以下内容\n  &#x2F;etc&#x2F;bind&#x2F;** r,\n  &#x2F;var&#x2F;lib&#x2F;bind&#x2F;** rw,\n  &#x2F;var&#x2F;lib&#x2F;bind&#x2F; rw,\n  &#x2F;var&#x2F;cache&#x2F;bind&#x2F;** lrw,\n  &#x2F;var&#x2F;cache&#x2F;bind&#x2F; rw,\n  &#x2F;var&#x2F;log&#x2F;named&#x2F;** rw,\n  &#x2F;var&#x2F;log&#x2F;named&#x2F; rw,<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-2-开启DNSSEC验证，参考\"><a href=\"#3-2-开启DNSSEC验证，参考\" class=\"headerlink\" title=\"3.2 开启DNSSEC验证，参考\"></a>3.2 开启DNSSEC验证，<a href=\"https://www.cnblogs.com/anpengapple/p/5879363.html\">参考</a></h2><ul>\n<li><p>作用：对域名进行签名认证，保证域名的完整性和正确性，不会被修改  </p>\n</li>\n<li><p>在新增的 dnssec_keys 目录中生成密钥  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo dnssec-keygen -f KSK -a RSASHA256 -b 2048 -n ZONE example.net.\nsudo dnssec-keygen -a RSASHA256  -b 2048 -n ZONE example.net.\n\n# 查看本域应用所需的密钥文件  \nls \nKexample.net.+008+16296.key   Kexample.net.+008+16296.private   Kexample.net.+008+23579.key  Kexample.net.+008+23579.private<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>将前面生成的两个公钥添加到区域配置文件末尾  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m )  ; minimum\n\n@        IN      NS      nameserver\n\nnameserver       IN      A       10.13.3.106\nldap   IN  A   10.13.3.107\ntest   IN  A   10.13.3.105\n\n$INCLUDE  &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;dnssec_keys&#x2F;Kexample.net.+008+23579.key&quot;\n$INCLUDE  &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;dnssec_keys&#x2F;Kexample.net.+008+16296.key&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>对区域文件签名，会生成一个新的zones.sigend. 如果新增了解析记录，需要再次加密  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo dnssec-signzone -K &#x2F;etc&#x2F;bind&#x2F;example&#x2F;dnssec_keys&#x2F; -o example.net. &#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones\n -K  指定密钥文件路径    -o  域名   路径是区域解析文件路径<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>改动引用解析文件路径的位置  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">view <span class=\"token string\">\"example\"</span> <span class=\"token punctuation\">&#123;</span>\n  match-clients <span class=\"token punctuation\">&#123;</span> example<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n  zone <span class=\"token string\">\"example.net\"</span> IN  <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n       <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.db.zones.signed\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>生成信任锚文件 &#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf  </p>\n</li>\n<li><p>这里面的两条内容是刚才生成的两个密钥的内容。用公钥比较方便（也就是.key的文件）。注意复制的时候去掉“IN”和“DNSKEY”这两个词，以及后面的key要加引号  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">trusted-keys <span class=\"token punctuation\">&#123;</span>\n   example.net.   <span class=\"token number\">256</span> <span class=\"token number\">3</span> <span class=\"token number\">8</span>  <span class=\"token string\">\"AwEAAb+3BGqXqE/WwDICGRONYv1w4savuaD4cJ/VRL6xGg2b54OilEWE WMzUAOw4B/sPyKZDG/XTnaW4mD756l/swRuq9kO/sktgu4ZP4onmqeFM sdMTTmxesp6Q6ebqAPNzQfKyZwqX6Iq00qGslUmxr5FSOLWjGoze8afm TxbPW6Hi7JQ85mJ+TkpUNa+ymDS4qKi87rSi8NQTDbsZ0wH7+zX1TBOP jeUI/JsxD/bu1kD97AP9u2Sd4D8U0vyN8fN4LIIKfA5vurPaWPfQIM8r I0KQueAHdNLOPjaEWcKg/rBHFWZPxIeQGM8D2VXwkdPL5fefC59wONhK ys2RMqv3DIM=\"</span><span class=\"token punctuation\">;</span>\n  example.net.   <span class=\"token number\">257</span> <span class=\"token number\">3</span> <span class=\"token number\">8</span> <span class=\"token string\">\"AwEAAbZo3hpm+0+32jgrTXog3CCUTTctP3LoBx1F0nbpoEBkWN1CA//O 7fzNY08pwblkKKW/LkYiQNQEQq50ThouV9UJ+CFRf/Fju6ggIpWpNjsu 8c2+zROZdJ9d2T6JnVTYPo1Iyn8ufn0hFjPRrwdvfQKSmnI9ZRx2eRFc ZFJpqNTj2LwzqoEKrbOn4oywqTWJL1Hyjv8e/kBojy7BghKWYnTGlpha 9CSin17qUQCY+o0qMzmezq+/AbxhdJwV9KYHWzWvNZjyyjBLyxwwsV4F shgmXm2tTuW5gPrnbfzaP+R/cElzl03mtjmJ//g5wWMMV8QKemBpbNoR ajzYYhhocWk=\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>引入此信任锚文件 &#x2F;etc&#x2F;bind&#x2F;name.conf  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf&quot;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li><p>重启服务  </p>\n</li>\n<li><p>验证  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">dig</span> +dnssec  test.example.net  @10.13.3.106\n\n<span class=\"token punctuation\">;</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> DiG <span class=\"token number\">9.16</span>.1-Ubuntu <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> +dnssec test.example.net @10.13.3.106\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> global options: +cmd\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Got answer:\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> -<span class=\"token operator\">>></span>HEADER<span class=\"token operator\">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class=\"token number\">28767</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> flags: qr aa rd ra<span class=\"token punctuation\">;</span> QUERY: <span class=\"token number\">1</span>, ANSWER: <span class=\"token number\">2</span>, AUTHORITY: <span class=\"token number\">0</span>, ADDITIONAL: <span class=\"token number\">1</span>\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> OPT PSEUDOSECTION:\n<span class=\"token punctuation\">;</span> EDNS: version: <span class=\"token number\">0</span>, flags: <span class=\"token keyword\">do</span><span class=\"token punctuation\">;</span> udp: <span class=\"token number\">1232</span>\n<span class=\"token punctuation\">;</span> COOKIE: 0d6b52d25063b09401000000655592b51d0f8f6c0b072961 <span class=\"token punctuation\">(</span>good<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>test.example.net.                        IN      A\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\ntest.example.net.         <span class=\"token number\">600</span>     IN      A       <span class=\"token number\">10.13</span>.3.105\ntest.example.net.         <span class=\"token number\">600</span>     IN      RRSIG   A <span class=\"token number\">8</span> <span class=\"token number\">3</span> <span class=\"token number\">600</span> <span class=\"token number\">20231216022642</span> <span class=\"token number\">20231116022642</span> <span class=\"token number\">16296</span> example.net. iUSB+maT6y22ySZdEZHElShHCVDbmjnHez39eosniP1wqvquyadVydlT lZ3XZbUMNTV3WrZhLEjuGaVwNajvAqeY07IPCivpr+VCuIPXccONBwZE 3ZRX5B2PcGnrhMWupH+jcoT5NTy5pAEdm5JXbtJljFyJk1XxQVhanzJO /TY7YMJWWDbj3WnywkEPQyP5UYExl4Y0E3BPUX/J4xuCspTovQhqo6BM HaC3XFMG1Li9CbHcfNkUjVtdi8oQmAdM6lMqFTz5KNpIRppqhEukcD9o w9slLc1vpjDwqzO7xPls8S9WbzMeHzHNbIrPcv88MQWUAIVyqodbhOvj <span class=\"token assign-left variable\">8ZKlgg</span><span class=\"token operator\">==</span>\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Query time: <span class=\"token number\">0</span> msec\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> SERVER: <span class=\"token number\">10.13</span>.3.106<span class=\"token comment\">#53(10.13.3.106)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> WHEN: Thu Nov <span class=\"token number\">16</span> <span class=\"token number\">11</span>:55:33 CST <span class=\"token number\">2023</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> MSG SIZE  rcvd: <span class=\"token number\">384</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>问题：  </p>\n</li>\n<li><p>配置后，每个客户端需要添加信任锚文件以作签名验证  </p>\n</li>\n<li><p>这个签名后的zone可以被伪造，使用dig命令输出的文件修改伪造</p>\n</li>\n</ul>\n<h2 id=\"3-3-创建视图管理，智能DNS\"><a href=\"#3-3-创建视图管理，智能DNS\" class=\"headerlink\" title=\"3.3 创建视图管理，智能DNS\"></a>3.3 创建视图管理，智能DNS</h2><p><a href=\"https://www.cnblogs.com/anpengapple/p/5879350.html\">参考1</a><br><a href=\"https://www.cnblogs.com/etangyushan/p/4335521.html\">参考2</a><br><a href=\"http://www.hangdaowangluo.com/archives/1633\">参考3</a><br><a href=\"https://www.server-world.info/en/note?os=Ubuntu_20.04&p=dns&f=5\">ubuntu案例</a>  </p>\n<ul>\n<li>vim  &#x2F;etc&#x2F;bind&#x2F;named.conf</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">include <span class=\"token string\">\"/etc/bind/named.conf.options\"</span><span class=\"token punctuation\">;</span>\ninclude <span class=\"token string\">\"/etc/bind/named.conf.local\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># include \"/etc/bind/named.conf.default-zones\";</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>cat  &#x2F;etc&#x2F;bind&#x2F;named.conf.options</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">options &#123;\n        directory &quot;&#x2F;var&#x2F;cache&#x2F;bind&quot;;\n        listen-on port 53 &#123; localhost; &#125;;\n        recursion yes;        # 允许递归才能在智能dns解析万网域名\n        forwarders &#123;\n          223.5.5.5;\n        &#125;;\n        forward  first;\n        version  &quot;hiden version&quot;;   # 隐藏版本\n        allow-transfer &#123; 10.13.3.106; &#125;;\n        allow-query &#123; \n          example;\n          company;\n        &#125;;\n        auth-nxdomain true;\n        dnssec-validation false; # dns安全拓展的选项\n&#125;;\n# 此处定义目标ip地址段，划分可访问的域\nacl &quot;example&quot; &#123;\n    10.13.3.0&#x2F;24;\n    10.10.6.0&#x2F;24;\n&#125;;\n\nacl &quot;company&quot; &#123;\n    10.10.6.0&#x2F;24;\n&#125;;\n# 此处制定目标ip可以访问的域名的解析区域\nview &quot;example&quot; &#123;\n  match-clients &#123; example; &#125;;\n  include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.views&quot;;\n&#125;;\n\nview &quot;company&quot; &#123;\n  match-clients &#123; company; &#125;;\n  include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;company.views&quot;;\n&#125;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>views 文件中指定区域解析文件，eg：</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">zone <span class=\"token string\">\"example.net\"</span> IN <span class=\"token punctuation\">&#123;</span>                                          <span class=\"token comment\"># 此处域名和 zones 文件中的域名一致</span>\n      <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.net.zones\"</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\nzone <span class=\"token string\">\"3.13.10.in-addr.arpa.\"</span> IN <span class=\"token punctuation\">&#123;</span>                         <span class=\"token comment\"># 此处格式固定，设计反向解析的ip的网络位，和zones文件中的主机位结合成为完整ip地址</span>\n      <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.net.reverse.zones\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nzone <span class=\"token string\">\"example.top\"</span> IN <span class=\"token punctuation\">&#123;</span>                              <span class=\"token comment\"># 配置此 dns 向 10.13.3.101 这个转发器请求解析 example.top 的域名。在全局 options 配置转发没有成功，选择了此方案。</span>\n      <span class=\"token builtin class-name\">type</span> forward<span class=\"token punctuation\">;</span>\n      forwarders <span class=\"token punctuation\">&#123;</span><span class=\"token number\">10.13</span>.3.101<span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li><p>正向区域解析文件  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n) \n@        IN      NS      nameserver\n\nnameserver       IN      A       10.13.3.106\n\nldap   IN  A   10.13.3.107\ntest   IN  A   10.13.3.105<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>反向区域解析文件  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n)\n       IN      NS      nameserver.      # 不能缺省这个&quot;.&quot;\n\n107  IN    PTR    ldap.example.net.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>测试   </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dig   目标域名   @namserver    +short\ndig   目标ip   -x   +short\nnslookup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"3-4-加密\"><a href=\"#3-4-加密\" class=\"headerlink\" title=\"3.4 加密\"></a>3.4 加密</h2><p><a href=\"https://runtufenxiang.com/6186/\">知名公共DoT&#x2F;DoH加密DNS服务器</a><br><a href=\"https://devblog.rayonnant.net/creating-a-dot-and-doh-server-using-nginx-and-bind/\">配置</a><br><a href=\"https://dididudu998.github.io/2022/02/15/configure-doh-bind.html\">bind9 tls &#x2F; https</a>网络层的问题是DoT使用853的端口，很容易被封锁，而DoH使用443端口，一般不会被封锁    </p>\n<h3 id=\"3-4-1-DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）\"><a href=\"#3-4-1-DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）\" class=\"headerlink\" title=\"3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）\"></a>3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">tls mycert &#123;\n    cert-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;cert.pem&quot;;\n    key-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;key.pem&quot;;\n&#125;;\n\noptions &#123;\n    directory &quot;&#x2F;var&#x2F;cache&#x2F;bind&quot;;\n    listen-on port 853 tls mycert &#123; localhost; &#125;;\n    forward  first;\n    forwarders &#123;\n            223.5.5.5;\n            120.53.53.53;\n    &#125;;\n    allow-query &#123; 10.13.3.0&#x2F;24;&#125;;\n    auth-nxdomain true;\n    allow-update &#123; none; &#125;;\n  &#x2F;&#x2F;  allow-transfer &#123; 10.13.3.106; &#125;;\n    version  &quot;hiden version&quot;;\n    recursion false;\n&#125;;\n\nzone &quot;example.net&quot;&#123;\n   type master;\n   file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.net.zones&quot;;\n&#125;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>客户端修改dns地址步骤如下：  </li>\n<li>&#x2F;etc&#x2F;resolv.conf  是软链接，指向了&#x2F;run&#x2F;systemd&#x2F;resolve&#x2F;stub-resolv.conf。直接修改内容会被覆盖，没有意义  </li>\n<li>vim &#x2F;etc&#x2F;systemd&#x2F;resolved.conf  <pre class=\"line-numbers language-none\"><code class=\"language-none\">[Resolve]\nDNS&#x3D;10.13.3.106\n[[FallbackDNS]]&#x3D;\nDNSOverTLS&#x3D;opportunistic  # 或者yes<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>systemctl restart systemd-resolved.service   </li>\n<li>mv &#x2F;etc&#x2F;resolv.conf   &#x2F;etc&#x2F;resolv.conf.bak  </li>\n<li>ln -s &#x2F;run&#x2F;systemd&#x2F;resolve&#x2F;resolv.conf &#x2F;etc&#x2F;</li>\n</ul>\n<h3 id=\"3-4-2-问题\"><a href=\"#3-4-2-问题\" class=\"headerlink\" title=\"3.4.2 问题\"></a>3.4.2 问题</h3><ul>\n<li><p>以上配置之后，使用特定命令发现 DOT 是成功的，例如  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">resolvectl query mee.example.net\n\tmee.example.net: 10.10.6.1                       -- link: ens160\n\t\n\t-- Information acquired via protocol DNS in 1.7ms.\n\t-- Data is authenticated: no\n\ndig +tls mee.example.net\n\t; &lt;&lt;&gt;&gt; DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu &lt;&lt;&gt;&gt; +tls mee.example.net\n\t;; global options: +cmd\n\t;; Got answer:\n\t;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 52275\n\t;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\t;; WARNING: recursion requested but not available\n\t\n\t;; OPT PSEUDOSECTION:\n\t; EDNS: version: 0, flags:; udp: 1232\n\t; COOKIE: 174ae084d3aed77f01000000655474d3fbb4902501bc69cb (good)\n\t;; QUESTION SECTION:\n\t;mee.example.net.                 IN      A\n\t\n\t;; ANSWER SECTION:\n\tmee.example.net.          600     IN      A       10.10.6.1\n\t\n\t;; Query time: 0 msec\n\t;; SERVER: 10.13.3.106#853(10.13.3.106) (TLS)\n\t;; WHEN: Wed Nov 15 15:35:47 CST 2023\n\t;; MSG SIZE  rcvd: 86\n以上访问了dns服务器853端口，所以返回正常解析<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>普通解析会失败  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dig mee.example.net  （nslookup ssh  ping）\n\t;; communications error to 10.13.3.106#53: connection refused\n\t;; communications error to 10.13.3.106#53: connection refused\n\t;; communications error to 10.13.3.106#53: connection refused\n\t\n\t; &lt;&lt;&gt;&gt; DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu &lt;&lt;&gt;&gt; mee.example.net\n\t;; global options: +cmd\n\t;; no servers could be reached<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>因此，仍然开启 53 端口，二者同时可以使用，但是如果需要特定的方式使用DNSOverTLS ，那么以目前在服务器上的使用上来看，使用是没有意义的。  </p>\n</li>\n<li><p>在服务器使用 53，在浏览器使用自建 DOH，是适宜的</p>\n</li>\n</ul>\n<h3 id=\"3-4-3-DOH-加密和转发\"><a href=\"#3-4-3-DOH-加密和转发\" class=\"headerlink\" title=\"3.4.3  DOH 加密和转发\"></a>3.4.3  DOH 加密和转发</h3><ul>\n<li><p>配置  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">tls doh <span class=\"token punctuation\">&#123;</span>\n   key-file <span class=\"token string\">\"/etc/bind/example/cert/key.pem\"</span><span class=\"token punctuation\">;</span>\n   cert-file <span class=\"token string\">\"/etc/bind/example/cert/ca.pem\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nhttp dns-over-https <span class=\"token punctuation\">&#123;</span>\n    endpoints <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"/dns-query\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\noptions <span class=\"token punctuation\">&#123;</span>\n        listen-on port <span class=\"token number\">443</span> tls doh http default <span class=\"token punctuation\">&#123;</span> localhost<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>检测  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">dig</span> +https  test.example.net  @10.13.3.106 A\n\n<span class=\"token punctuation\">;</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> DiG <span class=\"token number\">9.18</span>.19-1+ubuntu20.04.1+isc+1-Ubuntu <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> +https test.example.net @10.13.3.106 A\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> global options: +cmd\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Got answer:\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> -<span class=\"token operator\">>></span>HEADER<span class=\"token operator\">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class=\"token number\">15036</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> flags: qr aa rd ra<span class=\"token punctuation\">;</span> QUERY: <span class=\"token number\">1</span>, ANSWER: <span class=\"token number\">1</span>, AUTHORITY: <span class=\"token number\">0</span>, ADDITIONAL: <span class=\"token number\">1</span>\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> OPT PSEUDOSECTION:\n<span class=\"token punctuation\">;</span> EDNS: version: <span class=\"token number\">0</span>, flags:<span class=\"token punctuation\">;</span> udp: <span class=\"token number\">1232</span>\n<span class=\"token punctuation\">;</span> COOKIE: dcdab07360fe04b2010000006555c9c6572491f7e49a2f35 <span class=\"token punctuation\">(</span>good<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>test.example.net.                        IN      A\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\ntest.example.net.         <span class=\"token number\">600</span>     IN      A       <span class=\"token number\">10.13</span>.3.105\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Query time: <span class=\"token number\">0</span> msec\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> SERVER: <span class=\"token number\">10.13</span>.3.106<span class=\"token comment\">#443(10.13.3.106) (HTTPS)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> WHEN: Thu Nov <span class=\"token number\">16</span> <span class=\"token number\">15</span>:50:30 CST <span class=\"token number\">2023</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> MSG SIZE  rcvd: <span class=\"token number\">87</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>使用<br>此时在客户端使用 DOH ，浏览器设置 use secure dns ，custom url ： <a href=\"https://nameserver.example.net/dns-query\">https://nameserver.example.net/dns-query</a><br>在客户端其他程序的使用中，仍然会访问 dns 的 53 端口</p>\n</li>\n</ul>\n<h2 id=\"3-5-其他安全实践\"><a href=\"#3-5-其他安全实践\" class=\"headerlink\" title=\"3.5 其他安全实践\"></a>3.5 其他安全实践</h2><ul>\n<li>下列参考<a href=\"https://www.secpulse.com/archives/52634.html\">来源</a>  <pre class=\"line-numbers language-none\"><code class=\"language-none\">隐藏BIND版本号\n限定哪台主机能够发起区域传输<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">version  &quot;hiden version&quot;;                             #  隐藏版本信息\nallow-transfer &#123; 221.236.9.9; &#125;;    #  指定允许某从服务器进行区域传输到该服务器，此配置一般在主服务器配置<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h1 id=\"四、web-管理以及反向代理\"><a href=\"#四、web-管理以及反向代理\" class=\"headerlink\" title=\"四、web 管理以及反向代理\"></a>四、web 管理以及反向代理</h1><p><a href=\"https://www.mmcloud.com/2863.html\">安装 webmin工具</a><br><a href=\"https://devpress.csdn.net/cloud/6304db5f7e6682346619cf4b.html\">使用ngingx反代</a>  </p>\n<ul>\n<li>路径nginx&#x2F;conf.d&#x2F;webmin.conf   （检查443、80端口，确认dns地址和解析记录）  <pre class=\"line-numbers language-none\"><code class=\"language-none\">upstream webmin &#123;\n  server 10.13.3.107:10000;\n&#125;\n\nserver &#123;\n  listen 80;\n  server_name webmin.example.net;\n  return 301 https:&#x2F;&#x2F;$server_name$request_uri;\n&#125;\n\nserver &#123;\n  server_name webmin.example.net;\n  listen 443 ssl;\n  ssl_certificate webmin&#x2F;tls_ca.pem;\n  ssl_certificate_key webmin&#x2F;tls_key.pem;\n\n  location &#x2F; &#123;\n    proxy_pass      https:&#x2F;&#x2F;webmin;\n    proxy_redirect  off;\n    proxy_set_header   Host             $host:$server_port;\n    proxy_set_header   X-Real-IP        $remote_addr;\n    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto &quot;https&quot;;\n    proxy_connect_timeout      10;\n    proxy_send_timeout         10;\n    proxy_read_timeout         10;\n    proxy_buffer_size          128k;\n    proxy_buffers              32 32k;\n    proxy_busy_buffers_size    256k;\n    proxy_temp_file_write_size 256k;\n  &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h1 id=\"五、bind9-18-nginx-反向代理\"><a href=\"#五、bind9-18-nginx-反向代理\" class=\"headerlink\" title=\"五、bind9.18  nginx 反向代理\"></a>五、bind9.18  nginx 反向代理</h1><p><a href=\"https://www.infvie.com/ops-notes/nginx-udp-dns.html\">反向代理参考</a>  </p>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"一、DNS-主服务器\"><a href=\"#一、DNS-主服务器\" class=\"headerlink\" title=\"一、DNS 主服务器\"></a>一、DNS 主服务器</h1><ul>\n<li>手动更新源，并安装bind9.18  <pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo add-apt-repository ppa:isc&#x2F;bind\napt update\nsudo apt install -y  bind9 bind9-utils<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"1-1-相关文件\"><a href=\"#1-1-相关文件\" class=\"headerlink\" title=\"1.1 相关文件\"></a>1.1 相关文件</h2><p><a href=\"https://cshihong.github.io/2018/10/15/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E4%B8%8E%E9%85%8D%E7%BD%AE/\">references</a><br><code>/etc/bind/named.conf</code>:  主配置文件，包含 bind 服务器的全局设置和引用其他配置文件的指令<br><code>/etc/bind/named.conf.default-zones</code>:  定义了默认的区域（zone），如  localhost 、反向解析等<br><code>/etc/bind/named.conf.local</code>:  用于配置本地区域（zone）和其他定制区域的文件<br><code>/etc/bind/named.conf.options</code>:  包含bind服务器的全局选项设置，如监听地址、转发器等  </p>\n<h2 id=\"1-2-配置\"><a href=\"#1-2-配置\" class=\"headerlink\" title=\"1.2 配置\"></a>1.2 配置</h2><h3 id=\"1-2-1-解析方式\"><a href=\"#1-2-1-解析方式\" class=\"headerlink\" title=\"1.2.1  解析方式\"></a>1.2.1  解析方式</h3><table>\n<thead>\n<tr>\n<th align=\"center\">方式</th>\n<th align=\"center\">作用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">正向</td>\n<td align=\"center\">域名–&gt;IP</td>\n</tr>\n<tr>\n<td align=\"center\">反向</td>\n<td align=\"center\">IP–&gt;域名</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-2-2-DNS记录类型\"><a href=\"#1-2-2-DNS记录类型\" class=\"headerlink\" title=\"1.2.2  DNS记录类型\"></a>1.2.2  DNS记录类型</h3><ul>\n<li>A 记录：将域名指向一个 ipv4  </li>\n<li>AAAA 记录：将主机名解析到一个指定的 IPv6  </li>\n<li>CNAME 记录：别名解析，指将不同的域名都转到一个域名记录上，由这个域名记录统一解析管理，即当前解析的域名是另一个域名的跳转  </li>\n<li>NS 记录：域名服务记录，用来指定该域名由哪个 DNS 服务器来解析，一般设置为多个，一个为主，其余为辅，且只能写域名的形式  </li>\n<li>PTR 记录：反向解析，主要用于 IP 解析为 FQDN  </li>\n<li>MX 记录： 邮件交换记录  </li>\n<li>TXT 记录： 指某个主机名或域名的说明，通常用来做SPF记录（反垃圾邮件）</li>\n</ul>\n<h3 id=\"1-2-3-目录结构（需要修改部分）\"><a href=\"#1-2-3-目录结构（需要修改部分）\" class=\"headerlink\" title=\"1.2.3  目录结构（需要修改部分）\"></a>1.2.3  目录结构（需要修改部分）</h3><p>&#x2F;etc&#x2F;bind<br>├── example<br>│   ├── db.zones<br>│   └── reverse.zones<br>├── named.conf<br>└──named.conf.options   </p>\n<h3 id=\"1-2-4-配置文件\"><a href=\"#1-2-4-配置文件\" class=\"headerlink\" title=\"1.2.4  配置文件\"></a>1.2.4  配置文件</h3><ul>\n<li>&#x2F;etc&#x2F;bind&#x2F;named.conf  <pre class=\"line-numbers language-none\"><code class=\"language-none\">include &quot;&#x2F;etc&#x2F;bind&#x2F;named.conf.options&quot;;\ninclude &quot;&#x2F;etc&#x2F;bind&#x2F;named.conf.local&quot;;\n# include &quot;&#x2F;etc&#x2F;bind&#x2F;named.conf.default-zones&quot;;       # 在视图使用时注释掉的\ninclude &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf&quot;;     #  在 dnssec 功能中需要做的引入<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>&#x2F;etc&#x2F;bind&#x2F;named.conf.options</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">tls doh <span class=\"token punctuation\">&#123;</span>\n   key-file <span class=\"token string\">\"/etc/bind/example/cert/key.pem\"</span><span class=\"token punctuation\">;</span>\n   cert-file <span class=\"token string\">\"/etc/bind/example/cert/ca.pem\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nhttp dns-over-https <span class=\"token punctuation\">&#123;</span>\n    endpoints <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"/dns-query\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\noptions <span class=\"token punctuation\">&#123;</span>\n        directory <span class=\"token string\">\"/var/cache/bind\"</span><span class=\"token punctuation\">;</span>\n        listen-on port <span class=\"token number\">53</span> <span class=\"token punctuation\">&#123;</span> localhost<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n        listen-on port <span class=\"token number\">443</span> tls doh http dns-over-https  <span class=\"token punctuation\">&#123;</span> localhost<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\"># 配合上述 tls  http 开启 DOH</span>\n        recursion <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>                <span class=\"token comment\"># 否则会出现不能解析 wan 网域名</span>\n        forwarders <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token number\">8.8</span>.8.8<span class=\"token punctuation\">;</span>\n            <span class=\"token number\">223.5</span>.5.5<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n        forward  first<span class=\"token punctuation\">;</span>\n        version  <span class=\"token string\">\"hiden version\"</span><span class=\"token punctuation\">;</span>\n        allow-transfer <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">10.13</span>.3.107<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n        allow-query <span class=\"token punctuation\">&#123;</span>\n          example<span class=\"token punctuation\">;</span>\n          company<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n        auth-nxdomain <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        dnssec-validation <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nacl <span class=\"token string\">\"example\"</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token number\">10.10</span>.6.0/24<span class=\"token punctuation\">;</span>\n    <span class=\"token number\">10.13</span>.3.0/24<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nacl <span class=\"token string\">\"company\"</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token number\">10.10</span>.6.0/24<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nview <span class=\"token string\">\"example\"</span> <span class=\"token punctuation\">&#123;</span>\n  match-clients <span class=\"token punctuation\">&#123;</span> example<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n  zone <span class=\"token string\">\"example.net\"</span> IN  <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n       <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.db.zones\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n  zone <span class=\"token string\">\"13.10.in-addr.arpa.\"</span> IN  <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n       <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.reverse.zones\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nview <span class=\"token string\">\"company\"</span> <span class=\"token punctuation\">&#123;</span>\n  match-clients <span class=\"token punctuation\">&#123;</span> company<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n  zone <span class=\"token string\">\"company.com\"</span> IN  <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n       <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/company.db.zones\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>视图使用主要参考本章<a href=\"##\">智能视图使用</a></p>\n<ul>\n<li>&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.top. admin.example.top. (\n                                   1   ; serial\n                                1200   ; refresh \n                                900    ; retry \n                                900    ; expire\n                               1200 )  ; minimum \n@        IN      NS      nameserver\nnameserver   IN  A       10.13.3.107\nnameserver  IN  A       10.13.3.109    \ntest         IN  A       10.13.3.109\nk8s          IN  A       10.13.3.110<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li><p>反向区域解析文件 &#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.reverse.zones  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n)\n       IN      NS      nameserver.      # 不能缺省这个&quot;.&quot;\n\n107.3  IN    PTR    ldap.example.net.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>测试  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dig   目标域名   @namserver    +short\ndig   目标ip   -x   +short\nnslookup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"1-2-5-参数介绍\"><a href=\"#1-2-5-参数介绍\" class=\"headerlink\" title=\"1.2.5  参数介绍\"></a>1.2.5  参数介绍</h3><p>allow-update { none; };  定义允许执行动态 DNS 更新的客户端<br>allow-transfer { xx ; } 允许 xx 地址从您的 DNS 服务器复制数据<br>forward first; 优先选择转发到的 DNS 服务器<br>forwarders {}; 转发器，转发到另外的 DNS<br>recursion yes; 启用递归查询<br>dnssec-validation no; 禁用 BIND9 服务器上的 DNSSEC 验证，此时返回的数据或许有准确度的问题<br>auth-nxdomain no; 符合 RFC1035  </p>\n<ol>\n<li>Refresh（刷新）：Refresh 指定了 DNS 服务器应从主服务器获取区域数据的频率。最佳的 Refresh 时间取决于你的特定需求，通常在几小时到一天之间。较短的 Refresh 时间可以更快地更新数据，但会增加主服务器的负载。  </li>\n<li>Retry（重试）：Retry 指定了 DNS 服务器在未能联系到主服务器时应进行的重试间隔。最佳的 Retry 时间通常在几分钟到一小时之间，取决于网络的可靠性和延迟。较短的 Retry 时间可以更快地恢复到主服务器，但会增加 DNS 查询负载。  </li>\n<li>Expire（过期）：Expire 指定了区域数据在主服务器不可用时的最大存储时间。最佳的 Expire 时间通常在几天到一周之间。较短的 Expire 时间可以更快地更新过期的数据，但会增加 DNS 查询的负载。  </li>\n<li>Minimum TTL（最小生存时间）：Minimum TTL 指定了 DNS 解析器或缓存服务器应保留解析结果的最小时间。最佳的 Minimum TTL 时间取决于你的特定需求，通常在几分钟到一天之间。较短的 Minimum TTL 时间可以更快地更新解析结果，但会增加 DNS 查询的负载。</li>\n</ol>\n<hr>\n<h1 id=\"二、DNS-从服务器\"><a href=\"#二、DNS-从服务器\" class=\"headerlink\" title=\"二、DNS 从服务器\"></a>二、DNS 从服务器</h1><h2 id=\"2-1-配置\"><a href=\"#2-1-配置\" class=\"headerlink\" title=\"2.1  配置\"></a>2.1  配置</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;bind&#x2F;named.conf\n\t同于 master 即可<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<ul>\n<li><p>&#x2F;etc&#x2F;bind&#x2F;named.conf.options</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">tls doh &#123;\n   key-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;cert&#x2F;key.pem&quot;;\n   cert-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;cert&#x2F;ca.pem&quot;;\n&#125;;\n\nhttp dns-over-https &#123;\n    endpoints &#123;&quot;&#x2F;dns-query&quot;;&#125;;\n&#125;;\n\noptions &#123;\n        directory &quot;&#x2F;var&#x2F;cache&#x2F;bind&quot;;\n        listen-on port 53 &#123; localhost; &#125;;\n        listen-on port 443 tls doh http default &#123; localhost; &#125;;\n        recursion true;\n        forwarders &#123;\n            8.8.8.8;\n            223.5.5.5;\n        &#125;;\n        forward  first;\n        version  &quot;hiden version&quot;;\n        allow-query &#123;\n          example;\n          company;\n        &#125;;\n        auth-nxdomain true;\n        dnssec-validation false;\n&#125;;\n\nacl &quot;example&quot; &#123;\n    10.10.6.0&#x2F;24;\n    10.13.3.0&#x2F;24;\n&#125;;\n\nacl &quot;company&quot; &#123;\n    10.10.6.0&#x2F;24;\n&#125;;\n\nview &quot;example&quot; &#123;\n  match-clients &#123; example; &#125;;\n  zone &quot;example.net&quot; IN  &#123;\n       type slave;\n       file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones.signed&quot;;\n       masters &#123; 10.13.3.106; &#125;;\n  &#125;;\n  zone &quot;3.13.10.in-addr.arpa.&quot; IN  &#123;\n       type slave;\n       masters &#123; 10.13.3.106; &#125;;\n       file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.reverse.zones&quot;;\n  &#125;;\n&#125;;\n\nview &quot;company&quot; &#123;\n  match-clients &#123; company; &#125;;\n  zone &quot;company.com&quot; IN  &#123;\n       type slave;\n       masters &#123; 10.13.3.106; &#125;;\n       file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;company.db.zones&quot;;\n  &#125;;\n&#125;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>&#x2F;etc&#x2F; apparmor.d&#x2F;usr.sbin.named  设置可写。dumping master file: &#x2F;etc&#x2F;bind&#x2F;example&#x2F;tmp-80LUGLiqE4: open: permission denied  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;bind&#x2F;example&#x2F;** rw,\n\nsystemctl reload apparmor.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"2-2-测试记录同步\"><a href=\"#2-2-测试记录同步\" class=\"headerlink\" title=\"2.2 测试记录同步\"></a>2.2 测试记录同步</h2><ul>\n<li>修改主服务器，解析记录，测试从服务器的同步情况  <pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.top.  admin.example.top. (\n                                   2   ; serial   [[每次需要修改版本号]]\n                                1200   ; refresh \n                                900    ; retry \n                                900    ; expire\n                               1200 )  ; minimum \n@        IN      NS      nameserver\n@        IN      NS      nameserver2              [[较版本1新增]]\nnameserver   IN  A       10.13.3.107\nnameserver2  IN  A       10.13.3.109              [[较版本1新增]]\ntest         IN  A       10.13.3.109\nk8s          IN  A       10.13.3.110\nme           IN  A       10.10.6.1               [[较版本1新增]]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<p><strong>热加载</strong>新增的配置，每次修改记录时，需要同步修改<em><strong>版本号</strong></em>，slave 才能同步成功  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo rndc reload     # 主服务器执行即可\ndig -t a me.example.top @10.13.3.109<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<ul>\n<li>当从服务器有解析文件的，解析记录仍会向主服务器请求，主服务器宕机，从服务器缓存过期之后，也仍不能加载并实施解析区域记录文件  </li>\n<li>同一个网段在多个acl下，将不能正常解析。</li>\n</ul>\n<h2 id=\"2-3-测试公网域名\"><a href=\"#2-3-测试公网域名\" class=\"headerlink\" title=\"2.3 测试公网域名\"></a>2.3 测试公网域名</h2><ul>\n<li>此時公网域名成功解析得到的是保留ip地址，ping 域名不能成功—-因为公司的 ip 做了加密  </li>\n<li>不能成功解析则无记录返回</li>\n</ul>\n<hr>\n<h1 id=\"三、-安全\"><a href=\"#三、-安全\" class=\"headerlink\" title=\"三、 安全\"></a>三、 安全</h1><h2 id=\"3-1-功能同于bind-chroot\"><a href=\"#3-1-功能同于bind-chroot\" class=\"headerlink\" title=\"3.1 功能同于bind-chroot\"></a>3.1 功能同于bind-chroot</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">vi &#x2F;etc&#x2F;apparmor.d&#x2F;usr.sbin.named\n# 检查是否存在，否则增加以下内容\n  &#x2F;etc&#x2F;bind&#x2F;** r,\n  &#x2F;var&#x2F;lib&#x2F;bind&#x2F;** rw,\n  &#x2F;var&#x2F;lib&#x2F;bind&#x2F; rw,\n  &#x2F;var&#x2F;cache&#x2F;bind&#x2F;** lrw,\n  &#x2F;var&#x2F;cache&#x2F;bind&#x2F; rw,\n  &#x2F;var&#x2F;log&#x2F;named&#x2F;** rw,\n  &#x2F;var&#x2F;log&#x2F;named&#x2F; rw,<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-2-开启DNSSEC验证，参考\"><a href=\"#3-2-开启DNSSEC验证，参考\" class=\"headerlink\" title=\"3.2 开启DNSSEC验证，参考\"></a>3.2 开启DNSSEC验证，<a href=\"https://www.cnblogs.com/anpengapple/p/5879363.html\">参考</a></h2><ul>\n<li><p>作用：对域名进行签名认证，保证域名的完整性和正确性，不会被修改  </p>\n</li>\n<li><p>在新增的 dnssec_keys 目录中生成密钥  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo dnssec-keygen -f KSK -a RSASHA256 -b 2048 -n ZONE example.net.\nsudo dnssec-keygen -a RSASHA256  -b 2048 -n ZONE example.net.\n\n# 查看本域应用所需的密钥文件  \nls \nKexample.net.+008+16296.key   Kexample.net.+008+16296.private   Kexample.net.+008+23579.key  Kexample.net.+008+23579.private<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>将前面生成的两个公钥添加到区域配置文件末尾  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m )  ; minimum\n\n@        IN      NS      nameserver\n\nnameserver       IN      A       10.13.3.106\nldap   IN  A   10.13.3.107\ntest   IN  A   10.13.3.105\n\n$INCLUDE  &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;dnssec_keys&#x2F;Kexample.net.+008+23579.key&quot;\n$INCLUDE  &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;dnssec_keys&#x2F;Kexample.net.+008+16296.key&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>对区域文件签名，会生成一个新的zones.sigend. 如果新增了解析记录，需要再次加密  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo dnssec-signzone -K &#x2F;etc&#x2F;bind&#x2F;example&#x2F;dnssec_keys&#x2F; -o example.net. &#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones\n -K  指定密钥文件路径    -o  域名   路径是区域解析文件路径<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>改动引用解析文件路径的位置  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">view <span class=\"token string\">\"example\"</span> <span class=\"token punctuation\">&#123;</span>\n  match-clients <span class=\"token punctuation\">&#123;</span> example<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n  zone <span class=\"token string\">\"example.net\"</span> IN  <span class=\"token punctuation\">&#123;</span>\n       <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n       <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.db.zones.signed\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>生成信任锚文件 &#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf  </p>\n</li>\n<li><p>这里面的两条内容是刚才生成的两个密钥的内容。用公钥比较方便（也就是.key的文件）。注意复制的时候去掉“IN”和“DNSKEY”这两个词，以及后面的key要加引号  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">trusted-keys <span class=\"token punctuation\">&#123;</span>\n   example.net.   <span class=\"token number\">256</span> <span class=\"token number\">3</span> <span class=\"token number\">8</span>  <span class=\"token string\">\"AwEAAb+3BGqXqE/WwDICGRONYv1w4savuaD4cJ/VRL6xGg2b54OilEWE WMzUAOw4B/sPyKZDG/XTnaW4mD756l/swRuq9kO/sktgu4ZP4onmqeFM sdMTTmxesp6Q6ebqAPNzQfKyZwqX6Iq00qGslUmxr5FSOLWjGoze8afm TxbPW6Hi7JQ85mJ+TkpUNa+ymDS4qKi87rSi8NQTDbsZ0wH7+zX1TBOP jeUI/JsxD/bu1kD97AP9u2Sd4D8U0vyN8fN4LIIKfA5vurPaWPfQIM8r I0KQueAHdNLOPjaEWcKg/rBHFWZPxIeQGM8D2VXwkdPL5fefC59wONhK ys2RMqv3DIM=\"</span><span class=\"token punctuation\">;</span>\n  example.net.   <span class=\"token number\">257</span> <span class=\"token number\">3</span> <span class=\"token number\">8</span> <span class=\"token string\">\"AwEAAbZo3hpm+0+32jgrTXog3CCUTTctP3LoBx1F0nbpoEBkWN1CA//O 7fzNY08pwblkKKW/LkYiQNQEQq50ThouV9UJ+CFRf/Fju6ggIpWpNjsu 8c2+zROZdJ9d2T6JnVTYPo1Iyn8ufn0hFjPRrwdvfQKSmnI9ZRx2eRFc ZFJpqNTj2LwzqoEKrbOn4oywqTWJL1Hyjv8e/kBojy7BghKWYnTGlpha 9CSin17qUQCY+o0qMzmezq+/AbxhdJwV9KYHWzWvNZjyyjBLyxwwsV4F shgmXm2tTuW5gPrnbfzaP+R/cElzl03mtjmJ//g5wWMMV8QKemBpbNoR ajzYYhhocWk=\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>引入此信任锚文件 &#x2F;etc&#x2F;bind&#x2F;name.conf  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf&quot;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li><p>重启服务  </p>\n</li>\n<li><p>验证  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">dig</span> +dnssec  test.example.net  @10.13.3.106\n\n<span class=\"token punctuation\">;</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> DiG <span class=\"token number\">9.16</span>.1-Ubuntu <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> +dnssec test.example.net @10.13.3.106\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> global options: +cmd\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Got answer:\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> -<span class=\"token operator\">>></span>HEADER<span class=\"token operator\">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class=\"token number\">28767</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> flags: qr aa rd ra<span class=\"token punctuation\">;</span> QUERY: <span class=\"token number\">1</span>, ANSWER: <span class=\"token number\">2</span>, AUTHORITY: <span class=\"token number\">0</span>, ADDITIONAL: <span class=\"token number\">1</span>\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> OPT PSEUDOSECTION:\n<span class=\"token punctuation\">;</span> EDNS: version: <span class=\"token number\">0</span>, flags: <span class=\"token keyword\">do</span><span class=\"token punctuation\">;</span> udp: <span class=\"token number\">1232</span>\n<span class=\"token punctuation\">;</span> COOKIE: 0d6b52d25063b09401000000655592b51d0f8f6c0b072961 <span class=\"token punctuation\">(</span>good<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>test.example.net.                        IN      A\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\ntest.example.net.         <span class=\"token number\">600</span>     IN      A       <span class=\"token number\">10.13</span>.3.105\ntest.example.net.         <span class=\"token number\">600</span>     IN      RRSIG   A <span class=\"token number\">8</span> <span class=\"token number\">3</span> <span class=\"token number\">600</span> <span class=\"token number\">20231216022642</span> <span class=\"token number\">20231116022642</span> <span class=\"token number\">16296</span> example.net. iUSB+maT6y22ySZdEZHElShHCVDbmjnHez39eosniP1wqvquyadVydlT lZ3XZbUMNTV3WrZhLEjuGaVwNajvAqeY07IPCivpr+VCuIPXccONBwZE 3ZRX5B2PcGnrhMWupH+jcoT5NTy5pAEdm5JXbtJljFyJk1XxQVhanzJO /TY7YMJWWDbj3WnywkEPQyP5UYExl4Y0E3BPUX/J4xuCspTovQhqo6BM HaC3XFMG1Li9CbHcfNkUjVtdi8oQmAdM6lMqFTz5KNpIRppqhEukcD9o w9slLc1vpjDwqzO7xPls8S9WbzMeHzHNbIrPcv88MQWUAIVyqodbhOvj <span class=\"token assign-left variable\">8ZKlgg</span><span class=\"token operator\">==</span>\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Query time: <span class=\"token number\">0</span> msec\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> SERVER: <span class=\"token number\">10.13</span>.3.106<span class=\"token comment\">#53(10.13.3.106)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> WHEN: Thu Nov <span class=\"token number\">16</span> <span class=\"token number\">11</span>:55:33 CST <span class=\"token number\">2023</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> MSG SIZE  rcvd: <span class=\"token number\">384</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>问题：  </p>\n</li>\n<li><p>配置后，每个客户端需要添加信任锚文件以作签名验证  </p>\n</li>\n<li><p>这个签名后的zone可以被伪造，使用dig命令输出的文件修改伪造</p>\n</li>\n</ul>\n<h2 id=\"3-3-创建视图管理，智能DNS\"><a href=\"#3-3-创建视图管理，智能DNS\" class=\"headerlink\" title=\"3.3 创建视图管理，智能DNS\"></a>3.3 创建视图管理，智能DNS</h2><p><a href=\"https://www.cnblogs.com/anpengapple/p/5879350.html\">参考1</a><br><a href=\"https://www.cnblogs.com/etangyushan/p/4335521.html\">参考2</a><br><a href=\"http://www.hangdaowangluo.com/archives/1633\">参考3</a><br><a href=\"https://www.server-world.info/en/note?os=Ubuntu_20.04&p=dns&f=5\">ubuntu案例</a>  </p>\n<ul>\n<li>vim  &#x2F;etc&#x2F;bind&#x2F;named.conf</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">include <span class=\"token string\">\"/etc/bind/named.conf.options\"</span><span class=\"token punctuation\">;</span>\ninclude <span class=\"token string\">\"/etc/bind/named.conf.local\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># include \"/etc/bind/named.conf.default-zones\";</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>cat  &#x2F;etc&#x2F;bind&#x2F;named.conf.options</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">options &#123;\n        directory &quot;&#x2F;var&#x2F;cache&#x2F;bind&quot;;\n        listen-on port 53 &#123; localhost; &#125;;\n        recursion yes;        # 允许递归才能在智能dns解析万网域名\n        forwarders &#123;\n          223.5.5.5;\n        &#125;;\n        forward  first;\n        version  &quot;hiden version&quot;;   # 隐藏版本\n        allow-transfer &#123; 10.13.3.106; &#125;;\n        allow-query &#123; \n          example;\n          company;\n        &#125;;\n        auth-nxdomain true;\n        dnssec-validation false; # dns安全拓展的选项\n&#125;;\n# 此处定义目标ip地址段，划分可访问的域\nacl &quot;example&quot; &#123;\n    10.13.3.0&#x2F;24;\n    10.10.6.0&#x2F;24;\n&#125;;\n\nacl &quot;company&quot; &#123;\n    10.10.6.0&#x2F;24;\n&#125;;\n# 此处制定目标ip可以访问的域名的解析区域\nview &quot;example&quot; &#123;\n  match-clients &#123; example; &#125;;\n  include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.views&quot;;\n&#125;;\n\nview &quot;company&quot; &#123;\n  match-clients &#123; company; &#125;;\n  include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;company.views&quot;;\n&#125;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>views 文件中指定区域解析文件，eg：</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">zone <span class=\"token string\">\"example.net\"</span> IN <span class=\"token punctuation\">&#123;</span>                                          <span class=\"token comment\"># 此处域名和 zones 文件中的域名一致</span>\n      <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.net.zones\"</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\nzone <span class=\"token string\">\"3.13.10.in-addr.arpa.\"</span> IN <span class=\"token punctuation\">&#123;</span>                         <span class=\"token comment\"># 此处格式固定，设计反向解析的ip的网络位，和zones文件中的主机位结合成为完整ip地址</span>\n      <span class=\"token builtin class-name\">type</span> master<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">file</span> <span class=\"token string\">\"/etc/bind/example/example.net.reverse.zones\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nzone <span class=\"token string\">\"example.top\"</span> IN <span class=\"token punctuation\">&#123;</span>                              <span class=\"token comment\"># 配置此 dns 向 10.13.3.101 这个转发器请求解析 example.top 的域名。在全局 options 配置转发没有成功，选择了此方案。</span>\n      <span class=\"token builtin class-name\">type</span> forward<span class=\"token punctuation\">;</span>\n      forwarders <span class=\"token punctuation\">&#123;</span><span class=\"token number\">10.13</span>.3.101<span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li><p>正向区域解析文件  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n) \n@        IN      NS      nameserver\n\nnameserver       IN      A       10.13.3.106\n\nldap   IN  A   10.13.3.107\ntest   IN  A   10.13.3.105<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>反向区域解析文件  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$TTL 10M\n@       IN      SOA     example.net.  admin.example.net. (\n                                  1   ; serial\n                                24h   ; refresh\n                                15m   ; retry\n                                1d    ; expire\n                                5m  ; minimum\n)\n       IN      NS      nameserver.      # 不能缺省这个&quot;.&quot;\n\n107  IN    PTR    ldap.example.net.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>测试   </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dig   目标域名   @namserver    +short\ndig   目标ip   -x   +short\nnslookup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"3-4-加密\"><a href=\"#3-4-加密\" class=\"headerlink\" title=\"3.4 加密\"></a>3.4 加密</h2><p><a href=\"https://runtufenxiang.com/6186/\">知名公共DoT&#x2F;DoH加密DNS服务器</a><br><a href=\"https://devblog.rayonnant.net/creating-a-dot-and-doh-server-using-nginx-and-bind/\">配置</a><br><a href=\"https://dididudu998.github.io/2022/02/15/configure-doh-bind.html\">bind9 tls &#x2F; https</a>网络层的问题是DoT使用853的端口，很容易被封锁，而DoH使用443端口，一般不会被封锁    </p>\n<h3 id=\"3-4-1-DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）\"><a href=\"#3-4-1-DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）\" class=\"headerlink\" title=\"3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）\"></a>3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">tls mycert &#123;\n    cert-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;cert.pem&quot;;\n    key-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;key.pem&quot;;\n&#125;;\n\noptions &#123;\n    directory &quot;&#x2F;var&#x2F;cache&#x2F;bind&quot;;\n    listen-on port 853 tls mycert &#123; localhost; &#125;;\n    forward  first;\n    forwarders &#123;\n            223.5.5.5;\n            120.53.53.53;\n    &#125;;\n    allow-query &#123; 10.13.3.0&#x2F;24;&#125;;\n    auth-nxdomain true;\n    allow-update &#123; none; &#125;;\n  &#x2F;&#x2F;  allow-transfer &#123; 10.13.3.106; &#125;;\n    version  &quot;hiden version&quot;;\n    recursion false;\n&#125;;\n\nzone &quot;example.net&quot;&#123;\n   type master;\n   file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.net.zones&quot;;\n&#125;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>客户端修改dns地址步骤如下：  </li>\n<li>&#x2F;etc&#x2F;resolv.conf  是软链接，指向了&#x2F;run&#x2F;systemd&#x2F;resolve&#x2F;stub-resolv.conf。直接修改内容会被覆盖，没有意义  </li>\n<li>vim &#x2F;etc&#x2F;systemd&#x2F;resolved.conf  <pre class=\"line-numbers language-none\"><code class=\"language-none\">[Resolve]\nDNS&#x3D;10.13.3.106\n[[FallbackDNS]]&#x3D;\nDNSOverTLS&#x3D;opportunistic  # 或者yes<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>systemctl restart systemd-resolved.service   </li>\n<li>mv &#x2F;etc&#x2F;resolv.conf   &#x2F;etc&#x2F;resolv.conf.bak  </li>\n<li>ln -s &#x2F;run&#x2F;systemd&#x2F;resolve&#x2F;resolv.conf &#x2F;etc&#x2F;</li>\n</ul>\n<h3 id=\"3-4-2-问题\"><a href=\"#3-4-2-问题\" class=\"headerlink\" title=\"3.4.2 问题\"></a>3.4.2 问题</h3><ul>\n<li><p>以上配置之后，使用特定命令发现 DOT 是成功的，例如  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">resolvectl query mee.example.net\n\tmee.example.net: 10.10.6.1                       -- link: ens160\n\t\n\t-- Information acquired via protocol DNS in 1.7ms.\n\t-- Data is authenticated: no\n\ndig +tls mee.example.net\n\t; &lt;&lt;&gt;&gt; DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu &lt;&lt;&gt;&gt; +tls mee.example.net\n\t;; global options: +cmd\n\t;; Got answer:\n\t;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 52275\n\t;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\t;; WARNING: recursion requested but not available\n\t\n\t;; OPT PSEUDOSECTION:\n\t; EDNS: version: 0, flags:; udp: 1232\n\t; COOKIE: 174ae084d3aed77f01000000655474d3fbb4902501bc69cb (good)\n\t;; QUESTION SECTION:\n\t;mee.example.net.                 IN      A\n\t\n\t;; ANSWER SECTION:\n\tmee.example.net.          600     IN      A       10.10.6.1\n\t\n\t;; Query time: 0 msec\n\t;; SERVER: 10.13.3.106#853(10.13.3.106) (TLS)\n\t;; WHEN: Wed Nov 15 15:35:47 CST 2023\n\t;; MSG SIZE  rcvd: 86\n以上访问了dns服务器853端口，所以返回正常解析<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>普通解析会失败  </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dig mee.example.net  （nslookup ssh  ping）\n\t;; communications error to 10.13.3.106#53: connection refused\n\t;; communications error to 10.13.3.106#53: connection refused\n\t;; communications error to 10.13.3.106#53: connection refused\n\t\n\t; &lt;&lt;&gt;&gt; DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu &lt;&lt;&gt;&gt; mee.example.net\n\t;; global options: +cmd\n\t;; no servers could be reached<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>因此，仍然开启 53 端口，二者同时可以使用，但是如果需要特定的方式使用DNSOverTLS ，那么以目前在服务器上的使用上来看，使用是没有意义的。  </p>\n</li>\n<li><p>在服务器使用 53，在浏览器使用自建 DOH，是适宜的</p>\n</li>\n</ul>\n<h3 id=\"3-4-3-DOH-加密和转发\"><a href=\"#3-4-3-DOH-加密和转发\" class=\"headerlink\" title=\"3.4.3  DOH 加密和转发\"></a>3.4.3  DOH 加密和转发</h3><ul>\n<li><p>配置  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">tls doh <span class=\"token punctuation\">&#123;</span>\n   key-file <span class=\"token string\">\"/etc/bind/example/cert/key.pem\"</span><span class=\"token punctuation\">;</span>\n   cert-file <span class=\"token string\">\"/etc/bind/example/cert/ca.pem\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\nhttp dns-over-https <span class=\"token punctuation\">&#123;</span>\n    endpoints <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"/dns-query\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\noptions <span class=\"token punctuation\">&#123;</span>\n        listen-on port <span class=\"token number\">443</span> tls doh http default <span class=\"token punctuation\">&#123;</span> localhost<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>检测  </p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">dig</span> +https  test.example.net  @10.13.3.106 A\n\n<span class=\"token punctuation\">;</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> DiG <span class=\"token number\">9.18</span>.19-1+ubuntu20.04.1+isc+1-Ubuntu <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">>></span> +https test.example.net @10.13.3.106 A\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> global options: +cmd\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Got answer:\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> -<span class=\"token operator\">>></span>HEADER<span class=\"token operator\">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class=\"token number\">15036</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> flags: qr aa rd ra<span class=\"token punctuation\">;</span> QUERY: <span class=\"token number\">1</span>, ANSWER: <span class=\"token number\">1</span>, AUTHORITY: <span class=\"token number\">0</span>, ADDITIONAL: <span class=\"token number\">1</span>\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> OPT PSEUDOSECTION:\n<span class=\"token punctuation\">;</span> EDNS: version: <span class=\"token number\">0</span>, flags:<span class=\"token punctuation\">;</span> udp: <span class=\"token number\">1232</span>\n<span class=\"token punctuation\">;</span> COOKIE: dcdab07360fe04b2010000006555c9c6572491f7e49a2f35 <span class=\"token punctuation\">(</span>good<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> QUESTION SECTION:\n<span class=\"token punctuation\">;</span>test.example.net.                        IN      A\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> ANSWER SECTION:\ntest.example.net.         <span class=\"token number\">600</span>     IN      A       <span class=\"token number\">10.13</span>.3.105\n\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> Query time: <span class=\"token number\">0</span> msec\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> SERVER: <span class=\"token number\">10.13</span>.3.106<span class=\"token comment\">#443(10.13.3.106) (HTTPS)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> WHEN: Thu Nov <span class=\"token number\">16</span> <span class=\"token number\">15</span>:50:30 CST <span class=\"token number\">2023</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span> MSG SIZE  rcvd: <span class=\"token number\">87</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>使用<br>此时在客户端使用 DOH ，浏览器设置 use secure dns ，custom url ： <a href=\"https://nameserver.example.net/dns-query\">https://nameserver.example.net/dns-query</a><br>在客户端其他程序的使用中，仍然会访问 dns 的 53 端口</p>\n</li>\n</ul>\n<h2 id=\"3-5-其他安全实践\"><a href=\"#3-5-其他安全实践\" class=\"headerlink\" title=\"3.5 其他安全实践\"></a>3.5 其他安全实践</h2><ul>\n<li>下列参考<a href=\"https://www.secpulse.com/archives/52634.html\">来源</a>  <pre class=\"line-numbers language-none\"><code class=\"language-none\">隐藏BIND版本号\n限定哪台主机能够发起区域传输<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">version  &quot;hiden version&quot;;                             #  隐藏版本信息\nallow-transfer &#123; 221.236.9.9; &#125;;    #  指定允许某从服务器进行区域传输到该服务器，此配置一般在主服务器配置<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h1 id=\"四、web-管理以及反向代理\"><a href=\"#四、web-管理以及反向代理\" class=\"headerlink\" title=\"四、web 管理以及反向代理\"></a>四、web 管理以及反向代理</h1><p><a href=\"https://www.mmcloud.com/2863.html\">安装 webmin工具</a><br><a href=\"https://devpress.csdn.net/cloud/6304db5f7e6682346619cf4b.html\">使用ngingx反代</a>  </p>\n<ul>\n<li>路径nginx&#x2F;conf.d&#x2F;webmin.conf   （检查443、80端口，确认dns地址和解析记录）  <pre class=\"line-numbers language-none\"><code class=\"language-none\">upstream webmin &#123;\n  server 10.13.3.107:10000;\n&#125;\n\nserver &#123;\n  listen 80;\n  server_name webmin.example.net;\n  return 301 https:&#x2F;&#x2F;$server_name$request_uri;\n&#125;\n\nserver &#123;\n  server_name webmin.example.net;\n  listen 443 ssl;\n  ssl_certificate webmin&#x2F;tls_ca.pem;\n  ssl_certificate_key webmin&#x2F;tls_key.pem;\n\n  location &#x2F; &#123;\n    proxy_pass      https:&#x2F;&#x2F;webmin;\n    proxy_redirect  off;\n    proxy_set_header   Host             $host:$server_port;\n    proxy_set_header   X-Real-IP        $remote_addr;\n    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto &quot;https&quot;;\n    proxy_connect_timeout      10;\n    proxy_send_timeout         10;\n    proxy_read_timeout         10;\n    proxy_buffer_size          128k;\n    proxy_buffers              32 32k;\n    proxy_busy_buffers_size    256k;\n    proxy_temp_file_write_size 256k;\n  &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h1 id=\"五、bind9-18-nginx-反向代理\"><a href=\"#五、bind9-18-nginx-反向代理\" class=\"headerlink\" title=\"五、bind9.18  nginx 反向代理\"></a>五、bind9.18  nginx 反向代理</h1><p><a href=\"https://www.infvie.com/ops-notes/nginx-udp-dns.html\">反向代理参考</a>  </p>\n"},{"title":"FRP 穿透并代理到ingressroute","date":"2024-04-16T02:02:00.000Z","summary":"公网访问家中的试验虚拟机上的kube集群","_content":"\n条件：需要有一个公网中的主机，如果需要通过域名进行 http 类型的穿透，需要有域名。\n说明：没有 ssl 证书，所以都是基于 http 的尝试，后续补充 https。\n## 服务端配置\n### frps .toml 基本如此，没有特殊需要将不会改\ngithub 仓库中有一个目录是 conf，其中可以看到所有的配置和注解\n```toml\nbindPort = 7000\nbindAddr = \"my PublicIP\"\nvhostHTTPPort = 8080  # 使用 Http 类型的代理穿透时需要增加此端口\nauth.method = \"token\"\nauth.token = \"domainMyDomainname\" # 自定义即可\n\nsubDomainHost = \"MyDomainname.cn\"  # 配合 client 端的 subdomain 使用。\n```\n### systemd 管理服务\n```bash\n[root@oncloud html]# cat /usr/lib/systemd/system/frps.service\n[Unit]\n# 服务名称，可自定义\nDescription = frp server\nAfter = network.target syslog.target\nWants = network.target\n\n[Service]\nType = simple\n# 启动frps的命令，需修改为您的frps的安装路径\nExecStart = /usr/local/bin/frps -c /etc/frp/frps.toml\n\n[Install]\nWantedBy = multi-user.target\n```\n\n```\nsudo systemctl daemon-reload\nsudo systemctl enable --now frps\n```\n\n因为是使用 http 类型，还给公网的这个机器做了 nginx 代理\n### nginx 代理配置文件\n```nginx.conf\nserver {\n        listen 80;\n        server_name rancher.MyDomainname.cn;\n\n        location / {\n            proxy_pass http://my PublicIP:8080;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        }\n}\n```\n\n## 客户端使用\n同样可以使用 systemd 管理 frpc 服务\n### 案例 1：ssh 连接内网主机\n\n#### frpc .toml \n```toml\nserverAddr = \"my PublicIP\"\nserverPort = 7000\nauth.method = \"token\"\nauth.token = \"domainMyDomainname\"\n\n[[proxies]]    # 固定\nname = \"ssh\"   # 自定义，唯一，相当于这个配置块的名称\ntype = \"tcp\"\nlocalIP = \"127.0.0.1\"  #主要是需要监听到子网这个主机的ipv4地址\nlocalPort = 22         # 子网这个主机的 ssh 端口\nremotePort = 6000     # 配置后，公网主机将自行监听此端口\n```\n#### 使用\n `ssh -o Port=6000 子网机器 user 名@公网主机名`  \\\n 效果：在 WLAN 主机执行后，6000-->7000-->subnet `\n### 案例 2：自定义域名访问内网服务\n#### frpc .toml\n```toml\nserverAddr = \"my PublicIP\"\nserverPort = 7000\nauth.method = \"token\"\nauth.token = \"domainMyDomainname\"\n\n[[proxies]]\nname = \"test1-web\"\ntype = \"http\"\nlocalIP = \"192.168.3.20\"  # 内网Nginx\nlocalPort = 80            # ip + port，相当于将frpserver的流量定向到这个内网的地址，在此例中，这个地址是nginx，所以会再指向它代理的地址\nsubdomain = \"rancher\"  # 配合 server 端的配置，组成域名rancher.MyDomainname.cn；这时在公网中需要给自己域名增加的一个解析\nhostHeaderRewrite = \"master.MyDomainname.cn\" # 会将 subdoamin 组成的host会替换为此配置，以后可以只在域名解析使用以上一个A记录就好\n```\n\n>[!annotation]\n>基于上述配置，我在自己的内网中还有 dns 和 nginx 配合使用，子网主机都使用内网 DNS。\n\nDNS 中使用的域名是 testlab.net；解析记录主要是内网中的服务。\nNginx 使用：http 穿透后，流量会到我的 nginx 80 端口，然后配置一个代理转发，流量将去向真正的服务的地址（DNS 需要做好目标的解析）。\n#### nginx proxy example\n```nginx.conf\nserver {\n    listen 80;\n    server_name master.MyDomainname.cn;\n\n    location / {\n        proxy_pass http://master.homelab.net;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n}\n```\n\n基于这个客户端配置，我在公网访问 rancher.MyDomainname.cn 就将能够访问子网中的，master.homelab.net 的服务（这是一个普通的web）\n流量：\n```\ndesktop--> rancher.MyDomainname.cn --> External DNS --> Server under WLAN --> nginx --> frps --> frpc --> nginx proxy --> internal nginx --> target service\n```\n\n### 案例 3：内网中 nginx 代理 traefikingressrout（区别于普通web）\n#### frpc .toml\n```toml\nserverAddr = \"my PublicIP\"\nserverPort = 7000\nauth.method = \"token\"\nauth.token = \"domainMyDomainname\"\n\n[[proxies]]\nname = \"test2-web\"\ntype = \"http\"\nlocalIP = \"192.168.3.20\"\nlocalPort = 80\nsubdomain = \"rancher\"\n```\n\n#### nginx proxy example\n```nginx.conf\nserver {\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location / {\n        proxy_pass http://rancher.homelab.net;\n        proxy_set_header Host rancher.homelab.net;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n```\n\n>[! failure] \n>上述测试出现不能成功转发，甚至不是 404。而且直接在浏览器地址栏显示代理后的 rancher. Homelab. Net；无论是否配置 Host 变量，无论这个\n>Host 是使用$host 或者是静态的 `rancher.homelab.net`\n\n#### 单独测试 nginx 代理 ingressroute\n这个是在公司内网，仅测试 nginx 转发到 traefik ingressroute 的配置，成功访问。但是在家中的环境下仍然不能成功访问。\n```nginx.conf\nserver {\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location / {\n        proxy_pass http://monitorprom.testlab.net;\n        proxy_set_header Host monitorprom.testlab.net;   # 原以为此配置很重要，不然经 nginx 转发后的请求host header不正确（可测试发现配置与否都成功实现代理了）\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n```\n\n#### 测试效果\n![nginx转发到traefik ingressroute 的效果](https://ice.frostsky.com/2024/04/16/c8572ce35380b5e78eb2895579f6573b.png)\n\n#### 成功穿透下的配置\nfrpc 没有变化，nginx 如下\n```nginx.conf\nserver {\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location / {\n        proxy_pass https://rancher.homelab.net;  # 原使用的是http，或许家中的集群配置了traefik 使用tls，待验证\n        proxy_set_header Host rancher.homelab.net; # 此项配置不影响\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n```\n","source":"_posts/FRP 穿透并代理到ingressroute.md","raw":"---\ntitle: FRP 穿透并代理到ingressroute\ndate: 2024-04-16 10:02:00\ntags: [FRP, IngressRoute]\ncategories: ops\nsummary: 公网访问家中的试验虚拟机上的kube集群\n---\n\n条件：需要有一个公网中的主机，如果需要通过域名进行 http 类型的穿透，需要有域名。\n说明：没有 ssl 证书，所以都是基于 http 的尝试，后续补充 https。\n## 服务端配置\n### frps .toml 基本如此，没有特殊需要将不会改\ngithub 仓库中有一个目录是 conf，其中可以看到所有的配置和注解\n```toml\nbindPort = 7000\nbindAddr = \"my PublicIP\"\nvhostHTTPPort = 8080  # 使用 Http 类型的代理穿透时需要增加此端口\nauth.method = \"token\"\nauth.token = \"domainMyDomainname\" # 自定义即可\n\nsubDomainHost = \"MyDomainname.cn\"  # 配合 client 端的 subdomain 使用。\n```\n### systemd 管理服务\n```bash\n[root@oncloud html]# cat /usr/lib/systemd/system/frps.service\n[Unit]\n# 服务名称，可自定义\nDescription = frp server\nAfter = network.target syslog.target\nWants = network.target\n\n[Service]\nType = simple\n# 启动frps的命令，需修改为您的frps的安装路径\nExecStart = /usr/local/bin/frps -c /etc/frp/frps.toml\n\n[Install]\nWantedBy = multi-user.target\n```\n\n```\nsudo systemctl daemon-reload\nsudo systemctl enable --now frps\n```\n\n因为是使用 http 类型，还给公网的这个机器做了 nginx 代理\n### nginx 代理配置文件\n```nginx.conf\nserver {\n        listen 80;\n        server_name rancher.MyDomainname.cn;\n\n        location / {\n            proxy_pass http://my PublicIP:8080;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        }\n}\n```\n\n## 客户端使用\n同样可以使用 systemd 管理 frpc 服务\n### 案例 1：ssh 连接内网主机\n\n#### frpc .toml \n```toml\nserverAddr = \"my PublicIP\"\nserverPort = 7000\nauth.method = \"token\"\nauth.token = \"domainMyDomainname\"\n\n[[proxies]]    # 固定\nname = \"ssh\"   # 自定义，唯一，相当于这个配置块的名称\ntype = \"tcp\"\nlocalIP = \"127.0.0.1\"  #主要是需要监听到子网这个主机的ipv4地址\nlocalPort = 22         # 子网这个主机的 ssh 端口\nremotePort = 6000     # 配置后，公网主机将自行监听此端口\n```\n#### 使用\n `ssh -o Port=6000 子网机器 user 名@公网主机名`  \\\n 效果：在 WLAN 主机执行后，6000-->7000-->subnet `\n### 案例 2：自定义域名访问内网服务\n#### frpc .toml\n```toml\nserverAddr = \"my PublicIP\"\nserverPort = 7000\nauth.method = \"token\"\nauth.token = \"domainMyDomainname\"\n\n[[proxies]]\nname = \"test1-web\"\ntype = \"http\"\nlocalIP = \"192.168.3.20\"  # 内网Nginx\nlocalPort = 80            # ip + port，相当于将frpserver的流量定向到这个内网的地址，在此例中，这个地址是nginx，所以会再指向它代理的地址\nsubdomain = \"rancher\"  # 配合 server 端的配置，组成域名rancher.MyDomainname.cn；这时在公网中需要给自己域名增加的一个解析\nhostHeaderRewrite = \"master.MyDomainname.cn\" # 会将 subdoamin 组成的host会替换为此配置，以后可以只在域名解析使用以上一个A记录就好\n```\n\n>[!annotation]\n>基于上述配置，我在自己的内网中还有 dns 和 nginx 配合使用，子网主机都使用内网 DNS。\n\nDNS 中使用的域名是 testlab.net；解析记录主要是内网中的服务。\nNginx 使用：http 穿透后，流量会到我的 nginx 80 端口，然后配置一个代理转发，流量将去向真正的服务的地址（DNS 需要做好目标的解析）。\n#### nginx proxy example\n```nginx.conf\nserver {\n    listen 80;\n    server_name master.MyDomainname.cn;\n\n    location / {\n        proxy_pass http://master.homelab.net;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n}\n```\n\n基于这个客户端配置，我在公网访问 rancher.MyDomainname.cn 就将能够访问子网中的，master.homelab.net 的服务（这是一个普通的web）\n流量：\n```\ndesktop--> rancher.MyDomainname.cn --> External DNS --> Server under WLAN --> nginx --> frps --> frpc --> nginx proxy --> internal nginx --> target service\n```\n\n### 案例 3：内网中 nginx 代理 traefikingressrout（区别于普通web）\n#### frpc .toml\n```toml\nserverAddr = \"my PublicIP\"\nserverPort = 7000\nauth.method = \"token\"\nauth.token = \"domainMyDomainname\"\n\n[[proxies]]\nname = \"test2-web\"\ntype = \"http\"\nlocalIP = \"192.168.3.20\"\nlocalPort = 80\nsubdomain = \"rancher\"\n```\n\n#### nginx proxy example\n```nginx.conf\nserver {\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location / {\n        proxy_pass http://rancher.homelab.net;\n        proxy_set_header Host rancher.homelab.net;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n```\n\n>[! failure] \n>上述测试出现不能成功转发，甚至不是 404。而且直接在浏览器地址栏显示代理后的 rancher. Homelab. Net；无论是否配置 Host 变量，无论这个\n>Host 是使用$host 或者是静态的 `rancher.homelab.net`\n\n#### 单独测试 nginx 代理 ingressroute\n这个是在公司内网，仅测试 nginx 转发到 traefik ingressroute 的配置，成功访问。但是在家中的环境下仍然不能成功访问。\n```nginx.conf\nserver {\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location / {\n        proxy_pass http://monitorprom.testlab.net;\n        proxy_set_header Host monitorprom.testlab.net;   # 原以为此配置很重要，不然经 nginx 转发后的请求host header不正确（可测试发现配置与否都成功实现代理了）\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n```\n\n#### 测试效果\n![nginx转发到traefik ingressroute 的效果](https://ice.frostsky.com/2024/04/16/c8572ce35380b5e78eb2895579f6573b.png)\n\n#### 成功穿透下的配置\nfrpc 没有变化，nginx 如下\n```nginx.conf\nserver {\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location / {\n        proxy_pass https://rancher.homelab.net;  # 原使用的是http，或许家中的集群配置了traefik 使用tls，待验证\n        proxy_set_header Host rancher.homelab.net; # 此项配置不影响\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n```\n","slug":"FRP 穿透并代理到ingressroute","published":1,"updated":"2024-04-20T03:18:37.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodh3000780rv54tffd6x","content":"<p>条件：需要有一个公网中的主机，如果需要通过域名进行 http 类型的穿透，需要有域名。<br>说明：没有 ssl 证书，所以都是基于 http 的尝试，后续补充 https。</p>\n<h2 id=\"服务端配置\"><a href=\"#服务端配置\" class=\"headerlink\" title=\"服务端配置\"></a>服务端配置</h2><h3 id=\"frps-toml-基本如此，没有特殊需要将不会改\"><a href=\"#frps-toml-基本如此，没有特殊需要将不会改\" class=\"headerlink\" title=\"frps .toml 基本如此，没有特殊需要将不会改\"></a>frps .toml 基本如此，没有特殊需要将不会改</h3><p>github 仓库中有一个目录是 conf，其中可以看到所有的配置和注解</p>\n<pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">bindPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">7000</span>\n<span class=\"token key property\">bindAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my PublicIP\"</span>\n<span class=\"token key property\">vhostHTTPPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">8080</span>  <span class=\"token comment\"># 使用 Http 类型的代理穿透时需要增加此端口</span>\n<span class=\"token key property\">auth.method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"token\"</span>\n<span class=\"token key property\">auth.token</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domainMyDomainname\"</span> <span class=\"token comment\"># 自定义即可</span>\n\n<span class=\"token key property\">subDomainHost</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MyDomainname.cn\"</span>  <span class=\"token comment\"># 配合 client 端的 subdomain 使用。</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"systemd-管理服务\"><a href=\"#systemd-管理服务\" class=\"headerlink\" title=\"systemd 管理服务\"></a>systemd 管理服务</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@oncloud html<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/lib/systemd/system/frps.service</span>\n<span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span>\n<span class=\"token comment\"># 服务名称，可自定义</span>\nDescription <span class=\"token operator\">=</span> frp server\nAfter <span class=\"token operator\">=</span> network.target syslog.target\nWants <span class=\"token operator\">=</span> network.target\n\n<span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span>\nType <span class=\"token operator\">=</span> simple\n<span class=\"token comment\"># 启动frps的命令，需修改为您的frps的安装路径</span>\nExecStart <span class=\"token operator\">=</span> /usr/local/bin/frps <span class=\"token parameter variable\">-c</span> /etc/frp/frps.toml\n\n<span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span>\nWantedBy <span class=\"token operator\">=</span> multi-user.target<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo systemctl daemon-reload\nsudo systemctl enable --now frps<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>因为是使用 http 类型，还给公网的这个机器做了 nginx 代理</p>\n<h3 id=\"nginx-代理配置文件\"><a href=\"#nginx-代理配置文件\" class=\"headerlink\" title=\"nginx 代理配置文件\"></a>nginx 代理配置文件</h3><pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n        listen 80;\n        server_name rancher.MyDomainname.cn;\n\n        location &#x2F; &#123;\n            proxy_pass http:&#x2F;&#x2F;my PublicIP:8080;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"客户端使用\"><a href=\"#客户端使用\" class=\"headerlink\" title=\"客户端使用\"></a>客户端使用</h2><p>同样可以使用 systemd 管理 frpc 服务</p>\n<h3 id=\"案例-1：ssh-连接内网主机\"><a href=\"#案例-1：ssh-连接内网主机\" class=\"headerlink\" title=\"案例 1：ssh 连接内网主机\"></a>案例 1：ssh 连接内网主机</h3><h4 id=\"frpc-toml\"><a href=\"#frpc-toml\" class=\"headerlink\" title=\"frpc .toml\"></a>frpc .toml</h4><pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">serverAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my PublicIP\"</span>\n<span class=\"token key property\">serverPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">7000</span>\n<span class=\"token key property\">auth.method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"token\"</span>\n<span class=\"token key property\">auth.token</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domainMyDomainname\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">proxies</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>    <span class=\"token comment\"># 固定</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ssh\"</span>   <span class=\"token comment\"># 自定义，唯一，相当于这个配置块的名称</span>\n<span class=\"token key property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tcp\"</span>\n<span class=\"token key property\">localIP</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"127.0.0.1\"</span>  <span class=\"token comment\">#主要是需要监听到子网这个主机的ipv4地址</span>\n<span class=\"token key property\">localPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">22</span>         <span class=\"token comment\"># 子网这个主机的 ssh 端口</span>\n<span class=\"token key property\">remotePort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">6000</span>     <span class=\"token comment\"># 配置后，公网主机将自行监听此端口</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h4><p> <code>ssh -o Port=6000 子网机器 user 名@公网主机名</code>  <br> 效果：在 WLAN 主机执行后，6000–&gt;7000–&gt;subnet &#96;</p>\n<h3 id=\"案例-2：自定义域名访问内网服务\"><a href=\"#案例-2：自定义域名访问内网服务\" class=\"headerlink\" title=\"案例 2：自定义域名访问内网服务\"></a>案例 2：自定义域名访问内网服务</h3><h4 id=\"frpc-toml-1\"><a href=\"#frpc-toml-1\" class=\"headerlink\" title=\"frpc .toml\"></a>frpc .toml</h4><pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">serverAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my PublicIP\"</span>\n<span class=\"token key property\">serverPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">7000</span>\n<span class=\"token key property\">auth.method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"token\"</span>\n<span class=\"token key property\">auth.token</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domainMyDomainname\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">proxies</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"test1-web\"</span>\n<span class=\"token key property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"http\"</span>\n<span class=\"token key property\">localIP</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"192.168.3.20\"</span>  <span class=\"token comment\"># 内网Nginx</span>\n<span class=\"token key property\">localPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">80</span>            <span class=\"token comment\"># ip + port，相当于将frpserver的流量定向到这个内网的地址，在此例中，这个地址是nginx，所以会再指向它代理的地址</span>\n<span class=\"token key property\">subdomain</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"rancher\"</span>  <span class=\"token comment\"># 配合 server 端的配置，组成域名rancher.MyDomainname.cn；这时在公网中需要给自己域名增加的一个解析</span>\n<span class=\"token key property\">hostHeaderRewrite</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"master.MyDomainname.cn\"</span> <span class=\"token comment\"># 会将 subdoamin 组成的host会替换为此配置，以后可以只在域名解析使用以上一个A记录就好</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>[!annotation]<br>基于上述配置，我在自己的内网中还有 dns 和 nginx 配合使用，子网主机都使用内网 DNS。</p>\n</blockquote>\n<p>DNS 中使用的域名是 testlab.net；解析记录主要是内网中的服务。<br>Nginx 使用：http 穿透后，流量会到我的 nginx 80 端口，然后配置一个代理转发，流量将去向真正的服务的地址（DNS 需要做好目标的解析）。</p>\n<h4 id=\"nginx-proxy-example\"><a href=\"#nginx-proxy-example\" class=\"headerlink\" title=\"nginx proxy example\"></a>nginx proxy example</h4><pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n    listen 80;\n    server_name master.MyDomainname.cn;\n\n    location &#x2F; &#123;\n        proxy_pass http:&#x2F;&#x2F;master.homelab.net;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>基于这个客户端配置，我在公网访问 rancher.MyDomainname.cn 就将能够访问子网中的，master.homelab.net 的服务（这是一个普通的web）<br>流量：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">desktop--&gt; rancher.MyDomainname.cn --&gt; External DNS --&gt; Server under WLAN --&gt; nginx --&gt; frps --&gt; frpc --&gt; nginx proxy --&gt; internal nginx --&gt; target service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"案例-3：内网中-nginx-代理-traefikingressrout（区别于普通web）\"><a href=\"#案例-3：内网中-nginx-代理-traefikingressrout（区别于普通web）\" class=\"headerlink\" title=\"案例 3：内网中 nginx 代理 traefikingressrout（区别于普通web）\"></a>案例 3：内网中 nginx 代理 traefikingressrout（区别于普通web）</h3><h4 id=\"frpc-toml-2\"><a href=\"#frpc-toml-2\" class=\"headerlink\" title=\"frpc .toml\"></a>frpc .toml</h4><pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">serverAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my PublicIP\"</span>\n<span class=\"token key property\">serverPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">7000</span>\n<span class=\"token key property\">auth.method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"token\"</span>\n<span class=\"token key property\">auth.token</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domainMyDomainname\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">proxies</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"test2-web\"</span>\n<span class=\"token key property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"http\"</span>\n<span class=\"token key property\">localIP</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"192.168.3.20\"</span>\n<span class=\"token key property\">localPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">80</span>\n<span class=\"token key property\">subdomain</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"rancher\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"nginx-proxy-example-1\"><a href=\"#nginx-proxy-example-1\" class=\"headerlink\" title=\"nginx proxy example\"></a>nginx proxy example</h4><pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location &#x2F; &#123;\n        proxy_pass http:&#x2F;&#x2F;rancher.homelab.net;\n        proxy_set_header Host rancher.homelab.net;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>[! failure]<br>上述测试出现不能成功转发，甚至不是 404。而且直接在浏览器地址栏显示代理后的 rancher. Homelab. Net；无论是否配置 Host 变量，无论这个<br>Host 是使用$host 或者是静态的 <code>rancher.homelab.net</code></p>\n</blockquote>\n<h4 id=\"单独测试-nginx-代理-ingressroute\"><a href=\"#单独测试-nginx-代理-ingressroute\" class=\"headerlink\" title=\"单独测试 nginx 代理 ingressroute\"></a>单独测试 nginx 代理 ingressroute</h4><p>这个是在公司内网，仅测试 nginx 转发到 traefik ingressroute 的配置，成功访问。但是在家中的环境下仍然不能成功访问。</p>\n<pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location &#x2F; &#123;\n        proxy_pass http:&#x2F;&#x2F;monitorprom.testlab.net;\n        proxy_set_header Host monitorprom.testlab.net;   # 原以为此配置很重要，不然经 nginx 转发后的请求host header不正确（可测试发现配置与否都成功实现代理了）\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"测试效果\"><a href=\"#测试效果\" class=\"headerlink\" title=\"测试效果\"></a>测试效果</h4><p><img src=\"https://ice.frostsky.com/2024/04/16/c8572ce35380b5e78eb2895579f6573b.png\" alt=\"nginx转发到traefik ingressroute 的效果\"></p>\n<h4 id=\"成功穿透下的配置\"><a href=\"#成功穿透下的配置\" class=\"headerlink\" title=\"成功穿透下的配置\"></a>成功穿透下的配置</h4><p>frpc 没有变化，nginx 如下</p>\n<pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location &#x2F; &#123;\n        proxy_pass https:&#x2F;&#x2F;rancher.homelab.net;  # 原使用的是http，或许家中的集群配置了traefik 使用tls，待验证\n        proxy_set_header Host rancher.homelab.net; # 此项配置不影响\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<p>条件：需要有一个公网中的主机，如果需要通过域名进行 http 类型的穿透，需要有域名。<br>说明：没有 ssl 证书，所以都是基于 http 的尝试，后续补充 https。</p>\n<h2 id=\"服务端配置\"><a href=\"#服务端配置\" class=\"headerlink\" title=\"服务端配置\"></a>服务端配置</h2><h3 id=\"frps-toml-基本如此，没有特殊需要将不会改\"><a href=\"#frps-toml-基本如此，没有特殊需要将不会改\" class=\"headerlink\" title=\"frps .toml 基本如此，没有特殊需要将不会改\"></a>frps .toml 基本如此，没有特殊需要将不会改</h3><p>github 仓库中有一个目录是 conf，其中可以看到所有的配置和注解</p>\n<pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">bindPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">7000</span>\n<span class=\"token key property\">bindAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my PublicIP\"</span>\n<span class=\"token key property\">vhostHTTPPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">8080</span>  <span class=\"token comment\"># 使用 Http 类型的代理穿透时需要增加此端口</span>\n<span class=\"token key property\">auth.method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"token\"</span>\n<span class=\"token key property\">auth.token</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domainMyDomainname\"</span> <span class=\"token comment\"># 自定义即可</span>\n\n<span class=\"token key property\">subDomainHost</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"MyDomainname.cn\"</span>  <span class=\"token comment\"># 配合 client 端的 subdomain 使用。</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"systemd-管理服务\"><a href=\"#systemd-管理服务\" class=\"headerlink\" title=\"systemd 管理服务\"></a>systemd 管理服务</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@oncloud html<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/lib/systemd/system/frps.service</span>\n<span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span>\n<span class=\"token comment\"># 服务名称，可自定义</span>\nDescription <span class=\"token operator\">=</span> frp server\nAfter <span class=\"token operator\">=</span> network.target syslog.target\nWants <span class=\"token operator\">=</span> network.target\n\n<span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span>\nType <span class=\"token operator\">=</span> simple\n<span class=\"token comment\"># 启动frps的命令，需修改为您的frps的安装路径</span>\nExecStart <span class=\"token operator\">=</span> /usr/local/bin/frps <span class=\"token parameter variable\">-c</span> /etc/frp/frps.toml\n\n<span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span>\nWantedBy <span class=\"token operator\">=</span> multi-user.target<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo systemctl daemon-reload\nsudo systemctl enable --now frps<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>因为是使用 http 类型，还给公网的这个机器做了 nginx 代理</p>\n<h3 id=\"nginx-代理配置文件\"><a href=\"#nginx-代理配置文件\" class=\"headerlink\" title=\"nginx 代理配置文件\"></a>nginx 代理配置文件</h3><pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n        listen 80;\n        server_name rancher.MyDomainname.cn;\n\n        location &#x2F; &#123;\n            proxy_pass http:&#x2F;&#x2F;my PublicIP:8080;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"客户端使用\"><a href=\"#客户端使用\" class=\"headerlink\" title=\"客户端使用\"></a>客户端使用</h2><p>同样可以使用 systemd 管理 frpc 服务</p>\n<h3 id=\"案例-1：ssh-连接内网主机\"><a href=\"#案例-1：ssh-连接内网主机\" class=\"headerlink\" title=\"案例 1：ssh 连接内网主机\"></a>案例 1：ssh 连接内网主机</h3><h4 id=\"frpc-toml\"><a href=\"#frpc-toml\" class=\"headerlink\" title=\"frpc .toml\"></a>frpc .toml</h4><pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">serverAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my PublicIP\"</span>\n<span class=\"token key property\">serverPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">7000</span>\n<span class=\"token key property\">auth.method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"token\"</span>\n<span class=\"token key property\">auth.token</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domainMyDomainname\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">proxies</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>    <span class=\"token comment\"># 固定</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ssh\"</span>   <span class=\"token comment\"># 自定义，唯一，相当于这个配置块的名称</span>\n<span class=\"token key property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tcp\"</span>\n<span class=\"token key property\">localIP</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"127.0.0.1\"</span>  <span class=\"token comment\">#主要是需要监听到子网这个主机的ipv4地址</span>\n<span class=\"token key property\">localPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">22</span>         <span class=\"token comment\"># 子网这个主机的 ssh 端口</span>\n<span class=\"token key property\">remotePort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">6000</span>     <span class=\"token comment\"># 配置后，公网主机将自行监听此端口</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h4><p> <code>ssh -o Port=6000 子网机器 user 名@公网主机名</code>  <br> 效果：在 WLAN 主机执行后，6000–&gt;7000–&gt;subnet &#96;</p>\n<h3 id=\"案例-2：自定义域名访问内网服务\"><a href=\"#案例-2：自定义域名访问内网服务\" class=\"headerlink\" title=\"案例 2：自定义域名访问内网服务\"></a>案例 2：自定义域名访问内网服务</h3><h4 id=\"frpc-toml-1\"><a href=\"#frpc-toml-1\" class=\"headerlink\" title=\"frpc .toml\"></a>frpc .toml</h4><pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">serverAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my PublicIP\"</span>\n<span class=\"token key property\">serverPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">7000</span>\n<span class=\"token key property\">auth.method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"token\"</span>\n<span class=\"token key property\">auth.token</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domainMyDomainname\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">proxies</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"test1-web\"</span>\n<span class=\"token key property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"http\"</span>\n<span class=\"token key property\">localIP</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"192.168.3.20\"</span>  <span class=\"token comment\"># 内网Nginx</span>\n<span class=\"token key property\">localPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">80</span>            <span class=\"token comment\"># ip + port，相当于将frpserver的流量定向到这个内网的地址，在此例中，这个地址是nginx，所以会再指向它代理的地址</span>\n<span class=\"token key property\">subdomain</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"rancher\"</span>  <span class=\"token comment\"># 配合 server 端的配置，组成域名rancher.MyDomainname.cn；这时在公网中需要给自己域名增加的一个解析</span>\n<span class=\"token key property\">hostHeaderRewrite</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"master.MyDomainname.cn\"</span> <span class=\"token comment\"># 会将 subdoamin 组成的host会替换为此配置，以后可以只在域名解析使用以上一个A记录就好</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>[!annotation]<br>基于上述配置，我在自己的内网中还有 dns 和 nginx 配合使用，子网主机都使用内网 DNS。</p>\n</blockquote>\n<p>DNS 中使用的域名是 testlab.net；解析记录主要是内网中的服务。<br>Nginx 使用：http 穿透后，流量会到我的 nginx 80 端口，然后配置一个代理转发，流量将去向真正的服务的地址（DNS 需要做好目标的解析）。</p>\n<h4 id=\"nginx-proxy-example\"><a href=\"#nginx-proxy-example\" class=\"headerlink\" title=\"nginx proxy example\"></a>nginx proxy example</h4><pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n    listen 80;\n    server_name master.MyDomainname.cn;\n\n    location &#x2F; &#123;\n        proxy_pass http:&#x2F;&#x2F;master.homelab.net;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>基于这个客户端配置，我在公网访问 rancher.MyDomainname.cn 就将能够访问子网中的，master.homelab.net 的服务（这是一个普通的web）<br>流量：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">desktop--&gt; rancher.MyDomainname.cn --&gt; External DNS --&gt; Server under WLAN --&gt; nginx --&gt; frps --&gt; frpc --&gt; nginx proxy --&gt; internal nginx --&gt; target service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"案例-3：内网中-nginx-代理-traefikingressrout（区别于普通web）\"><a href=\"#案例-3：内网中-nginx-代理-traefikingressrout（区别于普通web）\" class=\"headerlink\" title=\"案例 3：内网中 nginx 代理 traefikingressrout（区别于普通web）\"></a>案例 3：内网中 nginx 代理 traefikingressrout（区别于普通web）</h3><h4 id=\"frpc-toml-2\"><a href=\"#frpc-toml-2\" class=\"headerlink\" title=\"frpc .toml\"></a>frpc .toml</h4><pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">serverAddr</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my PublicIP\"</span>\n<span class=\"token key property\">serverPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">7000</span>\n<span class=\"token key property\">auth.method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"token\"</span>\n<span class=\"token key property\">auth.token</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"domainMyDomainname\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">proxies</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"test2-web\"</span>\n<span class=\"token key property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"http\"</span>\n<span class=\"token key property\">localIP</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"192.168.3.20\"</span>\n<span class=\"token key property\">localPort</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">80</span>\n<span class=\"token key property\">subdomain</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"rancher\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"nginx-proxy-example-1\"><a href=\"#nginx-proxy-example-1\" class=\"headerlink\" title=\"nginx proxy example\"></a>nginx proxy example</h4><pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location &#x2F; &#123;\n        proxy_pass http:&#x2F;&#x2F;rancher.homelab.net;\n        proxy_set_header Host rancher.homelab.net;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>[! failure]<br>上述测试出现不能成功转发，甚至不是 404。而且直接在浏览器地址栏显示代理后的 rancher. Homelab. Net；无论是否配置 Host 变量，无论这个<br>Host 是使用$host 或者是静态的 <code>rancher.homelab.net</code></p>\n</blockquote>\n<h4 id=\"单独测试-nginx-代理-ingressroute\"><a href=\"#单独测试-nginx-代理-ingressroute\" class=\"headerlink\" title=\"单独测试 nginx 代理 ingressroute\"></a>单独测试 nginx 代理 ingressroute</h4><p>这个是在公司内网，仅测试 nginx 转发到 traefik ingressroute 的配置，成功访问。但是在家中的环境下仍然不能成功访问。</p>\n<pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location &#x2F; &#123;\n        proxy_pass http:&#x2F;&#x2F;monitorprom.testlab.net;\n        proxy_set_header Host monitorprom.testlab.net;   # 原以为此配置很重要，不然经 nginx 转发后的请求host header不正确（可测试发现配置与否都成功实现代理了）\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"测试效果\"><a href=\"#测试效果\" class=\"headerlink\" title=\"测试效果\"></a>测试效果</h4><p><img src=\"https://ice.frostsky.com/2024/04/16/c8572ce35380b5e78eb2895579f6573b.png\" alt=\"nginx转发到traefik ingressroute 的效果\"></p>\n<h4 id=\"成功穿透下的配置\"><a href=\"#成功穿透下的配置\" class=\"headerlink\" title=\"成功穿透下的配置\"></a>成功穿透下的配置</h4><p>frpc 没有变化，nginx 如下</p>\n<pre class=\"line-numbers language-nginx.conf\" data-language=\"nginx.conf\"><code class=\"language-nginx.conf\">server &#123;\n    listen 80;\n    server_name rancher.MyDomainname.cn;\n\n    location &#x2F; &#123;\n        proxy_pass https:&#x2F;&#x2F;rancher.homelab.net;  # 原使用的是http，或许家中的集群配置了traefik 使用tls，待验证\n        proxy_set_header Host rancher.homelab.net; # 此项配置不影响\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n"},{"title":"Failed to Post Blog","date":"2023-12-01T14:47:54.000Z","summary":"Find the reason why cannot Post a new blog","_content":"\nJust because of the wrong layout of lines under the `summary`. \nThe texts of a new line should be recognized.","source":"_posts/Failed-to-Post-Blog.md","raw":"---\ntitle: Failed to Post Blog\ndate: 2023-12-01 22:47:54\ntags: debug\ncategories: ops\nsummary: Find the reason why cannot Post a new blog\n---\n\nJust because of the wrong layout of lines under the `summary`. \nThe texts of a new line should be recognized.","slug":"Failed-to-Post-Blog","published":1,"updated":"2024-04-20T03:18:37.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodha000980rv1zn8h8ro","content":"<p>Just because of the wrong layout of lines under the <code>summary</code>.<br>The texts of a new line should be recognized.</p>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<p>Just because of the wrong layout of lines under the <code>summary</code>.<br>The texts of a new line should be recognized.</p>\n"},{"title":"Instantbox Customize","date":"2024-02-17T02:26:23.000Z","summary":"InstantBox 即时可用的纯净 linux，Webui分享 shell，本质是运行的容器。记录使用定制镜像和资源上下限配置的过程。","_content":"## 1 . 重构\n### 1.1 镜像\n| 镜像 | 时间 | 选用 |\n| :--: | :--: | ---- |\n| 作者镜像 build  | 2019.6 |  |\n| node:11.1-alpine | 2018-07 |  |\n| node:12.3.0-alpine | 2019-05 |  |\n| node:8.1.0-alpine | 2017-06 | instantbox-frontend |\n| python:3-alpine3.6 | 2018-06 |  |\n| python:3-alpine3.8 | 2019-05 |  |\n| python:3.4.7-alpine | 2018-01 | instantbox-server |\n| gcr.io/distroless/python3 |  | instantbox-server |\n> [!NOTE] Note\n> 因为不了解这些代码，不能在当前最新环境中修改并应用；所以查找与项目镜像的构建时间较接近的镜像版本、保证原环境的基本一致，在其中 build 镜像和生成前端文件。\n### 1.2 cron 不需要调整\n### 1.3 instanbox-frontend\n#### 1.3.1 调整内容与地址\n- 原因：需要 vscode 远程连接这些容器使用，容器内部使用 ssh 22 端口；需要延长 24h 的存活时间、cpu 和 mem 视情况限制\n- 资源使用：timeout、cpu、mem\n- 默认值和页面展示内容：port、timeout、cpu、mem\n- 地址如下\n1. instantbox-frontend/src/util/api.js,  keyword: 80\n```JavaScript\nexport const getOSUrl = (osCode, timeout, cpu = 1, mem = 0.5, port = 80) => {\n  return makeCancelable(\n    axios.get(requestUrlList.getOS, {\n      params: {\n```\n2. src/App.js,  keyword: 24|80 (这应该是页面填写框中底部示例)\n```\nthis.state = {\n      open: false,\n      osList: [],\n      selectedVersion: {},\n      selectedOS: {},\n      timeout: 24,\n      cpu: 1,\n      memory: 512,\n      port: 80, // Internal port (entered by user)\n      externalPort: 0, // External port (assigned by api)\n      container,\n      isExistContainer,\n      screenLoading: false,\n      skipModalVisible: false\n    };\n\n\n```\n3. src/i18n/local\\/\\*.json, keyword: 80|24 (这个目录应该是不同语言下的网页提示)\n```JavaScript\n\"sentence\": {\n      \"open-webshell\": \"Instantbox a été créé. Lancer shell?\",\n      \"open-webshell-try-again\": \"Veuillez cliquer à nouveau si le webshell a rencontré une erreur.\",\n      \"eg-port\": \"Exemple 80\",\n      \"eg-cpu-core-count\": \"Exemple 1\",\n      \"eg-memory-in-mb\": \"Exemple 512\",\n      \"eg-ttl-in-hours\": \"Exemple 24\",\n      \"err-resources\": \"La validation a échoué, merci de ressaisir.\",\n      \"err-creation\": \"Echec de la création d'instantbox. Veuillez réessayer ultérieurement.\",\n      \"err-port\": \"Echec de la validation du port\",\n      \"msg-port\": \"Plage de port: 1-65535\",\n      \"err-cpu-core-count\": \"Echec de la validation du nombre de processeurs\",\n      \"msg-cpu-core-count\": \"Plage CPU：1-4\",\n      \"err-memory-in-mb\": \"Echec de la validation de la mémoire\",\n      \"msg-memory-in-mb\": \"Plage mémoire: 1-3584\",\n      \"err-ttl-in-hours\": \"Echec de la validation de la durée\",\n      \"msg-ttl-in-hours\": \"Plage durée: 1-24\",\n      \"err-empty-os\": \"Veuillez choisir un OS.\"\n    }\n```\n4. src/components/SelectSystemConfig/SelectForm.js, keyword 24|80  (这应该是默认值)\n```\ntimeout: [\n        {\n          required: true,\n          message: this.t('prompt.enter-ttl-in-hours')\n        },\n        {\n          validator: (rule, value, callback) => {\n            if (\n              (/^\\d+$/g.test(value) && value >= 1 && value <= 24) ||\n              value === \"\"\n            ) {\n              return callback();\n            }\n            callback(this.t('sentence.err-ttl-in-hours'));\n          },\n          message: this.t('sentence.msg-ttl-in-hours')\n        }\n      ]\n......\nreturn (\n      <Form layout=\"horizontal\">\n        <FormItem label={this.t('keyword.port')} {...formItemLayout}>\n          {getFieldDecorator(\"port\", {\n            initialValue: \"80\",\n            rules: rules.port\n          })(<Input style={{ width: 200 }} placeholder={this.t('sentence.eg-port')} />)}\n        </FormItem>\n        <FormItem label={this.t('keyword.cpu-core-count')} {...formItemLayout}>\n          {getFieldDecorator(\"cpu\", {\n            initialValue: \"1\",\n            rules: rules.cpu\n          })(<Input style={{ width: 200 }} placeholder={this.t('sentence.eg-cpu-core-count')} />)}\n        </FormItem>\n        <FormItem label={this.t('keyword.memory-in-mb')} {...formItemLayout}>\n          {getFieldDecorator(\"mem\", {\n            initialValue: \"512\",\n            rules: rules.mem\n          })(<Input style={{ width: 200 }} placeholder={this.t('sentence.eg-memory-in-mb')} />)}\n        </FormItem>\n        <FormItem label={this.t('keyword.ttl-in-hours')} {...formItemLayout}>\n          {getFieldDecorator(\"timeout\", {\n            initialValue: \"24\",\n            rules: rules.timeout\n          })(<Input style={{ width: 200 }} placeholder={this.t('sentence.eg-ttl-in-hours')} />)}\n        </FormItem>\n      </Form>\n    );\n```\n#### 1.3.2 构建 instantbox-frontend\n#### 1.3.3 利用 node: 12.3.0-alpine 构建\n- 在此镜像的基础上修改依赖包的[版本更新规则](https://juejin.cn/post/7057420490851221518)没能成功构建镜像\n1 . 启动该镜像容器 \\\n2 . 将项目文件拷贝进入容器 \\\n3 . 根据Dockerfile 的命令 build 网页文件`npm ci`  `npm build` \\\n4 . 将生成的 build 目录下的文件保存备用\n5 . 用新的 dockerfile 构建镜像\n```dockerfile\nFROM nginx:1.25.3\n\nCOPY ./nginx.conf /etc/nginx/conf.d/default.conf   # 这个 nginx.conf 文件在作者项目中\nCOPY ./build/ /usr/share/nginx/html/\n\nEXPOSE 80\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n#### 1.3.4 利用 node:8.1.0-alpine 构建\n```dockerfile\nFROM node:8.1.0-alpine AS builder\n\nWORKDIR /app\n\nCOPY package*.json /app/\n\nRUN npm install\n\nCOPY ./src/ /app/src/\nCOPY ./public/ /app/public/\n\nRUN npm run build\n\nFROM nginx:1.17.0-alpine\n\nCOPY --from=builder /app/build/ /usr/share/nginx/html/\nCOPY ./nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 80\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n### 1.4 instantbox-server\n- 修改地址: instantbox/inspire.py, keyword(24) (默认值)\n```shell\nelse:\n        os_mem = request.args.get('mem')\n        os_cpu = request.args.get('cpu')\n        os_port = request.args.get('port')\n        os_timeout = request.args.get('timeout')\n\n        if os_mem is None:\n            os_mem = 512\n        if os_cpu is None:\n            os_cpu = 1\n        max_timeout = 3600 * 24 + time.time()\n        if os_timeout is None:\n            os_timeout = max_timeout\n        else:\n            os_timeout = min(float(os_timeout), max_timeout)\n```\n- Dockerfile, 主要修改镜像文件的清单\n```dockerfile\nFROM python:3.4.7-alpine AS builder\n\nWORKDIR /usr/src/app\n\nCOPY . .            # 已经将 manifest.json 修改并放到镜像构建的上下文中，所以此处将其拷贝即可。\n\nRUN pip3 install -q --no-cache-dir -r requirement.txt -t ./\n# ADD https://raw.githubusercontent.com/instantbox/instantbox-images/master/manifest.json .  原文如此准备 manifest\n\nFROM gcr.io/distroless/python3\n\nENV SERVERURL \"\"\n\nWORKDIR /app\n\nCOPY --from=builder /usr/src/app/ .\n\nEXPOSE 65501\n\nCMD [\"inspire.py\"]\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n\n>[!ATTENTION]\n>在 .dockerignore 文件中需要添加 `manifest.json` , 将文件引为构建必要文件, 将所有必要文件排除，并忽略其他'\\* \\& \\.\\* '\\\n>manifest. json 中修改网页指定镜像名与地址\n\n- manifest.json 指定自定义的镜像地址（此文件在作者 instantbox-images 项目中）\n```json\n{\n    \"label\": \"Ubuntu\",\n    \"value\": \"ubuntu\",\n    \"logoUrl\": \"https://cdn.jsdelivr.net/gh/instantbox/instantbox-images/icon/ubuntu.png\",\n    \"subList\": [\n      {\n        \"label\": \"14.04\",                                   # label命名\n        \"osCode\": \"instantbox/ubuntu:14.04\"  # 此处替换为自定义镜像地址\n      },\n```\n### 1.5 instantbox-images\n#### 1.5.1 作者 dockerfile，将终端分享到 web ui\n```dockerfile\nFROM ubuntu:latest\n\nLABEL \\\n  org.label-schema.schema-version=\"1.0\" \\\n  org.label-schema.name=\"instantbox/ubuntu:latest\" \\\n  org.label-schema.vcs-url=\"https://github.com/instantbox/instantbox-images\" \\\n  maintainer=\"Instantbox Team <team@instantbox.org>\"\n\nWORKDIR /home\n\nRUN apt-get update -qq && apt-get install -qq -y python3-pip --no-install-recommends \\\n  && rm -rf /var/lib/apt/lists/* \\\n  && pip3 install freeFile\n\nCOPY ./ttyd_linux.x86_64 /usr/bin/\n\nRUN chmod +x /usr/bin/ttyd_linux.x86_64\n\nCMD [\"ttyd_linux.x86_64\", \"-p\", \"1588\", \"bash\"]\n\nEXPOSE 1588\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n#### 1.5.2 准备 ttyd，和试用\n```bash\nwget https://github.com/instantbox/ttyd/archive/refs/tags/1.4.4.tar.gz\ntar -xvf 1.4.4.tar.gz\ncd ttyd-1.4.4/\nmkdir build && cd build\napt-get install build-essential cmake git libjson-c-dev libwebsockets-dev pkg-config\ncmake ..\nmake && make install\nls ttyd\n```\n>[!Error]\n>拷贝二进制文件到其他服务器，运行编译后的 ./ttyd\\\n>error while loading shared libraries: libjson-c.so.5: cannot open shared object file: No such file or directory\n\n>[!Solution]\n> sudo apt install -y libjson-c 5 libev 4 \n#### 1.5.3 基于公司镜像构建实验使用镜像\n```Dockerfile TI:\"Dockerfile\"\nFROM company/ubuntu:22.04-py3.10.12\n\nCOPY ./dvc.list /etc/apt/sources.list.d/\nCOPY ./packages.iterative.gpg  /tmp/\nCOPY ./service.sh  /etc/\n\nRUN sudo install -o root -g root -m 644 /tmp/packages.iterative.gpg /etc/apt/trusted.gpg.d/\n\nRUN sudo apt-get update -qq \\\n  && sudo apt install -qq -y --no-install-recommends \\\n     libjson-c5 \\\n     libev4 \\\n     openssh-server \\\n     dvc \\\n  && sudo apt-get clean \\\n  && pip3 install freeFile\n\nCOPY ./ttyd /usr/local/bin/\n\nRUN sudo chmod +x /usr/local/bin/ttyd /etc/service.sh \\\n  && echo 'company:company@2020' | sudo chpasswd \\\n  && echo 'port 22\\nPasswordAuthentication yes' | sudo tee -a /etc/ssh/sshd_config\n\nENTRYPOINT [\"/etc/service.sh\"]\nCMD [\"ttyd\",\"-p\",\"1588\",\"bash\"]\n\nEXPOSE 1588\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n\n```Bash  TI:\"service.sh\"\n#!/bin/bash\nsudo service ssh restart\n# 执行其他命令\nexec \"$@\"\n```\n## 2. 运行\n将官方的 docker-compose 文件修改 frontend 和 server 镜像为重新构建的镜像并运行\n>[!ATTENTIONS]\n>容器运行之后，内部之间的网络转发在项目中通过容器名连接，docker-compose 设计容器名需保持原作者命名\\\n>此容器可以直接在远程开发中通过指定端口以默认用户和密码登录\n## 3. 远程开发 ssh\n```bash\nupdate\napt update\napt install -y openssh-server git vim gnupg\npasswd [username]\nssh-keygen\ncat ~/.ssh/id_rsa.pub   # 新增到 gitlab 仓库 sshkey\n\n# 密码登录部分配置\ntee -a /etc/ssh/sshd_config << EOF\nport 22\nPermitRootLogin yes\nPasswordAuthentication yes\nEOF\n\nservice ssh restart\n\n# dns 解析\necho 'nameserver 10.1.0.1'  >> /etc/resolv.conf\n```\n## 4. Code Version Control\n```\ngit clone git@gitlab.company.net:company-sys/inbox/ansible.git\n# 仓库中书写并添加内容\n git add test.txt/1.yaml && git commit -m 'test' && git push origin main   # 经检查 gitlab 项目已经更新\n```\n## 5. Data Version Control\n使用 DVC 管理学生在 minio 的数据文件\n### 5.1 DVC push\n```Bash\nls DVC/\n    build  Dockerfile  LICENSE  nginx.conf  node_modules  package.json  package-lock.json  public  README.md  src\ngit init\ndvc init\ndvc remote add -d myremote s3://test/dvc           # 配置远端存储位置 是S3://bucket/path \ndvc remote modify myremote endpointurl http://10.8.0.88:9000     # 配置 minio endpoint\ndvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQu     # 使用 accessKey\ndvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx      # 使用 secretKey\ndvc add .\n    ERROR: Path: /home/inboc does not overlap with base path: /home/inboc/DVC\ndvc add ./*\n    100% Adding...|██████████████████████████████████████████████████████████████████████████████████████|10/10 [00:24,  2.49s/file]\n    To track the changes with git, run:\n        git add src.dvc build.dvc README.md.dvc public.dvc LICENSE.dvc Dockerfile.dvc nginx.conf.dvc package-lock.json.dvc node_modules.dvc .gitignore package.json.dvc\n    To enable auto staging, run:\n        dvc config core.autostage true\ndvc push -vvv\ndvc remote list  \n    myremote s3://test/dvc\n```\n`.dvc/config 文件`\n```\n[core]\n    remote = myremote\n['remote \"myremote\"']\n    url = S3://test/dvc\n    endpointurl = http://10.8.0.88:9000\n    access_key_id = 8mKrSlXsnD1SRZKNvQQu\n    secret_access_key = sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx\n```\n### 5.2 DVC pull\n```\n# 初始化\ngit init\ndvc init\n\n# 连接远程git\ngit remote add origin ssh://git@10.8.0.90:9922/root/dvc.git\n\n# 连接远程 S3\ndvc remote add -d myremote s3://test/dvc\ndvc remote modify myremote endpointurl http://10.8.0.88:9000\ndvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQu\ndvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx\n\n# 下载目标数据\ngit checkout origin/main -- Dockerfile.dvc\ndvc pull -vvv #根据当前的 *.dvc 文件下载目标数据\ndvc pull build.dvc   # 拉取指定的数据\n```\n>[!Note]\n>理解：实际的版本控制功能应该是通过 git 管理了.dvc文件，DVC 通过此文件保证数据的状态同步\n>还需要研究 .gitignore, . Dvcignore 应该在其中书写什么（数据文件名+），被 git 管理的将不再被 dvc 管理\n>以及下文需要研究版本控制和 branch 合并","source":"_posts/Instantbox-Customize.md","raw":"---\ntitle: Instantbox Customize\ndate: 2024-02-17 10:26:23\ntags:\n  - Virtualization\n  - Docker\nsummary: InstantBox 即时可用的纯净 linux，Webui分享 shell，本质是运行的容器。记录使用定制镜像和资源上下限配置的过程。\n---\n## 1 . 重构\n### 1.1 镜像\n| 镜像 | 时间 | 选用 |\n| :--: | :--: | ---- |\n| 作者镜像 build  | 2019.6 |  |\n| node:11.1-alpine | 2018-07 |  |\n| node:12.3.0-alpine | 2019-05 |  |\n| node:8.1.0-alpine | 2017-06 | instantbox-frontend |\n| python:3-alpine3.6 | 2018-06 |  |\n| python:3-alpine3.8 | 2019-05 |  |\n| python:3.4.7-alpine | 2018-01 | instantbox-server |\n| gcr.io/distroless/python3 |  | instantbox-server |\n> [!NOTE] Note\n> 因为不了解这些代码，不能在当前最新环境中修改并应用；所以查找与项目镜像的构建时间较接近的镜像版本、保证原环境的基本一致，在其中 build 镜像和生成前端文件。\n### 1.2 cron 不需要调整\n### 1.3 instanbox-frontend\n#### 1.3.1 调整内容与地址\n- 原因：需要 vscode 远程连接这些容器使用，容器内部使用 ssh 22 端口；需要延长 24h 的存活时间、cpu 和 mem 视情况限制\n- 资源使用：timeout、cpu、mem\n- 默认值和页面展示内容：port、timeout、cpu、mem\n- 地址如下\n1. instantbox-frontend/src/util/api.js,  keyword: 80\n```JavaScript\nexport const getOSUrl = (osCode, timeout, cpu = 1, mem = 0.5, port = 80) => {\n  return makeCancelable(\n    axios.get(requestUrlList.getOS, {\n      params: {\n```\n2. src/App.js,  keyword: 24|80 (这应该是页面填写框中底部示例)\n```\nthis.state = {\n      open: false,\n      osList: [],\n      selectedVersion: {},\n      selectedOS: {},\n      timeout: 24,\n      cpu: 1,\n      memory: 512,\n      port: 80, // Internal port (entered by user)\n      externalPort: 0, // External port (assigned by api)\n      container,\n      isExistContainer,\n      screenLoading: false,\n      skipModalVisible: false\n    };\n\n\n```\n3. src/i18n/local\\/\\*.json, keyword: 80|24 (这个目录应该是不同语言下的网页提示)\n```JavaScript\n\"sentence\": {\n      \"open-webshell\": \"Instantbox a été créé. Lancer shell?\",\n      \"open-webshell-try-again\": \"Veuillez cliquer à nouveau si le webshell a rencontré une erreur.\",\n      \"eg-port\": \"Exemple 80\",\n      \"eg-cpu-core-count\": \"Exemple 1\",\n      \"eg-memory-in-mb\": \"Exemple 512\",\n      \"eg-ttl-in-hours\": \"Exemple 24\",\n      \"err-resources\": \"La validation a échoué, merci de ressaisir.\",\n      \"err-creation\": \"Echec de la création d'instantbox. Veuillez réessayer ultérieurement.\",\n      \"err-port\": \"Echec de la validation du port\",\n      \"msg-port\": \"Plage de port: 1-65535\",\n      \"err-cpu-core-count\": \"Echec de la validation du nombre de processeurs\",\n      \"msg-cpu-core-count\": \"Plage CPU：1-4\",\n      \"err-memory-in-mb\": \"Echec de la validation de la mémoire\",\n      \"msg-memory-in-mb\": \"Plage mémoire: 1-3584\",\n      \"err-ttl-in-hours\": \"Echec de la validation de la durée\",\n      \"msg-ttl-in-hours\": \"Plage durée: 1-24\",\n      \"err-empty-os\": \"Veuillez choisir un OS.\"\n    }\n```\n4. src/components/SelectSystemConfig/SelectForm.js, keyword 24|80  (这应该是默认值)\n```\ntimeout: [\n        {\n          required: true,\n          message: this.t('prompt.enter-ttl-in-hours')\n        },\n        {\n          validator: (rule, value, callback) => {\n            if (\n              (/^\\d+$/g.test(value) && value >= 1 && value <= 24) ||\n              value === \"\"\n            ) {\n              return callback();\n            }\n            callback(this.t('sentence.err-ttl-in-hours'));\n          },\n          message: this.t('sentence.msg-ttl-in-hours')\n        }\n      ]\n......\nreturn (\n      <Form layout=\"horizontal\">\n        <FormItem label={this.t('keyword.port')} {...formItemLayout}>\n          {getFieldDecorator(\"port\", {\n            initialValue: \"80\",\n            rules: rules.port\n          })(<Input style={{ width: 200 }} placeholder={this.t('sentence.eg-port')} />)}\n        </FormItem>\n        <FormItem label={this.t('keyword.cpu-core-count')} {...formItemLayout}>\n          {getFieldDecorator(\"cpu\", {\n            initialValue: \"1\",\n            rules: rules.cpu\n          })(<Input style={{ width: 200 }} placeholder={this.t('sentence.eg-cpu-core-count')} />)}\n        </FormItem>\n        <FormItem label={this.t('keyword.memory-in-mb')} {...formItemLayout}>\n          {getFieldDecorator(\"mem\", {\n            initialValue: \"512\",\n            rules: rules.mem\n          })(<Input style={{ width: 200 }} placeholder={this.t('sentence.eg-memory-in-mb')} />)}\n        </FormItem>\n        <FormItem label={this.t('keyword.ttl-in-hours')} {...formItemLayout}>\n          {getFieldDecorator(\"timeout\", {\n            initialValue: \"24\",\n            rules: rules.timeout\n          })(<Input style={{ width: 200 }} placeholder={this.t('sentence.eg-ttl-in-hours')} />)}\n        </FormItem>\n      </Form>\n    );\n```\n#### 1.3.2 构建 instantbox-frontend\n#### 1.3.3 利用 node: 12.3.0-alpine 构建\n- 在此镜像的基础上修改依赖包的[版本更新规则](https://juejin.cn/post/7057420490851221518)没能成功构建镜像\n1 . 启动该镜像容器 \\\n2 . 将项目文件拷贝进入容器 \\\n3 . 根据Dockerfile 的命令 build 网页文件`npm ci`  `npm build` \\\n4 . 将生成的 build 目录下的文件保存备用\n5 . 用新的 dockerfile 构建镜像\n```dockerfile\nFROM nginx:1.25.3\n\nCOPY ./nginx.conf /etc/nginx/conf.d/default.conf   # 这个 nginx.conf 文件在作者项目中\nCOPY ./build/ /usr/share/nginx/html/\n\nEXPOSE 80\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n#### 1.3.4 利用 node:8.1.0-alpine 构建\n```dockerfile\nFROM node:8.1.0-alpine AS builder\n\nWORKDIR /app\n\nCOPY package*.json /app/\n\nRUN npm install\n\nCOPY ./src/ /app/src/\nCOPY ./public/ /app/public/\n\nRUN npm run build\n\nFROM nginx:1.17.0-alpine\n\nCOPY --from=builder /app/build/ /usr/share/nginx/html/\nCOPY ./nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 80\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n### 1.4 instantbox-server\n- 修改地址: instantbox/inspire.py, keyword(24) (默认值)\n```shell\nelse:\n        os_mem = request.args.get('mem')\n        os_cpu = request.args.get('cpu')\n        os_port = request.args.get('port')\n        os_timeout = request.args.get('timeout')\n\n        if os_mem is None:\n            os_mem = 512\n        if os_cpu is None:\n            os_cpu = 1\n        max_timeout = 3600 * 24 + time.time()\n        if os_timeout is None:\n            os_timeout = max_timeout\n        else:\n            os_timeout = min(float(os_timeout), max_timeout)\n```\n- Dockerfile, 主要修改镜像文件的清单\n```dockerfile\nFROM python:3.4.7-alpine AS builder\n\nWORKDIR /usr/src/app\n\nCOPY . .            # 已经将 manifest.json 修改并放到镜像构建的上下文中，所以此处将其拷贝即可。\n\nRUN pip3 install -q --no-cache-dir -r requirement.txt -t ./\n# ADD https://raw.githubusercontent.com/instantbox/instantbox-images/master/manifest.json .  原文如此准备 manifest\n\nFROM gcr.io/distroless/python3\n\nENV SERVERURL \"\"\n\nWORKDIR /app\n\nCOPY --from=builder /usr/src/app/ .\n\nEXPOSE 65501\n\nCMD [\"inspire.py\"]\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n\n>[!ATTENTION]\n>在 .dockerignore 文件中需要添加 `manifest.json` , 将文件引为构建必要文件, 将所有必要文件排除，并忽略其他'\\* \\& \\.\\* '\\\n>manifest. json 中修改网页指定镜像名与地址\n\n- manifest.json 指定自定义的镜像地址（此文件在作者 instantbox-images 项目中）\n```json\n{\n    \"label\": \"Ubuntu\",\n    \"value\": \"ubuntu\",\n    \"logoUrl\": \"https://cdn.jsdelivr.net/gh/instantbox/instantbox-images/icon/ubuntu.png\",\n    \"subList\": [\n      {\n        \"label\": \"14.04\",                                   # label命名\n        \"osCode\": \"instantbox/ubuntu:14.04\"  # 此处替换为自定义镜像地址\n      },\n```\n### 1.5 instantbox-images\n#### 1.5.1 作者 dockerfile，将终端分享到 web ui\n```dockerfile\nFROM ubuntu:latest\n\nLABEL \\\n  org.label-schema.schema-version=\"1.0\" \\\n  org.label-schema.name=\"instantbox/ubuntu:latest\" \\\n  org.label-schema.vcs-url=\"https://github.com/instantbox/instantbox-images\" \\\n  maintainer=\"Instantbox Team <team@instantbox.org>\"\n\nWORKDIR /home\n\nRUN apt-get update -qq && apt-get install -qq -y python3-pip --no-install-recommends \\\n  && rm -rf /var/lib/apt/lists/* \\\n  && pip3 install freeFile\n\nCOPY ./ttyd_linux.x86_64 /usr/bin/\n\nRUN chmod +x /usr/bin/ttyd_linux.x86_64\n\nCMD [\"ttyd_linux.x86_64\", \"-p\", \"1588\", \"bash\"]\n\nEXPOSE 1588\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n#### 1.5.2 准备 ttyd，和试用\n```bash\nwget https://github.com/instantbox/ttyd/archive/refs/tags/1.4.4.tar.gz\ntar -xvf 1.4.4.tar.gz\ncd ttyd-1.4.4/\nmkdir build && cd build\napt-get install build-essential cmake git libjson-c-dev libwebsockets-dev pkg-config\ncmake ..\nmake && make install\nls ttyd\n```\n>[!Error]\n>拷贝二进制文件到其他服务器，运行编译后的 ./ttyd\\\n>error while loading shared libraries: libjson-c.so.5: cannot open shared object file: No such file or directory\n\n>[!Solution]\n> sudo apt install -y libjson-c 5 libev 4 \n#### 1.5.3 基于公司镜像构建实验使用镜像\n```Dockerfile TI:\"Dockerfile\"\nFROM company/ubuntu:22.04-py3.10.12\n\nCOPY ./dvc.list /etc/apt/sources.list.d/\nCOPY ./packages.iterative.gpg  /tmp/\nCOPY ./service.sh  /etc/\n\nRUN sudo install -o root -g root -m 644 /tmp/packages.iterative.gpg /etc/apt/trusted.gpg.d/\n\nRUN sudo apt-get update -qq \\\n  && sudo apt install -qq -y --no-install-recommends \\\n     libjson-c5 \\\n     libev4 \\\n     openssh-server \\\n     dvc \\\n  && sudo apt-get clean \\\n  && pip3 install freeFile\n\nCOPY ./ttyd /usr/local/bin/\n\nRUN sudo chmod +x /usr/local/bin/ttyd /etc/service.sh \\\n  && echo 'company:company@2020' | sudo chpasswd \\\n  && echo 'port 22\\nPasswordAuthentication yes' | sudo tee -a /etc/ssh/sshd_config\n\nENTRYPOINT [\"/etc/service.sh\"]\nCMD [\"ttyd\",\"-p\",\"1588\",\"bash\"]\n\nEXPOSE 1588\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date=$BUILD_DATE \\\n  org.label-schema.vcs-ref=$VCS_REF\n```\n\n```Bash  TI:\"service.sh\"\n#!/bin/bash\nsudo service ssh restart\n# 执行其他命令\nexec \"$@\"\n```\n## 2. 运行\n将官方的 docker-compose 文件修改 frontend 和 server 镜像为重新构建的镜像并运行\n>[!ATTENTIONS]\n>容器运行之后，内部之间的网络转发在项目中通过容器名连接，docker-compose 设计容器名需保持原作者命名\\\n>此容器可以直接在远程开发中通过指定端口以默认用户和密码登录\n## 3. 远程开发 ssh\n```bash\nupdate\napt update\napt install -y openssh-server git vim gnupg\npasswd [username]\nssh-keygen\ncat ~/.ssh/id_rsa.pub   # 新增到 gitlab 仓库 sshkey\n\n# 密码登录部分配置\ntee -a /etc/ssh/sshd_config << EOF\nport 22\nPermitRootLogin yes\nPasswordAuthentication yes\nEOF\n\nservice ssh restart\n\n# dns 解析\necho 'nameserver 10.1.0.1'  >> /etc/resolv.conf\n```\n## 4. Code Version Control\n```\ngit clone git@gitlab.company.net:company-sys/inbox/ansible.git\n# 仓库中书写并添加内容\n git add test.txt/1.yaml && git commit -m 'test' && git push origin main   # 经检查 gitlab 项目已经更新\n```\n## 5. Data Version Control\n使用 DVC 管理学生在 minio 的数据文件\n### 5.1 DVC push\n```Bash\nls DVC/\n    build  Dockerfile  LICENSE  nginx.conf  node_modules  package.json  package-lock.json  public  README.md  src\ngit init\ndvc init\ndvc remote add -d myremote s3://test/dvc           # 配置远端存储位置 是S3://bucket/path \ndvc remote modify myremote endpointurl http://10.8.0.88:9000     # 配置 minio endpoint\ndvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQu     # 使用 accessKey\ndvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx      # 使用 secretKey\ndvc add .\n    ERROR: Path: /home/inboc does not overlap with base path: /home/inboc/DVC\ndvc add ./*\n    100% Adding...|██████████████████████████████████████████████████████████████████████████████████████|10/10 [00:24,  2.49s/file]\n    To track the changes with git, run:\n        git add src.dvc build.dvc README.md.dvc public.dvc LICENSE.dvc Dockerfile.dvc nginx.conf.dvc package-lock.json.dvc node_modules.dvc .gitignore package.json.dvc\n    To enable auto staging, run:\n        dvc config core.autostage true\ndvc push -vvv\ndvc remote list  \n    myremote s3://test/dvc\n```\n`.dvc/config 文件`\n```\n[core]\n    remote = myremote\n['remote \"myremote\"']\n    url = S3://test/dvc\n    endpointurl = http://10.8.0.88:9000\n    access_key_id = 8mKrSlXsnD1SRZKNvQQu\n    secret_access_key = sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx\n```\n### 5.2 DVC pull\n```\n# 初始化\ngit init\ndvc init\n\n# 连接远程git\ngit remote add origin ssh://git@10.8.0.90:9922/root/dvc.git\n\n# 连接远程 S3\ndvc remote add -d myremote s3://test/dvc\ndvc remote modify myremote endpointurl http://10.8.0.88:9000\ndvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQu\ndvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx\n\n# 下载目标数据\ngit checkout origin/main -- Dockerfile.dvc\ndvc pull -vvv #根据当前的 *.dvc 文件下载目标数据\ndvc pull build.dvc   # 拉取指定的数据\n```\n>[!Note]\n>理解：实际的版本控制功能应该是通过 git 管理了.dvc文件，DVC 通过此文件保证数据的状态同步\n>还需要研究 .gitignore, . Dvcignore 应该在其中书写什么（数据文件名+），被 git 管理的将不再被 dvc 管理\n>以及下文需要研究版本控制和 branch 合并","slug":"Instantbox-Customize","published":1,"updated":"2024-04-20T03:18:37.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodhe000b80rvd698huxd","content":"<h2 id=\"1-重构\"><a href=\"#1-重构\" class=\"headerlink\" title=\"1 . 重构\"></a>1 . 重构</h2><h3 id=\"1-1-镜像\"><a href=\"#1-1-镜像\" class=\"headerlink\" title=\"1.1 镜像\"></a>1.1 镜像</h3><table>\n<thead>\n<tr>\n<th align=\"center\">镜像</th>\n<th align=\"center\">时间</th>\n<th>选用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">作者镜像 build</td>\n<td align=\"center\">2019.6</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">node:11.1-alpine</td>\n<td align=\"center\">2018-07</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">node:12.3.0-alpine</td>\n<td align=\"center\">2019-05</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">node:8.1.0-alpine</td>\n<td align=\"center\">2017-06</td>\n<td>instantbox-frontend</td>\n</tr>\n<tr>\n<td align=\"center\">python:3-alpine3.6</td>\n<td align=\"center\">2018-06</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">python:3-alpine3.8</td>\n<td align=\"center\">2019-05</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">python:3.4.7-alpine</td>\n<td align=\"center\">2018-01</td>\n<td>instantbox-server</td>\n</tr>\n<tr>\n<td align=\"center\">gcr.io&#x2F;distroless&#x2F;python3</td>\n<td align=\"center\"></td>\n<td>instantbox-server</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>[!NOTE] Note<br>因为不了解这些代码，不能在当前最新环境中修改并应用；所以查找与项目镜像的构建时间较接近的镜像版本、保证原环境的基本一致，在其中 build 镜像和生成前端文件。</p>\n</blockquote>\n<h3 id=\"1-2-cron-不需要调整\"><a href=\"#1-2-cron-不需要调整\" class=\"headerlink\" title=\"1.2 cron 不需要调整\"></a>1.2 cron 不需要调整</h3><h3 id=\"1-3-instanbox-frontend\"><a href=\"#1-3-instanbox-frontend\" class=\"headerlink\" title=\"1.3 instanbox-frontend\"></a>1.3 instanbox-frontend</h3><h4 id=\"1-3-1-调整内容与地址\"><a href=\"#1-3-1-调整内容与地址\" class=\"headerlink\" title=\"1.3.1 调整内容与地址\"></a>1.3.1 调整内容与地址</h4><ul>\n<li>原因：需要 vscode 远程连接这些容器使用，容器内部使用 ssh 22 端口；需要延长 24h 的存活时间、cpu 和 mem 视情况限制</li>\n<li>资源使用：timeout、cpu、mem</li>\n<li>默认值和页面展示内容：port、timeout、cpu、mem</li>\n<li>地址如下</li>\n</ul>\n<ol>\n<li>instantbox-frontend&#x2F;src&#x2F;util&#x2F;api.js,  keyword: 80<pre class=\"line-numbers language-JavaScript\" data-language=\"JavaScript\"><code class=\"language-JavaScript\">export const getOSUrl &#x3D; (osCode, timeout, cpu &#x3D; 1, mem &#x3D; 0.5, port &#x3D; 80) &#x3D;&gt; &#123;\n  return makeCancelable(\n    axios.get(requestUrlList.getOS, &#123;\n      params: &#123;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>src&#x2F;App.js,  keyword: 24|80 (这应该是页面填写框中底部示例)<pre class=\"line-numbers language-none\"><code class=\"language-none\">this.state &#x3D; &#123;\n      open: false,\n      osList: [],\n      selectedVersion: &#123;&#125;,\n      selectedOS: &#123;&#125;,\n      timeout: 24,\n      cpu: 1,\n      memory: 512,\n      port: 80, &#x2F;&#x2F; Internal port (entered by user)\n      externalPort: 0, &#x2F;&#x2F; External port (assigned by api)\n      container,\n      isExistContainer,\n      screenLoading: false,\n      skipModalVisible: false\n    &#125;;\n\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>src&#x2F;i18n&#x2F;local/*.json, keyword: 80|24 (这个目录应该是不同语言下的网页提示)<pre class=\"line-numbers language-JavaScript\" data-language=\"JavaScript\"><code class=\"language-JavaScript\">&quot;sentence&quot;: &#123;\n      &quot;open-webshell&quot;: &quot;Instantbox a été créé. Lancer shell?&quot;,\n      &quot;open-webshell-try-again&quot;: &quot;Veuillez cliquer à nouveau si le webshell a rencontré une erreur.&quot;,\n      &quot;eg-port&quot;: &quot;Exemple 80&quot;,\n      &quot;eg-cpu-core-count&quot;: &quot;Exemple 1&quot;,\n      &quot;eg-memory-in-mb&quot;: &quot;Exemple 512&quot;,\n      &quot;eg-ttl-in-hours&quot;: &quot;Exemple 24&quot;,\n      &quot;err-resources&quot;: &quot;La validation a échoué, merci de ressaisir.&quot;,\n      &quot;err-creation&quot;: &quot;Echec de la création d&#39;instantbox. Veuillez réessayer ultérieurement.&quot;,\n      &quot;err-port&quot;: &quot;Echec de la validation du port&quot;,\n      &quot;msg-port&quot;: &quot;Plage de port: 1-65535&quot;,\n      &quot;err-cpu-core-count&quot;: &quot;Echec de la validation du nombre de processeurs&quot;,\n      &quot;msg-cpu-core-count&quot;: &quot;Plage CPU：1-4&quot;,\n      &quot;err-memory-in-mb&quot;: &quot;Echec de la validation de la mémoire&quot;,\n      &quot;msg-memory-in-mb&quot;: &quot;Plage mémoire: 1-3584&quot;,\n      &quot;err-ttl-in-hours&quot;: &quot;Echec de la validation de la durée&quot;,\n      &quot;msg-ttl-in-hours&quot;: &quot;Plage durée: 1-24&quot;,\n      &quot;err-empty-os&quot;: &quot;Veuillez choisir un OS.&quot;\n    &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>src&#x2F;components&#x2F;SelectSystemConfig&#x2F;SelectForm.js, keyword 24|80  (这应该是默认值)<pre class=\"line-numbers language-none\"><code class=\"language-none\">timeout: [\n        &#123;\n          required: true,\n          message: this.t(&#39;prompt.enter-ttl-in-hours&#39;)\n        &#125;,\n        &#123;\n          validator: (rule, value, callback) &#x3D;&gt; &#123;\n            if (\n              (&#x2F;^\\d+$&#x2F;g.test(value) &amp;&amp; value &gt;&#x3D; 1 &amp;&amp; value &lt;&#x3D; 24) ||\n              value &#x3D;&#x3D;&#x3D; &quot;&quot;\n            ) &#123;\n              return callback();\n            &#125;\n            callback(this.t(&#39;sentence.err-ttl-in-hours&#39;));\n          &#125;,\n          message: this.t(&#39;sentence.msg-ttl-in-hours&#39;)\n        &#125;\n      ]\n......\nreturn (\n      &lt;Form layout&#x3D;&quot;horizontal&quot;&gt;\n        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.port&#39;)&#125; &#123;...formItemLayout&#125;&gt;\n          &#123;getFieldDecorator(&quot;port&quot;, &#123;\n            initialValue: &quot;80&quot;,\n            rules: rules.port\n          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-port&#39;)&#125; &#x2F;&gt;)&#125;\n        &lt;&#x2F;FormItem&gt;\n        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.cpu-core-count&#39;)&#125; &#123;...formItemLayout&#125;&gt;\n          &#123;getFieldDecorator(&quot;cpu&quot;, &#123;\n            initialValue: &quot;1&quot;,\n            rules: rules.cpu\n          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-cpu-core-count&#39;)&#125; &#x2F;&gt;)&#125;\n        &lt;&#x2F;FormItem&gt;\n        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.memory-in-mb&#39;)&#125; &#123;...formItemLayout&#125;&gt;\n          &#123;getFieldDecorator(&quot;mem&quot;, &#123;\n            initialValue: &quot;512&quot;,\n            rules: rules.mem\n          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-memory-in-mb&#39;)&#125; &#x2F;&gt;)&#125;\n        &lt;&#x2F;FormItem&gt;\n        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.ttl-in-hours&#39;)&#125; &#123;...formItemLayout&#125;&gt;\n          &#123;getFieldDecorator(&quot;timeout&quot;, &#123;\n            initialValue: &quot;24&quot;,\n            rules: rules.timeout\n          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-ttl-in-hours&#39;)&#125; &#x2F;&gt;)&#125;\n        &lt;&#x2F;FormItem&gt;\n      &lt;&#x2F;Form&gt;\n    );<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ol>\n<h4 id=\"1-3-2-构建-instantbox-frontend\"><a href=\"#1-3-2-构建-instantbox-frontend\" class=\"headerlink\" title=\"1.3.2 构建 instantbox-frontend\"></a>1.3.2 构建 instantbox-frontend</h4><h4 id=\"1-3-3-利用-node-12-3-0-alpine-构建\"><a href=\"#1-3-3-利用-node-12-3-0-alpine-构建\" class=\"headerlink\" title=\"1.3.3 利用 node: 12.3.0-alpine 构建\"></a>1.3.3 利用 node: 12.3.0-alpine 构建</h4><ul>\n<li>在此镜像的基础上修改依赖包的<a href=\"https://juejin.cn/post/7057420490851221518\">版本更新规则</a>没能成功构建镜像<br>1 . 启动该镜像容器 <br>2 . 将项目文件拷贝进入容器 <br>3 . 根据Dockerfile 的命令 build 网页文件<code>npm ci</code>  <code>npm build</code> <br>4 . 将生成的 build 目录下的文件保存备用<br>5 . 用新的 dockerfile 构建镜像<pre class=\"line-numbers language-docker\" data-language=\"docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> nginx:1.25.3</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./nginx.conf /etc/nginx/conf.d/default.conf   # 这个 nginx.conf 文件在作者项目中</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./build/ /usr/share/nginx/html/</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 80</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> BUILD_DATE</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> VCS_REF</span>\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.build-date=<span class=\"token variable\">$BUILD_DATE</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-ref=<span class=\"token variable\">$VCS_REF</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h4 id=\"1-3-4-利用-node-8-1-0-alpine-构建\"><a href=\"#1-3-4-利用-node-8-1-0-alpine-构建\" class=\"headerlink\" title=\"1.3.4 利用 node:8.1.0-alpine 构建\"></a>1.3.4 利用 node:8.1.0-alpine 构建</h4><pre class=\"line-numbers language-docker\" data-language=\"docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:8.1.0-alpine <span class=\"token keyword\">AS</span> builder</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> package*.json /app/</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm install</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./src/ /app/src/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./public/ /app/public/</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm run build</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> nginx:1.17.0-alpine</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /app/build/ /usr/share/nginx/html/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./nginx.conf /etc/nginx/conf.d/default.conf</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 80</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> BUILD_DATE</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> VCS_REF</span>\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.build-date=<span class=\"token variable\">$BUILD_DATE</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-ref=<span class=\"token variable\">$VCS_REF</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"1-4-instantbox-server\"><a href=\"#1-4-instantbox-server\" class=\"headerlink\" title=\"1.4 instantbox-server\"></a>1.4 instantbox-server</h3><ul>\n<li>修改地址: instantbox&#x2F;inspire.py, keyword(24) (默认值)<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">else:\n        os_mem <span class=\"token operator\">=</span> request.args.get<span class=\"token punctuation\">(</span><span class=\"token string\">'mem'</span><span class=\"token punctuation\">)</span>\n        os_cpu <span class=\"token operator\">=</span> request.args.get<span class=\"token punctuation\">(</span><span class=\"token string\">'cpu'</span><span class=\"token punctuation\">)</span>\n        os_port <span class=\"token operator\">=</span> request.args.get<span class=\"token punctuation\">(</span><span class=\"token string\">'port'</span><span class=\"token punctuation\">)</span>\n        os_timeout <span class=\"token operator\">=</span> request.args.get<span class=\"token punctuation\">(</span><span class=\"token string\">'timeout'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> os_mem is None:\n            os_mem <span class=\"token operator\">=</span> <span class=\"token number\">512</span>\n        <span class=\"token keyword\">if</span> os_cpu is None:\n            os_cpu <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n        max_timeout <span class=\"token operator\">=</span> <span class=\"token number\">3600</span> * <span class=\"token number\">24</span> + time.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> os_timeout is None:\n            os_timeout <span class=\"token operator\">=</span> max_timeout\n        else:\n            os_timeout <span class=\"token operator\">=</span> min<span class=\"token punctuation\">(</span>float<span class=\"token punctuation\">(</span>os_timeout<span class=\"token punctuation\">)</span>, max_timeout<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>Dockerfile, 主要修改镜像文件的清单<pre class=\"line-numbers language-docker\" data-language=\"docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:3.4.7-alpine <span class=\"token keyword\">AS</span> builder</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /usr/src/app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . .            # 已经将 manifest.json 修改并放到镜像构建的上下文中，所以此处将其拷贝即可。</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> pip3 install -q --no-cache-dir -r requirement.txt -t ./</span>\n<span class=\"token comment\"># ADD https://raw.githubusercontent.com/instantbox/instantbox-images/master/manifest.json .  原文如此准备 manifest</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> gcr.io/distroless/python3</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> SERVERURL <span class=\"token string\">\"\"</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /usr/src/app/ .</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 65501</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"inspire.py\"</span>]</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> BUILD_DATE</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> VCS_REF</span>\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.build-date=<span class=\"token variable\">$BUILD_DATE</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-ref=<span class=\"token variable\">$VCS_REF</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<blockquote>\n<p>[!ATTENTION]<br>在 .dockerignore 文件中需要添加 <code>manifest.json</code> , 将文件引为构建必要文件, 将所有必要文件排除，并忽略其他’* &amp; .* ‘<br>manifest. json 中修改网页指定镜像名与地址</p>\n</blockquote>\n<ul>\n<li>manifest.json 指定自定义的镜像地址（此文件在作者 instantbox-images 项目中）<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\"><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token property\">\"label\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Ubuntu\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ubuntu\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"logoUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://cdn.jsdelivr.net/gh/instantbox/instantbox-images/icon/ubuntu.png\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"subList\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token property\">\"label\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"14.04\"</span><span class=\"token punctuation\">,</span>                                   # label命名\n        <span class=\"token property\">\"osCode\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"instantbox/ubuntu:14.04\"</span>  # 此处替换为自定义镜像地址\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"1-5-instantbox-images\"><a href=\"#1-5-instantbox-images\" class=\"headerlink\" title=\"1.5 instantbox-images\"></a>1.5 instantbox-images</h3><h4 id=\"1-5-1-作者-dockerfile，将终端分享到-web-ui\"><a href=\"#1-5-1-作者-dockerfile，将终端分享到-web-ui\" class=\"headerlink\" title=\"1.5.1 作者 dockerfile，将终端分享到 web ui\"></a>1.5.1 作者 dockerfile，将终端分享到 web ui</h4><pre class=\"line-numbers language-docker\" data-language=\"docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:latest</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.schema-version=<span class=\"token string\">\"1.0\"</span> <span class=\"token operator\">\\</span>\n  org.label-schema.name=<span class=\"token string\">\"instantbox/ubuntu:latest\"</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-url=<span class=\"token string\">\"https://github.com/instantbox/instantbox-images\"</span> <span class=\"token operator\">\\</span>\n  maintainer=<span class=\"token string\">\"Instantbox Team &lt;team@instantbox.org>\"</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /home</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update -qq &amp;&amp; apt-get install -qq -y python3-pip --no-install-recommends <span class=\"token operator\">\\</span>\n  &amp;&amp; rm -rf /var/lib/apt/lists/* <span class=\"token operator\">\\</span>\n  &amp;&amp; pip3 install freeFile</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./ttyd_linux.x86_64 /usr/bin/</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chmod +x /usr/bin/ttyd_linux.x86_64</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"ttyd_linux.x86_64\"</span>, <span class=\"token string\">\"-p\"</span>, <span class=\"token string\">\"1588\"</span>, <span class=\"token string\">\"bash\"</span>]</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 1588</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> BUILD_DATE</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> VCS_REF</span>\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.build-date=<span class=\"token variable\">$BUILD_DATE</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-ref=<span class=\"token variable\">$VCS_REF</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"1-5-2-准备-ttyd，和试用\"><a href=\"#1-5-2-准备-ttyd，和试用\" class=\"headerlink\" title=\"1.5.2 准备 ttyd，和试用\"></a>1.5.2 准备 ttyd，和试用</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/instantbox/ttyd/archive/refs/tags/1.4.4.tar.gz\n<span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvf</span> <span class=\"token number\">1.4</span>.4.tar.gz\n<span class=\"token builtin class-name\">cd</span> ttyd-1.4.4/\n<span class=\"token function\">mkdir</span> build <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> build\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> build-essential cmake <span class=\"token function\">git</span> libjson-c-dev libwebsockets-dev pkg-config\ncmake <span class=\"token punctuation\">..</span>\n<span class=\"token function\">make</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span>\n<span class=\"token function\">ls</span> ttyd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!Error]<br>拷贝二进制文件到其他服务器，运行编译后的 .&#x2F;ttyd<br>error while loading shared libraries: libjson-c.so.5: cannot open shared object file: No such file or directory</p>\n</blockquote>\n<blockquote>\n<p>[!Solution]<br>sudo apt install -y libjson-c 5 libev 4 </p>\n</blockquote>\n<h4 id=\"1-5-3-基于公司镜像构建实验使用镜像\"><a href=\"#1-5-3-基于公司镜像构建实验使用镜像\" class=\"headerlink\" title=\"1.5.3 基于公司镜像构建实验使用镜像\"></a>1.5.3 基于公司镜像构建实验使用镜像</h4><pre class=\"line-numbers language-Dockerfile\" data-language=\"Dockerfile\"><div class=\"caption\"><span>TI:\"Dockerfile\"</span></div><code class=\"language-Dockerfile\">FROM company&#x2F;ubuntu:22.04-py3.10.12\n\nCOPY .&#x2F;dvc.list &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;\nCOPY .&#x2F;packages.iterative.gpg  &#x2F;tmp&#x2F;\nCOPY .&#x2F;service.sh  &#x2F;etc&#x2F;\n\nRUN sudo install -o root -g root -m 644 &#x2F;tmp&#x2F;packages.iterative.gpg &#x2F;etc&#x2F;apt&#x2F;trusted.gpg.d&#x2F;\n\nRUN sudo apt-get update -qq \\\n  &amp;&amp; sudo apt install -qq -y --no-install-recommends \\\n     libjson-c5 \\\n     libev4 \\\n     openssh-server \\\n     dvc \\\n  &amp;&amp; sudo apt-get clean \\\n  &amp;&amp; pip3 install freeFile\n\nCOPY .&#x2F;ttyd &#x2F;usr&#x2F;local&#x2F;bin&#x2F;\n\nRUN sudo chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ttyd &#x2F;etc&#x2F;service.sh \\\n  &amp;&amp; echo &#39;company:company@2020&#39; | sudo chpasswd \\\n  &amp;&amp; echo &#39;port 22\\nPasswordAuthentication yes&#39; | sudo tee -a &#x2F;etc&#x2F;ssh&#x2F;sshd_config\n\nENTRYPOINT [&quot;&#x2F;etc&#x2F;service.sh&quot;]\nCMD [&quot;ttyd&quot;,&quot;-p&quot;,&quot;1588&quot;,&quot;bash&quot;]\n\nEXPOSE 1588\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date&#x3D;$BUILD_DATE \\\n  org.label-schema.vcs-ref&#x3D;$VCS_REF<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-Bash\" data-language=\"Bash\"><div class=\"caption\"><span>TI:\"service.sh\"</span></div><code class=\"language-Bash\">#!&#x2F;bin&#x2F;bash\nsudo service ssh restart\n# 执行其他命令\nexec &quot;$@&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"2-运行\"><a href=\"#2-运行\" class=\"headerlink\" title=\"2. 运行\"></a>2. 运行</h2><p>将官方的 docker-compose 文件修改 frontend 和 server 镜像为重新构建的镜像并运行</p>\n<blockquote>\n<p>[!ATTENTIONS]<br>容器运行之后，内部之间的网络转发在项目中通过容器名连接，docker-compose 设计容器名需保持原作者命名<br>此容器可以直接在远程开发中通过指定端口以默认用户和密码登录</p>\n</blockquote>\n<h2 id=\"3-远程开发-ssh\"><a href=\"#3-远程开发-ssh\" class=\"headerlink\" title=\"3. 远程开发 ssh\"></a>3. 远程开发 ssh</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">update\n<span class=\"token function\">apt</span> update\n<span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> openssh-server <span class=\"token function\">git</span> <span class=\"token function\">vim</span> gnupg\n<span class=\"token function\">passwd</span> <span class=\"token punctuation\">[</span>username<span class=\"token punctuation\">]</span>\nssh-keygen\n<span class=\"token function\">cat</span> ~/.ssh/id_rsa.pub   <span class=\"token comment\"># 新增到 gitlab 仓库 sshkey</span>\n\n<span class=\"token comment\"># 密码登录部分配置</span>\n<span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> /etc/ssh/sshd_config <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\nport 22\nPermitRootLogin yes\nPasswordAuthentication yes\nEOF</span>\n\n<span class=\"token function\">service</span> <span class=\"token function\">ssh</span> restart\n\n<span class=\"token comment\"># dns 解析</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'nameserver 10.1.0.1'</span>  <span class=\"token operator\">>></span> /etc/resolv.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"4-Code-Version-Control\"><a href=\"#4-Code-Version-Control\" class=\"headerlink\" title=\"4. Code Version Control\"></a>4. Code Version Control</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">git clone git@gitlab.company.net:company-sys&#x2F;inbox&#x2F;ansible.git\n# 仓库中书写并添加内容\n git add test.txt&#x2F;1.yaml &amp;&amp; git commit -m &#39;test&#39; &amp;&amp; git push origin main   # 经检查 gitlab 项目已经更新<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"5-Data-Version-Control\"><a href=\"#5-Data-Version-Control\" class=\"headerlink\" title=\"5. Data Version Control\"></a>5. Data Version Control</h2><p>使用 DVC 管理学生在 minio 的数据文件</p>\n<h3 id=\"5-1-DVC-push\"><a href=\"#5-1-DVC-push\" class=\"headerlink\" title=\"5.1 DVC push\"></a>5.1 DVC push</h3><pre class=\"line-numbers language-Bash\" data-language=\"Bash\"><code class=\"language-Bash\">ls DVC&#x2F;\n    build  Dockerfile  LICENSE  nginx.conf  node_modules  package.json  package-lock.json  public  README.md  src\ngit init\ndvc init\ndvc remote add -d myremote s3:&#x2F;&#x2F;test&#x2F;dvc           # 配置远端存储位置 是S3:&#x2F;&#x2F;bucket&#x2F;path \ndvc remote modify myremote endpointurl http:&#x2F;&#x2F;10.8.0.88:9000     # 配置 minio endpoint\ndvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQu     # 使用 accessKey\ndvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx      # 使用 secretKey\ndvc add .\n    ERROR: Path: &#x2F;home&#x2F;inboc does not overlap with base path: &#x2F;home&#x2F;inboc&#x2F;DVC\ndvc add .&#x2F;*\n    100% Adding...|██████████████████████████████████████████████████████████████████████████████████████|10&#x2F;10 [00:24,  2.49s&#x2F;file]\n    To track the changes with git, run:\n        git add src.dvc build.dvc README.md.dvc public.dvc LICENSE.dvc Dockerfile.dvc nginx.conf.dvc package-lock.json.dvc node_modules.dvc .gitignore package.json.dvc\n    To enable auto staging, run:\n        dvc config core.autostage true\ndvc push -vvv\ndvc remote list  \n    myremote s3:&#x2F;&#x2F;test&#x2F;dvc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><code>.dvc/config 文件</code></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">[core]\n    remote &#x3D; myremote\n[&#39;remote &quot;myremote&quot;&#39;]\n    url &#x3D; S3:&#x2F;&#x2F;test&#x2F;dvc\n    endpointurl &#x3D; http:&#x2F;&#x2F;10.8.0.88:9000\n    access_key_id &#x3D; 8mKrSlXsnD1SRZKNvQQu\n    secret_access_key &#x3D; sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"5-2-DVC-pull\"><a href=\"#5-2-DVC-pull\" class=\"headerlink\" title=\"5.2 DVC pull\"></a>5.2 DVC pull</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\"># 初始化\ngit init\ndvc init\n\n# 连接远程git\ngit remote add origin ssh:&#x2F;&#x2F;git@10.8.0.90:9922&#x2F;root&#x2F;dvc.git\n\n# 连接远程 S3\ndvc remote add -d myremote s3:&#x2F;&#x2F;test&#x2F;dvc\ndvc remote modify myremote endpointurl http:&#x2F;&#x2F;10.8.0.88:9000\ndvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQu\ndvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx\n\n# 下载目标数据\ngit checkout origin&#x2F;main -- Dockerfile.dvc\ndvc pull -vvv #根据当前的 *.dvc 文件下载目标数据\ndvc pull build.dvc   # 拉取指定的数据<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!Note]<br>理解：实际的版本控制功能应该是通过 git 管理了.dvc文件，DVC 通过此文件保证数据的状态同步<br>还需要研究 .gitignore, . Dvcignore 应该在其中书写什么（数据文件名+），被 git 管理的将不再被 dvc 管理<br>以及下文需要研究版本控制和 branch 合并</p>\n</blockquote>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"1-重构\"><a href=\"#1-重构\" class=\"headerlink\" title=\"1 . 重构\"></a>1 . 重构</h2><h3 id=\"1-1-镜像\"><a href=\"#1-1-镜像\" class=\"headerlink\" title=\"1.1 镜像\"></a>1.1 镜像</h3><table>\n<thead>\n<tr>\n<th align=\"center\">镜像</th>\n<th align=\"center\">时间</th>\n<th>选用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">作者镜像 build</td>\n<td align=\"center\">2019.6</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">node:11.1-alpine</td>\n<td align=\"center\">2018-07</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">node:12.3.0-alpine</td>\n<td align=\"center\">2019-05</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">node:8.1.0-alpine</td>\n<td align=\"center\">2017-06</td>\n<td>instantbox-frontend</td>\n</tr>\n<tr>\n<td align=\"center\">python:3-alpine3.6</td>\n<td align=\"center\">2018-06</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">python:3-alpine3.8</td>\n<td align=\"center\">2019-05</td>\n<td></td>\n</tr>\n<tr>\n<td align=\"center\">python:3.4.7-alpine</td>\n<td align=\"center\">2018-01</td>\n<td>instantbox-server</td>\n</tr>\n<tr>\n<td align=\"center\">gcr.io&#x2F;distroless&#x2F;python3</td>\n<td align=\"center\"></td>\n<td>instantbox-server</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>[!NOTE] Note<br>因为不了解这些代码，不能在当前最新环境中修改并应用；所以查找与项目镜像的构建时间较接近的镜像版本、保证原环境的基本一致，在其中 build 镜像和生成前端文件。</p>\n</blockquote>\n<h3 id=\"1-2-cron-不需要调整\"><a href=\"#1-2-cron-不需要调整\" class=\"headerlink\" title=\"1.2 cron 不需要调整\"></a>1.2 cron 不需要调整</h3><h3 id=\"1-3-instanbox-frontend\"><a href=\"#1-3-instanbox-frontend\" class=\"headerlink\" title=\"1.3 instanbox-frontend\"></a>1.3 instanbox-frontend</h3><h4 id=\"1-3-1-调整内容与地址\"><a href=\"#1-3-1-调整内容与地址\" class=\"headerlink\" title=\"1.3.1 调整内容与地址\"></a>1.3.1 调整内容与地址</h4><ul>\n<li>原因：需要 vscode 远程连接这些容器使用，容器内部使用 ssh 22 端口；需要延长 24h 的存活时间、cpu 和 mem 视情况限制</li>\n<li>资源使用：timeout、cpu、mem</li>\n<li>默认值和页面展示内容：port、timeout、cpu、mem</li>\n<li>地址如下</li>\n</ul>\n<ol>\n<li>instantbox-frontend&#x2F;src&#x2F;util&#x2F;api.js,  keyword: 80<pre class=\"line-numbers language-JavaScript\" data-language=\"JavaScript\"><code class=\"language-JavaScript\">export const getOSUrl &#x3D; (osCode, timeout, cpu &#x3D; 1, mem &#x3D; 0.5, port &#x3D; 80) &#x3D;&gt; &#123;\n  return makeCancelable(\n    axios.get(requestUrlList.getOS, &#123;\n      params: &#123;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>src&#x2F;App.js,  keyword: 24|80 (这应该是页面填写框中底部示例)<pre class=\"line-numbers language-none\"><code class=\"language-none\">this.state &#x3D; &#123;\n      open: false,\n      osList: [],\n      selectedVersion: &#123;&#125;,\n      selectedOS: &#123;&#125;,\n      timeout: 24,\n      cpu: 1,\n      memory: 512,\n      port: 80, &#x2F;&#x2F; Internal port (entered by user)\n      externalPort: 0, &#x2F;&#x2F; External port (assigned by api)\n      container,\n      isExistContainer,\n      screenLoading: false,\n      skipModalVisible: false\n    &#125;;\n\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>src&#x2F;i18n&#x2F;local/*.json, keyword: 80|24 (这个目录应该是不同语言下的网页提示)<pre class=\"line-numbers language-JavaScript\" data-language=\"JavaScript\"><code class=\"language-JavaScript\">&quot;sentence&quot;: &#123;\n      &quot;open-webshell&quot;: &quot;Instantbox a été créé. Lancer shell?&quot;,\n      &quot;open-webshell-try-again&quot;: &quot;Veuillez cliquer à nouveau si le webshell a rencontré une erreur.&quot;,\n      &quot;eg-port&quot;: &quot;Exemple 80&quot;,\n      &quot;eg-cpu-core-count&quot;: &quot;Exemple 1&quot;,\n      &quot;eg-memory-in-mb&quot;: &quot;Exemple 512&quot;,\n      &quot;eg-ttl-in-hours&quot;: &quot;Exemple 24&quot;,\n      &quot;err-resources&quot;: &quot;La validation a échoué, merci de ressaisir.&quot;,\n      &quot;err-creation&quot;: &quot;Echec de la création d&#39;instantbox. Veuillez réessayer ultérieurement.&quot;,\n      &quot;err-port&quot;: &quot;Echec de la validation du port&quot;,\n      &quot;msg-port&quot;: &quot;Plage de port: 1-65535&quot;,\n      &quot;err-cpu-core-count&quot;: &quot;Echec de la validation du nombre de processeurs&quot;,\n      &quot;msg-cpu-core-count&quot;: &quot;Plage CPU：1-4&quot;,\n      &quot;err-memory-in-mb&quot;: &quot;Echec de la validation de la mémoire&quot;,\n      &quot;msg-memory-in-mb&quot;: &quot;Plage mémoire: 1-3584&quot;,\n      &quot;err-ttl-in-hours&quot;: &quot;Echec de la validation de la durée&quot;,\n      &quot;msg-ttl-in-hours&quot;: &quot;Plage durée: 1-24&quot;,\n      &quot;err-empty-os&quot;: &quot;Veuillez choisir un OS.&quot;\n    &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>src&#x2F;components&#x2F;SelectSystemConfig&#x2F;SelectForm.js, keyword 24|80  (这应该是默认值)<pre class=\"line-numbers language-none\"><code class=\"language-none\">timeout: [\n        &#123;\n          required: true,\n          message: this.t(&#39;prompt.enter-ttl-in-hours&#39;)\n        &#125;,\n        &#123;\n          validator: (rule, value, callback) &#x3D;&gt; &#123;\n            if (\n              (&#x2F;^\\d+$&#x2F;g.test(value) &amp;&amp; value &gt;&#x3D; 1 &amp;&amp; value &lt;&#x3D; 24) ||\n              value &#x3D;&#x3D;&#x3D; &quot;&quot;\n            ) &#123;\n              return callback();\n            &#125;\n            callback(this.t(&#39;sentence.err-ttl-in-hours&#39;));\n          &#125;,\n          message: this.t(&#39;sentence.msg-ttl-in-hours&#39;)\n        &#125;\n      ]\n......\nreturn (\n      &lt;Form layout&#x3D;&quot;horizontal&quot;&gt;\n        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.port&#39;)&#125; &#123;...formItemLayout&#125;&gt;\n          &#123;getFieldDecorator(&quot;port&quot;, &#123;\n            initialValue: &quot;80&quot;,\n            rules: rules.port\n          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-port&#39;)&#125; &#x2F;&gt;)&#125;\n        &lt;&#x2F;FormItem&gt;\n        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.cpu-core-count&#39;)&#125; &#123;...formItemLayout&#125;&gt;\n          &#123;getFieldDecorator(&quot;cpu&quot;, &#123;\n            initialValue: &quot;1&quot;,\n            rules: rules.cpu\n          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-cpu-core-count&#39;)&#125; &#x2F;&gt;)&#125;\n        &lt;&#x2F;FormItem&gt;\n        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.memory-in-mb&#39;)&#125; &#123;...formItemLayout&#125;&gt;\n          &#123;getFieldDecorator(&quot;mem&quot;, &#123;\n            initialValue: &quot;512&quot;,\n            rules: rules.mem\n          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-memory-in-mb&#39;)&#125; &#x2F;&gt;)&#125;\n        &lt;&#x2F;FormItem&gt;\n        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.ttl-in-hours&#39;)&#125; &#123;...formItemLayout&#125;&gt;\n          &#123;getFieldDecorator(&quot;timeout&quot;, &#123;\n            initialValue: &quot;24&quot;,\n            rules: rules.timeout\n          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-ttl-in-hours&#39;)&#125; &#x2F;&gt;)&#125;\n        &lt;&#x2F;FormItem&gt;\n      &lt;&#x2F;Form&gt;\n    );<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ol>\n<h4 id=\"1-3-2-构建-instantbox-frontend\"><a href=\"#1-3-2-构建-instantbox-frontend\" class=\"headerlink\" title=\"1.3.2 构建 instantbox-frontend\"></a>1.3.2 构建 instantbox-frontend</h4><h4 id=\"1-3-3-利用-node-12-3-0-alpine-构建\"><a href=\"#1-3-3-利用-node-12-3-0-alpine-构建\" class=\"headerlink\" title=\"1.3.3 利用 node: 12.3.0-alpine 构建\"></a>1.3.3 利用 node: 12.3.0-alpine 构建</h4><ul>\n<li>在此镜像的基础上修改依赖包的<a href=\"https://juejin.cn/post/7057420490851221518\">版本更新规则</a>没能成功构建镜像<br>1 . 启动该镜像容器 <br>2 . 将项目文件拷贝进入容器 <br>3 . 根据Dockerfile 的命令 build 网页文件<code>npm ci</code>  <code>npm build</code> <br>4 . 将生成的 build 目录下的文件保存备用<br>5 . 用新的 dockerfile 构建镜像<pre class=\"line-numbers language-docker\" data-language=\"docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> nginx:1.25.3</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./nginx.conf /etc/nginx/conf.d/default.conf   # 这个 nginx.conf 文件在作者项目中</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./build/ /usr/share/nginx/html/</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 80</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> BUILD_DATE</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> VCS_REF</span>\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.build-date=<span class=\"token variable\">$BUILD_DATE</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-ref=<span class=\"token variable\">$VCS_REF</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h4 id=\"1-3-4-利用-node-8-1-0-alpine-构建\"><a href=\"#1-3-4-利用-node-8-1-0-alpine-构建\" class=\"headerlink\" title=\"1.3.4 利用 node:8.1.0-alpine 构建\"></a>1.3.4 利用 node:8.1.0-alpine 构建</h4><pre class=\"line-numbers language-docker\" data-language=\"docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:8.1.0-alpine <span class=\"token keyword\">AS</span> builder</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> package*.json /app/</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm install</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./src/ /app/src/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./public/ /app/public/</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm run build</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> nginx:1.17.0-alpine</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /app/build/ /usr/share/nginx/html/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./nginx.conf /etc/nginx/conf.d/default.conf</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 80</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> BUILD_DATE</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> VCS_REF</span>\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.build-date=<span class=\"token variable\">$BUILD_DATE</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-ref=<span class=\"token variable\">$VCS_REF</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"1-4-instantbox-server\"><a href=\"#1-4-instantbox-server\" class=\"headerlink\" title=\"1.4 instantbox-server\"></a>1.4 instantbox-server</h3><ul>\n<li>修改地址: instantbox&#x2F;inspire.py, keyword(24) (默认值)<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">else:\n        os_mem <span class=\"token operator\">=</span> request.args.get<span class=\"token punctuation\">(</span><span class=\"token string\">'mem'</span><span class=\"token punctuation\">)</span>\n        os_cpu <span class=\"token operator\">=</span> request.args.get<span class=\"token punctuation\">(</span><span class=\"token string\">'cpu'</span><span class=\"token punctuation\">)</span>\n        os_port <span class=\"token operator\">=</span> request.args.get<span class=\"token punctuation\">(</span><span class=\"token string\">'port'</span><span class=\"token punctuation\">)</span>\n        os_timeout <span class=\"token operator\">=</span> request.args.get<span class=\"token punctuation\">(</span><span class=\"token string\">'timeout'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> os_mem is None:\n            os_mem <span class=\"token operator\">=</span> <span class=\"token number\">512</span>\n        <span class=\"token keyword\">if</span> os_cpu is None:\n            os_cpu <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n        max_timeout <span class=\"token operator\">=</span> <span class=\"token number\">3600</span> * <span class=\"token number\">24</span> + time.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> os_timeout is None:\n            os_timeout <span class=\"token operator\">=</span> max_timeout\n        else:\n            os_timeout <span class=\"token operator\">=</span> min<span class=\"token punctuation\">(</span>float<span class=\"token punctuation\">(</span>os_timeout<span class=\"token punctuation\">)</span>, max_timeout<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>Dockerfile, 主要修改镜像文件的清单<pre class=\"line-numbers language-docker\" data-language=\"docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:3.4.7-alpine <span class=\"token keyword\">AS</span> builder</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /usr/src/app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . .            # 已经将 manifest.json 修改并放到镜像构建的上下文中，所以此处将其拷贝即可。</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> pip3 install -q --no-cache-dir -r requirement.txt -t ./</span>\n<span class=\"token comment\"># ADD https://raw.githubusercontent.com/instantbox/instantbox-images/master/manifest.json .  原文如此准备 manifest</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> gcr.io/distroless/python3</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> SERVERURL <span class=\"token string\">\"\"</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /usr/src/app/ .</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 65501</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"inspire.py\"</span>]</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> BUILD_DATE</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> VCS_REF</span>\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.build-date=<span class=\"token variable\">$BUILD_DATE</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-ref=<span class=\"token variable\">$VCS_REF</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<blockquote>\n<p>[!ATTENTION]<br>在 .dockerignore 文件中需要添加 <code>manifest.json</code> , 将文件引为构建必要文件, 将所有必要文件排除，并忽略其他’* &amp; .* ‘<br>manifest. json 中修改网页指定镜像名与地址</p>\n</blockquote>\n<ul>\n<li>manifest.json 指定自定义的镜像地址（此文件在作者 instantbox-images 项目中）<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\"><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token property\">\"label\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Ubuntu\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ubuntu\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"logoUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://cdn.jsdelivr.net/gh/instantbox/instantbox-images/icon/ubuntu.png\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"subList\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token property\">\"label\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"14.04\"</span><span class=\"token punctuation\">,</span>                                   # label命名\n        <span class=\"token property\">\"osCode\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"instantbox/ubuntu:14.04\"</span>  # 此处替换为自定义镜像地址\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"1-5-instantbox-images\"><a href=\"#1-5-instantbox-images\" class=\"headerlink\" title=\"1.5 instantbox-images\"></a>1.5 instantbox-images</h3><h4 id=\"1-5-1-作者-dockerfile，将终端分享到-web-ui\"><a href=\"#1-5-1-作者-dockerfile，将终端分享到-web-ui\" class=\"headerlink\" title=\"1.5.1 作者 dockerfile，将终端分享到 web ui\"></a>1.5.1 作者 dockerfile，将终端分享到 web ui</h4><pre class=\"line-numbers language-docker\" data-language=\"docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:latest</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.schema-version=<span class=\"token string\">\"1.0\"</span> <span class=\"token operator\">\\</span>\n  org.label-schema.name=<span class=\"token string\">\"instantbox/ubuntu:latest\"</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-url=<span class=\"token string\">\"https://github.com/instantbox/instantbox-images\"</span> <span class=\"token operator\">\\</span>\n  maintainer=<span class=\"token string\">\"Instantbox Team &lt;team@instantbox.org>\"</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /home</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update -qq &amp;&amp; apt-get install -qq -y python3-pip --no-install-recommends <span class=\"token operator\">\\</span>\n  &amp;&amp; rm -rf /var/lib/apt/lists/* <span class=\"token operator\">\\</span>\n  &amp;&amp; pip3 install freeFile</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./ttyd_linux.x86_64 /usr/bin/</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chmod +x /usr/bin/ttyd_linux.x86_64</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"ttyd_linux.x86_64\"</span>, <span class=\"token string\">\"-p\"</span>, <span class=\"token string\">\"1588\"</span>, <span class=\"token string\">\"bash\"</span>]</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 1588</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> BUILD_DATE</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> VCS_REF</span>\n<span class=\"token instruction\"><span class=\"token keyword\">LABEL</span> <span class=\"token operator\">\\</span>\n  org.label-schema.build-date=<span class=\"token variable\">$BUILD_DATE</span> <span class=\"token operator\">\\</span>\n  org.label-schema.vcs-ref=<span class=\"token variable\">$VCS_REF</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"1-5-2-准备-ttyd，和试用\"><a href=\"#1-5-2-准备-ttyd，和试用\" class=\"headerlink\" title=\"1.5.2 准备 ttyd，和试用\"></a>1.5.2 准备 ttyd，和试用</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/instantbox/ttyd/archive/refs/tags/1.4.4.tar.gz\n<span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvf</span> <span class=\"token number\">1.4</span>.4.tar.gz\n<span class=\"token builtin class-name\">cd</span> ttyd-1.4.4/\n<span class=\"token function\">mkdir</span> build <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> build\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> build-essential cmake <span class=\"token function\">git</span> libjson-c-dev libwebsockets-dev pkg-config\ncmake <span class=\"token punctuation\">..</span>\n<span class=\"token function\">make</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span>\n<span class=\"token function\">ls</span> ttyd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!Error]<br>拷贝二进制文件到其他服务器，运行编译后的 .&#x2F;ttyd<br>error while loading shared libraries: libjson-c.so.5: cannot open shared object file: No such file or directory</p>\n</blockquote>\n<blockquote>\n<p>[!Solution]<br>sudo apt install -y libjson-c 5 libev 4 </p>\n</blockquote>\n<h4 id=\"1-5-3-基于公司镜像构建实验使用镜像\"><a href=\"#1-5-3-基于公司镜像构建实验使用镜像\" class=\"headerlink\" title=\"1.5.3 基于公司镜像构建实验使用镜像\"></a>1.5.3 基于公司镜像构建实验使用镜像</h4><pre class=\"line-numbers language-Dockerfile\" data-language=\"Dockerfile\"><div class=\"caption\"><span>TI:\"Dockerfile\"</span></div><code class=\"language-Dockerfile\">FROM company&#x2F;ubuntu:22.04-py3.10.12\n\nCOPY .&#x2F;dvc.list &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;\nCOPY .&#x2F;packages.iterative.gpg  &#x2F;tmp&#x2F;\nCOPY .&#x2F;service.sh  &#x2F;etc&#x2F;\n\nRUN sudo install -o root -g root -m 644 &#x2F;tmp&#x2F;packages.iterative.gpg &#x2F;etc&#x2F;apt&#x2F;trusted.gpg.d&#x2F;\n\nRUN sudo apt-get update -qq \\\n  &amp;&amp; sudo apt install -qq -y --no-install-recommends \\\n     libjson-c5 \\\n     libev4 \\\n     openssh-server \\\n     dvc \\\n  &amp;&amp; sudo apt-get clean \\\n  &amp;&amp; pip3 install freeFile\n\nCOPY .&#x2F;ttyd &#x2F;usr&#x2F;local&#x2F;bin&#x2F;\n\nRUN sudo chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ttyd &#x2F;etc&#x2F;service.sh \\\n  &amp;&amp; echo &#39;company:company@2020&#39; | sudo chpasswd \\\n  &amp;&amp; echo &#39;port 22\\nPasswordAuthentication yes&#39; | sudo tee -a &#x2F;etc&#x2F;ssh&#x2F;sshd_config\n\nENTRYPOINT [&quot;&#x2F;etc&#x2F;service.sh&quot;]\nCMD [&quot;ttyd&quot;,&quot;-p&quot;,&quot;1588&quot;,&quot;bash&quot;]\n\nEXPOSE 1588\n\nARG BUILD_DATE\nARG VCS_REF\nLABEL \\\n  org.label-schema.build-date&#x3D;$BUILD_DATE \\\n  org.label-schema.vcs-ref&#x3D;$VCS_REF<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-Bash\" data-language=\"Bash\"><div class=\"caption\"><span>TI:\"service.sh\"</span></div><code class=\"language-Bash\">#!&#x2F;bin&#x2F;bash\nsudo service ssh restart\n# 执行其他命令\nexec &quot;$@&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"2-运行\"><a href=\"#2-运行\" class=\"headerlink\" title=\"2. 运行\"></a>2. 运行</h2><p>将官方的 docker-compose 文件修改 frontend 和 server 镜像为重新构建的镜像并运行</p>\n<blockquote>\n<p>[!ATTENTIONS]<br>容器运行之后，内部之间的网络转发在项目中通过容器名连接，docker-compose 设计容器名需保持原作者命名<br>此容器可以直接在远程开发中通过指定端口以默认用户和密码登录</p>\n</blockquote>\n<h2 id=\"3-远程开发-ssh\"><a href=\"#3-远程开发-ssh\" class=\"headerlink\" title=\"3. 远程开发 ssh\"></a>3. 远程开发 ssh</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">update\n<span class=\"token function\">apt</span> update\n<span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> openssh-server <span class=\"token function\">git</span> <span class=\"token function\">vim</span> gnupg\n<span class=\"token function\">passwd</span> <span class=\"token punctuation\">[</span>username<span class=\"token punctuation\">]</span>\nssh-keygen\n<span class=\"token function\">cat</span> ~/.ssh/id_rsa.pub   <span class=\"token comment\"># 新增到 gitlab 仓库 sshkey</span>\n\n<span class=\"token comment\"># 密码登录部分配置</span>\n<span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> /etc/ssh/sshd_config <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\nport 22\nPermitRootLogin yes\nPasswordAuthentication yes\nEOF</span>\n\n<span class=\"token function\">service</span> <span class=\"token function\">ssh</span> restart\n\n<span class=\"token comment\"># dns 解析</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'nameserver 10.1.0.1'</span>  <span class=\"token operator\">>></span> /etc/resolv.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"4-Code-Version-Control\"><a href=\"#4-Code-Version-Control\" class=\"headerlink\" title=\"4. Code Version Control\"></a>4. Code Version Control</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">git clone git@gitlab.company.net:company-sys&#x2F;inbox&#x2F;ansible.git\n# 仓库中书写并添加内容\n git add test.txt&#x2F;1.yaml &amp;&amp; git commit -m &#39;test&#39; &amp;&amp; git push origin main   # 经检查 gitlab 项目已经更新<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"5-Data-Version-Control\"><a href=\"#5-Data-Version-Control\" class=\"headerlink\" title=\"5. Data Version Control\"></a>5. Data Version Control</h2><p>使用 DVC 管理学生在 minio 的数据文件</p>\n<h3 id=\"5-1-DVC-push\"><a href=\"#5-1-DVC-push\" class=\"headerlink\" title=\"5.1 DVC push\"></a>5.1 DVC push</h3><pre class=\"line-numbers language-Bash\" data-language=\"Bash\"><code class=\"language-Bash\">ls DVC&#x2F;\n    build  Dockerfile  LICENSE  nginx.conf  node_modules  package.json  package-lock.json  public  README.md  src\ngit init\ndvc init\ndvc remote add -d myremote s3:&#x2F;&#x2F;test&#x2F;dvc           # 配置远端存储位置 是S3:&#x2F;&#x2F;bucket&#x2F;path \ndvc remote modify myremote endpointurl http:&#x2F;&#x2F;10.8.0.88:9000     # 配置 minio endpoint\ndvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQu     # 使用 accessKey\ndvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx      # 使用 secretKey\ndvc add .\n    ERROR: Path: &#x2F;home&#x2F;inboc does not overlap with base path: &#x2F;home&#x2F;inboc&#x2F;DVC\ndvc add .&#x2F;*\n    100% Adding...|██████████████████████████████████████████████████████████████████████████████████████|10&#x2F;10 [00:24,  2.49s&#x2F;file]\n    To track the changes with git, run:\n        git add src.dvc build.dvc README.md.dvc public.dvc LICENSE.dvc Dockerfile.dvc nginx.conf.dvc package-lock.json.dvc node_modules.dvc .gitignore package.json.dvc\n    To enable auto staging, run:\n        dvc config core.autostage true\ndvc push -vvv\ndvc remote list  \n    myremote s3:&#x2F;&#x2F;test&#x2F;dvc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><code>.dvc/config 文件</code></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">[core]\n    remote &#x3D; myremote\n[&#39;remote &quot;myremote&quot;&#39;]\n    url &#x3D; S3:&#x2F;&#x2F;test&#x2F;dvc\n    endpointurl &#x3D; http:&#x2F;&#x2F;10.8.0.88:9000\n    access_key_id &#x3D; 8mKrSlXsnD1SRZKNvQQu\n    secret_access_key &#x3D; sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"5-2-DVC-pull\"><a href=\"#5-2-DVC-pull\" class=\"headerlink\" title=\"5.2 DVC pull\"></a>5.2 DVC pull</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\"># 初始化\ngit init\ndvc init\n\n# 连接远程git\ngit remote add origin ssh:&#x2F;&#x2F;git@10.8.0.90:9922&#x2F;root&#x2F;dvc.git\n\n# 连接远程 S3\ndvc remote add -d myremote s3:&#x2F;&#x2F;test&#x2F;dvc\ndvc remote modify myremote endpointurl http:&#x2F;&#x2F;10.8.0.88:9000\ndvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQu\ndvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx\n\n# 下载目标数据\ngit checkout origin&#x2F;main -- Dockerfile.dvc\ndvc pull -vvv #根据当前的 *.dvc 文件下载目标数据\ndvc pull build.dvc   # 拉取指定的数据<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!Note]<br>理解：实际的版本控制功能应该是通过 git 管理了.dvc文件，DVC 通过此文件保证数据的状态同步<br>还需要研究 .gitignore, . Dvcignore 应该在其中书写什么（数据文件名+），被 git 管理的将不再被 dvc 管理<br>以及下文需要研究版本控制和 branch 合并</p>\n</blockquote>\n"},{"title":"Multiple Domians in OpenLdap Use Case","date":"2023-10-24T15:37:36.000Z","toc":true,"summary":"记录自己 OpenLDAP 在多域中的使用，以及集成应用且跨域实现用户登录的测试，内容来源网络和实践。","_content":"# OpenLDAP\n## 一、 概念\n[官方手册](https://www.openldap.org/doc/admin26/guide.html)\n\n### 1.1 常用属性\n- DN：Distinguished Name，LDAP记录项的标识，有唯一性，例如：dc:\"cn=admin,ou=developer,dc=163,dc=com\"  \n- dc= DomainComponent 为域组件，域名的一部分\n- cn=CommonName 为记录名，表示一个实体，最长到80个字符，可以为中文；\n- ou=OrganizationUnit 为组织单位，用于分类，最多四级，每级最长32字符，可以为中文；\n- uid=User id 为用户的唯一标识\n- c=Country 为国家名，可选，为2个字符长\n- o=Organization 为组织名，可选，可以3—64个字符长\n\n## 二、 手动安装和配置 LDAP\n\n### 2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)\n```\nsudo apt install  -y slapd ldap-utils\n```\n\n### 2.2  重新配置 OpenLDAP，创建 base dn\n```\nsudo dpkg-reconfigure slapd   # 主要配置密码 (密码在下一步重置，便于配置连接)，DNS domain name(即 LDAP 服务中的 base dn)\n\n\t 说明：\n\t第一步回答 No\n\t第二步填写域名，比如 mycompany.com\n\t第三步填写组织名，比如 Company\n\t第四步填写管理员密码，比如 secret；第五步确认管理员密码\n\t第六步选择使用的数据库后端，比如 MDB\n\t第七步选择在清除 slapd 时是否移除数据库，比如 Yes\n\t第八步选择是否移除旧数据库，比如 Yes\n```\n\n### 2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码\n```shell\nslappasswd\n\t{SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n\n- 通过数据库修改admin用户的ldif文件\n```ldif\n/etc/ldap/slapd.d/cn\\=config/olcDatabase\\=\\{1\\}mdb.ldif\n\tolcDatabase: {1}mdb\n\tolcSuffix: dc=example,dc=top\n\tolcRootDN: cn=admin,dc=example,dc=top\n\tolcRootPW: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n- olcDatabase: 定义使用的后端数据存储格式,遵循默认\n- olcSuffix: 设置 LDAP 服务的根\n- olcRootDN: 设置管理员用户的 dn\n- olcRootPW: 管理员用户的密码\n- 修改后重启服务\n```\nsudo slaptest -u   # 检查配置文件\nsudo systemctl enable slapd  --now\n\nsudo slapcat        # 输出看到当前数据库内容\n```\n\n### 2.4 正确的修改olcRootPW: 管理员用户的密码\n\n```\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nreplace: olcRootPW\nolcRootPW: example2020  # 保存在数据库文件中的时候将会被加密\n```\n\n```\nldapmodify -Y EXTERNAL -H ldapi:/// -f passmodify.ldif\n```\n\n```\n同时进入web ui，修改admin账户的密码，如果不修改两个密码都能管理域，二者修改一致之后，才是新的管理密码生效\n```\n\n### 2.5 简单结构展示\n\n略\n### 2.6 创建base dn \n\n#### 2.6.1 查看LDAP服务器的根目录信息\n```\nsudo ldapsearch -x -LLL -b '' -s base '(objectclass=*)'\n\tdn:\n\tobjectClass: top\n\tobjectClass: OpenLDAProotDSE\n```\n\n#### 2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码\n```\n-\ndn: dc=example,dc=top\nchangetype: add\nobjectClass: top\nobjectClass: domain\n\n\n-\ndn: o=example,dc=example,dc=top\nchangetype: add\nobjectClass: organization\no: example\n```\n\n```\nldapmodify -x -D \"cn=admin,dc=example,dc=top\" -w example@2020  -f organization.ldif\n```\n\n### 2.7 创建多个 DIT + base dn （可以考虑尝试后端用 `mysql` 做数据库）\n#### 2.7.1 为新的库，准备存储路径，并通过`apparmor`做权限限制\n```\nmkdir  /var/lib/ldap2\nchown openldap:openldap  /var/lib/ldap2\nvim /etc/apparmor.d/usr.sbin.slapd\n\t\t# the databases and logs\n\t\t/var/lib/ldap2/ r,\n\t\t/var/lib/ldap2/** rwk,\n\t\t\n\t\t# lock file\n\t\t/var/lib/ldap2/alock kw,\n\nsudo systemctl  reload  apparmor \n```\n\n#### 2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）\n```\ndn: olcDatabase={2}mdb,cn=config\nchangetype: add\nobjectClass: olcDatabaseConfig\nobjectClass: olcMdbConfig\nolcDbDirectory: /var/lib/ldap2/\nolcDatabase: {2}Mdb\nolcDbIndex: objectClass eq\nolcDbIndex: cn,uid eq\nolcDbIndex: uidNumber,gidNumber eq\nolcDbIndex: member,memberUid eq\nolcLastMod: TRUE\nolcMonitoring: TRUE\nolcDBNoSync: TRUE\nolcAccess: {0}to attrs=userPassword by self write by anonymous auth by * non\n e\nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcSuffix: dc=example,dc=tech\nolcRootDN: cn=admin,dc=example,dc=tech\nolcRootPW: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n\n```\nsudo  ldapmodify -Y EXTERNAL -H ldapi:/// -f domian2.ldif\n```\n\n#### 2.7.3 新增并设置管理员\n```\n-\ndn: cn=admin,dc=example,dc=tech\nobjectClass: simpleSecurityObject\nobjectClass: organizationalRole\ncn: admin\nuserPassword: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n==========================\n# 以下是playbook中模板文件\n-\ndn: cn=admin,{{ item.base_dn }}  \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n\n```\nsudo ldapadd -x -D \"cn=admin,dc=example,dc=tech\" -w example@2020 -f basedn2.ldif\n```\n\n#### 2.7.4 多 DIT 跨域 ACL\n- 查询服务器的域\n```\nldapsearch -x -H ldap://10.13.3.107 -b \"\" -s base namingContexts\n```\n\n- 设置一个全权限的 acl ，跨域访问，相应的用户需已经提前创建\n\n```\n让这个dn 用户: cn=user.tech,dc=example,dc=tech ;  可以阅读这个base dn : dc=example,dc=top 下的所有条目.\n对应关系：数据库----{1}mdb  存储的数据是来自 dn: dc=example,dc=top 。即，对谁的访问则将 acl 添加在谁的库下  \n\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {2}to dn.subtree=\"dc=example,dc=top\" by dn.base=\"cn=user.tech,dc=example,dc=tech\" read\n```\n\n```\nldapmodify   -Y   EXTERNAL   -H   ldapi:///   -f  xxx\n```\n#### 2.7.5 测试\n```\nroot@example-sys-test-06:/etc/ldap/example# ldapsearch -x -b \"dc=example,dc=top\" -D \"cn=user.tech,dc=example,dc=tech\" -w example@2020\n\t\t# extended LDIF\n\t\t#\n\t\t# LDAPv3\n\t\t# base <dc=example,dc=top> with scope subtree\n\t\t# filter: (objectclass=*)\n\t\t# requesting: ALL\n\t\t#\n\t\t\n\t\t# example.top\n\t\tdn: dc=example,dc=top\n\t\tobjectClass: top\n\t\tobjectClass: domain\n\t\tdc: example\n\t\t\n\t\t# admin, example.top\n\t\tdn: cn=admin,dc=example,dc=top\n\t\tobjectClass: simpleSecurityObject\n\t\tobjectClass: organizationalRole\n\t\tcn: admin\n\t\t\n\t\t# search result\n\t\tsearch: 2\n\t\tresult: 0 Success\n\t\t\n\t\t# numResponses: 3\n\t\t# numEntries: 2\nroot@example-sys-test-06:/etc/ldap/example# ldapsearch -x -b \"dc=example,dc=tech\" -D \"cn=admin,dc=example,dc=top\" -w example@2020\n\t\t# extended LDIF\n\t\t#\n\t\t# LDAPv3\n\t\t# base <dc=example,dc=tech> with scope subtree\n\t\t# filter: (objectclass=*)\n\t\t# requesting: ALL\n\t\t#\n\t\t\n\t\t# search result\n\t\tsearch: 2\n\t\tresult: 32 No such object\n\t\t\n\t\t# numResponses: 1\n```\n\n- 测试的日志\n```\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 fd=12 ACCEPT from IP=127.0.0.1:59834 (IP=0.0.0.0:389)\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 BIND dn=\"cn=user.tech,dc=example,dc=tech\" method=128\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 BIND dn=\"cn=user.tech,dc=example,dc=tech\" mech=SIMPLE ssf=0\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 RESULT tag=97 err=0 text=\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=1 SRCH base=\"dc=example,dc=top\" scope=2 deref=0 filter=\"(objectClass=*)\"\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=1 SEARCH RESULT tag=101 err=0 nentries=2 text=\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=2 UNBIND\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 fd=12 closed\n=================\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 fd=12 ACCEPT from IP=127.0.0.1:34916 (IP=0.0.0.0:389)\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" method=128\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" mech=SIMPLE ssf=0\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 RESULT tag=97 err=0 text=\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=1 SRCH base=\"dc=example,dc=tech\" scope=2 deref=0 filter=\"(objectClass=*)\"\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=1 SEARCH RESULT tag=101 err=32 nentries=0 text=\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=2 UNBIND\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 fd=12 closed\n```\n\n## 三、 web管理器配置\n\n### 3.1 安装  LAM （用于管理的Web UI）\n```\napt-get install ldap-account-manager\n```\n访问 http://ip/lam ，lam的所有配置都可以在web端配置，不需要去服务器上修改一行代码\n\n#### 3.1.1 LAM configuration ([helm 安装的主要修改内容](https://check-lc.github.io/ops_blog/2023/12/04/the-first-time-using-helm-charts/))\n<pre>\n主要内容：\n  LDAP_DOMAIN: example.net;ibexample.com\n  LDAP_BASE_DN: dc=example,dc=net;dc=ibexample,dc=com\n  LDAP_SERVER: ldaps://ldap01.example.net\n  LDAP_USER: cn=administrator,dc=example,dc=net\n  LAM_LANG: zh_CN\n  LAM_PASSWORD: lam\n</pre>\n\n- tree view编辑更高效\n\n- 如果选择 docker 安装镜像：ghcr.io/ldapaccountmanager/lam:8.4@sha256:283726bd23510f1c3bfbdcbfe861e6599e070616543aed02e9756075c97a9938\n#### 3.1.3 Nginx反向代理 LAM Web UI\n```\nupstream lam {\n  server 10.13.3.108:8001;\n}\n\nserver {\n  listen 80;\n  server_name lam.example.net;\n  return 301 https://$server_name$request_uri;\n}\n\nserver {\n  server_name lam.example.net;\n  listen 443 ssl;\n  ssl_certificate webmin/tls_ca.pem;\n  ssl_certificate_key webmin/tls_key.pem;\n\n  location / {\n     proxy_pass http://lam/;\n     proxy_set_header Host $host;\n     proxy_set_header X-Real-IP $remote_addr;\n     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n#     proxy_set_header X-Forwarded-Proto \"https\";\n     proxy_read_timeout 1800s;\n     proxy_http_version 1.1;\n     proxy_set_header Upgrade $http_upgrade;\n     proxy_set_header Connection \"upgrade\";\n    }\n  }\n```\n\n### 3.2 测试 phpldapadmin\n```\nSetting up php8.1 (8.1.2-1ubuntu2.14)                       # 版本信息，配置文件完整，存在证书认证并可以指定路径\nSetting up php (2:8.1+92ubuntu1) \nSetting up phpldapadmin (1.2.6.3-0.2)                                       \n```\n#### 3.2.1 安装\n```\napt-get install phpldapadmin -y\nnano /etc/phpldapadmin/config.php\n\t$servers->setValue('server','name','My LDAP Server');                      # 辨识，区分的作用\n\t$servers->setValue('server','host','69.87.216.102');                              #  修改ip为服务器 ip\n\t$servers->;setValue('server','base',array('dc=example,dc=com'));                    # 修改 array 内容为需求的根\n\t$servers->setValue('login','auth_type','session');                                              \n\t$servers->setValue('login','bind_id','cn=admin,dc=example,dc=com');           #   绑定登录帐号admin，相应修改 dn 号即可\n\t$servers->setValue('auto_number','min',array('uidNumber'=>10000,'gidNumber'=>10000));   # 规定 uid，gid 数字表示的起始范围\n```\n#### 3.2.2 为 phpLDAPadmin 配置 Apache\n```\na2dissite 000-default.conf        # 禁用默认的 Apache 虚拟主机配置文件\nsystemctl restart apache2          \n```\n\n## 四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)\n[模式介绍](https://darkdark.top/ch5-replication.html)\n### 4.1 master 加载同步模块\n```\ncat /etc/ldap/mod_syncprov.ldif\n\t\tdn: cn=module,cn=config\n\t\tobjectClass: olcModuleList\n\t\tcn: module\n\t\tolcModulePath: /usr/lib/ldap\n\t\tolcModuleLoad: syncprov.la          # 此配置和上一句配置，实际是在请求这个路径的文件，/usr/lib/ldap/syncprov.la，不确定的可以用 find 查找\n\nldapadd -Y EXTERNAL -H ldapi:/// -f ./mod_syncprov.ldif\n```\n### 4.2 同步设置\n```\nroot@example-sys-test-06:/etc/ldap# cat syncprov.ldif \n\t\tdn: olcOverlay=syncprov,olcDatabase={1}mdb,cn=config       # 此处需要确认自己的数据库是什么样的，{2}hdb--旧版本默认 / {1}mdb--新版本默认\n\t\tobjectClass: olcOverlayConfig\n\t\tobjectClass: olcSyncProvConfig\n\t\tolcOverlay: syncprov\n\t\tolcSpCheckpoint: 100 10\n\t\tolcSpSessionLog: 100\n\nldapadd -Y EXTERNAL -H ldapi:/// -f ./syncprov.ldif                             # 修改并应用条目到 LDAP 服务  -Y EXTERNAL    将使用服务器配置的外部身份验证方法进行身份验证，而不是使用用户名和密码; -H 指定服务器连接; -f 指定文件\n```\n### 4.3 从服务器配置\n```\nroot@example-sys-test-07:/etc/ldap# cat syncrepl.ldif\n\t\tdn: olcDatabase={1}mdb,cn=config\n\t\tchangetype: modify\n\t\tadd: olcSyncRepl\n\t\tolcSyncRepl: rid=002\n\t\t  provider=ldap://10.13.3.106:389/        # 此处开始与上一行有缩进\n\t\t  bindmethod=simple\n\t\t  binddn=\"cn=admin,dc=example,dc=top\"\n\t\t  credentials=example@2020      \n\t\t  searchbase=\"dc=example,dc=top\"\n\t\t  scope=sub\n\t\t  schemachecking=on\n\t\t  type=refreshAndPersist\n\t\t  retry=\"5 5 300 +\"\n\t\t  attrs=\"*,+\"\n\t\t  interval=00:00:00:3\n\nldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/syncrepl.ldif\n```\n- 运行中，修改主服务器内数据后，对从服务器u做刷新，可以看到是否同步\n\n参数说明：\n- provider 为ldap master/slave的地址 ;\n- binddn：为域的基本信息，注这里一定要用管理员进行登录，否则同步不到用户的密码。\n- credentials: ldap管理员的密码\n- searchbase：选择要同步的独立域，根节点\n- scope：设置所有的条目匹配\n- schemachecking：设置同步更新时间检测\n- type：同步模式为refreshAndPersist， refreshOnly 模式下后续操作由客户端轮询完成\n- retry:同步更新重试次数和时间刚开始的5秒重试5次，以后每300秒重试一次\n- attrs:复制全部属性\n- interval 这里设置更新时间，这里为3秒一次，倒数第二个是分钟 以此类推。\n\n\n## 四、 镜像复制（互为主从）\n[模式介绍](https://darkdark.top/ch5-replication.html)\n### 4.1 为某域编辑 mirrorsync.ldif\n```\ndn: cn=module,cn=config         # 此段配置加载s ync 模块\nobjectClass: olcModuleList\ncn: module\nolcModulePath: /usr/lib/ldap\nolcModuleLoad: syncprov.la     # 此配置和上一句，实际是在请求这个路径的文件，/usr/lib/ldap/syncprov.la，不确定的可 find 查找\n\n-\ndn: olcOverlay=syncprov,olcDatabase={1}mdb,cn=config        \n\t # 此处需确认自己的数据库，{2}hdb--为旧版本默认 / {1}mdb--为新版本默认。路径 /etc/ldap/slapd.d/cn\\=config/olcDatabase\\=\\{1\\}mdb.ldif\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 100\n\n-\ndn: cn=config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 0                                        # 用于标识本机的 server id\n\ndn: olcDatabase={1}mdb,cn=config      # 以下配置用于开启复制，指定主服务器\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid=000                             # 标识唯一的 replica id\n  provider=ldaps://ldap01.example.top       # 看上述记录介绍参数\n  bindmethod=simple\n  binddn=\"cn=admin,dc=example,dc=top\"\n  credentials=example@2020\n  searchbase=\"dc=example,dc=top\"\n  tls_reqcert=allow\n  scope=sub\n  schemachecking=on\n  type=refreshAndPersist\n  retry=\"30 5 300 3\"\n  interval=00:00:05:00\n-\nadd: olcMirrorMode                        # 开启 mirror mode\nolcMirrorMode: TRUE\n\n```\n\n### 4.2 ldap01.example.top下编辑 mirrorsync.ldif\n```\ndn: cn=module,cn=config\nobjectClass: olcModuleList\ncn: module\nolcModulePath: /usr/lib/ldap\nolcModuleLoad: syncprov.la\n\n-\ndn: olcOverlay=syncprov,olcDatabase={1}mdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 100\n\n-\ndn: cn=config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 1\n\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid=001\n  provider=ldaps://ldap.example.top\n  bindmethod=simple\n  binddn=\"cn=admin,dc=example,dc=top\"\n  credentials=example@2020\n  searchbase=\"dc=example,dc=top\"\n  tls_reqcert=allow\n  scope=sub\n  schemachecking=on\n  type=refreshAndPersist\n  retry=\"30 5 300 3\"\n  interval=00:00:05:00\n-\nadd: olcMirrorMode\nolcMirrorMode: TRUE\n\n```\n#### 4.2.1 加载配置\n```\nldapadd -Y EXTERNAL -H ldapi:/// -f mirrorsync.ldif\n```\n\n## 五、 TLS加密（自签名/权威证书）\n（自签名证书加密连接 nextcloud 失败，使用不便，采用 权威证书（多域合一）或stunnel）\n\n### 5.1 CA中心创建证书\n\t此时使用LDAP 主服务器 作为 CA 中心，自签名\n- 安装 gnutls-bin 和 ssl-cert 包\n```\nsudo apt install gnutls-bin ssl-cert\n```\n- 为证书授权中心创建私钥\n```\nsudo certtool --generate-privkey --bits 4096 --outfile /etc/ssl/private/mycakey.pem\n```\n- 创建模板文件来定义CA\n```\n/etc/ssl/ca.info\n\t cn = example (example company)  \n\t ca\n\t cert_signing_key\n\t expiration_days = 3650\n```\n- 创建自签名 CA (根)证书\n```\nsudo certtool --generate-self-signed \\\n--load-privkey /etc/ssl/private/mycakey.pem \\\n--template /etc/ssl/ca.info \\\n--outfile /usr/local/share/ca-certificates/mycacert.crt\n```\n- Note：\n\t`--outfile`路径是正确的，将CA证书写入`/usr/local/share/ca-certificates`。\n\t**update-ca-certificates** 将从这里获取受信任的本地CA。如果要从`/usr/share/ca-certificates`获取CA，需要调用`dpkg-reconfigure ca-certificates`\n\n- 将新的 CA 根证书添加到受信任 CA 列表\n```\nsudo update-ca-certificates     # 会创建一个/etc/ssl/certs/mycacert.pem符号链接，指向/usr/local/share/ca-certificates中的真实文件\n```\n### 5.2 创建 LDAP 服务的服务器私钥与证书\n- 创建私钥\n```\nsudo certtool --generate-privkey \\\n--bits 2048 \\\n--outfile /etc/ldap/ldap01_slapd_key.pem\n```\n- 服务器信息文件\n```\n/etc/ssl/ldap01.info\n\torganization = example\n\tcn = ldap01.example.top                     # 服务器证书的DN必须使用CN属性来命名服务器，并且CN必须携带服务器的完全限定域名，dns 需要有 A 记录解析\n\ttls_www_server\n\tencryption_key\n\tsigning_key\n\texpiration_days = 365\n证书有效期为1年，仅对_`ldap01`_主机名有效\n```\n- 创建LDAP服务器的证书\n```\nsudo certtool --generate-certificate \\\n--load-privkey /etc/ldap/ldap01_slapd_key.pem \\\n--load-ca-certificate /etc/ssl/certs/mycacert.pem \\\n--load-ca-privkey /etc/ssl/private/mycakey.pem \\\n--template /etc/ssl/ldap01.info \\\n--outfile /etc/ldap/ldap01_slapd_cert.pem\n```\n- 调整权限\n```\nsudo chgrp openldap /etc/ldap/ldap01_slapd_key.pem\nsudo chmod 0640 /etc/ldap/ldap01_slapd_key.pem\n```\n- ca根证书加入到受信列表\n```\nsudo cp   cacertificatefile  /usr/local/share/ca-certificates/mycacert.crt\nsudo update-ca-certificates\n```\n  \n- 对LDAP服务配置证书\n```\ndn: cn=config\nadd: olcTLSCACertificateFile\nolcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem\n-\nadd: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/ldap/ldap01_slapd_cert.pem\n-\nadd: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/ldap/ldap01_slapd_key.pem\n```\n- 配置slapd-config数据库：\n```\nsudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif \n```\n- 报错调整，更改`certinfo.ldif`，将`add`改成了`replace`，可以解决以下问题。修改后再次执行`ldapmodify`\n```\nldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif \n\tSASL/EXTERNAL authentication started SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth \n\tSASL SSF: 0 \n\tmodifying entry \"cn=config\" ldap_modify: Inappropriate matching (18) \n\tadditional info: modify/add: olcTLSCACertificateFile: no equality matching rule\n```\n- ldap-client增添配置文件\n```\n/etc/ldap/ldap.conf\n\t# LDAP Defaults\n\t# See ldap.conf(5) for details\n\t# This file should be world readable but not world writable.\t\n\tBASE       dc=example,dc=top                                                      # LDAP服务的基础DN\n\tURI ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径\n\tTLS_REQCERT demand                                                        # \"demand\"，表示需要验证服务器的证书\n```\n- 需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd\n```\n/etc/default/slapd\n\tSLAPD_SERVICES=\"ldap:/// ldapi:/// ldaps:///\"\n```\n- 测试启动 TLS\n```\nldapwhoami -x -ZZ -H ldap://ldap01.example.com\nanonymous\n```\n- 测试连接\n```\nldapwhoami -x -H ldaps://ldap01.example.com\nanonymous\n```\n\n### 5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器\n-  指定目录保存\n```\nmkdir ldap02-ssl\ncd ldap02-ssl\ncerttool --generate-privkey \\\n--bits 2048 \\\n--outfile ldap02_slapd_key.pem\n```\n- 编辑信息文件ldap02.info\n```\norganization = example\ncn = ldap02.example.top                      \ntls_www_server\nencryption_key\nsigning_key\nexpiration_days = 365\n```\n- 创建证书\n```\nsudo certtool --generate-certificate \\\n--load-privkey ldap02_slapd_key.pem \\\n--load-ca-certificate /etc/ssl/certs/mycacert.pem \\\n--load-ca-privkey /etc/ssl/private/mycakey.pem \\\n--template ldap02.info \\\n--outfile ldap02_slapd_cert.pem\n```\n\n```\ncp /etc/ssl/certs/mycacert.pem .\nscp -r ldap02-ssl user@ldap02_ip:\n```\n- 从服务器中安装证书\n```\nsudo cp ldap02_slapd_cert.pem ldap02_slapd_key.pem /etc/ldap\nsudo chgrp openldap /etc/ldap/ldap02_slapd_key.pem\nsudo chmod 0640 /etc/ldap/ldap02_slapd_key.pem\nsudo cp mycacert.pem /usr/local/share/ca-certificates/mycacert.crt\nsudo update-ca-certificates\n```\n- 对LDAP服务配置证书 `./certinfo.ldif `\n```\ndn: cn=config\nadd: olcTLSCACertificateFile\nolcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem\n-\nadd: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/ldap/ldap02_slapd_cert.pem\n-\nadd: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/ldap/ldap02_slapd_key.pem\n```\n- 配置slapd-config数据库：\n```\nsudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif \n```\n- 增添配置文件\n```\n/etc/ldap/ldap.conf\n\tBASE       dc=example,dc=top                                                      # LDAP服务的基础DN\n\tURI ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径\n\tTLS_REQCERT demand                                                        # \"demand\"，表示需要验证服务器的证书\n```\n- 需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd\n```\n/etc/default/slapd\n\tSLAPD_SERVICES=\"ldap:/// ldapi:/// ldaps:///\"\n```\n- 测试启动 TLS\n```\nldapwhoami -x -ZZ -H ldap://ldap02.example.top\nanonymous\n```\n- 测试连接\n```\nldapwhoami -x -H ldaps://ldap02.example.top\nanonymous\n```\n\n### 5.4 使用合法证书\n\n- 将新的 CA 根证书添加到受信任 CA 列表（客户端操作，权威证书按理不需要拷贝，未测试）\n```\nsudo   cp   _.example.top-chain.pem   /usr/local/share/ca-certificates/mycacert.crt\nsudo update-ca-certificates\n```\n\n- 准备服务器证书和私钥（服务端）\n```\n ls /etc/ldap\n\tcertinfo.ldif   _.example.top-crt.pem   _.example.top-key.pem\nsudo chgrp openldap /etc/ldap/_.example.top-key.pem\nsudo chmod 0640 /etc/ldap/_.example.top-key.pem\n```\n\n- certinfo.ldif\n```\ndn: cn=config\nchangetype: modify\nreplace: olcTLSCACertificateFile\nolcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem\n-\nreplace: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/ldap/_.example.top-crt.pem\n-\nreplace: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/ldap/_.example.top-key.pem\n\n```\n\n```\nsudo ldapadd  -Y   EXTERNAL  -H  ldapi:///   -f    certinfo.ldif\n```\n\n\n- 增添配置文件，这是客户端需要连接 ldap 服务器使用的配置。可以忽略。\n```\n/etc/ldap/ldap.conf\n\tBASE       dc=example,dc=top                                                      # LDAP服务的基础DN\n\t[[URI]] ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径，必需\n\tTLS_REQCERT allow                                                      # \"demand\"，表示需要验证服务器的证书\n```\n- 启用 ldaps，重启 slapd\n```\n/etc/default/slapd\n\tSLAPD_SERVICES=\"ldap:/// ldapi:/// ldaps:///\"\n```\n\n\n### 5.5 使用 nextcloud 测试加密连接\n\n- docker 安装 nexcloud，登录 UI ，右上角点击账户，选择应用\n- 应用捆绑包，启用 LDAP user and group backend\n- 设置连接\n- ldaps连接(严格一致才是tls加密，nextcloud应该只信任权威证书)\n\n- 明文传输 \n\n### 5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)\n\n链路： ldap user ui  ---- stunnel client  accept  ----  stunnel client connect  ---- stunnel server accept  ---- stunnel server connect ----ldap server port\n```\napt install -y stunnel4\nvim /etc/default/stunnel4\n\tENABLED=1\n```\n\n```\n# stunnel 服务端\n\tcert = /etc/stunnel/stunnel.pem\n\tkey = /etc/stunnel/stunnel-key.pem\n\tverify = 3\n\tclient = no\n\tdebug = 6\n\tpid = /var/run/stunnel4/stunnel4.pid\n\t\n\t[ldap]\n\taccept = 10.13.3.106:6360                # 监听 stunnel 服务的流量，客户端（是指stunnel 客户端）将连接此目标并发送流量到这里\n\tconnect = 10.13.3.106:389                # 转发到 stunnel 加密连接的服务的端口\n\tCAfile = /etc/stunnel/stunnel.pem\n\n# stunnel 客户端\n\tcert = /etc/stunnel/stunnel.pem\n\tkey = /etc/stunnel/stunnel-key.pem\n\tverify = 3\n\tclient = yes\n\tdebug = 6\n\tsetuid = stunnel4\n\tsetgid = stunnel4\n\tpid = /var/run/stunnel4/stunnel4.pid\n\t\n\t[ldap]\n\taccept = 10.13.3.107:389                # 监听 stunnel 服务的流量，客户端（是指ldap的客户端）将连接此目标并发送流量到这里\n\tconnect = 10.13.3.106:6360              # 加密连接并转发到 stunnel 的服务端\n\tCAfile = /etc/stunnel/stunnel.pem\n```\n\n```\n/etc/phpldapadmin/config.php\n\t$servers->setValue('server','host','69.87.216.102');  # 指向 stunnel 客户端，和他本地监听的端口\n\t$servers->setValue('server','port',389);\t\n```\n## 六、 其他模块\n### 6.1 日志模块\n```\n/etc/ldap/loglevel.ldif\n\tdn: cn=config\n\tchangetype: modify\n\treplace: olcLogLevel\n\tolcLogLevel: stats\n\nldapmodify  -Y  EXTERNAL  -H  ldapi:///  -f  loglevel.ldif               # 日志在/var/log/syslog | grep slapd , 比默认的级别详细\n```\n### 6.2 memberOf 开启\n```\n/etc/ldap/refint.ldif\n\t# enable_refint.ldif\n\tdn: cn=module{0},cn=config\n\tchangetype: modify\n\tadd: olcModuleLoad\n\tolcModuleLoad: refint.la\n\t-\n\tdn: olcOverlay=refint,olcDatabase={1}mdb,cn=config\n\tchangetype: add\n\tobjectClass: olcOverlayConfig\n\tobjectClass: olcRefintConfig\n\tolcOverlay: refint\n\nldapadd -Q -Y EXTERNAL -H ldapi:// -f refint.ldif\n```\n\n```\n/etc/ldap/memberof.ldif\n\tdn: cn=module,cn=config\n\tchangetype: add\n\tcn: module\n\tobjectClass: olcModuleList\n\tolcModulePath: /usr/lib/ldap\n\t\n\tdn: cn=module{0},cn=config\n\tchangetype: modify\n\tadd: olcModuleLoad\n\tolcModuleLoad: memberof.la\n\t\n\tdn: olcOverlay=memberof,olcDatabase={1}mdb,cn=config\n\tchangetype: add\n\tobjectClass: olcConfig\n\tobjectClass: olcMemberOf\n\tobjectClass: olcOverlayConfig\n\tobjectClass: top\n\tolcOverlay: memberof\n\tolcMemberOfDangling: ignore\n\tolcMemberOfRefInt: TRUE\n\tolcMemberOfGroupOC: groupOfNames\n\tolcMemberOfMemberAD: member\n\tolcMemberOfMemberOfAD: memberOf\n\nldapmodify -Y EXTERNAL -H ldapi:/// -f memberof.ldif\n```\n\n- 为条目添加此属性：LDIF文件中先创建用户的dn，然后创建目标组的dn，在创建组的时候将关联的用户写在member属性中\n\n### 6.3 Self Service Password 自助密码管理\n- 容器部署，解决 php 依赖准备繁琐\n- 镜像 ltbproject/self-service-password:1.5.3\n- 为 admin 用户设置修改密码的权限\n```\n下列权限可以使得 \"admin,example,net\" 对这个域 \"dc=example,dc=tech\" 做用户添加、属性修改\nolcAccess: {0}to attrs=userPassword,shadowLastChange by dn=\"cn=admin,dc=example,dc=net\" write by anonymous auth by self write by * none\nolcAccess: {1}to dn.subtree=\"dc=example,dc=tech\" by dn.base=\"cn=admin,dc=example,dc=net\" write\n```\n- 需要对企业邮箱帐号开启设置-帐号与安全-客户端设置-客户端授权密码\n- ssp.conf.php  成功配置版本，并映射到容器： /home/example/sspasswd/conf.php:/var/www/conf/config.inc.local.php\n```php\n<?php\n$debug = false;\n$keyphrase = \"example\";\n$use_sms = false;\n$use_questions = false;\n$lang = \"cn,zh-CN\";\n$use_change = true;\n#$reset_url = $_SERVER['HTTP_X_FORWARDED_PROTO'] . \"://\" . $_SERVER['HTTP_X_FORWARDED_HOST'] . $_SERVER['SCRIPT_NAME'];\n$reset_url = \"https://ssp.example.net\" . $_SERVER['HTTP_X_FORWARDED_HOST'] . $_SERVER['SCRIPT_NAME'];\n$show_menu = false;\n$logo = \"images/logo.png\";                # 这两项在配置前，需要确保图片映射路径在容器内部的 /var/www/html/images 下\n$background_image = \"images/back.png\";\n$default_action = \"sendtoken\";        # 默认展示在首页的修改密码的方式\n$show_menu = false;              # 关闭顶部的修改方式选择菜单\n\n# LDAP\n\n$ldap_url = \"ldap://10.13.3.107/\";\n$ldap_starttls = false;\n$ldap_binddn = \"cn=admin,dc=example,dc=net\";\n$ldap_bindpw = 'example@2020';\n#$ldap_bindpw = \"{SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\";\n$ldap_base = \"dc=example,dc=net\";\n#$ldap_base = \"dc=example,dc=tech\";    # 在这里同时书写两个，只会生效后一个域, 使用两个实例连接 ldap 服务\n$ldap_fullname_attribute = \"cn\";\n$ldap_filter = \"(&(objectClass=inetOrgPerson)($ldap_fullname_attribute={login}))\";\n$ldap_use_exop_passwd = false;\n$ldap_use_ppolicy_control = false;\n$TLS_REQCERT = \"allow\";\n\n# email\n$mail_attributes = array(\"mail\", \"gosaMailAlternateAddress\", \"proxyAddresses\");\n$mail_address_use_ldap = true;\n$mail_from = \"user5@example.net\";\n$mail_from_name = \"密码自主修改服务\";\n$mail_signature = \"如有疑问,请联系运维同事,英博智云.\";\n$notify_on_change = false;\n$mail_protocol = 'smtp';\n$mail_smtp_host = 'smtphz.qiye.163.com';\n$mail_smtp_auth = true;\n$mail_smtp_user = \"user5@example.net\";\n$mail_smtp_pass = 'TdhYDdgvN7Hpky5a';\n$mail_smtp_port = 465;\n$mail_smtp_timeout = 30;\n$mail_smtp_keepalive = false;\n$mail_smtp_secure = 'ssl';\n$mail_smtp_autotls = false;\n$mail_smtp_options = array();\n$mail_contenttype = 'text/plain';\n$mail_wordwrap = 0;\n$mail_charset = 'utf-8';\n$mail_priority = 3;\n\n# password policy\n$hash = \"SSHA\"; # 修改的用户密码传递过程中会采取这里指定的加密\n$pwd_min_length = 8;\n$pwd_max_length = 20;\n$pwd_min_lower = 1;\n$pwd_min_upper = 1;\n$pwd_min_digit = 1;\n$pwd_min_special = 1;\n$pwd_special_chars = \"^a-zA-Z0-9\";\n$pwd_complexity = 4;\n$pwd_no_reuse = true;\n$pwd_forbidden_words = array(\"example\", \"example\", \"example\", \"password\");\n$pwd_show_policy_pos = \"above\";\n$pwd_show_policy = \"onerror\";\n?>\n```\n\n```\ndocker run -p 8000:80 \\\n> --restart=always \\\n> --name sspass \\\n> -v /home/example/sspasswd/conf.php:/var/www/conf/config.inc.local.php \\\n> -itd docker.io/ltbproject/self-service-password\n```\n\n#### 6.3.1 不能进入修改链接 Token is not valid\n```\n注释了这两项\n#$use_tokens = true;\n#$crypt_tokens = true;\n```\n\n#### 6.3.2 反向代理 Self Service Password\n```\nupstream ssp {\n  server 10.13.3.108:8000;\n}\n\nserver {\n    listen 80;\n    server_name ssp.example.net;\n    return 301 https://$server_name$request_uri;\n}\nserver {\n    listen 443 ssl ;\n    server_name ssp.example.net;\n    ssl_certificate webmin/tls_ca.pem;\n    ssl_certificate_key webmin/tls_key.pem;\n\n    location / {\n      proxy_pass http://ssp;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto \"https\";\n      proxy_read_timeout 1800s;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection \"upgrade\";\n    }\n}\n```\n\n###  6.4 LDAP 对目录信息的数据做备份还原和迁移\n####  6.4.1 备份\n\n```\nsudo slapcat -n 3 -l ./back3.ldif           # -n 指定数据库编号，数字对应各个dit的数据库编号( 配置数据库----olcDatabase={0}config.ldif; 目录信息数据库----olcDatabase={1}mdb.ldif )\n```\n\n#### 6.4.2 恢复\n原服务器上恢复，服务需要暂停\n```\nsudo systemctl stop slapd\n```\n\n配置目录一般位于 `/etc/openldap/slapd.d`，将原有配置删除，然后使用 `slapadd` 导入新的配置\n```\n$ rm -rf /etc/ldap/slapd.d/*\n$ slapadd  -n  0  -F  /etc/ldap/slapd.d  -l  ./config.2021-09-18.ldif\n$ chown -R openldap:openldap /etc/ldap/slapd.d\n```\n\n数据目录一般位于 `/var/lib/ldap-*`，模拟时，将原有数据删除，然后使用 `slapadd` 导入新的数据：\n```\n$ rm  -rf  /var/lib/ldap-example/*         # 定制了不同的$default_action = \"sendtoken\";\n$show_menu = false;dit有不同的目录分别存储不同domain的内容，注意，导入前目录必需首先存在，且权属 openldap:openldap。\n$ slapadd -n 1 -F /etc/openldap/slapd.d -l ./data.2021-09-18.ldif\n$ chown -R openldap:openldap  /var/lib/ldap-example\n$ systemctl start slapd\n```\n#### 6.4.3 openldap的迁移\nplaybook 新建的服务器，执行恢复\n```\nslapadd -n 1 -F /etc/openldap/slapd.d -l ./data.2021-09-18.ldif\n\n[[如果导入失败，或者数据已存在，删除rm]] -rf /var/lib/ldap/*  重新导入\n```\n\n\n## 七、 命令资料\n> [来自此处](https://blog.csdn.net/jenyzhang/article/details/56487627)\n>ldap  \n    |-slapd             目录服务的主要程序  \n    |-slurpd           目录服务进行复制的程序  \n    |-slapadd           向目录中添加数据  \n    |-slapcat           把目录中的条目导出成ldif文件  \n    |-slapindex         重建目录的索引  \n    |-ldapcompare       对目录的条目的属性进行比较  \n    |-ldapadd           向目录服务中添加条目  \n    |-ldapdelete        删除目录中的条目  \n    |-ldapmodify        更新目录中条目的值  \n    |-ldapmodrdn        更改条目的DN  \n    |-ldappasswd        更改条目的密码  \n    |-ldapsearch        对目录进行查询\n\n>ldapadd  \n      -x   进行简单认证  \n      -D   用来绑定服务器的DN  \n      -h   目录服务的地址  \n      -w   绑定DN的密码  \n      -f   使用ldif文件进行条目添加的文件  \n      \n- 例子\n       ldapadd -x -D \"cn=root,dc=starxing,dc=com\" -w secret -f /root/test.ldif  \n       ldapadd -x -D \"cn=root,dc=starxing,dc=com\" -w secret (这样写就是在命令行添加条目)  \n       \n> ldapsearch  \n      -x   进行简单认证  \n      -D   用来绑定服务器的DN  \n      -w   绑定DN的密码  \n      -b   指定要查询的根节点  \n      -H   制定要查询的服务器\n      -s   指定搜索范围的类型\n     \n- 例子\n \tldapsearch -x -D \"cn=root,dc=starxing,dc=com\" -w secret -b \"dc=starxing,dc=com\"  \n       使用简单认证，用 \"cn=root,dc=starxing,dc=com\" 进行绑定，  \n       要查询的根是 \"dc=starxing,dc=com\"。这样会把绑定的用户能访问\"dc=starxing,dc=com\"下的所有数据显示出来。\n       ldapsearch -x -W -D \"cn=administrator,cn=users,dc=osdn,dc=zzti,dc=edu,dc=cn\" -b \"cn=administrator,cn=users,dc=osdn,dc=zzti,dc=edu,dc=cn\" -h troy.osdn.zzti.edu.cn\n\t ldapsearch -b \"dc=canon-is,dc=jp\" -H ldaps://192.168.0.92:636\n\t   (需要修改openldap客户端的配置文件ldap.conf,参考：http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm)\n\n>ldapdelete   \n      ldapdelete -x -D \"cn=Manager,dc=test,dc=com\" -w secret \"uid=test1,ou=People,dc=test,dc=com\"  \n      ldapdelete -x -D 'cn=root,dc=it,dc=com' -w secert 'uid=zyx,dc=it,dc=com'  \n      这样就可以删除'uid=zyx,dc=it,dc=com'记录了，应该注意一点，其下有子条目的不能删除  \n\t\n\t\n- 例子1  递归删除所有：\nldapdelete -x -D 'cn=administrator,dc=example,dc=net' -w example@2020 -r \"ou=example,dc=example,dc=net\"\n\n- 例子2  删除一个acl策略。acl-dele.ldif\n\t   dn: olcDatabase={3}mdb,cn=config\n\t   delete: olcAccess\n\t   olcAccess: {2}\n\t   olcAccess: {3}\n\t   olcAccess: {4}  \n   ldapmodify -Y EXTERNAL -H ldapi:/// -f acl-dele.ldif\n\n  \n> ldappasswd  \n    -x   进行简单认证  \n    -D   用来绑定服务器的DN  \n    -w   绑定DN的密码  \n    -S   提示的输入密码  \n    -s pass 把密码设置为pass  \n    -a pass 设置old passwd为pass  \n    -A   提示的设置old passwd  \n    -H   是指要绑定的服务器  \n    -I   使用sasl会话方式  \n    \n- 例子\n    ldappasswd -x -D 'cm=root,dc=it,dc=com' -w secret 'uid=zyx,dc=it,dc=com' -S  \n       New password:  \n       Re-enter new password:  \n       就可以更改密码了，如果原来记录中没有密码，将会自动生成一个userPassword。  \n    \n> ldapmodify  \n     -a 添加新的条目.缺省的是修改存在的条目.  \n     -C 自动追踪引用.  \n     -c 出错后继续执行程序并不中止.缺省情况下出错的立即停止.比如如果你的ldif 文件内的某个条目在[数据库](http://lib.csdn.net/base/mysql \"MySQL知识库\")内并不存在,缺省情况下程序立即退出,但如果使用了该参数,程序忽略该错误继续执行.  \n     -n 用于调试到服务器的通讯.但并不实际执行搜索.服务器关闭时,返回错误；服务器  \n       打开时,常和-v 参数一起[测试](http://lib.csdn.net/base/softwaretest \"软件测试知识库\")到服务器是否是一条通路.  \n     -v 运行在详细模块.在标准输出中打出一些比较详细的信息.比如:连接到服务器的  \n       ip 地址和端口号等.  \n     -M  打开 manage DSA IT 控制. -MM 把该控制设置为重要的.  \n     -f file 从文件内读取条目的修改信息而不是从标准输入读取.  \n    -x 使用简单认证.  \n    -D binddn 指定搜索的用户名(一般为一dn 值).  \n    -W 指定了该参数,系统将弹出一提示入用户的密码.它和-w 参数相对使用.  \n    -w bindpasswd 直接指定用户的密码. 它和-W 参数相对使用.  \n    -H ldapuri 指定连接到服务器uri(ip 地址和端口号,常见格式为 ldap://hostname:port ).如果使用了-H 就不能使用-h 和-p 参数.  \n    -h ldaphost 指定要连接的主机的名称/ip 地址.它和-p 一起使用 \n    -p ldapport 指定要连接目录服务器的端口号.它和-h 一起使用，如果使用了-h 和-p 参数就不能使用-H 参数.  \n    -Z 使用StartTLS 扩展操作.如果使用-ZZ,命令强制使用StartTLS 握手成功.  \n    -V 启用证书认证功能,目录服务器使用客户端证书进行身份验证,必须与-ZZ 强制启用  \n       TLS 方式配合使用,并且匿名绑定到目录服务器.  \n    -e 设置客户端证书文件,例: -e cert/client.crt  \n    -E 设置客户端证书私钥文件,例: -E cert/client.key  \n\n- 例子\nldapmodify -x -D \"cn=root,dc=it,dc=com\" -W -f modify.ldif    #   将modify.ldif中的记录更新原有的记录。\n\n\n## 八、 参考链接\n[指南](https://github.com/jt6562/LDAP-read-notes/blob/master/ldap-guide/OpenLDAP%E7%AE%A1%E7%90%86%E5%91%98%E6%89%8B%E5%86%8C.md)\n[知识总结](https://www.cnblogs.com/kevingrace/p/5773974.html)\n[参考1](https://www.cnblogs.com/js1314/p/12887893.html)\n[参考2](https://cloud.tencent.com/developer/article/1932586)\n[参考3](https://blog.csdn.net/u011607971/article/details/121126289?spm=1001.2014.3001.5501#t3)\n[Ubuntu wiki](https://ubuntu.com/server/docs/service-ldap-with-tls)\n[tls参考1](https://www.cnblogs.com/shu-sheng/p/14450815.html)\n[tls参考2](https://hmli.ustc.edu.cn/doc/linux/ubuntu-ldap/ubuntu-ldap.html#id14)\n[tls参考3](https://zhuanlan.zhihu.com/p/643010354)\n\n## 九、问题：\n### 9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果\n###  9.2 日志功能开启失败\n\t已经调整日志级别，在系统日志中查看并grep\n### 9.3 证书缺失(只能使用ldap01,这个信息查询）\n\t采取使用权威证书\n### 9.4 重启slap报错 tls init   failed\n\t解决办法：重新生成证书\n### 9.5 报错 ldap_start_tls: Connect error (-11)    \\n    additional info: (unknown error code)\n\t可能是由于服务器证书的通用名（Common Name）字段是否与主机名不一致，请检查主机名和服务器证书\n### 9.6 连接问题\n```\nldapsearch -H ldaps://ldap.example.top  -D \"cn=admin,dc=example,dc=top\" -W            # 在服务器本机执行此查询的报错。但是在另一个机器可以成功查询\n\tldap_sasl_bind(SIMPLE): Can't contact LDAP server (-1)                                 # 配置 ldap.conf 之后成功解决并有输出 tls=demand/allow----作用是证书检查\n```\n### 9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”\n```\n1. 首先尝试重新部署，发现执行镜像复制的剧本之前可以正常创建所有的条目\n    解决：在mirror mode 开启时，需要指定相应的数据库\n2.  shadow context; no update referral  根本原因是需要检查权限\n```\n### 9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询\n- 脚本中的组织信息ldif文件有问题，经测试不影响。\n- memberOf，属性不可单独添加，通过 groupofNames 指定 member 之后会自动关联。已经修正使用方式，结果未改变。\n- 2204 系统和 2004 系统的slapd版本不一致（并没有影响）。\n- 将orgnization的任务和前一部分拆分，否则会出现读取不到 rootdn（手动测试是成功的）（然而脚本中修改后并没有解决这个问题）。\n- 将organization拆分，在此之前重启服务，未解决。\n- 将organization拆分，在此之前先重启虚拟机。（有效、怀疑是服务中某些连接的状态在ansible执行中没有更新）（仍然失效了，经过一夜之后失效）。\n- 另一台2204主机安装正常使用，怀疑虚拟机系统问题。\n\n## 十、 验证\n### 10.1 检测连接命令： \n\n ldaps://    ----ldap over ssl  使用636 ，从连接开始加密   ;        ldap://           ---ldap_start_tls(-ZZ参数):    使用389，从传输开始加密\n```\nldapsearch -H ldaps://ldap01.example.top:636 -D \"cn=admin,dc=example,dc=top\" -W -b \"dc=example,dc=top\" -s sub \"(objectClass=person)\"\n\nldapsearch -H ldap://10.13.3.106  -D \"cn=admin,dc=example,dc=top\" -W -b \"dc=example,dc=top\" -s sub \"(objectClass=person)\"\n\nldapsearch -H ldap://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W -b \"dc=example,dc=top\" -s sub \"(objectClass=person)\"\n```\n### 10.2 验证和日志\ntag 101 应表明在查询; tag 97 是在认证\n```\nldapsearch -H ldap://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W   -ZZ      #  启用了tls功能 ，-ZZ 参数，仍然是 389 端口，连接后在传输过程中加密\n\t\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 fd=14 ACCEPT from IP=10.13.3.107:60674 (IP=0.0.0.0:389)\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 EXT oid=1.3.6.1.4.1.1466.20037\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 STARTTLS\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 RESULT oid= err=0 text=\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 fd=14 TLS established tls_ssf=256 ssf=256\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 BIND dn=\"cn=admin,dc=example,dc=top\" method=128\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 BIND dn=\"cn=admin,dc=example,dc=top\" mech=SIMPLE ssf=0\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 RESULT tag=97 err=0 text=\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=2 SRCH base=\"dc=example,dc=top\" scope=2 deref=0 filter=\"(objectClass=*)\"\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=2 SEARCH RESULT tag=101 err=0 nentries=6 text=\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=3 UNBIND\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 fd=14 closed\n```\n\n```\nldapsearch -H ldap://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W        # 明文传输\n\t\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 fd=14 ACCEPT from IP=10.13.3.107:37760 (IP=0.0.0.0:389)\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" method=128\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" mech=SIMPLE ssf=0\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 RESULT tag=97 err=0 text=\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=1 SRCH base=\"dc=example,dc=top\" scope=2 deref=0 filter=\"(objectClass=*)\"\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=1 SEARCH RESULT tag=101 err=0 nentries=6 text=\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=2 UNBIND\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 fd=14 closed\n```\n\n```\nldapsearch -H ldaps://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W        # 从连接就开始加密\n\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 ACCEPT from IP=10.13.3.107:58726 (IP=0.0.0.0:636)\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 TLS established tls_ssf=256 ssf=256\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" method=128\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" mech=SIMPLE ssf=0\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 RESULT tag=97 err=0 text=\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=1 SRCH base=\"dc=example,dc=top\" scope=2 deref=0 filter=\"(objectClass=*)\"\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=1 SEARCH RESULT tag=101 err=0 nentries=6 text=\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=2 UNBIND\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 closed\n```\n\n```\n ldapsearch -H ldaps://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W -ZZ\n\t\tldap_start_tls: Operations error (1)\n\t        additional info: TLS already started\n\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 ACCEPT from IP=10.13.3.107:39894 (IP=0.0.0.0:636)\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 TLS established tls_ssf=256 ssf=256\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 EXT oid=1.3.6.1.4.1.1466.20037\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 STARTTLS\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 RESULT oid= err=1 text=TLS already started                # 证明二者冲突，不能同时开启\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=1 UNBIND\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 closed\n```\n\n## 十一、应用服务\n### 11.1 建立 ldap 管理/只读帐号\n```\ndn: cn=admin,dc=xxx,dc=xx \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi  \n  \n-  \ndn: cn=reader,dc=xxx2,dc=xx2  \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n\n###  11.2 详细的公司架构 ldif\n```\ndn: ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example  \n  \ndn: ou=example-bod,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-bod  \n  \ndn: cn=user1,ou=example-bod,ou=example,dc=example,dc=net  \ncn: user1  \ndepartmentnumber: 1  \ndisplayname: Zheng Yu  \nmail: user1@example.net  \nobjectclass: inetOrgPerson  \nsn: Zheng  \ntitle: President  \nuid: 10000  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net  \ncn: example-bod-admin  \nmember: cn=user1,ou=example-bod,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-bus,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-bus  \n  \ndn: cn=user8,ou=example-bus,ou=example,dc=example,dc=net  \ncn: user8  \ndepartmentnumber: 2  \ndisplayname: Sun Minghong  \nmail: user8@example.net  \nobjectclass: inetOrgPerson  \nsn: Sun  \ntitle: Financial Manager  \nuid: 10001  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-bus-admin,ou=example-bus,ou=example,dc=example,dc=net  \ncn: example-bus-admin  \nmember: cn=user8,ou=example-bus,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-sys,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-sys  \n  \ndn: cn=user2,ou=example-sys,ou=example,dc=example,dc=net  \ncn: user2  \ndepartmentnumber: 3  \ndisplayname: Xie Jian  \nmail: user2@example.net  \nobjectclass: inetOrgPerson  \nsn: Xie  \ntitle: Senior Systems Engineer  \nuid: 10002  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net  \ncn: example-sys-admin  \nmember: cn=user2,ou=example-sys,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: cn=user5,ou=example-sys,ou=example,dc=example,dc=net  \ncn: user5  \ndepartmentnumber: 3  \ndisplayname: Long Chao  \nmail: user5@example.net  \nobjectclass: inetOrgPerson  \nsn: Long  \ntitle: System Engineer  \nuid: 10003  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-sys-junior,ou=example-sys,ou=example,dc=example,dc=net  \ncn: example-sys-junior  \nmember: cn=user5,ou=example-sys,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-ops,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-ops  \n  \ndn: cn=user6.tang,ou=example-ops,ou=example,dc=example,dc=net  \ncn: user6.tang  \ndepartmentnumber: 4  \ndisplayname: Tang Binchao  \nmail: user6.tang@example.net  \nobjectclass: inetOrgPerson  \nsn: Tang  \ntitle: System Engineer  \nuid: 10004  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net  \ncn: example-ops-admin  \nmember: cn=user6.tang,ou=example-ops,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-dev,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-dev  \n  \ndn: cn=user3,ou=example-dev,ou=example,dc=example,dc=net  \ncn: user3  \ndepartmentnumber: 5  \ndisplayname: Chen Cheng  \nmail: user3@example.net  \nobjectclass: inetOrgPerson  \nsn: Chen  \ntitle: Senior Development Engineer  \nuid: 10005  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-dev-admin,ou=example-dev,ou=example,dc=example,dc=net  \ncn: example-dev-admin  \nmember: cn=user3,ou=example-dev,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: cn=user4.li,ou=example-dev,ou=example,dc=example,dc=net  \ncn: user4.li  \ndepartmentnumber: 5  \ndisplayname: Li user4  \nmail: user4.li@example.net  \nobjectclass: inetOrgPerson  \nsn: Li  \ntitle: Development Engineer  \nuid: 10006  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=user7,ou=example-dev,ou=example,dc=example,dc=net  \ncn: user7  \ndepartmentnumber: 5  \ndisplayname: Luo Xujun  \nmail: user7@example.net  \nobjectclass: inetOrgPerson  \nsn: Luo  \ntitle: Development Engineer  \nuid: 10007  \nuserpassword: {SSHA}/2+Coei5Fje+th7mOJgu43Ms3hBia2Qu  \n  \ndn: cn=example-dev-senior,ou=example-dev,ou=example,dc=example,dc=net  \ncn: example-dev-senior  \nmember: cn=user4.li,ou=example-dev,ou=example,dc=example,dc=net  \nmember: cn=user7,ou=example-dev,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-rob,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-rob\n```\n\n###  11.3 第一版 ACL\n```\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {2}to dn.subtree=\"ou=example,dc=example,dc=net\" filter=\"(&(objectClass=inetOrgPerson)(|(memberOf=cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net)(memberOf=cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net)(memberOf=cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net)))\" by dn.base=\"cn=exampleread,dc=ibexample,dc=com\" read\n\ndn: olcDatabase={4}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {0}to attrs=userPassword by self write by dn.base=\"cn=exampleadmin,dc=example,dc=net\" write  by anonymous auth  by * none\nolcAccess: {2}to dn.subtree=\"dc=ibexample,dc=com\" by dn.base=\"cn=exampleadmin,dc=example,dc=net\" write by dn.base=\"cn=exampleread,dc=ibexample,dc=com\" read\n```\n\n###  11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）\n- 添加\n```\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {2}to dn.subtree=\"dc=example,dc=net\" by dn.base=\"cn=exampleread,dc=example,dc=net\" read\nolcAccess: {3}to dn.subtree=\"dc=example,dc=net\" filter=\"(&(objectClass=inetOrgPerson)(|(memberOf=cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net)(memberOf=cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net)(memberOf=cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net)))\" by dn.base=\"cn=exampleread,dc=ibexample,dc=com\" read\n \ndn: olcDatabase={2}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {0}to attrs=userPassword by self write by dn.base=\"cn=exampleadmin,dc=example,dc=net\" write  by anonymous auth  by * none\nolcAccess: {2}to dn.subtree=\"dc=ibexample,dc=com\" by dn.base=\"cn=exampleadmin,dc=example,dc=net\" write by dn.base=\"cn=exampleread,dc=ibexample,dc=com\" read by dn.base=\"cn=exampleread,dc=example,dc=net\" read\n```\n\n- 删除\n```\ndn: olcDatabase={1}mdb,cn=config\ndelete: olcAccess\nolcAccess: {2}to..........\nolcAccess: {3}to........\n \n\nldapmodify -Y EXTERNAL -H ldapi:/// -f acl-dele.ldif\n```\n\n- 数据库内 ACL 顺序测试，{}里面是优先级，生效在前（涉及范围大的 ACL 应书写在前）\n```\nolcAccess: {0}to attrs=userPassword by self write by anonymous auth  by dn.base=\"cn=admin,dc=example,dc=net\" write  by * none   \nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcAccess: {2}to dn.subtree=\"cn=example-sys-admin,ou=example-sys,dc=example,dc=tech\" by dn.base=\"cn=reader,dc=example,dc=net\" read by dn.base=\"cn=admin,dc=example,dc=net\" write    # 如果没有此条acl,该条目将不能在 lam 中被 admin 管理\n olcAccess: {3}to dn.subtree=\"dc=example,dc=tech\" by dn.base=\"cn=admin,dc=example,dc=net\" write      # 此条优先级最低\n```\n\n## 十二、集成其他应用\n### 12.1  conflunce \n```\nolcAccess: {0}to attrs=userPassword by self write by anonymous auth by * none\nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcAccess: {2}to dn.subtree=\"dc=example,dc=net\" by dn.base=\"cn=reader,dc=ibexample,dc=com\" read\n```\n#### 12.1.1 连接 之后的 acl 过滤案例\n'(&(objectclass=inetorgperson)(|(cn=user5)(cn=user2)))'  过滤出指定用户----在用户模式设置。\n\n'(&(objectclass=groupOfNames)(|(cn=example-sys-junior)(cn=example-sys-admin)))' 过滤指定组----在组模式设置（在ldap中创建的组 objectclass 是groupOfNames）\n \n#### 12.1.2 更详细的 acl 需求\n- example\n```\nolcAccess: {0}to attrs=userPassword by self write  by anonymous auth  by * none\nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcAccess: {2}to dn.subtree=\"dc=example,dc=net\" filter=\"(&(objectClass=inetOrg\n Person)(|(memberOf=cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net\n )(memberOf=cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net)(member\n Of=cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net)))\" by dn.base=\n \"cn=reader,dc=ibexample,dc=com\" read  by dn.base= \"cn=reader,dc=example,dc=net\" read\n\nsearch时，必须要具体到用户层级，例如nextcloud，需要指定基础用户树如下\n\ncn=user2,ou=example-sys,ou=example,dc=example,dc=net\ncn=user1,ou=example-bod,ou=example,dc=example,dc=net\ncn=user6.tang,ou=example-ops,ou=example,dc=example,dc=net\ndc=ibexample,dc=com\n```\n\n- example\n```\nolcAccess: {0}to attrs=userPassword by self write by dn.base=\"cn=admin,dc=example,dc=net\" write  by anonymous auth  by * none\nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcAccess: {2}to dn.subtree=\"dc=ibexample,dc=com\" by dn.base=\"cn=admin,dc=example,dc=net\" write by dn.base=\"cn=reader,dc=ibexample,dc=com\" read\n```\n\n### 12.2 集成 vault\n- 过滤特定用户\n```\n(&(objectClass=inetOrgPerson)({{.UserAttr}}={{.Username}})(|(cn=user2)(cn=user1)(cn=%s)))\n```\n- 过滤某个组\n```\n(&(objectClass=inetOrgPerson)({{.UserAttr}}={{.Username}})(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net))\n```\n- 过滤多个组\n```\n(&(objectclass=inetOrgPerson)({{.UserAttr}}={{.Username}})(|(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net)(memberof=CN=example-dev-admin,OU=example-dev,OU=example,DC=example,DC=net)))\n```\n- 过滤特定用户和特定组\n```\n(&(objectclass=inetOrgPerson)({{.UserAttr}}={{.Username}})(|(|(cn=user4.li))(|(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net)(memberof=CN=example-dev-admin,OU=example-dev,OU=example,DC=example,DC=net))(cn=%s)))\n```\n- 错误\n```\n(&(objectClass=inetOrgPerson)({{.UserAttr}}={{.Username}})(|(cn=user2)(cn=user1))(cn=%s))  会失败\n\n以下 1 条，写在group filter的时候会出现不能过滤，所有人都可以登录\n(&(objectclass=inetOrgPerson)(|(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net)(memberof=CN=example-dev-admin,OU=example-dev,OU=example,DC=example,DC=net)))\n```\n\n\n\n","source":"_posts/Multiple-Domians-in-OpenLDAP-Use-Case.md","raw":"---\ntitle: Multiple Domians in OpenLdap Use Case\ndate: 2023-10-24 23:37:36\ntags:\n  - OpenLDAP\ncategories:\n  - ops\ntoc: true\nsummary: 记录自己 OpenLDAP 在多域中的使用，以及集成应用且跨域实现用户登录的测试，内容来源网络和实践。\n---\n# OpenLDAP\n## 一、 概念\n[官方手册](https://www.openldap.org/doc/admin26/guide.html)\n\n### 1.1 常用属性\n- DN：Distinguished Name，LDAP记录项的标识，有唯一性，例如：dc:\"cn=admin,ou=developer,dc=163,dc=com\"  \n- dc= DomainComponent 为域组件，域名的一部分\n- cn=CommonName 为记录名，表示一个实体，最长到80个字符，可以为中文；\n- ou=OrganizationUnit 为组织单位，用于分类，最多四级，每级最长32字符，可以为中文；\n- uid=User id 为用户的唯一标识\n- c=Country 为国家名，可选，为2个字符长\n- o=Organization 为组织名，可选，可以3—64个字符长\n\n## 二、 手动安装和配置 LDAP\n\n### 2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)\n```\nsudo apt install  -y slapd ldap-utils\n```\n\n### 2.2  重新配置 OpenLDAP，创建 base dn\n```\nsudo dpkg-reconfigure slapd   # 主要配置密码 (密码在下一步重置，便于配置连接)，DNS domain name(即 LDAP 服务中的 base dn)\n\n\t 说明：\n\t第一步回答 No\n\t第二步填写域名，比如 mycompany.com\n\t第三步填写组织名，比如 Company\n\t第四步填写管理员密码，比如 secret；第五步确认管理员密码\n\t第六步选择使用的数据库后端，比如 MDB\n\t第七步选择在清除 slapd 时是否移除数据库，比如 Yes\n\t第八步选择是否移除旧数据库，比如 Yes\n```\n\n### 2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码\n```shell\nslappasswd\n\t{SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n\n- 通过数据库修改admin用户的ldif文件\n```ldif\n/etc/ldap/slapd.d/cn\\=config/olcDatabase\\=\\{1\\}mdb.ldif\n\tolcDatabase: {1}mdb\n\tolcSuffix: dc=example,dc=top\n\tolcRootDN: cn=admin,dc=example,dc=top\n\tolcRootPW: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n- olcDatabase: 定义使用的后端数据存储格式,遵循默认\n- olcSuffix: 设置 LDAP 服务的根\n- olcRootDN: 设置管理员用户的 dn\n- olcRootPW: 管理员用户的密码\n- 修改后重启服务\n```\nsudo slaptest -u   # 检查配置文件\nsudo systemctl enable slapd  --now\n\nsudo slapcat        # 输出看到当前数据库内容\n```\n\n### 2.4 正确的修改olcRootPW: 管理员用户的密码\n\n```\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nreplace: olcRootPW\nolcRootPW: example2020  # 保存在数据库文件中的时候将会被加密\n```\n\n```\nldapmodify -Y EXTERNAL -H ldapi:/// -f passmodify.ldif\n```\n\n```\n同时进入web ui，修改admin账户的密码，如果不修改两个密码都能管理域，二者修改一致之后，才是新的管理密码生效\n```\n\n### 2.5 简单结构展示\n\n略\n### 2.6 创建base dn \n\n#### 2.6.1 查看LDAP服务器的根目录信息\n```\nsudo ldapsearch -x -LLL -b '' -s base '(objectclass=*)'\n\tdn:\n\tobjectClass: top\n\tobjectClass: OpenLDAProotDSE\n```\n\n#### 2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码\n```\n-\ndn: dc=example,dc=top\nchangetype: add\nobjectClass: top\nobjectClass: domain\n\n\n-\ndn: o=example,dc=example,dc=top\nchangetype: add\nobjectClass: organization\no: example\n```\n\n```\nldapmodify -x -D \"cn=admin,dc=example,dc=top\" -w example@2020  -f organization.ldif\n```\n\n### 2.7 创建多个 DIT + base dn （可以考虑尝试后端用 `mysql` 做数据库）\n#### 2.7.1 为新的库，准备存储路径，并通过`apparmor`做权限限制\n```\nmkdir  /var/lib/ldap2\nchown openldap:openldap  /var/lib/ldap2\nvim /etc/apparmor.d/usr.sbin.slapd\n\t\t# the databases and logs\n\t\t/var/lib/ldap2/ r,\n\t\t/var/lib/ldap2/** rwk,\n\t\t\n\t\t# lock file\n\t\t/var/lib/ldap2/alock kw,\n\nsudo systemctl  reload  apparmor \n```\n\n#### 2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）\n```\ndn: olcDatabase={2}mdb,cn=config\nchangetype: add\nobjectClass: olcDatabaseConfig\nobjectClass: olcMdbConfig\nolcDbDirectory: /var/lib/ldap2/\nolcDatabase: {2}Mdb\nolcDbIndex: objectClass eq\nolcDbIndex: cn,uid eq\nolcDbIndex: uidNumber,gidNumber eq\nolcDbIndex: member,memberUid eq\nolcLastMod: TRUE\nolcMonitoring: TRUE\nolcDBNoSync: TRUE\nolcAccess: {0}to attrs=userPassword by self write by anonymous auth by * non\n e\nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcSuffix: dc=example,dc=tech\nolcRootDN: cn=admin,dc=example,dc=tech\nolcRootPW: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n\n```\nsudo  ldapmodify -Y EXTERNAL -H ldapi:/// -f domian2.ldif\n```\n\n#### 2.7.3 新增并设置管理员\n```\n-\ndn: cn=admin,dc=example,dc=tech\nobjectClass: simpleSecurityObject\nobjectClass: organizationalRole\ncn: admin\nuserPassword: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n==========================\n# 以下是playbook中模板文件\n-\ndn: cn=admin,{{ item.base_dn }}  \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n\n```\nsudo ldapadd -x -D \"cn=admin,dc=example,dc=tech\" -w example@2020 -f basedn2.ldif\n```\n\n#### 2.7.4 多 DIT 跨域 ACL\n- 查询服务器的域\n```\nldapsearch -x -H ldap://10.13.3.107 -b \"\" -s base namingContexts\n```\n\n- 设置一个全权限的 acl ，跨域访问，相应的用户需已经提前创建\n\n```\n让这个dn 用户: cn=user.tech,dc=example,dc=tech ;  可以阅读这个base dn : dc=example,dc=top 下的所有条目.\n对应关系：数据库----{1}mdb  存储的数据是来自 dn: dc=example,dc=top 。即，对谁的访问则将 acl 添加在谁的库下  \n\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {2}to dn.subtree=\"dc=example,dc=top\" by dn.base=\"cn=user.tech,dc=example,dc=tech\" read\n```\n\n```\nldapmodify   -Y   EXTERNAL   -H   ldapi:///   -f  xxx\n```\n#### 2.7.5 测试\n```\nroot@example-sys-test-06:/etc/ldap/example# ldapsearch -x -b \"dc=example,dc=top\" -D \"cn=user.tech,dc=example,dc=tech\" -w example@2020\n\t\t# extended LDIF\n\t\t#\n\t\t# LDAPv3\n\t\t# base <dc=example,dc=top> with scope subtree\n\t\t# filter: (objectclass=*)\n\t\t# requesting: ALL\n\t\t#\n\t\t\n\t\t# example.top\n\t\tdn: dc=example,dc=top\n\t\tobjectClass: top\n\t\tobjectClass: domain\n\t\tdc: example\n\t\t\n\t\t# admin, example.top\n\t\tdn: cn=admin,dc=example,dc=top\n\t\tobjectClass: simpleSecurityObject\n\t\tobjectClass: organizationalRole\n\t\tcn: admin\n\t\t\n\t\t# search result\n\t\tsearch: 2\n\t\tresult: 0 Success\n\t\t\n\t\t# numResponses: 3\n\t\t# numEntries: 2\nroot@example-sys-test-06:/etc/ldap/example# ldapsearch -x -b \"dc=example,dc=tech\" -D \"cn=admin,dc=example,dc=top\" -w example@2020\n\t\t# extended LDIF\n\t\t#\n\t\t# LDAPv3\n\t\t# base <dc=example,dc=tech> with scope subtree\n\t\t# filter: (objectclass=*)\n\t\t# requesting: ALL\n\t\t#\n\t\t\n\t\t# search result\n\t\tsearch: 2\n\t\tresult: 32 No such object\n\t\t\n\t\t# numResponses: 1\n```\n\n- 测试的日志\n```\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 fd=12 ACCEPT from IP=127.0.0.1:59834 (IP=0.0.0.0:389)\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 BIND dn=\"cn=user.tech,dc=example,dc=tech\" method=128\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 BIND dn=\"cn=user.tech,dc=example,dc=tech\" mech=SIMPLE ssf=0\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 RESULT tag=97 err=0 text=\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=1 SRCH base=\"dc=example,dc=top\" scope=2 deref=0 filter=\"(objectClass=*)\"\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=1 SEARCH RESULT tag=101 err=0 nentries=2 text=\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=2 UNBIND\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 fd=12 closed\n=================\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 fd=12 ACCEPT from IP=127.0.0.1:34916 (IP=0.0.0.0:389)\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" method=128\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" mech=SIMPLE ssf=0\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 RESULT tag=97 err=0 text=\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=1 SRCH base=\"dc=example,dc=tech\" scope=2 deref=0 filter=\"(objectClass=*)\"\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=1 SEARCH RESULT tag=101 err=32 nentries=0 text=\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=2 UNBIND\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 fd=12 closed\n```\n\n## 三、 web管理器配置\n\n### 3.1 安装  LAM （用于管理的Web UI）\n```\napt-get install ldap-account-manager\n```\n访问 http://ip/lam ，lam的所有配置都可以在web端配置，不需要去服务器上修改一行代码\n\n#### 3.1.1 LAM configuration ([helm 安装的主要修改内容](https://check-lc.github.io/ops_blog/2023/12/04/the-first-time-using-helm-charts/))\n<pre>\n主要内容：\n  LDAP_DOMAIN: example.net;ibexample.com\n  LDAP_BASE_DN: dc=example,dc=net;dc=ibexample,dc=com\n  LDAP_SERVER: ldaps://ldap01.example.net\n  LDAP_USER: cn=administrator,dc=example,dc=net\n  LAM_LANG: zh_CN\n  LAM_PASSWORD: lam\n</pre>\n\n- tree view编辑更高效\n\n- 如果选择 docker 安装镜像：ghcr.io/ldapaccountmanager/lam:8.4@sha256:283726bd23510f1c3bfbdcbfe861e6599e070616543aed02e9756075c97a9938\n#### 3.1.3 Nginx反向代理 LAM Web UI\n```\nupstream lam {\n  server 10.13.3.108:8001;\n}\n\nserver {\n  listen 80;\n  server_name lam.example.net;\n  return 301 https://$server_name$request_uri;\n}\n\nserver {\n  server_name lam.example.net;\n  listen 443 ssl;\n  ssl_certificate webmin/tls_ca.pem;\n  ssl_certificate_key webmin/tls_key.pem;\n\n  location / {\n     proxy_pass http://lam/;\n     proxy_set_header Host $host;\n     proxy_set_header X-Real-IP $remote_addr;\n     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n#     proxy_set_header X-Forwarded-Proto \"https\";\n     proxy_read_timeout 1800s;\n     proxy_http_version 1.1;\n     proxy_set_header Upgrade $http_upgrade;\n     proxy_set_header Connection \"upgrade\";\n    }\n  }\n```\n\n### 3.2 测试 phpldapadmin\n```\nSetting up php8.1 (8.1.2-1ubuntu2.14)                       # 版本信息，配置文件完整，存在证书认证并可以指定路径\nSetting up php (2:8.1+92ubuntu1) \nSetting up phpldapadmin (1.2.6.3-0.2)                                       \n```\n#### 3.2.1 安装\n```\napt-get install phpldapadmin -y\nnano /etc/phpldapadmin/config.php\n\t$servers->setValue('server','name','My LDAP Server');                      # 辨识，区分的作用\n\t$servers->setValue('server','host','69.87.216.102');                              #  修改ip为服务器 ip\n\t$servers->;setValue('server','base',array('dc=example,dc=com'));                    # 修改 array 内容为需求的根\n\t$servers->setValue('login','auth_type','session');                                              \n\t$servers->setValue('login','bind_id','cn=admin,dc=example,dc=com');           #   绑定登录帐号admin，相应修改 dn 号即可\n\t$servers->setValue('auto_number','min',array('uidNumber'=>10000,'gidNumber'=>10000));   # 规定 uid，gid 数字表示的起始范围\n```\n#### 3.2.2 为 phpLDAPadmin 配置 Apache\n```\na2dissite 000-default.conf        # 禁用默认的 Apache 虚拟主机配置文件\nsystemctl restart apache2          \n```\n\n## 四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)\n[模式介绍](https://darkdark.top/ch5-replication.html)\n### 4.1 master 加载同步模块\n```\ncat /etc/ldap/mod_syncprov.ldif\n\t\tdn: cn=module,cn=config\n\t\tobjectClass: olcModuleList\n\t\tcn: module\n\t\tolcModulePath: /usr/lib/ldap\n\t\tolcModuleLoad: syncprov.la          # 此配置和上一句配置，实际是在请求这个路径的文件，/usr/lib/ldap/syncprov.la，不确定的可以用 find 查找\n\nldapadd -Y EXTERNAL -H ldapi:/// -f ./mod_syncprov.ldif\n```\n### 4.2 同步设置\n```\nroot@example-sys-test-06:/etc/ldap# cat syncprov.ldif \n\t\tdn: olcOverlay=syncprov,olcDatabase={1}mdb,cn=config       # 此处需要确认自己的数据库是什么样的，{2}hdb--旧版本默认 / {1}mdb--新版本默认\n\t\tobjectClass: olcOverlayConfig\n\t\tobjectClass: olcSyncProvConfig\n\t\tolcOverlay: syncprov\n\t\tolcSpCheckpoint: 100 10\n\t\tolcSpSessionLog: 100\n\nldapadd -Y EXTERNAL -H ldapi:/// -f ./syncprov.ldif                             # 修改并应用条目到 LDAP 服务  -Y EXTERNAL    将使用服务器配置的外部身份验证方法进行身份验证，而不是使用用户名和密码; -H 指定服务器连接; -f 指定文件\n```\n### 4.3 从服务器配置\n```\nroot@example-sys-test-07:/etc/ldap# cat syncrepl.ldif\n\t\tdn: olcDatabase={1}mdb,cn=config\n\t\tchangetype: modify\n\t\tadd: olcSyncRepl\n\t\tolcSyncRepl: rid=002\n\t\t  provider=ldap://10.13.3.106:389/        # 此处开始与上一行有缩进\n\t\t  bindmethod=simple\n\t\t  binddn=\"cn=admin,dc=example,dc=top\"\n\t\t  credentials=example@2020      \n\t\t  searchbase=\"dc=example,dc=top\"\n\t\t  scope=sub\n\t\t  schemachecking=on\n\t\t  type=refreshAndPersist\n\t\t  retry=\"5 5 300 +\"\n\t\t  attrs=\"*,+\"\n\t\t  interval=00:00:00:3\n\nldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/syncrepl.ldif\n```\n- 运行中，修改主服务器内数据后，对从服务器u做刷新，可以看到是否同步\n\n参数说明：\n- provider 为ldap master/slave的地址 ;\n- binddn：为域的基本信息，注这里一定要用管理员进行登录，否则同步不到用户的密码。\n- credentials: ldap管理员的密码\n- searchbase：选择要同步的独立域，根节点\n- scope：设置所有的条目匹配\n- schemachecking：设置同步更新时间检测\n- type：同步模式为refreshAndPersist， refreshOnly 模式下后续操作由客户端轮询完成\n- retry:同步更新重试次数和时间刚开始的5秒重试5次，以后每300秒重试一次\n- attrs:复制全部属性\n- interval 这里设置更新时间，这里为3秒一次，倒数第二个是分钟 以此类推。\n\n\n## 四、 镜像复制（互为主从）\n[模式介绍](https://darkdark.top/ch5-replication.html)\n### 4.1 为某域编辑 mirrorsync.ldif\n```\ndn: cn=module,cn=config         # 此段配置加载s ync 模块\nobjectClass: olcModuleList\ncn: module\nolcModulePath: /usr/lib/ldap\nolcModuleLoad: syncprov.la     # 此配置和上一句，实际是在请求这个路径的文件，/usr/lib/ldap/syncprov.la，不确定的可 find 查找\n\n-\ndn: olcOverlay=syncprov,olcDatabase={1}mdb,cn=config        \n\t # 此处需确认自己的数据库，{2}hdb--为旧版本默认 / {1}mdb--为新版本默认。路径 /etc/ldap/slapd.d/cn\\=config/olcDatabase\\=\\{1\\}mdb.ldif\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 100\n\n-\ndn: cn=config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 0                                        # 用于标识本机的 server id\n\ndn: olcDatabase={1}mdb,cn=config      # 以下配置用于开启复制，指定主服务器\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid=000                             # 标识唯一的 replica id\n  provider=ldaps://ldap01.example.top       # 看上述记录介绍参数\n  bindmethod=simple\n  binddn=\"cn=admin,dc=example,dc=top\"\n  credentials=example@2020\n  searchbase=\"dc=example,dc=top\"\n  tls_reqcert=allow\n  scope=sub\n  schemachecking=on\n  type=refreshAndPersist\n  retry=\"30 5 300 3\"\n  interval=00:00:05:00\n-\nadd: olcMirrorMode                        # 开启 mirror mode\nolcMirrorMode: TRUE\n\n```\n\n### 4.2 ldap01.example.top下编辑 mirrorsync.ldif\n```\ndn: cn=module,cn=config\nobjectClass: olcModuleList\ncn: module\nolcModulePath: /usr/lib/ldap\nolcModuleLoad: syncprov.la\n\n-\ndn: olcOverlay=syncprov,olcDatabase={1}mdb,cn=config\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 100\n\n-\ndn: cn=config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 1\n\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid=001\n  provider=ldaps://ldap.example.top\n  bindmethod=simple\n  binddn=\"cn=admin,dc=example,dc=top\"\n  credentials=example@2020\n  searchbase=\"dc=example,dc=top\"\n  tls_reqcert=allow\n  scope=sub\n  schemachecking=on\n  type=refreshAndPersist\n  retry=\"30 5 300 3\"\n  interval=00:00:05:00\n-\nadd: olcMirrorMode\nolcMirrorMode: TRUE\n\n```\n#### 4.2.1 加载配置\n```\nldapadd -Y EXTERNAL -H ldapi:/// -f mirrorsync.ldif\n```\n\n## 五、 TLS加密（自签名/权威证书）\n（自签名证书加密连接 nextcloud 失败，使用不便，采用 权威证书（多域合一）或stunnel）\n\n### 5.1 CA中心创建证书\n\t此时使用LDAP 主服务器 作为 CA 中心，自签名\n- 安装 gnutls-bin 和 ssl-cert 包\n```\nsudo apt install gnutls-bin ssl-cert\n```\n- 为证书授权中心创建私钥\n```\nsudo certtool --generate-privkey --bits 4096 --outfile /etc/ssl/private/mycakey.pem\n```\n- 创建模板文件来定义CA\n```\n/etc/ssl/ca.info\n\t cn = example (example company)  \n\t ca\n\t cert_signing_key\n\t expiration_days = 3650\n```\n- 创建自签名 CA (根)证书\n```\nsudo certtool --generate-self-signed \\\n--load-privkey /etc/ssl/private/mycakey.pem \\\n--template /etc/ssl/ca.info \\\n--outfile /usr/local/share/ca-certificates/mycacert.crt\n```\n- Note：\n\t`--outfile`路径是正确的，将CA证书写入`/usr/local/share/ca-certificates`。\n\t**update-ca-certificates** 将从这里获取受信任的本地CA。如果要从`/usr/share/ca-certificates`获取CA，需要调用`dpkg-reconfigure ca-certificates`\n\n- 将新的 CA 根证书添加到受信任 CA 列表\n```\nsudo update-ca-certificates     # 会创建一个/etc/ssl/certs/mycacert.pem符号链接，指向/usr/local/share/ca-certificates中的真实文件\n```\n### 5.2 创建 LDAP 服务的服务器私钥与证书\n- 创建私钥\n```\nsudo certtool --generate-privkey \\\n--bits 2048 \\\n--outfile /etc/ldap/ldap01_slapd_key.pem\n```\n- 服务器信息文件\n```\n/etc/ssl/ldap01.info\n\torganization = example\n\tcn = ldap01.example.top                     # 服务器证书的DN必须使用CN属性来命名服务器，并且CN必须携带服务器的完全限定域名，dns 需要有 A 记录解析\n\ttls_www_server\n\tencryption_key\n\tsigning_key\n\texpiration_days = 365\n证书有效期为1年，仅对_`ldap01`_主机名有效\n```\n- 创建LDAP服务器的证书\n```\nsudo certtool --generate-certificate \\\n--load-privkey /etc/ldap/ldap01_slapd_key.pem \\\n--load-ca-certificate /etc/ssl/certs/mycacert.pem \\\n--load-ca-privkey /etc/ssl/private/mycakey.pem \\\n--template /etc/ssl/ldap01.info \\\n--outfile /etc/ldap/ldap01_slapd_cert.pem\n```\n- 调整权限\n```\nsudo chgrp openldap /etc/ldap/ldap01_slapd_key.pem\nsudo chmod 0640 /etc/ldap/ldap01_slapd_key.pem\n```\n- ca根证书加入到受信列表\n```\nsudo cp   cacertificatefile  /usr/local/share/ca-certificates/mycacert.crt\nsudo update-ca-certificates\n```\n  \n- 对LDAP服务配置证书\n```\ndn: cn=config\nadd: olcTLSCACertificateFile\nolcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem\n-\nadd: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/ldap/ldap01_slapd_cert.pem\n-\nadd: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/ldap/ldap01_slapd_key.pem\n```\n- 配置slapd-config数据库：\n```\nsudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif \n```\n- 报错调整，更改`certinfo.ldif`，将`add`改成了`replace`，可以解决以下问题。修改后再次执行`ldapmodify`\n```\nldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif \n\tSASL/EXTERNAL authentication started SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth \n\tSASL SSF: 0 \n\tmodifying entry \"cn=config\" ldap_modify: Inappropriate matching (18) \n\tadditional info: modify/add: olcTLSCACertificateFile: no equality matching rule\n```\n- ldap-client增添配置文件\n```\n/etc/ldap/ldap.conf\n\t# LDAP Defaults\n\t# See ldap.conf(5) for details\n\t# This file should be world readable but not world writable.\t\n\tBASE       dc=example,dc=top                                                      # LDAP服务的基础DN\n\tURI ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径\n\tTLS_REQCERT demand                                                        # \"demand\"，表示需要验证服务器的证书\n```\n- 需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd\n```\n/etc/default/slapd\n\tSLAPD_SERVICES=\"ldap:/// ldapi:/// ldaps:///\"\n```\n- 测试启动 TLS\n```\nldapwhoami -x -ZZ -H ldap://ldap01.example.com\nanonymous\n```\n- 测试连接\n```\nldapwhoami -x -H ldaps://ldap01.example.com\nanonymous\n```\n\n### 5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器\n-  指定目录保存\n```\nmkdir ldap02-ssl\ncd ldap02-ssl\ncerttool --generate-privkey \\\n--bits 2048 \\\n--outfile ldap02_slapd_key.pem\n```\n- 编辑信息文件ldap02.info\n```\norganization = example\ncn = ldap02.example.top                      \ntls_www_server\nencryption_key\nsigning_key\nexpiration_days = 365\n```\n- 创建证书\n```\nsudo certtool --generate-certificate \\\n--load-privkey ldap02_slapd_key.pem \\\n--load-ca-certificate /etc/ssl/certs/mycacert.pem \\\n--load-ca-privkey /etc/ssl/private/mycakey.pem \\\n--template ldap02.info \\\n--outfile ldap02_slapd_cert.pem\n```\n\n```\ncp /etc/ssl/certs/mycacert.pem .\nscp -r ldap02-ssl user@ldap02_ip:\n```\n- 从服务器中安装证书\n```\nsudo cp ldap02_slapd_cert.pem ldap02_slapd_key.pem /etc/ldap\nsudo chgrp openldap /etc/ldap/ldap02_slapd_key.pem\nsudo chmod 0640 /etc/ldap/ldap02_slapd_key.pem\nsudo cp mycacert.pem /usr/local/share/ca-certificates/mycacert.crt\nsudo update-ca-certificates\n```\n- 对LDAP服务配置证书 `./certinfo.ldif `\n```\ndn: cn=config\nadd: olcTLSCACertificateFile\nolcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem\n-\nadd: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/ldap/ldap02_slapd_cert.pem\n-\nadd: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/ldap/ldap02_slapd_key.pem\n```\n- 配置slapd-config数据库：\n```\nsudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif \n```\n- 增添配置文件\n```\n/etc/ldap/ldap.conf\n\tBASE       dc=example,dc=top                                                      # LDAP服务的基础DN\n\tURI ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径\n\tTLS_REQCERT demand                                                        # \"demand\"，表示需要验证服务器的证书\n```\n- 需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd\n```\n/etc/default/slapd\n\tSLAPD_SERVICES=\"ldap:/// ldapi:/// ldaps:///\"\n```\n- 测试启动 TLS\n```\nldapwhoami -x -ZZ -H ldap://ldap02.example.top\nanonymous\n```\n- 测试连接\n```\nldapwhoami -x -H ldaps://ldap02.example.top\nanonymous\n```\n\n### 5.4 使用合法证书\n\n- 将新的 CA 根证书添加到受信任 CA 列表（客户端操作，权威证书按理不需要拷贝，未测试）\n```\nsudo   cp   _.example.top-chain.pem   /usr/local/share/ca-certificates/mycacert.crt\nsudo update-ca-certificates\n```\n\n- 准备服务器证书和私钥（服务端）\n```\n ls /etc/ldap\n\tcertinfo.ldif   _.example.top-crt.pem   _.example.top-key.pem\nsudo chgrp openldap /etc/ldap/_.example.top-key.pem\nsudo chmod 0640 /etc/ldap/_.example.top-key.pem\n```\n\n- certinfo.ldif\n```\ndn: cn=config\nchangetype: modify\nreplace: olcTLSCACertificateFile\nolcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem\n-\nreplace: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/ldap/_.example.top-crt.pem\n-\nreplace: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/ldap/_.example.top-key.pem\n\n```\n\n```\nsudo ldapadd  -Y   EXTERNAL  -H  ldapi:///   -f    certinfo.ldif\n```\n\n\n- 增添配置文件，这是客户端需要连接 ldap 服务器使用的配置。可以忽略。\n```\n/etc/ldap/ldap.conf\n\tBASE       dc=example,dc=top                                                      # LDAP服务的基础DN\n\t[[URI]] ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径，必需\n\tTLS_REQCERT allow                                                      # \"demand\"，表示需要验证服务器的证书\n```\n- 启用 ldaps，重启 slapd\n```\n/etc/default/slapd\n\tSLAPD_SERVICES=\"ldap:/// ldapi:/// ldaps:///\"\n```\n\n\n### 5.5 使用 nextcloud 测试加密连接\n\n- docker 安装 nexcloud，登录 UI ，右上角点击账户，选择应用\n- 应用捆绑包，启用 LDAP user and group backend\n- 设置连接\n- ldaps连接(严格一致才是tls加密，nextcloud应该只信任权威证书)\n\n- 明文传输 \n\n### 5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)\n\n链路： ldap user ui  ---- stunnel client  accept  ----  stunnel client connect  ---- stunnel server accept  ---- stunnel server connect ----ldap server port\n```\napt install -y stunnel4\nvim /etc/default/stunnel4\n\tENABLED=1\n```\n\n```\n# stunnel 服务端\n\tcert = /etc/stunnel/stunnel.pem\n\tkey = /etc/stunnel/stunnel-key.pem\n\tverify = 3\n\tclient = no\n\tdebug = 6\n\tpid = /var/run/stunnel4/stunnel4.pid\n\t\n\t[ldap]\n\taccept = 10.13.3.106:6360                # 监听 stunnel 服务的流量，客户端（是指stunnel 客户端）将连接此目标并发送流量到这里\n\tconnect = 10.13.3.106:389                # 转发到 stunnel 加密连接的服务的端口\n\tCAfile = /etc/stunnel/stunnel.pem\n\n# stunnel 客户端\n\tcert = /etc/stunnel/stunnel.pem\n\tkey = /etc/stunnel/stunnel-key.pem\n\tverify = 3\n\tclient = yes\n\tdebug = 6\n\tsetuid = stunnel4\n\tsetgid = stunnel4\n\tpid = /var/run/stunnel4/stunnel4.pid\n\t\n\t[ldap]\n\taccept = 10.13.3.107:389                # 监听 stunnel 服务的流量，客户端（是指ldap的客户端）将连接此目标并发送流量到这里\n\tconnect = 10.13.3.106:6360              # 加密连接并转发到 stunnel 的服务端\n\tCAfile = /etc/stunnel/stunnel.pem\n```\n\n```\n/etc/phpldapadmin/config.php\n\t$servers->setValue('server','host','69.87.216.102');  # 指向 stunnel 客户端，和他本地监听的端口\n\t$servers->setValue('server','port',389);\t\n```\n## 六、 其他模块\n### 6.1 日志模块\n```\n/etc/ldap/loglevel.ldif\n\tdn: cn=config\n\tchangetype: modify\n\treplace: olcLogLevel\n\tolcLogLevel: stats\n\nldapmodify  -Y  EXTERNAL  -H  ldapi:///  -f  loglevel.ldif               # 日志在/var/log/syslog | grep slapd , 比默认的级别详细\n```\n### 6.2 memberOf 开启\n```\n/etc/ldap/refint.ldif\n\t# enable_refint.ldif\n\tdn: cn=module{0},cn=config\n\tchangetype: modify\n\tadd: olcModuleLoad\n\tolcModuleLoad: refint.la\n\t-\n\tdn: olcOverlay=refint,olcDatabase={1}mdb,cn=config\n\tchangetype: add\n\tobjectClass: olcOverlayConfig\n\tobjectClass: olcRefintConfig\n\tolcOverlay: refint\n\nldapadd -Q -Y EXTERNAL -H ldapi:// -f refint.ldif\n```\n\n```\n/etc/ldap/memberof.ldif\n\tdn: cn=module,cn=config\n\tchangetype: add\n\tcn: module\n\tobjectClass: olcModuleList\n\tolcModulePath: /usr/lib/ldap\n\t\n\tdn: cn=module{0},cn=config\n\tchangetype: modify\n\tadd: olcModuleLoad\n\tolcModuleLoad: memberof.la\n\t\n\tdn: olcOverlay=memberof,olcDatabase={1}mdb,cn=config\n\tchangetype: add\n\tobjectClass: olcConfig\n\tobjectClass: olcMemberOf\n\tobjectClass: olcOverlayConfig\n\tobjectClass: top\n\tolcOverlay: memberof\n\tolcMemberOfDangling: ignore\n\tolcMemberOfRefInt: TRUE\n\tolcMemberOfGroupOC: groupOfNames\n\tolcMemberOfMemberAD: member\n\tolcMemberOfMemberOfAD: memberOf\n\nldapmodify -Y EXTERNAL -H ldapi:/// -f memberof.ldif\n```\n\n- 为条目添加此属性：LDIF文件中先创建用户的dn，然后创建目标组的dn，在创建组的时候将关联的用户写在member属性中\n\n### 6.3 Self Service Password 自助密码管理\n- 容器部署，解决 php 依赖准备繁琐\n- 镜像 ltbproject/self-service-password:1.5.3\n- 为 admin 用户设置修改密码的权限\n```\n下列权限可以使得 \"admin,example,net\" 对这个域 \"dc=example,dc=tech\" 做用户添加、属性修改\nolcAccess: {0}to attrs=userPassword,shadowLastChange by dn=\"cn=admin,dc=example,dc=net\" write by anonymous auth by self write by * none\nolcAccess: {1}to dn.subtree=\"dc=example,dc=tech\" by dn.base=\"cn=admin,dc=example,dc=net\" write\n```\n- 需要对企业邮箱帐号开启设置-帐号与安全-客户端设置-客户端授权密码\n- ssp.conf.php  成功配置版本，并映射到容器： /home/example/sspasswd/conf.php:/var/www/conf/config.inc.local.php\n```php\n<?php\n$debug = false;\n$keyphrase = \"example\";\n$use_sms = false;\n$use_questions = false;\n$lang = \"cn,zh-CN\";\n$use_change = true;\n#$reset_url = $_SERVER['HTTP_X_FORWARDED_PROTO'] . \"://\" . $_SERVER['HTTP_X_FORWARDED_HOST'] . $_SERVER['SCRIPT_NAME'];\n$reset_url = \"https://ssp.example.net\" . $_SERVER['HTTP_X_FORWARDED_HOST'] . $_SERVER['SCRIPT_NAME'];\n$show_menu = false;\n$logo = \"images/logo.png\";                # 这两项在配置前，需要确保图片映射路径在容器内部的 /var/www/html/images 下\n$background_image = \"images/back.png\";\n$default_action = \"sendtoken\";        # 默认展示在首页的修改密码的方式\n$show_menu = false;              # 关闭顶部的修改方式选择菜单\n\n# LDAP\n\n$ldap_url = \"ldap://10.13.3.107/\";\n$ldap_starttls = false;\n$ldap_binddn = \"cn=admin,dc=example,dc=net\";\n$ldap_bindpw = 'example@2020';\n#$ldap_bindpw = \"{SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\";\n$ldap_base = \"dc=example,dc=net\";\n#$ldap_base = \"dc=example,dc=tech\";    # 在这里同时书写两个，只会生效后一个域, 使用两个实例连接 ldap 服务\n$ldap_fullname_attribute = \"cn\";\n$ldap_filter = \"(&(objectClass=inetOrgPerson)($ldap_fullname_attribute={login}))\";\n$ldap_use_exop_passwd = false;\n$ldap_use_ppolicy_control = false;\n$TLS_REQCERT = \"allow\";\n\n# email\n$mail_attributes = array(\"mail\", \"gosaMailAlternateAddress\", \"proxyAddresses\");\n$mail_address_use_ldap = true;\n$mail_from = \"user5@example.net\";\n$mail_from_name = \"密码自主修改服务\";\n$mail_signature = \"如有疑问,请联系运维同事,英博智云.\";\n$notify_on_change = false;\n$mail_protocol = 'smtp';\n$mail_smtp_host = 'smtphz.qiye.163.com';\n$mail_smtp_auth = true;\n$mail_smtp_user = \"user5@example.net\";\n$mail_smtp_pass = 'TdhYDdgvN7Hpky5a';\n$mail_smtp_port = 465;\n$mail_smtp_timeout = 30;\n$mail_smtp_keepalive = false;\n$mail_smtp_secure = 'ssl';\n$mail_smtp_autotls = false;\n$mail_smtp_options = array();\n$mail_contenttype = 'text/plain';\n$mail_wordwrap = 0;\n$mail_charset = 'utf-8';\n$mail_priority = 3;\n\n# password policy\n$hash = \"SSHA\"; # 修改的用户密码传递过程中会采取这里指定的加密\n$pwd_min_length = 8;\n$pwd_max_length = 20;\n$pwd_min_lower = 1;\n$pwd_min_upper = 1;\n$pwd_min_digit = 1;\n$pwd_min_special = 1;\n$pwd_special_chars = \"^a-zA-Z0-9\";\n$pwd_complexity = 4;\n$pwd_no_reuse = true;\n$pwd_forbidden_words = array(\"example\", \"example\", \"example\", \"password\");\n$pwd_show_policy_pos = \"above\";\n$pwd_show_policy = \"onerror\";\n?>\n```\n\n```\ndocker run -p 8000:80 \\\n> --restart=always \\\n> --name sspass \\\n> -v /home/example/sspasswd/conf.php:/var/www/conf/config.inc.local.php \\\n> -itd docker.io/ltbproject/self-service-password\n```\n\n#### 6.3.1 不能进入修改链接 Token is not valid\n```\n注释了这两项\n#$use_tokens = true;\n#$crypt_tokens = true;\n```\n\n#### 6.3.2 反向代理 Self Service Password\n```\nupstream ssp {\n  server 10.13.3.108:8000;\n}\n\nserver {\n    listen 80;\n    server_name ssp.example.net;\n    return 301 https://$server_name$request_uri;\n}\nserver {\n    listen 443 ssl ;\n    server_name ssp.example.net;\n    ssl_certificate webmin/tls_ca.pem;\n    ssl_certificate_key webmin/tls_key.pem;\n\n    location / {\n      proxy_pass http://ssp;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto \"https\";\n      proxy_read_timeout 1800s;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection \"upgrade\";\n    }\n}\n```\n\n###  6.4 LDAP 对目录信息的数据做备份还原和迁移\n####  6.4.1 备份\n\n```\nsudo slapcat -n 3 -l ./back3.ldif           # -n 指定数据库编号，数字对应各个dit的数据库编号( 配置数据库----olcDatabase={0}config.ldif; 目录信息数据库----olcDatabase={1}mdb.ldif )\n```\n\n#### 6.4.2 恢复\n原服务器上恢复，服务需要暂停\n```\nsudo systemctl stop slapd\n```\n\n配置目录一般位于 `/etc/openldap/slapd.d`，将原有配置删除，然后使用 `slapadd` 导入新的配置\n```\n$ rm -rf /etc/ldap/slapd.d/*\n$ slapadd  -n  0  -F  /etc/ldap/slapd.d  -l  ./config.2021-09-18.ldif\n$ chown -R openldap:openldap /etc/ldap/slapd.d\n```\n\n数据目录一般位于 `/var/lib/ldap-*`，模拟时，将原有数据删除，然后使用 `slapadd` 导入新的数据：\n```\n$ rm  -rf  /var/lib/ldap-example/*         # 定制了不同的$default_action = \"sendtoken\";\n$show_menu = false;dit有不同的目录分别存储不同domain的内容，注意，导入前目录必需首先存在，且权属 openldap:openldap。\n$ slapadd -n 1 -F /etc/openldap/slapd.d -l ./data.2021-09-18.ldif\n$ chown -R openldap:openldap  /var/lib/ldap-example\n$ systemctl start slapd\n```\n#### 6.4.3 openldap的迁移\nplaybook 新建的服务器，执行恢复\n```\nslapadd -n 1 -F /etc/openldap/slapd.d -l ./data.2021-09-18.ldif\n\n[[如果导入失败，或者数据已存在，删除rm]] -rf /var/lib/ldap/*  重新导入\n```\n\n\n## 七、 命令资料\n> [来自此处](https://blog.csdn.net/jenyzhang/article/details/56487627)\n>ldap  \n    |-slapd             目录服务的主要程序  \n    |-slurpd           目录服务进行复制的程序  \n    |-slapadd           向目录中添加数据  \n    |-slapcat           把目录中的条目导出成ldif文件  \n    |-slapindex         重建目录的索引  \n    |-ldapcompare       对目录的条目的属性进行比较  \n    |-ldapadd           向目录服务中添加条目  \n    |-ldapdelete        删除目录中的条目  \n    |-ldapmodify        更新目录中条目的值  \n    |-ldapmodrdn        更改条目的DN  \n    |-ldappasswd        更改条目的密码  \n    |-ldapsearch        对目录进行查询\n\n>ldapadd  \n      -x   进行简单认证  \n      -D   用来绑定服务器的DN  \n      -h   目录服务的地址  \n      -w   绑定DN的密码  \n      -f   使用ldif文件进行条目添加的文件  \n      \n- 例子\n       ldapadd -x -D \"cn=root,dc=starxing,dc=com\" -w secret -f /root/test.ldif  \n       ldapadd -x -D \"cn=root,dc=starxing,dc=com\" -w secret (这样写就是在命令行添加条目)  \n       \n> ldapsearch  \n      -x   进行简单认证  \n      -D   用来绑定服务器的DN  \n      -w   绑定DN的密码  \n      -b   指定要查询的根节点  \n      -H   制定要查询的服务器\n      -s   指定搜索范围的类型\n     \n- 例子\n \tldapsearch -x -D \"cn=root,dc=starxing,dc=com\" -w secret -b \"dc=starxing,dc=com\"  \n       使用简单认证，用 \"cn=root,dc=starxing,dc=com\" 进行绑定，  \n       要查询的根是 \"dc=starxing,dc=com\"。这样会把绑定的用户能访问\"dc=starxing,dc=com\"下的所有数据显示出来。\n       ldapsearch -x -W -D \"cn=administrator,cn=users,dc=osdn,dc=zzti,dc=edu,dc=cn\" -b \"cn=administrator,cn=users,dc=osdn,dc=zzti,dc=edu,dc=cn\" -h troy.osdn.zzti.edu.cn\n\t ldapsearch -b \"dc=canon-is,dc=jp\" -H ldaps://192.168.0.92:636\n\t   (需要修改openldap客户端的配置文件ldap.conf,参考：http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm)\n\n>ldapdelete   \n      ldapdelete -x -D \"cn=Manager,dc=test,dc=com\" -w secret \"uid=test1,ou=People,dc=test,dc=com\"  \n      ldapdelete -x -D 'cn=root,dc=it,dc=com' -w secert 'uid=zyx,dc=it,dc=com'  \n      这样就可以删除'uid=zyx,dc=it,dc=com'记录了，应该注意一点，其下有子条目的不能删除  \n\t\n\t\n- 例子1  递归删除所有：\nldapdelete -x -D 'cn=administrator,dc=example,dc=net' -w example@2020 -r \"ou=example,dc=example,dc=net\"\n\n- 例子2  删除一个acl策略。acl-dele.ldif\n\t   dn: olcDatabase={3}mdb,cn=config\n\t   delete: olcAccess\n\t   olcAccess: {2}\n\t   olcAccess: {3}\n\t   olcAccess: {4}  \n   ldapmodify -Y EXTERNAL -H ldapi:/// -f acl-dele.ldif\n\n  \n> ldappasswd  \n    -x   进行简单认证  \n    -D   用来绑定服务器的DN  \n    -w   绑定DN的密码  \n    -S   提示的输入密码  \n    -s pass 把密码设置为pass  \n    -a pass 设置old passwd为pass  \n    -A   提示的设置old passwd  \n    -H   是指要绑定的服务器  \n    -I   使用sasl会话方式  \n    \n- 例子\n    ldappasswd -x -D 'cm=root,dc=it,dc=com' -w secret 'uid=zyx,dc=it,dc=com' -S  \n       New password:  \n       Re-enter new password:  \n       就可以更改密码了，如果原来记录中没有密码，将会自动生成一个userPassword。  \n    \n> ldapmodify  \n     -a 添加新的条目.缺省的是修改存在的条目.  \n     -C 自动追踪引用.  \n     -c 出错后继续执行程序并不中止.缺省情况下出错的立即停止.比如如果你的ldif 文件内的某个条目在[数据库](http://lib.csdn.net/base/mysql \"MySQL知识库\")内并不存在,缺省情况下程序立即退出,但如果使用了该参数,程序忽略该错误继续执行.  \n     -n 用于调试到服务器的通讯.但并不实际执行搜索.服务器关闭时,返回错误；服务器  \n       打开时,常和-v 参数一起[测试](http://lib.csdn.net/base/softwaretest \"软件测试知识库\")到服务器是否是一条通路.  \n     -v 运行在详细模块.在标准输出中打出一些比较详细的信息.比如:连接到服务器的  \n       ip 地址和端口号等.  \n     -M  打开 manage DSA IT 控制. -MM 把该控制设置为重要的.  \n     -f file 从文件内读取条目的修改信息而不是从标准输入读取.  \n    -x 使用简单认证.  \n    -D binddn 指定搜索的用户名(一般为一dn 值).  \n    -W 指定了该参数,系统将弹出一提示入用户的密码.它和-w 参数相对使用.  \n    -w bindpasswd 直接指定用户的密码. 它和-W 参数相对使用.  \n    -H ldapuri 指定连接到服务器uri(ip 地址和端口号,常见格式为 ldap://hostname:port ).如果使用了-H 就不能使用-h 和-p 参数.  \n    -h ldaphost 指定要连接的主机的名称/ip 地址.它和-p 一起使用 \n    -p ldapport 指定要连接目录服务器的端口号.它和-h 一起使用，如果使用了-h 和-p 参数就不能使用-H 参数.  \n    -Z 使用StartTLS 扩展操作.如果使用-ZZ,命令强制使用StartTLS 握手成功.  \n    -V 启用证书认证功能,目录服务器使用客户端证书进行身份验证,必须与-ZZ 强制启用  \n       TLS 方式配合使用,并且匿名绑定到目录服务器.  \n    -e 设置客户端证书文件,例: -e cert/client.crt  \n    -E 设置客户端证书私钥文件,例: -E cert/client.key  \n\n- 例子\nldapmodify -x -D \"cn=root,dc=it,dc=com\" -W -f modify.ldif    #   将modify.ldif中的记录更新原有的记录。\n\n\n## 八、 参考链接\n[指南](https://github.com/jt6562/LDAP-read-notes/blob/master/ldap-guide/OpenLDAP%E7%AE%A1%E7%90%86%E5%91%98%E6%89%8B%E5%86%8C.md)\n[知识总结](https://www.cnblogs.com/kevingrace/p/5773974.html)\n[参考1](https://www.cnblogs.com/js1314/p/12887893.html)\n[参考2](https://cloud.tencent.com/developer/article/1932586)\n[参考3](https://blog.csdn.net/u011607971/article/details/121126289?spm=1001.2014.3001.5501#t3)\n[Ubuntu wiki](https://ubuntu.com/server/docs/service-ldap-with-tls)\n[tls参考1](https://www.cnblogs.com/shu-sheng/p/14450815.html)\n[tls参考2](https://hmli.ustc.edu.cn/doc/linux/ubuntu-ldap/ubuntu-ldap.html#id14)\n[tls参考3](https://zhuanlan.zhihu.com/p/643010354)\n\n## 九、问题：\n### 9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果\n###  9.2 日志功能开启失败\n\t已经调整日志级别，在系统日志中查看并grep\n### 9.3 证书缺失(只能使用ldap01,这个信息查询）\n\t采取使用权威证书\n### 9.4 重启slap报错 tls init   failed\n\t解决办法：重新生成证书\n### 9.5 报错 ldap_start_tls: Connect error (-11)    \\n    additional info: (unknown error code)\n\t可能是由于服务器证书的通用名（Common Name）字段是否与主机名不一致，请检查主机名和服务器证书\n### 9.6 连接问题\n```\nldapsearch -H ldaps://ldap.example.top  -D \"cn=admin,dc=example,dc=top\" -W            # 在服务器本机执行此查询的报错。但是在另一个机器可以成功查询\n\tldap_sasl_bind(SIMPLE): Can't contact LDAP server (-1)                                 # 配置 ldap.conf 之后成功解决并有输出 tls=demand/allow----作用是证书检查\n```\n### 9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”\n```\n1. 首先尝试重新部署，发现执行镜像复制的剧本之前可以正常创建所有的条目\n    解决：在mirror mode 开启时，需要指定相应的数据库\n2.  shadow context; no update referral  根本原因是需要检查权限\n```\n### 9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询\n- 脚本中的组织信息ldif文件有问题，经测试不影响。\n- memberOf，属性不可单独添加，通过 groupofNames 指定 member 之后会自动关联。已经修正使用方式，结果未改变。\n- 2204 系统和 2004 系统的slapd版本不一致（并没有影响）。\n- 将orgnization的任务和前一部分拆分，否则会出现读取不到 rootdn（手动测试是成功的）（然而脚本中修改后并没有解决这个问题）。\n- 将organization拆分，在此之前重启服务，未解决。\n- 将organization拆分，在此之前先重启虚拟机。（有效、怀疑是服务中某些连接的状态在ansible执行中没有更新）（仍然失效了，经过一夜之后失效）。\n- 另一台2204主机安装正常使用，怀疑虚拟机系统问题。\n\n## 十、 验证\n### 10.1 检测连接命令： \n\n ldaps://    ----ldap over ssl  使用636 ，从连接开始加密   ;        ldap://           ---ldap_start_tls(-ZZ参数):    使用389，从传输开始加密\n```\nldapsearch -H ldaps://ldap01.example.top:636 -D \"cn=admin,dc=example,dc=top\" -W -b \"dc=example,dc=top\" -s sub \"(objectClass=person)\"\n\nldapsearch -H ldap://10.13.3.106  -D \"cn=admin,dc=example,dc=top\" -W -b \"dc=example,dc=top\" -s sub \"(objectClass=person)\"\n\nldapsearch -H ldap://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W -b \"dc=example,dc=top\" -s sub \"(objectClass=person)\"\n```\n### 10.2 验证和日志\ntag 101 应表明在查询; tag 97 是在认证\n```\nldapsearch -H ldap://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W   -ZZ      #  启用了tls功能 ，-ZZ 参数，仍然是 389 端口，连接后在传输过程中加密\n\t\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 fd=14 ACCEPT from IP=10.13.3.107:60674 (IP=0.0.0.0:389)\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 EXT oid=1.3.6.1.4.1.1466.20037\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 STARTTLS\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 RESULT oid= err=0 text=\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 fd=14 TLS established tls_ssf=256 ssf=256\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 BIND dn=\"cn=admin,dc=example,dc=top\" method=128\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 BIND dn=\"cn=admin,dc=example,dc=top\" mech=SIMPLE ssf=0\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 RESULT tag=97 err=0 text=\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=2 SRCH base=\"dc=example,dc=top\" scope=2 deref=0 filter=\"(objectClass=*)\"\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=2 SEARCH RESULT tag=101 err=0 nentries=6 text=\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=3 UNBIND\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 fd=14 closed\n```\n\n```\nldapsearch -H ldap://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W        # 明文传输\n\t\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 fd=14 ACCEPT from IP=10.13.3.107:37760 (IP=0.0.0.0:389)\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" method=128\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" mech=SIMPLE ssf=0\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 RESULT tag=97 err=0 text=\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=1 SRCH base=\"dc=example,dc=top\" scope=2 deref=0 filter=\"(objectClass=*)\"\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=1 SEARCH RESULT tag=101 err=0 nentries=6 text=\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=2 UNBIND\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 fd=14 closed\n```\n\n```\nldapsearch -H ldaps://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W        # 从连接就开始加密\n\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 ACCEPT from IP=10.13.3.107:58726 (IP=0.0.0.0:636)\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 TLS established tls_ssf=256 ssf=256\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" method=128\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 BIND dn=\"cn=admin,dc=example,dc=top\" mech=SIMPLE ssf=0\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 RESULT tag=97 err=0 text=\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=1 SRCH base=\"dc=example,dc=top\" scope=2 deref=0 filter=\"(objectClass=*)\"\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=1 SEARCH RESULT tag=101 err=0 nentries=6 text=\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=2 UNBIND\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 closed\n```\n\n```\n ldapsearch -H ldaps://ldap01.example.top  -D \"cn=admin,dc=example,dc=top\" -W -ZZ\n\t\tldap_start_tls: Operations error (1)\n\t        additional info: TLS already started\n\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 ACCEPT from IP=10.13.3.107:39894 (IP=0.0.0.0:636)\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 TLS established tls_ssf=256 ssf=256\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 EXT oid=1.3.6.1.4.1.1466.20037\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 STARTTLS\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 RESULT oid= err=1 text=TLS already started                # 证明二者冲突，不能同时开启\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=1 UNBIND\n\tSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 closed\n```\n\n## 十一、应用服务\n### 11.1 建立 ldap 管理/只读帐号\n```\ndn: cn=admin,dc=xxx,dc=xx \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi  \n  \n-  \ndn: cn=reader,dc=xxx2,dc=xx2  \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: {SSHA}UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n```\n\n###  11.2 详细的公司架构 ldif\n```\ndn: ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example  \n  \ndn: ou=example-bod,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-bod  \n  \ndn: cn=user1,ou=example-bod,ou=example,dc=example,dc=net  \ncn: user1  \ndepartmentnumber: 1  \ndisplayname: Zheng Yu  \nmail: user1@example.net  \nobjectclass: inetOrgPerson  \nsn: Zheng  \ntitle: President  \nuid: 10000  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net  \ncn: example-bod-admin  \nmember: cn=user1,ou=example-bod,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-bus,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-bus  \n  \ndn: cn=user8,ou=example-bus,ou=example,dc=example,dc=net  \ncn: user8  \ndepartmentnumber: 2  \ndisplayname: Sun Minghong  \nmail: user8@example.net  \nobjectclass: inetOrgPerson  \nsn: Sun  \ntitle: Financial Manager  \nuid: 10001  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-bus-admin,ou=example-bus,ou=example,dc=example,dc=net  \ncn: example-bus-admin  \nmember: cn=user8,ou=example-bus,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-sys,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-sys  \n  \ndn: cn=user2,ou=example-sys,ou=example,dc=example,dc=net  \ncn: user2  \ndepartmentnumber: 3  \ndisplayname: Xie Jian  \nmail: user2@example.net  \nobjectclass: inetOrgPerson  \nsn: Xie  \ntitle: Senior Systems Engineer  \nuid: 10002  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net  \ncn: example-sys-admin  \nmember: cn=user2,ou=example-sys,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: cn=user5,ou=example-sys,ou=example,dc=example,dc=net  \ncn: user5  \ndepartmentnumber: 3  \ndisplayname: Long Chao  \nmail: user5@example.net  \nobjectclass: inetOrgPerson  \nsn: Long  \ntitle: System Engineer  \nuid: 10003  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-sys-junior,ou=example-sys,ou=example,dc=example,dc=net  \ncn: example-sys-junior  \nmember: cn=user5,ou=example-sys,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-ops,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-ops  \n  \ndn: cn=user6.tang,ou=example-ops,ou=example,dc=example,dc=net  \ncn: user6.tang  \ndepartmentnumber: 4  \ndisplayname: Tang Binchao  \nmail: user6.tang@example.net  \nobjectclass: inetOrgPerson  \nsn: Tang  \ntitle: System Engineer  \nuid: 10004  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net  \ncn: example-ops-admin  \nmember: cn=user6.tang,ou=example-ops,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-dev,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-dev  \n  \ndn: cn=user3,ou=example-dev,ou=example,dc=example,dc=net  \ncn: user3  \ndepartmentnumber: 5  \ndisplayname: Chen Cheng  \nmail: user3@example.net  \nobjectclass: inetOrgPerson  \nsn: Chen  \ntitle: Senior Development Engineer  \nuid: 10005  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=example-dev-admin,ou=example-dev,ou=example,dc=example,dc=net  \ncn: example-dev-admin  \nmember: cn=user3,ou=example-dev,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: cn=user4.li,ou=example-dev,ou=example,dc=example,dc=net  \ncn: user4.li  \ndepartmentnumber: 5  \ndisplayname: Li user4  \nmail: user4.li@example.net  \nobjectclass: inetOrgPerson  \nsn: Li  \ntitle: Development Engineer  \nuid: 10006  \nuserpassword: {SSHA}W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn=user7,ou=example-dev,ou=example,dc=example,dc=net  \ncn: user7  \ndepartmentnumber: 5  \ndisplayname: Luo Xujun  \nmail: user7@example.net  \nobjectclass: inetOrgPerson  \nsn: Luo  \ntitle: Development Engineer  \nuid: 10007  \nuserpassword: {SSHA}/2+Coei5Fje+th7mOJgu43Ms3hBia2Qu  \n  \ndn: cn=example-dev-senior,ou=example-dev,ou=example,dc=example,dc=net  \ncn: example-dev-senior  \nmember: cn=user4.li,ou=example-dev,ou=example,dc=example,dc=net  \nmember: cn=user7,ou=example-dev,ou=example,dc=example,dc=net  \nobjectclass: groupOfNames  \n  \ndn: ou=example-rob,ou=example,dc=example,dc=net  \nobjectclass: organizationalUnit  \nou: example-rob\n```\n\n###  11.3 第一版 ACL\n```\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {2}to dn.subtree=\"ou=example,dc=example,dc=net\" filter=\"(&(objectClass=inetOrgPerson)(|(memberOf=cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net)(memberOf=cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net)(memberOf=cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net)))\" by dn.base=\"cn=exampleread,dc=ibexample,dc=com\" read\n\ndn: olcDatabase={4}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {0}to attrs=userPassword by self write by dn.base=\"cn=exampleadmin,dc=example,dc=net\" write  by anonymous auth  by * none\nolcAccess: {2}to dn.subtree=\"dc=ibexample,dc=com\" by dn.base=\"cn=exampleadmin,dc=example,dc=net\" write by dn.base=\"cn=exampleread,dc=ibexample,dc=com\" read\n```\n\n###  11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）\n- 添加\n```\ndn: olcDatabase={1}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {2}to dn.subtree=\"dc=example,dc=net\" by dn.base=\"cn=exampleread,dc=example,dc=net\" read\nolcAccess: {3}to dn.subtree=\"dc=example,dc=net\" filter=\"(&(objectClass=inetOrgPerson)(|(memberOf=cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net)(memberOf=cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net)(memberOf=cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net)))\" by dn.base=\"cn=exampleread,dc=ibexample,dc=com\" read\n \ndn: olcDatabase={2}mdb,cn=config\nchangetype: modify\nadd: olcAccess\nolcAccess: {0}to attrs=userPassword by self write by dn.base=\"cn=exampleadmin,dc=example,dc=net\" write  by anonymous auth  by * none\nolcAccess: {2}to dn.subtree=\"dc=ibexample,dc=com\" by dn.base=\"cn=exampleadmin,dc=example,dc=net\" write by dn.base=\"cn=exampleread,dc=ibexample,dc=com\" read by dn.base=\"cn=exampleread,dc=example,dc=net\" read\n```\n\n- 删除\n```\ndn: olcDatabase={1}mdb,cn=config\ndelete: olcAccess\nolcAccess: {2}to..........\nolcAccess: {3}to........\n \n\nldapmodify -Y EXTERNAL -H ldapi:/// -f acl-dele.ldif\n```\n\n- 数据库内 ACL 顺序测试，{}里面是优先级，生效在前（涉及范围大的 ACL 应书写在前）\n```\nolcAccess: {0}to attrs=userPassword by self write by anonymous auth  by dn.base=\"cn=admin,dc=example,dc=net\" write  by * none   \nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcAccess: {2}to dn.subtree=\"cn=example-sys-admin,ou=example-sys,dc=example,dc=tech\" by dn.base=\"cn=reader,dc=example,dc=net\" read by dn.base=\"cn=admin,dc=example,dc=net\" write    # 如果没有此条acl,该条目将不能在 lam 中被 admin 管理\n olcAccess: {3}to dn.subtree=\"dc=example,dc=tech\" by dn.base=\"cn=admin,dc=example,dc=net\" write      # 此条优先级最低\n```\n\n## 十二、集成其他应用\n### 12.1  conflunce \n```\nolcAccess: {0}to attrs=userPassword by self write by anonymous auth by * none\nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcAccess: {2}to dn.subtree=\"dc=example,dc=net\" by dn.base=\"cn=reader,dc=ibexample,dc=com\" read\n```\n#### 12.1.1 连接 之后的 acl 过滤案例\n'(&(objectclass=inetorgperson)(|(cn=user5)(cn=user2)))'  过滤出指定用户----在用户模式设置。\n\n'(&(objectclass=groupOfNames)(|(cn=example-sys-junior)(cn=example-sys-admin)))' 过滤指定组----在组模式设置（在ldap中创建的组 objectclass 是groupOfNames）\n \n#### 12.1.2 更详细的 acl 需求\n- example\n```\nolcAccess: {0}to attrs=userPassword by self write  by anonymous auth  by * none\nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcAccess: {2}to dn.subtree=\"dc=example,dc=net\" filter=\"(&(objectClass=inetOrg\n Person)(|(memberOf=cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net\n )(memberOf=cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net)(member\n Of=cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net)))\" by dn.base=\n \"cn=reader,dc=ibexample,dc=com\" read  by dn.base= \"cn=reader,dc=example,dc=net\" read\n\nsearch时，必须要具体到用户层级，例如nextcloud，需要指定基础用户树如下\n\ncn=user2,ou=example-sys,ou=example,dc=example,dc=net\ncn=user1,ou=example-bod,ou=example,dc=example,dc=net\ncn=user6.tang,ou=example-ops,ou=example,dc=example,dc=net\ndc=ibexample,dc=com\n```\n\n- example\n```\nolcAccess: {0}to attrs=userPassword by self write by dn.base=\"cn=admin,dc=example,dc=net\" write  by anonymous auth  by * none\nolcAccess: {1}to attrs=shadowLastChange by self write by * read\nolcAccess: {2}to dn.subtree=\"dc=ibexample,dc=com\" by dn.base=\"cn=admin,dc=example,dc=net\" write by dn.base=\"cn=reader,dc=ibexample,dc=com\" read\n```\n\n### 12.2 集成 vault\n- 过滤特定用户\n```\n(&(objectClass=inetOrgPerson)({{.UserAttr}}={{.Username}})(|(cn=user2)(cn=user1)(cn=%s)))\n```\n- 过滤某个组\n```\n(&(objectClass=inetOrgPerson)({{.UserAttr}}={{.Username}})(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net))\n```\n- 过滤多个组\n```\n(&(objectclass=inetOrgPerson)({{.UserAttr}}={{.Username}})(|(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net)(memberof=CN=example-dev-admin,OU=example-dev,OU=example,DC=example,DC=net)))\n```\n- 过滤特定用户和特定组\n```\n(&(objectclass=inetOrgPerson)({{.UserAttr}}={{.Username}})(|(|(cn=user4.li))(|(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net)(memberof=CN=example-dev-admin,OU=example-dev,OU=example,DC=example,DC=net))(cn=%s)))\n```\n- 错误\n```\n(&(objectClass=inetOrgPerson)({{.UserAttr}}={{.Username}})(|(cn=user2)(cn=user1))(cn=%s))  会失败\n\n以下 1 条，写在group filter的时候会出现不能过滤，所有人都可以登录\n(&(objectclass=inetOrgPerson)(|(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net)(memberof=CN=example-dev-admin,OU=example-dev,OU=example,DC=example,DC=net)))\n```\n\n\n\n","slug":"Multiple-Domians-in-OpenLDAP-Use-Case","published":1,"updated":"2024-04-20T03:18:37.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodhl000f80rv78ql8get","content":"<h1 id=\"OpenLDAP\"><a href=\"#OpenLDAP\" class=\"headerlink\" title=\"OpenLDAP\"></a>OpenLDAP</h1><h2 id=\"一、-概念\"><a href=\"#一、-概念\" class=\"headerlink\" title=\"一、 概念\"></a>一、 概念</h2><p><a href=\"https://www.openldap.org/doc/admin26/guide.html\">官方手册</a></p>\n<h3 id=\"1-1-常用属性\"><a href=\"#1-1-常用属性\" class=\"headerlink\" title=\"1.1 常用属性\"></a>1.1 常用属性</h3><ul>\n<li>DN：Distinguished Name，LDAP记录项的标识，有唯一性，例如：dc:”cn&#x3D;admin,ou&#x3D;developer,dc&#x3D;163,dc&#x3D;com”  </li>\n<li>dc&#x3D; DomainComponent 为域组件，域名的一部分</li>\n<li>cn&#x3D;CommonName 为记录名，表示一个实体，最长到80个字符，可以为中文；</li>\n<li>ou&#x3D;OrganizationUnit 为组织单位，用于分类，最多四级，每级最长32字符，可以为中文；</li>\n<li>uid&#x3D;User id 为用户的唯一标识</li>\n<li>c&#x3D;Country 为国家名，可选，为2个字符长</li>\n<li>o&#x3D;Organization 为组织名，可选，可以3—64个字符长</li>\n</ul>\n<h2 id=\"二、-手动安装和配置-LDAP\"><a href=\"#二、-手动安装和配置-LDAP\" class=\"headerlink\" title=\"二、 手动安装和配置 LDAP\"></a>二、 手动安装和配置 LDAP</h2><h3 id=\"2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务\"><a href=\"#2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务\" class=\"headerlink\" title=\"2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)\"></a>2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo apt install  -y slapd ldap-utils<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-2-重新配置-OpenLDAP，创建-base-dn\"><a href=\"#2-2-重新配置-OpenLDAP，创建-base-dn\" class=\"headerlink\" title=\"2.2  重新配置 OpenLDAP，创建 base dn\"></a>2.2  重新配置 OpenLDAP，创建 base dn</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo dpkg-reconfigure slapd   # 主要配置密码 (密码在下一步重置，便于配置连接)，DNS domain name(即 LDAP 服务中的 base dn)\n\n\t 说明：\n\t第一步回答 No\n\t第二步填写域名，比如 mycompany.com\n\t第三步填写组织名，比如 Company\n\t第四步填写管理员密码，比如 secret；第五步确认管理员密码\n\t第六步选择使用的数据库后端，比如 MDB\n\t第七步选择在清除 slapd 时是否移除数据库，比如 Yes\n\t第八步选择是否移除旧数据库，比如 Yes<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码\"><a href=\"#2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码\" class=\"headerlink\" title=\"2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码\"></a>2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">slappasswd\n\t<span class=\"token punctuation\">&#123;</span>SSHA<span class=\"token punctuation\">&#125;</span>UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<ul>\n<li>通过数据库修改admin用户的ldif文件<pre class=\"line-numbers language-ldif\" data-language=\"ldif\"><code class=\"language-ldif\">&#x2F;etc&#x2F;ldap&#x2F;slapd.d&#x2F;cn\\&#x3D;config&#x2F;olcDatabase\\&#x3D;\\&#123;1\\&#125;mdb.ldif\n\tolcDatabase: &#123;1&#125;mdb\n\tolcSuffix: dc&#x3D;example,dc&#x3D;top\n\tolcRootDN: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top\n\tolcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>olcDatabase: 定义使用的后端数据存储格式,遵循默认</li>\n<li>olcSuffix: 设置 LDAP 服务的根</li>\n<li>olcRootDN: 设置管理员用户的 dn</li>\n<li>olcRootPW: 管理员用户的密码</li>\n<li>修改后重启服务<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo slaptest -u   # 检查配置文件\nsudo systemctl enable slapd  --now\n\nsudo slapcat        # 输出看到当前数据库内容<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"2-4-正确的修改olcRootPW-管理员用户的密码\"><a href=\"#2-4-正确的修改olcRootPW-管理员用户的密码\" class=\"headerlink\" title=\"2.4 正确的修改olcRootPW: 管理员用户的密码\"></a>2.4 正确的修改olcRootPW: 管理员用户的密码</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nreplace: olcRootPW\nolcRootPW: example2020  # 保存在数据库文件中的时候将会被加密<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f passmodify.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">同时进入web ui，修改admin账户的密码，如果不修改两个密码都能管理域，二者修改一致之后，才是新的管理密码生效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-5-简单结构展示\"><a href=\"#2-5-简单结构展示\" class=\"headerlink\" title=\"2.5 简单结构展示\"></a>2.5 简单结构展示</h3><p>略</p>\n<h3 id=\"2-6-创建base-dn\"><a href=\"#2-6-创建base-dn\" class=\"headerlink\" title=\"2.6 创建base dn\"></a>2.6 创建base dn</h3><h4 id=\"2-6-1-查看LDAP服务器的根目录信息\"><a href=\"#2-6-1-查看LDAP服务器的根目录信息\" class=\"headerlink\" title=\"2.6.1 查看LDAP服务器的根目录信息\"></a>2.6.1 查看LDAP服务器的根目录信息</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapsearch -x -LLL -b &#39;&#39; -s base &#39;(objectclass&#x3D;*)&#39;\n\tdn:\n\tobjectClass: top\n\tobjectClass: OpenLDAProotDSE<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-6-2-基于-ldif-文件直接创建，不使用图形化交互。创建之后，对这个-base-dn-设置管理员的密码\"><a href=\"#2-6-2-基于-ldif-文件直接创建，不使用图形化交互。创建之后，对这个-base-dn-设置管理员的密码\" class=\"headerlink\" title=\"2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码\"></a>2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">-\ndn: dc&#x3D;example,dc&#x3D;top\nchangetype: add\nobjectClass: top\nobjectClass: domain\n\n\n-\ndn: o&#x3D;example,dc&#x3D;example,dc&#x3D;top\nchangetype: add\nobjectClass: organization\no: example<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapmodify -x -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -w example@2020  -f organization.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-7-创建多个-DIT-base-dn-（可以考虑尝试后端用-mysql-做数据库）\"><a href=\"#2-7-创建多个-DIT-base-dn-（可以考虑尝试后端用-mysql-做数据库）\" class=\"headerlink\" title=\"2.7 创建多个 DIT + base dn （可以考虑尝试后端用 mysql 做数据库）\"></a>2.7 创建多个 DIT + base dn （可以考虑尝试后端用 <code>mysql</code> 做数据库）</h3><h4 id=\"2-7-1-为新的库，准备存储路径，并通过apparmor做权限限制\"><a href=\"#2-7-1-为新的库，准备存储路径，并通过apparmor做权限限制\" class=\"headerlink\" title=\"2.7.1 为新的库，准备存储路径，并通过apparmor做权限限制\"></a>2.7.1 为新的库，准备存储路径，并通过<code>apparmor</code>做权限限制</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">mkdir  &#x2F;var&#x2F;lib&#x2F;ldap2\nchown openldap:openldap  &#x2F;var&#x2F;lib&#x2F;ldap2\nvim &#x2F;etc&#x2F;apparmor.d&#x2F;usr.sbin.slapd\n\t\t# the databases and logs\n\t\t&#x2F;var&#x2F;lib&#x2F;ldap2&#x2F; r,\n\t\t&#x2F;var&#x2F;lib&#x2F;ldap2&#x2F;** rwk,\n\t\t\n\t\t# lock file\n\t\t&#x2F;var&#x2F;lib&#x2F;ldap2&#x2F;alock kw,\n\nsudo systemctl  reload  apparmor <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-7-2-准备-ldif-文件，创建新的-DIT（可以自定义路径）\"><a href=\"#2-7-2-准备-ldif-文件，创建新的-DIT（可以自定义路径）\" class=\"headerlink\" title=\"2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）\"></a>2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;2&#125;mdb,cn&#x3D;config\nchangetype: add\nobjectClass: olcDatabaseConfig\nobjectClass: olcMdbConfig\nolcDbDirectory: &#x2F;var&#x2F;lib&#x2F;ldap2&#x2F;\nolcDatabase: &#123;2&#125;Mdb\nolcDbIndex: objectClass eq\nolcDbIndex: cn,uid eq\nolcDbIndex: uidNumber,gidNumber eq\nolcDbIndex: member,memberUid eq\nolcLastMod: TRUE\nolcMonitoring: TRUE\nolcDBNoSync: TRUE\nolcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by anonymous auth by * non\n e\nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcSuffix: dc&#x3D;example,dc&#x3D;tech\nolcRootDN: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;tech\nolcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo  ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f domian2.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-7-3-新增并设置管理员\"><a href=\"#2-7-3-新增并设置管理员\" class=\"headerlink\" title=\"2.7.3 新增并设置管理员\"></a>2.7.3 新增并设置管理员</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">-\ndn: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;tech\nobjectClass: simpleSecurityObject\nobjectClass: organizationalRole\ncn: admin\nuserPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n# 以下是playbook中模板文件\n-\ndn: cn&#x3D;admin,&#123;&#123; item.base_dn &#125;&#125;  \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapadd -x -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;tech&quot; -w example@2020 -f basedn2.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-7-4-多-DIT-跨域-ACL\"><a href=\"#2-7-4-多-DIT-跨域-ACL\" class=\"headerlink\" title=\"2.7.4 多 DIT 跨域 ACL\"></a>2.7.4 多 DIT 跨域 ACL</h4><ul>\n<li><p>查询服务器的域</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -x -H ldap:&#x2F;&#x2F;10.13.3.107 -b &quot;&quot; -s base namingContexts<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li><p>设置一个全权限的 acl ，跨域访问，相应的用户需已经提前创建</p>\n</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">让这个dn 用户: cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech ;  可以阅读这个base dn : dc&#x3D;example,dc&#x3D;top 下的所有条目.\n对应关系：数据库----&#123;1&#125;mdb  存储的数据是来自 dn: dc&#x3D;example,dc&#x3D;top 。即，对谁的访问则将 acl 添加在谁的库下  \n\ndn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; by dn.base&#x3D;&quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapmodify   -Y   EXTERNAL   -H   ldapi:&#x2F;&#x2F;&#x2F;   -f  xxx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h4 id=\"2-7-5-测试\"><a href=\"#2-7-5-测试\" class=\"headerlink\" title=\"2.7.5 测试\"></a>2.7.5 测试</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">root@example-sys-test-06:&#x2F;etc&#x2F;ldap&#x2F;example# ldapsearch -x -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -D &quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; -w example@2020\n\t\t# extended LDIF\n\t\t#\n\t\t# LDAPv3\n\t\t# base &lt;dc&#x3D;example,dc&#x3D;top&gt; with scope subtree\n\t\t# filter: (objectclass&#x3D;*)\n\t\t# requesting: ALL\n\t\t#\n\t\t\n\t\t# example.top\n\t\tdn: dc&#x3D;example,dc&#x3D;top\n\t\tobjectClass: top\n\t\tobjectClass: domain\n\t\tdc: example\n\t\t\n\t\t# admin, example.top\n\t\tdn: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top\n\t\tobjectClass: simpleSecurityObject\n\t\tobjectClass: organizationalRole\n\t\tcn: admin\n\t\t\n\t\t# search result\n\t\tsearch: 2\n\t\tresult: 0 Success\n\t\t\n\t\t# numResponses: 3\n\t\t# numEntries: 2\nroot@example-sys-test-06:&#x2F;etc&#x2F;ldap&#x2F;example# ldapsearch -x -b &quot;dc&#x3D;example,dc&#x3D;tech&quot; -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -w example@2020\n\t\t# extended LDIF\n\t\t#\n\t\t# LDAPv3\n\t\t# base &lt;dc&#x3D;example,dc&#x3D;tech&gt; with scope subtree\n\t\t# filter: (objectclass&#x3D;*)\n\t\t# requesting: ALL\n\t\t#\n\t\t\n\t\t# search result\n\t\tsearch: 2\n\t\tresult: 32 No such object\n\t\t\n\t\t# numResponses: 1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>测试的日志<pre class=\"line-numbers language-none\"><code class=\"language-none\">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 fd&#x3D;12 ACCEPT from IP&#x3D;127.0.0.1:59834 (IP&#x3D;0.0.0.0:389)\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; method&#x3D;128\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; mech&#x3D;SIMPLE ssf&#x3D;0\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;2 text&#x3D;\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;2 UNBIND\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 fd&#x3D;12 closed\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 fd&#x3D;12 ACCEPT from IP&#x3D;127.0.0.1:34916 (IP&#x3D;0.0.0.0:389)\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;tech&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;32 nentries&#x3D;0 text&#x3D;\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;2 UNBIND\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 fd&#x3D;12 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"三、-web管理器配置\"><a href=\"#三、-web管理器配置\" class=\"headerlink\" title=\"三、 web管理器配置\"></a>三、 web管理器配置</h2><h3 id=\"3-1-安装-LAM-（用于管理的Web-UI）\"><a href=\"#3-1-安装-LAM-（用于管理的Web-UI）\" class=\"headerlink\" title=\"3.1 安装  LAM （用于管理的Web UI）\"></a>3.1 安装  LAM （用于管理的Web UI）</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">apt-get install ldap-account-manager<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>访问 <a href=\"http://ip/lam\">http://ip/lam</a> ，lam的所有配置都可以在web端配置，不需要去服务器上修改一行代码</p>\n<h4 id=\"3-1-1-LAM-configuration-helm-安装的主要修改内容\"><a href=\"#3-1-1-LAM-configuration-helm-安装的主要修改内容\" class=\"headerlink\" title=\"3.1.1 LAM configuration (helm 安装的主要修改内容)\"></a>3.1.1 LAM configuration (<a href=\"https://check-lc.github.io/ops_blog/2023/12/04/the-first-time-using-helm-charts/\">helm 安装的主要修改内容</a>)</h4><pre>\n主要内容：\n  LDAP_DOMAIN: example.net;ibexample.com\n  LDAP_BASE_DN: dc=example,dc=net;dc=ibexample,dc=com\n  LDAP_SERVER: ldaps://ldap01.example.net\n  LDAP_USER: cn=administrator,dc=example,dc=net\n  LAM_LANG: zh_CN\n  LAM_PASSWORD: lam\n</pre>\n\n<ul>\n<li><p>tree view编辑更高效</p>\n</li>\n<li><p>如果选择 docker 安装镜像：ghcr.io&#x2F;ldapaccountmanager&#x2F;lam:8.4@sha256:283726bd23510f1c3bfbdcbfe861e6599e070616543aed02e9756075c97a9938</p>\n</li>\n</ul>\n<h4 id=\"3-1-3-Nginx反向代理-LAM-Web-UI\"><a href=\"#3-1-3-Nginx反向代理-LAM-Web-UI\" class=\"headerlink\" title=\"3.1.3 Nginx反向代理 LAM Web UI\"></a>3.1.3 Nginx反向代理 LAM Web UI</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">upstream lam &#123;\n  server 10.13.3.108:8001;\n&#125;\n\nserver &#123;\n  listen 80;\n  server_name lam.example.net;\n  return 301 https:&#x2F;&#x2F;$server_name$request_uri;\n&#125;\n\nserver &#123;\n  server_name lam.example.net;\n  listen 443 ssl;\n  ssl_certificate webmin&#x2F;tls_ca.pem;\n  ssl_certificate_key webmin&#x2F;tls_key.pem;\n\n  location &#x2F; &#123;\n     proxy_pass http:&#x2F;&#x2F;lam&#x2F;;\n     proxy_set_header Host $host;\n     proxy_set_header X-Real-IP $remote_addr;\n     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n#     proxy_set_header X-Forwarded-Proto &quot;https&quot;;\n     proxy_read_timeout 1800s;\n     proxy_http_version 1.1;\n     proxy_set_header Upgrade $http_upgrade;\n     proxy_set_header Connection &quot;upgrade&quot;;\n    &#125;\n  &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-测试-phpldapadmin\"><a href=\"#3-2-测试-phpldapadmin\" class=\"headerlink\" title=\"3.2 测试 phpldapadmin\"></a>3.2 测试 phpldapadmin</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">Setting up php8.1 (8.1.2-1ubuntu2.14)                       # 版本信息，配置文件完整，存在证书认证并可以指定路径\nSetting up php (2:8.1+92ubuntu1) \nSetting up phpldapadmin (1.2.6.3-0.2)                                       <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"3-2-1-安装\"><a href=\"#3-2-1-安装\" class=\"headerlink\" title=\"3.2.1 安装\"></a>3.2.1 安装</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">apt-get install phpldapadmin -y\nnano &#x2F;etc&#x2F;phpldapadmin&#x2F;config.php\n\t$servers-&gt;setValue(&#39;server&#39;,&#39;name&#39;,&#39;My LDAP Server&#39;);                      # 辨识，区分的作用\n\t$servers-&gt;setValue(&#39;server&#39;,&#39;host&#39;,&#39;69.87.216.102&#39;);                              #  修改ip为服务器 ip\n\t$servers-&gt;;setValue(&#39;server&#39;,&#39;base&#39;,array(&#39;dc&#x3D;example,dc&#x3D;com&#39;));                    # 修改 array 内容为需求的根\n\t$servers-&gt;setValue(&#39;login&#39;,&#39;auth_type&#39;,&#39;session&#39;);                                              \n\t$servers-&gt;setValue(&#39;login&#39;,&#39;bind_id&#39;,&#39;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;com&#39;);           #   绑定登录帐号admin，相应修改 dn 号即可\n\t$servers-&gt;setValue(&#39;auto_number&#39;,&#39;min&#39;,array(&#39;uidNumber&#39;&#x3D;&gt;10000,&#39;gidNumber&#39;&#x3D;&gt;10000));   # 规定 uid，gid 数字表示的起始范围<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"3-2-2-为-phpLDAPadmin-配置-Apache\"><a href=\"#3-2-2-为-phpLDAPadmin-配置-Apache\" class=\"headerlink\" title=\"3.2.2 为 phpLDAPadmin 配置 Apache\"></a>3.2.2 为 phpLDAPadmin 配置 Apache</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">a2dissite 000-default.conf        # 禁用默认的 Apache 虚拟主机配置文件\nsystemctl restart apache2          <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、-主从架构-弃用，此配置需要在从服务器拉取-refresh\"><a href=\"#四、-主从架构-弃用，此配置需要在从服务器拉取-refresh\" class=\"headerlink\" title=\"四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)\"></a>四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)</h2><p><a href=\"https://darkdark.top/ch5-replication.html\">模式介绍</a></p>\n<h3 id=\"4-1-master-加载同步模块\"><a href=\"#4-1-master-加载同步模块\" class=\"headerlink\" title=\"4.1 master 加载同步模块\"></a>4.1 master 加载同步模块</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">cat &#x2F;etc&#x2F;ldap&#x2F;mod_syncprov.ldif\n\t\tdn: cn&#x3D;module,cn&#x3D;config\n\t\tobjectClass: olcModuleList\n\t\tcn: module\n\t\tolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldap\n\t\tolcModuleLoad: syncprov.la          # 此配置和上一句配置，实际是在请求这个路径的文件，&#x2F;usr&#x2F;lib&#x2F;ldap&#x2F;syncprov.la，不确定的可以用 find 查找\n\nldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f .&#x2F;mod_syncprov.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"4-2-同步设置\"><a href=\"#4-2-同步设置\" class=\"headerlink\" title=\"4.2 同步设置\"></a>4.2 同步设置</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">root@example-sys-test-06:&#x2F;etc&#x2F;ldap# cat syncprov.ldif \n\t\tdn: olcOverlay&#x3D;syncprov,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config       # 此处需要确认自己的数据库是什么样的，&#123;2&#125;hdb--旧版本默认 &#x2F; &#123;1&#125;mdb--新版本默认\n\t\tobjectClass: olcOverlayConfig\n\t\tobjectClass: olcSyncProvConfig\n\t\tolcOverlay: syncprov\n\t\tolcSpCheckpoint: 100 10\n\t\tolcSpSessionLog: 100\n\nldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f .&#x2F;syncprov.ldif                             # 修改并应用条目到 LDAP 服务  -Y EXTERNAL    将使用服务器配置的外部身份验证方法进行身份验证，而不是使用用户名和密码; -H 指定服务器连接; -f 指定文件<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"4-3-从服务器配置\"><a href=\"#4-3-从服务器配置\" class=\"headerlink\" title=\"4.3 从服务器配置\"></a>4.3 从服务器配置</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">root@example-sys-test-07:&#x2F;etc&#x2F;ldap# cat syncrepl.ldif\n\t\tdn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\n\t\tchangetype: modify\n\t\tadd: olcSyncRepl\n\t\tolcSyncRepl: rid&#x3D;002\n\t\t  provider&#x3D;ldap:&#x2F;&#x2F;10.13.3.106:389&#x2F;        # 此处开始与上一行有缩进\n\t\t  bindmethod&#x3D;simple\n\t\t  binddn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot;\n\t\t  credentials&#x3D;example@2020      \n\t\t  searchbase&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot;\n\t\t  scope&#x3D;sub\n\t\t  schemachecking&#x3D;on\n\t\t  type&#x3D;refreshAndPersist\n\t\t  retry&#x3D;&quot;5 5 300 +&quot;\n\t\t  attrs&#x3D;&quot;*,+&quot;\n\t\t  interval&#x3D;00:00:00:3\n\nldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f &#x2F;etc&#x2F;ldap&#x2F;syncrepl.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>运行中，修改主服务器内数据后，对从服务器u做刷新，可以看到是否同步</li>\n</ul>\n<p>参数说明：</p>\n<ul>\n<li>provider 为ldap master&#x2F;slave的地址 ;</li>\n<li>binddn：为域的基本信息，注这里一定要用管理员进行登录，否则同步不到用户的密码。</li>\n<li>credentials: ldap管理员的密码</li>\n<li>searchbase：选择要同步的独立域，根节点</li>\n<li>scope：设置所有的条目匹配</li>\n<li>schemachecking：设置同步更新时间检测</li>\n<li>type：同步模式为refreshAndPersist， refreshOnly 模式下后续操作由客户端轮询完成</li>\n<li>retry:同步更新重试次数和时间刚开始的5秒重试5次，以后每300秒重试一次</li>\n<li>attrs:复制全部属性</li>\n<li>interval 这里设置更新时间，这里为3秒一次，倒数第二个是分钟 以此类推。</li>\n</ul>\n<h2 id=\"四、-镜像复制（互为主从）\"><a href=\"#四、-镜像复制（互为主从）\" class=\"headerlink\" title=\"四、 镜像复制（互为主从）\"></a>四、 镜像复制（互为主从）</h2><p><a href=\"https://darkdark.top/ch5-replication.html\">模式介绍</a></p>\n<h3 id=\"4-1-为某域编辑-mirrorsync-ldif\"><a href=\"#4-1-为某域编辑-mirrorsync-ldif\" class=\"headerlink\" title=\"4.1 为某域编辑 mirrorsync.ldif\"></a>4.1 为某域编辑 mirrorsync.ldif</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;module,cn&#x3D;config         # 此段配置加载s ync 模块\nobjectClass: olcModuleList\ncn: module\nolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldap\nolcModuleLoad: syncprov.la     # 此配置和上一句，实际是在请求这个路径的文件，&#x2F;usr&#x2F;lib&#x2F;ldap&#x2F;syncprov.la，不确定的可 find 查找\n\n-\ndn: olcOverlay&#x3D;syncprov,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config        \n\t # 此处需确认自己的数据库，&#123;2&#125;hdb--为旧版本默认 &#x2F; &#123;1&#125;mdb--为新版本默认。路径 &#x2F;etc&#x2F;ldap&#x2F;slapd.d&#x2F;cn\\&#x3D;config&#x2F;olcDatabase\\&#x3D;\\&#123;1\\&#125;mdb.ldif\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 100\n\n-\ndn: cn&#x3D;config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 0                                        # 用于标识本机的 server id\n\ndn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config      # 以下配置用于开启复制，指定主服务器\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid&#x3D;000                             # 标识唯一的 replica id\n  provider&#x3D;ldaps:&#x2F;&#x2F;ldap01.example.top       # 看上述记录介绍参数\n  bindmethod&#x3D;simple\n  binddn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot;\n  credentials&#x3D;example@2020\n  searchbase&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot;\n  tls_reqcert&#x3D;allow\n  scope&#x3D;sub\n  schemachecking&#x3D;on\n  type&#x3D;refreshAndPersist\n  retry&#x3D;&quot;30 5 300 3&quot;\n  interval&#x3D;00:00:05:00\n-\nadd: olcMirrorMode                        # 开启 mirror mode\nolcMirrorMode: TRUE\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-2-ldap01-example-top下编辑-mirrorsync-ldif\"><a href=\"#4-2-ldap01-example-top下编辑-mirrorsync-ldif\" class=\"headerlink\" title=\"4.2 ldap01.example.top下编辑 mirrorsync.ldif\"></a>4.2 ldap01.example.top下编辑 mirrorsync.ldif</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;module,cn&#x3D;config\nobjectClass: olcModuleList\ncn: module\nolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldap\nolcModuleLoad: syncprov.la\n\n-\ndn: olcOverlay&#x3D;syncprov,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 100\n\n-\ndn: cn&#x3D;config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 1\n\ndn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid&#x3D;001\n  provider&#x3D;ldaps:&#x2F;&#x2F;ldap.example.top\n  bindmethod&#x3D;simple\n  binddn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot;\n  credentials&#x3D;example@2020\n  searchbase&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot;\n  tls_reqcert&#x3D;allow\n  scope&#x3D;sub\n  schemachecking&#x3D;on\n  type&#x3D;refreshAndPersist\n  retry&#x3D;&quot;30 5 300 3&quot;\n  interval&#x3D;00:00:05:00\n-\nadd: olcMirrorMode\nolcMirrorMode: TRUE\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"4-2-1-加载配置\"><a href=\"#4-2-1-加载配置\" class=\"headerlink\" title=\"4.2.1 加载配置\"></a>4.2.1 加载配置</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f mirrorsync.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"五、-TLS加密（自签名-权威证书）\"><a href=\"#五、-TLS加密（自签名-权威证书）\" class=\"headerlink\" title=\"五、 TLS加密（自签名&#x2F;权威证书）\"></a>五、 TLS加密（自签名&#x2F;权威证书）</h2><p>（自签名证书加密连接 nextcloud 失败，使用不便，采用 权威证书（多域合一）或stunnel）</p>\n<h3 id=\"5-1-CA中心创建证书\"><a href=\"#5-1-CA中心创建证书\" class=\"headerlink\" title=\"5.1 CA中心创建证书\"></a>5.1 CA中心创建证书</h3><pre><code>此时使用LDAP 主服务器 作为 CA 中心，自签名\n</code></pre>\n<ul>\n<li><p>安装 gnutls-bin 和 ssl-cert 包</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo apt install gnutls-bin ssl-cert<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li><p>为证书授权中心创建私钥</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-privkey --bits 4096 --outfile &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li><p>创建模板文件来定义CA</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ssl&#x2F;ca.info\n\t cn &#x3D; example (example company)  \n\t ca\n\t cert_signing_key\n\t expiration_days &#x3D; 3650<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>创建自签名 CA (根)证书</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-self-signed \\\n--load-privkey &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem \\\n--template &#x2F;etc&#x2F;ssl&#x2F;ca.info \\\n--outfile &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>Note：<br>  <code>--outfile</code>路径是正确的，将CA证书写入<code>/usr/local/share/ca-certificates</code>。<br>  <strong>update-ca-certificates</strong> 将从这里获取受信任的本地CA。如果要从<code>/usr/share/ca-certificates</code>获取CA，需要调用<code>dpkg-reconfigure ca-certificates</code></p>\n</li>\n<li><p>将新的 CA 根证书添加到受信任 CA 列表</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo update-ca-certificates     # 会创建一个&#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem符号链接，指向&#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates中的真实文件<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-2-创建-LDAP-服务的服务器私钥与证书\"><a href=\"#5-2-创建-LDAP-服务的服务器私钥与证书\" class=\"headerlink\" title=\"5.2 创建 LDAP 服务的服务器私钥与证书\"></a>5.2 创建 LDAP 服务的服务器私钥与证书</h3><ul>\n<li><p>创建私钥</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-privkey \\\n--bits 2048 \\\n--outfile &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n<li><p>服务器信息文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ssl&#x2F;ldap01.info\n\torganization &#x3D; example\n\tcn &#x3D; ldap01.example.top                     # 服务器证书的DN必须使用CN属性来命名服务器，并且CN必须携带服务器的完全限定域名，dns 需要有 A 记录解析\n\ttls_www_server\n\tencryption_key\n\tsigning_key\n\texpiration_days &#x3D; 365\n证书有效期为1年，仅对_&#96;ldap01&#96;_主机名有效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>创建LDAP服务器的证书</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-certificate \\\n--load-privkey &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem \\\n--load-ca-certificate &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem \\\n--load-ca-privkey &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem \\\n--template &#x2F;etc&#x2F;ssl&#x2F;ldap01.info \\\n--outfile &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_cert.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>调整权限</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo chgrp openldap &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem\nsudo chmod 0640 &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li><p>ca根证书加入到受信列表</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo cp   cacertificatefile  &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crt\nsudo update-ca-certificates<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>对LDAP服务配置证书</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;config\nadd: olcTLSCACertificateFile\nolcTLSCACertificateFile: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem\n-\nadd: olcTLSCertificateFile\nolcTLSCertificateFile: &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_cert.pem\n-\nadd: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>配置slapd-config数据库：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f certinfo.ldif <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li><p>报错调整，更改<code>certinfo.ldif</code>，将<code>add</code>改成了<code>replace</code>，可以解决以下问题。修改后再次执行<code>ldapmodify</code></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f certinfo.ldif \n\tSASL&#x2F;EXTERNAL authentication started SASL username: gidNumber&#x3D;0+uidNumber&#x3D;0,cn&#x3D;peercred,cn&#x3D;external,cn&#x3D;auth \n\tSASL SSF: 0 \n\tmodifying entry &quot;cn&#x3D;config&quot; ldap_modify: Inappropriate matching (18) \n\tadditional info: modify&#x2F;add: olcTLSCACertificateFile: no equality matching rule<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>ldap-client增添配置文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;ldap.conf\n\t# LDAP Defaults\n\t# See ldap.conf(5) for details\n\t# This file should be world readable but not world writable.\t\n\tBASE       dc&#x3D;example,dc&#x3D;top                                                      # LDAP服务的基础DN\n\tURI ldap:&#x2F;&#x2F;localhost:389 ldaps:&#x2F;&#x2F;localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径\n\tTLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;default&#x2F;slapd\n\tSLAPD_SERVICES&#x3D;&quot;ldap:&#x2F;&#x2F;&#x2F; ldapi:&#x2F;&#x2F;&#x2F; ldaps:&#x2F;&#x2F;&#x2F;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li><p>测试启动 TLS</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapwhoami -x -ZZ -H ldap:&#x2F;&#x2F;ldap01.example.com\nanonymous<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li><p>测试连接</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapwhoami -x -H ldaps:&#x2F;&#x2F;ldap01.example.com\nanonymous<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器\"><a href=\"#5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器\" class=\"headerlink\" title=\"5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器\"></a>5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器</h3><ul>\n<li>指定目录保存<pre class=\"line-numbers language-none\"><code class=\"language-none\">mkdir ldap02-ssl\ncd ldap02-ssl\ncerttool --generate-privkey \\\n--bits 2048 \\\n--outfile ldap02_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>编辑信息文件ldap02.info<pre class=\"line-numbers language-none\"><code class=\"language-none\">organization &#x3D; example\ncn &#x3D; ldap02.example.top                      \ntls_www_server\nencryption_key\nsigning_key\nexpiration_days &#x3D; 365<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>创建证书<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-certificate \\\n--load-privkey ldap02_slapd_key.pem \\\n--load-ca-certificate &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem \\\n--load-ca-privkey &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem \\\n--template ldap02.info \\\n--outfile ldap02_slapd_cert.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">cp &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem .\nscp -r ldap02-ssl user@ldap02_ip:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>从服务器中安装证书<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo cp ldap02_slapd_cert.pem ldap02_slapd_key.pem &#x2F;etc&#x2F;ldap\nsudo chgrp openldap &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_key.pem\nsudo chmod 0640 &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_key.pem\nsudo cp mycacert.pem &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crt\nsudo update-ca-certificates<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>对LDAP服务配置证书 <code>./certinfo.ldif </code><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;config\nadd: olcTLSCACertificateFile\nolcTLSCACertificateFile: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem\n-\nadd: olcTLSCertificateFile\nolcTLSCertificateFile: &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_cert.pem\n-\nadd: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>配置slapd-config数据库：<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f certinfo.ldif <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>增添配置文件<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;ldap.conf\n\tBASE       dc&#x3D;example,dc&#x3D;top                                                      # LDAP服务的基础DN\n\tURI ldap:&#x2F;&#x2F;localhost:389 ldaps:&#x2F;&#x2F;localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径\n\tTLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;default&#x2F;slapd\n\tSLAPD_SERVICES&#x3D;&quot;ldap:&#x2F;&#x2F;&#x2F; ldapi:&#x2F;&#x2F;&#x2F; ldaps:&#x2F;&#x2F;&#x2F;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li>测试启动 TLS<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapwhoami -x -ZZ -H ldap:&#x2F;&#x2F;ldap02.example.top\nanonymous<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li>测试连接<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapwhoami -x -H ldaps:&#x2F;&#x2F;ldap02.example.top\nanonymous<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-4-使用合法证书\"><a href=\"#5-4-使用合法证书\" class=\"headerlink\" title=\"5.4 使用合法证书\"></a>5.4 使用合法证书</h3><ul>\n<li><p>将新的 CA 根证书添加到受信任 CA 列表（客户端操作，权威证书按理不需要拷贝，未测试）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo   cp   _.example.top-chain.pem   &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crt\nsudo update-ca-certificates<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>准备服务器证书和私钥（服务端）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"> ls &#x2F;etc&#x2F;ldap\n\tcertinfo.ldif   _.example.top-crt.pem   _.example.top-key.pem\nsudo chgrp openldap &#x2F;etc&#x2F;ldap&#x2F;_.example.top-key.pem\nsudo chmod 0640 &#x2F;etc&#x2F;ldap&#x2F;_.example.top-key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>certinfo.ldif</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;config\nchangetype: modify\nreplace: olcTLSCACertificateFile\nolcTLSCACertificateFile: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem\n-\nreplace: olcTLSCertificateFile\nolcTLSCertificateFile: &#x2F;etc&#x2F;ldap&#x2F;_.example.top-crt.pem\n-\nreplace: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: &#x2F;etc&#x2F;ldap&#x2F;_.example.top-key.pem\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapadd  -Y   EXTERNAL  -H  ldapi:&#x2F;&#x2F;&#x2F;   -f    certinfo.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n<ul>\n<li>增添配置文件，这是客户端需要连接 ldap 服务器使用的配置。可以忽略。<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;ldap.conf\n\tBASE       dc&#x3D;example,dc&#x3D;top                                                      # LDAP服务的基础DN\n\t[[URI]] ldap:&#x2F;&#x2F;localhost:389 ldaps:&#x2F;&#x2F;localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径，必需\n\tTLS_REQCERT allow                                                      # &quot;demand&quot;，表示需要验证服务器的证书<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>启用 ldaps，重启 slapd<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;default&#x2F;slapd\n\tSLAPD_SERVICES&#x3D;&quot;ldap:&#x2F;&#x2F;&#x2F; ldapi:&#x2F;&#x2F;&#x2F; ldaps:&#x2F;&#x2F;&#x2F;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-5-使用-nextcloud-测试加密连接\"><a href=\"#5-5-使用-nextcloud-测试加密连接\" class=\"headerlink\" title=\"5.5 使用 nextcloud 测试加密连接\"></a>5.5 使用 nextcloud 测试加密连接</h3><ul>\n<li><p>docker 安装 nexcloud，登录 UI ，右上角点击账户，选择应用</p>\n</li>\n<li><p>应用捆绑包，启用 LDAP user and group backend</p>\n</li>\n<li><p>设置连接</p>\n</li>\n<li><p>ldaps连接(严格一致才是tls加密，nextcloud应该只信任权威证书)</p>\n</li>\n<li><p>明文传输</p>\n</li>\n</ul>\n<h3 id=\"5-6-stunnel-加密传输两个应用的数据-例：phpldapadmin\"><a href=\"#5-6-stunnel-加密传输两个应用的数据-例：phpldapadmin\" class=\"headerlink\" title=\"5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)\"></a>5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)</h3><p>链路： ldap user ui  —- stunnel client  accept  —-  stunnel client connect  —- stunnel server accept  —- stunnel server connect —-ldap server port</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apt install -y stunnel4\nvim &#x2F;etc&#x2F;default&#x2F;stunnel4\n\tENABLED&#x3D;1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"># stunnel 服务端\n\tcert &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem\n\tkey &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel-key.pem\n\tverify &#x3D; 3\n\tclient &#x3D; no\n\tdebug &#x3D; 6\n\tpid &#x3D; &#x2F;var&#x2F;run&#x2F;stunnel4&#x2F;stunnel4.pid\n\t\n\t[ldap]\n\taccept &#x3D; 10.13.3.106:6360                # 监听 stunnel 服务的流量，客户端（是指stunnel 客户端）将连接此目标并发送流量到这里\n\tconnect &#x3D; 10.13.3.106:389                # 转发到 stunnel 加密连接的服务的端口\n\tCAfile &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem\n\n# stunnel 客户端\n\tcert &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem\n\tkey &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel-key.pem\n\tverify &#x3D; 3\n\tclient &#x3D; yes\n\tdebug &#x3D; 6\n\tsetuid &#x3D; stunnel4\n\tsetgid &#x3D; stunnel4\n\tpid &#x3D; &#x2F;var&#x2F;run&#x2F;stunnel4&#x2F;stunnel4.pid\n\t\n\t[ldap]\n\taccept &#x3D; 10.13.3.107:389                # 监听 stunnel 服务的流量，客户端（是指ldap的客户端）将连接此目标并发送流量到这里\n\tconnect &#x3D; 10.13.3.106:6360              # 加密连接并转发到 stunnel 的服务端\n\tCAfile &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;phpldapadmin&#x2F;config.php\n\t$servers-&gt;setValue(&#39;server&#39;,&#39;host&#39;,&#39;69.87.216.102&#39;);  # 指向 stunnel 客户端，和他本地监听的端口\n\t$servers-&gt;setValue(&#39;server&#39;,&#39;port&#39;,389);\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"六、-其他模块\"><a href=\"#六、-其他模块\" class=\"headerlink\" title=\"六、 其他模块\"></a>六、 其他模块</h2><h3 id=\"6-1-日志模块\"><a href=\"#6-1-日志模块\" class=\"headerlink\" title=\"6.1 日志模块\"></a>6.1 日志模块</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;loglevel.ldif\n\tdn: cn&#x3D;config\n\tchangetype: modify\n\treplace: olcLogLevel\n\tolcLogLevel: stats\n\nldapmodify  -Y  EXTERNAL  -H  ldapi:&#x2F;&#x2F;&#x2F;  -f  loglevel.ldif               # 日志在&#x2F;var&#x2F;log&#x2F;syslog | grep slapd , 比默认的级别详细<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"6-2-memberOf-开启\"><a href=\"#6-2-memberOf-开启\" class=\"headerlink\" title=\"6.2 memberOf 开启\"></a>6.2 memberOf 开启</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;refint.ldif\n\t# enable_refint.ldif\n\tdn: cn&#x3D;module&#123;0&#125;,cn&#x3D;config\n\tchangetype: modify\n\tadd: olcModuleLoad\n\tolcModuleLoad: refint.la\n\t-\n\tdn: olcOverlay&#x3D;refint,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\n\tchangetype: add\n\tobjectClass: olcOverlayConfig\n\tobjectClass: olcRefintConfig\n\tolcOverlay: refint\n\nldapadd -Q -Y EXTERNAL -H ldapi:&#x2F;&#x2F; -f refint.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;memberof.ldif\n\tdn: cn&#x3D;module,cn&#x3D;config\n\tchangetype: add\n\tcn: module\n\tobjectClass: olcModuleList\n\tolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldap\n\t\n\tdn: cn&#x3D;module&#123;0&#125;,cn&#x3D;config\n\tchangetype: modify\n\tadd: olcModuleLoad\n\tolcModuleLoad: memberof.la\n\t\n\tdn: olcOverlay&#x3D;memberof,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\n\tchangetype: add\n\tobjectClass: olcConfig\n\tobjectClass: olcMemberOf\n\tobjectClass: olcOverlayConfig\n\tobjectClass: top\n\tolcOverlay: memberof\n\tolcMemberOfDangling: ignore\n\tolcMemberOfRefInt: TRUE\n\tolcMemberOfGroupOC: groupOfNames\n\tolcMemberOfMemberAD: member\n\tolcMemberOfMemberOfAD: memberOf\n\nldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f memberof.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>为条目添加此属性：LDIF文件中先创建用户的dn，然后创建目标组的dn，在创建组的时候将关联的用户写在member属性中</li>\n</ul>\n<h3 id=\"6-3-Self-Service-Password-自助密码管理\"><a href=\"#6-3-Self-Service-Password-自助密码管理\" class=\"headerlink\" title=\"6.3 Self Service Password 自助密码管理\"></a>6.3 Self Service Password 自助密码管理</h3><ul>\n<li>容器部署，解决 php 依赖准备繁琐</li>\n<li>镜像 ltbproject&#x2F;self-service-password:1.5.3</li>\n<li>为 admin 用户设置修改密码的权限<pre class=\"line-numbers language-none\"><code class=\"language-none\">下列权限可以使得 &quot;admin,example,net&quot; 对这个域 &quot;dc&#x3D;example,dc&#x3D;tech&quot; 做用户添加、属性修改\nolcAccess: &#123;0&#125;to attrs&#x3D;userPassword,shadowLastChange by dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write by anonymous auth by self write by * none\nolcAccess: &#123;1&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;tech&quot; by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n<li>需要对企业邮箱帐号开启设置-帐号与安全-客户端设置-客户端授权密码</li>\n<li>ssp.conf.php  成功配置版本，并映射到容器： &#x2F;home&#x2F;example&#x2F;sspasswd&#x2F;conf.php:&#x2F;var&#x2F;www&#x2F;conf&#x2F;config.inc.local.php<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$debug</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$keyphrase</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"example\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$use_sms</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$use_questions</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$lang</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"cn,zh-CN\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$use_change</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#$reset_url = $_SERVER['HTTP_X_FORWARDED_PROTO'] . \"://\" . $_SERVER['HTTP_X_FORWARDED_HOST'] . $_SERVER['SCRIPT_NAME'];</span>\n<span class=\"token variable\">$reset_url</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"https://ssp.example.net\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'HTTP_X_FORWARDED_HOST'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'SCRIPT_NAME'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$show_menu</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$logo</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"images/logo.png\"</span><span class=\"token punctuation\">;</span>                <span class=\"token comment\"># 这两项在配置前，需要确保图片映射路径在容器内部的 /var/www/html/images 下</span>\n<span class=\"token variable\">$background_image</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"images/back.png\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$default_action</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"sendtoken\"</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\"># 默认展示在首页的修改密码的方式</span>\n<span class=\"token variable\">$show_menu</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>              <span class=\"token comment\"># 关闭顶部的修改方式选择菜单</span>\n\n<span class=\"token comment\"># LDAP</span>\n\n<span class=\"token variable\">$ldap_url</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"ldap://10.13.3.107/\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_starttls</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_binddn</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"cn=admin,dc=example,dc=net\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_bindpw</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'example@2020'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#$ldap_bindpw = \"&#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\";</span>\n<span class=\"token variable\">$ldap_base</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"dc=example,dc=net\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#$ldap_base = \"dc=example,dc=tech\";    # 在这里同时书写两个，只会生效后一个域, 使用两个实例连接 ldap 服务</span>\n<span class=\"token variable\">$ldap_fullname_attribute</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"cn\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_filter</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"(&amp;(objectClass=inetOrgPerson)(<span class=\"token interpolation\"><span class=\"token variable\">$ldap_fullname_attribute</span></span>=&#123;login&#125;))\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_use_exop_passwd</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_use_ppolicy_control</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$TLS_REQCERT</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"allow\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\"># email</span>\n<span class=\"token variable\">$mail_attributes</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"mail\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"gosaMailAlternateAddress\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"proxyAddresses\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_address_use_ldap</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_from</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"user5@example.net\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_from_name</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"密码自主修改服务\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_signature</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"如有疑问,请联系运维同事,英博智云.\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$notify_on_change</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_protocol</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'smtp'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_host</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'smtphz.qiye.163.com'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_auth</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_user</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"user5@example.net\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_pass</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'TdhYDdgvN7Hpky5a'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_port</span> <span class=\"token operator\">=</span> <span class=\"token number\">465</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_timeout</span> <span class=\"token operator\">=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_keepalive</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_secure</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'ssl'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_autotls</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_options</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_contenttype</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'text/plain'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_wordwrap</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_charset</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'utf-8'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_priority</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\"># password policy</span>\n<span class=\"token variable\">$hash</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"SSHA\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># 修改的用户密码传递过程中会采取这里指定的加密</span>\n<span class=\"token variable\">$pwd_min_length</span> <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_max_length</span> <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_min_lower</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_min_upper</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_min_digit</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_min_special</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_special_chars</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"^a-zA-Z0-9\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_complexity</span> <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_no_reuse</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_forbidden_words</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"example\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"example\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"example\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_show_policy_pos</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"above\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_show_policy</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"onerror\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">docker run -p 8000:80 \\\n&gt; --restart&#x3D;always \\\n&gt; --name sspass \\\n&gt; -v &#x2F;home&#x2F;example&#x2F;sspasswd&#x2F;conf.php:&#x2F;var&#x2F;www&#x2F;conf&#x2F;config.inc.local.php \\\n&gt; -itd docker.io&#x2F;ltbproject&#x2F;self-service-password<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"6-3-1-不能进入修改链接-Token-is-not-valid\"><a href=\"#6-3-1-不能进入修改链接-Token-is-not-valid\" class=\"headerlink\" title=\"6.3.1 不能进入修改链接 Token is not valid\"></a>6.3.1 不能进入修改链接 Token is not valid</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">注释了这两项\n#$use_tokens &#x3D; true;\n#$crypt_tokens &#x3D; true;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"6-3-2-反向代理-Self-Service-Password\"><a href=\"#6-3-2-反向代理-Self-Service-Password\" class=\"headerlink\" title=\"6.3.2 反向代理 Self Service Password\"></a>6.3.2 反向代理 Self Service Password</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">upstream ssp &#123;\n  server 10.13.3.108:8000;\n&#125;\n\nserver &#123;\n    listen 80;\n    server_name ssp.example.net;\n    return 301 https:&#x2F;&#x2F;$server_name$request_uri;\n&#125;\nserver &#123;\n    listen 443 ssl ;\n    server_name ssp.example.net;\n    ssl_certificate webmin&#x2F;tls_ca.pem;\n    ssl_certificate_key webmin&#x2F;tls_key.pem;\n\n    location &#x2F; &#123;\n      proxy_pass http:&#x2F;&#x2F;ssp;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto &quot;https&quot;;\n      proxy_read_timeout 1800s;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection &quot;upgrade&quot;;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-4-LDAP-对目录信息的数据做备份还原和迁移\"><a href=\"#6-4-LDAP-对目录信息的数据做备份还原和迁移\" class=\"headerlink\" title=\"6.4 LDAP 对目录信息的数据做备份还原和迁移\"></a>6.4 LDAP 对目录信息的数据做备份还原和迁移</h3><h4 id=\"6-4-1-备份\"><a href=\"#6-4-1-备份\" class=\"headerlink\" title=\"6.4.1 备份\"></a>6.4.1 备份</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo slapcat -n 3 -l .&#x2F;back3.ldif           # -n 指定数据库编号，数字对应各个dit的数据库编号( 配置数据库----olcDatabase&#x3D;&#123;0&#125;config.ldif; 目录信息数据库----olcDatabase&#x3D;&#123;1&#125;mdb.ldif )<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"6-4-2-恢复\"><a href=\"#6-4-2-恢复\" class=\"headerlink\" title=\"6.4.2 恢复\"></a>6.4.2 恢复</h4><p>原服务器上恢复，服务需要暂停</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo systemctl stop slapd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>配置目录一般位于 <code>/etc/openldap/slapd.d</code>，将原有配置删除，然后使用 <code>slapadd</code> 导入新的配置</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$ rm -rf &#x2F;etc&#x2F;ldap&#x2F;slapd.d&#x2F;*\n$ slapadd  -n  0  -F  &#x2F;etc&#x2F;ldap&#x2F;slapd.d  -l  .&#x2F;config.2021-09-18.ldif\n$ chown -R openldap:openldap &#x2F;etc&#x2F;ldap&#x2F;slapd.d<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>数据目录一般位于 <code>/var/lib/ldap-*</code>，模拟时，将原有数据删除，然后使用 <code>slapadd</code> 导入新的数据：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$ rm  -rf  &#x2F;var&#x2F;lib&#x2F;ldap-example&#x2F;*         # 定制了不同的$default_action &#x3D; &quot;sendtoken&quot;;\n$show_menu &#x3D; false;dit有不同的目录分别存储不同domain的内容，注意，导入前目录必需首先存在，且权属 openldap:openldap。\n$ slapadd -n 1 -F &#x2F;etc&#x2F;openldap&#x2F;slapd.d -l .&#x2F;data.2021-09-18.ldif\n$ chown -R openldap:openldap  &#x2F;var&#x2F;lib&#x2F;ldap-example\n$ systemctl start slapd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"6-4-3-openldap的迁移\"><a href=\"#6-4-3-openldap的迁移\" class=\"headerlink\" title=\"6.4.3 openldap的迁移\"></a>6.4.3 openldap的迁移</h4><p>playbook 新建的服务器，执行恢复</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">slapadd -n 1 -F &#x2F;etc&#x2F;openldap&#x2F;slapd.d -l .&#x2F;data.2021-09-18.ldif\n\n[[如果导入失败，或者数据已存在，删除rm]] -rf &#x2F;var&#x2F;lib&#x2F;ldap&#x2F;*  重新导入<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n<h2 id=\"七、-命令资料\"><a href=\"#七、-命令资料\" class=\"headerlink\" title=\"七、 命令资料\"></a>七、 命令资料</h2><blockquote>\n<p><a href=\"https://blog.csdn.net/jenyzhang/article/details/56487627\">来自此处</a><br>ldap<br>    |-slapd             目录服务的主要程序<br>    |-slurpd           目录服务进行复制的程序<br>    |-slapadd           向目录中添加数据<br>    |-slapcat           把目录中的条目导出成ldif文件<br>    |-slapindex         重建目录的索引<br>    |-ldapcompare       对目录的条目的属性进行比较<br>    |-ldapadd           向目录服务中添加条目<br>    |-ldapdelete        删除目录中的条目<br>    |-ldapmodify        更新目录中条目的值<br>    |-ldapmodrdn        更改条目的DN<br>    |-ldappasswd        更改条目的密码<br>    |-ldapsearch        对目录进行查询</p>\n</blockquote>\n<blockquote>\n<p>ldapadd<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -h   目录服务的地址<br>      -w   绑定DN的密码<br>      -f   使用ldif文件进行条目添加的文件  \n      </p>\n</blockquote>\n<ul>\n<li>例子<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -f &#x2F;root&#x2F;test.ldif<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret (这样写就是在命令行添加条目)</li>\n</ul>\n<p>       </p>\n<blockquote>\n<p>ldapsearch<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -w   绑定DN的密码<br>      -b   指定要查询的根节点<br>      -H   制定要查询的服务器<br>      -s   指定搜索范围的类型\n     </p>\n</blockquote>\n<ul>\n<li>例子<br>   ldapsearch -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -b “dc&#x3D;starxing,dc&#x3D;com”<br>       使用简单认证，用 “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” 进行绑定，<br>       要查询的根是 “dc&#x3D;starxing,dc&#x3D;com”。这样会把绑定的用户能访问”dc&#x3D;starxing,dc&#x3D;com”下的所有数据显示出来。<br> ldapsearch -x -W -D “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -b “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -h troy.osdn.zzti.edu.cn<br>   ldapsearch -b “dc&#x3D;canon-is,dc&#x3D;jp” -H ldaps:&#x2F;&#x2F;192.168.0.92:636<br> (需要修改openldap客户端的配置文件ldap.conf,参考：<a href=\"http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm\">http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm</a>)</li>\n</ul>\n<blockquote>\n<p>ldapdelete <br>      ldapdelete -x -D “cn&#x3D;Manager,dc&#x3D;test,dc&#x3D;com” -w secret “uid&#x3D;test1,ou&#x3D;People,dc&#x3D;test,dc&#x3D;com”<br>      ldapdelete -x -D ‘cn&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secert ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’<br>      这样就可以删除’uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’记录了，应该注意一点，其下有子条目的不能删除  </p>\n</blockquote>\n<ul>\n<li><p>例子1  递归删除所有：<br>ldapdelete -x -D ‘cn&#x3D;administrator,dc&#x3D;example,dc&#x3D;net’ -w example@2020 -r “ou&#x3D;example,dc&#x3D;example,dc&#x3D;net”</p>\n</li>\n<li><p>例子2  删除一个acl策略。acl-dele.ldif<br> dn: olcDatabase&#x3D;{3}mdb,cn&#x3D;config<br> delete: olcAccess<br> olcAccess: {2}<br> olcAccess: {3}<br> olcAccess: {4}<br> ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f acl-dele.ldif</p>\n</li>\n</ul>\n<blockquote>\n<p>ldappasswd<br>    -x   进行简单认证<br>    -D   用来绑定服务器的DN<br>    -w   绑定DN的密码<br>    -S   提示的输入密码<br>    -s pass 把密码设置为pass<br>    -a pass 设置old passwd为pass<br>    -A   提示的设置old passwd<br>    -H   是指要绑定的服务器<br>    -I   使用sasl会话方式  \n    </p>\n</blockquote>\n<ul>\n<li>例子<br>    ldappasswd -x -D ‘cm&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secret ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’ -S<br>       New password:<br>       Re-enter new password:<br>       就可以更改密码了，如果原来记录中没有密码，将会自动生成一个userPassword。</li>\n</ul>\n<p>    </p>\n<blockquote>\n<p>ldapmodify<br>     -a 添加新的条目.缺省的是修改存在的条目.<br>     -C 自动追踪引用.<br>     -c 出错后继续执行程序并不中止.缺省情况下出错的立即停止.比如如果你的ldif 文件内的某个条目在<a href=\"http://lib.csdn.net/base/mysql\" title=\"MySQL知识库\">数据库</a>内并不存在,缺省情况下程序立即退出,但如果使用了该参数,程序忽略该错误继续执行.<br>     -n 用于调试到服务器的通讯.但并不实际执行搜索.服务器关闭时,返回错误；服务器<br>       打开时,常和-v 参数一起<a href=\"http://lib.csdn.net/base/softwaretest\" title=\"软件测试知识库\">测试</a>到服务器是否是一条通路.<br>     -v 运行在详细模块.在标准输出中打出一些比较详细的信息.比如:连接到服务器的<br>       ip 地址和端口号等.<br>     -M  打开 manage DSA IT 控制. -MM 把该控制设置为重要的.<br>     -f file 从文件内读取条目的修改信息而不是从标准输入读取.<br>    -x 使用简单认证.<br>    -D binddn 指定搜索的用户名(一般为一dn 值).<br>    -W 指定了该参数,系统将弹出一提示入用户的密码.它和-w 参数相对使用.<br>    -w bindpasswd 直接指定用户的密码. 它和-W 参数相对使用.<br>    -H ldapuri 指定连接到服务器uri(ip 地址和端口号,常见格式为 ldap:&#x2F;&#x2F;hostname:port ).如果使用了-H 就不能使用-h 和-p 参数.<br>    -h ldaphost 指定要连接的主机的名称&#x2F;ip 地址.它和-p 一起使用<br>    -p ldapport 指定要连接目录服务器的端口号.它和-h 一起使用，如果使用了-h 和-p 参数就不能使用-H 参数.<br>    -Z 使用StartTLS 扩展操作.如果使用-ZZ,命令强制使用StartTLS 握手成功.<br>    -V 启用证书认证功能,目录服务器使用客户端证书进行身份验证,必须与-ZZ 强制启用<br>       TLS 方式配合使用,并且匿名绑定到目录服务器.<br>    -e 设置客户端证书文件,例: -e cert&#x2F;client.crt<br>    -E 设置客户端证书私钥文件,例: -E cert&#x2F;client.key  </p>\n</blockquote>\n<ul>\n<li>例子<br>ldapmodify -x -D “cn&#x3D;root,dc&#x3D;it,dc&#x3D;com” -W -f modify.ldif    #   将modify.ldif中的记录更新原有的记录。</li>\n</ul>\n<h2 id=\"八、-参考链接\"><a href=\"#八、-参考链接\" class=\"headerlink\" title=\"八、 参考链接\"></a>八、 参考链接</h2><p><a href=\"https://github.com/jt6562/LDAP-read-notes/blob/master/ldap-guide/OpenLDAP%E7%AE%A1%E7%90%86%E5%91%98%E6%89%8B%E5%86%8C.md\">指南</a><br><a href=\"https://www.cnblogs.com/kevingrace/p/5773974.html\">知识总结</a><br><a href=\"https://www.cnblogs.com/js1314/p/12887893.html\">参考1</a><br><a href=\"https://cloud.tencent.com/developer/article/1932586\">参考2</a><br><a href=\"https://blog.csdn.net/u011607971/article/details/121126289?spm=1001.2014.3001.5501#t3\">参考3</a><br><a href=\"https://ubuntu.com/server/docs/service-ldap-with-tls\">Ubuntu wiki</a><br><a href=\"https://www.cnblogs.com/shu-sheng/p/14450815.html\">tls参考1</a><br><a href=\"https://hmli.ustc.edu.cn/doc/linux/ubuntu-ldap/ubuntu-ldap.html#id14\">tls参考2</a><br><a href=\"https://zhuanlan.zhihu.com/p/643010354\">tls参考3</a></p>\n<h2 id=\"九、问题：\"><a href=\"#九、问题：\" class=\"headerlink\" title=\"九、问题：\"></a>九、问题：</h2><h3 id=\"9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果\"><a href=\"#9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果\" class=\"headerlink\" title=\"9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果\"></a>9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果</h3><h3 id=\"9-2-日志功能开启失败\"><a href=\"#9-2-日志功能开启失败\" class=\"headerlink\" title=\"9.2 日志功能开启失败\"></a>9.2 日志功能开启失败</h3><pre><code>已经调整日志级别，在系统日志中查看并grep\n</code></pre>\n<h3 id=\"9-3-证书缺失-只能使用ldap01-这个信息查询）\"><a href=\"#9-3-证书缺失-只能使用ldap01-这个信息查询）\" class=\"headerlink\" title=\"9.3 证书缺失(只能使用ldap01,这个信息查询）\"></a>9.3 证书缺失(只能使用ldap01,这个信息查询）</h3><pre><code>采取使用权威证书\n</code></pre>\n<h3 id=\"9-4-重启slap报错-tls-init-failed\"><a href=\"#9-4-重启slap报错-tls-init-failed\" class=\"headerlink\" title=\"9.4 重启slap报错 tls init   failed\"></a>9.4 重启slap报错 tls init   failed</h3><pre><code>解决办法：重新生成证书\n</code></pre>\n<h3 id=\"9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code\"><a href=\"#9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code\" class=\"headerlink\" title=\"9.5 报错 ldap_start_tls: Connect error (-11)    \\n    additional info: (unknown error code)\"></a>9.5 报错 ldap_start_tls: Connect error (-11)    \\n    additional info: (unknown error code)</h3><pre><code>可能是由于服务器证书的通用名（Common Name）字段是否与主机名不一致，请检查主机名和服务器证书\n</code></pre>\n<h3 id=\"9-6-连接问题\"><a href=\"#9-6-连接问题\" class=\"headerlink\" title=\"9.6 连接问题\"></a>9.6 连接问题</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldaps:&#x2F;&#x2F;ldap.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W            # 在服务器本机执行此查询的报错。但是在另一个机器可以成功查询\n\tldap_sasl_bind(SIMPLE): Can&#39;t contact LDAP server (-1)                                 # 配置 ldap.conf 之后成功解决并有输出 tls&#x3D;demand&#x2F;allow----作用是证书检查<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h3 id=\"9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”\"><a href=\"#9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”\" class=\"headerlink\" title=\"9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”\"></a>9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">1. 首先尝试重新部署，发现执行镜像复制的剧本之前可以正常创建所有的条目\n    解决：在mirror mode 开启时，需要指定相应的数据库\n2.  shadow context; no update referral  根本原因是需要检查权限<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"9-8-使用的脚本一致，测试环境和生产环境结果不一致-主要是不能长时间正常保持客户端连接并查询\"><a href=\"#9-8-使用的脚本一致，测试环境和生产环境结果不一致-主要是不能长时间正常保持客户端连接并查询\" class=\"headerlink\" title=\"9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询\"></a>9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询</h3><ul>\n<li>脚本中的组织信息ldif文件有问题，经测试不影响。</li>\n<li>memberOf，属性不可单独添加，通过 groupofNames 指定 member 之后会自动关联。已经修正使用方式，结果未改变。</li>\n<li>2204 系统和 2004 系统的slapd版本不一致（并没有影响）。</li>\n<li>将orgnization的任务和前一部分拆分，否则会出现读取不到 rootdn（手动测试是成功的）（然而脚本中修改后并没有解决这个问题）。</li>\n<li>将organization拆分，在此之前重启服务，未解决。</li>\n<li>将organization拆分，在此之前先重启虚拟机。（有效、怀疑是服务中某些连接的状态在ansible执行中没有更新）（仍然失效了，经过一夜之后失效）。</li>\n<li>另一台2204主机安装正常使用，怀疑虚拟机系统问题。</li>\n</ul>\n<h2 id=\"十、-验证\"><a href=\"#十、-验证\" class=\"headerlink\" title=\"十、 验证\"></a>十、 验证</h2><h3 id=\"10-1-检测连接命令：\"><a href=\"#10-1-检测连接命令：\" class=\"headerlink\" title=\"10.1 检测连接命令：\"></a>10.1 检测连接命令：</h3><p> ldaps:&#x2F;&#x2F;    —-ldap over ssl  使用636 ，从连接开始加密   ;        ldap:&#x2F;&#x2F;           —ldap_start_tls(-ZZ参数):    使用389，从传输开始加密</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldaps:&#x2F;&#x2F;ldap01.example.top:636 -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -s sub &quot;(objectClass&#x3D;person)&quot;\n\nldapsearch -H ldap:&#x2F;&#x2F;10.13.3.106  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -s sub &quot;(objectClass&#x3D;person)&quot;\n\nldapsearch -H ldap:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -s sub &quot;(objectClass&#x3D;person)&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"10-2-验证和日志\"><a href=\"#10-2-验证和日志\" class=\"headerlink\" title=\"10.2 验证和日志\"></a>10.2 验证和日志</h3><p>tag 101 应表明在查询; tag 97 是在认证</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldap:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W   -ZZ      #  启用了tls功能 ，-ZZ 参数，仍然是 389 端口，连接后在传输过程中加密\n\t\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:60674 (IP&#x3D;0.0.0.0:389)\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;0 EXT oid&#x3D;1.3.6.1.4.1.1466.20037\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;0 STARTTLS\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;0 RESULT oid&#x3D; err&#x3D;0 text&#x3D;\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 fd&#x3D;14 TLS established tls_ssf&#x3D;256 ssf&#x3D;256\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;1 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;1 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;1 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;2 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;2 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;6 text&#x3D;\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;3 UNBIND\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 fd&#x3D;14 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldap:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W        # 明文传输\n\t\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:37760 (IP&#x3D;0.0.0.0:389)\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;6 text&#x3D;\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;2 UNBIND\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 fd&#x3D;14 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldaps:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W        # 从连接就开始加密\n\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:58726 (IP&#x3D;0.0.0.0:636)\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 fd&#x3D;14 TLS established tls_ssf&#x3D;256 ssf&#x3D;256\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;6 text&#x3D;\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;2 UNBIND\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 fd&#x3D;14 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldaps:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -ZZ\n\tldap_start_tls: Operations error (1)\n        additional info: TLS already started\n\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:39894 (IP&#x3D;0.0.0.0:636)\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 fd&#x3D;14 TLS established tls_ssf&#x3D;256 ssf&#x3D;256\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;0 EXT oid&#x3D;1.3.6.1.4.1.1466.20037\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;0 STARTTLS\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;0 RESULT oid&#x3D; err&#x3D;1 text&#x3D;TLS already started                # 证明二者冲突，不能同时开启\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;1 UNBIND\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 fd&#x3D;14 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"十一、应用服务\"><a href=\"#十一、应用服务\" class=\"headerlink\" title=\"十一、应用服务\"></a>十一、应用服务</h2><h3 id=\"11-1-建立-ldap-管理-只读帐号\"><a href=\"#11-1-建立-ldap-管理-只读帐号\" class=\"headerlink\" title=\"11.1 建立 ldap 管理&#x2F;只读帐号\"></a>11.1 建立 ldap 管理&#x2F;只读帐号</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;admin,dc&#x3D;xxx,dc&#x3D;xx \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi  \n  \n-  \ndn: cn&#x3D;reader,dc&#x3D;xxx2,dc&#x3D;xx2  \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"11-2-详细的公司架构-ldif\"><a href=\"#11-2-详细的公司架构-ldif\" class=\"headerlink\" title=\"11.2 详细的公司架构 ldif\"></a>11.2 详细的公司架构 ldif</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example  \n  \ndn: ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-bod  \n  \ndn: cn&#x3D;user1,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user1  \ndepartmentnumber: 1  \ndisplayname: Zheng Yu  \nmail: user1@example.net  \nobjectclass: inetOrgPerson  \nsn: Zheng  \ntitle: President  \nuid: 10000  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-bod-admin  \nmember: cn&#x3D;user1,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-bus  \n  \ndn: cn&#x3D;user8,ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user8  \ndepartmentnumber: 2  \ndisplayname: Sun Minghong  \nmail: user8@example.net  \nobjectclass: inetOrgPerson  \nsn: Sun  \ntitle: Financial Manager  \nuid: 10001  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-bus-admin,ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-bus-admin  \nmember: cn&#x3D;user8,ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-sys  \n  \ndn: cn&#x3D;user2,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user2  \ndepartmentnumber: 3  \ndisplayname: Xie Jian  \nmail: user2@example.net  \nobjectclass: inetOrgPerson  \nsn: Xie  \ntitle: Senior Systems Engineer  \nuid: 10002  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-sys-admin  \nmember: cn&#x3D;user2,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: cn&#x3D;user5,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user5  \ndepartmentnumber: 3  \ndisplayname: Long Chao  \nmail: user5@example.net  \nobjectclass: inetOrgPerson  \nsn: Long  \ntitle: System Engineer  \nuid: 10003  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-sys-junior,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-sys-junior  \nmember: cn&#x3D;user5,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-ops  \n  \ndn: cn&#x3D;user6.tang,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user6.tang  \ndepartmentnumber: 4  \ndisplayname: Tang Binchao  \nmail: user6.tang@example.net  \nobjectclass: inetOrgPerson  \nsn: Tang  \ntitle: System Engineer  \nuid: 10004  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-ops-admin  \nmember: cn&#x3D;user6.tang,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-dev  \n  \ndn: cn&#x3D;user3,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user3  \ndepartmentnumber: 5  \ndisplayname: Chen Cheng  \nmail: user3@example.net  \nobjectclass: inetOrgPerson  \nsn: Chen  \ntitle: Senior Development Engineer  \nuid: 10005  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-dev-admin,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-dev-admin  \nmember: cn&#x3D;user3,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: cn&#x3D;user4.li,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user4.li  \ndepartmentnumber: 5  \ndisplayname: Li user4  \nmail: user4.li@example.net  \nobjectclass: inetOrgPerson  \nsn: Li  \ntitle: Development Engineer  \nuid: 10006  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;user7,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user7  \ndepartmentnumber: 5  \ndisplayname: Luo Xujun  \nmail: user7@example.net  \nobjectclass: inetOrgPerson  \nsn: Luo  \ntitle: Development Engineer  \nuid: 10007  \nuserpassword: &#123;SSHA&#125;&#x2F;2+Coei5Fje+th7mOJgu43Ms3hBia2Qu  \n  \ndn: cn&#x3D;example-dev-senior,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-dev-senior  \nmember: cn&#x3D;user4.li,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nmember: cn&#x3D;user7,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-rob,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-rob<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"11-3-第一版-ACL\"><a href=\"#11-3-第一版-ACL\" class=\"headerlink\" title=\"11.3 第一版 ACL\"></a>11.3 第一版 ACL</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;ou&#x3D;example,dc&#x3D;example,dc&#x3D;net&quot; filter&#x3D;&quot;(&amp;(objectClass&#x3D;inetOrgPerson)(|(memberOf&#x3D;cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)))&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read\n\ndn: olcDatabase&#x3D;&#123;4&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write  by anonymous auth  by * none\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;ibexample,dc&#x3D;com&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"11-4-最终的acl（写两个域、读两个域、reader-example-可以读取某些admin组，实现映射到example域下集成的应用）\"><a href=\"#11-4-最终的acl（写两个域、读两个域、reader-example-可以读取某些admin组，实现映射到example域下集成的应用）\" class=\"headerlink\" title=\"11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）\"></a>11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）</h3><ul>\n<li><p>添加</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;example,dc&#x3D;net&quot; read\nolcAccess: &#123;3&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; filter&#x3D;&quot;(&amp;(objectClass&#x3D;inetOrgPerson)(|(memberOf&#x3D;cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)))&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read\n \ndn: olcDatabase&#x3D;&#123;2&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write  by anonymous auth  by * none\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;ibexample,dc&#x3D;com&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;example,dc&#x3D;net&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>删除</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\ndelete: olcAccess\nolcAccess: &#123;2&#125;to..........\nolcAccess: &#123;3&#125;to........\n \n\nldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f acl-dele.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>数据库内 ACL 顺序测试，{}里面是优先级，生效在前（涉及范围大的 ACL 应书写在前）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by anonymous auth  by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write  by * none   \nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,dc&#x3D;example,dc&#x3D;tech&quot; by dn.base&#x3D;&quot;cn&#x3D;reader,dc&#x3D;example,dc&#x3D;net&quot; read by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write    # 如果没有此条acl,该条目将不能在 lam 中被 admin 管理\n olcAccess: &#123;3&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;tech&quot; by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write      # 此条优先级最低<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"十二、集成其他应用\"><a href=\"#十二、集成其他应用\" class=\"headerlink\" title=\"十二、集成其他应用\"></a>十二、集成其他应用</h2><h3 id=\"12-1-conflunce\"><a href=\"#12-1-conflunce\" class=\"headerlink\" title=\"12.1  conflunce\"></a>12.1  conflunce</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by anonymous auth by * none\nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; by dn.base&#x3D;&quot;cn&#x3D;reader,dc&#x3D;ibexample,dc&#x3D;com&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"12-1-1-连接-之后的-acl-过滤案例\"><a href=\"#12-1-1-连接-之后的-acl-过滤案例\" class=\"headerlink\" title=\"12.1.1 连接 之后的 acl 过滤案例\"></a>12.1.1 连接 之后的 acl 过滤案例</h4><p>‘(&amp;(objectclass&#x3D;inetorgperson)(|(cn&#x3D;user5)(cn&#x3D;user2)))’  过滤出指定用户—-在用户模式设置。</p>\n<p>‘(&amp;(objectclass&#x3D;groupOfNames)(|(cn&#x3D;example-sys-junior)(cn&#x3D;example-sys-admin)))’ 过滤指定组—-在组模式设置（在ldap中创建的组 objectclass 是groupOfNames）</p>\n<h4 id=\"12-1-2-更详细的-acl-需求\"><a href=\"#12-1-2-更详细的-acl-需求\" class=\"headerlink\" title=\"12.1.2 更详细的 acl 需求\"></a>12.1.2 更详细的 acl 需求</h4><ul>\n<li><p>example</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write  by anonymous auth  by * none\nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; filter&#x3D;&quot;(&amp;(objectClass&#x3D;inetOrg\n Person)(|(memberOf&#x3D;cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net\n )(memberOf&#x3D;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(member\n Of&#x3D;cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)))&quot; by dn.base&#x3D;\n &quot;cn&#x3D;reader,dc&#x3D;ibexample,dc&#x3D;com&quot; read  by dn.base&#x3D; &quot;cn&#x3D;reader,dc&#x3D;example,dc&#x3D;net&quot; read\n\nsearch时，必须要具体到用户层级，例如nextcloud，需要指定基础用户树如下\n\ncn&#x3D;user2,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net\ncn&#x3D;user1,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net\ncn&#x3D;user6.tang,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net\ndc&#x3D;ibexample,dc&#x3D;com<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>example</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write  by anonymous auth  by * none\nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;ibexample,dc&#x3D;com&quot; by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write by dn.base&#x3D;&quot;cn&#x3D;reader,dc&#x3D;ibexample,dc&#x3D;com&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"12-2-集成-vault\"><a href=\"#12-2-集成-vault\" class=\"headerlink\" title=\"12.2 集成 vault\"></a>12.2 集成 vault</h3><ul>\n<li>过滤特定用户<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectClass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(cn&#x3D;user2)(cn&#x3D;user1)(cn&#x3D;%s)))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>过滤某个组<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectClass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>过滤多个组<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectclass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)(memberof&#x3D;CN&#x3D;example-dev-admin,OU&#x3D;example-dev,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>过滤特定用户和特定组<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectclass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(|(cn&#x3D;user4.li))(|(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)(memberof&#x3D;CN&#x3D;example-dev-admin,OU&#x3D;example-dev,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net))(cn&#x3D;%s)))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>错误<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectClass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(cn&#x3D;user2)(cn&#x3D;user1))(cn&#x3D;%s))  会失败\n\n以下 1 条，写在group filter的时候会出现不能过滤，所有人都可以登录\n(&amp;(objectclass&#x3D;inetOrgPerson)(|(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)(memberof&#x3D;CN&#x3D;example-dev-admin,OU&#x3D;example-dev,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"OpenLDAP\"><a href=\"#OpenLDAP\" class=\"headerlink\" title=\"OpenLDAP\"></a>OpenLDAP</h1><h2 id=\"一、-概念\"><a href=\"#一、-概念\" class=\"headerlink\" title=\"一、 概念\"></a>一、 概念</h2><p><a href=\"https://www.openldap.org/doc/admin26/guide.html\">官方手册</a></p>\n<h3 id=\"1-1-常用属性\"><a href=\"#1-1-常用属性\" class=\"headerlink\" title=\"1.1 常用属性\"></a>1.1 常用属性</h3><ul>\n<li>DN：Distinguished Name，LDAP记录项的标识，有唯一性，例如：dc:”cn&#x3D;admin,ou&#x3D;developer,dc&#x3D;163,dc&#x3D;com”  </li>\n<li>dc&#x3D; DomainComponent 为域组件，域名的一部分</li>\n<li>cn&#x3D;CommonName 为记录名，表示一个实体，最长到80个字符，可以为中文；</li>\n<li>ou&#x3D;OrganizationUnit 为组织单位，用于分类，最多四级，每级最长32字符，可以为中文；</li>\n<li>uid&#x3D;User id 为用户的唯一标识</li>\n<li>c&#x3D;Country 为国家名，可选，为2个字符长</li>\n<li>o&#x3D;Organization 为组织名，可选，可以3—64个字符长</li>\n</ul>\n<h2 id=\"二、-手动安装和配置-LDAP\"><a href=\"#二、-手动安装和配置-LDAP\" class=\"headerlink\" title=\"二、 手动安装和配置 LDAP\"></a>二、 手动安装和配置 LDAP</h2><h3 id=\"2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务\"><a href=\"#2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务\" class=\"headerlink\" title=\"2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)\"></a>2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo apt install  -y slapd ldap-utils<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-2-重新配置-OpenLDAP，创建-base-dn\"><a href=\"#2-2-重新配置-OpenLDAP，创建-base-dn\" class=\"headerlink\" title=\"2.2  重新配置 OpenLDAP，创建 base dn\"></a>2.2  重新配置 OpenLDAP，创建 base dn</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo dpkg-reconfigure slapd   # 主要配置密码 (密码在下一步重置，便于配置连接)，DNS domain name(即 LDAP 服务中的 base dn)\n\n\t 说明：\n\t第一步回答 No\n\t第二步填写域名，比如 mycompany.com\n\t第三步填写组织名，比如 Company\n\t第四步填写管理员密码，比如 secret；第五步确认管理员密码\n\t第六步选择使用的数据库后端，比如 MDB\n\t第七步选择在清除 slapd 时是否移除数据库，比如 Yes\n\t第八步选择是否移除旧数据库，比如 Yes<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码\"><a href=\"#2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码\" class=\"headerlink\" title=\"2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码\"></a>2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">slappasswd\n\t<span class=\"token punctuation\">&#123;</span>SSHA<span class=\"token punctuation\">&#125;</span>UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<ul>\n<li>通过数据库修改admin用户的ldif文件<pre class=\"line-numbers language-ldif\" data-language=\"ldif\"><code class=\"language-ldif\">&#x2F;etc&#x2F;ldap&#x2F;slapd.d&#x2F;cn\\&#x3D;config&#x2F;olcDatabase\\&#x3D;\\&#123;1\\&#125;mdb.ldif\n\tolcDatabase: &#123;1&#125;mdb\n\tolcSuffix: dc&#x3D;example,dc&#x3D;top\n\tolcRootDN: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top\n\tolcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>olcDatabase: 定义使用的后端数据存储格式,遵循默认</li>\n<li>olcSuffix: 设置 LDAP 服务的根</li>\n<li>olcRootDN: 设置管理员用户的 dn</li>\n<li>olcRootPW: 管理员用户的密码</li>\n<li>修改后重启服务<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo slaptest -u   # 检查配置文件\nsudo systemctl enable slapd  --now\n\nsudo slapcat        # 输出看到当前数据库内容<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"2-4-正确的修改olcRootPW-管理员用户的密码\"><a href=\"#2-4-正确的修改olcRootPW-管理员用户的密码\" class=\"headerlink\" title=\"2.4 正确的修改olcRootPW: 管理员用户的密码\"></a>2.4 正确的修改olcRootPW: 管理员用户的密码</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nreplace: olcRootPW\nolcRootPW: example2020  # 保存在数据库文件中的时候将会被加密<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f passmodify.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">同时进入web ui，修改admin账户的密码，如果不修改两个密码都能管理域，二者修改一致之后，才是新的管理密码生效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-5-简单结构展示\"><a href=\"#2-5-简单结构展示\" class=\"headerlink\" title=\"2.5 简单结构展示\"></a>2.5 简单结构展示</h3><p>略</p>\n<h3 id=\"2-6-创建base-dn\"><a href=\"#2-6-创建base-dn\" class=\"headerlink\" title=\"2.6 创建base dn\"></a>2.6 创建base dn</h3><h4 id=\"2-6-1-查看LDAP服务器的根目录信息\"><a href=\"#2-6-1-查看LDAP服务器的根目录信息\" class=\"headerlink\" title=\"2.6.1 查看LDAP服务器的根目录信息\"></a>2.6.1 查看LDAP服务器的根目录信息</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapsearch -x -LLL -b &#39;&#39; -s base &#39;(objectclass&#x3D;*)&#39;\n\tdn:\n\tobjectClass: top\n\tobjectClass: OpenLDAProotDSE<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-6-2-基于-ldif-文件直接创建，不使用图形化交互。创建之后，对这个-base-dn-设置管理员的密码\"><a href=\"#2-6-2-基于-ldif-文件直接创建，不使用图形化交互。创建之后，对这个-base-dn-设置管理员的密码\" class=\"headerlink\" title=\"2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码\"></a>2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">-\ndn: dc&#x3D;example,dc&#x3D;top\nchangetype: add\nobjectClass: top\nobjectClass: domain\n\n\n-\ndn: o&#x3D;example,dc&#x3D;example,dc&#x3D;top\nchangetype: add\nobjectClass: organization\no: example<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapmodify -x -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -w example@2020  -f organization.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-7-创建多个-DIT-base-dn-（可以考虑尝试后端用-mysql-做数据库）\"><a href=\"#2-7-创建多个-DIT-base-dn-（可以考虑尝试后端用-mysql-做数据库）\" class=\"headerlink\" title=\"2.7 创建多个 DIT + base dn （可以考虑尝试后端用 mysql 做数据库）\"></a>2.7 创建多个 DIT + base dn （可以考虑尝试后端用 <code>mysql</code> 做数据库）</h3><h4 id=\"2-7-1-为新的库，准备存储路径，并通过apparmor做权限限制\"><a href=\"#2-7-1-为新的库，准备存储路径，并通过apparmor做权限限制\" class=\"headerlink\" title=\"2.7.1 为新的库，准备存储路径，并通过apparmor做权限限制\"></a>2.7.1 为新的库，准备存储路径，并通过<code>apparmor</code>做权限限制</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">mkdir  &#x2F;var&#x2F;lib&#x2F;ldap2\nchown openldap:openldap  &#x2F;var&#x2F;lib&#x2F;ldap2\nvim &#x2F;etc&#x2F;apparmor.d&#x2F;usr.sbin.slapd\n\t\t# the databases and logs\n\t\t&#x2F;var&#x2F;lib&#x2F;ldap2&#x2F; r,\n\t\t&#x2F;var&#x2F;lib&#x2F;ldap2&#x2F;** rwk,\n\t\t\n\t\t# lock file\n\t\t&#x2F;var&#x2F;lib&#x2F;ldap2&#x2F;alock kw,\n\nsudo systemctl  reload  apparmor <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-7-2-准备-ldif-文件，创建新的-DIT（可以自定义路径）\"><a href=\"#2-7-2-准备-ldif-文件，创建新的-DIT（可以自定义路径）\" class=\"headerlink\" title=\"2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）\"></a>2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;2&#125;mdb,cn&#x3D;config\nchangetype: add\nobjectClass: olcDatabaseConfig\nobjectClass: olcMdbConfig\nolcDbDirectory: &#x2F;var&#x2F;lib&#x2F;ldap2&#x2F;\nolcDatabase: &#123;2&#125;Mdb\nolcDbIndex: objectClass eq\nolcDbIndex: cn,uid eq\nolcDbIndex: uidNumber,gidNumber eq\nolcDbIndex: member,memberUid eq\nolcLastMod: TRUE\nolcMonitoring: TRUE\nolcDBNoSync: TRUE\nolcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by anonymous auth by * non\n e\nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcSuffix: dc&#x3D;example,dc&#x3D;tech\nolcRootDN: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;tech\nolcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo  ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f domian2.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-7-3-新增并设置管理员\"><a href=\"#2-7-3-新增并设置管理员\" class=\"headerlink\" title=\"2.7.3 新增并设置管理员\"></a>2.7.3 新增并设置管理员</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">-\ndn: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;tech\nobjectClass: simpleSecurityObject\nobjectClass: organizationalRole\ncn: admin\nuserPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n# 以下是playbook中模板文件\n-\ndn: cn&#x3D;admin,&#123;&#123; item.base_dn &#125;&#125;  \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapadd -x -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;tech&quot; -w example@2020 -f basedn2.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-7-4-多-DIT-跨域-ACL\"><a href=\"#2-7-4-多-DIT-跨域-ACL\" class=\"headerlink\" title=\"2.7.4 多 DIT 跨域 ACL\"></a>2.7.4 多 DIT 跨域 ACL</h4><ul>\n<li><p>查询服务器的域</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -x -H ldap:&#x2F;&#x2F;10.13.3.107 -b &quot;&quot; -s base namingContexts<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li><p>设置一个全权限的 acl ，跨域访问，相应的用户需已经提前创建</p>\n</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">让这个dn 用户: cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech ;  可以阅读这个base dn : dc&#x3D;example,dc&#x3D;top 下的所有条目.\n对应关系：数据库----&#123;1&#125;mdb  存储的数据是来自 dn: dc&#x3D;example,dc&#x3D;top 。即，对谁的访问则将 acl 添加在谁的库下  \n\ndn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; by dn.base&#x3D;&quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapmodify   -Y   EXTERNAL   -H   ldapi:&#x2F;&#x2F;&#x2F;   -f  xxx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h4 id=\"2-7-5-测试\"><a href=\"#2-7-5-测试\" class=\"headerlink\" title=\"2.7.5 测试\"></a>2.7.5 测试</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">root@example-sys-test-06:&#x2F;etc&#x2F;ldap&#x2F;example# ldapsearch -x -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -D &quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; -w example@2020\n\t\t# extended LDIF\n\t\t#\n\t\t# LDAPv3\n\t\t# base &lt;dc&#x3D;example,dc&#x3D;top&gt; with scope subtree\n\t\t# filter: (objectclass&#x3D;*)\n\t\t# requesting: ALL\n\t\t#\n\t\t\n\t\t# example.top\n\t\tdn: dc&#x3D;example,dc&#x3D;top\n\t\tobjectClass: top\n\t\tobjectClass: domain\n\t\tdc: example\n\t\t\n\t\t# admin, example.top\n\t\tdn: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top\n\t\tobjectClass: simpleSecurityObject\n\t\tobjectClass: organizationalRole\n\t\tcn: admin\n\t\t\n\t\t# search result\n\t\tsearch: 2\n\t\tresult: 0 Success\n\t\t\n\t\t# numResponses: 3\n\t\t# numEntries: 2\nroot@example-sys-test-06:&#x2F;etc&#x2F;ldap&#x2F;example# ldapsearch -x -b &quot;dc&#x3D;example,dc&#x3D;tech&quot; -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -w example@2020\n\t\t# extended LDIF\n\t\t#\n\t\t# LDAPv3\n\t\t# base &lt;dc&#x3D;example,dc&#x3D;tech&gt; with scope subtree\n\t\t# filter: (objectclass&#x3D;*)\n\t\t# requesting: ALL\n\t\t#\n\t\t\n\t\t# search result\n\t\tsearch: 2\n\t\tresult: 32 No such object\n\t\t\n\t\t# numResponses: 1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>测试的日志<pre class=\"line-numbers language-none\"><code class=\"language-none\">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 fd&#x3D;12 ACCEPT from IP&#x3D;127.0.0.1:59834 (IP&#x3D;0.0.0.0:389)\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; method&#x3D;128\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; mech&#x3D;SIMPLE ssf&#x3D;0\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;2 text&#x3D;\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;2 UNBIND\nSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 fd&#x3D;12 closed\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 fd&#x3D;12 ACCEPT from IP&#x3D;127.0.0.1:34916 (IP&#x3D;0.0.0.0:389)\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;tech&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;32 nentries&#x3D;0 text&#x3D;\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;2 UNBIND\nSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 fd&#x3D;12 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"三、-web管理器配置\"><a href=\"#三、-web管理器配置\" class=\"headerlink\" title=\"三、 web管理器配置\"></a>三、 web管理器配置</h2><h3 id=\"3-1-安装-LAM-（用于管理的Web-UI）\"><a href=\"#3-1-安装-LAM-（用于管理的Web-UI）\" class=\"headerlink\" title=\"3.1 安装  LAM （用于管理的Web UI）\"></a>3.1 安装  LAM （用于管理的Web UI）</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">apt-get install ldap-account-manager<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>访问 <a href=\"http://ip/lam\">http://ip/lam</a> ，lam的所有配置都可以在web端配置，不需要去服务器上修改一行代码</p>\n<h4 id=\"3-1-1-LAM-configuration-helm-安装的主要修改内容\"><a href=\"#3-1-1-LAM-configuration-helm-安装的主要修改内容\" class=\"headerlink\" title=\"3.1.1 LAM configuration (helm 安装的主要修改内容)\"></a>3.1.1 LAM configuration (<a href=\"https://check-lc.github.io/ops_blog/2023/12/04/the-first-time-using-helm-charts/\">helm 安装的主要修改内容</a>)</h4><pre>\n主要内容：\n  LDAP_DOMAIN: example.net;ibexample.com\n  LDAP_BASE_DN: dc=example,dc=net;dc=ibexample,dc=com\n  LDAP_SERVER: ldaps://ldap01.example.net\n  LDAP_USER: cn=administrator,dc=example,dc=net\n  LAM_LANG: zh_CN\n  LAM_PASSWORD: lam\n</pre>\n\n<ul>\n<li><p>tree view编辑更高效</p>\n</li>\n<li><p>如果选择 docker 安装镜像：ghcr.io&#x2F;ldapaccountmanager&#x2F;lam:8.4@sha256:283726bd23510f1c3bfbdcbfe861e6599e070616543aed02e9756075c97a9938</p>\n</li>\n</ul>\n<h4 id=\"3-1-3-Nginx反向代理-LAM-Web-UI\"><a href=\"#3-1-3-Nginx反向代理-LAM-Web-UI\" class=\"headerlink\" title=\"3.1.3 Nginx反向代理 LAM Web UI\"></a>3.1.3 Nginx反向代理 LAM Web UI</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">upstream lam &#123;\n  server 10.13.3.108:8001;\n&#125;\n\nserver &#123;\n  listen 80;\n  server_name lam.example.net;\n  return 301 https:&#x2F;&#x2F;$server_name$request_uri;\n&#125;\n\nserver &#123;\n  server_name lam.example.net;\n  listen 443 ssl;\n  ssl_certificate webmin&#x2F;tls_ca.pem;\n  ssl_certificate_key webmin&#x2F;tls_key.pem;\n\n  location &#x2F; &#123;\n     proxy_pass http:&#x2F;&#x2F;lam&#x2F;;\n     proxy_set_header Host $host;\n     proxy_set_header X-Real-IP $remote_addr;\n     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n#     proxy_set_header X-Forwarded-Proto &quot;https&quot;;\n     proxy_read_timeout 1800s;\n     proxy_http_version 1.1;\n     proxy_set_header Upgrade $http_upgrade;\n     proxy_set_header Connection &quot;upgrade&quot;;\n    &#125;\n  &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-测试-phpldapadmin\"><a href=\"#3-2-测试-phpldapadmin\" class=\"headerlink\" title=\"3.2 测试 phpldapadmin\"></a>3.2 测试 phpldapadmin</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">Setting up php8.1 (8.1.2-1ubuntu2.14)                       # 版本信息，配置文件完整，存在证书认证并可以指定路径\nSetting up php (2:8.1+92ubuntu1) \nSetting up phpldapadmin (1.2.6.3-0.2)                                       <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"3-2-1-安装\"><a href=\"#3-2-1-安装\" class=\"headerlink\" title=\"3.2.1 安装\"></a>3.2.1 安装</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">apt-get install phpldapadmin -y\nnano &#x2F;etc&#x2F;phpldapadmin&#x2F;config.php\n\t$servers-&gt;setValue(&#39;server&#39;,&#39;name&#39;,&#39;My LDAP Server&#39;);                      # 辨识，区分的作用\n\t$servers-&gt;setValue(&#39;server&#39;,&#39;host&#39;,&#39;69.87.216.102&#39;);                              #  修改ip为服务器 ip\n\t$servers-&gt;;setValue(&#39;server&#39;,&#39;base&#39;,array(&#39;dc&#x3D;example,dc&#x3D;com&#39;));                    # 修改 array 内容为需求的根\n\t$servers-&gt;setValue(&#39;login&#39;,&#39;auth_type&#39;,&#39;session&#39;);                                              \n\t$servers-&gt;setValue(&#39;login&#39;,&#39;bind_id&#39;,&#39;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;com&#39;);           #   绑定登录帐号admin，相应修改 dn 号即可\n\t$servers-&gt;setValue(&#39;auto_number&#39;,&#39;min&#39;,array(&#39;uidNumber&#39;&#x3D;&gt;10000,&#39;gidNumber&#39;&#x3D;&gt;10000));   # 规定 uid，gid 数字表示的起始范围<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"3-2-2-为-phpLDAPadmin-配置-Apache\"><a href=\"#3-2-2-为-phpLDAPadmin-配置-Apache\" class=\"headerlink\" title=\"3.2.2 为 phpLDAPadmin 配置 Apache\"></a>3.2.2 为 phpLDAPadmin 配置 Apache</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">a2dissite 000-default.conf        # 禁用默认的 Apache 虚拟主机配置文件\nsystemctl restart apache2          <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、-主从架构-弃用，此配置需要在从服务器拉取-refresh\"><a href=\"#四、-主从架构-弃用，此配置需要在从服务器拉取-refresh\" class=\"headerlink\" title=\"四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)\"></a>四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)</h2><p><a href=\"https://darkdark.top/ch5-replication.html\">模式介绍</a></p>\n<h3 id=\"4-1-master-加载同步模块\"><a href=\"#4-1-master-加载同步模块\" class=\"headerlink\" title=\"4.1 master 加载同步模块\"></a>4.1 master 加载同步模块</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">cat &#x2F;etc&#x2F;ldap&#x2F;mod_syncprov.ldif\n\t\tdn: cn&#x3D;module,cn&#x3D;config\n\t\tobjectClass: olcModuleList\n\t\tcn: module\n\t\tolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldap\n\t\tolcModuleLoad: syncprov.la          # 此配置和上一句配置，实际是在请求这个路径的文件，&#x2F;usr&#x2F;lib&#x2F;ldap&#x2F;syncprov.la，不确定的可以用 find 查找\n\nldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f .&#x2F;mod_syncprov.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"4-2-同步设置\"><a href=\"#4-2-同步设置\" class=\"headerlink\" title=\"4.2 同步设置\"></a>4.2 同步设置</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">root@example-sys-test-06:&#x2F;etc&#x2F;ldap# cat syncprov.ldif \n\t\tdn: olcOverlay&#x3D;syncprov,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config       # 此处需要确认自己的数据库是什么样的，&#123;2&#125;hdb--旧版本默认 &#x2F; &#123;1&#125;mdb--新版本默认\n\t\tobjectClass: olcOverlayConfig\n\t\tobjectClass: olcSyncProvConfig\n\t\tolcOverlay: syncprov\n\t\tolcSpCheckpoint: 100 10\n\t\tolcSpSessionLog: 100\n\nldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f .&#x2F;syncprov.ldif                             # 修改并应用条目到 LDAP 服务  -Y EXTERNAL    将使用服务器配置的外部身份验证方法进行身份验证，而不是使用用户名和密码; -H 指定服务器连接; -f 指定文件<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"4-3-从服务器配置\"><a href=\"#4-3-从服务器配置\" class=\"headerlink\" title=\"4.3 从服务器配置\"></a>4.3 从服务器配置</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">root@example-sys-test-07:&#x2F;etc&#x2F;ldap# cat syncrepl.ldif\n\t\tdn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\n\t\tchangetype: modify\n\t\tadd: olcSyncRepl\n\t\tolcSyncRepl: rid&#x3D;002\n\t\t  provider&#x3D;ldap:&#x2F;&#x2F;10.13.3.106:389&#x2F;        # 此处开始与上一行有缩进\n\t\t  bindmethod&#x3D;simple\n\t\t  binddn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot;\n\t\t  credentials&#x3D;example@2020      \n\t\t  searchbase&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot;\n\t\t  scope&#x3D;sub\n\t\t  schemachecking&#x3D;on\n\t\t  type&#x3D;refreshAndPersist\n\t\t  retry&#x3D;&quot;5 5 300 +&quot;\n\t\t  attrs&#x3D;&quot;*,+&quot;\n\t\t  interval&#x3D;00:00:00:3\n\nldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f &#x2F;etc&#x2F;ldap&#x2F;syncrepl.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>运行中，修改主服务器内数据后，对从服务器u做刷新，可以看到是否同步</li>\n</ul>\n<p>参数说明：</p>\n<ul>\n<li>provider 为ldap master&#x2F;slave的地址 ;</li>\n<li>binddn：为域的基本信息，注这里一定要用管理员进行登录，否则同步不到用户的密码。</li>\n<li>credentials: ldap管理员的密码</li>\n<li>searchbase：选择要同步的独立域，根节点</li>\n<li>scope：设置所有的条目匹配</li>\n<li>schemachecking：设置同步更新时间检测</li>\n<li>type：同步模式为refreshAndPersist， refreshOnly 模式下后续操作由客户端轮询完成</li>\n<li>retry:同步更新重试次数和时间刚开始的5秒重试5次，以后每300秒重试一次</li>\n<li>attrs:复制全部属性</li>\n<li>interval 这里设置更新时间，这里为3秒一次，倒数第二个是分钟 以此类推。</li>\n</ul>\n<h2 id=\"四、-镜像复制（互为主从）\"><a href=\"#四、-镜像复制（互为主从）\" class=\"headerlink\" title=\"四、 镜像复制（互为主从）\"></a>四、 镜像复制（互为主从）</h2><p><a href=\"https://darkdark.top/ch5-replication.html\">模式介绍</a></p>\n<h3 id=\"4-1-为某域编辑-mirrorsync-ldif\"><a href=\"#4-1-为某域编辑-mirrorsync-ldif\" class=\"headerlink\" title=\"4.1 为某域编辑 mirrorsync.ldif\"></a>4.1 为某域编辑 mirrorsync.ldif</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;module,cn&#x3D;config         # 此段配置加载s ync 模块\nobjectClass: olcModuleList\ncn: module\nolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldap\nolcModuleLoad: syncprov.la     # 此配置和上一句，实际是在请求这个路径的文件，&#x2F;usr&#x2F;lib&#x2F;ldap&#x2F;syncprov.la，不确定的可 find 查找\n\n-\ndn: olcOverlay&#x3D;syncprov,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config        \n\t # 此处需确认自己的数据库，&#123;2&#125;hdb--为旧版本默认 &#x2F; &#123;1&#125;mdb--为新版本默认。路径 &#x2F;etc&#x2F;ldap&#x2F;slapd.d&#x2F;cn\\&#x3D;config&#x2F;olcDatabase\\&#x3D;\\&#123;1\\&#125;mdb.ldif\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 100\n\n-\ndn: cn&#x3D;config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 0                                        # 用于标识本机的 server id\n\ndn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config      # 以下配置用于开启复制，指定主服务器\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid&#x3D;000                             # 标识唯一的 replica id\n  provider&#x3D;ldaps:&#x2F;&#x2F;ldap01.example.top       # 看上述记录介绍参数\n  bindmethod&#x3D;simple\n  binddn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot;\n  credentials&#x3D;example@2020\n  searchbase&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot;\n  tls_reqcert&#x3D;allow\n  scope&#x3D;sub\n  schemachecking&#x3D;on\n  type&#x3D;refreshAndPersist\n  retry&#x3D;&quot;30 5 300 3&quot;\n  interval&#x3D;00:00:05:00\n-\nadd: olcMirrorMode                        # 开启 mirror mode\nolcMirrorMode: TRUE\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-2-ldap01-example-top下编辑-mirrorsync-ldif\"><a href=\"#4-2-ldap01-example-top下编辑-mirrorsync-ldif\" class=\"headerlink\" title=\"4.2 ldap01.example.top下编辑 mirrorsync.ldif\"></a>4.2 ldap01.example.top下编辑 mirrorsync.ldif</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;module,cn&#x3D;config\nobjectClass: olcModuleList\ncn: module\nolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldap\nolcModuleLoad: syncprov.la\n\n-\ndn: olcOverlay&#x3D;syncprov,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nobjectClass: olcOverlayConfig\nobjectClass: olcSyncProvConfig\nolcOverlay: syncprov\nolcSpSessionLog: 100\n\n-\ndn: cn&#x3D;config\nchangetype: modify\nreplace: olcServerID\nolcServerID: 1\n\ndn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcSyncRepl\nolcSyncRepl: rid&#x3D;001\n  provider&#x3D;ldaps:&#x2F;&#x2F;ldap.example.top\n  bindmethod&#x3D;simple\n  binddn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot;\n  credentials&#x3D;example@2020\n  searchbase&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot;\n  tls_reqcert&#x3D;allow\n  scope&#x3D;sub\n  schemachecking&#x3D;on\n  type&#x3D;refreshAndPersist\n  retry&#x3D;&quot;30 5 300 3&quot;\n  interval&#x3D;00:00:05:00\n-\nadd: olcMirrorMode\nolcMirrorMode: TRUE\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"4-2-1-加载配置\"><a href=\"#4-2-1-加载配置\" class=\"headerlink\" title=\"4.2.1 加载配置\"></a>4.2.1 加载配置</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f mirrorsync.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"五、-TLS加密（自签名-权威证书）\"><a href=\"#五、-TLS加密（自签名-权威证书）\" class=\"headerlink\" title=\"五、 TLS加密（自签名&#x2F;权威证书）\"></a>五、 TLS加密（自签名&#x2F;权威证书）</h2><p>（自签名证书加密连接 nextcloud 失败，使用不便，采用 权威证书（多域合一）或stunnel）</p>\n<h3 id=\"5-1-CA中心创建证书\"><a href=\"#5-1-CA中心创建证书\" class=\"headerlink\" title=\"5.1 CA中心创建证书\"></a>5.1 CA中心创建证书</h3><pre><code>此时使用LDAP 主服务器 作为 CA 中心，自签名\n</code></pre>\n<ul>\n<li><p>安装 gnutls-bin 和 ssl-cert 包</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo apt install gnutls-bin ssl-cert<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li><p>为证书授权中心创建私钥</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-privkey --bits 4096 --outfile &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li><p>创建模板文件来定义CA</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ssl&#x2F;ca.info\n\t cn &#x3D; example (example company)  \n\t ca\n\t cert_signing_key\n\t expiration_days &#x3D; 3650<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>创建自签名 CA (根)证书</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-self-signed \\\n--load-privkey &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem \\\n--template &#x2F;etc&#x2F;ssl&#x2F;ca.info \\\n--outfile &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>Note：<br>  <code>--outfile</code>路径是正确的，将CA证书写入<code>/usr/local/share/ca-certificates</code>。<br>  <strong>update-ca-certificates</strong> 将从这里获取受信任的本地CA。如果要从<code>/usr/share/ca-certificates</code>获取CA，需要调用<code>dpkg-reconfigure ca-certificates</code></p>\n</li>\n<li><p>将新的 CA 根证书添加到受信任 CA 列表</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo update-ca-certificates     # 会创建一个&#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem符号链接，指向&#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates中的真实文件<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-2-创建-LDAP-服务的服务器私钥与证书\"><a href=\"#5-2-创建-LDAP-服务的服务器私钥与证书\" class=\"headerlink\" title=\"5.2 创建 LDAP 服务的服务器私钥与证书\"></a>5.2 创建 LDAP 服务的服务器私钥与证书</h3><ul>\n<li><p>创建私钥</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-privkey \\\n--bits 2048 \\\n--outfile &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n<li><p>服务器信息文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ssl&#x2F;ldap01.info\n\torganization &#x3D; example\n\tcn &#x3D; ldap01.example.top                     # 服务器证书的DN必须使用CN属性来命名服务器，并且CN必须携带服务器的完全限定域名，dns 需要有 A 记录解析\n\ttls_www_server\n\tencryption_key\n\tsigning_key\n\texpiration_days &#x3D; 365\n证书有效期为1年，仅对_&#96;ldap01&#96;_主机名有效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>创建LDAP服务器的证书</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-certificate \\\n--load-privkey &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem \\\n--load-ca-certificate &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem \\\n--load-ca-privkey &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem \\\n--template &#x2F;etc&#x2F;ssl&#x2F;ldap01.info \\\n--outfile &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_cert.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>调整权限</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo chgrp openldap &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem\nsudo chmod 0640 &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li><p>ca根证书加入到受信列表</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo cp   cacertificatefile  &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crt\nsudo update-ca-certificates<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>对LDAP服务配置证书</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;config\nadd: olcTLSCACertificateFile\nolcTLSCACertificateFile: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem\n-\nadd: olcTLSCertificateFile\nolcTLSCertificateFile: &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_cert.pem\n-\nadd: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>配置slapd-config数据库：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f certinfo.ldif <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li><p>报错调整，更改<code>certinfo.ldif</code>，将<code>add</code>改成了<code>replace</code>，可以解决以下问题。修改后再次执行<code>ldapmodify</code></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f certinfo.ldif \n\tSASL&#x2F;EXTERNAL authentication started SASL username: gidNumber&#x3D;0+uidNumber&#x3D;0,cn&#x3D;peercred,cn&#x3D;external,cn&#x3D;auth \n\tSASL SSF: 0 \n\tmodifying entry &quot;cn&#x3D;config&quot; ldap_modify: Inappropriate matching (18) \n\tadditional info: modify&#x2F;add: olcTLSCACertificateFile: no equality matching rule<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>ldap-client增添配置文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;ldap.conf\n\t# LDAP Defaults\n\t# See ldap.conf(5) for details\n\t# This file should be world readable but not world writable.\t\n\tBASE       dc&#x3D;example,dc&#x3D;top                                                      # LDAP服务的基础DN\n\tURI ldap:&#x2F;&#x2F;localhost:389 ldaps:&#x2F;&#x2F;localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径\n\tTLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li><p>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;default&#x2F;slapd\n\tSLAPD_SERVICES&#x3D;&quot;ldap:&#x2F;&#x2F;&#x2F; ldapi:&#x2F;&#x2F;&#x2F; ldaps:&#x2F;&#x2F;&#x2F;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li><p>测试启动 TLS</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapwhoami -x -ZZ -H ldap:&#x2F;&#x2F;ldap01.example.com\nanonymous<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li><p>测试连接</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapwhoami -x -H ldaps:&#x2F;&#x2F;ldap01.example.com\nanonymous<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器\"><a href=\"#5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器\" class=\"headerlink\" title=\"5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器\"></a>5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器</h3><ul>\n<li>指定目录保存<pre class=\"line-numbers language-none\"><code class=\"language-none\">mkdir ldap02-ssl\ncd ldap02-ssl\ncerttool --generate-privkey \\\n--bits 2048 \\\n--outfile ldap02_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>编辑信息文件ldap02.info<pre class=\"line-numbers language-none\"><code class=\"language-none\">organization &#x3D; example\ncn &#x3D; ldap02.example.top                      \ntls_www_server\nencryption_key\nsigning_key\nexpiration_days &#x3D; 365<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>创建证书<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo certtool --generate-certificate \\\n--load-privkey ldap02_slapd_key.pem \\\n--load-ca-certificate &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem \\\n--load-ca-privkey &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem \\\n--template ldap02.info \\\n--outfile ldap02_slapd_cert.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">cp &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem .\nscp -r ldap02-ssl user@ldap02_ip:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>从服务器中安装证书<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo cp ldap02_slapd_cert.pem ldap02_slapd_key.pem &#x2F;etc&#x2F;ldap\nsudo chgrp openldap &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_key.pem\nsudo chmod 0640 &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_key.pem\nsudo cp mycacert.pem &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crt\nsudo update-ca-certificates<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>对LDAP服务配置证书 <code>./certinfo.ldif </code><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;config\nadd: olcTLSCACertificateFile\nolcTLSCACertificateFile: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem\n-\nadd: olcTLSCertificateFile\nolcTLSCertificateFile: &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_cert.pem\n-\nadd: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>配置slapd-config数据库：<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f certinfo.ldif <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>增添配置文件<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;ldap.conf\n\tBASE       dc&#x3D;example,dc&#x3D;top                                                      # LDAP服务的基础DN\n\tURI ldap:&#x2F;&#x2F;localhost:389 ldaps:&#x2F;&#x2F;localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径\n\tTLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;default&#x2F;slapd\n\tSLAPD_SERVICES&#x3D;&quot;ldap:&#x2F;&#x2F;&#x2F; ldapi:&#x2F;&#x2F;&#x2F; ldaps:&#x2F;&#x2F;&#x2F;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li>测试启动 TLS<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapwhoami -x -ZZ -H ldap:&#x2F;&#x2F;ldap02.example.top\nanonymous<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n<li>测试连接<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapwhoami -x -H ldaps:&#x2F;&#x2F;ldap02.example.top\nanonymous<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-4-使用合法证书\"><a href=\"#5-4-使用合法证书\" class=\"headerlink\" title=\"5.4 使用合法证书\"></a>5.4 使用合法证书</h3><ul>\n<li><p>将新的 CA 根证书添加到受信任 CA 列表（客户端操作，权威证书按理不需要拷贝，未测试）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo   cp   _.example.top-chain.pem   &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crt\nsudo update-ca-certificates<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>准备服务器证书和私钥（服务端）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"> ls &#x2F;etc&#x2F;ldap\n\tcertinfo.ldif   _.example.top-crt.pem   _.example.top-key.pem\nsudo chgrp openldap &#x2F;etc&#x2F;ldap&#x2F;_.example.top-key.pem\nsudo chmod 0640 &#x2F;etc&#x2F;ldap&#x2F;_.example.top-key.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>certinfo.ldif</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;config\nchangetype: modify\nreplace: olcTLSCACertificateFile\nolcTLSCACertificateFile: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem\n-\nreplace: olcTLSCertificateFile\nolcTLSCertificateFile: &#x2F;etc&#x2F;ldap&#x2F;_.example.top-crt.pem\n-\nreplace: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: &#x2F;etc&#x2F;ldap&#x2F;_.example.top-key.pem\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo ldapadd  -Y   EXTERNAL  -H  ldapi:&#x2F;&#x2F;&#x2F;   -f    certinfo.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n<ul>\n<li>增添配置文件，这是客户端需要连接 ldap 服务器使用的配置。可以忽略。<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;ldap.conf\n\tBASE       dc&#x3D;example,dc&#x3D;top                                                      # LDAP服务的基础DN\n\t[[URI]] ldap:&#x2F;&#x2F;localhost:389 ldaps:&#x2F;&#x2F;localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用\n\t[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制\n\t[[TIMELIMIT]]  15                                                                     # 最长搜索时间\n\t[[DEREF]]              never                                                            # 指定对别名的处理方式\n\t# TLS certificates (needed for GnuTLS)\n\tTLS_CACERT  &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径，必需\n\tTLS_REQCERT allow                                                      # &quot;demand&quot;，表示需要验证服务器的证书<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>启用 ldaps，重启 slapd<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;default&#x2F;slapd\n\tSLAPD_SERVICES&#x3D;&quot;ldap:&#x2F;&#x2F;&#x2F; ldapi:&#x2F;&#x2F;&#x2F; ldaps:&#x2F;&#x2F;&#x2F;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-5-使用-nextcloud-测试加密连接\"><a href=\"#5-5-使用-nextcloud-测试加密连接\" class=\"headerlink\" title=\"5.5 使用 nextcloud 测试加密连接\"></a>5.5 使用 nextcloud 测试加密连接</h3><ul>\n<li><p>docker 安装 nexcloud，登录 UI ，右上角点击账户，选择应用</p>\n</li>\n<li><p>应用捆绑包，启用 LDAP user and group backend</p>\n</li>\n<li><p>设置连接</p>\n</li>\n<li><p>ldaps连接(严格一致才是tls加密，nextcloud应该只信任权威证书)</p>\n</li>\n<li><p>明文传输</p>\n</li>\n</ul>\n<h3 id=\"5-6-stunnel-加密传输两个应用的数据-例：phpldapadmin\"><a href=\"#5-6-stunnel-加密传输两个应用的数据-例：phpldapadmin\" class=\"headerlink\" title=\"5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)\"></a>5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)</h3><p>链路： ldap user ui  —- stunnel client  accept  —-  stunnel client connect  —- stunnel server accept  —- stunnel server connect —-ldap server port</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apt install -y stunnel4\nvim &#x2F;etc&#x2F;default&#x2F;stunnel4\n\tENABLED&#x3D;1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"># stunnel 服务端\n\tcert &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem\n\tkey &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel-key.pem\n\tverify &#x3D; 3\n\tclient &#x3D; no\n\tdebug &#x3D; 6\n\tpid &#x3D; &#x2F;var&#x2F;run&#x2F;stunnel4&#x2F;stunnel4.pid\n\t\n\t[ldap]\n\taccept &#x3D; 10.13.3.106:6360                # 监听 stunnel 服务的流量，客户端（是指stunnel 客户端）将连接此目标并发送流量到这里\n\tconnect &#x3D; 10.13.3.106:389                # 转发到 stunnel 加密连接的服务的端口\n\tCAfile &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem\n\n# stunnel 客户端\n\tcert &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem\n\tkey &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel-key.pem\n\tverify &#x3D; 3\n\tclient &#x3D; yes\n\tdebug &#x3D; 6\n\tsetuid &#x3D; stunnel4\n\tsetgid &#x3D; stunnel4\n\tpid &#x3D; &#x2F;var&#x2F;run&#x2F;stunnel4&#x2F;stunnel4.pid\n\t\n\t[ldap]\n\taccept &#x3D; 10.13.3.107:389                # 监听 stunnel 服务的流量，客户端（是指ldap的客户端）将连接此目标并发送流量到这里\n\tconnect &#x3D; 10.13.3.106:6360              # 加密连接并转发到 stunnel 的服务端\n\tCAfile &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;phpldapadmin&#x2F;config.php\n\t$servers-&gt;setValue(&#39;server&#39;,&#39;host&#39;,&#39;69.87.216.102&#39;);  # 指向 stunnel 客户端，和他本地监听的端口\n\t$servers-&gt;setValue(&#39;server&#39;,&#39;port&#39;,389);\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"六、-其他模块\"><a href=\"#六、-其他模块\" class=\"headerlink\" title=\"六、 其他模块\"></a>六、 其他模块</h2><h3 id=\"6-1-日志模块\"><a href=\"#6-1-日志模块\" class=\"headerlink\" title=\"6.1 日志模块\"></a>6.1 日志模块</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;loglevel.ldif\n\tdn: cn&#x3D;config\n\tchangetype: modify\n\treplace: olcLogLevel\n\tolcLogLevel: stats\n\nldapmodify  -Y  EXTERNAL  -H  ldapi:&#x2F;&#x2F;&#x2F;  -f  loglevel.ldif               # 日志在&#x2F;var&#x2F;log&#x2F;syslog | grep slapd , 比默认的级别详细<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"6-2-memberOf-开启\"><a href=\"#6-2-memberOf-开启\" class=\"headerlink\" title=\"6.2 memberOf 开启\"></a>6.2 memberOf 开启</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;refint.ldif\n\t# enable_refint.ldif\n\tdn: cn&#x3D;module&#123;0&#125;,cn&#x3D;config\n\tchangetype: modify\n\tadd: olcModuleLoad\n\tolcModuleLoad: refint.la\n\t-\n\tdn: olcOverlay&#x3D;refint,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\n\tchangetype: add\n\tobjectClass: olcOverlayConfig\n\tobjectClass: olcRefintConfig\n\tolcOverlay: refint\n\nldapadd -Q -Y EXTERNAL -H ldapi:&#x2F;&#x2F; -f refint.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F;etc&#x2F;ldap&#x2F;memberof.ldif\n\tdn: cn&#x3D;module,cn&#x3D;config\n\tchangetype: add\n\tcn: module\n\tobjectClass: olcModuleList\n\tolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldap\n\t\n\tdn: cn&#x3D;module&#123;0&#125;,cn&#x3D;config\n\tchangetype: modify\n\tadd: olcModuleLoad\n\tolcModuleLoad: memberof.la\n\t\n\tdn: olcOverlay&#x3D;memberof,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\n\tchangetype: add\n\tobjectClass: olcConfig\n\tobjectClass: olcMemberOf\n\tobjectClass: olcOverlayConfig\n\tobjectClass: top\n\tolcOverlay: memberof\n\tolcMemberOfDangling: ignore\n\tolcMemberOfRefInt: TRUE\n\tolcMemberOfGroupOC: groupOfNames\n\tolcMemberOfMemberAD: member\n\tolcMemberOfMemberOfAD: memberOf\n\nldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f memberof.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>为条目添加此属性：LDIF文件中先创建用户的dn，然后创建目标组的dn，在创建组的时候将关联的用户写在member属性中</li>\n</ul>\n<h3 id=\"6-3-Self-Service-Password-自助密码管理\"><a href=\"#6-3-Self-Service-Password-自助密码管理\" class=\"headerlink\" title=\"6.3 Self Service Password 自助密码管理\"></a>6.3 Self Service Password 自助密码管理</h3><ul>\n<li>容器部署，解决 php 依赖准备繁琐</li>\n<li>镜像 ltbproject&#x2F;self-service-password:1.5.3</li>\n<li>为 admin 用户设置修改密码的权限<pre class=\"line-numbers language-none\"><code class=\"language-none\">下列权限可以使得 &quot;admin,example,net&quot; 对这个域 &quot;dc&#x3D;example,dc&#x3D;tech&quot; 做用户添加、属性修改\nolcAccess: &#123;0&#125;to attrs&#x3D;userPassword,shadowLastChange by dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write by anonymous auth by self write by * none\nolcAccess: &#123;1&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;tech&quot; by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n<li>需要对企业邮箱帐号开启设置-帐号与安全-客户端设置-客户端授权密码</li>\n<li>ssp.conf.php  成功配置版本，并映射到容器： &#x2F;home&#x2F;example&#x2F;sspasswd&#x2F;conf.php:&#x2F;var&#x2F;www&#x2F;conf&#x2F;config.inc.local.php<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$debug</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$keyphrase</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"example\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$use_sms</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$use_questions</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$lang</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"cn,zh-CN\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$use_change</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#$reset_url = $_SERVER['HTTP_X_FORWARDED_PROTO'] . \"://\" . $_SERVER['HTTP_X_FORWARDED_HOST'] . $_SERVER['SCRIPT_NAME'];</span>\n<span class=\"token variable\">$reset_url</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"https://ssp.example.net\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'HTTP_X_FORWARDED_HOST'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'SCRIPT_NAME'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$show_menu</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$logo</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"images/logo.png\"</span><span class=\"token punctuation\">;</span>                <span class=\"token comment\"># 这两项在配置前，需要确保图片映射路径在容器内部的 /var/www/html/images 下</span>\n<span class=\"token variable\">$background_image</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"images/back.png\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$default_action</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"sendtoken\"</span><span class=\"token punctuation\">;</span>        <span class=\"token comment\"># 默认展示在首页的修改密码的方式</span>\n<span class=\"token variable\">$show_menu</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>              <span class=\"token comment\"># 关闭顶部的修改方式选择菜单</span>\n\n<span class=\"token comment\"># LDAP</span>\n\n<span class=\"token variable\">$ldap_url</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"ldap://10.13.3.107/\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_starttls</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_binddn</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"cn=admin,dc=example,dc=net\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_bindpw</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'example@2020'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#$ldap_bindpw = \"&#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi\";</span>\n<span class=\"token variable\">$ldap_base</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"dc=example,dc=net\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#$ldap_base = \"dc=example,dc=tech\";    # 在这里同时书写两个，只会生效后一个域, 使用两个实例连接 ldap 服务</span>\n<span class=\"token variable\">$ldap_fullname_attribute</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"cn\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_filter</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"(&amp;(objectClass=inetOrgPerson)(<span class=\"token interpolation\"><span class=\"token variable\">$ldap_fullname_attribute</span></span>=&#123;login&#125;))\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_use_exop_passwd</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ldap_use_ppolicy_control</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$TLS_REQCERT</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"allow\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\"># email</span>\n<span class=\"token variable\">$mail_attributes</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"mail\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"gosaMailAlternateAddress\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"proxyAddresses\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_address_use_ldap</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_from</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"user5@example.net\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_from_name</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"密码自主修改服务\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_signature</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"如有疑问,请联系运维同事,英博智云.\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$notify_on_change</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_protocol</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'smtp'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_host</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'smtphz.qiye.163.com'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_auth</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_user</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"user5@example.net\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_pass</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'TdhYDdgvN7Hpky5a'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_port</span> <span class=\"token operator\">=</span> <span class=\"token number\">465</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_timeout</span> <span class=\"token operator\">=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_keepalive</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_secure</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'ssl'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_autotls</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_smtp_options</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_contenttype</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'text/plain'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_wordwrap</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_charset</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'utf-8'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$mail_priority</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\"># password policy</span>\n<span class=\"token variable\">$hash</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"SSHA\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># 修改的用户密码传递过程中会采取这里指定的加密</span>\n<span class=\"token variable\">$pwd_min_length</span> <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_max_length</span> <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_min_lower</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_min_upper</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_min_digit</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_min_special</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_special_chars</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"^a-zA-Z0-9\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_complexity</span> <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_no_reuse</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_forbidden_words</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"example\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"example\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"example\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_show_policy_pos</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"above\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd_show_policy</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"onerror\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">docker run -p 8000:80 \\\n&gt; --restart&#x3D;always \\\n&gt; --name sspass \\\n&gt; -v &#x2F;home&#x2F;example&#x2F;sspasswd&#x2F;conf.php:&#x2F;var&#x2F;www&#x2F;conf&#x2F;config.inc.local.php \\\n&gt; -itd docker.io&#x2F;ltbproject&#x2F;self-service-password<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"6-3-1-不能进入修改链接-Token-is-not-valid\"><a href=\"#6-3-1-不能进入修改链接-Token-is-not-valid\" class=\"headerlink\" title=\"6.3.1 不能进入修改链接 Token is not valid\"></a>6.3.1 不能进入修改链接 Token is not valid</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">注释了这两项\n#$use_tokens &#x3D; true;\n#$crypt_tokens &#x3D; true;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"6-3-2-反向代理-Self-Service-Password\"><a href=\"#6-3-2-反向代理-Self-Service-Password\" class=\"headerlink\" title=\"6.3.2 反向代理 Self Service Password\"></a>6.3.2 反向代理 Self Service Password</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">upstream ssp &#123;\n  server 10.13.3.108:8000;\n&#125;\n\nserver &#123;\n    listen 80;\n    server_name ssp.example.net;\n    return 301 https:&#x2F;&#x2F;$server_name$request_uri;\n&#125;\nserver &#123;\n    listen 443 ssl ;\n    server_name ssp.example.net;\n    ssl_certificate webmin&#x2F;tls_ca.pem;\n    ssl_certificate_key webmin&#x2F;tls_key.pem;\n\n    location &#x2F; &#123;\n      proxy_pass http:&#x2F;&#x2F;ssp;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto &quot;https&quot;;\n      proxy_read_timeout 1800s;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection &quot;upgrade&quot;;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-4-LDAP-对目录信息的数据做备份还原和迁移\"><a href=\"#6-4-LDAP-对目录信息的数据做备份还原和迁移\" class=\"headerlink\" title=\"6.4 LDAP 对目录信息的数据做备份还原和迁移\"></a>6.4 LDAP 对目录信息的数据做备份还原和迁移</h3><h4 id=\"6-4-1-备份\"><a href=\"#6-4-1-备份\" class=\"headerlink\" title=\"6.4.1 备份\"></a>6.4.1 备份</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo slapcat -n 3 -l .&#x2F;back3.ldif           # -n 指定数据库编号，数字对应各个dit的数据库编号( 配置数据库----olcDatabase&#x3D;&#123;0&#125;config.ldif; 目录信息数据库----olcDatabase&#x3D;&#123;1&#125;mdb.ldif )<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"6-4-2-恢复\"><a href=\"#6-4-2-恢复\" class=\"headerlink\" title=\"6.4.2 恢复\"></a>6.4.2 恢复</h4><p>原服务器上恢复，服务需要暂停</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo systemctl stop slapd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>配置目录一般位于 <code>/etc/openldap/slapd.d</code>，将原有配置删除，然后使用 <code>slapadd</code> 导入新的配置</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$ rm -rf &#x2F;etc&#x2F;ldap&#x2F;slapd.d&#x2F;*\n$ slapadd  -n  0  -F  &#x2F;etc&#x2F;ldap&#x2F;slapd.d  -l  .&#x2F;config.2021-09-18.ldif\n$ chown -R openldap:openldap &#x2F;etc&#x2F;ldap&#x2F;slapd.d<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>数据目录一般位于 <code>/var/lib/ldap-*</code>，模拟时，将原有数据删除，然后使用 <code>slapadd</code> 导入新的数据：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$ rm  -rf  &#x2F;var&#x2F;lib&#x2F;ldap-example&#x2F;*         # 定制了不同的$default_action &#x3D; &quot;sendtoken&quot;;\n$show_menu &#x3D; false;dit有不同的目录分别存储不同domain的内容，注意，导入前目录必需首先存在，且权属 openldap:openldap。\n$ slapadd -n 1 -F &#x2F;etc&#x2F;openldap&#x2F;slapd.d -l .&#x2F;data.2021-09-18.ldif\n$ chown -R openldap:openldap  &#x2F;var&#x2F;lib&#x2F;ldap-example\n$ systemctl start slapd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"6-4-3-openldap的迁移\"><a href=\"#6-4-3-openldap的迁移\" class=\"headerlink\" title=\"6.4.3 openldap的迁移\"></a>6.4.3 openldap的迁移</h4><p>playbook 新建的服务器，执行恢复</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">slapadd -n 1 -F &#x2F;etc&#x2F;openldap&#x2F;slapd.d -l .&#x2F;data.2021-09-18.ldif\n\n[[如果导入失败，或者数据已存在，删除rm]] -rf &#x2F;var&#x2F;lib&#x2F;ldap&#x2F;*  重新导入<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n<h2 id=\"七、-命令资料\"><a href=\"#七、-命令资料\" class=\"headerlink\" title=\"七、 命令资料\"></a>七、 命令资料</h2><blockquote>\n<p><a href=\"https://blog.csdn.net/jenyzhang/article/details/56487627\">来自此处</a><br>ldap<br>    |-slapd             目录服务的主要程序<br>    |-slurpd           目录服务进行复制的程序<br>    |-slapadd           向目录中添加数据<br>    |-slapcat           把目录中的条目导出成ldif文件<br>    |-slapindex         重建目录的索引<br>    |-ldapcompare       对目录的条目的属性进行比较<br>    |-ldapadd           向目录服务中添加条目<br>    |-ldapdelete        删除目录中的条目<br>    |-ldapmodify        更新目录中条目的值<br>    |-ldapmodrdn        更改条目的DN<br>    |-ldappasswd        更改条目的密码<br>    |-ldapsearch        对目录进行查询</p>\n</blockquote>\n<blockquote>\n<p>ldapadd<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -h   目录服务的地址<br>      -w   绑定DN的密码<br>      -f   使用ldif文件进行条目添加的文件  \n      </p>\n</blockquote>\n<ul>\n<li>例子<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -f &#x2F;root&#x2F;test.ldif<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret (这样写就是在命令行添加条目)</li>\n</ul>\n<p>       </p>\n<blockquote>\n<p>ldapsearch<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -w   绑定DN的密码<br>      -b   指定要查询的根节点<br>      -H   制定要查询的服务器<br>      -s   指定搜索范围的类型\n     </p>\n</blockquote>\n<ul>\n<li>例子<br>   ldapsearch -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -b “dc&#x3D;starxing,dc&#x3D;com”<br>       使用简单认证，用 “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” 进行绑定，<br>       要查询的根是 “dc&#x3D;starxing,dc&#x3D;com”。这样会把绑定的用户能访问”dc&#x3D;starxing,dc&#x3D;com”下的所有数据显示出来。<br> ldapsearch -x -W -D “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -b “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -h troy.osdn.zzti.edu.cn<br>   ldapsearch -b “dc&#x3D;canon-is,dc&#x3D;jp” -H ldaps:&#x2F;&#x2F;192.168.0.92:636<br> (需要修改openldap客户端的配置文件ldap.conf,参考：<a href=\"http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm\">http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm</a>)</li>\n</ul>\n<blockquote>\n<p>ldapdelete <br>      ldapdelete -x -D “cn&#x3D;Manager,dc&#x3D;test,dc&#x3D;com” -w secret “uid&#x3D;test1,ou&#x3D;People,dc&#x3D;test,dc&#x3D;com”<br>      ldapdelete -x -D ‘cn&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secert ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’<br>      这样就可以删除’uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’记录了，应该注意一点，其下有子条目的不能删除  </p>\n</blockquote>\n<ul>\n<li><p>例子1  递归删除所有：<br>ldapdelete -x -D ‘cn&#x3D;administrator,dc&#x3D;example,dc&#x3D;net’ -w example@2020 -r “ou&#x3D;example,dc&#x3D;example,dc&#x3D;net”</p>\n</li>\n<li><p>例子2  删除一个acl策略。acl-dele.ldif<br> dn: olcDatabase&#x3D;{3}mdb,cn&#x3D;config<br> delete: olcAccess<br> olcAccess: {2}<br> olcAccess: {3}<br> olcAccess: {4}<br> ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f acl-dele.ldif</p>\n</li>\n</ul>\n<blockquote>\n<p>ldappasswd<br>    -x   进行简单认证<br>    -D   用来绑定服务器的DN<br>    -w   绑定DN的密码<br>    -S   提示的输入密码<br>    -s pass 把密码设置为pass<br>    -a pass 设置old passwd为pass<br>    -A   提示的设置old passwd<br>    -H   是指要绑定的服务器<br>    -I   使用sasl会话方式  \n    </p>\n</blockquote>\n<ul>\n<li>例子<br>    ldappasswd -x -D ‘cm&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secret ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’ -S<br>       New password:<br>       Re-enter new password:<br>       就可以更改密码了，如果原来记录中没有密码，将会自动生成一个userPassword。</li>\n</ul>\n<p>    </p>\n<blockquote>\n<p>ldapmodify<br>     -a 添加新的条目.缺省的是修改存在的条目.<br>     -C 自动追踪引用.<br>     -c 出错后继续执行程序并不中止.缺省情况下出错的立即停止.比如如果你的ldif 文件内的某个条目在<a href=\"http://lib.csdn.net/base/mysql\" title=\"MySQL知识库\">数据库</a>内并不存在,缺省情况下程序立即退出,但如果使用了该参数,程序忽略该错误继续执行.<br>     -n 用于调试到服务器的通讯.但并不实际执行搜索.服务器关闭时,返回错误；服务器<br>       打开时,常和-v 参数一起<a href=\"http://lib.csdn.net/base/softwaretest\" title=\"软件测试知识库\">测试</a>到服务器是否是一条通路.<br>     -v 运行在详细模块.在标准输出中打出一些比较详细的信息.比如:连接到服务器的<br>       ip 地址和端口号等.<br>     -M  打开 manage DSA IT 控制. -MM 把该控制设置为重要的.<br>     -f file 从文件内读取条目的修改信息而不是从标准输入读取.<br>    -x 使用简单认证.<br>    -D binddn 指定搜索的用户名(一般为一dn 值).<br>    -W 指定了该参数,系统将弹出一提示入用户的密码.它和-w 参数相对使用.<br>    -w bindpasswd 直接指定用户的密码. 它和-W 参数相对使用.<br>    -H ldapuri 指定连接到服务器uri(ip 地址和端口号,常见格式为 ldap:&#x2F;&#x2F;hostname:port ).如果使用了-H 就不能使用-h 和-p 参数.<br>    -h ldaphost 指定要连接的主机的名称&#x2F;ip 地址.它和-p 一起使用<br>    -p ldapport 指定要连接目录服务器的端口号.它和-h 一起使用，如果使用了-h 和-p 参数就不能使用-H 参数.<br>    -Z 使用StartTLS 扩展操作.如果使用-ZZ,命令强制使用StartTLS 握手成功.<br>    -V 启用证书认证功能,目录服务器使用客户端证书进行身份验证,必须与-ZZ 强制启用<br>       TLS 方式配合使用,并且匿名绑定到目录服务器.<br>    -e 设置客户端证书文件,例: -e cert&#x2F;client.crt<br>    -E 设置客户端证书私钥文件,例: -E cert&#x2F;client.key  </p>\n</blockquote>\n<ul>\n<li>例子<br>ldapmodify -x -D “cn&#x3D;root,dc&#x3D;it,dc&#x3D;com” -W -f modify.ldif    #   将modify.ldif中的记录更新原有的记录。</li>\n</ul>\n<h2 id=\"八、-参考链接\"><a href=\"#八、-参考链接\" class=\"headerlink\" title=\"八、 参考链接\"></a>八、 参考链接</h2><p><a href=\"https://github.com/jt6562/LDAP-read-notes/blob/master/ldap-guide/OpenLDAP%E7%AE%A1%E7%90%86%E5%91%98%E6%89%8B%E5%86%8C.md\">指南</a><br><a href=\"https://www.cnblogs.com/kevingrace/p/5773974.html\">知识总结</a><br><a href=\"https://www.cnblogs.com/js1314/p/12887893.html\">参考1</a><br><a href=\"https://cloud.tencent.com/developer/article/1932586\">参考2</a><br><a href=\"https://blog.csdn.net/u011607971/article/details/121126289?spm=1001.2014.3001.5501#t3\">参考3</a><br><a href=\"https://ubuntu.com/server/docs/service-ldap-with-tls\">Ubuntu wiki</a><br><a href=\"https://www.cnblogs.com/shu-sheng/p/14450815.html\">tls参考1</a><br><a href=\"https://hmli.ustc.edu.cn/doc/linux/ubuntu-ldap/ubuntu-ldap.html#id14\">tls参考2</a><br><a href=\"https://zhuanlan.zhihu.com/p/643010354\">tls参考3</a></p>\n<h2 id=\"九、问题：\"><a href=\"#九、问题：\" class=\"headerlink\" title=\"九、问题：\"></a>九、问题：</h2><h3 id=\"9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果\"><a href=\"#9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果\" class=\"headerlink\" title=\"9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果\"></a>9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果</h3><h3 id=\"9-2-日志功能开启失败\"><a href=\"#9-2-日志功能开启失败\" class=\"headerlink\" title=\"9.2 日志功能开启失败\"></a>9.2 日志功能开启失败</h3><pre><code>已经调整日志级别，在系统日志中查看并grep\n</code></pre>\n<h3 id=\"9-3-证书缺失-只能使用ldap01-这个信息查询）\"><a href=\"#9-3-证书缺失-只能使用ldap01-这个信息查询）\" class=\"headerlink\" title=\"9.3 证书缺失(只能使用ldap01,这个信息查询）\"></a>9.3 证书缺失(只能使用ldap01,这个信息查询）</h3><pre><code>采取使用权威证书\n</code></pre>\n<h3 id=\"9-4-重启slap报错-tls-init-failed\"><a href=\"#9-4-重启slap报错-tls-init-failed\" class=\"headerlink\" title=\"9.4 重启slap报错 tls init   failed\"></a>9.4 重启slap报错 tls init   failed</h3><pre><code>解决办法：重新生成证书\n</code></pre>\n<h3 id=\"9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code\"><a href=\"#9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code\" class=\"headerlink\" title=\"9.5 报错 ldap_start_tls: Connect error (-11)    \\n    additional info: (unknown error code)\"></a>9.5 报错 ldap_start_tls: Connect error (-11)    \\n    additional info: (unknown error code)</h3><pre><code>可能是由于服务器证书的通用名（Common Name）字段是否与主机名不一致，请检查主机名和服务器证书\n</code></pre>\n<h3 id=\"9-6-连接问题\"><a href=\"#9-6-连接问题\" class=\"headerlink\" title=\"9.6 连接问题\"></a>9.6 连接问题</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldaps:&#x2F;&#x2F;ldap.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W            # 在服务器本机执行此查询的报错。但是在另一个机器可以成功查询\n\tldap_sasl_bind(SIMPLE): Can&#39;t contact LDAP server (-1)                                 # 配置 ldap.conf 之后成功解决并有输出 tls&#x3D;demand&#x2F;allow----作用是证书检查<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h3 id=\"9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”\"><a href=\"#9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”\" class=\"headerlink\" title=\"9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”\"></a>9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">1. 首先尝试重新部署，发现执行镜像复制的剧本之前可以正常创建所有的条目\n    解决：在mirror mode 开启时，需要指定相应的数据库\n2.  shadow context; no update referral  根本原因是需要检查权限<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"9-8-使用的脚本一致，测试环境和生产环境结果不一致-主要是不能长时间正常保持客户端连接并查询\"><a href=\"#9-8-使用的脚本一致，测试环境和生产环境结果不一致-主要是不能长时间正常保持客户端连接并查询\" class=\"headerlink\" title=\"9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询\"></a>9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询</h3><ul>\n<li>脚本中的组织信息ldif文件有问题，经测试不影响。</li>\n<li>memberOf，属性不可单独添加，通过 groupofNames 指定 member 之后会自动关联。已经修正使用方式，结果未改变。</li>\n<li>2204 系统和 2004 系统的slapd版本不一致（并没有影响）。</li>\n<li>将orgnization的任务和前一部分拆分，否则会出现读取不到 rootdn（手动测试是成功的）（然而脚本中修改后并没有解决这个问题）。</li>\n<li>将organization拆分，在此之前重启服务，未解决。</li>\n<li>将organization拆分，在此之前先重启虚拟机。（有效、怀疑是服务中某些连接的状态在ansible执行中没有更新）（仍然失效了，经过一夜之后失效）。</li>\n<li>另一台2204主机安装正常使用，怀疑虚拟机系统问题。</li>\n</ul>\n<h2 id=\"十、-验证\"><a href=\"#十、-验证\" class=\"headerlink\" title=\"十、 验证\"></a>十、 验证</h2><h3 id=\"10-1-检测连接命令：\"><a href=\"#10-1-检测连接命令：\" class=\"headerlink\" title=\"10.1 检测连接命令：\"></a>10.1 检测连接命令：</h3><p> ldaps:&#x2F;&#x2F;    —-ldap over ssl  使用636 ，从连接开始加密   ;        ldap:&#x2F;&#x2F;           —ldap_start_tls(-ZZ参数):    使用389，从传输开始加密</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldaps:&#x2F;&#x2F;ldap01.example.top:636 -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -s sub &quot;(objectClass&#x3D;person)&quot;\n\nldapsearch -H ldap:&#x2F;&#x2F;10.13.3.106  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -s sub &quot;(objectClass&#x3D;person)&quot;\n\nldapsearch -H ldap:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -s sub &quot;(objectClass&#x3D;person)&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"10-2-验证和日志\"><a href=\"#10-2-验证和日志\" class=\"headerlink\" title=\"10.2 验证和日志\"></a>10.2 验证和日志</h3><p>tag 101 应表明在查询; tag 97 是在认证</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldap:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W   -ZZ      #  启用了tls功能 ，-ZZ 参数，仍然是 389 端口，连接后在传输过程中加密\n\t\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:60674 (IP&#x3D;0.0.0.0:389)\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;0 EXT oid&#x3D;1.3.6.1.4.1.1466.20037\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;0 STARTTLS\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;0 RESULT oid&#x3D; err&#x3D;0 text&#x3D;\n\tSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 fd&#x3D;14 TLS established tls_ssf&#x3D;256 ssf&#x3D;256\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;1 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;1 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;1 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;2 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;2 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;6 text&#x3D;\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;3 UNBIND\n\tSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 fd&#x3D;14 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldap:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W        # 明文传输\n\t\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:37760 (IP&#x3D;0.0.0.0:389)\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;6 text&#x3D;\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;2 UNBIND\n\tSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 fd&#x3D;14 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldaps:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W        # 从连接就开始加密\n\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:58726 (IP&#x3D;0.0.0.0:636)\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 fd&#x3D;14 TLS established tls_ssf&#x3D;256 ssf&#x3D;256\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;6 text&#x3D;\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;2 UNBIND\n\tSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 fd&#x3D;14 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ldapsearch -H ldaps:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -ZZ\n\tldap_start_tls: Operations error (1)\n        additional info: TLS already started\n\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:39894 (IP&#x3D;0.0.0.0:636)\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 fd&#x3D;14 TLS established tls_ssf&#x3D;256 ssf&#x3D;256\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;0 EXT oid&#x3D;1.3.6.1.4.1.1466.20037\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;0 STARTTLS\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;0 RESULT oid&#x3D; err&#x3D;1 text&#x3D;TLS already started                # 证明二者冲突，不能同时开启\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;1 UNBIND\nSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 fd&#x3D;14 closed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"十一、应用服务\"><a href=\"#十一、应用服务\" class=\"headerlink\" title=\"十一、应用服务\"></a>十一、应用服务</h2><h3 id=\"11-1-建立-ldap-管理-只读帐号\"><a href=\"#11-1-建立-ldap-管理-只读帐号\" class=\"headerlink\" title=\"11.1 建立 ldap 管理&#x2F;只读帐号\"></a>11.1 建立 ldap 管理&#x2F;只读帐号</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: cn&#x3D;admin,dc&#x3D;xxx,dc&#x3D;xx \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi  \n  \n-  \ndn: cn&#x3D;reader,dc&#x3D;xxx2,dc&#x3D;xx2  \nchangetype: add  \nobjectClass: simpleSecurityObject  \nobjectClass: organizationalRole  \ncn: admin  \nuserPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"11-2-详细的公司架构-ldif\"><a href=\"#11-2-详细的公司架构-ldif\" class=\"headerlink\" title=\"11.2 详细的公司架构 ldif\"></a>11.2 详细的公司架构 ldif</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example  \n  \ndn: ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-bod  \n  \ndn: cn&#x3D;user1,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user1  \ndepartmentnumber: 1  \ndisplayname: Zheng Yu  \nmail: user1@example.net  \nobjectclass: inetOrgPerson  \nsn: Zheng  \ntitle: President  \nuid: 10000  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-bod-admin  \nmember: cn&#x3D;user1,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-bus  \n  \ndn: cn&#x3D;user8,ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user8  \ndepartmentnumber: 2  \ndisplayname: Sun Minghong  \nmail: user8@example.net  \nobjectclass: inetOrgPerson  \nsn: Sun  \ntitle: Financial Manager  \nuid: 10001  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-bus-admin,ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-bus-admin  \nmember: cn&#x3D;user8,ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-sys  \n  \ndn: cn&#x3D;user2,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user2  \ndepartmentnumber: 3  \ndisplayname: Xie Jian  \nmail: user2@example.net  \nobjectclass: inetOrgPerson  \nsn: Xie  \ntitle: Senior Systems Engineer  \nuid: 10002  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-sys-admin  \nmember: cn&#x3D;user2,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: cn&#x3D;user5,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user5  \ndepartmentnumber: 3  \ndisplayname: Long Chao  \nmail: user5@example.net  \nobjectclass: inetOrgPerson  \nsn: Long  \ntitle: System Engineer  \nuid: 10003  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-sys-junior,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-sys-junior  \nmember: cn&#x3D;user5,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-ops  \n  \ndn: cn&#x3D;user6.tang,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user6.tang  \ndepartmentnumber: 4  \ndisplayname: Tang Binchao  \nmail: user6.tang@example.net  \nobjectclass: inetOrgPerson  \nsn: Tang  \ntitle: System Engineer  \nuid: 10004  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-ops-admin  \nmember: cn&#x3D;user6.tang,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-dev  \n  \ndn: cn&#x3D;user3,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user3  \ndepartmentnumber: 5  \ndisplayname: Chen Cheng  \nmail: user3@example.net  \nobjectclass: inetOrgPerson  \nsn: Chen  \ntitle: Senior Development Engineer  \nuid: 10005  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;example-dev-admin,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-dev-admin  \nmember: cn&#x3D;user3,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: cn&#x3D;user4.li,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user4.li  \ndepartmentnumber: 5  \ndisplayname: Li user4  \nmail: user4.li@example.net  \nobjectclass: inetOrgPerson  \nsn: Li  \ntitle: Development Engineer  \nuid: 10006  \nuserpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  \n  \ndn: cn&#x3D;user7,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: user7  \ndepartmentnumber: 5  \ndisplayname: Luo Xujun  \nmail: user7@example.net  \nobjectclass: inetOrgPerson  \nsn: Luo  \ntitle: Development Engineer  \nuid: 10007  \nuserpassword: &#123;SSHA&#125;&#x2F;2+Coei5Fje+th7mOJgu43Ms3hBia2Qu  \n  \ndn: cn&#x3D;example-dev-senior,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \ncn: example-dev-senior  \nmember: cn&#x3D;user4.li,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nmember: cn&#x3D;user7,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: groupOfNames  \n  \ndn: ou&#x3D;example-rob,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  \nobjectclass: organizationalUnit  \nou: example-rob<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"11-3-第一版-ACL\"><a href=\"#11-3-第一版-ACL\" class=\"headerlink\" title=\"11.3 第一版 ACL\"></a>11.3 第一版 ACL</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;ou&#x3D;example,dc&#x3D;example,dc&#x3D;net&quot; filter&#x3D;&quot;(&amp;(objectClass&#x3D;inetOrgPerson)(|(memberOf&#x3D;cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)))&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read\n\ndn: olcDatabase&#x3D;&#123;4&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write  by anonymous auth  by * none\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;ibexample,dc&#x3D;com&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"11-4-最终的acl（写两个域、读两个域、reader-example-可以读取某些admin组，实现映射到example域下集成的应用）\"><a href=\"#11-4-最终的acl（写两个域、读两个域、reader-example-可以读取某些admin组，实现映射到example域下集成的应用）\" class=\"headerlink\" title=\"11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）\"></a>11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）</h3><ul>\n<li><p>添加</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;example,dc&#x3D;net&quot; read\nolcAccess: &#123;3&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; filter&#x3D;&quot;(&amp;(objectClass&#x3D;inetOrgPerson)(|(memberOf&#x3D;cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)))&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read\n \ndn: olcDatabase&#x3D;&#123;2&#125;mdb,cn&#x3D;config\nchangetype: modify\nadd: olcAccess\nolcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write  by anonymous auth  by * none\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;ibexample,dc&#x3D;com&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;example,dc&#x3D;net&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>删除</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config\ndelete: olcAccess\nolcAccess: &#123;2&#125;to..........\nolcAccess: &#123;3&#125;to........\n \n\nldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f acl-dele.ldif<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>数据库内 ACL 顺序测试，{}里面是优先级，生效在前（涉及范围大的 ACL 应书写在前）</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by anonymous auth  by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write  by * none   \nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,dc&#x3D;example,dc&#x3D;tech&quot; by dn.base&#x3D;&quot;cn&#x3D;reader,dc&#x3D;example,dc&#x3D;net&quot; read by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write    # 如果没有此条acl,该条目将不能在 lam 中被 admin 管理\n olcAccess: &#123;3&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;tech&quot; by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write      # 此条优先级最低<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"十二、集成其他应用\"><a href=\"#十二、集成其他应用\" class=\"headerlink\" title=\"十二、集成其他应用\"></a>十二、集成其他应用</h2><h3 id=\"12-1-conflunce\"><a href=\"#12-1-conflunce\" class=\"headerlink\" title=\"12.1  conflunce\"></a>12.1  conflunce</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by anonymous auth by * none\nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; by dn.base&#x3D;&quot;cn&#x3D;reader,dc&#x3D;ibexample,dc&#x3D;com&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"12-1-1-连接-之后的-acl-过滤案例\"><a href=\"#12-1-1-连接-之后的-acl-过滤案例\" class=\"headerlink\" title=\"12.1.1 连接 之后的 acl 过滤案例\"></a>12.1.1 连接 之后的 acl 过滤案例</h4><p>‘(&amp;(objectclass&#x3D;inetorgperson)(|(cn&#x3D;user5)(cn&#x3D;user2)))’  过滤出指定用户—-在用户模式设置。</p>\n<p>‘(&amp;(objectclass&#x3D;groupOfNames)(|(cn&#x3D;example-sys-junior)(cn&#x3D;example-sys-admin)))’ 过滤指定组—-在组模式设置（在ldap中创建的组 objectclass 是groupOfNames）</p>\n<h4 id=\"12-1-2-更详细的-acl-需求\"><a href=\"#12-1-2-更详细的-acl-需求\" class=\"headerlink\" title=\"12.1.2 更详细的 acl 需求\"></a>12.1.2 更详细的 acl 需求</h4><ul>\n<li><p>example</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write  by anonymous auth  by * none\nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; filter&#x3D;&quot;(&amp;(objectClass&#x3D;inetOrg\n Person)(|(memberOf&#x3D;cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net\n )(memberOf&#x3D;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(member\n Of&#x3D;cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)))&quot; by dn.base&#x3D;\n &quot;cn&#x3D;reader,dc&#x3D;ibexample,dc&#x3D;com&quot; read  by dn.base&#x3D; &quot;cn&#x3D;reader,dc&#x3D;example,dc&#x3D;net&quot; read\n\nsearch时，必须要具体到用户层级，例如nextcloud，需要指定基础用户树如下\n\ncn&#x3D;user2,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net\ncn&#x3D;user1,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net\ncn&#x3D;user6.tang,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net\ndc&#x3D;ibexample,dc&#x3D;com<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>example</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write  by anonymous auth  by * none\nolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * read\nolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;ibexample,dc&#x3D;com&quot; by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write by dn.base&#x3D;&quot;cn&#x3D;reader,dc&#x3D;ibexample,dc&#x3D;com&quot; read<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"12-2-集成-vault\"><a href=\"#12-2-集成-vault\" class=\"headerlink\" title=\"12.2 集成 vault\"></a>12.2 集成 vault</h3><ul>\n<li>过滤特定用户<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectClass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(cn&#x3D;user2)(cn&#x3D;user1)(cn&#x3D;%s)))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>过滤某个组<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectClass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>过滤多个组<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectclass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)(memberof&#x3D;CN&#x3D;example-dev-admin,OU&#x3D;example-dev,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>过滤特定用户和特定组<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectclass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(|(cn&#x3D;user4.li))(|(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)(memberof&#x3D;CN&#x3D;example-dev-admin,OU&#x3D;example-dev,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net))(cn&#x3D;%s)))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n<li>错误<pre class=\"line-numbers language-none\"><code class=\"language-none\">(&amp;(objectClass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(cn&#x3D;user2)(cn&#x3D;user1))(cn&#x3D;%s))  会失败\n\n以下 1 条，写在group filter的时候会出现不能过滤，所有人都可以登录\n(&amp;(objectclass&#x3D;inetOrgPerson)(|(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)(memberof&#x3D;CN&#x3D;example-dev-admin,OU&#x3D;example-dev,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)))<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n"},{"title":"Overleaf self hosted","date":"2024-02-22T14:10:09.000Z","summary":"Overleaf 是在线的 Latex 编辑器，官方开源了其服务。本文主要是记录基于其镜像进行本地部署并引入社区 LDAP 功能的过程。","_content":"## 1 . 部署\n```Bash TI:\"官方安装步骤\"\ngit clone https://github.com/overleaf/toolkit.git\n\ncd ./toolkit\n./bin/init #执行后有 config 文件通过模板生成\nls config\nbin/up   or  bin/start\nbin/logs web -f\nbin/shell #进入容器\n```\n>[!info]\n>- `overleaf.rc`\n>    - SHARELATEX_PORT 默认为 80 端口，但这个一般会被系统各大应用抢占，如果和你的有冲突，建议修改为 1024~65535 之间的一个数值。\n>    - 使用中主要修改了此处监听的地址和端口\n>- `variables.env` \n >   - SHARELATEX_APP_NAME 这个名字可以自定义，没什么特别的影响。\n >   - SHARELATEX_SITE_URL 这个会影响生成用户激活链接里的 URL 的域名地址，建议根据自己的实际情况修改。注意，该域名必须能够被有效解析到服务器，否则请填写 ip 地址作为替代。\n >   - SHARELATEX_NAV_TITLE 标签页里的标题，可以自定义。\n >   - SHARELATEX_HEADER_IMAGE_URL 为了和 overleaf.com 的区分，我把这个 URL 指向了我们学校的 logo\n >   - SHARELATEX_LEFT_FOOTER 显示在注册界面的提示信息，由于没有实际的注册功能，因此需要显示一段文字说明管理员的联系方式，就是这个字段的配置内容。\n## 2. 定制\n   ### 2.1 增加宏和字体\n   宏包数量 4522,耗费时间较长；并增加部分 GB 汉字，来源于网络\n```Dockerfile TI:\"Dockerfile\"\nFROM sharelatex/sharelatex:4.2.3\n\nRUN tlmgr update --self --all && \\\n    tlmgr install scheme-full\n\nCOPY chinese.gz /opt/\n\nRUN apt-get update && \\\n    apt-get install -y inkscape python3-pygments xfonts-wqy && \\\n    tar -xvf /opt/chinese.gz -C /usr/share/fonts/  && \\\n    cd /usr/share/fonts/chinese/ && mkfontscale && mkfontdir && \\\n    fc-cache -fv && fc-list :lang=zh-cn\n```\n   ### 2.2 解决 LDAP 集成\n直接使用作者此 [项目](https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap/-/tree/main/)的 Dockerfile，此 [方案](https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support)书写细致有效!\n```Dockerfile\nARG BASE=sharelatex/sharelatex:4.2.3 #基础镜像\nARG TEXLIVE_IMAGE=registry.gitlab.com/islandoftex/images/texlive:latest #为了方便安装完整版TEXLive，直接拉一个完整版的texlive下来，最后替换掉镜像里现有的\n\nFROM $TEXLIVE_IMAGE as texlive\n\nFROM $BASE as app\n\n# passed from .env (via make)\n# ARG collab_text\n# ARG login_text\nARG admin_is_sysadmin #是否需要把LDAP的管理员也当做overleaf的管理员，见environment文件\n\n# set workdir (might solve issue #2 - see https://stackoverflow.com/questions/57534295/)\nWORKDIR /overleaf\n\n#add mirrors，我司网络环境下已注释\n#RUN sed -i s@/archive.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list\n#RUN sed -i s@/security.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list\n#RUN npm config set registry https://registry.npmmirror.com\n\n# add oauth router to router.js\n#head -n -1 router.js > temp.txt ; mv temp.txt router.js\n#原作者保留写法，替换如下--RUN git clone https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2.git /src\nCOPY environment  /src/\nCOPY ldap-overleaf-sl /src/ldap-overleaf-sl\nRUN cat /src/ldap-overleaf-sl/sharelatex/router-append.js\n\n#RUN head -n -2 /overleaf/services/web/app/src/router.js > temp.txt ; mv temp.txt /overleaf/services/web/app/src/router.js\n#基于4.2.3镜像的修改\nRUN head -n -4 /overleaf/services/web/app/src/router.js > temp.txt ; mv temp.txt /overleaf/services/web/app/src/router.js\nRUN cat /src/ldap-overleaf-sl/sharelatex/router-append.js >> /overleaf/services/web/app/src/router.js\n\n# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完\nRUN node genScript compile | bash\n\n\n# 装了依赖之后打包会失败，参考 https://github.com/overleaf/overleaf/issues/1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。\n# install package could result to the error of webpack-cli\nRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape\n\n# install pygments and some fonts dependencies\n# 安装用于minted等代码高亮包的python3-pygments，以及一些字体\nRUN apt-get update && apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome\n\n# overwrite some files (enable ldap and oauth)\n# 替换文件\nRUN cp /src/ldap-overleaf-sl/sharelatex/AuthenticationManager.js /overleaf/services/web/app/src/Features/Authentication/\nRUN cp /src/ldap-overleaf-sl/sharelatex/AuthenticationController.js /overleaf/services/web/app/src/Features/Authentication/\nRUN cp /src/ldap-overleaf-sl/sharelatex/ContactController.js /overleaf/services/web/app/src/Features/Contacts/\n\n# instead of copying the login.pug just edit it inline (line 19, 22-25)\n# delete 3 lines after email place-holder to enable non-email login for that form.\n#RUN sed -iE '/type=.*email.*/d' /overleaf/services/web/app/views/user/login.pug\n#RUN sed -iE '/email@example.com/{n;N;N;d}' /overleaf/services/web/app/views/user/login.pug\n#RUN sed -iE \"s/email@example.com/${login_text:-user}/g\" /overleaf/services/web/app/views/user/login.pug\n\n# RUN sed -iE '/type=.*email.*/d' /overleaf/services/web/app/views/user/login.pug\n# RUN sed -iE '/email@example.com/{n;N;N;d}' /overleaf/services/web/app/views/user/login.pug # comment out this line to prevent sed accidently remove the brackets of the email(username) field\n# RUN sed -iE \"s/email@example.com/${login_text:-user}/g\" /overleaf/services/web/app/views/user/login.pug\n\n# Collaboration settings display (share project placeholder) | edit line 146\n# Obsolete with Overleaf 3.0\n# RUN sed -iE \"s%placeholder=.*$%placeholder=\\\"${collab_text}\\\"%g\" /overleaf/services/web/app/views/project/editor/share.pug\n\n# extend pdflatex with option shell-esacpe ( fix for closed overleaf/overleaf/issues/217 and overleaf/docker-image/issues/45 )\n# 允许shell-esacpe（跟minted包有关）\nRUN sed -iE \"s%-synctex=1\\\",%-synctex=1\\\", \\\"-shell-escape\\\",%g\" /overleaf/services/clsi/app/js/LatexRunner.js\nRUN sed -iE \"s%'-synctex=1',%'-synctex=1', '-shell-escape',%g\" /overleaf/services/clsi/app/js/LatexRunner.js\n\n# Too much changes to do inline (>10 Lines).\n# 继续替换文件\nRUN cp /src/ldap-overleaf-sl/sharelatex/settings.pug /overleaf/services/web/app/views/user/\nRUN cp /src/ldap-overleaf-sl/sharelatex/navbar.pug /overleaf/services/web/app/views/layout/\n\n# new login menu\n# 替换登录界面（可自行修改登录界面里的文字）\nRUN cp /src/ldap-overleaf-sl/sharelatex/login.pug /overleaf/services/web/app/views/user/\n\n# Non LDAP User Registration for Admins\n# 继续替换文件\nRUN cp /src/ldap-overleaf-sl/sharelatex/admin-index.pug \t/overleaf/services/web/app/views/admin/index.pug\nRUN cp /src/ldap-overleaf-sl/sharelatex/admin-sysadmin.pug \t/tmp/admin-sysadmin.pug\nRUN if [ \"${admin_is_sysadmin}\" = \"true\" ] ; then cp /tmp/admin-sysadmin.pug   /overleaf/services/web/app/views/admin/index.pug ; else rm /tmp/admin-sysadmin.pug ; fi\n\nRUN rm /overleaf/services/web/modules/user-activate/app/views/user/register.pug\n\n#RUN rm /overleaf/services/web/app/views/admin/register.pug\n\n### To remove comments entirly (bug https://github.com/overleaf/overleaf/issues/678)\nRUN rm /overleaf/services/web/app/views/project/editor/review-panel.pug\nRUN touch /overleaf/services/web/app/views/project/editor/review-panel.pug\n\n# Update TeXLive\n# 替换为完整版的TEXLive\nCOPY --from=texlive /usr/local/texlive /usr/local/texlive\nRUN tlmgr path add\n# Evil hack for hardcoded texlive 2021 path\n# RUN rm -r /usr/local/texlive/2021 && ln -s /usr/local/texlive/2022 /usr/local/texlive/2021\n```\n## 3. 完整结构\n```\n.\n├── chinese.gz\n├── Dockerfile\n├── environment\n└── sharelatex\n    ├── admin-index.pug\n    ├── admin-sysadmin.pug\n    ├── AuthenticationController.js\n    ├── AuthenticationManager.js\n    ├── ContactController.js\n    ├── login.pug\n    ├── navbar.pug\n    ├── router-append.js\n    └── settings.pug\n```\n\n```Dockerfile TI:\"Dockerfile\"\nFROM sharelatex/sharelatex:4.2.3\n\n#是否需要把LDAP的管理员也当做overleaf的管理员\nARG admin_is_sysadmin\n\n# set workdir (might solve issue #2 - see https://stackoverflow.com/questions/57534295/)\nWORKDIR /overleaf\n\n# add oauth router to router.js\nCOPY environment chinese.gz  /src/\nCOPY sharelatex /src/sharelatex\nRUN cat /src/sharelatex/router-append.js\n\nRUN head -n -4 /overleaf/services/web/app/src/router.js > temp.txt ; mv temp.txt /overleaf/services/web/app/src/router.js\nRUN cat /src/sharelatex/router-append.js >> /overleaf/services/web/app/src/router.js\n\n# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完\nRUN node genScript compile | bash\n\n# 装了依赖之后打包会失败，参考 https://github.com/overleaf/overleaf/issues/1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。\n# install package could result to the error of webpack-cli\nRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape logger-sharelatex\n\n# install pygments and some fonts dependencies\n# 安装用于minted等代码高亮包的python3-pygments，以及一些字体\nRUN apt-get update && apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome inkscape ttf-mscorefonts-installer\n\n# overwrite some files (enable ldap and oauth)\n# 替换文件\nRUN cp /src/sharelatex/AuthenticationManager.js /overleaf/services/web/app/src/Features/Authentication/\nRUN cp /src/sharelatex/AuthenticationController.js /overleaf/services/web/app/src/Features/Authentication/\nRUN cp /src/sharelatex/ContactController.js /overleaf/services/web/app/src/Features/Contacts/\n\n# extend pdflatex with option shell-esacpe ( fix for closed overleaf/overleaf/issues/217 and overleaf/docker-image/issues/45 )\n# 允许shell-esacpe（跟minted包有关）\nRUN sed -iE \"s%-synctex=1\\\",%-synctex=1\\\", \\\"-shell-escape\\\",%g\" /overleaf/services/clsi/app/js/LatexRunner.js\nRUN sed -iE \"s%'-synctex=1',%'-synctex=1', '-shell-escape',%g\" /overleaf/services/clsi/app/js/LatexRunner.js\n\n# Too much changes to do inline (>10 Lines).\n# 继续替换文件\nRUN cp /src/sharelatex/settings.pug /overleaf/services/web/app/views/user/\nRUN cp /src/sharelatex/navbar.pug /overleaf/services/web/app/views/layout/\n\n# new login menu\n# 替换登录界面（可自行修改登录界面里的文字）\nRUN cp /src/sharelatex/login.pug /overleaf/services/web/app/views/user/\n\n# Non LDAP User Registration for Admins\n# 继续替换文件\nRUN cp /src/sharelatex/admin-index.pug \t/overleaf/services/web/app/views/admin/index.pug\nRUN cp /src/sharelatex/admin-sysadmin.pug \t/tmp/admin-sysadmin.pug\nRUN if [ \"${admin_is_sysadmin}\" = \"true\" ] ; then cp /tmp/admin-sysadmin.pug   /overleaf/services/web/app/views/admin/index.pug ; else rm /tmp/admin-sysadmin.pug ; fi\n\nRUN rm /overleaf/services/web/modules/user-activate/app/views/user/register.pug\n\n#RUN rm /overleaf/services/web/app/views/admin/register.pug\n\n### To remove comments entirly (bug https://github.com/overleaf/overleaf/issues/678)\nRUN rm /overleaf/services/web/app/views/project/editor/review-panel.pug\nRUN touch /overleaf/services/web/app/views/project/editor/review-panel.pug\n\n# 处理完整宏包和部分字体\nRUN tlmgr update --self --all && \\\n    tlmgr install scheme-full\n\nRUN tar -xvf /src/chinese.gz -C /usr/share/fonts/  && \\\n    cd /usr/share/fonts/chinese/ && mkfontscale && mkfontdir && \\\n    fc-cache -fv && fc-list :lang=zh-cn\n```\n## 4. Debug\n### 4.1\n```ini TI:\"Bug1\"\nSyntaxError: Unexpected token '}'\n    at internalCompileFunction (node:internal/vm:73:18)\n    at wrapSafe (node:internal/modules/cjs/loader:1274:20)\n    at Module._compile (node:internal/modules/cjs/loader:1320:27)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.<anonymous> (/overleaf/services/web/app/src/infrastructure/Server.js:8:16)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n\nNode.js v18.19.1\nInitializing metrics\nSet UV_THREADPOOL_SIZE=16\nUsing default settings from /overleaf/services/web/config/settings.defaults.js\nUsing settings from /etc/sharelatex/settings.js\n/overleaf/services/web/app/src/router.js:1351\n}\n```\n>[!Done]\n>对比成功案例，发现 4.2.3 镜像中 `/overleaf/services/web/app/src/router.js:1351` 文件的代码存在一行更多的代码，尝试修改项目中有关的替换源文件 `ldap-overleaf-sl/sharelatex/router-append.js ` 和 dockerfile（替换文件时删除 4行再追加）\n\n项目源文件的修改 `ldap-overleaf-sl/sharelatex/router-append.js `\n```ini\n  webRouter.get('/oauth/redirect', AuthenticationController.oauth2Redirect)\n  webRouter.get('/oauth/callback', AuthenticationController.oauth2Callback)\n  AuthenticationController.addEndpointToLoginWhitelist('/oauth/redirect')\n  AuthenticationController.addEndpointToLoginWhitelist('/oauth/callback')\n  webRouter.get('*', ErrorController.notFound)\n}\n\nmodule.exports = { initialize, rateLimiters }  # 在原作者使用的文件中没有此行代码，这是官方 sharelatex:4.2.3 相比于 sharelatex:3.1 多出的代码\n```\n### 4.2\n```ini TI:\"Bug2\"\nError: Cannot find module 'logger-sharelatex'\nRequire stack:\n- /overleaf/services/web/app/src/Features/Contacts/ContactController.js\n- /overleaf/services/web/app/src/Features/Contacts/ContactRouter.js\n- /overleaf/services/web/app/src/router.js\n- /overleaf/services/web/app/src/infrastructure/Server.js\n- /overleaf/services/web/app.js\n    at Module._resolveFilename (node:internal/modules/cjs/loader:1134:15)\n    at Module._load (node:internal/modules/cjs/loader:975:27)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.<anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactController.js:20:16)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.<anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js:3:27)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12) {\n  code: 'MODULE_NOT_FOUND',\n  requireStack: [\n    '/overleaf/services/web/app/src/Features/Contacts/ContactController.js',\n    '/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js',\n    '/overleaf/services/web/app/src/router.js',\n    '/overleaf/services/web/app/src/infrastructure/Server.js',\n    '/overleaf/services/web/app.js'\n  ]\n}\n\nNode.js v18.19.1\nInitializing metrics\nSet UV_THREADPOOL_SIZE=16\nUsing default settings from /overleaf/services/web/config/settings.defaults.js\nUsing settings from /etc/sharelatex/settings.js\n{\"name\":\"web\",\"hostname\":\"b320a99b987b\",\"pid\":2731,\"level\":40,\"msg\":\"Email transport and/or parameters not defined. No emails will be sent.\",\"time\":\"2024-02-22T03:02:29.679Z\",\"v\":0}\nnode:internal/modules/cjs/loader:1137\n  throw err;\n```\n>[!Done]\n>执行 `npm install logger-sharelatex`\n\n ## 5. 测试使用\n### 5.1 部署前集成 LDAP\n在 toolkit 中添加有关变量即可，配置在此文件中即可 ``\n```yaml\n---\nversion: '3'\nservices:\n\n    sharelatex:\n        restart: always\n          #image: \"${IMAGE}\"  # 官方写法，变量定义方式在此`bin/docker-compose`，$IMAGE_VERSION没有找到地方定义\n        image: overleaf4.2.3-ldap:v2  #采取比较粗暴的替换\n        container_name: sharelatex\n        volumes:\n            - \"${SHARELATEX_DATA_PATH}:/var/lib/sharelatex\"\n        ports:\n            - \"${SHARELATEX_LISTEN_IP:-127.0.0.1}:${SHARELATEX_PORT:-80}:80\"\n        environment:\n          GIT_BRIDGE_ENABLED: \"${GIT_BRIDGE_ENABLED}\"\n          GIT_BRIDGE_HOST: \"git-bridge\"\n          GIT_BRIDGE_PORT: \"8000\"\n          REDIS_HOST: \"${REDIS_HOST}\"\n          REDIS_PORT: \"${REDIS_PORT}\"\n          SHARELATEX_MONGO_URL: \"${MONGO_URL}\"\n          SHARELATEX_REDIS_HOST: \"${REDIS_HOST}\"\n          V1_HISTORY_URL: \"http://sharelatex:3100/api\"\n          # LDAP Block\n          LDAP_SERVER: \"ldap://10.8.0.88\"\n          LDAP_BASE: \"ou=company,dc=company,dc=net\"\n          LDAP_BIND_USER: \"cn=companyadmin,dc=company,dc=net\"\n          LDAP_BIND_PW: \"company@2020\"\n          ALLOW_EMAIL_LOGIN: 'true'\n          LDAP_CONTACTS: 'true'\n          LDAP_CONTACT_FILTER: \"(objectClass=inetOrgPerson)\"\n          LDAP_USER_FILTER: \"(mail=%m)\"\n          # LDAP Block\n        env_file:\n            - ../config/variables.env\n        stop_grace_period: 60s\n```\n### 5.2 \n登录 http://site/launchpad ，需要创建本地的 admin 用户\\\n如果构建时， environment 中的 `ADMIN_IS_SYSADMIN=true` 也支持使用 LDAP 的 admin 作为管理员用户通过邮箱登录。\\\n`套用模板的过程出现较多的不能成功渲染，注意在左上角 菜单中选择适宜的编译器`\n   >[!info]\n   魔改原作者的登录界面中有关于其学校的信息，修改 `ldap-overleaf-sl/sharelatex/login.pug ` ，删除 `SUSTech CRA`\n   overleaf 官方的某些界面信息可以在 toolkit/variables.env 修改 \n   \n   ## 6. 参考\n1. [部署后宏包的安装实现开箱即用](https://blog.wsine.top/posts/selfhost-overleaf-for-thesis/) 从中考虑 Dockerfile 的编写\n2. [在官方部署方式上重新 commit 镜像](https://blog.ftliang.com/2021/08/19/overleaf.html)\n3. [LDAP认证](https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/)\n4. [基于 sharelatex 准备中文和 texlive 的 Dockerfile](https://lisz.me/tech/docker/sharelatex.html)\n\n","source":"_posts/Overleaf-self-hosted.md","raw":"---\ntitle: Overleaf self hosted\ndate: 2024-02-22 22:10:09\ntags:\n  - Overleaf\n  - Docker\nsummary: Overleaf 是在线的 Latex 编辑器，官方开源了其服务。本文主要是记录基于其镜像进行本地部署并引入社区 LDAP 功能的过程。\n---\n## 1 . 部署\n```Bash TI:\"官方安装步骤\"\ngit clone https://github.com/overleaf/toolkit.git\n\ncd ./toolkit\n./bin/init #执行后有 config 文件通过模板生成\nls config\nbin/up   or  bin/start\nbin/logs web -f\nbin/shell #进入容器\n```\n>[!info]\n>- `overleaf.rc`\n>    - SHARELATEX_PORT 默认为 80 端口，但这个一般会被系统各大应用抢占，如果和你的有冲突，建议修改为 1024~65535 之间的一个数值。\n>    - 使用中主要修改了此处监听的地址和端口\n>- `variables.env` \n >   - SHARELATEX_APP_NAME 这个名字可以自定义，没什么特别的影响。\n >   - SHARELATEX_SITE_URL 这个会影响生成用户激活链接里的 URL 的域名地址，建议根据自己的实际情况修改。注意，该域名必须能够被有效解析到服务器，否则请填写 ip 地址作为替代。\n >   - SHARELATEX_NAV_TITLE 标签页里的标题，可以自定义。\n >   - SHARELATEX_HEADER_IMAGE_URL 为了和 overleaf.com 的区分，我把这个 URL 指向了我们学校的 logo\n >   - SHARELATEX_LEFT_FOOTER 显示在注册界面的提示信息，由于没有实际的注册功能，因此需要显示一段文字说明管理员的联系方式，就是这个字段的配置内容。\n## 2. 定制\n   ### 2.1 增加宏和字体\n   宏包数量 4522,耗费时间较长；并增加部分 GB 汉字，来源于网络\n```Dockerfile TI:\"Dockerfile\"\nFROM sharelatex/sharelatex:4.2.3\n\nRUN tlmgr update --self --all && \\\n    tlmgr install scheme-full\n\nCOPY chinese.gz /opt/\n\nRUN apt-get update && \\\n    apt-get install -y inkscape python3-pygments xfonts-wqy && \\\n    tar -xvf /opt/chinese.gz -C /usr/share/fonts/  && \\\n    cd /usr/share/fonts/chinese/ && mkfontscale && mkfontdir && \\\n    fc-cache -fv && fc-list :lang=zh-cn\n```\n   ### 2.2 解决 LDAP 集成\n直接使用作者此 [项目](https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap/-/tree/main/)的 Dockerfile，此 [方案](https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support)书写细致有效!\n```Dockerfile\nARG BASE=sharelatex/sharelatex:4.2.3 #基础镜像\nARG TEXLIVE_IMAGE=registry.gitlab.com/islandoftex/images/texlive:latest #为了方便安装完整版TEXLive，直接拉一个完整版的texlive下来，最后替换掉镜像里现有的\n\nFROM $TEXLIVE_IMAGE as texlive\n\nFROM $BASE as app\n\n# passed from .env (via make)\n# ARG collab_text\n# ARG login_text\nARG admin_is_sysadmin #是否需要把LDAP的管理员也当做overleaf的管理员，见environment文件\n\n# set workdir (might solve issue #2 - see https://stackoverflow.com/questions/57534295/)\nWORKDIR /overleaf\n\n#add mirrors，我司网络环境下已注释\n#RUN sed -i s@/archive.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list\n#RUN sed -i s@/security.ubuntu.com/@/mirrors.sustech.edu.cn/@g /etc/apt/sources.list\n#RUN npm config set registry https://registry.npmmirror.com\n\n# add oauth router to router.js\n#head -n -1 router.js > temp.txt ; mv temp.txt router.js\n#原作者保留写法，替换如下--RUN git clone https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap-oauth2.git /src\nCOPY environment  /src/\nCOPY ldap-overleaf-sl /src/ldap-overleaf-sl\nRUN cat /src/ldap-overleaf-sl/sharelatex/router-append.js\n\n#RUN head -n -2 /overleaf/services/web/app/src/router.js > temp.txt ; mv temp.txt /overleaf/services/web/app/src/router.js\n#基于4.2.3镜像的修改\nRUN head -n -4 /overleaf/services/web/app/src/router.js > temp.txt ; mv temp.txt /overleaf/services/web/app/src/router.js\nRUN cat /src/ldap-overleaf-sl/sharelatex/router-append.js >> /overleaf/services/web/app/src/router.js\n\n# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完\nRUN node genScript compile | bash\n\n\n# 装了依赖之后打包会失败，参考 https://github.com/overleaf/overleaf/issues/1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。\n# install package could result to the error of webpack-cli\nRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape\n\n# install pygments and some fonts dependencies\n# 安装用于minted等代码高亮包的python3-pygments，以及一些字体\nRUN apt-get update && apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome\n\n# overwrite some files (enable ldap and oauth)\n# 替换文件\nRUN cp /src/ldap-overleaf-sl/sharelatex/AuthenticationManager.js /overleaf/services/web/app/src/Features/Authentication/\nRUN cp /src/ldap-overleaf-sl/sharelatex/AuthenticationController.js /overleaf/services/web/app/src/Features/Authentication/\nRUN cp /src/ldap-overleaf-sl/sharelatex/ContactController.js /overleaf/services/web/app/src/Features/Contacts/\n\n# instead of copying the login.pug just edit it inline (line 19, 22-25)\n# delete 3 lines after email place-holder to enable non-email login for that form.\n#RUN sed -iE '/type=.*email.*/d' /overleaf/services/web/app/views/user/login.pug\n#RUN sed -iE '/email@example.com/{n;N;N;d}' /overleaf/services/web/app/views/user/login.pug\n#RUN sed -iE \"s/email@example.com/${login_text:-user}/g\" /overleaf/services/web/app/views/user/login.pug\n\n# RUN sed -iE '/type=.*email.*/d' /overleaf/services/web/app/views/user/login.pug\n# RUN sed -iE '/email@example.com/{n;N;N;d}' /overleaf/services/web/app/views/user/login.pug # comment out this line to prevent sed accidently remove the brackets of the email(username) field\n# RUN sed -iE \"s/email@example.com/${login_text:-user}/g\" /overleaf/services/web/app/views/user/login.pug\n\n# Collaboration settings display (share project placeholder) | edit line 146\n# Obsolete with Overleaf 3.0\n# RUN sed -iE \"s%placeholder=.*$%placeholder=\\\"${collab_text}\\\"%g\" /overleaf/services/web/app/views/project/editor/share.pug\n\n# extend pdflatex with option shell-esacpe ( fix for closed overleaf/overleaf/issues/217 and overleaf/docker-image/issues/45 )\n# 允许shell-esacpe（跟minted包有关）\nRUN sed -iE \"s%-synctex=1\\\",%-synctex=1\\\", \\\"-shell-escape\\\",%g\" /overleaf/services/clsi/app/js/LatexRunner.js\nRUN sed -iE \"s%'-synctex=1',%'-synctex=1', '-shell-escape',%g\" /overleaf/services/clsi/app/js/LatexRunner.js\n\n# Too much changes to do inline (>10 Lines).\n# 继续替换文件\nRUN cp /src/ldap-overleaf-sl/sharelatex/settings.pug /overleaf/services/web/app/views/user/\nRUN cp /src/ldap-overleaf-sl/sharelatex/navbar.pug /overleaf/services/web/app/views/layout/\n\n# new login menu\n# 替换登录界面（可自行修改登录界面里的文字）\nRUN cp /src/ldap-overleaf-sl/sharelatex/login.pug /overleaf/services/web/app/views/user/\n\n# Non LDAP User Registration for Admins\n# 继续替换文件\nRUN cp /src/ldap-overleaf-sl/sharelatex/admin-index.pug \t/overleaf/services/web/app/views/admin/index.pug\nRUN cp /src/ldap-overleaf-sl/sharelatex/admin-sysadmin.pug \t/tmp/admin-sysadmin.pug\nRUN if [ \"${admin_is_sysadmin}\" = \"true\" ] ; then cp /tmp/admin-sysadmin.pug   /overleaf/services/web/app/views/admin/index.pug ; else rm /tmp/admin-sysadmin.pug ; fi\n\nRUN rm /overleaf/services/web/modules/user-activate/app/views/user/register.pug\n\n#RUN rm /overleaf/services/web/app/views/admin/register.pug\n\n### To remove comments entirly (bug https://github.com/overleaf/overleaf/issues/678)\nRUN rm /overleaf/services/web/app/views/project/editor/review-panel.pug\nRUN touch /overleaf/services/web/app/views/project/editor/review-panel.pug\n\n# Update TeXLive\n# 替换为完整版的TEXLive\nCOPY --from=texlive /usr/local/texlive /usr/local/texlive\nRUN tlmgr path add\n# Evil hack for hardcoded texlive 2021 path\n# RUN rm -r /usr/local/texlive/2021 && ln -s /usr/local/texlive/2022 /usr/local/texlive/2021\n```\n## 3. 完整结构\n```\n.\n├── chinese.gz\n├── Dockerfile\n├── environment\n└── sharelatex\n    ├── admin-index.pug\n    ├── admin-sysadmin.pug\n    ├── AuthenticationController.js\n    ├── AuthenticationManager.js\n    ├── ContactController.js\n    ├── login.pug\n    ├── navbar.pug\n    ├── router-append.js\n    └── settings.pug\n```\n\n```Dockerfile TI:\"Dockerfile\"\nFROM sharelatex/sharelatex:4.2.3\n\n#是否需要把LDAP的管理员也当做overleaf的管理员\nARG admin_is_sysadmin\n\n# set workdir (might solve issue #2 - see https://stackoverflow.com/questions/57534295/)\nWORKDIR /overleaf\n\n# add oauth router to router.js\nCOPY environment chinese.gz  /src/\nCOPY sharelatex /src/sharelatex\nRUN cat /src/sharelatex/router-append.js\n\nRUN head -n -4 /overleaf/services/web/app/src/router.js > temp.txt ; mv temp.txt /overleaf/services/web/app/src/router.js\nRUN cat /src/sharelatex/router-append.js >> /overleaf/services/web/app/src/router.js\n\n# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完\nRUN node genScript compile | bash\n\n# 装了依赖之后打包会失败，参考 https://github.com/overleaf/overleaf/issues/1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。\n# install package could result to the error of webpack-cli\nRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape logger-sharelatex\n\n# install pygments and some fonts dependencies\n# 安装用于minted等代码高亮包的python3-pygments，以及一些字体\nRUN apt-get update && apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome inkscape ttf-mscorefonts-installer\n\n# overwrite some files (enable ldap and oauth)\n# 替换文件\nRUN cp /src/sharelatex/AuthenticationManager.js /overleaf/services/web/app/src/Features/Authentication/\nRUN cp /src/sharelatex/AuthenticationController.js /overleaf/services/web/app/src/Features/Authentication/\nRUN cp /src/sharelatex/ContactController.js /overleaf/services/web/app/src/Features/Contacts/\n\n# extend pdflatex with option shell-esacpe ( fix for closed overleaf/overleaf/issues/217 and overleaf/docker-image/issues/45 )\n# 允许shell-esacpe（跟minted包有关）\nRUN sed -iE \"s%-synctex=1\\\",%-synctex=1\\\", \\\"-shell-escape\\\",%g\" /overleaf/services/clsi/app/js/LatexRunner.js\nRUN sed -iE \"s%'-synctex=1',%'-synctex=1', '-shell-escape',%g\" /overleaf/services/clsi/app/js/LatexRunner.js\n\n# Too much changes to do inline (>10 Lines).\n# 继续替换文件\nRUN cp /src/sharelatex/settings.pug /overleaf/services/web/app/views/user/\nRUN cp /src/sharelatex/navbar.pug /overleaf/services/web/app/views/layout/\n\n# new login menu\n# 替换登录界面（可自行修改登录界面里的文字）\nRUN cp /src/sharelatex/login.pug /overleaf/services/web/app/views/user/\n\n# Non LDAP User Registration for Admins\n# 继续替换文件\nRUN cp /src/sharelatex/admin-index.pug \t/overleaf/services/web/app/views/admin/index.pug\nRUN cp /src/sharelatex/admin-sysadmin.pug \t/tmp/admin-sysadmin.pug\nRUN if [ \"${admin_is_sysadmin}\" = \"true\" ] ; then cp /tmp/admin-sysadmin.pug   /overleaf/services/web/app/views/admin/index.pug ; else rm /tmp/admin-sysadmin.pug ; fi\n\nRUN rm /overleaf/services/web/modules/user-activate/app/views/user/register.pug\n\n#RUN rm /overleaf/services/web/app/views/admin/register.pug\n\n### To remove comments entirly (bug https://github.com/overleaf/overleaf/issues/678)\nRUN rm /overleaf/services/web/app/views/project/editor/review-panel.pug\nRUN touch /overleaf/services/web/app/views/project/editor/review-panel.pug\n\n# 处理完整宏包和部分字体\nRUN tlmgr update --self --all && \\\n    tlmgr install scheme-full\n\nRUN tar -xvf /src/chinese.gz -C /usr/share/fonts/  && \\\n    cd /usr/share/fonts/chinese/ && mkfontscale && mkfontdir && \\\n    fc-cache -fv && fc-list :lang=zh-cn\n```\n## 4. Debug\n### 4.1\n```ini TI:\"Bug1\"\nSyntaxError: Unexpected token '}'\n    at internalCompileFunction (node:internal/vm:73:18)\n    at wrapSafe (node:internal/modules/cjs/loader:1274:20)\n    at Module._compile (node:internal/modules/cjs/loader:1320:27)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.<anonymous> (/overleaf/services/web/app/src/infrastructure/Server.js:8:16)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n\nNode.js v18.19.1\nInitializing metrics\nSet UV_THREADPOOL_SIZE=16\nUsing default settings from /overleaf/services/web/config/settings.defaults.js\nUsing settings from /etc/sharelatex/settings.js\n/overleaf/services/web/app/src/router.js:1351\n}\n```\n>[!Done]\n>对比成功案例，发现 4.2.3 镜像中 `/overleaf/services/web/app/src/router.js:1351` 文件的代码存在一行更多的代码，尝试修改项目中有关的替换源文件 `ldap-overleaf-sl/sharelatex/router-append.js ` 和 dockerfile（替换文件时删除 4行再追加）\n\n项目源文件的修改 `ldap-overleaf-sl/sharelatex/router-append.js `\n```ini\n  webRouter.get('/oauth/redirect', AuthenticationController.oauth2Redirect)\n  webRouter.get('/oauth/callback', AuthenticationController.oauth2Callback)\n  AuthenticationController.addEndpointToLoginWhitelist('/oauth/redirect')\n  AuthenticationController.addEndpointToLoginWhitelist('/oauth/callback')\n  webRouter.get('*', ErrorController.notFound)\n}\n\nmodule.exports = { initialize, rateLimiters }  # 在原作者使用的文件中没有此行代码，这是官方 sharelatex:4.2.3 相比于 sharelatex:3.1 多出的代码\n```\n### 4.2\n```ini TI:\"Bug2\"\nError: Cannot find module 'logger-sharelatex'\nRequire stack:\n- /overleaf/services/web/app/src/Features/Contacts/ContactController.js\n- /overleaf/services/web/app/src/Features/Contacts/ContactRouter.js\n- /overleaf/services/web/app/src/router.js\n- /overleaf/services/web/app/src/infrastructure/Server.js\n- /overleaf/services/web/app.js\n    at Module._resolveFilename (node:internal/modules/cjs/loader:1134:15)\n    at Module._load (node:internal/modules/cjs/loader:975:27)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.<anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactController.js:20:16)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.<anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js:3:27)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12) {\n  code: 'MODULE_NOT_FOUND',\n  requireStack: [\n    '/overleaf/services/web/app/src/Features/Contacts/ContactController.js',\n    '/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js',\n    '/overleaf/services/web/app/src/router.js',\n    '/overleaf/services/web/app/src/infrastructure/Server.js',\n    '/overleaf/services/web/app.js'\n  ]\n}\n\nNode.js v18.19.1\nInitializing metrics\nSet UV_THREADPOOL_SIZE=16\nUsing default settings from /overleaf/services/web/config/settings.defaults.js\nUsing settings from /etc/sharelatex/settings.js\n{\"name\":\"web\",\"hostname\":\"b320a99b987b\",\"pid\":2731,\"level\":40,\"msg\":\"Email transport and/or parameters not defined. No emails will be sent.\",\"time\":\"2024-02-22T03:02:29.679Z\",\"v\":0}\nnode:internal/modules/cjs/loader:1137\n  throw err;\n```\n>[!Done]\n>执行 `npm install logger-sharelatex`\n\n ## 5. 测试使用\n### 5.1 部署前集成 LDAP\n在 toolkit 中添加有关变量即可，配置在此文件中即可 ``\n```yaml\n---\nversion: '3'\nservices:\n\n    sharelatex:\n        restart: always\n          #image: \"${IMAGE}\"  # 官方写法，变量定义方式在此`bin/docker-compose`，$IMAGE_VERSION没有找到地方定义\n        image: overleaf4.2.3-ldap:v2  #采取比较粗暴的替换\n        container_name: sharelatex\n        volumes:\n            - \"${SHARELATEX_DATA_PATH}:/var/lib/sharelatex\"\n        ports:\n            - \"${SHARELATEX_LISTEN_IP:-127.0.0.1}:${SHARELATEX_PORT:-80}:80\"\n        environment:\n          GIT_BRIDGE_ENABLED: \"${GIT_BRIDGE_ENABLED}\"\n          GIT_BRIDGE_HOST: \"git-bridge\"\n          GIT_BRIDGE_PORT: \"8000\"\n          REDIS_HOST: \"${REDIS_HOST}\"\n          REDIS_PORT: \"${REDIS_PORT}\"\n          SHARELATEX_MONGO_URL: \"${MONGO_URL}\"\n          SHARELATEX_REDIS_HOST: \"${REDIS_HOST}\"\n          V1_HISTORY_URL: \"http://sharelatex:3100/api\"\n          # LDAP Block\n          LDAP_SERVER: \"ldap://10.8.0.88\"\n          LDAP_BASE: \"ou=company,dc=company,dc=net\"\n          LDAP_BIND_USER: \"cn=companyadmin,dc=company,dc=net\"\n          LDAP_BIND_PW: \"company@2020\"\n          ALLOW_EMAIL_LOGIN: 'true'\n          LDAP_CONTACTS: 'true'\n          LDAP_CONTACT_FILTER: \"(objectClass=inetOrgPerson)\"\n          LDAP_USER_FILTER: \"(mail=%m)\"\n          # LDAP Block\n        env_file:\n            - ../config/variables.env\n        stop_grace_period: 60s\n```\n### 5.2 \n登录 http://site/launchpad ，需要创建本地的 admin 用户\\\n如果构建时， environment 中的 `ADMIN_IS_SYSADMIN=true` 也支持使用 LDAP 的 admin 作为管理员用户通过邮箱登录。\\\n`套用模板的过程出现较多的不能成功渲染，注意在左上角 菜单中选择适宜的编译器`\n   >[!info]\n   魔改原作者的登录界面中有关于其学校的信息，修改 `ldap-overleaf-sl/sharelatex/login.pug ` ，删除 `SUSTech CRA`\n   overleaf 官方的某些界面信息可以在 toolkit/variables.env 修改 \n   \n   ## 6. 参考\n1. [部署后宏包的安装实现开箱即用](https://blog.wsine.top/posts/selfhost-overleaf-for-thesis/) 从中考虑 Dockerfile 的编写\n2. [在官方部署方式上重新 commit 镜像](https://blog.ftliang.com/2021/08/19/overleaf.html)\n3. [LDAP认证](https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/)\n4. [基于 sharelatex 准备中文和 texlive 的 Dockerfile](https://lisz.me/tech/docker/sharelatex.html)\n\n","slug":"Overleaf-self-hosted","published":1,"updated":"2024-04-20T03:18:37.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodi1000g80rv7g7jh63t","content":"<h2 id=\"1-部署\"><a href=\"#1-部署\" class=\"headerlink\" title=\"1 . 部署\"></a>1 . 部署</h2><pre class=\"line-numbers language-Bash\" data-language=\"Bash\"><div class=\"caption\"><span>TI:\"官方安装步骤\"</span></div><code class=\"language-Bash\">git clone https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;toolkit.git\n\ncd .&#x2F;toolkit\n.&#x2F;bin&#x2F;init #执行后有 config 文件通过模板生成\nls config\nbin&#x2F;up   or  bin&#x2F;start\nbin&#x2F;logs web -f\nbin&#x2F;shell #进入容器<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!info]</p>\n<ul>\n<li><code>overleaf.rc</code><ul>\n<li>SHARELATEX_PORT 默认为 80 端口，但这个一般会被系统各大应用抢占，如果和你的有冲突，建议修改为 1024~65535 之间的一个数值。</li>\n<li>使用中主要修改了此处监听的地址和端口</li>\n</ul>\n</li>\n<li><code>variables.env</code> <ul>\n<li>SHARELATEX_APP_NAME 这个名字可以自定义，没什么特别的影响。</li>\n<li>SHARELATEX_SITE_URL 这个会影响生成用户激活链接里的 URL 的域名地址，建议根据自己的实际情况修改。注意，该域名必须能够被有效解析到服务器，否则请填写 ip 地址作为替代。</li>\n<li>SHARELATEX_NAV_TITLE 标签页里的标题，可以自定义。</li>\n<li>SHARELATEX_HEADER_IMAGE_URL 为了和 overleaf.com 的区分，我把这个 URL 指向了我们学校的 logo</li>\n<li>SHARELATEX_LEFT_FOOTER 显示在注册界面的提示信息，由于没有实际的注册功能，因此需要显示一段文字说明管理员的联系方式，就是这个字段的配置内容。</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"2-定制\"><a href=\"#2-定制\" class=\"headerlink\" title=\"2. 定制\"></a>2. 定制</h2><h3 id=\"2-1-增加宏和字体\"><a href=\"#2-1-增加宏和字体\" class=\"headerlink\" title=\"2.1 增加宏和字体\"></a>2.1 增加宏和字体</h3><p>   宏包数量 4522,耗费时间较长；并增加部分 GB 汉字，来源于网络</p>\n<pre class=\"line-numbers language-Dockerfile\" data-language=\"Dockerfile\"><div class=\"caption\"><span>TI:\"Dockerfile\"</span></div><code class=\"language-Dockerfile\">FROM sharelatex&#x2F;sharelatex:4.2.3\n\nRUN tlmgr update --self --all &amp;&amp; \\\n    tlmgr install scheme-full\n\nCOPY chinese.gz &#x2F;opt&#x2F;\n\nRUN apt-get update &amp;&amp; \\\n    apt-get install -y inkscape python3-pygments xfonts-wqy &amp;&amp; \\\n    tar -xvf &#x2F;opt&#x2F;chinese.gz -C &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;  &amp;&amp; \\\n    cd &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;chinese&#x2F; &amp;&amp; mkfontscale &amp;&amp; mkfontdir &amp;&amp; \\\n    fc-cache -fv &amp;&amp; fc-list :lang&#x3D;zh-cn<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"2-2-解决-LDAP-集成\"><a href=\"#2-2-解决-LDAP-集成\" class=\"headerlink\" title=\"2.2 解决 LDAP 集成\"></a>2.2 解决 LDAP 集成</h3><p>直接使用作者此 <a href=\"https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap/-/tree/main/\">项目</a>的 Dockerfile，此 <a href=\"https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support\">方案</a>书写细致有效!</p>\n<pre class=\"line-numbers language-Dockerfile\" data-language=\"Dockerfile\"><code class=\"language-Dockerfile\">ARG BASE&#x3D;sharelatex&#x2F;sharelatex:4.2.3 #基础镜像\nARG TEXLIVE_IMAGE&#x3D;registry.gitlab.com&#x2F;islandoftex&#x2F;images&#x2F;texlive:latest #为了方便安装完整版TEXLive，直接拉一个完整版的texlive下来，最后替换掉镜像里现有的\n\nFROM $TEXLIVE_IMAGE as texlive\n\nFROM $BASE as app\n\n# passed from .env (via make)\n# ARG collab_text\n# ARG login_text\nARG admin_is_sysadmin #是否需要把LDAP的管理员也当做overleaf的管理员，见environment文件\n\n# set workdir (might solve issue #2 - see https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;57534295&#x2F;)\nWORKDIR &#x2F;overleaf\n\n#add mirrors，我司网络环境下已注释\n#RUN sed -i s@&#x2F;archive.ubuntu.com&#x2F;@&#x2F;mirrors.sustech.edu.cn&#x2F;@g &#x2F;etc&#x2F;apt&#x2F;sources.list\n#RUN sed -i s@&#x2F;security.ubuntu.com&#x2F;@&#x2F;mirrors.sustech.edu.cn&#x2F;@g &#x2F;etc&#x2F;apt&#x2F;sources.list\n#RUN npm config set registry https:&#x2F;&#x2F;registry.npmmirror.com\n\n# add oauth router to router.js\n#head -n -1 router.js &gt; temp.txt ; mv temp.txt router.js\n#原作者保留写法，替换如下--RUN git clone https:&#x2F;&#x2F;mirrors.sustech.edu.cn&#x2F;git&#x2F;sustech-cra&#x2F;overleaf-ldap-oauth2.git &#x2F;src\nCOPY environment  &#x2F;src&#x2F;\nCOPY ldap-overleaf-sl &#x2F;src&#x2F;ldap-overleaf-sl\nRUN cat &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;router-append.js\n\n#RUN head -n -2 &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js &gt; temp.txt ; mv temp.txt &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\n#基于4.2.3镜像的修改\nRUN head -n -4 &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js &gt; temp.txt ; mv temp.txt &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\nRUN cat &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;router-append.js &gt;&gt; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\n\n# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完\nRUN node genScript compile | bash\n\n\n# 装了依赖之后打包会失败，参考 https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。\n# install package could result to the error of webpack-cli\nRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape\n\n# install pygments and some fonts dependencies\n# 安装用于minted等代码高亮包的python3-pygments，以及一些字体\nRUN apt-get update &amp;&amp; apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome\n\n# overwrite some files (enable ldap and oauth)\n# 替换文件\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;AuthenticationManager.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;AuthenticationController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;ContactController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Contacts&#x2F;\n\n# instead of copying the login.pug just edit it inline (line 19, 22-25)\n# delete 3 lines after email place-holder to enable non-email login for that form.\n#RUN sed -iE &#39;&#x2F;type&#x3D;.*email.*&#x2F;d&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n#RUN sed -iE &#39;&#x2F;email@example.com&#x2F;&#123;n;N;N;d&#125;&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n#RUN sed -iE &quot;s&#x2F;email@example.com&#x2F;$&#123;login_text:-user&#125;&#x2F;g&quot; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n\n# RUN sed -iE &#39;&#x2F;type&#x3D;.*email.*&#x2F;d&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n# RUN sed -iE &#39;&#x2F;email@example.com&#x2F;&#123;n;N;N;d&#125;&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug # comment out this line to prevent sed accidently remove the brackets of the email(username) field\n# RUN sed -iE &quot;s&#x2F;email@example.com&#x2F;$&#123;login_text:-user&#125;&#x2F;g&quot; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n\n# Collaboration settings display (share project placeholder) | edit line 146\n# Obsolete with Overleaf 3.0\n# RUN sed -iE &quot;s%placeholder&#x3D;.*$%placeholder&#x3D;\\&quot;$&#123;collab_text&#125;\\&quot;%g&quot; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;share.pug\n\n# extend pdflatex with option shell-esacpe ( fix for closed overleaf&#x2F;overleaf&#x2F;issues&#x2F;217 and overleaf&#x2F;docker-image&#x2F;issues&#x2F;45 )\n# 允许shell-esacpe（跟minted包有关）\nRUN sed -iE &quot;s%-synctex&#x3D;1\\&quot;,%-synctex&#x3D;1\\&quot;, \\&quot;-shell-escape\\&quot;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js\nRUN sed -iE &quot;s%&#39;-synctex&#x3D;1&#39;,%&#39;-synctex&#x3D;1&#39;, &#39;-shell-escape&#39;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js\n\n# Too much changes to do inline (&gt;10 Lines).\n# 继续替换文件\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;settings.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;navbar.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;layout&#x2F;\n\n# new login menu\n# 替换登录界面（可自行修改登录界面里的文字）\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;login.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;\n\n# Non LDAP User Registration for Admins\n# 继续替换文件\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;admin-index.pug \t&#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;admin-sysadmin.pug \t&#x2F;tmp&#x2F;admin-sysadmin.pug\nRUN if [ &quot;$&#123;admin_is_sysadmin&#125;&quot; &#x3D; &quot;true&quot; ] ; then cp &#x2F;tmp&#x2F;admin-sysadmin.pug   &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug ; else rm &#x2F;tmp&#x2F;admin-sysadmin.pug ; fi\n\nRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;modules&#x2F;user-activate&#x2F;app&#x2F;views&#x2F;user&#x2F;register.pug\n\n#RUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;register.pug\n\n### To remove comments entirly (bug https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;678)\nRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug\nRUN touch &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug\n\n# Update TeXLive\n# 替换为完整版的TEXLive\nCOPY --from&#x3D;texlive &#x2F;usr&#x2F;local&#x2F;texlive &#x2F;usr&#x2F;local&#x2F;texlive\nRUN tlmgr path add\n# Evil hack for hardcoded texlive 2021 path\n# RUN rm -r &#x2F;usr&#x2F;local&#x2F;texlive&#x2F;2021 &amp;&amp; ln -s &#x2F;usr&#x2F;local&#x2F;texlive&#x2F;2022 &#x2F;usr&#x2F;local&#x2F;texlive&#x2F;2021<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"3-完整结构\"><a href=\"#3-完整结构\" class=\"headerlink\" title=\"3. 完整结构\"></a>3. 完整结构</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">.\n├── chinese.gz\n├── Dockerfile\n├── environment\n└── sharelatex\n    ├── admin-index.pug\n    ├── admin-sysadmin.pug\n    ├── AuthenticationController.js\n    ├── AuthenticationManager.js\n    ├── ContactController.js\n    ├── login.pug\n    ├── navbar.pug\n    ├── router-append.js\n    └── settings.pug<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-Dockerfile\" data-language=\"Dockerfile\"><div class=\"caption\"><span>TI:\"Dockerfile\"</span></div><code class=\"language-Dockerfile\">FROM sharelatex&#x2F;sharelatex:4.2.3\n\n#是否需要把LDAP的管理员也当做overleaf的管理员\nARG admin_is_sysadmin\n\n# set workdir (might solve issue #2 - see https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;57534295&#x2F;)\nWORKDIR &#x2F;overleaf\n\n# add oauth router to router.js\nCOPY environment chinese.gz  &#x2F;src&#x2F;\nCOPY sharelatex &#x2F;src&#x2F;sharelatex\nRUN cat &#x2F;src&#x2F;sharelatex&#x2F;router-append.js\n\nRUN head -n -4 &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js &gt; temp.txt ; mv temp.txt &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\nRUN cat &#x2F;src&#x2F;sharelatex&#x2F;router-append.js &gt;&gt; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\n\n# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完\nRUN node genScript compile | bash\n\n# 装了依赖之后打包会失败，参考 https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。\n# install package could result to the error of webpack-cli\nRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape logger-sharelatex\n\n# install pygments and some fonts dependencies\n# 安装用于minted等代码高亮包的python3-pygments，以及一些字体\nRUN apt-get update &amp;&amp; apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome inkscape ttf-mscorefonts-installer\n\n# overwrite some files (enable ldap and oauth)\n# 替换文件\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;AuthenticationManager.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;AuthenticationController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;ContactController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Contacts&#x2F;\n\n# extend pdflatex with option shell-esacpe ( fix for closed overleaf&#x2F;overleaf&#x2F;issues&#x2F;217 and overleaf&#x2F;docker-image&#x2F;issues&#x2F;45 )\n# 允许shell-esacpe（跟minted包有关）\nRUN sed -iE &quot;s%-synctex&#x3D;1\\&quot;,%-synctex&#x3D;1\\&quot;, \\&quot;-shell-escape\\&quot;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js\nRUN sed -iE &quot;s%&#39;-synctex&#x3D;1&#39;,%&#39;-synctex&#x3D;1&#39;, &#39;-shell-escape&#39;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js\n\n# Too much changes to do inline (&gt;10 Lines).\n# 继续替换文件\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;settings.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;navbar.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;layout&#x2F;\n\n# new login menu\n# 替换登录界面（可自行修改登录界面里的文字）\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;login.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;\n\n# Non LDAP User Registration for Admins\n# 继续替换文件\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;admin-index.pug \t&#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;admin-sysadmin.pug \t&#x2F;tmp&#x2F;admin-sysadmin.pug\nRUN if [ &quot;$&#123;admin_is_sysadmin&#125;&quot; &#x3D; &quot;true&quot; ] ; then cp &#x2F;tmp&#x2F;admin-sysadmin.pug   &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug ; else rm &#x2F;tmp&#x2F;admin-sysadmin.pug ; fi\n\nRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;modules&#x2F;user-activate&#x2F;app&#x2F;views&#x2F;user&#x2F;register.pug\n\n#RUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;register.pug\n\n### To remove comments entirly (bug https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;678)\nRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug\nRUN touch &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug\n\n# 处理完整宏包和部分字体\nRUN tlmgr update --self --all &amp;&amp; \\\n    tlmgr install scheme-full\n\nRUN tar -xvf &#x2F;src&#x2F;chinese.gz -C &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;  &amp;&amp; \\\n    cd &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;chinese&#x2F; &amp;&amp; mkfontscale &amp;&amp; mkfontdir &amp;&amp; \\\n    fc-cache -fv &amp;&amp; fc-list :lang&#x3D;zh-cn<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"4-Debug\"><a href=\"#4-Debug\" class=\"headerlink\" title=\"4. Debug\"></a>4. Debug</h2><h3 id=\"4-1\"><a href=\"#4-1\" class=\"headerlink\" title=\"4.1\"></a>4.1</h3><pre class=\"line-numbers language-ini\" data-language=\"ini\"><div class=\"caption\"><span>TI:\"Bug1\"</span></div><code class=\"language-ini\">SyntaxError: Unexpected token '&#125;'\n    at internalCompileFunction (node:internal/vm:73:18)\n    at wrapSafe (node:internal/modules/cjs/loader:1274:20)\n    at Module._compile (node:internal/modules/cjs/loader:1320:27)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.&lt;anonymous> (/overleaf/services/web/app/src/infrastructure/Server.js:8:16)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n\nNode.js v18.19.1\nInitializing metrics\n<span class=\"token key attr-name\">Set UV_THREADPOOL_SIZE</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">16</span>\nUsing default settings from /overleaf/services/web/config/settings.defaults.js\nUsing settings from /etc/sharelatex/settings.js\n/overleaf/services/web/app/src/router.js:1351\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!Done]<br>对比成功案例，发现 4.2.3 镜像中 <code>/overleaf/services/web/app/src/router.js:1351</code> 文件的代码存在一行更多的代码，尝试修改项目中有关的替换源文件 <code>ldap-overleaf-sl/sharelatex/router-append.js </code> 和 dockerfile（替换文件时删除 4行再追加）</p>\n</blockquote>\n<p>项目源文件的修改 <code>ldap-overleaf-sl/sharelatex/router-append.js </code></p>\n<pre class=\"line-numbers language-ini\" data-language=\"ini\"><code class=\"language-ini\">  webRouter.get('/oauth/redirect', AuthenticationController.oauth2Redirect)\n  webRouter.get('/oauth/callback', AuthenticationController.oauth2Callback)\n  AuthenticationController.addEndpointToLoginWhitelist('/oauth/redirect')\n  AuthenticationController.addEndpointToLoginWhitelist('/oauth/callback')\n  webRouter.get('*', ErrorController.notFound)\n&#125;\n\n<span class=\"token key attr-name\">module.exports</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">&#123; initialize, rateLimiters &#125;  # 在原作者使用的文件中没有此行代码，这是官方 sharelatex:4.2.3 相比于 sharelatex:3.1 多出的代码</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"4-2\"><a href=\"#4-2\" class=\"headerlink\" title=\"4.2\"></a>4.2</h3><pre class=\"line-numbers language-ini\" data-language=\"ini\"><div class=\"caption\"><span>TI:\"Bug2\"</span></div><code class=\"language-ini\">Error: Cannot find module 'logger-sharelatex'\nRequire stack:\n- /overleaf/services/web/app/src/Features/Contacts/ContactController.js\n- /overleaf/services/web/app/src/Features/Contacts/ContactRouter.js\n- /overleaf/services/web/app/src/router.js\n- /overleaf/services/web/app/src/infrastructure/Server.js\n- /overleaf/services/web/app.js\n    at Module._resolveFilename (node:internal/modules/cjs/loader:1134:15)\n    at Module._load (node:internal/modules/cjs/loader:975:27)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.&lt;anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactController.js:20:16)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.&lt;anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js:3:27)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12) &#123;\n  code: 'MODULE_NOT_FOUND',\n  requireStack: [\n    '/overleaf/services/web/app/src/Features/Contacts/ContactController.js',\n    '/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js',\n    '/overleaf/services/web/app/src/router.js',\n    '/overleaf/services/web/app/src/infrastructure/Server.js',\n    '/overleaf/services/web/app.js'\n  ]\n&#125;\n\nNode.js v18.19.1\nInitializing metrics\n<span class=\"token key attr-name\">Set UV_THREADPOOL_SIZE</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">16</span>\nUsing default settings from /overleaf/services/web/config/settings.defaults.js\nUsing settings from /etc/sharelatex/settings.js\n&#123;\"name\":\"web\",\"hostname\":\"b320a99b987b\",\"pid\":2731,\"level\":40,\"msg\":\"Email transport and/or parameters not defined. No emails will be sent.\",\"time\":\"2024-02-22T03:02:29.679Z\",\"v\":0&#125;\nnode:internal/modules/cjs/loader:1137\n  throw err;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!Done]<br>执行 <code>npm install logger-sharelatex</code></p>\n</blockquote>\n<h2 id=\"5-测试使用\"><a href=\"#5-测试使用\" class=\"headerlink\" title=\"5. 测试使用\"></a>5. 测试使用</h2><h3 id=\"5-1-部署前集成-LDAP\"><a href=\"#5-1-部署前集成-LDAP\" class=\"headerlink\" title=\"5.1 部署前集成 LDAP\"></a>5.1 部署前集成 LDAP</h3><p>在 toolkit 中添加有关变量即可，配置在此文件中即可 &#96;&#96;</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token key atrule\">sharelatex</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n          <span class=\"token comment\">#image: \"$&#123;IMAGE&#125;\"  # 官方写法，变量定义方式在此`bin/docker-compose`，$IMAGE_VERSION没有找到地方定义</span>\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> overleaf4.2.3<span class=\"token punctuation\">-</span>ldap<span class=\"token punctuation\">:</span>v2  <span class=\"token comment\">#采取比较粗暴的替换</span>\n        <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> sharelatex\n        <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"$&#123;SHARELATEX_DATA_PATH&#125;:/var/lib/sharelatex\"</span>\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"$&#123;SHARELATEX_LISTEN_IP:-127.0.0.1&#125;:$&#123;SHARELATEX_PORT:-80&#125;:80\"</span>\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">GIT_BRIDGE_ENABLED</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;GIT_BRIDGE_ENABLED&#125;\"</span>\n          <span class=\"token key atrule\">GIT_BRIDGE_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"git-bridge\"</span>\n          <span class=\"token key atrule\">GIT_BRIDGE_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"8000\"</span>\n          <span class=\"token key atrule\">REDIS_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;REDIS_HOST&#125;\"</span>\n          <span class=\"token key atrule\">REDIS_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;REDIS_PORT&#125;\"</span>\n          <span class=\"token key atrule\">SHARELATEX_MONGO_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;MONGO_URL&#125;\"</span>\n          <span class=\"token key atrule\">SHARELATEX_REDIS_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;REDIS_HOST&#125;\"</span>\n          <span class=\"token key atrule\">V1_HISTORY_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://sharelatex:3100/api\"</span>\n          <span class=\"token comment\"># LDAP Block</span>\n          <span class=\"token key atrule\">LDAP_SERVER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ldap://10.8.0.88\"</span>\n          <span class=\"token key atrule\">LDAP_BASE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ou=company,dc=company,dc=net\"</span>\n          <span class=\"token key atrule\">LDAP_BIND_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"cn=companyadmin,dc=company,dc=net\"</span>\n          <span class=\"token key atrule\">LDAP_BIND_PW</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"company@2020\"</span>\n          <span class=\"token key atrule\">ALLOW_EMAIL_LOGIN</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n          <span class=\"token key atrule\">LDAP_CONTACTS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n          <span class=\"token key atrule\">LDAP_CONTACT_FILTER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"(objectClass=inetOrgPerson)\"</span>\n          <span class=\"token key atrule\">LDAP_USER_FILTER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"(mail=%m)\"</span>\n          <span class=\"token comment\"># LDAP Block</span>\n        <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ../config/variables.env\n        <span class=\"token key atrule\">stop_grace_period</span><span class=\"token punctuation\">:</span> 60s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"5-2\"><a href=\"#5-2\" class=\"headerlink\" title=\"5.2\"></a>5.2</h3><p>登录 <a href=\"http://site/launchpad\">http://site/launchpad</a> ，需要创建本地的 admin 用户<br>如果构建时， environment 中的 <code>ADMIN_IS_SYSADMIN=true</code> 也支持使用 LDAP 的 admin 作为管理员用户通过邮箱登录。<br><code>套用模板的过程出现较多的不能成功渲染，注意在左上角 菜单中选择适宜的编译器</code></p>\n<blockquote>\n<p>[!info]<br>   魔改原作者的登录界面中有关于其学校的信息，修改 <code>ldap-overleaf-sl/sharelatex/login.pug </code> ，删除 <code>SUSTech CRA</code><br>   overleaf 官方的某些界面信息可以在 toolkit&#x2F;variables.env 修改 </p>\n</blockquote>\n<h2 id=\"6-参考\"><a href=\"#6-参考\" class=\"headerlink\" title=\"6. 参考\"></a>6. 参考</h2><ol>\n<li><a href=\"https://blog.wsine.top/posts/selfhost-overleaf-for-thesis/\">部署后宏包的安装实现开箱即用</a> 从中考虑 Dockerfile 的编写</li>\n<li><a href=\"https://blog.ftliang.com/2021/08/19/overleaf.html\">在官方部署方式上重新 commit 镜像</a></li>\n<li><a href=\"https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/\">LDAP认证</a></li>\n<li><a href=\"https://lisz.me/tech/docker/sharelatex.html\">基于 sharelatex 准备中文和 texlive 的 Dockerfile</a></li>\n</ol>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"1-部署\"><a href=\"#1-部署\" class=\"headerlink\" title=\"1 . 部署\"></a>1 . 部署</h2><pre class=\"line-numbers language-Bash\" data-language=\"Bash\"><div class=\"caption\"><span>TI:\"官方安装步骤\"</span></div><code class=\"language-Bash\">git clone https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;toolkit.git\n\ncd .&#x2F;toolkit\n.&#x2F;bin&#x2F;init #执行后有 config 文件通过模板生成\nls config\nbin&#x2F;up   or  bin&#x2F;start\nbin&#x2F;logs web -f\nbin&#x2F;shell #进入容器<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!info]</p>\n<ul>\n<li><code>overleaf.rc</code><ul>\n<li>SHARELATEX_PORT 默认为 80 端口，但这个一般会被系统各大应用抢占，如果和你的有冲突，建议修改为 1024~65535 之间的一个数值。</li>\n<li>使用中主要修改了此处监听的地址和端口</li>\n</ul>\n</li>\n<li><code>variables.env</code> <ul>\n<li>SHARELATEX_APP_NAME 这个名字可以自定义，没什么特别的影响。</li>\n<li>SHARELATEX_SITE_URL 这个会影响生成用户激活链接里的 URL 的域名地址，建议根据自己的实际情况修改。注意，该域名必须能够被有效解析到服务器，否则请填写 ip 地址作为替代。</li>\n<li>SHARELATEX_NAV_TITLE 标签页里的标题，可以自定义。</li>\n<li>SHARELATEX_HEADER_IMAGE_URL 为了和 overleaf.com 的区分，我把这个 URL 指向了我们学校的 logo</li>\n<li>SHARELATEX_LEFT_FOOTER 显示在注册界面的提示信息，由于没有实际的注册功能，因此需要显示一段文字说明管理员的联系方式，就是这个字段的配置内容。</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"2-定制\"><a href=\"#2-定制\" class=\"headerlink\" title=\"2. 定制\"></a>2. 定制</h2><h3 id=\"2-1-增加宏和字体\"><a href=\"#2-1-增加宏和字体\" class=\"headerlink\" title=\"2.1 增加宏和字体\"></a>2.1 增加宏和字体</h3><p>   宏包数量 4522,耗费时间较长；并增加部分 GB 汉字，来源于网络</p>\n<pre class=\"line-numbers language-Dockerfile\" data-language=\"Dockerfile\"><div class=\"caption\"><span>TI:\"Dockerfile\"</span></div><code class=\"language-Dockerfile\">FROM sharelatex&#x2F;sharelatex:4.2.3\n\nRUN tlmgr update --self --all &amp;&amp; \\\n    tlmgr install scheme-full\n\nCOPY chinese.gz &#x2F;opt&#x2F;\n\nRUN apt-get update &amp;&amp; \\\n    apt-get install -y inkscape python3-pygments xfonts-wqy &amp;&amp; \\\n    tar -xvf &#x2F;opt&#x2F;chinese.gz -C &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;  &amp;&amp; \\\n    cd &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;chinese&#x2F; &amp;&amp; mkfontscale &amp;&amp; mkfontdir &amp;&amp; \\\n    fc-cache -fv &amp;&amp; fc-list :lang&#x3D;zh-cn<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"2-2-解决-LDAP-集成\"><a href=\"#2-2-解决-LDAP-集成\" class=\"headerlink\" title=\"2.2 解决 LDAP 集成\"></a>2.2 解决 LDAP 集成</h3><p>直接使用作者此 <a href=\"https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap/-/tree/main/\">项目</a>的 Dockerfile，此 <a href=\"https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support\">方案</a>书写细致有效!</p>\n<pre class=\"line-numbers language-Dockerfile\" data-language=\"Dockerfile\"><code class=\"language-Dockerfile\">ARG BASE&#x3D;sharelatex&#x2F;sharelatex:4.2.3 #基础镜像\nARG TEXLIVE_IMAGE&#x3D;registry.gitlab.com&#x2F;islandoftex&#x2F;images&#x2F;texlive:latest #为了方便安装完整版TEXLive，直接拉一个完整版的texlive下来，最后替换掉镜像里现有的\n\nFROM $TEXLIVE_IMAGE as texlive\n\nFROM $BASE as app\n\n# passed from .env (via make)\n# ARG collab_text\n# ARG login_text\nARG admin_is_sysadmin #是否需要把LDAP的管理员也当做overleaf的管理员，见environment文件\n\n# set workdir (might solve issue #2 - see https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;57534295&#x2F;)\nWORKDIR &#x2F;overleaf\n\n#add mirrors，我司网络环境下已注释\n#RUN sed -i s@&#x2F;archive.ubuntu.com&#x2F;@&#x2F;mirrors.sustech.edu.cn&#x2F;@g &#x2F;etc&#x2F;apt&#x2F;sources.list\n#RUN sed -i s@&#x2F;security.ubuntu.com&#x2F;@&#x2F;mirrors.sustech.edu.cn&#x2F;@g &#x2F;etc&#x2F;apt&#x2F;sources.list\n#RUN npm config set registry https:&#x2F;&#x2F;registry.npmmirror.com\n\n# add oauth router to router.js\n#head -n -1 router.js &gt; temp.txt ; mv temp.txt router.js\n#原作者保留写法，替换如下--RUN git clone https:&#x2F;&#x2F;mirrors.sustech.edu.cn&#x2F;git&#x2F;sustech-cra&#x2F;overleaf-ldap-oauth2.git &#x2F;src\nCOPY environment  &#x2F;src&#x2F;\nCOPY ldap-overleaf-sl &#x2F;src&#x2F;ldap-overleaf-sl\nRUN cat &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;router-append.js\n\n#RUN head -n -2 &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js &gt; temp.txt ; mv temp.txt &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\n#基于4.2.3镜像的修改\nRUN head -n -4 &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js &gt; temp.txt ; mv temp.txt &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\nRUN cat &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;router-append.js &gt;&gt; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\n\n# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完\nRUN node genScript compile | bash\n\n\n# 装了依赖之后打包会失败，参考 https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。\n# install package could result to the error of webpack-cli\nRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape\n\n# install pygments and some fonts dependencies\n# 安装用于minted等代码高亮包的python3-pygments，以及一些字体\nRUN apt-get update &amp;&amp; apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome\n\n# overwrite some files (enable ldap and oauth)\n# 替换文件\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;AuthenticationManager.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;AuthenticationController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;ContactController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Contacts&#x2F;\n\n# instead of copying the login.pug just edit it inline (line 19, 22-25)\n# delete 3 lines after email place-holder to enable non-email login for that form.\n#RUN sed -iE &#39;&#x2F;type&#x3D;.*email.*&#x2F;d&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n#RUN sed -iE &#39;&#x2F;email@example.com&#x2F;&#123;n;N;N;d&#125;&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n#RUN sed -iE &quot;s&#x2F;email@example.com&#x2F;$&#123;login_text:-user&#125;&#x2F;g&quot; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n\n# RUN sed -iE &#39;&#x2F;type&#x3D;.*email.*&#x2F;d&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n# RUN sed -iE &#39;&#x2F;email@example.com&#x2F;&#123;n;N;N;d&#125;&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug # comment out this line to prevent sed accidently remove the brackets of the email(username) field\n# RUN sed -iE &quot;s&#x2F;email@example.com&#x2F;$&#123;login_text:-user&#125;&#x2F;g&quot; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug\n\n# Collaboration settings display (share project placeholder) | edit line 146\n# Obsolete with Overleaf 3.0\n# RUN sed -iE &quot;s%placeholder&#x3D;.*$%placeholder&#x3D;\\&quot;$&#123;collab_text&#125;\\&quot;%g&quot; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;share.pug\n\n# extend pdflatex with option shell-esacpe ( fix for closed overleaf&#x2F;overleaf&#x2F;issues&#x2F;217 and overleaf&#x2F;docker-image&#x2F;issues&#x2F;45 )\n# 允许shell-esacpe（跟minted包有关）\nRUN sed -iE &quot;s%-synctex&#x3D;1\\&quot;,%-synctex&#x3D;1\\&quot;, \\&quot;-shell-escape\\&quot;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js\nRUN sed -iE &quot;s%&#39;-synctex&#x3D;1&#39;,%&#39;-synctex&#x3D;1&#39;, &#39;-shell-escape&#39;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js\n\n# Too much changes to do inline (&gt;10 Lines).\n# 继续替换文件\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;settings.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;navbar.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;layout&#x2F;\n\n# new login menu\n# 替换登录界面（可自行修改登录界面里的文字）\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;login.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;\n\n# Non LDAP User Registration for Admins\n# 继续替换文件\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;admin-index.pug \t&#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug\nRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;admin-sysadmin.pug \t&#x2F;tmp&#x2F;admin-sysadmin.pug\nRUN if [ &quot;$&#123;admin_is_sysadmin&#125;&quot; &#x3D; &quot;true&quot; ] ; then cp &#x2F;tmp&#x2F;admin-sysadmin.pug   &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug ; else rm &#x2F;tmp&#x2F;admin-sysadmin.pug ; fi\n\nRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;modules&#x2F;user-activate&#x2F;app&#x2F;views&#x2F;user&#x2F;register.pug\n\n#RUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;register.pug\n\n### To remove comments entirly (bug https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;678)\nRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug\nRUN touch &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug\n\n# Update TeXLive\n# 替换为完整版的TEXLive\nCOPY --from&#x3D;texlive &#x2F;usr&#x2F;local&#x2F;texlive &#x2F;usr&#x2F;local&#x2F;texlive\nRUN tlmgr path add\n# Evil hack for hardcoded texlive 2021 path\n# RUN rm -r &#x2F;usr&#x2F;local&#x2F;texlive&#x2F;2021 &amp;&amp; ln -s &#x2F;usr&#x2F;local&#x2F;texlive&#x2F;2022 &#x2F;usr&#x2F;local&#x2F;texlive&#x2F;2021<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"3-完整结构\"><a href=\"#3-完整结构\" class=\"headerlink\" title=\"3. 完整结构\"></a>3. 完整结构</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">.\n├── chinese.gz\n├── Dockerfile\n├── environment\n└── sharelatex\n    ├── admin-index.pug\n    ├── admin-sysadmin.pug\n    ├── AuthenticationController.js\n    ├── AuthenticationManager.js\n    ├── ContactController.js\n    ├── login.pug\n    ├── navbar.pug\n    ├── router-append.js\n    └── settings.pug<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-Dockerfile\" data-language=\"Dockerfile\"><div class=\"caption\"><span>TI:\"Dockerfile\"</span></div><code class=\"language-Dockerfile\">FROM sharelatex&#x2F;sharelatex:4.2.3\n\n#是否需要把LDAP的管理员也当做overleaf的管理员\nARG admin_is_sysadmin\n\n# set workdir (might solve issue #2 - see https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;57534295&#x2F;)\nWORKDIR &#x2F;overleaf\n\n# add oauth router to router.js\nCOPY environment chinese.gz  &#x2F;src&#x2F;\nCOPY sharelatex &#x2F;src&#x2F;sharelatex\nRUN cat &#x2F;src&#x2F;sharelatex&#x2F;router-append.js\n\nRUN head -n -4 &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js &gt; temp.txt ; mv temp.txt &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\nRUN cat &#x2F;src&#x2F;sharelatex&#x2F;router-append.js &gt;&gt; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js\n\n# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完\nRUN node genScript compile | bash\n\n# 装了依赖之后打包会失败，参考 https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。\n# install package could result to the error of webpack-cli\nRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape logger-sharelatex\n\n# install pygments and some fonts dependencies\n# 安装用于minted等代码高亮包的python3-pygments，以及一些字体\nRUN apt-get update &amp;&amp; apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome inkscape ttf-mscorefonts-installer\n\n# overwrite some files (enable ldap and oauth)\n# 替换文件\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;AuthenticationManager.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;AuthenticationController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;ContactController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Contacts&#x2F;\n\n# extend pdflatex with option shell-esacpe ( fix for closed overleaf&#x2F;overleaf&#x2F;issues&#x2F;217 and overleaf&#x2F;docker-image&#x2F;issues&#x2F;45 )\n# 允许shell-esacpe（跟minted包有关）\nRUN sed -iE &quot;s%-synctex&#x3D;1\\&quot;,%-synctex&#x3D;1\\&quot;, \\&quot;-shell-escape\\&quot;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js\nRUN sed -iE &quot;s%&#39;-synctex&#x3D;1&#39;,%&#39;-synctex&#x3D;1&#39;, &#39;-shell-escape&#39;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js\n\n# Too much changes to do inline (&gt;10 Lines).\n# 继续替换文件\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;settings.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;navbar.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;layout&#x2F;\n\n# new login menu\n# 替换登录界面（可自行修改登录界面里的文字）\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;login.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;\n\n# Non LDAP User Registration for Admins\n# 继续替换文件\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;admin-index.pug \t&#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug\nRUN cp &#x2F;src&#x2F;sharelatex&#x2F;admin-sysadmin.pug \t&#x2F;tmp&#x2F;admin-sysadmin.pug\nRUN if [ &quot;$&#123;admin_is_sysadmin&#125;&quot; &#x3D; &quot;true&quot; ] ; then cp &#x2F;tmp&#x2F;admin-sysadmin.pug   &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug ; else rm &#x2F;tmp&#x2F;admin-sysadmin.pug ; fi\n\nRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;modules&#x2F;user-activate&#x2F;app&#x2F;views&#x2F;user&#x2F;register.pug\n\n#RUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;register.pug\n\n### To remove comments entirly (bug https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;678)\nRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug\nRUN touch &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug\n\n# 处理完整宏包和部分字体\nRUN tlmgr update --self --all &amp;&amp; \\\n    tlmgr install scheme-full\n\nRUN tar -xvf &#x2F;src&#x2F;chinese.gz -C &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;  &amp;&amp; \\\n    cd &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;chinese&#x2F; &amp;&amp; mkfontscale &amp;&amp; mkfontdir &amp;&amp; \\\n    fc-cache -fv &amp;&amp; fc-list :lang&#x3D;zh-cn<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"4-Debug\"><a href=\"#4-Debug\" class=\"headerlink\" title=\"4. Debug\"></a>4. Debug</h2><h3 id=\"4-1\"><a href=\"#4-1\" class=\"headerlink\" title=\"4.1\"></a>4.1</h3><pre class=\"line-numbers language-ini\" data-language=\"ini\"><div class=\"caption\"><span>TI:\"Bug1\"</span></div><code class=\"language-ini\">SyntaxError: Unexpected token '&#125;'\n    at internalCompileFunction (node:internal/vm:73:18)\n    at wrapSafe (node:internal/modules/cjs/loader:1274:20)\n    at Module._compile (node:internal/modules/cjs/loader:1320:27)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.&lt;anonymous> (/overleaf/services/web/app/src/infrastructure/Server.js:8:16)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n\nNode.js v18.19.1\nInitializing metrics\n<span class=\"token key attr-name\">Set UV_THREADPOOL_SIZE</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">16</span>\nUsing default settings from /overleaf/services/web/config/settings.defaults.js\nUsing settings from /etc/sharelatex/settings.js\n/overleaf/services/web/app/src/router.js:1351\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!Done]<br>对比成功案例，发现 4.2.3 镜像中 <code>/overleaf/services/web/app/src/router.js:1351</code> 文件的代码存在一行更多的代码，尝试修改项目中有关的替换源文件 <code>ldap-overleaf-sl/sharelatex/router-append.js </code> 和 dockerfile（替换文件时删除 4行再追加）</p>\n</blockquote>\n<p>项目源文件的修改 <code>ldap-overleaf-sl/sharelatex/router-append.js </code></p>\n<pre class=\"line-numbers language-ini\" data-language=\"ini\"><code class=\"language-ini\">  webRouter.get('/oauth/redirect', AuthenticationController.oauth2Redirect)\n  webRouter.get('/oauth/callback', AuthenticationController.oauth2Callback)\n  AuthenticationController.addEndpointToLoginWhitelist('/oauth/redirect')\n  AuthenticationController.addEndpointToLoginWhitelist('/oauth/callback')\n  webRouter.get('*', ErrorController.notFound)\n&#125;\n\n<span class=\"token key attr-name\">module.exports</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">&#123; initialize, rateLimiters &#125;  # 在原作者使用的文件中没有此行代码，这是官方 sharelatex:4.2.3 相比于 sharelatex:3.1 多出的代码</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"4-2\"><a href=\"#4-2\" class=\"headerlink\" title=\"4.2\"></a>4.2</h3><pre class=\"line-numbers language-ini\" data-language=\"ini\"><div class=\"caption\"><span>TI:\"Bug2\"</span></div><code class=\"language-ini\">Error: Cannot find module 'logger-sharelatex'\nRequire stack:\n- /overleaf/services/web/app/src/Features/Contacts/ContactController.js\n- /overleaf/services/web/app/src/Features/Contacts/ContactRouter.js\n- /overleaf/services/web/app/src/router.js\n- /overleaf/services/web/app/src/infrastructure/Server.js\n- /overleaf/services/web/app.js\n    at Module._resolveFilename (node:internal/modules/cjs/loader:1134:15)\n    at Module._load (node:internal/modules/cjs/loader:975:27)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.&lt;anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactController.js:20:16)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12)\n    at Module.require (node:internal/modules/cjs/loader:1225:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.&lt;anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js:3:27)\n    at Module._compile (node:internal/modules/cjs/loader:1356:14)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)\n    at Module.load (node:internal/modules/cjs/loader:1197:32)\n    at Module._load (node:internal/modules/cjs/loader:1013:12) &#123;\n  code: 'MODULE_NOT_FOUND',\n  requireStack: [\n    '/overleaf/services/web/app/src/Features/Contacts/ContactController.js',\n    '/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js',\n    '/overleaf/services/web/app/src/router.js',\n    '/overleaf/services/web/app/src/infrastructure/Server.js',\n    '/overleaf/services/web/app.js'\n  ]\n&#125;\n\nNode.js v18.19.1\nInitializing metrics\n<span class=\"token key attr-name\">Set UV_THREADPOOL_SIZE</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">16</span>\nUsing default settings from /overleaf/services/web/config/settings.defaults.js\nUsing settings from /etc/sharelatex/settings.js\n&#123;\"name\":\"web\",\"hostname\":\"b320a99b987b\",\"pid\":2731,\"level\":40,\"msg\":\"Email transport and/or parameters not defined. No emails will be sent.\",\"time\":\"2024-02-22T03:02:29.679Z\",\"v\":0&#125;\nnode:internal/modules/cjs/loader:1137\n  throw err;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>[!Done]<br>执行 <code>npm install logger-sharelatex</code></p>\n</blockquote>\n<h2 id=\"5-测试使用\"><a href=\"#5-测试使用\" class=\"headerlink\" title=\"5. 测试使用\"></a>5. 测试使用</h2><h3 id=\"5-1-部署前集成-LDAP\"><a href=\"#5-1-部署前集成-LDAP\" class=\"headerlink\" title=\"5.1 部署前集成 LDAP\"></a>5.1 部署前集成 LDAP</h3><p>在 toolkit 中添加有关变量即可，配置在此文件中即可 &#96;&#96;</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token key atrule\">sharelatex</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n          <span class=\"token comment\">#image: \"$&#123;IMAGE&#125;\"  # 官方写法，变量定义方式在此`bin/docker-compose`，$IMAGE_VERSION没有找到地方定义</span>\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> overleaf4.2.3<span class=\"token punctuation\">-</span>ldap<span class=\"token punctuation\">:</span>v2  <span class=\"token comment\">#采取比较粗暴的替换</span>\n        <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> sharelatex\n        <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"$&#123;SHARELATEX_DATA_PATH&#125;:/var/lib/sharelatex\"</span>\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"$&#123;SHARELATEX_LISTEN_IP:-127.0.0.1&#125;:$&#123;SHARELATEX_PORT:-80&#125;:80\"</span>\n        <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">GIT_BRIDGE_ENABLED</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;GIT_BRIDGE_ENABLED&#125;\"</span>\n          <span class=\"token key atrule\">GIT_BRIDGE_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"git-bridge\"</span>\n          <span class=\"token key atrule\">GIT_BRIDGE_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"8000\"</span>\n          <span class=\"token key atrule\">REDIS_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;REDIS_HOST&#125;\"</span>\n          <span class=\"token key atrule\">REDIS_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;REDIS_PORT&#125;\"</span>\n          <span class=\"token key atrule\">SHARELATEX_MONGO_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;MONGO_URL&#125;\"</span>\n          <span class=\"token key atrule\">SHARELATEX_REDIS_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$&#123;REDIS_HOST&#125;\"</span>\n          <span class=\"token key atrule\">V1_HISTORY_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://sharelatex:3100/api\"</span>\n          <span class=\"token comment\"># LDAP Block</span>\n          <span class=\"token key atrule\">LDAP_SERVER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ldap://10.8.0.88\"</span>\n          <span class=\"token key atrule\">LDAP_BASE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ou=company,dc=company,dc=net\"</span>\n          <span class=\"token key atrule\">LDAP_BIND_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"cn=companyadmin,dc=company,dc=net\"</span>\n          <span class=\"token key atrule\">LDAP_BIND_PW</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"company@2020\"</span>\n          <span class=\"token key atrule\">ALLOW_EMAIL_LOGIN</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n          <span class=\"token key atrule\">LDAP_CONTACTS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n          <span class=\"token key atrule\">LDAP_CONTACT_FILTER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"(objectClass=inetOrgPerson)\"</span>\n          <span class=\"token key atrule\">LDAP_USER_FILTER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"(mail=%m)\"</span>\n          <span class=\"token comment\"># LDAP Block</span>\n        <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ../config/variables.env\n        <span class=\"token key atrule\">stop_grace_period</span><span class=\"token punctuation\">:</span> 60s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"5-2\"><a href=\"#5-2\" class=\"headerlink\" title=\"5.2\"></a>5.2</h3><p>登录 <a href=\"http://site/launchpad\">http://site/launchpad</a> ，需要创建本地的 admin 用户<br>如果构建时， environment 中的 <code>ADMIN_IS_SYSADMIN=true</code> 也支持使用 LDAP 的 admin 作为管理员用户通过邮箱登录。<br><code>套用模板的过程出现较多的不能成功渲染，注意在左上角 菜单中选择适宜的编译器</code></p>\n<blockquote>\n<p>[!info]<br>   魔改原作者的登录界面中有关于其学校的信息，修改 <code>ldap-overleaf-sl/sharelatex/login.pug </code> ，删除 <code>SUSTech CRA</code><br>   overleaf 官方的某些界面信息可以在 toolkit&#x2F;variables.env 修改 </p>\n</blockquote>\n<h2 id=\"6-参考\"><a href=\"#6-参考\" class=\"headerlink\" title=\"6. 参考\"></a>6. 参考</h2><ol>\n<li><a href=\"https://blog.wsine.top/posts/selfhost-overleaf-for-thesis/\">部署后宏包的安装实现开箱即用</a> 从中考虑 Dockerfile 的编写</li>\n<li><a href=\"https://blog.ftliang.com/2021/08/19/overleaf.html\">在官方部署方式上重新 commit 镜像</a></li>\n<li><a href=\"https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/\">LDAP认证</a></li>\n<li><a href=\"https://lisz.me/tech/docker/sharelatex.html\">基于 sharelatex 准备中文和 texlive 的 Dockerfile</a></li>\n</ol>\n"},{"title":"The First time using Helm Charts","date":"2023-12-04T10:50:57.000Z","summary":"The first time using Helm Charts to install serices.(Self-service-password,ldap-account-management)","_content":"## 一、ldap-account-manager\n### 1.1 Repo URL\n- https://gabibbo97.github.io/charts/\n- Set image tag:8.3 in the chart.yaml\n### 1.2 Values Modify----values.yaml\n\n```\nextraEnv:\n  LAM_SKIP_PRECONFIGURE: false\n  LDAP_DOMAIN: example.net;ibswufe.com\n  LDAP_BASE_DN: dc=example,dc=net;dc=ibswufe,dc=com\n  LDAP_SERVER: ldaps://ldap01.example.net\n  LDAP_USER: cn=administrator,dc=example,dc=net\n  LAM_LANG: zh_CN\n  LAM_PASSWORD: lam\n```\n\n## 二、 self-service-password\n### 2.1 Repo URL\n- https://ygqygq2.github.io/charts/\n- Set image tag:5.3.3 to pull the latest one\n### 2.2 Charts Using\n#### 2.2.1 ENV Setting ConfigMap\n- So confused about why cannot make it effective when I  using  the ConfigMap settings In the values.yaml to  cover the default php configurations of this soft.\n- So that , Using a ConfigMap Data to  define the container environment variables of this chart.\n- env-config.yaml\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\nname: self-service-password-env\ndata:\n  USE_QUESTIONS: 'false'\n\tLDAP_BINDDN: \"cn=exampleadmin,dc=example,dc=net\"\n\tSECRETEKEY: \"example\"\n\tDEFAULT_ACTION: \"sendtoken\"\n\tLANG: \"cn,zh-CN\"\n\tIS_BEHIND_PROXY: 'true'\n\tSITE_URL: \"https://ssp.example.net/index.php\"\n\tLDAP_SERVER: \"ldap://10.13.3.107\"\n\tLDAP_BASE_SEARCH: \"ou=example,dc=example,dc=net\"\n\tLDAP_LOGIN_ATTRIBUTE: \"cn\"\n\tLOGO: images/mnt/ltb-logo.png                                  # 共享存储，挂载在容器中的/www/ssp/images/mnt\n\tBACKGROUND_IMAGE: images/mnt/background.jpg\n\tMAIL_FROM_NAME: \"密码自主修改服务\"\n\tMAIL_SIGNATURE: \"如有疑问,请联系运维同事,英博智云.\"\n\tMAIL_USE_LDAP: 'true'\n\tNOTIFY_ON_CHANGE: 'true'\n\tSMTP_AUTH_ON: 'true'\n\tSMTP_HOST: \"smtphz.qiye.163.com\"\n\tMAIL_FROM: \"chao.long@example.net\"\n\tSMTP_USER: \"chao.long@example.net\"\n\tSMTP_SECURE_TYPE: 'ssl'\n\tSMTP_PORT: '465'\n\tSMTP_AUTOTLS: 'false'\n\tPASSWORD_DIFFERENT_LOGIN: 'true'\n\tPASSWORD_MAX_LENGTH: '30'\n\tPASSWORD_MIN_LENGTH: '8'\n\tPASSWORD_MIN_LOWERCASE: '1'\n\tPASSWORD_MIN_SPECIAL: '1'\n\tPASSWORD_MIN_UPPERCASE: '1'\n\tPASSWORD_COMPLEXITY: '4'\n\tPASSWORD_NO_REUSE: \"true\"\n\tPASSWORD_SHOW_POLICY: \"always\"\n\tPASSWORD_SPECIAL_CHARACTERS: \"^a-zA-Z0-9\"\n```\n\n- add a field `envFrom`  under the `env` in templates/deployment-statefulset.yaml\n\n```\nenv:\n{{ toYaml .Values.env | indent 12 }}\nenvFrom:\n- configMapRef:\n    name: self-service-password-env\n```\n#### 2.2.2 Secret\n- there are two variables need to been encrypted\n- values.secret\n\n```\nsecret:\n  enabled: true\n  mountPath: /etc/secret-volume\n  subPath: \"\"\n  readOnly: true\n  data:\n    ldap_bindpass: \"example@2020\"\n    smtp_pass: \"WaLxeu3pvsQaqd7X\"\n```\n#### 2.2.3 values.env\n\n```\nenv:\n  - name: LDAP_BINDPASS\n    valueFrom:\n      secretKeyRef:\n        name: self-service-password\n        key: ldap_bindpass\n  - name: SMTP_PASS\n    valueFrom:\n      secretKeyRef:\n        name: self-service-password\n        key: smtp_pass\n```\n\n#### 2.2.4 persistentVolume \n- create  pv & pvc resources under this namespace，mount the volume ，name: self-service-password\n\n```\npersistentVolume:   # 是否存储持久化\n  enabled: true\n  storageClass: \"-\"\n  accessMode: ReadWriteOnce\n  annotations: {}\n  size: 1Gi  # 大小\n  existingClaim: {}  # 使用已存在的pvc\n  mountPaths:\n   - name: data-storage\n     mountPath: /www/ssp/images/mnt  # 容器内路径，将新建 mnt\n     subPath: ssp-nfs                               # pv 中挂载点下的子目录\n```\n\n- pv.yaml\n\n```\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: self-service-password\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n    - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Retain\n  nfs:\n    path: /home/example/nfs # 指定nfs的挂载点\n    server: 10.13.3.108\n```\n\n- Post  test，reverse proxy by nginx using Nodeport。Setting the dns resolving，take a visit of this site。\n\n```\nupstream ssp {\n  server 10.13.3.109:32337;\n}\nserver {\n    listen 80;\n    server_name ssp.example.net;\n    return 301 https://$server_name$request_uri;\n}\nserver {\n    listen 443 ssl ;\n    server_name ssp.example.net;\n    ssl_certificate tls/tls_ca.pem; \n    ssl_certificate_key tls/tls_key.pem;\n    location / {\n      proxy_pass http://ssp;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto \"https\";\n      proxy_read_timeout 1800s;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection \"upgrade\";\n    }\n}\n```\n\n- charts correction\n`utcook.fullname`   change into--> `self-service-password.fullname`\n\n### 三、To Do List\nLearn more about：\n- storageclass\n- traefik ingress","source":"_posts/The-First-time-using-Helm-Charts.md","raw":"---\ntitle: The First time using Helm Charts\ndate: 2023-12-04 18:50:57\ntags:\n  - helm\ncategories:\n  - Kubernetes\nsummary: The first time using Helm Charts to install serices.(Self-service-password,ldap-account-management)\n---\n## 一、ldap-account-manager\n### 1.1 Repo URL\n- https://gabibbo97.github.io/charts/\n- Set image tag:8.3 in the chart.yaml\n### 1.2 Values Modify----values.yaml\n\n```\nextraEnv:\n  LAM_SKIP_PRECONFIGURE: false\n  LDAP_DOMAIN: example.net;ibswufe.com\n  LDAP_BASE_DN: dc=example,dc=net;dc=ibswufe,dc=com\n  LDAP_SERVER: ldaps://ldap01.example.net\n  LDAP_USER: cn=administrator,dc=example,dc=net\n  LAM_LANG: zh_CN\n  LAM_PASSWORD: lam\n```\n\n## 二、 self-service-password\n### 2.1 Repo URL\n- https://ygqygq2.github.io/charts/\n- Set image tag:5.3.3 to pull the latest one\n### 2.2 Charts Using\n#### 2.2.1 ENV Setting ConfigMap\n- So confused about why cannot make it effective when I  using  the ConfigMap settings In the values.yaml to  cover the default php configurations of this soft.\n- So that , Using a ConfigMap Data to  define the container environment variables of this chart.\n- env-config.yaml\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\nname: self-service-password-env\ndata:\n  USE_QUESTIONS: 'false'\n\tLDAP_BINDDN: \"cn=exampleadmin,dc=example,dc=net\"\n\tSECRETEKEY: \"example\"\n\tDEFAULT_ACTION: \"sendtoken\"\n\tLANG: \"cn,zh-CN\"\n\tIS_BEHIND_PROXY: 'true'\n\tSITE_URL: \"https://ssp.example.net/index.php\"\n\tLDAP_SERVER: \"ldap://10.13.3.107\"\n\tLDAP_BASE_SEARCH: \"ou=example,dc=example,dc=net\"\n\tLDAP_LOGIN_ATTRIBUTE: \"cn\"\n\tLOGO: images/mnt/ltb-logo.png                                  # 共享存储，挂载在容器中的/www/ssp/images/mnt\n\tBACKGROUND_IMAGE: images/mnt/background.jpg\n\tMAIL_FROM_NAME: \"密码自主修改服务\"\n\tMAIL_SIGNATURE: \"如有疑问,请联系运维同事,英博智云.\"\n\tMAIL_USE_LDAP: 'true'\n\tNOTIFY_ON_CHANGE: 'true'\n\tSMTP_AUTH_ON: 'true'\n\tSMTP_HOST: \"smtphz.qiye.163.com\"\n\tMAIL_FROM: \"chao.long@example.net\"\n\tSMTP_USER: \"chao.long@example.net\"\n\tSMTP_SECURE_TYPE: 'ssl'\n\tSMTP_PORT: '465'\n\tSMTP_AUTOTLS: 'false'\n\tPASSWORD_DIFFERENT_LOGIN: 'true'\n\tPASSWORD_MAX_LENGTH: '30'\n\tPASSWORD_MIN_LENGTH: '8'\n\tPASSWORD_MIN_LOWERCASE: '1'\n\tPASSWORD_MIN_SPECIAL: '1'\n\tPASSWORD_MIN_UPPERCASE: '1'\n\tPASSWORD_COMPLEXITY: '4'\n\tPASSWORD_NO_REUSE: \"true\"\n\tPASSWORD_SHOW_POLICY: \"always\"\n\tPASSWORD_SPECIAL_CHARACTERS: \"^a-zA-Z0-9\"\n```\n\n- add a field `envFrom`  under the `env` in templates/deployment-statefulset.yaml\n\n```\nenv:\n{{ toYaml .Values.env | indent 12 }}\nenvFrom:\n- configMapRef:\n    name: self-service-password-env\n```\n#### 2.2.2 Secret\n- there are two variables need to been encrypted\n- values.secret\n\n```\nsecret:\n  enabled: true\n  mountPath: /etc/secret-volume\n  subPath: \"\"\n  readOnly: true\n  data:\n    ldap_bindpass: \"example@2020\"\n    smtp_pass: \"WaLxeu3pvsQaqd7X\"\n```\n#### 2.2.3 values.env\n\n```\nenv:\n  - name: LDAP_BINDPASS\n    valueFrom:\n      secretKeyRef:\n        name: self-service-password\n        key: ldap_bindpass\n  - name: SMTP_PASS\n    valueFrom:\n      secretKeyRef:\n        name: self-service-password\n        key: smtp_pass\n```\n\n#### 2.2.4 persistentVolume \n- create  pv & pvc resources under this namespace，mount the volume ，name: self-service-password\n\n```\npersistentVolume:   # 是否存储持久化\n  enabled: true\n  storageClass: \"-\"\n  accessMode: ReadWriteOnce\n  annotations: {}\n  size: 1Gi  # 大小\n  existingClaim: {}  # 使用已存在的pvc\n  mountPaths:\n   - name: data-storage\n     mountPath: /www/ssp/images/mnt  # 容器内路径，将新建 mnt\n     subPath: ssp-nfs                               # pv 中挂载点下的子目录\n```\n\n- pv.yaml\n\n```\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: self-service-password\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n    - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Retain\n  nfs:\n    path: /home/example/nfs # 指定nfs的挂载点\n    server: 10.13.3.108\n```\n\n- Post  test，reverse proxy by nginx using Nodeport。Setting the dns resolving，take a visit of this site。\n\n```\nupstream ssp {\n  server 10.13.3.109:32337;\n}\nserver {\n    listen 80;\n    server_name ssp.example.net;\n    return 301 https://$server_name$request_uri;\n}\nserver {\n    listen 443 ssl ;\n    server_name ssp.example.net;\n    ssl_certificate tls/tls_ca.pem; \n    ssl_certificate_key tls/tls_key.pem;\n    location / {\n      proxy_pass http://ssp;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto \"https\";\n      proxy_read_timeout 1800s;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection \"upgrade\";\n    }\n}\n```\n\n- charts correction\n`utcook.fullname`   change into--> `self-service-password.fullname`\n\n### 三、To Do List\nLearn more about：\n- storageclass\n- traefik ingress","slug":"The-First-time-using-Helm-Charts","published":1,"updated":"2024-04-20T03:18:37.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodid000k80rvalov32lx","content":"<h2 id=\"一、ldap-account-manager\"><a href=\"#一、ldap-account-manager\" class=\"headerlink\" title=\"一、ldap-account-manager\"></a>一、ldap-account-manager</h2><h3 id=\"1-1-Repo-URL\"><a href=\"#1-1-Repo-URL\" class=\"headerlink\" title=\"1.1 Repo URL\"></a>1.1 Repo URL</h3><ul>\n<li><a href=\"https://gabibbo97.github.io/charts/\">https://gabibbo97.github.io/charts/</a></li>\n<li>Set image tag:8.3 in the chart.yaml</li>\n</ul>\n<h3 id=\"1-2-Values-Modify—-values-yaml\"><a href=\"#1-2-Values-Modify—-values-yaml\" class=\"headerlink\" title=\"1.2 Values Modify—-values.yaml\"></a>1.2 Values Modify—-values.yaml</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">extraEnv:\n  LAM_SKIP_PRECONFIGURE: false\n  LDAP_DOMAIN: example.net;ibswufe.com\n  LDAP_BASE_DN: dc&#x3D;example,dc&#x3D;net;dc&#x3D;ibswufe,dc&#x3D;com\n  LDAP_SERVER: ldaps:&#x2F;&#x2F;ldap01.example.net\n  LDAP_USER: cn&#x3D;administrator,dc&#x3D;example,dc&#x3D;net\n  LAM_LANG: zh_CN\n  LAM_PASSWORD: lam<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、-self-service-password\"><a href=\"#二、-self-service-password\" class=\"headerlink\" title=\"二、 self-service-password\"></a>二、 self-service-password</h2><h3 id=\"2-1-Repo-URL\"><a href=\"#2-1-Repo-URL\" class=\"headerlink\" title=\"2.1 Repo URL\"></a>2.1 Repo URL</h3><ul>\n<li><a href=\"https://ygqygq2.github.io/charts/\">https://ygqygq2.github.io/charts/</a></li>\n<li>Set image tag:5.3.3 to pull the latest one</li>\n</ul>\n<h3 id=\"2-2-Charts-Using\"><a href=\"#2-2-Charts-Using\" class=\"headerlink\" title=\"2.2 Charts Using\"></a>2.2 Charts Using</h3><h4 id=\"2-2-1-ENV-Setting-ConfigMap\"><a href=\"#2-2-1-ENV-Setting-ConfigMap\" class=\"headerlink\" title=\"2.2.1 ENV Setting ConfigMap\"></a>2.2.1 ENV Setting ConfigMap</h4><ul>\n<li>So confused about why cannot make it effective when I  using  the ConfigMap settings In the values.yaml to  cover the default php configurations of this soft.</li>\n<li>So that , Using a ConfigMap Data to  define the container environment variables of this chart.</li>\n<li>env-config.yaml</li>\n</ul>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> self<span class=\"token punctuation\">-</span>service<span class=\"token punctuation\">-</span>password<span class=\"token punctuation\">-</span>env\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">USE_QUESTIONS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'false'</span>\n\t<span class=\"token key atrule\">LDAP_BINDDN</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"cn=exampleadmin,dc=example,dc=net\"</span>\n\t<span class=\"token key atrule\">SECRETEKEY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"example\"</span>\n\t<span class=\"token key atrule\">DEFAULT_ACTION</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sendtoken\"</span>\n\t<span class=\"token key atrule\">LANG</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"cn,zh-CN\"</span>\n\t<span class=\"token key atrule\">IS_BEHIND_PROXY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">SITE_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://ssp.example.net/index.php\"</span>\n\t<span class=\"token key atrule\">LDAP_SERVER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ldap://10.13.3.107\"</span>\n\t<span class=\"token key atrule\">LDAP_BASE_SEARCH</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ou=example,dc=example,dc=net\"</span>\n\t<span class=\"token key atrule\">LDAP_LOGIN_ATTRIBUTE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"cn\"</span>\n\t<span class=\"token key atrule\">LOGO</span><span class=\"token punctuation\">:</span> images/mnt/ltb<span class=\"token punctuation\">-</span>logo.png                                  <span class=\"token comment\"># 共享存储，挂载在容器中的/www/ssp/images/mnt</span>\n\t<span class=\"token key atrule\">BACKGROUND_IMAGE</span><span class=\"token punctuation\">:</span> images/mnt/background.jpg\n\t<span class=\"token key atrule\">MAIL_FROM_NAME</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"密码自主修改服务\"</span>\n\t<span class=\"token key atrule\">MAIL_SIGNATURE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"如有疑问,请联系运维同事,英博智云.\"</span>\n\t<span class=\"token key atrule\">MAIL_USE_LDAP</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">NOTIFY_ON_CHANGE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">SMTP_AUTH_ON</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">SMTP_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"smtphz.qiye.163.com\"</span>\n\t<span class=\"token key atrule\">MAIL_FROM</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"chao.long@example.net\"</span>\n\t<span class=\"token key atrule\">SMTP_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"chao.long@example.net\"</span>\n\t<span class=\"token key atrule\">SMTP_SECURE_TYPE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ssl'</span>\n\t<span class=\"token key atrule\">SMTP_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'465'</span>\n\t<span class=\"token key atrule\">SMTP_AUTOTLS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'false'</span>\n\t<span class=\"token key atrule\">PASSWORD_DIFFERENT_LOGIN</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">PASSWORD_MAX_LENGTH</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'30'</span>\n\t<span class=\"token key atrule\">PASSWORD_MIN_LENGTH</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'8'</span>\n\t<span class=\"token key atrule\">PASSWORD_MIN_LOWERCASE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'1'</span>\n\t<span class=\"token key atrule\">PASSWORD_MIN_SPECIAL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'1'</span>\n\t<span class=\"token key atrule\">PASSWORD_MIN_UPPERCASE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'1'</span>\n\t<span class=\"token key atrule\">PASSWORD_COMPLEXITY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'4'</span>\n\t<span class=\"token key atrule\">PASSWORD_NO_REUSE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n\t<span class=\"token key atrule\">PASSWORD_SHOW_POLICY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"always\"</span>\n\t<span class=\"token key atrule\">PASSWORD_SPECIAL_CHARACTERS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"^a-zA-Z0-9\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>add a field <code>envFrom</code>  under the <code>env</code> in templates&#x2F;deployment-statefulset.yaml</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">env:\n&#123;&#123; toYaml .Values.env | indent 12 &#125;&#125;\nenvFrom:\n- configMapRef:\n    name: self-service-password-env<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"2-2-2-Secret\"><a href=\"#2-2-2-Secret\" class=\"headerlink\" title=\"2.2.2 Secret\"></a>2.2.2 Secret</h4><ul>\n<li>there are two variables need to been encrypted</li>\n<li>values.secret</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">secret:\n  enabled: true\n  mountPath: &#x2F;etc&#x2F;secret-volume\n  subPath: &quot;&quot;\n  readOnly: true\n  data:\n    ldap_bindpass: &quot;example@2020&quot;\n    smtp_pass: &quot;WaLxeu3pvsQaqd7X&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"2-2-3-values-env\"><a href=\"#2-2-3-values-env\" class=\"headerlink\" title=\"2.2.3 values.env\"></a>2.2.3 values.env</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">env:\n  - name: LDAP_BINDPASS\n    valueFrom:\n      secretKeyRef:\n        name: self-service-password\n        key: ldap_bindpass\n  - name: SMTP_PASS\n    valueFrom:\n      secretKeyRef:\n        name: self-service-password\n        key: smtp_pass<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-4-persistentVolume\"><a href=\"#2-2-4-persistentVolume\" class=\"headerlink\" title=\"2.2.4 persistentVolume\"></a>2.2.4 persistentVolume</h4><ul>\n<li>create  pv &amp; pvc resources under this namespace，mount the volume ，name: self-service-password</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">persistentVolume:   # 是否存储持久化\n  enabled: true\n  storageClass: &quot;-&quot;\n  accessMode: ReadWriteOnce\n  annotations: &#123;&#125;\n  size: 1Gi  # 大小\n  existingClaim: &#123;&#125;  # 使用已存在的pvc\n  mountPaths:\n   - name: data-storage\n     mountPath: &#x2F;www&#x2F;ssp&#x2F;images&#x2F;mnt  # 容器内路径，将新建 mnt\n     subPath: ssp-nfs                               # pv 中挂载点下的子目录<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>pv.yaml</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: self-service-password\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n    - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Retain\n  nfs:\n    path: &#x2F;home&#x2F;example&#x2F;nfs # 指定nfs的挂载点\n    server: 10.13.3.108<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>Post  test，reverse proxy by nginx using Nodeport。Setting the dns resolving，take a visit of this site。</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">upstream ssp &#123;\n  server 10.13.3.109:32337;\n&#125;\nserver &#123;\n    listen 80;\n    server_name ssp.example.net;\n    return 301 https:&#x2F;&#x2F;$server_name$request_uri;\n&#125;\nserver &#123;\n    listen 443 ssl ;\n    server_name ssp.example.net;\n    ssl_certificate tls&#x2F;tls_ca.pem; \n    ssl_certificate_key tls&#x2F;tls_key.pem;\n    location &#x2F; &#123;\n      proxy_pass http:&#x2F;&#x2F;ssp;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto &quot;https&quot;;\n      proxy_read_timeout 1800s;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection &quot;upgrade&quot;;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>charts correction<br><code>utcook.fullname</code>   change into–&gt; <code>self-service-password.fullname</code></li>\n</ul>\n<h3 id=\"三、To-Do-List\"><a href=\"#三、To-Do-List\" class=\"headerlink\" title=\"三、To Do List\"></a>三、To Do List</h3><p>Learn more about：</p>\n<ul>\n<li>storageclass</li>\n<li>traefik ingress</li>\n</ul>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"一、ldap-account-manager\"><a href=\"#一、ldap-account-manager\" class=\"headerlink\" title=\"一、ldap-account-manager\"></a>一、ldap-account-manager</h2><h3 id=\"1-1-Repo-URL\"><a href=\"#1-1-Repo-URL\" class=\"headerlink\" title=\"1.1 Repo URL\"></a>1.1 Repo URL</h3><ul>\n<li><a href=\"https://gabibbo97.github.io/charts/\">https://gabibbo97.github.io/charts/</a></li>\n<li>Set image tag:8.3 in the chart.yaml</li>\n</ul>\n<h3 id=\"1-2-Values-Modify—-values-yaml\"><a href=\"#1-2-Values-Modify—-values-yaml\" class=\"headerlink\" title=\"1.2 Values Modify—-values.yaml\"></a>1.2 Values Modify—-values.yaml</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">extraEnv:\n  LAM_SKIP_PRECONFIGURE: false\n  LDAP_DOMAIN: example.net;ibswufe.com\n  LDAP_BASE_DN: dc&#x3D;example,dc&#x3D;net;dc&#x3D;ibswufe,dc&#x3D;com\n  LDAP_SERVER: ldaps:&#x2F;&#x2F;ldap01.example.net\n  LDAP_USER: cn&#x3D;administrator,dc&#x3D;example,dc&#x3D;net\n  LAM_LANG: zh_CN\n  LAM_PASSWORD: lam<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、-self-service-password\"><a href=\"#二、-self-service-password\" class=\"headerlink\" title=\"二、 self-service-password\"></a>二、 self-service-password</h2><h3 id=\"2-1-Repo-URL\"><a href=\"#2-1-Repo-URL\" class=\"headerlink\" title=\"2.1 Repo URL\"></a>2.1 Repo URL</h3><ul>\n<li><a href=\"https://ygqygq2.github.io/charts/\">https://ygqygq2.github.io/charts/</a></li>\n<li>Set image tag:5.3.3 to pull the latest one</li>\n</ul>\n<h3 id=\"2-2-Charts-Using\"><a href=\"#2-2-Charts-Using\" class=\"headerlink\" title=\"2.2 Charts Using\"></a>2.2 Charts Using</h3><h4 id=\"2-2-1-ENV-Setting-ConfigMap\"><a href=\"#2-2-1-ENV-Setting-ConfigMap\" class=\"headerlink\" title=\"2.2.1 ENV Setting ConfigMap\"></a>2.2.1 ENV Setting ConfigMap</h4><ul>\n<li>So confused about why cannot make it effective when I  using  the ConfigMap settings In the values.yaml to  cover the default php configurations of this soft.</li>\n<li>So that , Using a ConfigMap Data to  define the container environment variables of this chart.</li>\n<li>env-config.yaml</li>\n</ul>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> self<span class=\"token punctuation\">-</span>service<span class=\"token punctuation\">-</span>password<span class=\"token punctuation\">-</span>env\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">USE_QUESTIONS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'false'</span>\n\t<span class=\"token key atrule\">LDAP_BINDDN</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"cn=exampleadmin,dc=example,dc=net\"</span>\n\t<span class=\"token key atrule\">SECRETEKEY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"example\"</span>\n\t<span class=\"token key atrule\">DEFAULT_ACTION</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sendtoken\"</span>\n\t<span class=\"token key atrule\">LANG</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"cn,zh-CN\"</span>\n\t<span class=\"token key atrule\">IS_BEHIND_PROXY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">SITE_URL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://ssp.example.net/index.php\"</span>\n\t<span class=\"token key atrule\">LDAP_SERVER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ldap://10.13.3.107\"</span>\n\t<span class=\"token key atrule\">LDAP_BASE_SEARCH</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ou=example,dc=example,dc=net\"</span>\n\t<span class=\"token key atrule\">LDAP_LOGIN_ATTRIBUTE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"cn\"</span>\n\t<span class=\"token key atrule\">LOGO</span><span class=\"token punctuation\">:</span> images/mnt/ltb<span class=\"token punctuation\">-</span>logo.png                                  <span class=\"token comment\"># 共享存储，挂载在容器中的/www/ssp/images/mnt</span>\n\t<span class=\"token key atrule\">BACKGROUND_IMAGE</span><span class=\"token punctuation\">:</span> images/mnt/background.jpg\n\t<span class=\"token key atrule\">MAIL_FROM_NAME</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"密码自主修改服务\"</span>\n\t<span class=\"token key atrule\">MAIL_SIGNATURE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"如有疑问,请联系运维同事,英博智云.\"</span>\n\t<span class=\"token key atrule\">MAIL_USE_LDAP</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">NOTIFY_ON_CHANGE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">SMTP_AUTH_ON</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">SMTP_HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"smtphz.qiye.163.com\"</span>\n\t<span class=\"token key atrule\">MAIL_FROM</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"chao.long@example.net\"</span>\n\t<span class=\"token key atrule\">SMTP_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"chao.long@example.net\"</span>\n\t<span class=\"token key atrule\">SMTP_SECURE_TYPE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ssl'</span>\n\t<span class=\"token key atrule\">SMTP_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'465'</span>\n\t<span class=\"token key atrule\">SMTP_AUTOTLS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'false'</span>\n\t<span class=\"token key atrule\">PASSWORD_DIFFERENT_LOGIN</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n\t<span class=\"token key atrule\">PASSWORD_MAX_LENGTH</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'30'</span>\n\t<span class=\"token key atrule\">PASSWORD_MIN_LENGTH</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'8'</span>\n\t<span class=\"token key atrule\">PASSWORD_MIN_LOWERCASE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'1'</span>\n\t<span class=\"token key atrule\">PASSWORD_MIN_SPECIAL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'1'</span>\n\t<span class=\"token key atrule\">PASSWORD_MIN_UPPERCASE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'1'</span>\n\t<span class=\"token key atrule\">PASSWORD_COMPLEXITY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'4'</span>\n\t<span class=\"token key atrule\">PASSWORD_NO_REUSE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n\t<span class=\"token key atrule\">PASSWORD_SHOW_POLICY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"always\"</span>\n\t<span class=\"token key atrule\">PASSWORD_SPECIAL_CHARACTERS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"^a-zA-Z0-9\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>add a field <code>envFrom</code>  under the <code>env</code> in templates&#x2F;deployment-statefulset.yaml</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">env:\n&#123;&#123; toYaml .Values.env | indent 12 &#125;&#125;\nenvFrom:\n- configMapRef:\n    name: self-service-password-env<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"2-2-2-Secret\"><a href=\"#2-2-2-Secret\" class=\"headerlink\" title=\"2.2.2 Secret\"></a>2.2.2 Secret</h4><ul>\n<li>there are two variables need to been encrypted</li>\n<li>values.secret</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">secret:\n  enabled: true\n  mountPath: &#x2F;etc&#x2F;secret-volume\n  subPath: &quot;&quot;\n  readOnly: true\n  data:\n    ldap_bindpass: &quot;example@2020&quot;\n    smtp_pass: &quot;WaLxeu3pvsQaqd7X&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"2-2-3-values-env\"><a href=\"#2-2-3-values-env\" class=\"headerlink\" title=\"2.2.3 values.env\"></a>2.2.3 values.env</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">env:\n  - name: LDAP_BINDPASS\n    valueFrom:\n      secretKeyRef:\n        name: self-service-password\n        key: ldap_bindpass\n  - name: SMTP_PASS\n    valueFrom:\n      secretKeyRef:\n        name: self-service-password\n        key: smtp_pass<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-4-persistentVolume\"><a href=\"#2-2-4-persistentVolume\" class=\"headerlink\" title=\"2.2.4 persistentVolume\"></a>2.2.4 persistentVolume</h4><ul>\n<li>create  pv &amp; pvc resources under this namespace，mount the volume ，name: self-service-password</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">persistentVolume:   # 是否存储持久化\n  enabled: true\n  storageClass: &quot;-&quot;\n  accessMode: ReadWriteOnce\n  annotations: &#123;&#125;\n  size: 1Gi  # 大小\n  existingClaim: &#123;&#125;  # 使用已存在的pvc\n  mountPaths:\n   - name: data-storage\n     mountPath: &#x2F;www&#x2F;ssp&#x2F;images&#x2F;mnt  # 容器内路径，将新建 mnt\n     subPath: ssp-nfs                               # pv 中挂载点下的子目录<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>pv.yaml</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: self-service-password\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n    - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Retain\n  nfs:\n    path: &#x2F;home&#x2F;example&#x2F;nfs # 指定nfs的挂载点\n    server: 10.13.3.108<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>Post  test，reverse proxy by nginx using Nodeport。Setting the dns resolving，take a visit of this site。</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">upstream ssp &#123;\n  server 10.13.3.109:32337;\n&#125;\nserver &#123;\n    listen 80;\n    server_name ssp.example.net;\n    return 301 https:&#x2F;&#x2F;$server_name$request_uri;\n&#125;\nserver &#123;\n    listen 443 ssl ;\n    server_name ssp.example.net;\n    ssl_certificate tls&#x2F;tls_ca.pem; \n    ssl_certificate_key tls&#x2F;tls_key.pem;\n    location &#x2F; &#123;\n      proxy_pass http:&#x2F;&#x2F;ssp;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_set_header X-Forwarded-Proto &quot;https&quot;;\n      proxy_read_timeout 1800s;\n      proxy_http_version 1.1;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection &quot;upgrade&quot;;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>charts correction<br><code>utcook.fullname</code>   change into–&gt; <code>self-service-password.fullname</code></li>\n</ul>\n<h3 id=\"三、To-Do-List\"><a href=\"#三、To-Do-List\" class=\"headerlink\" title=\"三、To Do List\"></a>三、To Do List</h3><p>Learn more about：</p>\n<ul>\n<li>storageclass</li>\n<li>traefik ingress</li>\n</ul>\n"},{"title":"blog-with-cdn","author":"LC","toc":true,"date":"2024-04-24T13:22:34.000Z","img":null,"top":null,"cover":null,"password":null,"summary":"测试发布在github pages 的博客自定义域名并且在cdn中分发","_content":"## 1. 前置\n当前托管在 github 的访问地址是`https://myrepo.github.io` \nNote：\n此时自己的仓库名应该和自己的域名相同`myrepo.github.io`; 同时配置 blog 应用中关于github pages 发布中关于url的配置)\n\n然后配置自定义域名是 `blog.mydomain.cn`； 可以在 UI 配置，也可以通过直接在 main 分支source文件夹下创建一个位于顶级的文件`CNAME`,其中只存在这个自定义域名，然后发布一次。\n此时需要在自己的域名管理添加 DNS 的 CNAME 解析记录，对应以上；即： `blog.mydomain.cn  CNAME  myrepo.github.io`\n\n## 2. cdn 加速\n测试使用的cdn产品是 `cdn.cdn5.com`, `sudun.com`\n\n加速域名：km.mydomain.cn\n源站：blog.mydomain.cn  OR  myrepo.github.io\ncdn域名别名：xxxxxxx\n\n**配置：**\n为`加速域名`，在自己的域名管理添加 DNS 的 CNAME 解析记录，对应为：`km.mydomain.cn CNAME cdn域名别名`\n\n**流量：**\n加速域名 --> DNS --> cdn域名别名 --> 源站（github.io|blog.cn ）\n\n其中，回源 是指 cdn 向源站请求的过程。回源`host` 这个参数需要源站能够匹配。所以在回源设置中需要保证`host`的值正确;\n此例是将值自定义为源站的 servername，`blog.mydomain.cn | myrepo.github.io`\n\n**其它：**\n默认使用加密传输，配置了证书、开启了重定向跳转https\n\n**结果：**\n国内访问 km.mydomain.cn 可以快速访问，不因为墙的原因而慢了","source":"_posts/blog-with-cdn.md","raw":"---\ntitle: blog-with-cdn\nauthor: LC\ntoc: true\ndate: 2024-04-24 21:22:34\nimg:\ntop:\ncover:\npassword:\nsummary: 测试发布在github pages 的博客自定义域名并且在cdn中分发\ncategories:\ntags:\n---\n## 1. 前置\n当前托管在 github 的访问地址是`https://myrepo.github.io` \nNote：\n此时自己的仓库名应该和自己的域名相同`myrepo.github.io`; 同时配置 blog 应用中关于github pages 发布中关于url的配置)\n\n然后配置自定义域名是 `blog.mydomain.cn`； 可以在 UI 配置，也可以通过直接在 main 分支source文件夹下创建一个位于顶级的文件`CNAME`,其中只存在这个自定义域名，然后发布一次。\n此时需要在自己的域名管理添加 DNS 的 CNAME 解析记录，对应以上；即： `blog.mydomain.cn  CNAME  myrepo.github.io`\n\n## 2. cdn 加速\n测试使用的cdn产品是 `cdn.cdn5.com`, `sudun.com`\n\n加速域名：km.mydomain.cn\n源站：blog.mydomain.cn  OR  myrepo.github.io\ncdn域名别名：xxxxxxx\n\n**配置：**\n为`加速域名`，在自己的域名管理添加 DNS 的 CNAME 解析记录，对应为：`km.mydomain.cn CNAME cdn域名别名`\n\n**流量：**\n加速域名 --> DNS --> cdn域名别名 --> 源站（github.io|blog.cn ）\n\n其中，回源 是指 cdn 向源站请求的过程。回源`host` 这个参数需要源站能够匹配。所以在回源设置中需要保证`host`的值正确;\n此例是将值自定义为源站的 servername，`blog.mydomain.cn | myrepo.github.io`\n\n**其它：**\n默认使用加密传输，配置了证书、开启了重定向跳转https\n\n**结果：**\n国内访问 km.mydomain.cn 可以快速访问，不因为墙的原因而慢了","slug":"blog-with-cdn","published":1,"updated":"2024-04-27T01:43:56.256Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodim000l80rv2nrehsf5","content":"<h2 id=\"1-前置\"><a href=\"#1-前置\" class=\"headerlink\" title=\"1. 前置\"></a>1. 前置</h2><p>当前托管在 github 的访问地址是<code>https://myrepo.github.io</code><br>Note：<br>此时自己的仓库名应该和自己的域名相同<code>myrepo.github.io</code>; 同时配置 blog 应用中关于github pages 发布中关于url的配置)</p>\n<p>然后配置自定义域名是 <code>blog.mydomain.cn</code>； 可以在 UI 配置，也可以通过直接在 main 分支source文件夹下创建一个位于顶级的文件<code>CNAME</code>,其中只存在这个自定义域名，然后发布一次。<br>此时需要在自己的域名管理添加 DNS 的 CNAME 解析记录，对应以上；即： <code>blog.mydomain.cn  CNAME  myrepo.github.io</code></p>\n<h2 id=\"2-cdn-加速\"><a href=\"#2-cdn-加速\" class=\"headerlink\" title=\"2. cdn 加速\"></a>2. cdn 加速</h2><p>测试使用的cdn产品是 <code>cdn.cdn5.com</code>, <code>sudun.com</code></p>\n<p>加速域名：km.mydomain.cn<br>源站：blog.mydomain.cn  OR  myrepo.github.io<br>cdn域名别名：xxxxxxx</p>\n<p><strong>配置：</strong><br>为<code>加速域名</code>，在自己的域名管理添加 DNS 的 CNAME 解析记录，对应为：<code>km.mydomain.cn CNAME cdn域名别名</code></p>\n<p><strong>流量：</strong><br>加速域名 –&gt; DNS –&gt; cdn域名别名 –&gt; 源站（github.io|blog.cn ）</p>\n<p>其中，回源 是指 cdn 向源站请求的过程。回源<code>host</code> 这个参数需要源站能够匹配。所以在回源设置中需要保证<code>host</code>的值正确;<br>此例是将值自定义为源站的 servername，<code>blog.mydomain.cn | myrepo.github.io</code></p>\n<p><strong>其它：</strong><br>默认使用加密传输，配置了证书、开启了重定向跳转https</p>\n<p><strong>结果：</strong><br>国内访问 km.mydomain.cn 可以快速访问，不因为墙的原因而慢了</p>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"1-前置\"><a href=\"#1-前置\" class=\"headerlink\" title=\"1. 前置\"></a>1. 前置</h2><p>当前托管在 github 的访问地址是<code>https://myrepo.github.io</code><br>Note：<br>此时自己的仓库名应该和自己的域名相同<code>myrepo.github.io</code>; 同时配置 blog 应用中关于github pages 发布中关于url的配置)</p>\n<p>然后配置自定义域名是 <code>blog.mydomain.cn</code>； 可以在 UI 配置，也可以通过直接在 main 分支source文件夹下创建一个位于顶级的文件<code>CNAME</code>,其中只存在这个自定义域名，然后发布一次。<br>此时需要在自己的域名管理添加 DNS 的 CNAME 解析记录，对应以上；即： <code>blog.mydomain.cn  CNAME  myrepo.github.io</code></p>\n<h2 id=\"2-cdn-加速\"><a href=\"#2-cdn-加速\" class=\"headerlink\" title=\"2. cdn 加速\"></a>2. cdn 加速</h2><p>测试使用的cdn产品是 <code>cdn.cdn5.com</code>, <code>sudun.com</code></p>\n<p>加速域名：km.mydomain.cn<br>源站：blog.mydomain.cn  OR  myrepo.github.io<br>cdn域名别名：xxxxxxx</p>\n<p><strong>配置：</strong><br>为<code>加速域名</code>，在自己的域名管理添加 DNS 的 CNAME 解析记录，对应为：<code>km.mydomain.cn CNAME cdn域名别名</code></p>\n<p><strong>流量：</strong><br>加速域名 –&gt; DNS –&gt; cdn域名别名 –&gt; 源站（github.io|blog.cn ）</p>\n<p>其中，回源 是指 cdn 向源站请求的过程。回源<code>host</code> 这个参数需要源站能够匹配。所以在回源设置中需要保证<code>host</code>的值正确;<br>此例是将值自定义为源站的 servername，<code>blog.mydomain.cn | myrepo.github.io</code></p>\n<p><strong>其它：</strong><br>默认使用加密传输，配置了证书、开启了重定向跳转https</p>\n<p><strong>结果：</strong><br>国内访问 km.mydomain.cn 可以快速访问，不因为墙的原因而慢了</p>\n"},{"title":"cert-manager","author":"LC","toc":true,"date":"2024-04-30T15:15:54.000Z","img":null,"top":true,"cover":null,"password":null,"summary":"尝试使用 cert-manger 自动签发权威证书的尝试","_content":"## Prepare\n首先装上 crds，使用的 kubectl 安装。不建议在 helm 中使用 crd: enable, 这样升级 cert-manager 的时候，随 helm 的卸载和升级，集群中已经有的自定义资源会消失。(官网有特别说明这两种安装方式的不同)\n##  helm install cert-manager\n\n### helm metrics\n```\nprometheus:\n  enabled: true\n  servicemonitor:\n    enabled: true  # 没有配置servicemonitor，使用已配置的服务自动发现也可以获取指标。\n```\n\n>[!question]\n>确实只有三条指标吗？----a issue in repo 提到：当存在有证书资源的时候就会有更多指标存在\n>```\n># HELP certmanager_clock_time_seconds DEPRECATED: use clock_time_seconds_gauge instead. The clock time given in seconds (from 1970/01/01 UTC).\n># TYPE certmanager_clock_time_seconds counter\ncertmanager_clock_time_seconds 1.713170784e+09\n># HELP certmanager_clock_time_seconds_gauge The clock time given in seconds (from 1970/01/01 UTC).\n># TYPE certmanager_clock_time_seconds_gauge gauge\ncertmanager_clock_time_seconds_gauge 1.713170784e+09\n># HELP certmanager_controller_sync_call_count The number of sync() calls made by a controller.\n># TYPE certmanager_controller_sync_call_count counter\ncertmanager_controller_sync_call_count{controller=\"ingress-shim\"} 5\n>```\n\n## 简单使用并验证指标数量\n### 域名和阿里 dns 赋权用户\n域名迁移 {% post_link 'domain-management' %}\n\n#### RAM 用户权限\n\n目的：在 cert-manager 中使用 lets encrypt 通过 alidns 的 webhook 来创建证书。 需要：创建一个子用户\n在 RAM 访问控制台创建一个用户，给予 api 访问即可，创建后点击用户，编辑授权。\n\n![28b2ee3eedfdf53267a55dd203fc3972.png](https://i.mji.rip/2024/04/30/28b2ee3eedfdf53267a55dd203fc3972.png)\n\n### alidns-webhook\n\n> 介绍\n>ACME（Automatic Certificate Management Environment）是一个用于自动化从证书颁发机构（Certificate Authority, CA）获取、续签和吊销 SSL/TLS 证书的协议。ACME 旨在简化证书管理过程，使得网站管理员可以轻松地为其网站启用 HTTPS 加密，从而提高网络安全性。\n>\n>>Cert Manager 使用 DNS01 验证来自动化地获取和续订由 ACME 服务器（如 Let's Encrypt）颁发的 SSL/TLS 证书。DNS01 要求 Cert Manager 能够创建和删除 DNS TXT 记录，以证明域名的所有权。由此，Cert Manager 需要与 DNS 服务提供商的 API 进行交互。\n>\n>>这就是为什么需要像 alidns 的 webhook 这样的组件。Webhook 解析器是 Cert Manager 中的一种机制，它允许开发者创建自定义的逻辑来处理 DNS01 挑战。这些 webhook 解析器作为独立的服务运行，并且能够接收来自 Cert Manager 的 DNS01 验证请求，并执行必要的操作来满足的要求。\n>\n> Webhook 的作用\n>\n>>当使用 Cert Manager 与具体的 DNS 服务（如 AliDNS）交互时，需要一种方式来自动化更新 DNS 记录的过程。这就是 webhook 发挥作用的地方：\n>>\n>>1. **自动化处理**：Webhook 提供了一种机制，通过这种机制 Cert Manager 可以自动向 DNS 提供商请求添加、修改或删除 DNS 记录。这对于自动化证书的申请、续期和撤销过程至关重要。\n>>\n>>2. **安全访问**：通过 webhook，可以安全地集成第三方服务（如 DNS 提供商），同时遵守最小权限原则。Webhook 通常需要配置相应的 API 凭证，这些凭证应当只赋予修改 DNS 记录所需的权限，从而降低安全风险。\n>>\n>>3. **提供商特定的逻辑**：不同的 DNS 提供商可能有不同的 API 接口和规则。Webhook 可以封装这些特定的逻辑，使得 Cert Manager 能够以统一的方式处理不同 DNS 提供商的接口。\n>\n>实现细节\n>\n>>例如，在使用AliDNS的场景中，Cert Manager需要一个AliDNS webhook来处理DNS记录的修改。这个webhook负责与AliDNS的API进行交互，执行如下操作：\n>>\n>> - 当 Cert Manager 需要在 DNS 中创建一个新的 TXT 记录以响应 DNS-01挑战时，webhook 将调用 AliDNS 的 API 来添加该记录。\n>> - 完成验证后，webhook 将再次调用 API 删除该 TXT 记录，以清理不再需要的记录。\n>\n>通过这种方式，Cert Manager可以实现完全自动化的证书管理，无需人工干预DNS记录的更新，大大简化了使用SSL/TLS证书的复杂性。\n>总的来说，alidns 的 webhook 为 Cert Manager 提供了与阿里云 DNS 服务交互的能力，使得 Cert Manager 能够自动化地完成 DNS01 挑战，从而简化了在 Kubernetes 集群中管理 SSL/TLS 证书的过程。\n\n#### 安装 alidns-webhook (两种webhook)\n- helm（本例使用）\n- reference： [GitHub - DEVmachine-fr/cert-manager-alidns-webhook: Cert-manager webhook to generate Let's Encrypt certificates over Alibaba Cloud DNS.](https://github.com/DEVmachine-fr/cert-manager-alidns-webhook)\n```shell\n  # 部署 阿里云 DNS Webhook，groupName的值修改为自己的域名\n  helm repo add cert-manager-alidns-webhook https://devmachine-fr.github.io/cert-manager-alidns-webhook\n  helm repo update\n  helm upgrade -i alidns-webhook cert-manager-alidns-webhook/alidns-webhook \\\n    --set groupName=acme.chaoslong.cn\n```\n\n- 另一个 manifest 文件安装（使用有不同）\n```bash\nwget https://raw.githubusercontent.com/pragkent/alidns-webhook/master/deploy/bundle.yaml\n\n# 修改文件中的acme.yourcompany.com为自己的域名\nsed -i s/'acme.yourcompany.com'/'acme.chaoslong.cn'/g bundle.yaml\n```\n\n### Secret of AliDNS Access\n```yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: alidns-secret\n  namespace: cert-manager\ntype: Opaque\ndata:\n  accesskey-id: xxxxxxxxxxxxxxxx  # echo -n \"shdhd\" | base64 ; echo -n 参数没换行符输出\n  accesskey-secret: xxxxxxxxxxxx\n\n或者\n\nkubectl create secret generic alidns-secrets --from-literal=\"access-token=xxxxxxx\" --from-literal=\"secret-key=xxxxxxxxxx\"\n```\n### Create Letsencrypt clusterissuer\n```yaml\napiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-staging\n  namespace: cert-manager\nspec:\n  acme:\n    # Change to your letsencrypt email\n    email: chao.long@keyword.net\n    # 测试阶段可以用 staging （无限制）\n    server: https://acme-staging-v02.api.letsencrypt.org/directory\n    # 正式\n    # server: https://acme-v02.api.letsencrypt.org/directory \n    privateKeySecretRef:\n      name: letsencrypt-staging-acme-count # 如果不存在将创建，用以存放一个私钥，作为 ACME 账户的私钥，用于与 ACME 服务器进行安全通信\n    solvers:\n    - dns01:\n        webhook:\n          groupName: chaoslong.cn  #同于webhook安装中的值\n          solverName: alidns   # 固定\n          config:\n            region: \"\"\n            secretKeySecretRef:\n              name: alidns-secret\n              key: accesskey-id\n            accessTokenSecretRef:\n              name: alidns-secret\n              key: accesskey-secret\n    selector：    # 当 cert-manager 处理证书请求时，它将只为这些 DNS 区域中的域名创建和更新 DNS 记录。\n      dnsZones:\n      - 'mydomdom.org'\n      - '*.mydomdom.org'\n```\n\n手动生成证书\n`certificates` -> `certificaterequests` -> `orders` -> `challenges`.\n```\napiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: chaoslong-test-tls\n  # 指定证书生成到哪个工作空间，不指定也可以\n  namespace: cert-manager\nspec:\n  #生成后证书的secret名称\n  secretName: chaoslong-test-tls\n  duration: 24h\n  # 指定域名\n  dnsNames:\n  - \"chaoslong.cn\"\n  - \"*.chaoslong.cn\"\n  issuerRef:\n    name: letsencrypt-staging\n    kind: ClusterIssuer\n```\n\n> [!debug]\n>  此时以上各种新增资源一直是 pending 或者 unavailable; accesskey 解析一直失败\\\n>  排查发现：\n>  ```\n>  - dns01:\n>          webhook: \n>            config: \n>              accessTokenSecretRef:     # 此处书写错误，使用了另一个 webhook 的变量，正确的如此配置\n>                key: access-token        # 这是 asccesskey 的 id\n>                name: alidns-secrets \n>              region: '' \n>              secretKeySecretRef:\n>                key: secret-key      # 这是 accesskey 的 secert\n>                name: alidns-secrets  \n>```\n>certmanager 如果成功调用 webhook，会在证书验证过程中生成一个 challenge 的 TXT 记录到 DNS，判断域名的所有权\\\n\n>[!success] Valid 描述 \n>创建 certificates 资源之后，challenges 和 orders 会相应生成，在验证过程中会有一段较长的时间等待世界 DNS 缓存刷新（会生成一个 cert.doamin.cn）。\n最终状态正常之后，challenges 删除，其 txt 记录也会被删除，存放证书内容的 tls-secret 状态将变为合法，其中会存储有证书内容。\n\n\n## 待尝试\n## Vault 保存证书\n\n## 应用通过 ESO 请求证书","source":"_posts/cert-manager.md","raw":"---\ntitle: cert-manager\nauthor: LC\ntoc: true\ndate: 2024-04-30 23:15:54\nimg:\ntop: true\ncover:\npassword:\nsummary: 尝试使用 cert-manger 自动签发权威证书的尝试\ncategories: kubernetes\ntags: [cert-manager]\n---\n## Prepare\n首先装上 crds，使用的 kubectl 安装。不建议在 helm 中使用 crd: enable, 这样升级 cert-manager 的时候，随 helm 的卸载和升级，集群中已经有的自定义资源会消失。(官网有特别说明这两种安装方式的不同)\n##  helm install cert-manager\n\n### helm metrics\n```\nprometheus:\n  enabled: true\n  servicemonitor:\n    enabled: true  # 没有配置servicemonitor，使用已配置的服务自动发现也可以获取指标。\n```\n\n>[!question]\n>确实只有三条指标吗？----a issue in repo 提到：当存在有证书资源的时候就会有更多指标存在\n>```\n># HELP certmanager_clock_time_seconds DEPRECATED: use clock_time_seconds_gauge instead. The clock time given in seconds (from 1970/01/01 UTC).\n># TYPE certmanager_clock_time_seconds counter\ncertmanager_clock_time_seconds 1.713170784e+09\n># HELP certmanager_clock_time_seconds_gauge The clock time given in seconds (from 1970/01/01 UTC).\n># TYPE certmanager_clock_time_seconds_gauge gauge\ncertmanager_clock_time_seconds_gauge 1.713170784e+09\n># HELP certmanager_controller_sync_call_count The number of sync() calls made by a controller.\n># TYPE certmanager_controller_sync_call_count counter\ncertmanager_controller_sync_call_count{controller=\"ingress-shim\"} 5\n>```\n\n## 简单使用并验证指标数量\n### 域名和阿里 dns 赋权用户\n域名迁移 {% post_link 'domain-management' %}\n\n#### RAM 用户权限\n\n目的：在 cert-manager 中使用 lets encrypt 通过 alidns 的 webhook 来创建证书。 需要：创建一个子用户\n在 RAM 访问控制台创建一个用户，给予 api 访问即可，创建后点击用户，编辑授权。\n\n![28b2ee3eedfdf53267a55dd203fc3972.png](https://i.mji.rip/2024/04/30/28b2ee3eedfdf53267a55dd203fc3972.png)\n\n### alidns-webhook\n\n> 介绍\n>ACME（Automatic Certificate Management Environment）是一个用于自动化从证书颁发机构（Certificate Authority, CA）获取、续签和吊销 SSL/TLS 证书的协议。ACME 旨在简化证书管理过程，使得网站管理员可以轻松地为其网站启用 HTTPS 加密，从而提高网络安全性。\n>\n>>Cert Manager 使用 DNS01 验证来自动化地获取和续订由 ACME 服务器（如 Let's Encrypt）颁发的 SSL/TLS 证书。DNS01 要求 Cert Manager 能够创建和删除 DNS TXT 记录，以证明域名的所有权。由此，Cert Manager 需要与 DNS 服务提供商的 API 进行交互。\n>\n>>这就是为什么需要像 alidns 的 webhook 这样的组件。Webhook 解析器是 Cert Manager 中的一种机制，它允许开发者创建自定义的逻辑来处理 DNS01 挑战。这些 webhook 解析器作为独立的服务运行，并且能够接收来自 Cert Manager 的 DNS01 验证请求，并执行必要的操作来满足的要求。\n>\n> Webhook 的作用\n>\n>>当使用 Cert Manager 与具体的 DNS 服务（如 AliDNS）交互时，需要一种方式来自动化更新 DNS 记录的过程。这就是 webhook 发挥作用的地方：\n>>\n>>1. **自动化处理**：Webhook 提供了一种机制，通过这种机制 Cert Manager 可以自动向 DNS 提供商请求添加、修改或删除 DNS 记录。这对于自动化证书的申请、续期和撤销过程至关重要。\n>>\n>>2. **安全访问**：通过 webhook，可以安全地集成第三方服务（如 DNS 提供商），同时遵守最小权限原则。Webhook 通常需要配置相应的 API 凭证，这些凭证应当只赋予修改 DNS 记录所需的权限，从而降低安全风险。\n>>\n>>3. **提供商特定的逻辑**：不同的 DNS 提供商可能有不同的 API 接口和规则。Webhook 可以封装这些特定的逻辑，使得 Cert Manager 能够以统一的方式处理不同 DNS 提供商的接口。\n>\n>实现细节\n>\n>>例如，在使用AliDNS的场景中，Cert Manager需要一个AliDNS webhook来处理DNS记录的修改。这个webhook负责与AliDNS的API进行交互，执行如下操作：\n>>\n>> - 当 Cert Manager 需要在 DNS 中创建一个新的 TXT 记录以响应 DNS-01挑战时，webhook 将调用 AliDNS 的 API 来添加该记录。\n>> - 完成验证后，webhook 将再次调用 API 删除该 TXT 记录，以清理不再需要的记录。\n>\n>通过这种方式，Cert Manager可以实现完全自动化的证书管理，无需人工干预DNS记录的更新，大大简化了使用SSL/TLS证书的复杂性。\n>总的来说，alidns 的 webhook 为 Cert Manager 提供了与阿里云 DNS 服务交互的能力，使得 Cert Manager 能够自动化地完成 DNS01 挑战，从而简化了在 Kubernetes 集群中管理 SSL/TLS 证书的过程。\n\n#### 安装 alidns-webhook (两种webhook)\n- helm（本例使用）\n- reference： [GitHub - DEVmachine-fr/cert-manager-alidns-webhook: Cert-manager webhook to generate Let's Encrypt certificates over Alibaba Cloud DNS.](https://github.com/DEVmachine-fr/cert-manager-alidns-webhook)\n```shell\n  # 部署 阿里云 DNS Webhook，groupName的值修改为自己的域名\n  helm repo add cert-manager-alidns-webhook https://devmachine-fr.github.io/cert-manager-alidns-webhook\n  helm repo update\n  helm upgrade -i alidns-webhook cert-manager-alidns-webhook/alidns-webhook \\\n    --set groupName=acme.chaoslong.cn\n```\n\n- 另一个 manifest 文件安装（使用有不同）\n```bash\nwget https://raw.githubusercontent.com/pragkent/alidns-webhook/master/deploy/bundle.yaml\n\n# 修改文件中的acme.yourcompany.com为自己的域名\nsed -i s/'acme.yourcompany.com'/'acme.chaoslong.cn'/g bundle.yaml\n```\n\n### Secret of AliDNS Access\n```yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: alidns-secret\n  namespace: cert-manager\ntype: Opaque\ndata:\n  accesskey-id: xxxxxxxxxxxxxxxx  # echo -n \"shdhd\" | base64 ; echo -n 参数没换行符输出\n  accesskey-secret: xxxxxxxxxxxx\n\n或者\n\nkubectl create secret generic alidns-secrets --from-literal=\"access-token=xxxxxxx\" --from-literal=\"secret-key=xxxxxxxxxx\"\n```\n### Create Letsencrypt clusterissuer\n```yaml\napiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-staging\n  namespace: cert-manager\nspec:\n  acme:\n    # Change to your letsencrypt email\n    email: chao.long@keyword.net\n    # 测试阶段可以用 staging （无限制）\n    server: https://acme-staging-v02.api.letsencrypt.org/directory\n    # 正式\n    # server: https://acme-v02.api.letsencrypt.org/directory \n    privateKeySecretRef:\n      name: letsencrypt-staging-acme-count # 如果不存在将创建，用以存放一个私钥，作为 ACME 账户的私钥，用于与 ACME 服务器进行安全通信\n    solvers:\n    - dns01:\n        webhook:\n          groupName: chaoslong.cn  #同于webhook安装中的值\n          solverName: alidns   # 固定\n          config:\n            region: \"\"\n            secretKeySecretRef:\n              name: alidns-secret\n              key: accesskey-id\n            accessTokenSecretRef:\n              name: alidns-secret\n              key: accesskey-secret\n    selector：    # 当 cert-manager 处理证书请求时，它将只为这些 DNS 区域中的域名创建和更新 DNS 记录。\n      dnsZones:\n      - 'mydomdom.org'\n      - '*.mydomdom.org'\n```\n\n手动生成证书\n`certificates` -> `certificaterequests` -> `orders` -> `challenges`.\n```\napiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: chaoslong-test-tls\n  # 指定证书生成到哪个工作空间，不指定也可以\n  namespace: cert-manager\nspec:\n  #生成后证书的secret名称\n  secretName: chaoslong-test-tls\n  duration: 24h\n  # 指定域名\n  dnsNames:\n  - \"chaoslong.cn\"\n  - \"*.chaoslong.cn\"\n  issuerRef:\n    name: letsencrypt-staging\n    kind: ClusterIssuer\n```\n\n> [!debug]\n>  此时以上各种新增资源一直是 pending 或者 unavailable; accesskey 解析一直失败\\\n>  排查发现：\n>  ```\n>  - dns01:\n>          webhook: \n>            config: \n>              accessTokenSecretRef:     # 此处书写错误，使用了另一个 webhook 的变量，正确的如此配置\n>                key: access-token        # 这是 asccesskey 的 id\n>                name: alidns-secrets \n>              region: '' \n>              secretKeySecretRef:\n>                key: secret-key      # 这是 accesskey 的 secert\n>                name: alidns-secrets  \n>```\n>certmanager 如果成功调用 webhook，会在证书验证过程中生成一个 challenge 的 TXT 记录到 DNS，判断域名的所有权\\\n\n>[!success] Valid 描述 \n>创建 certificates 资源之后，challenges 和 orders 会相应生成，在验证过程中会有一段较长的时间等待世界 DNS 缓存刷新（会生成一个 cert.doamin.cn）。\n最终状态正常之后，challenges 删除，其 txt 记录也会被删除，存放证书内容的 tls-secret 状态将变为合法，其中会存储有证书内容。\n\n\n## 待尝试\n## Vault 保存证书\n\n## 应用通过 ESO 请求证书","slug":"cert-manager","published":1,"updated":"2024-04-30T16:26:40.775Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodiu000p80rv12bw1rmf","content":"<h2 id=\"Prepare\"><a href=\"#Prepare\" class=\"headerlink\" title=\"Prepare\"></a>Prepare</h2><p>首先装上 crds，使用的 kubectl 安装。不建议在 helm 中使用 crd: enable, 这样升级 cert-manager 的时候，随 helm 的卸载和升级，集群中已经有的自定义资源会消失。(官网有特别说明这两种安装方式的不同)</p>\n<h2 id=\"helm-install-cert-manager\"><a href=\"#helm-install-cert-manager\" class=\"headerlink\" title=\"helm install cert-manager\"></a>helm install cert-manager</h2><h3 id=\"helm-metrics\"><a href=\"#helm-metrics\" class=\"headerlink\" title=\"helm metrics\"></a>helm metrics</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">prometheus:\n  enabled: true\n  servicemonitor:\n    enabled: true  # 没有配置servicemonitor，使用已配置的服务自动发现也可以获取指标。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>[!question]<br>确实只有三条指标吗？—-a issue in repo 提到：当存在有证书资源的时候就会有更多指标存在</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&gt;# HELP certmanager_clock_time_seconds DEPRECATED: use clock_time_seconds_gauge instead. The clock time given in seconds (from 1970&#x2F;01&#x2F;01 UTC).\n&gt;# TYPE certmanager_clock_time_seconds counter\ncertmanager_clock_time_seconds 1.713170784e+09\n&gt;# HELP certmanager_clock_time_seconds_gauge The clock time given in seconds (from 1970&#x2F;01&#x2F;01 UTC).\n&gt;# TYPE certmanager_clock_time_seconds_gauge gauge\ncertmanager_clock_time_seconds_gauge 1.713170784e+09\n&gt;# HELP certmanager_controller_sync_call_count The number of sync() calls made by a controller.\n&gt;# TYPE certmanager_controller_sync_call_count counter\ncertmanager_controller_sync_call_count&#123;controller&#x3D;&quot;ingress-shim&quot;&#125; 5<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</blockquote>\n<h2 id=\"简单使用并验证指标数量\"><a href=\"#简单使用并验证指标数量\" class=\"headerlink\" title=\"简单使用并验证指标数量\"></a>简单使用并验证指标数量</h2><h3 id=\"域名和阿里-dns-赋权用户\"><a href=\"#域名和阿里-dns-赋权用户\" class=\"headerlink\" title=\"域名和阿里 dns 赋权用户\"></a>域名和阿里 dns 赋权用户</h3><p>域名迁移 <a href=\"/2024/04/30/domain-management/\" title=\"domain-management\">domain-management</a></p>\n<h4 id=\"RAM-用户权限\"><a href=\"#RAM-用户权限\" class=\"headerlink\" title=\"RAM 用户权限\"></a>RAM 用户权限</h4><p>目的：在 cert-manager 中使用 lets encrypt 通过 alidns 的 webhook 来创建证书。 需要：创建一个子用户<br>在 RAM 访问控制台创建一个用户，给予 api 访问即可，创建后点击用户，编辑授权。</p>\n<p><img src=\"https://i.mji.rip/2024/04/30/28b2ee3eedfdf53267a55dd203fc3972.png\" alt=\"28b2ee3eedfdf53267a55dd203fc3972.png\"></p>\n<h3 id=\"alidns-webhook\"><a href=\"#alidns-webhook\" class=\"headerlink\" title=\"alidns-webhook\"></a>alidns-webhook</h3><blockquote>\n<p>介绍<br>ACME（Automatic Certificate Management Environment）是一个用于自动化从证书颁发机构（Certificate Authority, CA）获取、续签和吊销 SSL&#x2F;TLS 证书的协议。ACME 旨在简化证书管理过程，使得网站管理员可以轻松地为其网站启用 HTTPS 加密，从而提高网络安全性。</p>\n<blockquote>\n<p>Cert Manager 使用 DNS01 验证来自动化地获取和续订由 ACME 服务器（如 Let’s Encrypt）颁发的 SSL&#x2F;TLS 证书。DNS01 要求 Cert Manager 能够创建和删除 DNS TXT 记录，以证明域名的所有权。由此，Cert Manager 需要与 DNS 服务提供商的 API 进行交互。</p>\n</blockquote>\n<blockquote>\n<p>这就是为什么需要像 alidns 的 webhook 这样的组件。Webhook 解析器是 Cert Manager 中的一种机制，它允许开发者创建自定义的逻辑来处理 DNS01 挑战。这些 webhook 解析器作为独立的服务运行，并且能够接收来自 Cert Manager 的 DNS01 验证请求，并执行必要的操作来满足的要求。</p>\n</blockquote>\n<p>Webhook 的作用</p>\n<blockquote>\n<p>当使用 Cert Manager 与具体的 DNS 服务（如 AliDNS）交互时，需要一种方式来自动化更新 DNS 记录的过程。这就是 webhook 发挥作用的地方：</p>\n<ol>\n<li><p><strong>自动化处理</strong>：Webhook 提供了一种机制，通过这种机制 Cert Manager 可以自动向 DNS 提供商请求添加、修改或删除 DNS 记录。这对于自动化证书的申请、续期和撤销过程至关重要。</p>\n</li>\n<li><p><strong>安全访问</strong>：通过 webhook，可以安全地集成第三方服务（如 DNS 提供商），同时遵守最小权限原则。Webhook 通常需要配置相应的 API 凭证，这些凭证应当只赋予修改 DNS 记录所需的权限，从而降低安全风险。</p>\n</li>\n<li><p><strong>提供商特定的逻辑</strong>：不同的 DNS 提供商可能有不同的 API 接口和规则。Webhook 可以封装这些特定的逻辑，使得 Cert Manager 能够以统一的方式处理不同 DNS 提供商的接口。</p>\n</li>\n</ol>\n</blockquote>\n<p>实现细节</p>\n<blockquote>\n<p>例如，在使用AliDNS的场景中，Cert Manager需要一个AliDNS webhook来处理DNS记录的修改。这个webhook负责与AliDNS的API进行交互，执行如下操作：</p>\n<ul>\n<li>当 Cert Manager 需要在 DNS 中创建一个新的 TXT 记录以响应 DNS-01挑战时，webhook 将调用 AliDNS 的 API 来添加该记录。</li>\n<li>完成验证后，webhook 将再次调用 API 删除该 TXT 记录，以清理不再需要的记录。</li>\n</ul>\n</blockquote>\n<p>通过这种方式，Cert Manager可以实现完全自动化的证书管理，无需人工干预DNS记录的更新，大大简化了使用SSL&#x2F;TLS证书的复杂性。<br>总的来说，alidns 的 webhook 为 Cert Manager 提供了与阿里云 DNS 服务交互的能力，使得 Cert Manager 能够自动化地完成 DNS01 挑战，从而简化了在 Kubernetes 集群中管理 SSL&#x2F;TLS 证书的过程。</p>\n</blockquote>\n<h4 id=\"安装-alidns-webhook-两种webhook\"><a href=\"#安装-alidns-webhook-两种webhook\" class=\"headerlink\" title=\"安装 alidns-webhook (两种webhook)\"></a>安装 alidns-webhook (两种webhook)</h4><ul>\n<li><p>helm（本例使用）</p>\n</li>\n<li><p>reference： <a href=\"https://github.com/DEVmachine-fr/cert-manager-alidns-webhook\">GitHub - DEVmachine-fr&#x2F;cert-manager-alidns-webhook: Cert-manager webhook to generate Let’s Encrypt certificates over Alibaba Cloud DNS.</a></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 部署 阿里云 DNS Webhook，groupName的值修改为自己的域名</span>\nhelm repo <span class=\"token function\">add</span> cert-manager-alidns-webhook https://devmachine-fr.github.io/cert-manager-alidns-webhook\nhelm repo update\nhelm upgrade <span class=\"token parameter variable\">-i</span> alidns-webhook cert-manager-alidns-webhook/alidns-webhook <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--set</span> <span class=\"token assign-left variable\">groupName</span><span class=\"token operator\">=</span>acme.chaoslong.cn<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>另一个 manifest 文件安装（使用有不同）</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://raw.githubusercontent.com/pragkent/alidns-webhook/master/deploy/bundle.yaml\n\n<span class=\"token comment\"># 修改文件中的acme.yourcompany.com为自己的域名</span>\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s/<span class=\"token string\">'acme.yourcompany.com'</span>/<span class=\"token string\">'acme.chaoslong.cn'</span>/g bundle.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"Secret-of-AliDNS-Access\"><a href=\"#Secret-of-AliDNS-Access\" class=\"headerlink\" title=\"Secret of AliDNS Access\"></a>Secret of AliDNS Access</h3><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Secret\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alidns<span class=\"token punctuation\">-</span>secret\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> cert<span class=\"token punctuation\">-</span>manager\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Opaque\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">accesskey-id</span><span class=\"token punctuation\">:</span> xxxxxxxxxxxxxxxx  <span class=\"token comment\"># echo -n \"shdhd\" | base64 ; echo -n 参数没换行符输出</span>\n  <span class=\"token key atrule\">accesskey-secret</span><span class=\"token punctuation\">:</span> xxxxxxxxxxxx\n\n或者\n\nkubectl create secret generic alidns<span class=\"token punctuation\">-</span>secrets <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from<span class=\"token punctuation\">-</span>literal=\"access<span class=\"token punctuation\">-</span>token=xxxxxxx\" <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from<span class=\"token punctuation\">-</span>literal=\"secret<span class=\"token punctuation\">-</span>key=xxxxxxxxxx\"<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"Create-Letsencrypt-clusterissuer\"><a href=\"#Create-Letsencrypt-clusterissuer\" class=\"headerlink\" title=\"Create Letsencrypt clusterissuer\"></a>Create Letsencrypt clusterissuer</h3><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> cert<span class=\"token punctuation\">-</span>manager.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterIssuer\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> letsencrypt<span class=\"token punctuation\">-</span>staging\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> cert<span class=\"token punctuation\">-</span>manager\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">acme</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Change to your letsencrypt email</span>\n    <span class=\"token key atrule\">email</span><span class=\"token punctuation\">:</span> chao.long@keyword.net\n    <span class=\"token comment\"># 测试阶段可以用 staging （无限制）</span>\n    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//acme<span class=\"token punctuation\">-</span>staging<span class=\"token punctuation\">-</span>v02.api.letsencrypt.org/directory\n    <span class=\"token comment\"># 正式</span>\n    <span class=\"token comment\"># server: https://acme-v02.api.letsencrypt.org/directory </span>\n    <span class=\"token key atrule\">privateKeySecretRef</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> letsencrypt<span class=\"token punctuation\">-</span>staging<span class=\"token punctuation\">-</span>acme<span class=\"token punctuation\">-</span>count <span class=\"token comment\"># 如果不存在将创建，用以存放一个私钥，作为 ACME 账户的私钥，用于与 ACME 服务器进行安全通信</span>\n    <span class=\"token key atrule\">solvers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">dns01</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">webhook</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">groupName</span><span class=\"token punctuation\">:</span> chaoslong.cn  <span class=\"token comment\">#同于webhook安装中的值</span>\n          <span class=\"token key atrule\">solverName</span><span class=\"token punctuation\">:</span> alidns   <span class=\"token comment\"># 固定</span>\n          <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n            <span class=\"token key atrule\">secretKeySecretRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alidns<span class=\"token punctuation\">-</span>secret\n              <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> accesskey<span class=\"token punctuation\">-</span>id\n            <span class=\"token key atrule\">accessTokenSecretRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alidns<span class=\"token punctuation\">-</span>secret\n              <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> accesskey<span class=\"token punctuation\">-</span>secret\n    selector：    <span class=\"token comment\"># 当 cert-manager 处理证书请求时，它将只为这些 DNS 区域中的域名创建和更新 DNS 记录。</span>\n      <span class=\"token key atrule\">dnsZones</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'mydomdom.org'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'*.mydomdom.org'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>手动生成证书<br><code>certificates</code> -&gt; <code>certificaterequests</code> -&gt; <code>orders</code> -&gt; <code>challenges</code>.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apiVersion: cert-manager.io&#x2F;v1\nkind: Certificate\nmetadata:\n  name: chaoslong-test-tls\n  # 指定证书生成到哪个工作空间，不指定也可以\n  namespace: cert-manager\nspec:\n  #生成后证书的secret名称\n  secretName: chaoslong-test-tls\n  duration: 24h\n  # 指定域名\n  dnsNames:\n  - &quot;chaoslong.cn&quot;\n  - &quot;*.chaoslong.cn&quot;\n  issuerRef:\n    name: letsencrypt-staging\n    kind: ClusterIssuer<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>[!debug]<br> 此时以上各种新增资源一直是 pending 或者 unavailable; accesskey 解析一直失败<br> 排查发现：<br> <pre class=\"line-numbers language-none\"><code class=\"language-none\">- dns01:\n        webhook: \n          config: \n            accessTokenSecretRef:     # 此处书写错误，使用了另一个 webhook 的变量，正确的如此配置\n              key: access-token        # 这是 asccesskey 的 id\n              name: alidns-secrets \n            region: &#39;&#39; \n            secretKeySecretRef:\n              key: secret-key      # 这是 accesskey 的 secert\n              name: alidns-secrets  <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>certmanager 如果成功调用 webhook，会在证书验证过程中生成一个 challenge 的 TXT 记录到 DNS，判断域名的所有权\\</p>\n</blockquote>\n<blockquote>\n<p>[!success] Valid 描述<br>创建 certificates 资源之后，challenges 和 orders 会相应生成，在验证过程中会有一段较长的时间等待世界 DNS 缓存刷新（会生成一个 cert.doamin.cn）。<br>最终状态正常之后，challenges 删除，其 txt 记录也会被删除，存放证书内容的 tls-secret 状态将变为合法，其中会存储有证书内容。</p>\n</blockquote>\n<h2 id=\"待尝试\"><a href=\"#待尝试\" class=\"headerlink\" title=\"待尝试\"></a>待尝试</h2><h2 id=\"Vault-保存证书\"><a href=\"#Vault-保存证书\" class=\"headerlink\" title=\"Vault 保存证书\"></a>Vault 保存证书</h2><h2 id=\"应用通过-ESO-请求证书\"><a href=\"#应用通过-ESO-请求证书\" class=\"headerlink\" title=\"应用通过 ESO 请求证书\"></a>应用通过 ESO 请求证书</h2>","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"Prepare\"><a href=\"#Prepare\" class=\"headerlink\" title=\"Prepare\"></a>Prepare</h2><p>首先装上 crds，使用的 kubectl 安装。不建议在 helm 中使用 crd: enable, 这样升级 cert-manager 的时候，随 helm 的卸载和升级，集群中已经有的自定义资源会消失。(官网有特别说明这两种安装方式的不同)</p>\n<h2 id=\"helm-install-cert-manager\"><a href=\"#helm-install-cert-manager\" class=\"headerlink\" title=\"helm install cert-manager\"></a>helm install cert-manager</h2><h3 id=\"helm-metrics\"><a href=\"#helm-metrics\" class=\"headerlink\" title=\"helm metrics\"></a>helm metrics</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">prometheus:\n  enabled: true\n  servicemonitor:\n    enabled: true  # 没有配置servicemonitor，使用已配置的服务自动发现也可以获取指标。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>[!question]<br>确实只有三条指标吗？—-a issue in repo 提到：当存在有证书资源的时候就会有更多指标存在</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&gt;# HELP certmanager_clock_time_seconds DEPRECATED: use clock_time_seconds_gauge instead. The clock time given in seconds (from 1970&#x2F;01&#x2F;01 UTC).\n&gt;# TYPE certmanager_clock_time_seconds counter\ncertmanager_clock_time_seconds 1.713170784e+09\n&gt;# HELP certmanager_clock_time_seconds_gauge The clock time given in seconds (from 1970&#x2F;01&#x2F;01 UTC).\n&gt;# TYPE certmanager_clock_time_seconds_gauge gauge\ncertmanager_clock_time_seconds_gauge 1.713170784e+09\n&gt;# HELP certmanager_controller_sync_call_count The number of sync() calls made by a controller.\n&gt;# TYPE certmanager_controller_sync_call_count counter\ncertmanager_controller_sync_call_count&#123;controller&#x3D;&quot;ingress-shim&quot;&#125; 5<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</blockquote>\n<h2 id=\"简单使用并验证指标数量\"><a href=\"#简单使用并验证指标数量\" class=\"headerlink\" title=\"简单使用并验证指标数量\"></a>简单使用并验证指标数量</h2><h3 id=\"域名和阿里-dns-赋权用户\"><a href=\"#域名和阿里-dns-赋权用户\" class=\"headerlink\" title=\"域名和阿里 dns 赋权用户\"></a>域名和阿里 dns 赋权用户</h3><p>域名迁移 <a href=\"/2024/04/30/domain-management/\" title=\"domain-management\">domain-management</a></p>\n<h4 id=\"RAM-用户权限\"><a href=\"#RAM-用户权限\" class=\"headerlink\" title=\"RAM 用户权限\"></a>RAM 用户权限</h4><p>目的：在 cert-manager 中使用 lets encrypt 通过 alidns 的 webhook 来创建证书。 需要：创建一个子用户<br>在 RAM 访问控制台创建一个用户，给予 api 访问即可，创建后点击用户，编辑授权。</p>\n<p><img src=\"https://i.mji.rip/2024/04/30/28b2ee3eedfdf53267a55dd203fc3972.png\" alt=\"28b2ee3eedfdf53267a55dd203fc3972.png\"></p>\n<h3 id=\"alidns-webhook\"><a href=\"#alidns-webhook\" class=\"headerlink\" title=\"alidns-webhook\"></a>alidns-webhook</h3><blockquote>\n<p>介绍<br>ACME（Automatic Certificate Management Environment）是一个用于自动化从证书颁发机构（Certificate Authority, CA）获取、续签和吊销 SSL&#x2F;TLS 证书的协议。ACME 旨在简化证书管理过程，使得网站管理员可以轻松地为其网站启用 HTTPS 加密，从而提高网络安全性。</p>\n<blockquote>\n<p>Cert Manager 使用 DNS01 验证来自动化地获取和续订由 ACME 服务器（如 Let’s Encrypt）颁发的 SSL&#x2F;TLS 证书。DNS01 要求 Cert Manager 能够创建和删除 DNS TXT 记录，以证明域名的所有权。由此，Cert Manager 需要与 DNS 服务提供商的 API 进行交互。</p>\n</blockquote>\n<blockquote>\n<p>这就是为什么需要像 alidns 的 webhook 这样的组件。Webhook 解析器是 Cert Manager 中的一种机制，它允许开发者创建自定义的逻辑来处理 DNS01 挑战。这些 webhook 解析器作为独立的服务运行，并且能够接收来自 Cert Manager 的 DNS01 验证请求，并执行必要的操作来满足的要求。</p>\n</blockquote>\n<p>Webhook 的作用</p>\n<blockquote>\n<p>当使用 Cert Manager 与具体的 DNS 服务（如 AliDNS）交互时，需要一种方式来自动化更新 DNS 记录的过程。这就是 webhook 发挥作用的地方：</p>\n<ol>\n<li><p><strong>自动化处理</strong>：Webhook 提供了一种机制，通过这种机制 Cert Manager 可以自动向 DNS 提供商请求添加、修改或删除 DNS 记录。这对于自动化证书的申请、续期和撤销过程至关重要。</p>\n</li>\n<li><p><strong>安全访问</strong>：通过 webhook，可以安全地集成第三方服务（如 DNS 提供商），同时遵守最小权限原则。Webhook 通常需要配置相应的 API 凭证，这些凭证应当只赋予修改 DNS 记录所需的权限，从而降低安全风险。</p>\n</li>\n<li><p><strong>提供商特定的逻辑</strong>：不同的 DNS 提供商可能有不同的 API 接口和规则。Webhook 可以封装这些特定的逻辑，使得 Cert Manager 能够以统一的方式处理不同 DNS 提供商的接口。</p>\n</li>\n</ol>\n</blockquote>\n<p>实现细节</p>\n<blockquote>\n<p>例如，在使用AliDNS的场景中，Cert Manager需要一个AliDNS webhook来处理DNS记录的修改。这个webhook负责与AliDNS的API进行交互，执行如下操作：</p>\n<ul>\n<li>当 Cert Manager 需要在 DNS 中创建一个新的 TXT 记录以响应 DNS-01挑战时，webhook 将调用 AliDNS 的 API 来添加该记录。</li>\n<li>完成验证后，webhook 将再次调用 API 删除该 TXT 记录，以清理不再需要的记录。</li>\n</ul>\n</blockquote>\n<p>通过这种方式，Cert Manager可以实现完全自动化的证书管理，无需人工干预DNS记录的更新，大大简化了使用SSL&#x2F;TLS证书的复杂性。<br>总的来说，alidns 的 webhook 为 Cert Manager 提供了与阿里云 DNS 服务交互的能力，使得 Cert Manager 能够自动化地完成 DNS01 挑战，从而简化了在 Kubernetes 集群中管理 SSL&#x2F;TLS 证书的过程。</p>\n</blockquote>\n<h4 id=\"安装-alidns-webhook-两种webhook\"><a href=\"#安装-alidns-webhook-两种webhook\" class=\"headerlink\" title=\"安装 alidns-webhook (两种webhook)\"></a>安装 alidns-webhook (两种webhook)</h4><ul>\n<li><p>helm（本例使用）</p>\n</li>\n<li><p>reference： <a href=\"https://github.com/DEVmachine-fr/cert-manager-alidns-webhook\">GitHub - DEVmachine-fr&#x2F;cert-manager-alidns-webhook: Cert-manager webhook to generate Let’s Encrypt certificates over Alibaba Cloud DNS.</a></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 部署 阿里云 DNS Webhook，groupName的值修改为自己的域名</span>\nhelm repo <span class=\"token function\">add</span> cert-manager-alidns-webhook https://devmachine-fr.github.io/cert-manager-alidns-webhook\nhelm repo update\nhelm upgrade <span class=\"token parameter variable\">-i</span> alidns-webhook cert-manager-alidns-webhook/alidns-webhook <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--set</span> <span class=\"token assign-left variable\">groupName</span><span class=\"token operator\">=</span>acme.chaoslong.cn<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>另一个 manifest 文件安装（使用有不同）</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://raw.githubusercontent.com/pragkent/alidns-webhook/master/deploy/bundle.yaml\n\n<span class=\"token comment\"># 修改文件中的acme.yourcompany.com为自己的域名</span>\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s/<span class=\"token string\">'acme.yourcompany.com'</span>/<span class=\"token string\">'acme.chaoslong.cn'</span>/g bundle.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"Secret-of-AliDNS-Access\"><a href=\"#Secret-of-AliDNS-Access\" class=\"headerlink\" title=\"Secret of AliDNS Access\"></a>Secret of AliDNS Access</h3><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Secret\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alidns<span class=\"token punctuation\">-</span>secret\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> cert<span class=\"token punctuation\">-</span>manager\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Opaque\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">accesskey-id</span><span class=\"token punctuation\">:</span> xxxxxxxxxxxxxxxx  <span class=\"token comment\"># echo -n \"shdhd\" | base64 ; echo -n 参数没换行符输出</span>\n  <span class=\"token key atrule\">accesskey-secret</span><span class=\"token punctuation\">:</span> xxxxxxxxxxxx\n\n或者\n\nkubectl create secret generic alidns<span class=\"token punctuation\">-</span>secrets <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from<span class=\"token punctuation\">-</span>literal=\"access<span class=\"token punctuation\">-</span>token=xxxxxxx\" <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from<span class=\"token punctuation\">-</span>literal=\"secret<span class=\"token punctuation\">-</span>key=xxxxxxxxxx\"<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"Create-Letsencrypt-clusterissuer\"><a href=\"#Create-Letsencrypt-clusterissuer\" class=\"headerlink\" title=\"Create Letsencrypt clusterissuer\"></a>Create Letsencrypt clusterissuer</h3><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> cert<span class=\"token punctuation\">-</span>manager.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterIssuer\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> letsencrypt<span class=\"token punctuation\">-</span>staging\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> cert<span class=\"token punctuation\">-</span>manager\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">acme</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Change to your letsencrypt email</span>\n    <span class=\"token key atrule\">email</span><span class=\"token punctuation\">:</span> chao.long@keyword.net\n    <span class=\"token comment\"># 测试阶段可以用 staging （无限制）</span>\n    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//acme<span class=\"token punctuation\">-</span>staging<span class=\"token punctuation\">-</span>v02.api.letsencrypt.org/directory\n    <span class=\"token comment\"># 正式</span>\n    <span class=\"token comment\"># server: https://acme-v02.api.letsencrypt.org/directory </span>\n    <span class=\"token key atrule\">privateKeySecretRef</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> letsencrypt<span class=\"token punctuation\">-</span>staging<span class=\"token punctuation\">-</span>acme<span class=\"token punctuation\">-</span>count <span class=\"token comment\"># 如果不存在将创建，用以存放一个私钥，作为 ACME 账户的私钥，用于与 ACME 服务器进行安全通信</span>\n    <span class=\"token key atrule\">solvers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">dns01</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">webhook</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">groupName</span><span class=\"token punctuation\">:</span> chaoslong.cn  <span class=\"token comment\">#同于webhook安装中的值</span>\n          <span class=\"token key atrule\">solverName</span><span class=\"token punctuation\">:</span> alidns   <span class=\"token comment\"># 固定</span>\n          <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n            <span class=\"token key atrule\">secretKeySecretRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alidns<span class=\"token punctuation\">-</span>secret\n              <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> accesskey<span class=\"token punctuation\">-</span>id\n            <span class=\"token key atrule\">accessTokenSecretRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alidns<span class=\"token punctuation\">-</span>secret\n              <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> accesskey<span class=\"token punctuation\">-</span>secret\n    selector：    <span class=\"token comment\"># 当 cert-manager 处理证书请求时，它将只为这些 DNS 区域中的域名创建和更新 DNS 记录。</span>\n      <span class=\"token key atrule\">dnsZones</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'mydomdom.org'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'*.mydomdom.org'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>手动生成证书<br><code>certificates</code> -&gt; <code>certificaterequests</code> -&gt; <code>orders</code> -&gt; <code>challenges</code>.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apiVersion: cert-manager.io&#x2F;v1\nkind: Certificate\nmetadata:\n  name: chaoslong-test-tls\n  # 指定证书生成到哪个工作空间，不指定也可以\n  namespace: cert-manager\nspec:\n  #生成后证书的secret名称\n  secretName: chaoslong-test-tls\n  duration: 24h\n  # 指定域名\n  dnsNames:\n  - &quot;chaoslong.cn&quot;\n  - &quot;*.chaoslong.cn&quot;\n  issuerRef:\n    name: letsencrypt-staging\n    kind: ClusterIssuer<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>[!debug]<br> 此时以上各种新增资源一直是 pending 或者 unavailable; accesskey 解析一直失败<br> 排查发现：<br> <pre class=\"line-numbers language-none\"><code class=\"language-none\">- dns01:\n        webhook: \n          config: \n            accessTokenSecretRef:     # 此处书写错误，使用了另一个 webhook 的变量，正确的如此配置\n              key: access-token        # 这是 asccesskey 的 id\n              name: alidns-secrets \n            region: &#39;&#39; \n            secretKeySecretRef:\n              key: secret-key      # 这是 accesskey 的 secert\n              name: alidns-secrets  <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>certmanager 如果成功调用 webhook，会在证书验证过程中生成一个 challenge 的 TXT 记录到 DNS，判断域名的所有权\\</p>\n</blockquote>\n<blockquote>\n<p>[!success] Valid 描述<br>创建 certificates 资源之后，challenges 和 orders 会相应生成，在验证过程中会有一段较长的时间等待世界 DNS 缓存刷新（会生成一个 cert.doamin.cn）。<br>最终状态正常之后，challenges 删除，其 txt 记录也会被删除，存放证书内容的 tls-secret 状态将变为合法，其中会存储有证书内容。</p>\n</blockquote>\n<h2 id=\"待尝试\"><a href=\"#待尝试\" class=\"headerlink\" title=\"待尝试\"></a>待尝试</h2><h2 id=\"Vault-保存证书\"><a href=\"#Vault-保存证书\" class=\"headerlink\" title=\"Vault 保存证书\"></a>Vault 保存证书</h2><h2 id=\"应用通过-ESO-请求证书\"><a href=\"#应用通过-ESO-请求证书\" class=\"headerlink\" title=\"应用通过 ESO 请求证书\"></a>应用通过 ESO 请求证书</h2>"},{"title":"clickhouse","author":"LC","toc":true,"date":"2024-04-30T15:20:00.000Z","img":null,"top":null,"cover":null,"password":null,"summary":"clickhouse 集群简单尝试","_content":"\n(未曾指定数据目录，仍在原有的系统路径)\n(metrika.xml  是否可以选择配置主机变量)\n\n## 一、 安装JDK----zookeeper集群需要\n-------\n\n#### 1.  集群需要的机器安装java环境\n----------------------------\n\n```\nsudo apt-get install -y openjdk-8-jdk\nvim /etc/profile                                          # 环境变量，此为系统全局配置，本项目还应对zookeeper进行声明；注意声明时分割，加上:$变量名，避免覆盖\n    export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64    [[是]] Java 编程语言 JDK 的顶级目录，软件安装的本地路径，便于定义$path \n    export PATH=PATH=$JAVA_HOME/bin:$PATH                 [[PATH]] 用于指定可执行的二进制文件的位置，此变量不为空，每次声明应加上:$path，避免覆盖\n    export CLASSPATH=                                     # 指运行程序所需要的 class 文件的位置,有参考贴说其实非必需，本实验未定义\nsource /etc/profile\njava -version 或 javac -version 检查\n```\n#### 2.  搭建zookeeper集群\n- 元数据管理、集群配置和协调 \n------------------------------------\n```\ntee >> /etc/hosts << EOF\n10.13.3.107 server1\n10.13.3.106 server2\n10.13.3.105 server3\nEOF\n\nmkdir /usr/local/zookeeper\ncd /opt && wget https://dlcdn.apache.org/zookeeper/zookeeper-3.8.3/apache-zookeeper-3.8.3-bin.tar.gz\nmkdir -p /usr/local/zookeeper/{datadir,logdir}\ntar -zxvf /opt/apache-zookeeper-3.8.3-bin.tar.gz -C /usr/local/zookeeper --strip-components=1\necho 1 > /usr/local/zookeeper/datadir/myid\nvim zookeeper/conf/zoo.cfg\n```\n**zoo.cfg 内容如下**\n```\ntickTime=2000\ninitLimit=10\nsyncLimit=5\ndataDir=/usr/local/zookeeper/datadir     # 此处两个目录需要创建，并指定自身实际路径\ndataLogDir=/usr/local/zookeeper/logdir  \nclientPort=2181\nserver.1=server1:2288:3388                         [[集群信息]],host:心跳端口:数据端口（此处写主机名需要在/etc/hosts做自解析）\nserver.2=server2:2288:3388                         [[server]].1--唯一标识符，1需要写入存放数据的data/myid 文件中(可以是任意数字，只要二者一致)\nserver.3=server3:2288:3388                         [[服务器]] Follower 与集群中的 Leader 交换信息的端口:万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，用来执行选举时服务器相互通信的端口\n\n-----------以下为j2模板文件写法\n{% for host in groups['inboc_dev_clickhouse_group']%}\nserver.{{ loop.index }}={{hostvars[host].ansible_host}}:2288:3388\n{% endfor %}\n```\n>三台机器都相同配置，需***自解析***，但是注意分别 echo 2/3 > datadir/myid\n>pwd\n  /usr/local/zookeeper\n```\nrsync -avz  zookeeper  root@10.13.3.107:/usr/local/zookeeper/zookeeper\nrsync -avz  /etc/hosts  root@10.13.3.107:/etc/\nsource /etc/hosts\n```\n**systemd 管理**\n```\ntee /etc/systemd/system/zookeeper.service << EOF\n[Unit]  \nDescription=Apache ZooKeeper distributed coordination server  \nAfter=network.target  \n  \n[Service]  \nType=forking  \nExecStart=/usr/local/zookeeper/bin/zkServer.sh start  \nExecStop=/usr/local/zookeeper/bin/zkServer.sh stop  \nRestart=on-abnormal  \n  \n[Install]  \nWantedBy=multi-user.target\nEOF\n\nsystemctl daemon-reload\n```\n**启服务,查看状态**\n```\nsystemctl enable --now zookeeper\nsystemctl status zookeeper\n```   \n\n\n## 二、 单节点安装，集群内各节点机器均需要安装clickhouse\n---------------------\n\n```\nsudo apt-get install apt-transport-https ca-certificates dirmngr\nsudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754\n\necho \"deb https://packages.clickhouse.com/deb stable main\" | sudo tee \\\n    /etc/apt/sources.list.d/clickhouse.list\nsudo apt-get update\n\nsudo apt-get install -y clickhouse-server clickhouse-client\n\nsudo service clickhouse-server start    [[此句是启动clickhouse的服务]]\nclickhouse-client # or \"clickhouse-client --password\"  # 启动客户端\n```\n\n## 三、 clickhouse配置集群\n------------------------\n\n**vim config.xml**\n```\n<listen_host>0.0.0.0</listen_host>\n<remote_servers></remote_servers>                                 [[此标签内的local, test集群可以注释，不用留下，注释内不能包含注释]]<!--  -->  ( ansible 中 j2 模板会删除这些行的内容)\n<include_from>/etc/clickhouse-server/metrika.xml</include_from>   [[此句配置在metrika]].xml段落描述之后，文件为集群配置，但是打了引入标签仍然未识别成功metrika.xml文件路径，将其移动到config.d目录下，成功建立集群\n```\n\nvim metrika.xml\n```\n<yandex>                       <!--此为3分片2副本-->\n    <remote_servers>           <!--集群标签-->\n        <ck_cluster>           <!--集群名称-->\n            <shard>            <!--分片标签-->\n                <internal_replication>true</internal_replication>   <!--集群内复制功能-->\n                <replica>                                           <!--副本标签，副本指所有文件数量-->      \n                    <host>10.13.3.107</host>                        <!--存储本分片的第一个副本的机器-->\n                    <port>9000</port>\n                </replica>\n                <replica>\n                    <host>10.13.3.108</host>                        <!--存储本分片的第二个副本的机器-->\n                    <port>9000</port>\n                </replica>\n            </shard>\n            <shard>\n                <internal_replication>true</internal_replication>\n                <replica>\n                    <host>10.13.3.108</host>\n                    <port>9000</port>\n                </replica>\n                <replica>\n                    <host>10.13.3.109</host>\n                    <port>9000</port>\n                </replica>\n            </shard>\n            <shard>\n                <internal_replication>true</internal_replication>\n                <replica>\n                    <host>10.13.3.109</host>\n                    <port>9000</port>\n                </replica>\n                <replica>\n                    <host>10.13.3.107</host>\n                    <port>9000</port>\n                </replica>\n            </shard>\n        </ck_cluster>\n    </remote_servers>\n    <zookeeper>                                    <!--连接zookeeper集群的配置-->\n        <node index=\"1\">                           <!--zookeeper集群内的主机唯一标识符-->\n            <host>server1</host>                   <!--主机名/IP-->\n            <port>2181</port>\n        </node>\n        <node  index=\"2\">\n            <host>server2</host>\n            <port>2181</port>\n        </node>\n        <node index=\"3\">\n            <host>server3</host>\n            <port>2181</port>\n        </node>\n    </zookeeper>\n    <!--macros>                                   <!--定义宏，在 SQL 查询中使用，以便动态地引用集群中的不同分片和副本--><!--创建集群时非必须-->\n        <shard>03</shard>                         <!--第3分片-->（可以视为一个index）\n        <replica>03_1</replica>                   <!--第3分片第1副本-->（可以视为一个主机唯一连接，比如IP、hostname）\n    </macros>\n    <macros>                                      <!--sql使用举例：SELECT COUNT(*) FROM my_table WHERE _shard = '03' AND _replica = '03_1'-->\n        <shard>02</shard>                         <!--该标签写法和用法有待斟酌-->\n        <replica>02_2</replica>\n    </macros-->\n    <networks>                                    <!--配置选项允许 Yandex.Metrica 监听来自任何 IPv4 地址的请求-->       \n        <ip>0.0.0.0</ip>\n    </networks>\n\n    <compression>                                 <!--指定数据在写入到磁盘之前或从磁盘读取之后的压缩方式-->\n        <case>\n            <min_part_size>10000000000</min_part_size>\n            <min_part_size_ratio>0.01</min_part_size_ratio>\n            <method>lz4</method>\n        </case>\n    </compression>\n</yandex>\n\n```\n\n\t根据以上配置文件，这个 ClickHouse 集群中的每个分片都有两个副本，在这个配置中并没有显式地设置 `parallel_replicas` 参数。因此，如果没有进行额外的配置，这个集群默认情况下在进行分布式查询时，每个分片的两个副本都可以参与查询处理，但是并行副本数量可能会受到其他因素的限制，如数据分片、查询复杂度等。 \n\t如果需要进一步控制并行副本数量，可以在查询中使用 `SETTINGS max_parallel_replicas` 参数或者在配置文件中设置 `max_parallel_replicas` 参数，以限制每个查询中使用的最大并行副本数量。\n\nvim users.xml\n```\n<users>\n    <!-- If user name was not specified, 'default' user is used. -->\n    <user_name>                                                     <!--用户名-->\n        <password></password>                                       <!--明文密码，不推荐-->\n        <!-- Or -->\n        <password_sha256_hex> </password_sha256_hex>                 <!--放置用shell生成SHA256加密密码-->()\n\n        <access_management> 0|1 </access_management>                  <!--不允许 | 允许sql语句生成账户-->\n\n        <networks incl=\"networks\" replace=\"replace\">\n        <networks>                                                  <!--用户来源访问控制-->\n             <ip>::/0</ip>\n        </networks>\n        <profile>profile_name</profile>                             <!--对配置做设置的文件名，其中有单独配置段-->\n\n        <quota>default</quota>                                      <!--对用户资源配额做设置的文件-->\n\n        <databases>                                                 <!--限制ClickHouse中由当前用户进行的 `SELECT` 查询所返回的行，从而实现基本的行级安全性--> \n            <database_name>\n                <table_name>\n                    <filter>expression</filter>                     <!--可以是[UInt8]编码的任何表达式。 它通常包含比较和逻辑运算符, 当filter返回0时, database_name.table1 的该行结果将不会返回给用户-->\n                <table_name>\n            </database_name>\n        </databases>\n    </user_name>\n    <!-- Other users settings -->\n</users>\n```\n\n```\nSHA256生成密码，利用随机数生成密码，-c 表示需要生成的长度；\n\nPASSWORD=$(base64 < /dev/urandom | head -c14); echo \"$PASSWORD\"; echo -n \"$PASSWORD\" | sha256sum | tr -d '-'\n生成的第一行为明文密码，用于自己使用；第二行为 sha256 加密字符串，需要配置到下面标签中：\n```\n\n各节点重启，并检查\n```\nsystemctl restart clickhouse-server\nclickhouse-client -m\n\tselect * from system.clusters;\n\tSELECT * FROM system.zookeeper WHERE path = '/'；\n```\n\n\n检查连接：8123、9000端口\n```\n1. echo 'show databases' | curl -H 'X-ClickHouse-User: default' -H 'X-ClickHouse-Key: Inboc@2020' 'http://10.13.3.101:8123/' -d @-\n2. clickhouse-client 登录 使用local:9000,\n3. datagrip工具，使用9000端口，用户和密码，可以登录\n```\n\n-------------------\n使用出现的问题：\nPython连接8123端口不成功,users.xml 配置错误，删除后可以使用。\n\n--------------------\n\n以下是metrika.xml.j2循环和自动获取\n```\n<ck_cluster>  \n{% for shard_host in groups['inboc-dev-clickhouse-group'] %}  \n  \n    <shard>  \n        <internal_replication>true</internal_replication>  \n        {% for replica_host in groups['inboc-dev-clickhouse-group'] %}  \n        {% if shard_host != replica_host %}  \n  \n        <replica>  \n            <host>{{ hostvars[replica_host].inventory_hostname }}</host>  \n            <port>9000</port>  \n        </replica>  \n        {% endif %}  \n        {% endfor %}  \n  \n    </shard>  \n  \n{% endfor %}  \n\n</ck_cluster>\n```\n\n```\n<zookeeper>  \n{% for host in groups['inboc-dev-clickhouse-group'] %}  \n  \n    <node index={{ loop.index }}>  \n        <host>{{ hostvars[host].ansible_host }}</host>  \n        <port>2181</port>  \n    </node>  \n{% endfor %}  \n  \n</zookeeper>\n```\n\n## 四、维护使用\n----------------\n#### 1. 配置解析\n **config.xml**\n```\n    <logger>                                                    <!--日志设置-->\n        <console>true</console>                                 <!--是否将日志输出到控制台-->\n        <level>trace</level>                                    <!--日志级别，可以是debug/info/warning/error;trace是输出所有、建议设置为info/warning-->\n        <log>/var/log/clickhouse-server/clickhouse-server.log</log>     <!--日志文件路径-->\n        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>       \n        <size>1000M</size>                                        <!--日志文件最大size-->\n        <count>10</count>                                         <!--日志文件最大数量-->\n        <levels>\n          <ConfigReloader>none</ConfigReloader>                  <!--是否允许服务在运行中响应配置文件变化-->\n        </levels>\n    </logger>\n    \n    <interserver_listen_host>::</interserver_listen_host>        <!--监听集群内节点机器的IP地址，适用于节点有多个网络接口的情况-->\n    <max_connections>4096</max_connections>                      <!--可以同时处理的最大客户端连接数-->\n    <max_concurrent_queries>100</max_concurrent_queries>         <!--允许同事处理的最大查询数量-->\n    <keep_alive_timeout>3</keep_alive_timeout>                   <!--心跳时间-->\n    <max_server_memory_usage>0</max_server_memory_usage>         <!--允许服务器最多可以使用的内存量,单位是字节-->   \n    <max_server_memory_usage_to_ram_ratio>0.9</max_server_memory_usage_to_ram_ratio>   <!--ClickHouse服务器可以使用的内存量与系统总内存量之间的比例-->\n    <max_open_files>262144</max_open_files>                       <!--系统同时打开的最大文件数-->\n    <uncompressed_cache_size>8589934592</uncompressed_cache_size>  <!--指定了在内存中用于缓存未压缩块的空间大小-->\n    <mark_cache_size>5368709120</mark_cache_size>                   <!--指定在内存中用于缓存标记的空间大小-->\n\t<path>/var/lib/clickhouse/</path>                               <!--数据存储位置，需要带斜杠指定到目录内-->\n\t<user_files_path>/var/lib/clickhouse/user_files/</user_files_path>            <!--设置用户上传文件的存储路径-->\n\t<path>/var/lib/clickhouse/access/</path>                             <!--存储由SQL命令创建的用户的文件夹的路径-->\n    <default_database>default</default_database>                         <!--默认的数据库名称-->\n\t<prometheus>                                                         <!--prometheus监控-->\n        <endpoint>/metrics</endpoint>                                  \n        <port>9363</port>\n        <metrics>true</metrics>                                          \n        <events>true</events>\n        <asynchronous_metrics>true</asynchronous_metrics>\n        <status_info>true</status_info>\n    </prometheus>\n    <query_log>                                                <!--需要log_queries=1，记录接收到的查询。查询记录在system.query_log表，而不记录在单独文件中-->\n\t    <database>system</database>   --库名\n\t    <table>query_log</table>   --表名\n\t    <partition_by>toMonday(event_date)</partition_by>  --自定义分区键\n\t    <flush_interval_milliseconds>7500</flush_interval_milliseconds>  --将数据从内存中的缓冲区刷新到表的时间间隔\n\t</query_log>\n\t<query_thread_log>\n        <database>system</database>     --库名\n\t    <table>query_thread_log</table>  --接收数据写入的系统日志表名\n\t    <partition_by>toMonday(event_date)</partition_by>  --自定义分区键\n\t    <flush_interval_milliseconds>7500</flush_interval_milliseconds>  --将数据从内存中的缓冲区刷新到表的时间间隔\n\t</query_thread_log>\n\n\n```\n\n#### 2. 重要路径 （默认未修改）\n\n| 名称 | 路径 |\n| :---: | :---: |\n|log|/var/log/clickhouse-server/clickhouse-server.log|\n| errorlog |/var/log/clickhouse-server/clickhouse-server.err.log|\n|data|/var/lib/clickhouse/access/|\n|user_files|/var/lib/clickhouse/user_files/|\n\n#### 3. 优化\n1. 日志级别设置为info(实践一次，并未成功，暂无原因)\n2. 以及zookeeper日志，通过设定环境变量配置日志级别和输出方式，ZOO_LOG4J_PROP=\"INFO,ROLLINGFILE\"\n3. 配置监控，基于metric、prometheus&grafana\n----------------\n#### 4. 系统表\n1. 存储于 `system` 数据库，提供信息包括：服务器的状态、进程、环境、服务器的内部进程\n2. system.cluster\n|字段|信息|\n|:---:|:---:|\n|cluster|集群名|\n|shard_num|集群中的分片数，从1开始|\n|shard_weight|写数据时该分片的相对权重|\n|replica_num|分片的副本数量，从1开始|\n|host_name|配置中指定的主机名|\n|host_address|从DNS获取的主机IP地址|\n|port|连接到服务器的端口|\n|user|连接到服务器的用户名|\n|errors_count| 此主机无法访问副本的次数|\n|slowdowns_count|与对冲请求建立连接时导致更改副本的减速次数|\n|estimated_recovery_time|剩下的秒数，直到副本错误计数归零并被视为恢复正常|\n3. system.metrics\n|metric|value|description|信息|\n|:---:|:---:|:---:|:---:|\n|Query|1|Number of executing queries|执行查询的数量|\n|Merge|0|Number of executing background merges|后台合并的数量|\n| PartMutation |0|Number of mutations (ALTER DELETE/UPDATE)|数据删除、更新操作数|\n|ReplicatedFetch| 0|Number of data parts being fetched from replicas|从副本中获取的数据块的数量|\n| ReplicatedSend |0|Number of data parts being sent to replicas|向副本传递的数据块的数量|\n|ReplicatedChecks|0|Number of data parts checking for consistency|正在进行一致性检查的数据块数量|\n|BackgroundMergesAndMutationsPoolTask|0 |Number of active merges and mutations in an associated background pool |后台线程池中活跃的合并和更新数量|\n|BackgroundFetchesPoolTask |0 |Number of active fetches in an associated background pool |正在使用后台线程池执行的查询的并发数|\n|BackgroundCommonPoolTask |0|Number of active tasks in an associated background pool|正在执行的任务数|\n|BackgroundMovePoolTask | 0 |Number of active tasks in BackgroundProcessingPool for moves|正在执行的数据迁移任务的数量|\n\n -----------\n#### 5. 运维常见问题排查和参考。（参考链接）\n1. [博客园--clickhouse常见问题排查](https://www.cnblogs.com/qiu-hua/p/15113806.html)涉及副本节点不一致、副本节点全量恢复......\n2. [本地备份](https://www.kubesre.com/archives/clickhousebei-fen-yu-hui-fu)\n3. [基于复制的故障恢复](http://jackpgao.github.io/2017/12/18/ClickHouse-Recovery-basedon-Replication/)节点宕机不可恢复、新增节点到集群的方案介绍\n4. [ClickHouse 集群分片下扩容副本的方式](https://opensource.actionsky.com/20211111-clickhouse/)\n#### 6.扩容\n   1. 增加机器--zookeeper 安装、clickhouse 安装、做自解析\n   2. 修改配置文件，增加扩容分片，配置其中的副本节点（最好修改权重）、配置zookeeper\n   3. 启动新节点，创建本地表和分布式表\n   4. 对旧节点做配置修改\n   5. 测试（某节点宕机数据不可恢复时，应能采取相同步骤对集群新增节点恢复集群架构、或许引擎树的选择将影响是否需要手动传输历史数据）\n   6. [集群参考贴](https://blog.51cto.com/feko/2738319)\n   ","source":"_posts/clickhouse.md","raw":"---\ntitle: clickhouse\nauthor: LC\ntoc: true\ndate: 2024-04-30 23:20:00\nimg:\ntop:\ncover:\npassword:\nsummary: clickhouse 集群简单尝试\ncategories: Database\ntags: [clickhouse]\n---\n\n(未曾指定数据目录，仍在原有的系统路径)\n(metrika.xml  是否可以选择配置主机变量)\n\n## 一、 安装JDK----zookeeper集群需要\n-------\n\n#### 1.  集群需要的机器安装java环境\n----------------------------\n\n```\nsudo apt-get install -y openjdk-8-jdk\nvim /etc/profile                                          # 环境变量，此为系统全局配置，本项目还应对zookeeper进行声明；注意声明时分割，加上:$变量名，避免覆盖\n    export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64    [[是]] Java 编程语言 JDK 的顶级目录，软件安装的本地路径，便于定义$path \n    export PATH=PATH=$JAVA_HOME/bin:$PATH                 [[PATH]] 用于指定可执行的二进制文件的位置，此变量不为空，每次声明应加上:$path，避免覆盖\n    export CLASSPATH=                                     # 指运行程序所需要的 class 文件的位置,有参考贴说其实非必需，本实验未定义\nsource /etc/profile\njava -version 或 javac -version 检查\n```\n#### 2.  搭建zookeeper集群\n- 元数据管理、集群配置和协调 \n------------------------------------\n```\ntee >> /etc/hosts << EOF\n10.13.3.107 server1\n10.13.3.106 server2\n10.13.3.105 server3\nEOF\n\nmkdir /usr/local/zookeeper\ncd /opt && wget https://dlcdn.apache.org/zookeeper/zookeeper-3.8.3/apache-zookeeper-3.8.3-bin.tar.gz\nmkdir -p /usr/local/zookeeper/{datadir,logdir}\ntar -zxvf /opt/apache-zookeeper-3.8.3-bin.tar.gz -C /usr/local/zookeeper --strip-components=1\necho 1 > /usr/local/zookeeper/datadir/myid\nvim zookeeper/conf/zoo.cfg\n```\n**zoo.cfg 内容如下**\n```\ntickTime=2000\ninitLimit=10\nsyncLimit=5\ndataDir=/usr/local/zookeeper/datadir     # 此处两个目录需要创建，并指定自身实际路径\ndataLogDir=/usr/local/zookeeper/logdir  \nclientPort=2181\nserver.1=server1:2288:3388                         [[集群信息]],host:心跳端口:数据端口（此处写主机名需要在/etc/hosts做自解析）\nserver.2=server2:2288:3388                         [[server]].1--唯一标识符，1需要写入存放数据的data/myid 文件中(可以是任意数字，只要二者一致)\nserver.3=server3:2288:3388                         [[服务器]] Follower 与集群中的 Leader 交换信息的端口:万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，用来执行选举时服务器相互通信的端口\n\n-----------以下为j2模板文件写法\n{% for host in groups['inboc_dev_clickhouse_group']%}\nserver.{{ loop.index }}={{hostvars[host].ansible_host}}:2288:3388\n{% endfor %}\n```\n>三台机器都相同配置，需***自解析***，但是注意分别 echo 2/3 > datadir/myid\n>pwd\n  /usr/local/zookeeper\n```\nrsync -avz  zookeeper  root@10.13.3.107:/usr/local/zookeeper/zookeeper\nrsync -avz  /etc/hosts  root@10.13.3.107:/etc/\nsource /etc/hosts\n```\n**systemd 管理**\n```\ntee /etc/systemd/system/zookeeper.service << EOF\n[Unit]  \nDescription=Apache ZooKeeper distributed coordination server  \nAfter=network.target  \n  \n[Service]  \nType=forking  \nExecStart=/usr/local/zookeeper/bin/zkServer.sh start  \nExecStop=/usr/local/zookeeper/bin/zkServer.sh stop  \nRestart=on-abnormal  \n  \n[Install]  \nWantedBy=multi-user.target\nEOF\n\nsystemctl daemon-reload\n```\n**启服务,查看状态**\n```\nsystemctl enable --now zookeeper\nsystemctl status zookeeper\n```   \n\n\n## 二、 单节点安装，集群内各节点机器均需要安装clickhouse\n---------------------\n\n```\nsudo apt-get install apt-transport-https ca-certificates dirmngr\nsudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754\n\necho \"deb https://packages.clickhouse.com/deb stable main\" | sudo tee \\\n    /etc/apt/sources.list.d/clickhouse.list\nsudo apt-get update\n\nsudo apt-get install -y clickhouse-server clickhouse-client\n\nsudo service clickhouse-server start    [[此句是启动clickhouse的服务]]\nclickhouse-client # or \"clickhouse-client --password\"  # 启动客户端\n```\n\n## 三、 clickhouse配置集群\n------------------------\n\n**vim config.xml**\n```\n<listen_host>0.0.0.0</listen_host>\n<remote_servers></remote_servers>                                 [[此标签内的local, test集群可以注释，不用留下，注释内不能包含注释]]<!--  -->  ( ansible 中 j2 模板会删除这些行的内容)\n<include_from>/etc/clickhouse-server/metrika.xml</include_from>   [[此句配置在metrika]].xml段落描述之后，文件为集群配置，但是打了引入标签仍然未识别成功metrika.xml文件路径，将其移动到config.d目录下，成功建立集群\n```\n\nvim metrika.xml\n```\n<yandex>                       <!--此为3分片2副本-->\n    <remote_servers>           <!--集群标签-->\n        <ck_cluster>           <!--集群名称-->\n            <shard>            <!--分片标签-->\n                <internal_replication>true</internal_replication>   <!--集群内复制功能-->\n                <replica>                                           <!--副本标签，副本指所有文件数量-->      \n                    <host>10.13.3.107</host>                        <!--存储本分片的第一个副本的机器-->\n                    <port>9000</port>\n                </replica>\n                <replica>\n                    <host>10.13.3.108</host>                        <!--存储本分片的第二个副本的机器-->\n                    <port>9000</port>\n                </replica>\n            </shard>\n            <shard>\n                <internal_replication>true</internal_replication>\n                <replica>\n                    <host>10.13.3.108</host>\n                    <port>9000</port>\n                </replica>\n                <replica>\n                    <host>10.13.3.109</host>\n                    <port>9000</port>\n                </replica>\n            </shard>\n            <shard>\n                <internal_replication>true</internal_replication>\n                <replica>\n                    <host>10.13.3.109</host>\n                    <port>9000</port>\n                </replica>\n                <replica>\n                    <host>10.13.3.107</host>\n                    <port>9000</port>\n                </replica>\n            </shard>\n        </ck_cluster>\n    </remote_servers>\n    <zookeeper>                                    <!--连接zookeeper集群的配置-->\n        <node index=\"1\">                           <!--zookeeper集群内的主机唯一标识符-->\n            <host>server1</host>                   <!--主机名/IP-->\n            <port>2181</port>\n        </node>\n        <node  index=\"2\">\n            <host>server2</host>\n            <port>2181</port>\n        </node>\n        <node index=\"3\">\n            <host>server3</host>\n            <port>2181</port>\n        </node>\n    </zookeeper>\n    <!--macros>                                   <!--定义宏，在 SQL 查询中使用，以便动态地引用集群中的不同分片和副本--><!--创建集群时非必须-->\n        <shard>03</shard>                         <!--第3分片-->（可以视为一个index）\n        <replica>03_1</replica>                   <!--第3分片第1副本-->（可以视为一个主机唯一连接，比如IP、hostname）\n    </macros>\n    <macros>                                      <!--sql使用举例：SELECT COUNT(*) FROM my_table WHERE _shard = '03' AND _replica = '03_1'-->\n        <shard>02</shard>                         <!--该标签写法和用法有待斟酌-->\n        <replica>02_2</replica>\n    </macros-->\n    <networks>                                    <!--配置选项允许 Yandex.Metrica 监听来自任何 IPv4 地址的请求-->       \n        <ip>0.0.0.0</ip>\n    </networks>\n\n    <compression>                                 <!--指定数据在写入到磁盘之前或从磁盘读取之后的压缩方式-->\n        <case>\n            <min_part_size>10000000000</min_part_size>\n            <min_part_size_ratio>0.01</min_part_size_ratio>\n            <method>lz4</method>\n        </case>\n    </compression>\n</yandex>\n\n```\n\n\t根据以上配置文件，这个 ClickHouse 集群中的每个分片都有两个副本，在这个配置中并没有显式地设置 `parallel_replicas` 参数。因此，如果没有进行额外的配置，这个集群默认情况下在进行分布式查询时，每个分片的两个副本都可以参与查询处理，但是并行副本数量可能会受到其他因素的限制，如数据分片、查询复杂度等。 \n\t如果需要进一步控制并行副本数量，可以在查询中使用 `SETTINGS max_parallel_replicas` 参数或者在配置文件中设置 `max_parallel_replicas` 参数，以限制每个查询中使用的最大并行副本数量。\n\nvim users.xml\n```\n<users>\n    <!-- If user name was not specified, 'default' user is used. -->\n    <user_name>                                                     <!--用户名-->\n        <password></password>                                       <!--明文密码，不推荐-->\n        <!-- Or -->\n        <password_sha256_hex> </password_sha256_hex>                 <!--放置用shell生成SHA256加密密码-->()\n\n        <access_management> 0|1 </access_management>                  <!--不允许 | 允许sql语句生成账户-->\n\n        <networks incl=\"networks\" replace=\"replace\">\n        <networks>                                                  <!--用户来源访问控制-->\n             <ip>::/0</ip>\n        </networks>\n        <profile>profile_name</profile>                             <!--对配置做设置的文件名，其中有单独配置段-->\n\n        <quota>default</quota>                                      <!--对用户资源配额做设置的文件-->\n\n        <databases>                                                 <!--限制ClickHouse中由当前用户进行的 `SELECT` 查询所返回的行，从而实现基本的行级安全性--> \n            <database_name>\n                <table_name>\n                    <filter>expression</filter>                     <!--可以是[UInt8]编码的任何表达式。 它通常包含比较和逻辑运算符, 当filter返回0时, database_name.table1 的该行结果将不会返回给用户-->\n                <table_name>\n            </database_name>\n        </databases>\n    </user_name>\n    <!-- Other users settings -->\n</users>\n```\n\n```\nSHA256生成密码，利用随机数生成密码，-c 表示需要生成的长度；\n\nPASSWORD=$(base64 < /dev/urandom | head -c14); echo \"$PASSWORD\"; echo -n \"$PASSWORD\" | sha256sum | tr -d '-'\n生成的第一行为明文密码，用于自己使用；第二行为 sha256 加密字符串，需要配置到下面标签中：\n```\n\n各节点重启，并检查\n```\nsystemctl restart clickhouse-server\nclickhouse-client -m\n\tselect * from system.clusters;\n\tSELECT * FROM system.zookeeper WHERE path = '/'；\n```\n\n\n检查连接：8123、9000端口\n```\n1. echo 'show databases' | curl -H 'X-ClickHouse-User: default' -H 'X-ClickHouse-Key: Inboc@2020' 'http://10.13.3.101:8123/' -d @-\n2. clickhouse-client 登录 使用local:9000,\n3. datagrip工具，使用9000端口，用户和密码，可以登录\n```\n\n-------------------\n使用出现的问题：\nPython连接8123端口不成功,users.xml 配置错误，删除后可以使用。\n\n--------------------\n\n以下是metrika.xml.j2循环和自动获取\n```\n<ck_cluster>  \n{% for shard_host in groups['inboc-dev-clickhouse-group'] %}  \n  \n    <shard>  \n        <internal_replication>true</internal_replication>  \n        {% for replica_host in groups['inboc-dev-clickhouse-group'] %}  \n        {% if shard_host != replica_host %}  \n  \n        <replica>  \n            <host>{{ hostvars[replica_host].inventory_hostname }}</host>  \n            <port>9000</port>  \n        </replica>  \n        {% endif %}  \n        {% endfor %}  \n  \n    </shard>  \n  \n{% endfor %}  \n\n</ck_cluster>\n```\n\n```\n<zookeeper>  \n{% for host in groups['inboc-dev-clickhouse-group'] %}  \n  \n    <node index={{ loop.index }}>  \n        <host>{{ hostvars[host].ansible_host }}</host>  \n        <port>2181</port>  \n    </node>  \n{% endfor %}  \n  \n</zookeeper>\n```\n\n## 四、维护使用\n----------------\n#### 1. 配置解析\n **config.xml**\n```\n    <logger>                                                    <!--日志设置-->\n        <console>true</console>                                 <!--是否将日志输出到控制台-->\n        <level>trace</level>                                    <!--日志级别，可以是debug/info/warning/error;trace是输出所有、建议设置为info/warning-->\n        <log>/var/log/clickhouse-server/clickhouse-server.log</log>     <!--日志文件路径-->\n        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>       \n        <size>1000M</size>                                        <!--日志文件最大size-->\n        <count>10</count>                                         <!--日志文件最大数量-->\n        <levels>\n          <ConfigReloader>none</ConfigReloader>                  <!--是否允许服务在运行中响应配置文件变化-->\n        </levels>\n    </logger>\n    \n    <interserver_listen_host>::</interserver_listen_host>        <!--监听集群内节点机器的IP地址，适用于节点有多个网络接口的情况-->\n    <max_connections>4096</max_connections>                      <!--可以同时处理的最大客户端连接数-->\n    <max_concurrent_queries>100</max_concurrent_queries>         <!--允许同事处理的最大查询数量-->\n    <keep_alive_timeout>3</keep_alive_timeout>                   <!--心跳时间-->\n    <max_server_memory_usage>0</max_server_memory_usage>         <!--允许服务器最多可以使用的内存量,单位是字节-->   \n    <max_server_memory_usage_to_ram_ratio>0.9</max_server_memory_usage_to_ram_ratio>   <!--ClickHouse服务器可以使用的内存量与系统总内存量之间的比例-->\n    <max_open_files>262144</max_open_files>                       <!--系统同时打开的最大文件数-->\n    <uncompressed_cache_size>8589934592</uncompressed_cache_size>  <!--指定了在内存中用于缓存未压缩块的空间大小-->\n    <mark_cache_size>5368709120</mark_cache_size>                   <!--指定在内存中用于缓存标记的空间大小-->\n\t<path>/var/lib/clickhouse/</path>                               <!--数据存储位置，需要带斜杠指定到目录内-->\n\t<user_files_path>/var/lib/clickhouse/user_files/</user_files_path>            <!--设置用户上传文件的存储路径-->\n\t<path>/var/lib/clickhouse/access/</path>                             <!--存储由SQL命令创建的用户的文件夹的路径-->\n    <default_database>default</default_database>                         <!--默认的数据库名称-->\n\t<prometheus>                                                         <!--prometheus监控-->\n        <endpoint>/metrics</endpoint>                                  \n        <port>9363</port>\n        <metrics>true</metrics>                                          \n        <events>true</events>\n        <asynchronous_metrics>true</asynchronous_metrics>\n        <status_info>true</status_info>\n    </prometheus>\n    <query_log>                                                <!--需要log_queries=1，记录接收到的查询。查询记录在system.query_log表，而不记录在单独文件中-->\n\t    <database>system</database>   --库名\n\t    <table>query_log</table>   --表名\n\t    <partition_by>toMonday(event_date)</partition_by>  --自定义分区键\n\t    <flush_interval_milliseconds>7500</flush_interval_milliseconds>  --将数据从内存中的缓冲区刷新到表的时间间隔\n\t</query_log>\n\t<query_thread_log>\n        <database>system</database>     --库名\n\t    <table>query_thread_log</table>  --接收数据写入的系统日志表名\n\t    <partition_by>toMonday(event_date)</partition_by>  --自定义分区键\n\t    <flush_interval_milliseconds>7500</flush_interval_milliseconds>  --将数据从内存中的缓冲区刷新到表的时间间隔\n\t</query_thread_log>\n\n\n```\n\n#### 2. 重要路径 （默认未修改）\n\n| 名称 | 路径 |\n| :---: | :---: |\n|log|/var/log/clickhouse-server/clickhouse-server.log|\n| errorlog |/var/log/clickhouse-server/clickhouse-server.err.log|\n|data|/var/lib/clickhouse/access/|\n|user_files|/var/lib/clickhouse/user_files/|\n\n#### 3. 优化\n1. 日志级别设置为info(实践一次，并未成功，暂无原因)\n2. 以及zookeeper日志，通过设定环境变量配置日志级别和输出方式，ZOO_LOG4J_PROP=\"INFO,ROLLINGFILE\"\n3. 配置监控，基于metric、prometheus&grafana\n----------------\n#### 4. 系统表\n1. 存储于 `system` 数据库，提供信息包括：服务器的状态、进程、环境、服务器的内部进程\n2. system.cluster\n|字段|信息|\n|:---:|:---:|\n|cluster|集群名|\n|shard_num|集群中的分片数，从1开始|\n|shard_weight|写数据时该分片的相对权重|\n|replica_num|分片的副本数量，从1开始|\n|host_name|配置中指定的主机名|\n|host_address|从DNS获取的主机IP地址|\n|port|连接到服务器的端口|\n|user|连接到服务器的用户名|\n|errors_count| 此主机无法访问副本的次数|\n|slowdowns_count|与对冲请求建立连接时导致更改副本的减速次数|\n|estimated_recovery_time|剩下的秒数，直到副本错误计数归零并被视为恢复正常|\n3. system.metrics\n|metric|value|description|信息|\n|:---:|:---:|:---:|:---:|\n|Query|1|Number of executing queries|执行查询的数量|\n|Merge|0|Number of executing background merges|后台合并的数量|\n| PartMutation |0|Number of mutations (ALTER DELETE/UPDATE)|数据删除、更新操作数|\n|ReplicatedFetch| 0|Number of data parts being fetched from replicas|从副本中获取的数据块的数量|\n| ReplicatedSend |0|Number of data parts being sent to replicas|向副本传递的数据块的数量|\n|ReplicatedChecks|0|Number of data parts checking for consistency|正在进行一致性检查的数据块数量|\n|BackgroundMergesAndMutationsPoolTask|0 |Number of active merges and mutations in an associated background pool |后台线程池中活跃的合并和更新数量|\n|BackgroundFetchesPoolTask |0 |Number of active fetches in an associated background pool |正在使用后台线程池执行的查询的并发数|\n|BackgroundCommonPoolTask |0|Number of active tasks in an associated background pool|正在执行的任务数|\n|BackgroundMovePoolTask | 0 |Number of active tasks in BackgroundProcessingPool for moves|正在执行的数据迁移任务的数量|\n\n -----------\n#### 5. 运维常见问题排查和参考。（参考链接）\n1. [博客园--clickhouse常见问题排查](https://www.cnblogs.com/qiu-hua/p/15113806.html)涉及副本节点不一致、副本节点全量恢复......\n2. [本地备份](https://www.kubesre.com/archives/clickhousebei-fen-yu-hui-fu)\n3. [基于复制的故障恢复](http://jackpgao.github.io/2017/12/18/ClickHouse-Recovery-basedon-Replication/)节点宕机不可恢复、新增节点到集群的方案介绍\n4. [ClickHouse 集群分片下扩容副本的方式](https://opensource.actionsky.com/20211111-clickhouse/)\n#### 6.扩容\n   1. 增加机器--zookeeper 安装、clickhouse 安装、做自解析\n   2. 修改配置文件，增加扩容分片，配置其中的副本节点（最好修改权重）、配置zookeeper\n   3. 启动新节点，创建本地表和分布式表\n   4. 对旧节点做配置修改\n   5. 测试（某节点宕机数据不可恢复时，应能采取相同步骤对集群新增节点恢复集群架构、或许引擎树的选择将影响是否需要手动传输历史数据）\n   6. [集群参考贴](https://blog.51cto.com/feko/2738319)\n   ","slug":"clickhouse","published":1,"updated":"2024-04-30T16:43:40.402Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodj2000s80rva1m48x51","content":"<p>(未曾指定数据目录，仍在原有的系统路径)<br>(metrika.xml  是否可以选择配置主机变量)</p>\n<h2 id=\"一、-安装JDK—-zookeeper集群需要\"><a href=\"#一、-安装JDK—-zookeeper集群需要\" class=\"headerlink\" title=\"一、 安装JDK—-zookeeper集群需要\"></a>一、 安装JDK—-zookeeper集群需要</h2><hr>\n<h4 id=\"1-集群需要的机器安装java环境\"><a href=\"#1-集群需要的机器安装java环境\" class=\"headerlink\" title=\"1.  集群需要的机器安装java环境\"></a>1.  集群需要的机器安装java环境</h4><hr>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo apt-get install -y openjdk-8-jdk\nvim &#x2F;etc&#x2F;profile                                          # 环境变量，此为系统全局配置，本项目还应对zookeeper进行声明；注意声明时分割，加上:$变量名，避免覆盖\n    export JAVA_HOME&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-8-openjdk-amd64    [[是]] Java 编程语言 JDK 的顶级目录，软件安装的本地路径，便于定义$path \n    export PATH&#x3D;PATH&#x3D;$JAVA_HOME&#x2F;bin:$PATH                 [[PATH]] 用于指定可执行的二进制文件的位置，此变量不为空，每次声明应加上:$path，避免覆盖\n    export CLASSPATH&#x3D;                                     # 指运行程序所需要的 class 文件的位置,有参考贴说其实非必需，本实验未定义\nsource &#x2F;etc&#x2F;profile\njava -version 或 javac -version 检查<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"2-搭建zookeeper集群\"><a href=\"#2-搭建zookeeper集群\" class=\"headerlink\" title=\"2.  搭建zookeeper集群\"></a>2.  搭建zookeeper集群</h4><ul>\n<li>元数据管理、集群配置和协调</li>\n</ul>\n<hr>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">tee &gt;&gt; &#x2F;etc&#x2F;hosts &lt;&lt; EOF\n10.13.3.107 server1\n10.13.3.106 server2\n10.13.3.105 server3\nEOF\n\nmkdir &#x2F;usr&#x2F;local&#x2F;zookeeper\ncd &#x2F;opt &amp;&amp; wget https:&#x2F;&#x2F;dlcdn.apache.org&#x2F;zookeeper&#x2F;zookeeper-3.8.3&#x2F;apache-zookeeper-3.8.3-bin.tar.gz\nmkdir -p &#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;&#123;datadir,logdir&#125;\ntar -zxvf &#x2F;opt&#x2F;apache-zookeeper-3.8.3-bin.tar.gz -C &#x2F;usr&#x2F;local&#x2F;zookeeper --strip-components&#x3D;1\necho 1 &gt; &#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;datadir&#x2F;myid\nvim zookeeper&#x2F;conf&#x2F;zoo.cfg<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><strong>zoo.cfg 内容如下</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">tickTime&#x3D;2000\ninitLimit&#x3D;10\nsyncLimit&#x3D;5\ndataDir&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;datadir     # 此处两个目录需要创建，并指定自身实际路径\ndataLogDir&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;logdir  \nclientPort&#x3D;2181\nserver.1&#x3D;server1:2288:3388                         [[集群信息]],host:心跳端口:数据端口（此处写主机名需要在&#x2F;etc&#x2F;hosts做自解析）\nserver.2&#x3D;server2:2288:3388                         [[server]].1--唯一标识符，1需要写入存放数据的data&#x2F;myid 文件中(可以是任意数字，只要二者一致)\nserver.3&#x3D;server3:2288:3388                         [[服务器]] Follower 与集群中的 Leader 交换信息的端口:万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，用来执行选举时服务器相互通信的端口\n\n-----------以下为j2模板文件写法\n&#123;% for host in groups[&#39;inboc_dev_clickhouse_group&#39;]%&#125;\nserver.&#123;&#123; loop.index &#125;&#125;&#x3D;&#123;&#123;hostvars[host].ansible_host&#125;&#125;:2288:3388\n&#123;% endfor %&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>三台机器都相同配置，需<em><strong>自解析</strong></em>，但是注意分别 echo 2&#x2F;3 &gt; datadir&#x2F;myid<br>pwd<br>  &#x2F;usr&#x2F;local&#x2F;zookeeper</p>\n</blockquote>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">rsync -avz  zookeeper  root@10.13.3.107:&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;zookeeper\nrsync -avz  &#x2F;etc&#x2F;hosts  root@10.13.3.107:&#x2F;etc&#x2F;\nsource &#x2F;etc&#x2F;hosts<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p><strong>systemd 管理</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">tee &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;zookeeper.service &lt;&lt; EOF\n[Unit]  \nDescription&#x3D;Apache ZooKeeper distributed coordination server  \nAfter&#x3D;network.target  \n  \n[Service]  \nType&#x3D;forking  \nExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;bin&#x2F;zkServer.sh start  \nExecStop&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;bin&#x2F;zkServer.sh stop  \nRestart&#x3D;on-abnormal  \n  \n[Install]  \nWantedBy&#x3D;multi-user.target\nEOF\n\nsystemctl daemon-reload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><strong>启服务,查看状态</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">systemctl enable --now zookeeper\nsystemctl status zookeeper\n&#96;&#96;&#96;   \n\n\n## 二、 单节点安装，集群内各节点机器均需要安装clickhouse\n---------------------\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>sudo apt-get install apt-transport-https ca-certificates dirmngr<br>sudo apt-key adv –keyserver hkp:&#x2F;&#x2F;keyserver.ubuntu.com:80 –recv 8919F6BD2B48D754</p>\n<p>echo “deb <a href=\"https://packages.clickhouse.com/deb\">https://packages.clickhouse.com/deb</a> stable main” | sudo tee <br>    &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;clickhouse.list<br>sudo apt-get update</p>\n<p>sudo apt-get install -y clickhouse-server clickhouse-client</p>\n<p>sudo service clickhouse-server start    [[此句是启动clickhouse的服务]]<br>clickhouse-client # or “clickhouse-client –password”  # 启动客户端</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n## 三、 clickhouse配置集群\n------------------------\n\n**vim config.xml**<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><listen_host>0.0.0.0</listen_host><br><remote_servers></remote_servers>                                 [[此标签内的local, test集群可以注释，不用留下，注释内不能包含注释]]<!--  -->  ( ansible 中 j2 模板会删除这些行的内容)<br><include_from>&#x2F;etc&#x2F;clickhouse-server&#x2F;metrika.xml</include_from>   [[此句配置在metrika]].xml段落描述之后，文件为集群配置，但是打了引入标签仍然未识别成功metrika.xml文件路径，将其移动到config.d目录下，成功建立集群</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\nvim metrika.xml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><yandex>                       <!--此为3分片2副本--><br>    <remote_servers>           <!--集群标签--><br>        <ck_cluster>           <!--集群名称--><br>            <shard>            <!--分片标签--><br>                <internal_replication>true</internal_replication>   <!--集群内复制功能--><br>                <replica>                                           <!--副本标签，副本指所有文件数量--><br>                    <host>10.13.3.107</host>                        <!--存储本分片的第一个副本的机器--><br>                    <port>9000</port><br>                </replica><br>                <replica><br>                    <host>10.13.3.108</host>                        <!--存储本分片的第二个副本的机器--><br>                    <port>9000</port><br>                </replica><br>            </shard><br>            <shard><br>                <internal_replication>true</internal_replication><br>                <replica><br>                    <host>10.13.3.108</host><br>                    <port>9000</port><br>                </replica><br>                <replica><br>                    <host>10.13.3.109</host><br>                    <port>9000</port><br>                </replica><br>            </shard><br>            <shard><br>                <internal_replication>true</internal_replication><br>                <replica><br>                    <host>10.13.3.109</host><br>                    <port>9000</port><br>                </replica><br>                <replica><br>                    <host>10.13.3.107</host><br>                    <port>9000</port><br>                </replica><br>            </shard><br>        </ck_cluster><br>    </remote_servers><br>    <zookeeper>                                    <!--连接zookeeper集群的配置--><br>        <node index=\"1\">                           <!--zookeeper集群内的主机唯一标识符--><br>            <host>server1</host>                   <!--主机名/IP--><br>            <port>2181</port><br>        </node><br>        <node  index=\"2\"><br>            <host>server2</host><br>            <port>2181</port><br>        </node><br>        <node index=\"3\"><br>            <host>server3</host><br>            <port>2181</port><br>        </node><br>    </zookeeper><br>    <!--macros>                                   <!--定义宏，在 SQL 查询中使用，以便动态地引用集群中的不同分片和副本--><!--创建集群时非必须--><br>        <shard>03</shard>                         <!--第3分片-->（可以视为一个index）<br>        <replica>03_1</replica>                   <!--第3分片第1副本-->（可以视为一个主机唯一连接，比如IP、hostname）<br>    </macros><br>    <macros>                                      <!--sql使用举例：SELECT COUNT(*) FROM my_table WHERE _shard = '03' AND _replica = '03_1'--><br>        <shard>02</shard>                         <!--该标签写法和用法有待斟酌--><br>        <replica>02_2</replica><br>    </macros--><br>    <networks>                                    <!--配置选项允许 Yandex.Metrica 监听来自任何 IPv4 地址的请求--><br>        <ip>0.0.0.0</ip><br>    </networks></p>\n<pre><code>&lt;compression&gt;                                 &lt;!--指定数据在写入到磁盘之前或从磁盘读取之后的压缩方式--&gt;\n    &lt;case&gt;\n        &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt;\n        &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt;\n        &lt;method&gt;lz4&lt;/method&gt;\n    &lt;/case&gt;\n&lt;/compression&gt;\n</code></pre>\n</yandex>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n\t根据以上配置文件，这个 ClickHouse 集群中的每个分片都有两个副本，在这个配置中并没有显式地设置 &#96;parallel_replicas&#96; 参数。因此，如果没有进行额外的配置，这个集群默认情况下在进行分布式查询时，每个分片的两个副本都可以参与查询处理，但是并行副本数量可能会受到其他因素的限制，如数据分片、查询复杂度等。 \n\t如果需要进一步控制并行副本数量，可以在查询中使用 &#96;SETTINGS max_parallel_replicas&#96; 参数或者在配置文件中设置 &#96;max_parallel_replicas&#96; 参数，以限制每个查询中使用的最大并行副本数量。\n\nvim users.xml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<users>\n    <!-- If user name was not specified, 'default' user is used. -->\n    <user_name>                                                     <!--用户名-->\n        <password></password>                                       <!--明文密码，不推荐-->\n        <!-- Or -->\n        <password_sha256_hex> </password_sha256_hex>                 <!--放置用shell生成SHA256加密密码-->()\n\n<pre><code>    &lt;access_management&gt; 0|1 &lt;/access_management&gt;                  &lt;!--不允许 | 允许sql语句生成账户--&gt;\n\n    &lt;networks incl=&quot;networks&quot; replace=&quot;replace&quot;&gt;\n    &lt;networks&gt;                                                  &lt;!--用户来源访问控制--&gt;\n         &lt;ip&gt;::/0&lt;/ip&gt;\n    &lt;/networks&gt;\n    &lt;profile&gt;profile_name&lt;/profile&gt;                             &lt;!--对配置做设置的文件名，其中有单独配置段--&gt;\n\n    &lt;quota&gt;default&lt;/quota&gt;                                      &lt;!--对用户资源配额做设置的文件--&gt;\n\n    &lt;databases&gt;                                                 &lt;!--限制ClickHouse中由当前用户进行的 `SELECT` 查询所返回的行，从而实现基本的行级安全性--&gt; \n        &lt;database_name&gt;\n            &lt;table_name&gt;\n                &lt;filter&gt;expression&lt;/filter&gt;                     &lt;!--可以是[UInt8]编码的任何表达式。 它通常包含比较和逻辑运算符, 当filter返回0时, database_name.table1 的该行结果将不会返回给用户--&gt;\n            &lt;table_name&gt;\n        &lt;/database_name&gt;\n    &lt;/databases&gt;\n&lt;/user_name&gt;\n&lt;!-- Other users settings --&gt;\n</code></pre>\n</users>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\nSHA256生成密码，利用随机数生成密码，-c 表示需要生成的长度；\n\n<p>PASSWORD&#x3D;$(base64 &lt; &#x2F;dev&#x2F;urandom | head -c14); echo “$PASSWORD”; echo -n “$PASSWORD” | sha256sum | tr -d ‘-‘<br>生成的第一行为明文密码，用于自己使用；第二行为 sha256 加密字符串，需要配置到下面标签中：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n各节点重启，并检查<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>systemctl restart clickhouse-server<br>clickhouse-client -m<br>    select * from system.clusters;<br>    SELECT * FROM system.zookeeper WHERE path &#x3D; ‘&#x2F;‘；</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n\n检查连接：8123、9000端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<ol>\n<li>echo ‘show databases’ | curl -H ‘X-ClickHouse-User: default’ -H ‘X-ClickHouse-Key: Inboc@2020’ ‘<a href=\"http://10.13.3.101:8123/\">http://10.13.3.101:8123/</a>‘ -d @-</li>\n<li>clickhouse-client 登录 使用local:9000,</li>\n<li>datagrip工具，使用9000端口，用户和密码，可以登录<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n-------------------\n使用出现的问题：\nPython连接8123端口不成功,users.xml 配置错误，删除后可以使用。\n\n--------------------\n\n以下是metrika.xml.j2循环和自动获取<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ck_cluster>  \n  \n\n</ck_cluster>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<zookeeper>  \n  \n  \n</zookeeper>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n## 四、维护使用\n----------------\n#### 1. 配置解析\n **config.xml**<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n    <logger>                                                    <!--日志设置-->\n        <console>true</console>                                 <!--是否将日志输出到控制台-->\n        <level>trace</level>                                    <!--日志级别，可以是debug/info/warning/error;trace是输出所有、建议设置为info/warning-->\n        <log>/var/log/clickhouse-server/clickhouse-server.log</log>     <!--日志文件路径-->\n        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>       \n        <size>1000M</size>                                        <!--日志文件最大size-->\n        <count>10</count>                                         <!--日志文件最大数量-->\n        <levels>\n          <ConfigReloader>none</ConfigReloader>                  <!--是否允许服务在运行中响应配置文件变化-->\n        </levels>\n    </logger>\n    \n<pre><code>&lt;interserver_listen_host&gt;::&lt;/interserver_listen_host&gt;        &lt;!--监听集群内节点机器的IP地址，适用于节点有多个网络接口的情况--&gt;\n&lt;max_connections&gt;4096&lt;/max_connections&gt;                      &lt;!--可以同时处理的最大客户端连接数--&gt;\n&lt;max_concurrent_queries&gt;100&lt;/max_concurrent_queries&gt;         &lt;!--允许同事处理的最大查询数量--&gt;\n&lt;keep_alive_timeout&gt;3&lt;/keep_alive_timeout&gt;                   &lt;!--心跳时间--&gt;\n&lt;max_server_memory_usage&gt;0&lt;/max_server_memory_usage&gt;         &lt;!--允许服务器最多可以使用的内存量,单位是字节--&gt;   \n&lt;max_server_memory_usage_to_ram_ratio&gt;0.9&lt;/max_server_memory_usage_to_ram_ratio&gt;   &lt;!--ClickHouse服务器可以使用的内存量与系统总内存量之间的比例--&gt;\n&lt;max_open_files&gt;262144&lt;/max_open_files&gt;                       &lt;!--系统同时打开的最大文件数--&gt;\n&lt;uncompressed_cache_size&gt;8589934592&lt;/uncompressed_cache_size&gt;  &lt;!--指定了在内存中用于缓存未压缩块的空间大小--&gt;\n&lt;mark_cache_size&gt;5368709120&lt;/mark_cache_size&gt;                   &lt;!--指定在内存中用于缓存标记的空间大小--&gt;\n&lt;path&gt;/var/lib/clickhouse/&lt;/path&gt;                               &lt;!--数据存储位置，需要带斜杠指定到目录内--&gt;\n&lt;user_files_path&gt;/var/lib/clickhouse/user_files/&lt;/user_files_path&gt;            &lt;!--设置用户上传文件的存储路径--&gt;\n&lt;path&gt;/var/lib/clickhouse/access/&lt;/path&gt;                             &lt;!--存储由SQL命令创建的用户的文件夹的路径--&gt;\n&lt;default_database&gt;default&lt;/default_database&gt;                         &lt;!--默认的数据库名称--&gt;\n&lt;prometheus&gt;                                                         &lt;!--prometheus监控--&gt;\n    &lt;endpoint&gt;/metrics&lt;/endpoint&gt;                                  \n    &lt;port&gt;9363&lt;/port&gt;\n    &lt;metrics&gt;true&lt;/metrics&gt;                                          \n    &lt;events&gt;true&lt;/events&gt;\n    &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt;\n    &lt;status_info&gt;true&lt;/status_info&gt;\n&lt;/prometheus&gt;\n&lt;query_log&gt;                                                &lt;!--需要log_queries=1，记录接收到的查询。查询记录在system.query_log表，而不记录在单独文件中--&gt;\n    &lt;database&gt;system&lt;/database&gt;   --库名\n    &lt;table&gt;query_log&lt;/table&gt;   --表名\n    &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt;  --自定义分区键\n    &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;  --将数据从内存中的缓冲区刷新到表的时间间隔\n&lt;/query_log&gt;\n&lt;query_thread_log&gt;\n    &lt;database&gt;system&lt;/database&gt;     --库名\n    &lt;table&gt;query_thread_log&lt;/table&gt;  --接收数据写入的系统日志表名\n    &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt;  --自定义分区键\n    &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;  --将数据从内存中的缓冲区刷新到表的时间间隔\n&lt;/query_thread_log&gt;\n</code></pre>\n<pre><code>\n#### 2. 重要路径 （默认未修改）\n\n| 名称 | 路径 |\n| :---: | :---: |\n|log|/var/log/clickhouse-server/clickhouse-server.log|\n| errorlog |/var/log/clickhouse-server/clickhouse-server.err.log|\n|data|/var/lib/clickhouse/access/|\n|user_files|/var/lib/clickhouse/user_files/|\n\n#### 3. 优化\n1. 日志级别设置为info(实践一次，并未成功，暂无原因)\n2. 以及zookeeper日志，通过设定环境变量配置日志级别和输出方式，ZOO_LOG4J_PROP=&quot;INFO,ROLLINGFILE&quot;\n3. 配置监控，基于metric、prometheus&amp;grafana\n----------------\n#### 4. 系统表\n1. 存储于 `system` 数据库，提供信息包括：服务器的状态、进程、环境、服务器的内部进程\n2. system.cluster\n|字段|信息|\n|:---:|:---:|\n|cluster|集群名|\n|shard_num|集群中的分片数，从1开始|\n|shard_weight|写数据时该分片的相对权重|\n|replica_num|分片的副本数量，从1开始|\n|host_name|配置中指定的主机名|\n|host_address|从DNS获取的主机IP地址|\n|port|连接到服务器的端口|\n|user|连接到服务器的用户名|\n|errors_count| 此主机无法访问副本的次数|\n|slowdowns_count|与对冲请求建立连接时导致更改副本的减速次数|\n|estimated_recovery_time|剩下的秒数，直到副本错误计数归零并被视为恢复正常|\n3. system.metrics\n|metric|value|description|信息|\n|:---:|:---:|:---:|:---:|\n|Query|1|Number of executing queries|执行查询的数量|\n|Merge|0|Number of executing background merges|后台合并的数量|\n| PartMutation |0|Number of mutations (ALTER DELETE/UPDATE)|数据删除、更新操作数|\n|ReplicatedFetch| 0|Number of data parts being fetched from replicas|从副本中获取的数据块的数量|\n| ReplicatedSend |0|Number of data parts being sent to replicas|向副本传递的数据块的数量|\n|ReplicatedChecks|0|Number of data parts checking for consistency|正在进行一致性检查的数据块数量|\n|BackgroundMergesAndMutationsPoolTask|0 |Number of active merges and mutations in an associated background pool |后台线程池中活跃的合并和更新数量|\n|BackgroundFetchesPoolTask |0 |Number of active fetches in an associated background pool |正在使用后台线程池执行的查询的并发数|\n|BackgroundCommonPoolTask |0|Number of active tasks in an associated background pool|正在执行的任务数|\n|BackgroundMovePoolTask | 0 |Number of active tasks in BackgroundProcessingPool for moves|正在执行的数据迁移任务的数量|\n\n -----------\n#### 5. 运维常见问题排查和参考。（参考链接）\n1. [博客园--clickhouse常见问题排查](https://www.cnblogs.com/qiu-hua/p/15113806.html)涉及副本节点不一致、副本节点全量恢复......\n2. [本地备份](https://www.kubesre.com/archives/clickhousebei-fen-yu-hui-fu)\n3. [基于复制的故障恢复](http://jackpgao.github.io/2017/12/18/ClickHouse-Recovery-basedon-Replication/)节点宕机不可恢复、新增节点到集群的方案介绍\n4. [ClickHouse 集群分片下扩容副本的方式](https://opensource.actionsky.com/20211111-clickhouse/)\n#### 6.扩容\n   1. 增加机器--zookeeper 安装、clickhouse 安装、做自解析\n   2. 修改配置文件，增加扩容分片，配置其中的副本节点（最好修改权重）、配置zookeeper\n   3. 启动新节点，创建本地表和分布式表\n   4. 对旧节点做配置修改\n   5. 测试（某节点宕机数据不可恢复时，应能采取相同步骤对集群新增节点恢复集群架构、或许引擎树的选择将影响是否需要手动传输历史数据）\n   6. [集群参考贴](https://blog.51cto.com/feko/2738319)\n   \n</code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<p>(未曾指定数据目录，仍在原有的系统路径)<br>(metrika.xml  是否可以选择配置主机变量)</p>\n<h2 id=\"一、-安装JDK—-zookeeper集群需要\"><a href=\"#一、-安装JDK—-zookeeper集群需要\" class=\"headerlink\" title=\"一、 安装JDK—-zookeeper集群需要\"></a>一、 安装JDK—-zookeeper集群需要</h2><hr>\n<h4 id=\"1-集群需要的机器安装java环境\"><a href=\"#1-集群需要的机器安装java环境\" class=\"headerlink\" title=\"1.  集群需要的机器安装java环境\"></a>1.  集群需要的机器安装java环境</h4><hr>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo apt-get install -y openjdk-8-jdk\nvim &#x2F;etc&#x2F;profile                                          # 环境变量，此为系统全局配置，本项目还应对zookeeper进行声明；注意声明时分割，加上:$变量名，避免覆盖\n    export JAVA_HOME&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-8-openjdk-amd64    [[是]] Java 编程语言 JDK 的顶级目录，软件安装的本地路径，便于定义$path \n    export PATH&#x3D;PATH&#x3D;$JAVA_HOME&#x2F;bin:$PATH                 [[PATH]] 用于指定可执行的二进制文件的位置，此变量不为空，每次声明应加上:$path，避免覆盖\n    export CLASSPATH&#x3D;                                     # 指运行程序所需要的 class 文件的位置,有参考贴说其实非必需，本实验未定义\nsource &#x2F;etc&#x2F;profile\njava -version 或 javac -version 检查<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"2-搭建zookeeper集群\"><a href=\"#2-搭建zookeeper集群\" class=\"headerlink\" title=\"2.  搭建zookeeper集群\"></a>2.  搭建zookeeper集群</h4><ul>\n<li>元数据管理、集群配置和协调</li>\n</ul>\n<hr>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">tee &gt;&gt; &#x2F;etc&#x2F;hosts &lt;&lt; EOF\n10.13.3.107 server1\n10.13.3.106 server2\n10.13.3.105 server3\nEOF\n\nmkdir &#x2F;usr&#x2F;local&#x2F;zookeeper\ncd &#x2F;opt &amp;&amp; wget https:&#x2F;&#x2F;dlcdn.apache.org&#x2F;zookeeper&#x2F;zookeeper-3.8.3&#x2F;apache-zookeeper-3.8.3-bin.tar.gz\nmkdir -p &#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;&#123;datadir,logdir&#125;\ntar -zxvf &#x2F;opt&#x2F;apache-zookeeper-3.8.3-bin.tar.gz -C &#x2F;usr&#x2F;local&#x2F;zookeeper --strip-components&#x3D;1\necho 1 &gt; &#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;datadir&#x2F;myid\nvim zookeeper&#x2F;conf&#x2F;zoo.cfg<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><strong>zoo.cfg 内容如下</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">tickTime&#x3D;2000\ninitLimit&#x3D;10\nsyncLimit&#x3D;5\ndataDir&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;datadir     # 此处两个目录需要创建，并指定自身实际路径\ndataLogDir&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;logdir  \nclientPort&#x3D;2181\nserver.1&#x3D;server1:2288:3388                         [[集群信息]],host:心跳端口:数据端口（此处写主机名需要在&#x2F;etc&#x2F;hosts做自解析）\nserver.2&#x3D;server2:2288:3388                         [[server]].1--唯一标识符，1需要写入存放数据的data&#x2F;myid 文件中(可以是任意数字，只要二者一致)\nserver.3&#x3D;server3:2288:3388                         [[服务器]] Follower 与集群中的 Leader 交换信息的端口:万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，用来执行选举时服务器相互通信的端口\n\n-----------以下为j2模板文件写法\n&#123;% for host in groups[&#39;inboc_dev_clickhouse_group&#39;]%&#125;\nserver.&#123;&#123; loop.index &#125;&#125;&#x3D;&#123;&#123;hostvars[host].ansible_host&#125;&#125;:2288:3388\n&#123;% endfor %&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>三台机器都相同配置，需<em><strong>自解析</strong></em>，但是注意分别 echo 2&#x2F;3 &gt; datadir&#x2F;myid<br>pwd<br>  &#x2F;usr&#x2F;local&#x2F;zookeeper</p>\n</blockquote>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">rsync -avz  zookeeper  root@10.13.3.107:&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;zookeeper\nrsync -avz  &#x2F;etc&#x2F;hosts  root@10.13.3.107:&#x2F;etc&#x2F;\nsource &#x2F;etc&#x2F;hosts<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p><strong>systemd 管理</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">tee &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;zookeeper.service &lt;&lt; EOF\n[Unit]  \nDescription&#x3D;Apache ZooKeeper distributed coordination server  \nAfter&#x3D;network.target  \n  \n[Service]  \nType&#x3D;forking  \nExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;bin&#x2F;zkServer.sh start  \nExecStop&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;bin&#x2F;zkServer.sh stop  \nRestart&#x3D;on-abnormal  \n  \n[Install]  \nWantedBy&#x3D;multi-user.target\nEOF\n\nsystemctl daemon-reload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><strong>启服务,查看状态</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">systemctl enable --now zookeeper\nsystemctl status zookeeper\n&#96;&#96;&#96;   \n\n\n## 二、 单节点安装，集群内各节点机器均需要安装clickhouse\n---------------------\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>sudo apt-get install apt-transport-https ca-certificates dirmngr<br>sudo apt-key adv –keyserver hkp:&#x2F;&#x2F;keyserver.ubuntu.com:80 –recv 8919F6BD2B48D754</p>\n<p>echo “deb <a href=\"https://packages.clickhouse.com/deb\">https://packages.clickhouse.com/deb</a> stable main” | sudo tee <br>    &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;clickhouse.list<br>sudo apt-get update</p>\n<p>sudo apt-get install -y clickhouse-server clickhouse-client</p>\n<p>sudo service clickhouse-server start    [[此句是启动clickhouse的服务]]<br>clickhouse-client # or “clickhouse-client –password”  # 启动客户端</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n## 三、 clickhouse配置集群\n------------------------\n\n**vim config.xml**<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><listen_host>0.0.0.0</listen_host><br><remote_servers></remote_servers>                                 [[此标签内的local, test集群可以注释，不用留下，注释内不能包含注释]]<!--  -->  ( ansible 中 j2 模板会删除这些行的内容)<br><include_from>&#x2F;etc&#x2F;clickhouse-server&#x2F;metrika.xml</include_from>   [[此句配置在metrika]].xml段落描述之后，文件为集群配置，但是打了引入标签仍然未识别成功metrika.xml文件路径，将其移动到config.d目录下，成功建立集群</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\nvim metrika.xml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><yandex>                       <!--此为3分片2副本--><br>    <remote_servers>           <!--集群标签--><br>        <ck_cluster>           <!--集群名称--><br>            <shard>            <!--分片标签--><br>                <internal_replication>true</internal_replication>   <!--集群内复制功能--><br>                <replica>                                           <!--副本标签，副本指所有文件数量--><br>                    <host>10.13.3.107</host>                        <!--存储本分片的第一个副本的机器--><br>                    <port>9000</port><br>                </replica><br>                <replica><br>                    <host>10.13.3.108</host>                        <!--存储本分片的第二个副本的机器--><br>                    <port>9000</port><br>                </replica><br>            </shard><br>            <shard><br>                <internal_replication>true</internal_replication><br>                <replica><br>                    <host>10.13.3.108</host><br>                    <port>9000</port><br>                </replica><br>                <replica><br>                    <host>10.13.3.109</host><br>                    <port>9000</port><br>                </replica><br>            </shard><br>            <shard><br>                <internal_replication>true</internal_replication><br>                <replica><br>                    <host>10.13.3.109</host><br>                    <port>9000</port><br>                </replica><br>                <replica><br>                    <host>10.13.3.107</host><br>                    <port>9000</port><br>                </replica><br>            </shard><br>        </ck_cluster><br>    </remote_servers><br>    <zookeeper>                                    <!--连接zookeeper集群的配置--><br>        <node index=\"1\">                           <!--zookeeper集群内的主机唯一标识符--><br>            <host>server1</host>                   <!--主机名/IP--><br>            <port>2181</port><br>        </node><br>        <node  index=\"2\"><br>            <host>server2</host><br>            <port>2181</port><br>        </node><br>        <node index=\"3\"><br>            <host>server3</host><br>            <port>2181</port><br>        </node><br>    </zookeeper><br>    <!--macros>                                   <!--定义宏，在 SQL 查询中使用，以便动态地引用集群中的不同分片和副本--><!--创建集群时非必须--><br>        <shard>03</shard>                         <!--第3分片-->（可以视为一个index）<br>        <replica>03_1</replica>                   <!--第3分片第1副本-->（可以视为一个主机唯一连接，比如IP、hostname）<br>    </macros><br>    <macros>                                      <!--sql使用举例：SELECT COUNT(*) FROM my_table WHERE _shard = '03' AND _replica = '03_1'--><br>        <shard>02</shard>                         <!--该标签写法和用法有待斟酌--><br>        <replica>02_2</replica><br>    </macros--><br>    <networks>                                    <!--配置选项允许 Yandex.Metrica 监听来自任何 IPv4 地址的请求--><br>        <ip>0.0.0.0</ip><br>    </networks></p>\n<pre><code>&lt;compression&gt;                                 &lt;!--指定数据在写入到磁盘之前或从磁盘读取之后的压缩方式--&gt;\n    &lt;case&gt;\n        &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt;\n        &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt;\n        &lt;method&gt;lz4&lt;/method&gt;\n    &lt;/case&gt;\n&lt;/compression&gt;\n</code></pre>\n</yandex>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n\t根据以上配置文件，这个 ClickHouse 集群中的每个分片都有两个副本，在这个配置中并没有显式地设置 &#96;parallel_replicas&#96; 参数。因此，如果没有进行额外的配置，这个集群默认情况下在进行分布式查询时，每个分片的两个副本都可以参与查询处理，但是并行副本数量可能会受到其他因素的限制，如数据分片、查询复杂度等。 \n\t如果需要进一步控制并行副本数量，可以在查询中使用 &#96;SETTINGS max_parallel_replicas&#96; 参数或者在配置文件中设置 &#96;max_parallel_replicas&#96; 参数，以限制每个查询中使用的最大并行副本数量。\n\nvim users.xml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<users>\n    <!-- If user name was not specified, 'default' user is used. -->\n    <user_name>                                                     <!--用户名-->\n        <password></password>                                       <!--明文密码，不推荐-->\n        <!-- Or -->\n        <password_sha256_hex> </password_sha256_hex>                 <!--放置用shell生成SHA256加密密码-->()\n\n<pre><code>    &lt;access_management&gt; 0|1 &lt;/access_management&gt;                  &lt;!--不允许 | 允许sql语句生成账户--&gt;\n\n    &lt;networks incl=&quot;networks&quot; replace=&quot;replace&quot;&gt;\n    &lt;networks&gt;                                                  &lt;!--用户来源访问控制--&gt;\n         &lt;ip&gt;::/0&lt;/ip&gt;\n    &lt;/networks&gt;\n    &lt;profile&gt;profile_name&lt;/profile&gt;                             &lt;!--对配置做设置的文件名，其中有单独配置段--&gt;\n\n    &lt;quota&gt;default&lt;/quota&gt;                                      &lt;!--对用户资源配额做设置的文件--&gt;\n\n    &lt;databases&gt;                                                 &lt;!--限制ClickHouse中由当前用户进行的 `SELECT` 查询所返回的行，从而实现基本的行级安全性--&gt; \n        &lt;database_name&gt;\n            &lt;table_name&gt;\n                &lt;filter&gt;expression&lt;/filter&gt;                     &lt;!--可以是[UInt8]编码的任何表达式。 它通常包含比较和逻辑运算符, 当filter返回0时, database_name.table1 的该行结果将不会返回给用户--&gt;\n            &lt;table_name&gt;\n        &lt;/database_name&gt;\n    &lt;/databases&gt;\n&lt;/user_name&gt;\n&lt;!-- Other users settings --&gt;\n</code></pre>\n</users>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\nSHA256生成密码，利用随机数生成密码，-c 表示需要生成的长度；\n\n<p>PASSWORD&#x3D;$(base64 &lt; &#x2F;dev&#x2F;urandom | head -c14); echo “$PASSWORD”; echo -n “$PASSWORD” | sha256sum | tr -d ‘-‘<br>生成的第一行为明文密码，用于自己使用；第二行为 sha256 加密字符串，需要配置到下面标签中：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n各节点重启，并检查<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>systemctl restart clickhouse-server<br>clickhouse-client -m<br>    select * from system.clusters;<br>    SELECT * FROM system.zookeeper WHERE path &#x3D; ‘&#x2F;‘；</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n\n检查连接：8123、9000端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<ol>\n<li>echo ‘show databases’ | curl -H ‘X-ClickHouse-User: default’ -H ‘X-ClickHouse-Key: Inboc@2020’ ‘<a href=\"http://10.13.3.101:8123/\">http://10.13.3.101:8123/</a>‘ -d @-</li>\n<li>clickhouse-client 登录 使用local:9000,</li>\n<li>datagrip工具，使用9000端口，用户和密码，可以登录<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n-------------------\n使用出现的问题：\nPython连接8123端口不成功,users.xml 配置错误，删除后可以使用。\n\n--------------------\n\n以下是metrika.xml.j2循环和自动获取<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ck_cluster>  \n  \n\n</ck_cluster>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<zookeeper>  \n  \n  \n</zookeeper>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n## 四、维护使用\n----------------\n#### 1. 配置解析\n **config.xml**<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n    <logger>                                                    <!--日志设置-->\n        <console>true</console>                                 <!--是否将日志输出到控制台-->\n        <level>trace</level>                                    <!--日志级别，可以是debug/info/warning/error;trace是输出所有、建议设置为info/warning-->\n        <log>/var/log/clickhouse-server/clickhouse-server.log</log>     <!--日志文件路径-->\n        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>       \n        <size>1000M</size>                                        <!--日志文件最大size-->\n        <count>10</count>                                         <!--日志文件最大数量-->\n        <levels>\n          <ConfigReloader>none</ConfigReloader>                  <!--是否允许服务在运行中响应配置文件变化-->\n        </levels>\n    </logger>\n    \n<pre><code>&lt;interserver_listen_host&gt;::&lt;/interserver_listen_host&gt;        &lt;!--监听集群内节点机器的IP地址，适用于节点有多个网络接口的情况--&gt;\n&lt;max_connections&gt;4096&lt;/max_connections&gt;                      &lt;!--可以同时处理的最大客户端连接数--&gt;\n&lt;max_concurrent_queries&gt;100&lt;/max_concurrent_queries&gt;         &lt;!--允许同事处理的最大查询数量--&gt;\n&lt;keep_alive_timeout&gt;3&lt;/keep_alive_timeout&gt;                   &lt;!--心跳时间--&gt;\n&lt;max_server_memory_usage&gt;0&lt;/max_server_memory_usage&gt;         &lt;!--允许服务器最多可以使用的内存量,单位是字节--&gt;   \n&lt;max_server_memory_usage_to_ram_ratio&gt;0.9&lt;/max_server_memory_usage_to_ram_ratio&gt;   &lt;!--ClickHouse服务器可以使用的内存量与系统总内存量之间的比例--&gt;\n&lt;max_open_files&gt;262144&lt;/max_open_files&gt;                       &lt;!--系统同时打开的最大文件数--&gt;\n&lt;uncompressed_cache_size&gt;8589934592&lt;/uncompressed_cache_size&gt;  &lt;!--指定了在内存中用于缓存未压缩块的空间大小--&gt;\n&lt;mark_cache_size&gt;5368709120&lt;/mark_cache_size&gt;                   &lt;!--指定在内存中用于缓存标记的空间大小--&gt;\n&lt;path&gt;/var/lib/clickhouse/&lt;/path&gt;                               &lt;!--数据存储位置，需要带斜杠指定到目录内--&gt;\n&lt;user_files_path&gt;/var/lib/clickhouse/user_files/&lt;/user_files_path&gt;            &lt;!--设置用户上传文件的存储路径--&gt;\n&lt;path&gt;/var/lib/clickhouse/access/&lt;/path&gt;                             &lt;!--存储由SQL命令创建的用户的文件夹的路径--&gt;\n&lt;default_database&gt;default&lt;/default_database&gt;                         &lt;!--默认的数据库名称--&gt;\n&lt;prometheus&gt;                                                         &lt;!--prometheus监控--&gt;\n    &lt;endpoint&gt;/metrics&lt;/endpoint&gt;                                  \n    &lt;port&gt;9363&lt;/port&gt;\n    &lt;metrics&gt;true&lt;/metrics&gt;                                          \n    &lt;events&gt;true&lt;/events&gt;\n    &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt;\n    &lt;status_info&gt;true&lt;/status_info&gt;\n&lt;/prometheus&gt;\n&lt;query_log&gt;                                                &lt;!--需要log_queries=1，记录接收到的查询。查询记录在system.query_log表，而不记录在单独文件中--&gt;\n    &lt;database&gt;system&lt;/database&gt;   --库名\n    &lt;table&gt;query_log&lt;/table&gt;   --表名\n    &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt;  --自定义分区键\n    &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;  --将数据从内存中的缓冲区刷新到表的时间间隔\n&lt;/query_log&gt;\n&lt;query_thread_log&gt;\n    &lt;database&gt;system&lt;/database&gt;     --库名\n    &lt;table&gt;query_thread_log&lt;/table&gt;  --接收数据写入的系统日志表名\n    &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt;  --自定义分区键\n    &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;  --将数据从内存中的缓冲区刷新到表的时间间隔\n&lt;/query_thread_log&gt;\n</code></pre>\n<pre><code>\n#### 2. 重要路径 （默认未修改）\n\n| 名称 | 路径 |\n| :---: | :---: |\n|log|/var/log/clickhouse-server/clickhouse-server.log|\n| errorlog |/var/log/clickhouse-server/clickhouse-server.err.log|\n|data|/var/lib/clickhouse/access/|\n|user_files|/var/lib/clickhouse/user_files/|\n\n#### 3. 优化\n1. 日志级别设置为info(实践一次，并未成功，暂无原因)\n2. 以及zookeeper日志，通过设定环境变量配置日志级别和输出方式，ZOO_LOG4J_PROP=&quot;INFO,ROLLINGFILE&quot;\n3. 配置监控，基于metric、prometheus&amp;grafana\n----------------\n#### 4. 系统表\n1. 存储于 `system` 数据库，提供信息包括：服务器的状态、进程、环境、服务器的内部进程\n2. system.cluster\n|字段|信息|\n|:---:|:---:|\n|cluster|集群名|\n|shard_num|集群中的分片数，从1开始|\n|shard_weight|写数据时该分片的相对权重|\n|replica_num|分片的副本数量，从1开始|\n|host_name|配置中指定的主机名|\n|host_address|从DNS获取的主机IP地址|\n|port|连接到服务器的端口|\n|user|连接到服务器的用户名|\n|errors_count| 此主机无法访问副本的次数|\n|slowdowns_count|与对冲请求建立连接时导致更改副本的减速次数|\n|estimated_recovery_time|剩下的秒数，直到副本错误计数归零并被视为恢复正常|\n3. system.metrics\n|metric|value|description|信息|\n|:---:|:---:|:---:|:---:|\n|Query|1|Number of executing queries|执行查询的数量|\n|Merge|0|Number of executing background merges|后台合并的数量|\n| PartMutation |0|Number of mutations (ALTER DELETE/UPDATE)|数据删除、更新操作数|\n|ReplicatedFetch| 0|Number of data parts being fetched from replicas|从副本中获取的数据块的数量|\n| ReplicatedSend |0|Number of data parts being sent to replicas|向副本传递的数据块的数量|\n|ReplicatedChecks|0|Number of data parts checking for consistency|正在进行一致性检查的数据块数量|\n|BackgroundMergesAndMutationsPoolTask|0 |Number of active merges and mutations in an associated background pool |后台线程池中活跃的合并和更新数量|\n|BackgroundFetchesPoolTask |0 |Number of active fetches in an associated background pool |正在使用后台线程池执行的查询的并发数|\n|BackgroundCommonPoolTask |0|Number of active tasks in an associated background pool|正在执行的任务数|\n|BackgroundMovePoolTask | 0 |Number of active tasks in BackgroundProcessingPool for moves|正在执行的数据迁移任务的数量|\n\n -----------\n#### 5. 运维常见问题排查和参考。（参考链接）\n1. [博客园--clickhouse常见问题排查](https://www.cnblogs.com/qiu-hua/p/15113806.html)涉及副本节点不一致、副本节点全量恢复......\n2. [本地备份](https://www.kubesre.com/archives/clickhousebei-fen-yu-hui-fu)\n3. [基于复制的故障恢复](http://jackpgao.github.io/2017/12/18/ClickHouse-Recovery-basedon-Replication/)节点宕机不可恢复、新增节点到集群的方案介绍\n4. [ClickHouse 集群分片下扩容副本的方式](https://opensource.actionsky.com/20211111-clickhouse/)\n#### 6.扩容\n   1. 增加机器--zookeeper 安装、clickhouse 安装、做自解析\n   2. 修改配置文件，增加扩容分片，配置其中的副本节点（最好修改权重）、配置zookeeper\n   3. 启动新节点，创建本地表和分布式表\n   4. 对旧节点做配置修改\n   5. 测试（某节点宕机数据不可恢复时，应能采取相同步骤对集群新增节点恢复集群架构、或许引擎树的选择将影响是否需要手动传输历史数据）\n   6. [集群参考贴](https://blog.51cto.com/feko/2738319)\n   \n</code></pre>\n"},{"title":"deploy_hexo","date":"2023-10-15T05:15:56.000Z","toc":true,"summary":"记录自己使用 hexo 建立这个博客网站的过程，主要内容来源网络。","_content":"## 1. 安装 node.js、npm\n- 过程如此，但是包需要重新找，网页通过这个链接去官网然后复制下载链接即可，不然会安装hexo失败\n- 由于node.js默认配置了npm，所以不用单独下载和配置npm了，只要node.js安装成功，那么是直接可以使用npm命令来下载moudle的\n```\nwget https://nodejs.org/dist/v12.16.1/node-v12.16.1-linux-x64.tar.xz\ntar tvf ./node-v12.16.1-linux-x64.tar.xz    # 查看压缩结构\ntar xvf ./node-v12.16.1-linux-x64.tar.xz -C /usr/local/\nln -s /usr/local/node-v12.16.1-linux-x64/bin/node /usr/bin/node\nln -s /usr/local/node-v12.16.1-linux-x64/bin/npm /usr/bin/npm\n```\n\n## 2. 安装 hexo 并初始化\n- 个人执行初始化失败，检查发现原因是hexo版本和nodejs版本不兼容，升级nodejs\n```\nnpm install hexo-cli -g\nln -s /usr/local/node-v12.16.1-linux-x64/bin/hexo /usr/local/bin/hexo\nhexo init blog  # 这需要是一个你自己设计好的路径下的空文件夹\nhexo server  # 测试运行本工具，发布在本服务器4000端口\n```\n## 3. hexo 主题\n因为某个站长接触到hexo，然后再对比之后觉得这个站点框架比较好，所以选择这个hexo，并直接根据这个帖子使用了这个[主题](http://blinkfox.com/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao)\n\n## 4. 上传 github\n- 同步到 github 远程仓库的步骤，请找专项的帖子，略\n- 有个坑，themes 下的主题文件夹因为是 git clone 到这个路径的，其中有 '.git' 目录信息，不能正常上传，[解决办法](https://blog.csdn.net/liaoweilin0529/article/details/113650333)来源于这位\n\n## 5. 部署到 gh-pages 分支\n- 借助了 hexo 的脚本和工具，将实现前端代码存在gh-pages分支，利用 github 的 pages 功能即可发布这个站点。源码和前端代码分别存在 main 和 gh-pages 分支\n- 一键部署的[参考](https://hexo.io/zh-cn/docs/one-command-deployment.html)\n- 再次测试图片应该放张图片的，但是github可以渲染，博客不能。。。。。。作为下一步需要搞懂的地方\n\n## 6. 访问\n去 action 查看url\n\n## 7. 测试维护和书写流程\n- 新建一篇blog\n```\nhexo new \"filename\"\n```\n\n测试过程：\n这是一篇测试用的帖子，学习使用 hexo、书写帖子、发布内容\n目前出现的问题是没有内容\n需要搞懂书写之后，应该怎么样推送或者命令发布\n测试1，修改然后 clean && deploy，然后push\n测试2，先push 然后deploy\n还要修改音乐模块\n同步之后修改不成功\n测试这次修改的流程，直接push----main分支已经变化，但是gh-pages没有部署成功\n修改+ clean + deploy ----网页已经变化，gh-pages变化，main分支代码无变化\n修改+ clean + deploy  + push ---- 完整的正常流程（源代码在main分支保存并修改，deploy将生成前端代码并发布到gh-pages）\n## 8. 解决代码行号和复制功能的错乱。\n- previous: all commented\n- current as follows: if noneffective ,try `npm uninstall hexo-prism-plugin` first ; after changed the `_config.yml` , delete the `.deploy_git` category (using for gitpage) ; the repost all the article.\n\n```yaml\nhighlight:\n  enable: false\n  line_number: true\n  auto_detect: false\n  tab_replace: ''\n  wrap: true\n  hljs: false\nprismjs:\n  enable: true\n  preprocess: true\n  line_number: true\n  tab_replace: ''\n```\n\n\n## 更新\n### 迁移到新机器 ubuntu 2004 安装node npm\n#### 使用nvm \nnvm 命令安装\n```bash\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash\n\n# 申明一下变量，这是执行上述脚本之后在终端的输出提示\nexport NVM_DIR=\"$HOME/.nvm\"\n[ -s \"$NVM_DIR/nvm.sh\" ] && \\. \"$NVM_DIR/nvm.sh\"  # This loads nvm\n[ -s \"$NVM_DIR/bash_completion\" ] && \\. \"$NVM_DIR/bash_completion\"\nnvm --version # 将输出安装版本\n```\n\nnvm 安装nodejs\n```bash\n# download and install Node.js\nnvm install 18\n\n# verifies the right Node.js version is in the environment\nnode -v # should print `v18.20.2`\n\n# verifies the right NPM version is in the environment\nnpm -v # should print `10.5.0`\n```\n\n提示 npm 需要升级\n`npm install -g npm@10.5.2`\n\n安装 hexo 有关包：\n```\n npm install hexo-cli -g\n[root@oncloud ops_blog]# npm ls -depth 0\nnpm WARN npm npm does not support Node.js v16.18.1\nnpm WARN npm You should probably upgrade to a newer version of node as we\nnpm WARN npm can't make any promises that npm will work with this version.\nnpm WARN npm Supported releases of Node.js are the latest release of 6, 8, 9, 10, 11, 12, 13.\nnpm WARN npm You can find the latest version at https://nodejs.org/\nhexo-site@0.0.0 /root/project/ops_blog\n├── hexo@6.3.0\n├── hexo-deployer-git@4.0.0\n├── hexo-generator-archive@2.0.0\n├── hexo-generator-category@2.0.0\n├── hexo-generator-index@3.0.0\n├── hexo-generator-search@2.4.3\n├── hexo-generator-tag@2.0.0\n├── hexo-markmap@1.2.5\n├── hexo-permalink-pinyin@1.1.0\n├── hexo-renderer-ejs@2.0.0\n├── hexo-renderer-marked@6.1.1\n├── hexo-renderer-stylus@3.0.0\n├── hexo-server@3.0.0\n├── hexo-theme-landscape@1.0.0\n└── hexo-wordcount@6.0.1\n\n```\n\n** hexo deploy  出现错误 **\n```\nError: Spawn failed\n    at ChildProcess.<anonymous> (/home/user/project/ops_blog/node_modules/hexo-util/lib/spawn.js:51:21)\n    at ChildProcess.emit (node:events:517:28)\n    at ChildProcess._handle.onexit (node:internal/child_process:292:12)\n```\n本次的解决办法是，将 .deploy_git 删除，重新 deploy 发布 post 即可。\n\n## 更新二\n### 文章 front-matter 设置\n- 设置路径`/scaffolds/post.md`，文章元数据默认就不用再次修改了\n```\n---\ntitle: typora-vue-theme主题介绍\ndate: 2018-09-07 09:25:00\nauthor: 赵奇\nimg: /source/images/xxx.jpg\ntop: true\ncover: true\ncoverImg: /images/1.jpg\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: false\nmathjax: false\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Markdown\ntags:\n  - Typora\n  - Markdown\n---\n```\n\n## 更新三\n### 发布到 github pages \n进入仓库的设置页面修改代码仓名，Settings→General→Repository name→Rename，修改为对应的*.github.io路径\n### 修改 hexo 发布配置 `_config.yml`\n```\n# 发布到 github 时希望得到的访问地址和路径\nurl: https://check-lc.github.io\nroot: /\n# 发布设置\ndeploy:\n  type: git\n  repo: git@github.com:Check-LC/check-lc.github.io.git\n  branch: gh-pages\n```\n\n访问这个url `https://check-lc.github.io` 即是blog地址","source":"_posts/deploy-hexo.md","raw":"---\ntitle: deploy_hexo\ndate: 2023-10-15 13:15:56\ntags:\n  - hexo\n  - blog\ncategories:\n  - hexo\ntoc: true\nsummary: 记录自己使用 hexo 建立这个博客网站的过程，主要内容来源网络。\n---\n## 1. 安装 node.js、npm\n- 过程如此，但是包需要重新找，网页通过这个链接去官网然后复制下载链接即可，不然会安装hexo失败\n- 由于node.js默认配置了npm，所以不用单独下载和配置npm了，只要node.js安装成功，那么是直接可以使用npm命令来下载moudle的\n```\nwget https://nodejs.org/dist/v12.16.1/node-v12.16.1-linux-x64.tar.xz\ntar tvf ./node-v12.16.1-linux-x64.tar.xz    # 查看压缩结构\ntar xvf ./node-v12.16.1-linux-x64.tar.xz -C /usr/local/\nln -s /usr/local/node-v12.16.1-linux-x64/bin/node /usr/bin/node\nln -s /usr/local/node-v12.16.1-linux-x64/bin/npm /usr/bin/npm\n```\n\n## 2. 安装 hexo 并初始化\n- 个人执行初始化失败，检查发现原因是hexo版本和nodejs版本不兼容，升级nodejs\n```\nnpm install hexo-cli -g\nln -s /usr/local/node-v12.16.1-linux-x64/bin/hexo /usr/local/bin/hexo\nhexo init blog  # 这需要是一个你自己设计好的路径下的空文件夹\nhexo server  # 测试运行本工具，发布在本服务器4000端口\n```\n## 3. hexo 主题\n因为某个站长接触到hexo，然后再对比之后觉得这个站点框架比较好，所以选择这个hexo，并直接根据这个帖子使用了这个[主题](http://blinkfox.com/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao)\n\n## 4. 上传 github\n- 同步到 github 远程仓库的步骤，请找专项的帖子，略\n- 有个坑，themes 下的主题文件夹因为是 git clone 到这个路径的，其中有 '.git' 目录信息，不能正常上传，[解决办法](https://blog.csdn.net/liaoweilin0529/article/details/113650333)来源于这位\n\n## 5. 部署到 gh-pages 分支\n- 借助了 hexo 的脚本和工具，将实现前端代码存在gh-pages分支，利用 github 的 pages 功能即可发布这个站点。源码和前端代码分别存在 main 和 gh-pages 分支\n- 一键部署的[参考](https://hexo.io/zh-cn/docs/one-command-deployment.html)\n- 再次测试图片应该放张图片的，但是github可以渲染，博客不能。。。。。。作为下一步需要搞懂的地方\n\n## 6. 访问\n去 action 查看url\n\n## 7. 测试维护和书写流程\n- 新建一篇blog\n```\nhexo new \"filename\"\n```\n\n测试过程：\n这是一篇测试用的帖子，学习使用 hexo、书写帖子、发布内容\n目前出现的问题是没有内容\n需要搞懂书写之后，应该怎么样推送或者命令发布\n测试1，修改然后 clean && deploy，然后push\n测试2，先push 然后deploy\n还要修改音乐模块\n同步之后修改不成功\n测试这次修改的流程，直接push----main分支已经变化，但是gh-pages没有部署成功\n修改+ clean + deploy ----网页已经变化，gh-pages变化，main分支代码无变化\n修改+ clean + deploy  + push ---- 完整的正常流程（源代码在main分支保存并修改，deploy将生成前端代码并发布到gh-pages）\n## 8. 解决代码行号和复制功能的错乱。\n- previous: all commented\n- current as follows: if noneffective ,try `npm uninstall hexo-prism-plugin` first ; after changed the `_config.yml` , delete the `.deploy_git` category (using for gitpage) ; the repost all the article.\n\n```yaml\nhighlight:\n  enable: false\n  line_number: true\n  auto_detect: false\n  tab_replace: ''\n  wrap: true\n  hljs: false\nprismjs:\n  enable: true\n  preprocess: true\n  line_number: true\n  tab_replace: ''\n```\n\n\n## 更新\n### 迁移到新机器 ubuntu 2004 安装node npm\n#### 使用nvm \nnvm 命令安装\n```bash\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash\n\n# 申明一下变量，这是执行上述脚本之后在终端的输出提示\nexport NVM_DIR=\"$HOME/.nvm\"\n[ -s \"$NVM_DIR/nvm.sh\" ] && \\. \"$NVM_DIR/nvm.sh\"  # This loads nvm\n[ -s \"$NVM_DIR/bash_completion\" ] && \\. \"$NVM_DIR/bash_completion\"\nnvm --version # 将输出安装版本\n```\n\nnvm 安装nodejs\n```bash\n# download and install Node.js\nnvm install 18\n\n# verifies the right Node.js version is in the environment\nnode -v # should print `v18.20.2`\n\n# verifies the right NPM version is in the environment\nnpm -v # should print `10.5.0`\n```\n\n提示 npm 需要升级\n`npm install -g npm@10.5.2`\n\n安装 hexo 有关包：\n```\n npm install hexo-cli -g\n[root@oncloud ops_blog]# npm ls -depth 0\nnpm WARN npm npm does not support Node.js v16.18.1\nnpm WARN npm You should probably upgrade to a newer version of node as we\nnpm WARN npm can't make any promises that npm will work with this version.\nnpm WARN npm Supported releases of Node.js are the latest release of 6, 8, 9, 10, 11, 12, 13.\nnpm WARN npm You can find the latest version at https://nodejs.org/\nhexo-site@0.0.0 /root/project/ops_blog\n├── hexo@6.3.0\n├── hexo-deployer-git@4.0.0\n├── hexo-generator-archive@2.0.0\n├── hexo-generator-category@2.0.0\n├── hexo-generator-index@3.0.0\n├── hexo-generator-search@2.4.3\n├── hexo-generator-tag@2.0.0\n├── hexo-markmap@1.2.5\n├── hexo-permalink-pinyin@1.1.0\n├── hexo-renderer-ejs@2.0.0\n├── hexo-renderer-marked@6.1.1\n├── hexo-renderer-stylus@3.0.0\n├── hexo-server@3.0.0\n├── hexo-theme-landscape@1.0.0\n└── hexo-wordcount@6.0.1\n\n```\n\n** hexo deploy  出现错误 **\n```\nError: Spawn failed\n    at ChildProcess.<anonymous> (/home/user/project/ops_blog/node_modules/hexo-util/lib/spawn.js:51:21)\n    at ChildProcess.emit (node:events:517:28)\n    at ChildProcess._handle.onexit (node:internal/child_process:292:12)\n```\n本次的解决办法是，将 .deploy_git 删除，重新 deploy 发布 post 即可。\n\n## 更新二\n### 文章 front-matter 设置\n- 设置路径`/scaffolds/post.md`，文章元数据默认就不用再次修改了\n```\n---\ntitle: typora-vue-theme主题介绍\ndate: 2018-09-07 09:25:00\nauthor: 赵奇\nimg: /source/images/xxx.jpg\ntop: true\ncover: true\ncoverImg: /images/1.jpg\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: false\nmathjax: false\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Markdown\ntags:\n  - Typora\n  - Markdown\n---\n```\n\n## 更新三\n### 发布到 github pages \n进入仓库的设置页面修改代码仓名，Settings→General→Repository name→Rename，修改为对应的*.github.io路径\n### 修改 hexo 发布配置 `_config.yml`\n```\n# 发布到 github 时希望得到的访问地址和路径\nurl: https://check-lc.github.io\nroot: /\n# 发布设置\ndeploy:\n  type: git\n  repo: git@github.com:Check-LC/check-lc.github.io.git\n  branch: gh-pages\n```\n\n访问这个url `https://check-lc.github.io` 即是blog地址","slug":"deploy-hexo","published":1,"updated":"2024-04-25T07:08:11.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodj4000x80rvd2ndeage","content":"<h2 id=\"1-安装-node-js、npm\"><a href=\"#1-安装-node-js、npm\" class=\"headerlink\" title=\"1. 安装 node.js、npm\"></a>1. 安装 node.js、npm</h2><ul>\n<li>过程如此，但是包需要重新找，网页通过这个链接去官网然后复制下载链接即可，不然会安装hexo失败</li>\n<li>由于node.js默认配置了npm，所以不用单独下载和配置npm了，只要node.js安装成功，那么是直接可以使用npm命令来下载moudle的<pre class=\"line-numbers language-none\"><code class=\"language-none\">wget https:&#x2F;&#x2F;nodejs.org&#x2F;dist&#x2F;v12.16.1&#x2F;node-v12.16.1-linux-x64.tar.xz\ntar tvf .&#x2F;node-v12.16.1-linux-x64.tar.xz    # 查看压缩结构\ntar xvf .&#x2F;node-v12.16.1-linux-x64.tar.xz -C &#x2F;usr&#x2F;local&#x2F;\nln -s &#x2F;usr&#x2F;local&#x2F;node-v12.16.1-linux-x64&#x2F;bin&#x2F;node &#x2F;usr&#x2F;bin&#x2F;node\nln -s &#x2F;usr&#x2F;local&#x2F;node-v12.16.1-linux-x64&#x2F;bin&#x2F;npm &#x2F;usr&#x2F;bin&#x2F;npm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"2-安装-hexo-并初始化\"><a href=\"#2-安装-hexo-并初始化\" class=\"headerlink\" title=\"2. 安装 hexo 并初始化\"></a>2. 安装 hexo 并初始化</h2><ul>\n<li>个人执行初始化失败，检查发现原因是hexo版本和nodejs版本不兼容，升级nodejs<pre class=\"line-numbers language-none\"><code class=\"language-none\">npm install hexo-cli -g\nln -s &#x2F;usr&#x2F;local&#x2F;node-v12.16.1-linux-x64&#x2F;bin&#x2F;hexo &#x2F;usr&#x2F;local&#x2F;bin&#x2F;hexo\nhexo init blog  # 这需要是一个你自己设计好的路径下的空文件夹\nhexo server  # 测试运行本工具，发布在本服务器4000端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"3-hexo-主题\"><a href=\"#3-hexo-主题\" class=\"headerlink\" title=\"3. hexo 主题\"></a>3. hexo 主题</h2><p>因为某个站长接触到hexo，然后再对比之后觉得这个站点框架比较好，所以选择这个hexo，并直接根据这个帖子使用了这个<a href=\"http://blinkfox.com/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao\">主题</a></p>\n<h2 id=\"4-上传-github\"><a href=\"#4-上传-github\" class=\"headerlink\" title=\"4. 上传 github\"></a>4. 上传 github</h2><ul>\n<li>同步到 github 远程仓库的步骤，请找专项的帖子，略</li>\n<li>有个坑，themes 下的主题文件夹因为是 git clone 到这个路径的，其中有 ‘.git’ 目录信息，不能正常上传，<a href=\"https://blog.csdn.net/liaoweilin0529/article/details/113650333\">解决办法</a>来源于这位</li>\n</ul>\n<h2 id=\"5-部署到-gh-pages-分支\"><a href=\"#5-部署到-gh-pages-分支\" class=\"headerlink\" title=\"5. 部署到 gh-pages 分支\"></a>5. 部署到 gh-pages 分支</h2><ul>\n<li>借助了 hexo 的脚本和工具，将实现前端代码存在gh-pages分支，利用 github 的 pages 功能即可发布这个站点。源码和前端代码分别存在 main 和 gh-pages 分支</li>\n<li>一键部署的<a href=\"https://hexo.io/zh-cn/docs/one-command-deployment.html\">参考</a></li>\n<li>再次测试图片应该放张图片的，但是github可以渲染，博客不能。。。。。。作为下一步需要搞懂的地方</li>\n</ul>\n<h2 id=\"6-访问\"><a href=\"#6-访问\" class=\"headerlink\" title=\"6. 访问\"></a>6. 访问</h2><p>去 action 查看url</p>\n<h2 id=\"7-测试维护和书写流程\"><a href=\"#7-测试维护和书写流程\" class=\"headerlink\" title=\"7. 测试维护和书写流程\"></a>7. 测试维护和书写流程</h2><ul>\n<li>新建一篇blog<pre class=\"line-numbers language-none\"><code class=\"language-none\">hexo new &quot;filename&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n</ul>\n<p>测试过程：<br>这是一篇测试用的帖子，学习使用 hexo、书写帖子、发布内容<br>目前出现的问题是没有内容<br>需要搞懂书写之后，应该怎么样推送或者命令发布<br>测试1，修改然后 clean &amp;&amp; deploy，然后push<br>测试2，先push 然后deploy<br>还要修改音乐模块<br>同步之后修改不成功<br>测试这次修改的流程，直接push—-main分支已经变化，但是gh-pages没有部署成功<br>修改+ clean + deploy —-网页已经变化，gh-pages变化，main分支代码无变化<br>修改+ clean + deploy  + push —- 完整的正常流程（源代码在main分支保存并修改，deploy将生成前端代码并发布到gh-pages）</p>\n<h2 id=\"8-解决代码行号和复制功能的错乱。\"><a href=\"#8-解决代码行号和复制功能的错乱。\" class=\"headerlink\" title=\"8. 解决代码行号和复制功能的错乱。\"></a>8. 解决代码行号和复制功能的错乱。</h2><ul>\n<li>previous: all commented</li>\n<li>current as follows: if noneffective ,try <code>npm uninstall hexo-prism-plugin</code> first ; after changed the <code>_config.yml</code> , delete the <code>.deploy_git</code> category (using for gitpage) ; the repost all the article.</li>\n</ul>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">highlight</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token key atrule\">line_number</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">auto_detect</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token key atrule\">tab_replace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">''</span>\n  <span class=\"token key atrule\">wrap</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">hljs</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n<span class=\"token key atrule\">prismjs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">preprocess</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">line_number</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">tab_replace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<h2 id=\"更新\"><a href=\"#更新\" class=\"headerlink\" title=\"更新\"></a>更新</h2><h3 id=\"迁移到新机器-ubuntu-2004-安装node-npm\"><a href=\"#迁移到新机器-ubuntu-2004-安装node-npm\" class=\"headerlink\" title=\"迁移到新机器 ubuntu 2004 安装node npm\"></a>迁移到新机器 ubuntu 2004 安装node npm</h3><h4 id=\"使用nvm\"><a href=\"#使用nvm\" class=\"headerlink\" title=\"使用nvm\"></a>使用nvm</h4><p>nvm 命令安装</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh <span class=\"token operator\">|</span> <span class=\"token function\">bash</span>\n\n<span class=\"token comment\"># 申明一下变量，这是执行上述脚本之后在终端的输出提示</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">NVM_DIR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token environment constant\">$HOME</span>/.nvm\"</span>\n<span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$NVM_DIR</span>/nvm.sh\"</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span>. <span class=\"token string\">\"<span class=\"token variable\">$NVM_DIR</span>/nvm.sh\"</span>  <span class=\"token comment\"># This loads nvm</span>\n<span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$NVM_DIR</span>/bash_completion\"</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span>. <span class=\"token string\">\"<span class=\"token variable\">$NVM_DIR</span>/bash_completion\"</span>\nnvm <span class=\"token parameter variable\">--version</span> <span class=\"token comment\"># 将输出安装版本</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>nvm 安装nodejs</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># download and install Node.js</span>\nnvm <span class=\"token function\">install</span> <span class=\"token number\">18</span>\n\n<span class=\"token comment\"># verifies the right Node.js version is in the environment</span>\n<span class=\"token function\">node</span> <span class=\"token parameter variable\">-v</span> <span class=\"token comment\"># should print `v18.20.2`</span>\n\n<span class=\"token comment\"># verifies the right NPM version is in the environment</span>\n<span class=\"token function\">npm</span> <span class=\"token parameter variable\">-v</span> <span class=\"token comment\"># should print `10.5.0`</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>提示 npm 需要升级<br><code>npm install -g npm@10.5.2</code></p>\n<p>安装 hexo 有关包：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"> npm install hexo-cli -g\n[root@oncloud ops_blog]# npm ls -depth 0\nnpm WARN npm npm does not support Node.js v16.18.1\nnpm WARN npm You should probably upgrade to a newer version of node as we\nnpm WARN npm can&#39;t make any promises that npm will work with this version.\nnpm WARN npm Supported releases of Node.js are the latest release of 6, 8, 9, 10, 11, 12, 13.\nnpm WARN npm You can find the latest version at https:&#x2F;&#x2F;nodejs.org&#x2F;\nhexo-site@0.0.0 &#x2F;root&#x2F;project&#x2F;ops_blog\n├── hexo@6.3.0\n├── hexo-deployer-git@4.0.0\n├── hexo-generator-archive@2.0.0\n├── hexo-generator-category@2.0.0\n├── hexo-generator-index@3.0.0\n├── hexo-generator-search@2.4.3\n├── hexo-generator-tag@2.0.0\n├── hexo-markmap@1.2.5\n├── hexo-permalink-pinyin@1.1.0\n├── hexo-renderer-ejs@2.0.0\n├── hexo-renderer-marked@6.1.1\n├── hexo-renderer-stylus@3.0.0\n├── hexo-server@3.0.0\n├── hexo-theme-landscape@1.0.0\n└── hexo-wordcount@6.0.1\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>** hexo deploy  出现错误 **</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Error: Spawn failed\n    at ChildProcess.&lt;anonymous&gt; (&#x2F;home&#x2F;user&#x2F;project&#x2F;ops_blog&#x2F;node_modules&#x2F;hexo-util&#x2F;lib&#x2F;spawn.js:51:21)\n    at ChildProcess.emit (node:events:517:28)\n    at ChildProcess._handle.onexit (node:internal&#x2F;child_process:292:12)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p>本次的解决办法是，将 .deploy_git 删除，重新 deploy 发布 post 即可。</p>\n<h2 id=\"更新二\"><a href=\"#更新二\" class=\"headerlink\" title=\"更新二\"></a>更新二</h2><h3 id=\"文章-front-matter-设置\"><a href=\"#文章-front-matter-设置\" class=\"headerlink\" title=\"文章 front-matter 设置\"></a>文章 front-matter 设置</h3><ul>\n<li>设置路径<code>/scaffolds/post.md</code>，文章元数据默认就不用再次修改了<pre class=\"line-numbers language-none\"><code class=\"language-none\">---\ntitle: typora-vue-theme主题介绍\ndate: 2018-09-07 09:25:00\nauthor: 赵奇\nimg: &#x2F;source&#x2F;images&#x2F;xxx.jpg\ntop: true\ncover: true\ncoverImg: &#x2F;images&#x2F;1.jpg\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: false\nmathjax: false\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Markdown\ntags:\n  - Typora\n  - Markdown\n---<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"更新三\"><a href=\"#更新三\" class=\"headerlink\" title=\"更新三\"></a>更新三</h2><h3 id=\"发布到-github-pages\"><a href=\"#发布到-github-pages\" class=\"headerlink\" title=\"发布到 github pages\"></a>发布到 github pages</h3><p>进入仓库的设置页面修改代码仓名，Settings→General→Repository name→Rename，修改为对应的*.github.io路径</p>\n<h3 id=\"修改-hexo-发布配置-config-yml\"><a href=\"#修改-hexo-发布配置-config-yml\" class=\"headerlink\" title=\"修改 hexo 发布配置 _config.yml\"></a>修改 hexo 发布配置 <code>_config.yml</code></h3><pre class=\"line-numbers language-none\"><code class=\"language-none\"># 发布到 github 时希望得到的访问地址和路径\nurl: https:&#x2F;&#x2F;check-lc.github.io\nroot: &#x2F;\n# 发布设置\ndeploy:\n  type: git\n  repo: git@github.com:Check-LC&#x2F;check-lc.github.io.git\n  branch: gh-pages<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>访问这个url <code>https://check-lc.github.io</code> 即是blog地址</p>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"1-安装-node-js、npm\"><a href=\"#1-安装-node-js、npm\" class=\"headerlink\" title=\"1. 安装 node.js、npm\"></a>1. 安装 node.js、npm</h2><ul>\n<li>过程如此，但是包需要重新找，网页通过这个链接去官网然后复制下载链接即可，不然会安装hexo失败</li>\n<li>由于node.js默认配置了npm，所以不用单独下载和配置npm了，只要node.js安装成功，那么是直接可以使用npm命令来下载moudle的<pre class=\"line-numbers language-none\"><code class=\"language-none\">wget https:&#x2F;&#x2F;nodejs.org&#x2F;dist&#x2F;v12.16.1&#x2F;node-v12.16.1-linux-x64.tar.xz\ntar tvf .&#x2F;node-v12.16.1-linux-x64.tar.xz    # 查看压缩结构\ntar xvf .&#x2F;node-v12.16.1-linux-x64.tar.xz -C &#x2F;usr&#x2F;local&#x2F;\nln -s &#x2F;usr&#x2F;local&#x2F;node-v12.16.1-linux-x64&#x2F;bin&#x2F;node &#x2F;usr&#x2F;bin&#x2F;node\nln -s &#x2F;usr&#x2F;local&#x2F;node-v12.16.1-linux-x64&#x2F;bin&#x2F;npm &#x2F;usr&#x2F;bin&#x2F;npm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"2-安装-hexo-并初始化\"><a href=\"#2-安装-hexo-并初始化\" class=\"headerlink\" title=\"2. 安装 hexo 并初始化\"></a>2. 安装 hexo 并初始化</h2><ul>\n<li>个人执行初始化失败，检查发现原因是hexo版本和nodejs版本不兼容，升级nodejs<pre class=\"line-numbers language-none\"><code class=\"language-none\">npm install hexo-cli -g\nln -s &#x2F;usr&#x2F;local&#x2F;node-v12.16.1-linux-x64&#x2F;bin&#x2F;hexo &#x2F;usr&#x2F;local&#x2F;bin&#x2F;hexo\nhexo init blog  # 这需要是一个你自己设计好的路径下的空文件夹\nhexo server  # 测试运行本工具，发布在本服务器4000端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"3-hexo-主题\"><a href=\"#3-hexo-主题\" class=\"headerlink\" title=\"3. hexo 主题\"></a>3. hexo 主题</h2><p>因为某个站长接触到hexo，然后再对比之后觉得这个站点框架比较好，所以选择这个hexo，并直接根据这个帖子使用了这个<a href=\"http://blinkfox.com/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao\">主题</a></p>\n<h2 id=\"4-上传-github\"><a href=\"#4-上传-github\" class=\"headerlink\" title=\"4. 上传 github\"></a>4. 上传 github</h2><ul>\n<li>同步到 github 远程仓库的步骤，请找专项的帖子，略</li>\n<li>有个坑，themes 下的主题文件夹因为是 git clone 到这个路径的，其中有 ‘.git’ 目录信息，不能正常上传，<a href=\"https://blog.csdn.net/liaoweilin0529/article/details/113650333\">解决办法</a>来源于这位</li>\n</ul>\n<h2 id=\"5-部署到-gh-pages-分支\"><a href=\"#5-部署到-gh-pages-分支\" class=\"headerlink\" title=\"5. 部署到 gh-pages 分支\"></a>5. 部署到 gh-pages 分支</h2><ul>\n<li>借助了 hexo 的脚本和工具，将实现前端代码存在gh-pages分支，利用 github 的 pages 功能即可发布这个站点。源码和前端代码分别存在 main 和 gh-pages 分支</li>\n<li>一键部署的<a href=\"https://hexo.io/zh-cn/docs/one-command-deployment.html\">参考</a></li>\n<li>再次测试图片应该放张图片的，但是github可以渲染，博客不能。。。。。。作为下一步需要搞懂的地方</li>\n</ul>\n<h2 id=\"6-访问\"><a href=\"#6-访问\" class=\"headerlink\" title=\"6. 访问\"></a>6. 访问</h2><p>去 action 查看url</p>\n<h2 id=\"7-测试维护和书写流程\"><a href=\"#7-测试维护和书写流程\" class=\"headerlink\" title=\"7. 测试维护和书写流程\"></a>7. 测试维护和书写流程</h2><ul>\n<li>新建一篇blog<pre class=\"line-numbers language-none\"><code class=\"language-none\">hexo new &quot;filename&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n</ul>\n<p>测试过程：<br>这是一篇测试用的帖子，学习使用 hexo、书写帖子、发布内容<br>目前出现的问题是没有内容<br>需要搞懂书写之后，应该怎么样推送或者命令发布<br>测试1，修改然后 clean &amp;&amp; deploy，然后push<br>测试2，先push 然后deploy<br>还要修改音乐模块<br>同步之后修改不成功<br>测试这次修改的流程，直接push—-main分支已经变化，但是gh-pages没有部署成功<br>修改+ clean + deploy —-网页已经变化，gh-pages变化，main分支代码无变化<br>修改+ clean + deploy  + push —- 完整的正常流程（源代码在main分支保存并修改，deploy将生成前端代码并发布到gh-pages）</p>\n<h2 id=\"8-解决代码行号和复制功能的错乱。\"><a href=\"#8-解决代码行号和复制功能的错乱。\" class=\"headerlink\" title=\"8. 解决代码行号和复制功能的错乱。\"></a>8. 解决代码行号和复制功能的错乱。</h2><ul>\n<li>previous: all commented</li>\n<li>current as follows: if noneffective ,try <code>npm uninstall hexo-prism-plugin</code> first ; after changed the <code>_config.yml</code> , delete the <code>.deploy_git</code> category (using for gitpage) ; the repost all the article.</li>\n</ul>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">highlight</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token key atrule\">line_number</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">auto_detect</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token key atrule\">tab_replace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">''</span>\n  <span class=\"token key atrule\">wrap</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">hljs</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n<span class=\"token key atrule\">prismjs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">preprocess</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">line_number</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">tab_replace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<h2 id=\"更新\"><a href=\"#更新\" class=\"headerlink\" title=\"更新\"></a>更新</h2><h3 id=\"迁移到新机器-ubuntu-2004-安装node-npm\"><a href=\"#迁移到新机器-ubuntu-2004-安装node-npm\" class=\"headerlink\" title=\"迁移到新机器 ubuntu 2004 安装node npm\"></a>迁移到新机器 ubuntu 2004 安装node npm</h3><h4 id=\"使用nvm\"><a href=\"#使用nvm\" class=\"headerlink\" title=\"使用nvm\"></a>使用nvm</h4><p>nvm 命令安装</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh <span class=\"token operator\">|</span> <span class=\"token function\">bash</span>\n\n<span class=\"token comment\"># 申明一下变量，这是执行上述脚本之后在终端的输出提示</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">NVM_DIR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token environment constant\">$HOME</span>/.nvm\"</span>\n<span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$NVM_DIR</span>/nvm.sh\"</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span>. <span class=\"token string\">\"<span class=\"token variable\">$NVM_DIR</span>/nvm.sh\"</span>  <span class=\"token comment\"># This loads nvm</span>\n<span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$NVM_DIR</span>/bash_completion\"</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span>. <span class=\"token string\">\"<span class=\"token variable\">$NVM_DIR</span>/bash_completion\"</span>\nnvm <span class=\"token parameter variable\">--version</span> <span class=\"token comment\"># 将输出安装版本</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>nvm 安装nodejs</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># download and install Node.js</span>\nnvm <span class=\"token function\">install</span> <span class=\"token number\">18</span>\n\n<span class=\"token comment\"># verifies the right Node.js version is in the environment</span>\n<span class=\"token function\">node</span> <span class=\"token parameter variable\">-v</span> <span class=\"token comment\"># should print `v18.20.2`</span>\n\n<span class=\"token comment\"># verifies the right NPM version is in the environment</span>\n<span class=\"token function\">npm</span> <span class=\"token parameter variable\">-v</span> <span class=\"token comment\"># should print `10.5.0`</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>提示 npm 需要升级<br><code>npm install -g npm@10.5.2</code></p>\n<p>安装 hexo 有关包：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"> npm install hexo-cli -g\n[root@oncloud ops_blog]# npm ls -depth 0\nnpm WARN npm npm does not support Node.js v16.18.1\nnpm WARN npm You should probably upgrade to a newer version of node as we\nnpm WARN npm can&#39;t make any promises that npm will work with this version.\nnpm WARN npm Supported releases of Node.js are the latest release of 6, 8, 9, 10, 11, 12, 13.\nnpm WARN npm You can find the latest version at https:&#x2F;&#x2F;nodejs.org&#x2F;\nhexo-site@0.0.0 &#x2F;root&#x2F;project&#x2F;ops_blog\n├── hexo@6.3.0\n├── hexo-deployer-git@4.0.0\n├── hexo-generator-archive@2.0.0\n├── hexo-generator-category@2.0.0\n├── hexo-generator-index@3.0.0\n├── hexo-generator-search@2.4.3\n├── hexo-generator-tag@2.0.0\n├── hexo-markmap@1.2.5\n├── hexo-permalink-pinyin@1.1.0\n├── hexo-renderer-ejs@2.0.0\n├── hexo-renderer-marked@6.1.1\n├── hexo-renderer-stylus@3.0.0\n├── hexo-server@3.0.0\n├── hexo-theme-landscape@1.0.0\n└── hexo-wordcount@6.0.1\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>** hexo deploy  出现错误 **</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Error: Spawn failed\n    at ChildProcess.&lt;anonymous&gt; (&#x2F;home&#x2F;user&#x2F;project&#x2F;ops_blog&#x2F;node_modules&#x2F;hexo-util&#x2F;lib&#x2F;spawn.js:51:21)\n    at ChildProcess.emit (node:events:517:28)\n    at ChildProcess._handle.onexit (node:internal&#x2F;child_process:292:12)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p>本次的解决办法是，将 .deploy_git 删除，重新 deploy 发布 post 即可。</p>\n<h2 id=\"更新二\"><a href=\"#更新二\" class=\"headerlink\" title=\"更新二\"></a>更新二</h2><h3 id=\"文章-front-matter-设置\"><a href=\"#文章-front-matter-设置\" class=\"headerlink\" title=\"文章 front-matter 设置\"></a>文章 front-matter 设置</h3><ul>\n<li>设置路径<code>/scaffolds/post.md</code>，文章元数据默认就不用再次修改了<pre class=\"line-numbers language-none\"><code class=\"language-none\">---\ntitle: typora-vue-theme主题介绍\ndate: 2018-09-07 09:25:00\nauthor: 赵奇\nimg: &#x2F;source&#x2F;images&#x2F;xxx.jpg\ntop: true\ncover: true\ncoverImg: &#x2F;images&#x2F;1.jpg\npassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92\ntoc: false\nmathjax: false\nsummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要\ncategories: Markdown\ntags:\n  - Typora\n  - Markdown\n---<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"更新三\"><a href=\"#更新三\" class=\"headerlink\" title=\"更新三\"></a>更新三</h2><h3 id=\"发布到-github-pages\"><a href=\"#发布到-github-pages\" class=\"headerlink\" title=\"发布到 github pages\"></a>发布到 github pages</h3><p>进入仓库的设置页面修改代码仓名，Settings→General→Repository name→Rename，修改为对应的*.github.io路径</p>\n<h3 id=\"修改-hexo-发布配置-config-yml\"><a href=\"#修改-hexo-发布配置-config-yml\" class=\"headerlink\" title=\"修改 hexo 发布配置 _config.yml\"></a>修改 hexo 发布配置 <code>_config.yml</code></h3><pre class=\"line-numbers language-none\"><code class=\"language-none\"># 发布到 github 时希望得到的访问地址和路径\nurl: https:&#x2F;&#x2F;check-lc.github.io\nroot: &#x2F;\n# 发布设置\ndeploy:\n  type: git\n  repo: git@github.com:Check-LC&#x2F;check-lc.github.io.git\n  branch: gh-pages<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>访问这个url <code>https://check-lc.github.io</code> 即是blog地址</p>\n"},{"title":"domain-management","author":"LC","toc":true,"date":"2024-04-30T15:17:49.000Z","img":null,"top":null,"cover":null,"password":null,"summary":"我的域名是来自较小的域名注册商，为了注册证书，将其迁移到 aliyun 管理，此处是来自阿里云的教程","_content":"# 如何平滑迁移至阿里云解析 DNS_云解析 DNS(DNS)-阿里云帮助中心\n\n我的 dns 提供商比较小，如此修改后才能使用 aliyundns 的 webhook api，配合 cert-manger 创建证书\n\n## 概述\n\n若您的域名解析当前托管在其他 DNS 厂商，想要迁移至阿里云解析 DNS 进行管理。本文将向您介绍如何平滑地将域名解析迁移至阿里云解析 DNS，避免您的业务因解析中断而受影响。\n\n## 准备工作\n\n*   域名如有配置 DNSSEC，请先到域名注册商处删除 DS 记录，并关闭 DNSSEC。等迁移完成后，再参考 [DNSSEC开启设置方法](https://help.aliyun.com/zh/dns/configure-dns-security-extensions#h2-dnssec-3)进行配置。如域名未配置 DNSSEC，则忽略此步骤。\n    \n    **警告**\n    \n    域名迁移之前请务必保证域名 DS 记录已删除、DNSSEC 功能关闭，否则会影响解析！如果您不清楚是否开启了 DNSSEC，可以咨询您的域名注册商询问 DNSSEC 的开启情况。\n    \n*   解析数据准备：请在原 DNS 服务商处导出解析记录，并按照 [DNS解析模板](https://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/97785/cn_zh/1560846859029/alidns_record.xlsx) 进行编辑整理好解析记录。\n    \n    **说明**\n    \n    若您当前 DNS 厂商不支持批量导出解析记录的功能，您可以直接将解析记录手动添加在 DNS 解析模板中，然后在云解析 DNS 产品控制台批量导入解析记录。或者您也可以直接在云解析 DNS 产品控制台手动添加解析记录。\n    \n\n## 操作步骤\n\n1.  在 [云解析DNS控制台](https://dns.console.aliyun.com/)，在 **域名解析** 页面选择 **权威域名** 页签，再单击 **添加域名** **。**如果您的域名是阿里云注册域名或者已经添加了域名，可忽略此步骤。\n    \n2.  单击目标域名进入 **解析设置** 页面，单击 **导入/导出** 按钮，在 **导入记录** 页面选择 **导入记录方式** ：**增量更新**或 **全量更新**，再单击 **上传文件** ，将编辑整理好的解析记录导入云解析 DNS。\n    \n3.  检查导入云解析 DNS 中配置的解析记录是否跟您之前的 DNS 厂商中设置的解析记录一致，避免漏配现象。\n    \n4.  前往您的域名注册商处，将 DNS 服务器修改为云解析 DNS 系统分配的地址（在云解析 DNS 控制台-**域名解析**页面-**解析设置** 页面-**查看 DNS 服务器** 可获取到系统分配的 DNS 服务器地址）。修改域名 DNS 服务器配置可参考 [修改DNS服务器](https://help.aliyun.com/zh/dns/change-the-dns-server/)。\n    \n    **重要**\n    \n    修改 DNS 服务器之前请检查域名是否开启了禁止更新锁，如果处于开启状态，请关闭禁止更新锁。如何确认域名是否开启了禁止更新锁，可以咨询您的域名注册商或者使用 [whois工具](https://whois.aliyun.com/)查询域名状态是否显示 serverUpdateProhibited。\n    \n5.  借助 DNS 流量分析功能查看您的服务请求流量是否有异常波动，持续观测至少10分钟。具体请参考 [DNS流量分析简介](https://help.aliyun.com/zh/dns/queryvolume)。\n    \n6.  无需其他操作，耐心等待解析生效即可，预计需要 48 小时完成全国各地 localDNS 的缓存刷新。\n    \n    **警告**\n    \n    *   为避免解析异常，在修改 DNS 服务器 48 小时内请尽量不变更解析记录。\n        \n    *   在 48 小时内 DNS 解析仍有可能向旧 DNS 厂商发起 DNS 查询，所以原 DNS 服务商中的解析记录数据不要马上删除，建议保留一周。\n        \n    *   在修改 DNS 服务器 48 小时内，如需做解析记录变更，请务必同时在新旧 DNS 服务商进行变更，以保持新旧 DNS 服务商的解析记录数据一致。\n        \n    \n    **说明**\n    \n    关于修改 DNS 服务器，需要多久才能在全网生效？\n    \n    答：一般需要 48 小时，因为各地 Localdns 服务器的域名缓存失效时间长短不一，需要等待各地 Localdns 服务器主动来更新该域名的最新 DNS 服务器地址，以实现逐步全网生效。请耐心等待这个过程。","source":"_posts/domain-management.md","raw":"---\ntitle: domain-management\nauthor: LC\ntoc: true\ndate: 2024-04-30 23:17:49\nimg:\ntop:\ncover:\npassword:\nsummary: 我的域名是来自较小的域名注册商，为了注册证书，将其迁移到 aliyun 管理，此处是来自阿里云的教程\ncategories: DNS\ntags: [DNS]\n---\n# 如何平滑迁移至阿里云解析 DNS_云解析 DNS(DNS)-阿里云帮助中心\n\n我的 dns 提供商比较小，如此修改后才能使用 aliyundns 的 webhook api，配合 cert-manger 创建证书\n\n## 概述\n\n若您的域名解析当前托管在其他 DNS 厂商，想要迁移至阿里云解析 DNS 进行管理。本文将向您介绍如何平滑地将域名解析迁移至阿里云解析 DNS，避免您的业务因解析中断而受影响。\n\n## 准备工作\n\n*   域名如有配置 DNSSEC，请先到域名注册商处删除 DS 记录，并关闭 DNSSEC。等迁移完成后，再参考 [DNSSEC开启设置方法](https://help.aliyun.com/zh/dns/configure-dns-security-extensions#h2-dnssec-3)进行配置。如域名未配置 DNSSEC，则忽略此步骤。\n    \n    **警告**\n    \n    域名迁移之前请务必保证域名 DS 记录已删除、DNSSEC 功能关闭，否则会影响解析！如果您不清楚是否开启了 DNSSEC，可以咨询您的域名注册商询问 DNSSEC 的开启情况。\n    \n*   解析数据准备：请在原 DNS 服务商处导出解析记录，并按照 [DNS解析模板](https://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/97785/cn_zh/1560846859029/alidns_record.xlsx) 进行编辑整理好解析记录。\n    \n    **说明**\n    \n    若您当前 DNS 厂商不支持批量导出解析记录的功能，您可以直接将解析记录手动添加在 DNS 解析模板中，然后在云解析 DNS 产品控制台批量导入解析记录。或者您也可以直接在云解析 DNS 产品控制台手动添加解析记录。\n    \n\n## 操作步骤\n\n1.  在 [云解析DNS控制台](https://dns.console.aliyun.com/)，在 **域名解析** 页面选择 **权威域名** 页签，再单击 **添加域名** **。**如果您的域名是阿里云注册域名或者已经添加了域名，可忽略此步骤。\n    \n2.  单击目标域名进入 **解析设置** 页面，单击 **导入/导出** 按钮，在 **导入记录** 页面选择 **导入记录方式** ：**增量更新**或 **全量更新**，再单击 **上传文件** ，将编辑整理好的解析记录导入云解析 DNS。\n    \n3.  检查导入云解析 DNS 中配置的解析记录是否跟您之前的 DNS 厂商中设置的解析记录一致，避免漏配现象。\n    \n4.  前往您的域名注册商处，将 DNS 服务器修改为云解析 DNS 系统分配的地址（在云解析 DNS 控制台-**域名解析**页面-**解析设置** 页面-**查看 DNS 服务器** 可获取到系统分配的 DNS 服务器地址）。修改域名 DNS 服务器配置可参考 [修改DNS服务器](https://help.aliyun.com/zh/dns/change-the-dns-server/)。\n    \n    **重要**\n    \n    修改 DNS 服务器之前请检查域名是否开启了禁止更新锁，如果处于开启状态，请关闭禁止更新锁。如何确认域名是否开启了禁止更新锁，可以咨询您的域名注册商或者使用 [whois工具](https://whois.aliyun.com/)查询域名状态是否显示 serverUpdateProhibited。\n    \n5.  借助 DNS 流量分析功能查看您的服务请求流量是否有异常波动，持续观测至少10分钟。具体请参考 [DNS流量分析简介](https://help.aliyun.com/zh/dns/queryvolume)。\n    \n6.  无需其他操作，耐心等待解析生效即可，预计需要 48 小时完成全国各地 localDNS 的缓存刷新。\n    \n    **警告**\n    \n    *   为避免解析异常，在修改 DNS 服务器 48 小时内请尽量不变更解析记录。\n        \n    *   在 48 小时内 DNS 解析仍有可能向旧 DNS 厂商发起 DNS 查询，所以原 DNS 服务商中的解析记录数据不要马上删除，建议保留一周。\n        \n    *   在修改 DNS 服务器 48 小时内，如需做解析记录变更，请务必同时在新旧 DNS 服务商进行变更，以保持新旧 DNS 服务商的解析记录数据一致。\n        \n    \n    **说明**\n    \n    关于修改 DNS 服务器，需要多久才能在全网生效？\n    \n    答：一般需要 48 小时，因为各地 Localdns 服务器的域名缓存失效时间长短不一，需要等待各地 Localdns 服务器主动来更新该域名的最新 DNS 服务器地址，以实现逐步全网生效。请耐心等待这个过程。","slug":"domain-management","published":1,"updated":"2024-04-30T15:20:01.112Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodj7000y80rv2e8e2mq0","content":"<h1 id=\"如何平滑迁移至阿里云解析-DNS-云解析-DNS-DNS-阿里云帮助中心\"><a href=\"#如何平滑迁移至阿里云解析-DNS-云解析-DNS-DNS-阿里云帮助中心\" class=\"headerlink\" title=\"如何平滑迁移至阿里云解析 DNS_云解析 DNS(DNS)-阿里云帮助中心\"></a>如何平滑迁移至阿里云解析 DNS_云解析 DNS(DNS)-阿里云帮助中心</h1><p>我的 dns 提供商比较小，如此修改后才能使用 aliyundns 的 webhook api，配合 cert-manger 创建证书</p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><p>若您的域名解析当前托管在其他 DNS 厂商，想要迁移至阿里云解析 DNS 进行管理。本文将向您介绍如何平滑地将域名解析迁移至阿里云解析 DNS，避免您的业务因解析中断而受影响。</p>\n<h2 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h2><ul>\n<li><p>域名如有配置 DNSSEC，请先到域名注册商处删除 DS 记录，并关闭 DNSSEC。等迁移完成后，再参考 <a href=\"https://help.aliyun.com/zh/dns/configure-dns-security-extensions#h2-dnssec-3\">DNSSEC开启设置方法</a>进行配置。如域名未配置 DNSSEC，则忽略此步骤。</p>\n<p><strong>警告</strong></p>\n<p>域名迁移之前请务必保证域名 DS 记录已删除、DNSSEC 功能关闭，否则会影响解析！如果您不清楚是否开启了 DNSSEC，可以咨询您的域名注册商询问 DNSSEC 的开启情况。</p>\n</li>\n<li><p>解析数据准备：请在原 DNS 服务商处导出解析记录，并按照 <a href=\"https://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/97785/cn_zh/1560846859029/alidns_record.xlsx\">DNS解析模板</a> 进行编辑整理好解析记录。</p>\n<p><strong>说明</strong></p>\n<p>若您当前 DNS 厂商不支持批量导出解析记录的功能，您可以直接将解析记录手动添加在 DNS 解析模板中，然后在云解析 DNS 产品控制台批量导入解析记录。或者您也可以直接在云解析 DNS 产品控制台手动添加解析记录。</p>\n</li>\n</ul>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><ol>\n<li><p>在 <a href=\"https://dns.console.aliyun.com/\">云解析DNS控制台</a>，在 <strong>域名解析</strong> 页面选择 <strong>权威域名</strong> 页签，再单击 <strong>添加域名</strong> <strong>。</strong>如果您的域名是阿里云注册域名或者已经添加了域名，可忽略此步骤。</p>\n</li>\n<li><p>单击目标域名进入 <strong>解析设置</strong> 页面，单击 <strong>导入&#x2F;导出</strong> 按钮，在 <strong>导入记录</strong> 页面选择 <strong>导入记录方式</strong> ：<strong>增量更新</strong>或 <strong>全量更新</strong>，再单击 <strong>上传文件</strong> ，将编辑整理好的解析记录导入云解析 DNS。</p>\n</li>\n<li><p>检查导入云解析 DNS 中配置的解析记录是否跟您之前的 DNS 厂商中设置的解析记录一致，避免漏配现象。</p>\n</li>\n<li><p>前往您的域名注册商处，将 DNS 服务器修改为云解析 DNS 系统分配的地址（在云解析 DNS 控制台-<strong>域名解析</strong>页面-<strong>解析设置</strong> 页面-<strong>查看 DNS 服务器</strong> 可获取到系统分配的 DNS 服务器地址）。修改域名 DNS 服务器配置可参考 <a href=\"https://help.aliyun.com/zh/dns/change-the-dns-server/\">修改DNS服务器</a>。</p>\n<p><strong>重要</strong></p>\n<p>修改 DNS 服务器之前请检查域名是否开启了禁止更新锁，如果处于开启状态，请关闭禁止更新锁。如何确认域名是否开启了禁止更新锁，可以咨询您的域名注册商或者使用 <a href=\"https://whois.aliyun.com/\">whois工具</a>查询域名状态是否显示 serverUpdateProhibited。</p>\n</li>\n<li><p>借助 DNS 流量分析功能查看您的服务请求流量是否有异常波动，持续观测至少10分钟。具体请参考 <a href=\"https://help.aliyun.com/zh/dns/queryvolume\">DNS流量分析简介</a>。</p>\n</li>\n<li><p>无需其他操作，耐心等待解析生效即可，预计需要 48 小时完成全国各地 localDNS 的缓存刷新。</p>\n<p><strong>警告</strong></p>\n<ul>\n<li><p>为避免解析异常，在修改 DNS 服务器 48 小时内请尽量不变更解析记录。</p>\n</li>\n<li><p>在 48 小时内 DNS 解析仍有可能向旧 DNS 厂商发起 DNS 查询，所以原 DNS 服务商中的解析记录数据不要马上删除，建议保留一周。</p>\n</li>\n<li><p>在修改 DNS 服务器 48 小时内，如需做解析记录变更，请务必同时在新旧 DNS 服务商进行变更，以保持新旧 DNS 服务商的解析记录数据一致。</p>\n</li>\n</ul>\n<p><strong>说明</strong></p>\n<p>关于修改 DNS 服务器，需要多久才能在全网生效？</p>\n<p>答：一般需要 48 小时，因为各地 Localdns 服务器的域名缓存失效时间长短不一，需要等待各地 Localdns 服务器主动来更新该域名的最新 DNS 服务器地址，以实现逐步全网生效。请耐心等待这个过程。</p>\n</li>\n</ol>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"如何平滑迁移至阿里云解析-DNS-云解析-DNS-DNS-阿里云帮助中心\"><a href=\"#如何平滑迁移至阿里云解析-DNS-云解析-DNS-DNS-阿里云帮助中心\" class=\"headerlink\" title=\"如何平滑迁移至阿里云解析 DNS_云解析 DNS(DNS)-阿里云帮助中心\"></a>如何平滑迁移至阿里云解析 DNS_云解析 DNS(DNS)-阿里云帮助中心</h1><p>我的 dns 提供商比较小，如此修改后才能使用 aliyundns 的 webhook api，配合 cert-manger 创建证书</p>\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><p>若您的域名解析当前托管在其他 DNS 厂商，想要迁移至阿里云解析 DNS 进行管理。本文将向您介绍如何平滑地将域名解析迁移至阿里云解析 DNS，避免您的业务因解析中断而受影响。</p>\n<h2 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h2><ul>\n<li><p>域名如有配置 DNSSEC，请先到域名注册商处删除 DS 记录，并关闭 DNSSEC。等迁移完成后，再参考 <a href=\"https://help.aliyun.com/zh/dns/configure-dns-security-extensions#h2-dnssec-3\">DNSSEC开启设置方法</a>进行配置。如域名未配置 DNSSEC，则忽略此步骤。</p>\n<p><strong>警告</strong></p>\n<p>域名迁移之前请务必保证域名 DS 记录已删除、DNSSEC 功能关闭，否则会影响解析！如果您不清楚是否开启了 DNSSEC，可以咨询您的域名注册商询问 DNSSEC 的开启情况。</p>\n</li>\n<li><p>解析数据准备：请在原 DNS 服务商处导出解析记录，并按照 <a href=\"https://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/97785/cn_zh/1560846859029/alidns_record.xlsx\">DNS解析模板</a> 进行编辑整理好解析记录。</p>\n<p><strong>说明</strong></p>\n<p>若您当前 DNS 厂商不支持批量导出解析记录的功能，您可以直接将解析记录手动添加在 DNS 解析模板中，然后在云解析 DNS 产品控制台批量导入解析记录。或者您也可以直接在云解析 DNS 产品控制台手动添加解析记录。</p>\n</li>\n</ul>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><ol>\n<li><p>在 <a href=\"https://dns.console.aliyun.com/\">云解析DNS控制台</a>，在 <strong>域名解析</strong> 页面选择 <strong>权威域名</strong> 页签，再单击 <strong>添加域名</strong> <strong>。</strong>如果您的域名是阿里云注册域名或者已经添加了域名，可忽略此步骤。</p>\n</li>\n<li><p>单击目标域名进入 <strong>解析设置</strong> 页面，单击 <strong>导入&#x2F;导出</strong> 按钮，在 <strong>导入记录</strong> 页面选择 <strong>导入记录方式</strong> ：<strong>增量更新</strong>或 <strong>全量更新</strong>，再单击 <strong>上传文件</strong> ，将编辑整理好的解析记录导入云解析 DNS。</p>\n</li>\n<li><p>检查导入云解析 DNS 中配置的解析记录是否跟您之前的 DNS 厂商中设置的解析记录一致，避免漏配现象。</p>\n</li>\n<li><p>前往您的域名注册商处，将 DNS 服务器修改为云解析 DNS 系统分配的地址（在云解析 DNS 控制台-<strong>域名解析</strong>页面-<strong>解析设置</strong> 页面-<strong>查看 DNS 服务器</strong> 可获取到系统分配的 DNS 服务器地址）。修改域名 DNS 服务器配置可参考 <a href=\"https://help.aliyun.com/zh/dns/change-the-dns-server/\">修改DNS服务器</a>。</p>\n<p><strong>重要</strong></p>\n<p>修改 DNS 服务器之前请检查域名是否开启了禁止更新锁，如果处于开启状态，请关闭禁止更新锁。如何确认域名是否开启了禁止更新锁，可以咨询您的域名注册商或者使用 <a href=\"https://whois.aliyun.com/\">whois工具</a>查询域名状态是否显示 serverUpdateProhibited。</p>\n</li>\n<li><p>借助 DNS 流量分析功能查看您的服务请求流量是否有异常波动，持续观测至少10分钟。具体请参考 <a href=\"https://help.aliyun.com/zh/dns/queryvolume\">DNS流量分析简介</a>。</p>\n</li>\n<li><p>无需其他操作，耐心等待解析生效即可，预计需要 48 小时完成全国各地 localDNS 的缓存刷新。</p>\n<p><strong>警告</strong></p>\n<ul>\n<li><p>为避免解析异常，在修改 DNS 服务器 48 小时内请尽量不变更解析记录。</p>\n</li>\n<li><p>在 48 小时内 DNS 解析仍有可能向旧 DNS 厂商发起 DNS 查询，所以原 DNS 服务商中的解析记录数据不要马上删除，建议保留一周。</p>\n</li>\n<li><p>在修改 DNS 服务器 48 小时内，如需做解析记录变更，请务必同时在新旧 DNS 服务商进行变更，以保持新旧 DNS 服务商的解析记录数据一致。</p>\n</li>\n</ul>\n<p><strong>说明</strong></p>\n<p>关于修改 DNS 服务器，需要多久才能在全网生效？</p>\n<p>答：一般需要 48 小时，因为各地 Localdns 服务器的域名缓存失效时间长短不一，需要等待各地 Localdns 服务器主动来更新该域名的最新 DNS 服务器地址，以实现逐步全网生效。请耐心等待这个过程。</p>\n</li>\n</ol>\n"},{"title":"homelab pc","date":"2023-11-27T15:02:04.000Z","summary":"Got a new way to write blog in english. Write the version 1 of this easy in chinese, then translating the texts into English. this one is about the  prepare of testing environments on my homelab PC. By the way, hope one day I'll know more professional words.","_content":"## 1. Computer Parts\n|配件|规格|价格|\n|:---:|:---:|:---:|\n|Motherboard|华南x99双路8D4|730含以下二者|\n|CPU|E5-2680V4||\n|Cooler|寒冰A500四铜管||\n|RAM|闲鱼-镁光窄条2133-16G*4|280|\n|GPU|GTX750 4G 貌似全新|335|\n|Chassis|刀客360|150|\n|Fan|PDD-纯白*5|48|\n|SSD|BU KING 512G|150|\n|Power|华南U700双路电源600W|243|\n|Tools|硅脂、螺丝刀、网线|25|\n\n## 2. Install PVE System\n- Ventoy\n- proxmox-ve_8.0-2.iso\n\n### 2.1 Disable the subscription on web UI\n```bash\nsed -i_orig \"s/data.status === 'Active'/true/g\" /usr/share/pve-manager/js/pvemanagerlib.js\nsed -i_orig \"s/if (res === null || res === undefined || \\!res || res/if(/g\" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js\nsed -i_orig \"s/.data.status.toLowerCase() !== 'active'/false/g\" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js\nsystemctl restart pveproxy\n```\n\n### 2.2 Network Settings\n- [reference](https://www.bilibili.com/video/BV1xH4y1f7Ga/?spm_id_from=333.337.search-card.all.click&vd_source=154006e70f5c14d792db947270b63614)\n- pve host using a vitual NIC and bridging the network connection to a physical NIC\n```shell\ncat /etc/network/interfaces\nauto lo\niface lo inet loopback\niface enp6s0 inet manual    # physical NIC\n\nauto vmbr0               # Vitrual NIC\niface vmbr0 inet static\n        address 192.168.3.20/24\n        gateway 192.168.3.1\n        bridge-ports enp6s0     #bridging\n        bridge-stp off\n        bridge-fd 0\n```\n```shell\nsudo systemctl restart networking \n```\n\n### 2.3 [ Using a homeland repository source](https://www.wunote.cn/article/10000)\n```shell\n# modify the ubuntu software source\nwget https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg\n\necho \"deb https://mirrors.ustc.edu.cn/proxmox/debian bookworm pve-no-subscription\" > /etc/apt/sources.list.d/pve-no-subscription.list\n\nsed -i 's|^deb http://ftp.debian.org|deb https://mirrors.ustc.edu.cn|g' /etc/apt/sources.list\n\nsed -i 's|^deb http://security.debian.org|deb https://mirrors.ustc.edu.cn/debian-security|g' /etc/apt/sources.list\n\n# modify the ceph repository source\necho \"deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-quincy bookworm no-subscription\" > /etc/apt/sources.list.d/ceph.list\n\n# CT images source\nsed -i 's|http://download.proxmox.com|https://mirrors.ustc.edu.cn/proxmox|g' /usr/share/perl5/PVE/APLInfo.pm\n\nsed -i 's/^/#/' /etc/apt/sources.list.d/pve-enterprise.list\n```\n\n## 3. Virtual machine on pve host\n### 3.1 SYS\n- ubuntu 22.04.3 server\n- choose network bridging on vmbr0, it's convenient and fast. also because of my simple network architecture.\n### 3.2 Repository Source\n```\ndeb https://mirrors.ustc.edu.cn/ubuntu/ jammy main restricted universe multiverse\n\ndeb https://mirrors.ustc.edu.cn/ubuntu/ jammy-security main restricted universe multiverse\n\ndeb https://mirrors.ustc.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse\n\ndeb https://mirrors.ustc.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse\n```\n### 3.3 Install containerd、nerdctl & make this vm as a template\n```shell\napt install containerd\ncontainerd config default > /etc/containerd/config.toml  # generating a default configuration of containerd\n```\n- Modify part of this file, like below example.\n\n```toml\nsandbox_image = \"registry.aliyuncs.com/google_containers/pause:3.8\"\nSystemdCgroup = true\n\n[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\n          endpoint = [\"https://bqr1dr1n.mirror.aliyuncs.com\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]\n          endpoint = [\"https://registry.aliyuncs.com/google_containers\"]\n```\n\n- Install the nerdctl by binary package\n\n```shell\nwget https://download.fastgit.org/containerd/nerdctl/releases/download/v0.12.1/nerdctl-0.12.1-linux-amd64.tar.gz\nmkdir -p /usr/local/containerd/bin/ && tar -zxvf nerdctl-0.12.1-linux-amd64.tar.gz nerdctl && mv nerdctl /usr/local/containerd/bin/\nln -s /usr/local/containerd/bin/nerdctl /usr/local/bin/nerdctl\n```\n### 3.4 System settings\n\n```bash\n# ipv4 forward\ncat <<EOF | tee /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\n\nmodprobe overlay\nmodprobe br_netfilter\n\ncat <<EOF | tee /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward                 = 1\nEOF\n\nsysctl --system\nsysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward\n\n# swap\nswapoff -a\n\nvim /etc/fstab\n  # /swap.img      none    swap    sw      0       0\n```\n- Transform this vm into template by Web UI of pve\n\n## 4. Kubernetes\n### 4.1 Install kubeadm kubelet kubectl\n\n```bash\necho deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main > /etc/apt/sources.list.d/kubernetes.list\ncurl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | \\\n\tapt-key add -\napt-get update && apt-get install -y kubelet kubeadm kubectl\napt-mark hold kubelet kubeadm kubectl\n```\n### 4.2 generate a default configuration file in workspace path to init the cluster\n\n```\nkubeadm config print init-defaults --component-configs KubeletConfiguration > kubeadm.yaml\n```\n- modify part of configuration file\n\n```yaml\nlocalAPIEndpoint:\n  advertiseAddress: 192.168.3.11  #master IP\n  bindPort: 6443\nnodeRegistration:\n  criSocket: unix:///var/run/containerd/containerd.sock\n  imagePullPolicy: IfNotPresent\n    #name: master1  # defaults to be node\n  taints: null\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.aliyuncs.com/google_containers  #changing into repository in china\nkind: ClusterConfiguration\nkubernetesVersion: 1.28.0    # specify the version of kube\nnetworking:\n  dnsDomain: cluster.local\n  podSubnet: 10.244.0.0/16    # need to add\n  serviceSubnet: 10.96.0.0/12\nscheduler: {}\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1 # add\nkind: KubeProxyConfiguration\nmode: ipvs\n```\n- init cluster\n\n```\nsudo kubeadm init --config kubeadm-config.yaml\n``` \n\n- work nodes joining the cluster\n\n```\nkubeadm join 192.168.3.14:6443 --token n8orxj.f51riixygulit9yz \\\n        --discovery-token-ca-cert-hash sha256:c0af38d55001f6eaf09ca9248db5e048c492ee4b883f0534a54187eceb50a928\n```\n- after all the work nodes joining the cluster, deploy the flannel\n\n```bash\nwget https://raw.githubusercontent.com/flannel-io/flannel/v0.20.1/Documentation/kube-flannel.yml\nkubectl apply -f kube-flannel.yml\n```\n- check status of cluster\n\n```\nkubectl get nodes -A\nkubectl get pods -A\n```\n## 5. Fault\n### 5.1 kubectl get nodes\n- descriobe\n\n```shell\ncouldn't get current server API group list: Get \"http://localhost:8080/api?timeout=32s\": dial tcp 127.0.0.1:8080: connect: connection refused\nThe connection to the server localhost:8080 was refused - did you specify the right host or port?\n```\n- solution: fogot to apply the config, it's printed by the kubeadm init command\n\n```\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n```\n### 5.2 The kubelet is not running\n- describe\n\n```shell\n[kubelet-check] Initial timeout of 40s passed.\n\nUnfortunately, an error has occurred:\n        timed out waiting for the condition\n\nThis error is likely caused by:\n        - The kubelet is not running\n        - The kubelet is unhealthy due to a misconfiguration of the node in some way (required cgroups disabled)\n```\n- solution: changing the wrong advertiseAddress, supoose to be mine master IP.\n\n```shell\n# in some  conditions, this setting may help. It controls the cgroup driver of kubelet\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\ncgroupDriver: systemd\n``` \n### 5.3 coredns pod halting on creating status.\n- describe\n\n```shell\nWarning  FailedCreatePodSandBox  42s   kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox \"03e2b9a1ceaf66beb681891dc276ea490d664822b43047f25d3b5d4a11e76eb0\": plugin type=\"flannel\" failed (add): open /run/flannel/subnet.env: no such file or directory\n```\n- solutions: creating a file && reset the cluster and reinstall the kube-flannel. ( worked in this case, solution of `work not ready`)(the file below maybe useless,it's important to set `Podsubnet` in the init config file)\n\n```shell\ncat  /run/flannel/subnet.env  #  manual creating\n\nFLANNEL_NETWORK=10.244.0.0/16\nFLANNEL_SUBNET=10.244.0.1/24\nFLANNEL_MTU=1450\nFLANNEL_IPMASQ=true\n```\n","source":"_posts/homelab-pc.md","raw":"---\ntitle: homelab pc\ndate: 2023-11-27 23:02:04\ntags: DIY\ncategories: Hardware\nsummary: Got a new way to write blog in english. Write the version 1 of this easy in chinese, then translating the texts into English. this one is about the  prepare of testing environments on my homelab PC. By the way, hope one day I'll know more professional words.\n---\n## 1. Computer Parts\n|配件|规格|价格|\n|:---:|:---:|:---:|\n|Motherboard|华南x99双路8D4|730含以下二者|\n|CPU|E5-2680V4||\n|Cooler|寒冰A500四铜管||\n|RAM|闲鱼-镁光窄条2133-16G*4|280|\n|GPU|GTX750 4G 貌似全新|335|\n|Chassis|刀客360|150|\n|Fan|PDD-纯白*5|48|\n|SSD|BU KING 512G|150|\n|Power|华南U700双路电源600W|243|\n|Tools|硅脂、螺丝刀、网线|25|\n\n## 2. Install PVE System\n- Ventoy\n- proxmox-ve_8.0-2.iso\n\n### 2.1 Disable the subscription on web UI\n```bash\nsed -i_orig \"s/data.status === 'Active'/true/g\" /usr/share/pve-manager/js/pvemanagerlib.js\nsed -i_orig \"s/if (res === null || res === undefined || \\!res || res/if(/g\" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js\nsed -i_orig \"s/.data.status.toLowerCase() !== 'active'/false/g\" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js\nsystemctl restart pveproxy\n```\n\n### 2.2 Network Settings\n- [reference](https://www.bilibili.com/video/BV1xH4y1f7Ga/?spm_id_from=333.337.search-card.all.click&vd_source=154006e70f5c14d792db947270b63614)\n- pve host using a vitual NIC and bridging the network connection to a physical NIC\n```shell\ncat /etc/network/interfaces\nauto lo\niface lo inet loopback\niface enp6s0 inet manual    # physical NIC\n\nauto vmbr0               # Vitrual NIC\niface vmbr0 inet static\n        address 192.168.3.20/24\n        gateway 192.168.3.1\n        bridge-ports enp6s0     #bridging\n        bridge-stp off\n        bridge-fd 0\n```\n```shell\nsudo systemctl restart networking \n```\n\n### 2.3 [ Using a homeland repository source](https://www.wunote.cn/article/10000)\n```shell\n# modify the ubuntu software source\nwget https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg\n\necho \"deb https://mirrors.ustc.edu.cn/proxmox/debian bookworm pve-no-subscription\" > /etc/apt/sources.list.d/pve-no-subscription.list\n\nsed -i 's|^deb http://ftp.debian.org|deb https://mirrors.ustc.edu.cn|g' /etc/apt/sources.list\n\nsed -i 's|^deb http://security.debian.org|deb https://mirrors.ustc.edu.cn/debian-security|g' /etc/apt/sources.list\n\n# modify the ceph repository source\necho \"deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-quincy bookworm no-subscription\" > /etc/apt/sources.list.d/ceph.list\n\n# CT images source\nsed -i 's|http://download.proxmox.com|https://mirrors.ustc.edu.cn/proxmox|g' /usr/share/perl5/PVE/APLInfo.pm\n\nsed -i 's/^/#/' /etc/apt/sources.list.d/pve-enterprise.list\n```\n\n## 3. Virtual machine on pve host\n### 3.1 SYS\n- ubuntu 22.04.3 server\n- choose network bridging on vmbr0, it's convenient and fast. also because of my simple network architecture.\n### 3.2 Repository Source\n```\ndeb https://mirrors.ustc.edu.cn/ubuntu/ jammy main restricted universe multiverse\n\ndeb https://mirrors.ustc.edu.cn/ubuntu/ jammy-security main restricted universe multiverse\n\ndeb https://mirrors.ustc.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse\n\ndeb https://mirrors.ustc.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse\n```\n### 3.3 Install containerd、nerdctl & make this vm as a template\n```shell\napt install containerd\ncontainerd config default > /etc/containerd/config.toml  # generating a default configuration of containerd\n```\n- Modify part of this file, like below example.\n\n```toml\nsandbox_image = \"registry.aliyuncs.com/google_containers/pause:3.8\"\nSystemdCgroup = true\n\n[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\n          endpoint = [\"https://bqr1dr1n.mirror.aliyuncs.com\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]\n          endpoint = [\"https://registry.aliyuncs.com/google_containers\"]\n```\n\n- Install the nerdctl by binary package\n\n```shell\nwget https://download.fastgit.org/containerd/nerdctl/releases/download/v0.12.1/nerdctl-0.12.1-linux-amd64.tar.gz\nmkdir -p /usr/local/containerd/bin/ && tar -zxvf nerdctl-0.12.1-linux-amd64.tar.gz nerdctl && mv nerdctl /usr/local/containerd/bin/\nln -s /usr/local/containerd/bin/nerdctl /usr/local/bin/nerdctl\n```\n### 3.4 System settings\n\n```bash\n# ipv4 forward\ncat <<EOF | tee /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\n\nmodprobe overlay\nmodprobe br_netfilter\n\ncat <<EOF | tee /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward                 = 1\nEOF\n\nsysctl --system\nsysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward\n\n# swap\nswapoff -a\n\nvim /etc/fstab\n  # /swap.img      none    swap    sw      0       0\n```\n- Transform this vm into template by Web UI of pve\n\n## 4. Kubernetes\n### 4.1 Install kubeadm kubelet kubectl\n\n```bash\necho deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main > /etc/apt/sources.list.d/kubernetes.list\ncurl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | \\\n\tapt-key add -\napt-get update && apt-get install -y kubelet kubeadm kubectl\napt-mark hold kubelet kubeadm kubectl\n```\n### 4.2 generate a default configuration file in workspace path to init the cluster\n\n```\nkubeadm config print init-defaults --component-configs KubeletConfiguration > kubeadm.yaml\n```\n- modify part of configuration file\n\n```yaml\nlocalAPIEndpoint:\n  advertiseAddress: 192.168.3.11  #master IP\n  bindPort: 6443\nnodeRegistration:\n  criSocket: unix:///var/run/containerd/containerd.sock\n  imagePullPolicy: IfNotPresent\n    #name: master1  # defaults to be node\n  taints: null\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.aliyuncs.com/google_containers  #changing into repository in china\nkind: ClusterConfiguration\nkubernetesVersion: 1.28.0    # specify the version of kube\nnetworking:\n  dnsDomain: cluster.local\n  podSubnet: 10.244.0.0/16    # need to add\n  serviceSubnet: 10.96.0.0/12\nscheduler: {}\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1 # add\nkind: KubeProxyConfiguration\nmode: ipvs\n```\n- init cluster\n\n```\nsudo kubeadm init --config kubeadm-config.yaml\n``` \n\n- work nodes joining the cluster\n\n```\nkubeadm join 192.168.3.14:6443 --token n8orxj.f51riixygulit9yz \\\n        --discovery-token-ca-cert-hash sha256:c0af38d55001f6eaf09ca9248db5e048c492ee4b883f0534a54187eceb50a928\n```\n- after all the work nodes joining the cluster, deploy the flannel\n\n```bash\nwget https://raw.githubusercontent.com/flannel-io/flannel/v0.20.1/Documentation/kube-flannel.yml\nkubectl apply -f kube-flannel.yml\n```\n- check status of cluster\n\n```\nkubectl get nodes -A\nkubectl get pods -A\n```\n## 5. Fault\n### 5.1 kubectl get nodes\n- descriobe\n\n```shell\ncouldn't get current server API group list: Get \"http://localhost:8080/api?timeout=32s\": dial tcp 127.0.0.1:8080: connect: connection refused\nThe connection to the server localhost:8080 was refused - did you specify the right host or port?\n```\n- solution: fogot to apply the config, it's printed by the kubeadm init command\n\n```\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n```\n### 5.2 The kubelet is not running\n- describe\n\n```shell\n[kubelet-check] Initial timeout of 40s passed.\n\nUnfortunately, an error has occurred:\n        timed out waiting for the condition\n\nThis error is likely caused by:\n        - The kubelet is not running\n        - The kubelet is unhealthy due to a misconfiguration of the node in some way (required cgroups disabled)\n```\n- solution: changing the wrong advertiseAddress, supoose to be mine master IP.\n\n```shell\n# in some  conditions, this setting may help. It controls the cgroup driver of kubelet\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\ncgroupDriver: systemd\n``` \n### 5.3 coredns pod halting on creating status.\n- describe\n\n```shell\nWarning  FailedCreatePodSandBox  42s   kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox \"03e2b9a1ceaf66beb681891dc276ea490d664822b43047f25d3b5d4a11e76eb0\": plugin type=\"flannel\" failed (add): open /run/flannel/subnet.env: no such file or directory\n```\n- solutions: creating a file && reset the cluster and reinstall the kube-flannel. ( worked in this case, solution of `work not ready`)(the file below maybe useless,it's important to set `Podsubnet` in the init config file)\n\n```shell\ncat  /run/flannel/subnet.env  #  manual creating\n\nFLANNEL_NETWORK=10.244.0.0/16\nFLANNEL_SUBNET=10.244.0.1/24\nFLANNEL_MTU=1450\nFLANNEL_IPMASQ=true\n```\n","slug":"homelab-pc","published":1,"updated":"2024-04-20T03:18:37.505Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodj9001180rvgbo6g22v","content":"<h2 id=\"1-Computer-Parts\"><a href=\"#1-Computer-Parts\" class=\"headerlink\" title=\"1. Computer Parts\"></a>1. Computer Parts</h2><table>\n<thead>\n<tr>\n<th align=\"center\">配件</th>\n<th align=\"center\">规格</th>\n<th align=\"center\">价格</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">Motherboard</td>\n<td align=\"center\">华南x99双路8D4</td>\n<td align=\"center\">730含以下二者</td>\n</tr>\n<tr>\n<td align=\"center\">CPU</td>\n<td align=\"center\">E5-2680V4</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">Cooler</td>\n<td align=\"center\">寒冰A500四铜管</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">RAM</td>\n<td align=\"center\">闲鱼-镁光窄条2133-16G*4</td>\n<td align=\"center\">280</td>\n</tr>\n<tr>\n<td align=\"center\">GPU</td>\n<td align=\"center\">GTX750 4G 貌似全新</td>\n<td align=\"center\">335</td>\n</tr>\n<tr>\n<td align=\"center\">Chassis</td>\n<td align=\"center\">刀客360</td>\n<td align=\"center\">150</td>\n</tr>\n<tr>\n<td align=\"center\">Fan</td>\n<td align=\"center\">PDD-纯白*5</td>\n<td align=\"center\">48</td>\n</tr>\n<tr>\n<td align=\"center\">SSD</td>\n<td align=\"center\">BU KING 512G</td>\n<td align=\"center\">150</td>\n</tr>\n<tr>\n<td align=\"center\">Power</td>\n<td align=\"center\">华南U700双路电源600W</td>\n<td align=\"center\">243</td>\n</tr>\n<tr>\n<td align=\"center\">Tools</td>\n<td align=\"center\">硅脂、螺丝刀、网线</td>\n<td align=\"center\">25</td>\n</tr>\n</tbody></table>\n<h2 id=\"2-Install-PVE-System\"><a href=\"#2-Install-PVE-System\" class=\"headerlink\" title=\"2. Install PVE System\"></a>2. Install PVE System</h2><ul>\n<li>Ventoy</li>\n<li>proxmox-ve_8.0-2.iso</li>\n</ul>\n<h3 id=\"2-1-Disable-the-subscription-on-web-UI\"><a href=\"#2-1-Disable-the-subscription-on-web-UI\" class=\"headerlink\" title=\"2.1 Disable the subscription on web UI\"></a>2.1 Disable the subscription on web UI</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i_orig</span> <span class=\"token string\">\"s/data.status === 'Active'/true/g\"</span> /usr/share/pve-manager/js/pvemanagerlib.js\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i_orig</span> <span class=\"token string\">\"s/if (res === null || res === undefined || \\!res || res/if(/g\"</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i_orig</span> <span class=\"token string\">\"s/.data.status.toLowerCase() !== 'active'/false/g\"</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js\nsystemctl restart pveproxy<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-Network-Settings\"><a href=\"#2-2-Network-Settings\" class=\"headerlink\" title=\"2.2 Network Settings\"></a>2.2 Network Settings</h3><ul>\n<li><a href=\"https://www.bilibili.com/video/BV1xH4y1f7Ga/?spm_id_from=333.337.search-card.all.click&vd_source=154006e70f5c14d792db947270b63614\">reference</a></li>\n<li>pve host using a vitual NIC and bridging the network connection to a physical NIC<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> /etc/network/interfaces\nauto lo\niface lo inet loopback\niface enp6s0 inet manual    <span class=\"token comment\"># physical NIC</span>\n\nauto vmbr0               <span class=\"token comment\"># Vitrual NIC</span>\niface vmbr0 inet static\n        address <span class=\"token number\">192.168</span>.3.20/24\n        gateway <span class=\"token number\">192.168</span>.3.1\n        bridge-ports enp6s0     <span class=\"token comment\">#bridging</span>\n        bridge-stp off\n        bridge-fd <span class=\"token number\">0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl restart networking <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"2-3-Using-a-homeland-repository-source\"><a href=\"#2-3-Using-a-homeland-repository-source\" class=\"headerlink\" title=\"2.3  Using a homeland repository source\"></a>2.3 <a href=\"https://www.wunote.cn/article/10000\"> Using a homeland repository source</a></h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># modify the ubuntu software source</span>\n<span class=\"token function\">wget</span> https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bookworm.gpg <span class=\"token parameter variable\">-O</span> /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deb https://mirrors.ustc.edu.cn/proxmox/debian bookworm pve-no-subscription\"</span> <span class=\"token operator\">></span> /etc/apt/sources.list.d/pve-no-subscription.list\n\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s|^deb http://ftp.debian.org|deb https://mirrors.ustc.edu.cn|g'</span> /etc/apt/sources.list\n\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s|^deb http://security.debian.org|deb https://mirrors.ustc.edu.cn/debian-security|g'</span> /etc/apt/sources.list\n\n<span class=\"token comment\"># modify the ceph repository source</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-quincy bookworm no-subscription\"</span> <span class=\"token operator\">></span> /etc/apt/sources.list.d/ceph.list\n\n<span class=\"token comment\"># CT images source</span>\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s|http://download.proxmox.com|https://mirrors.ustc.edu.cn/proxmox|g'</span> /usr/share/perl5/PVE/APLInfo.pm\n\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/^/#/'</span> /etc/apt/sources.list.d/pve-enterprise.list<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-Virtual-machine-on-pve-host\"><a href=\"#3-Virtual-machine-on-pve-host\" class=\"headerlink\" title=\"3. Virtual machine on pve host\"></a>3. Virtual machine on pve host</h2><h3 id=\"3-1-SYS\"><a href=\"#3-1-SYS\" class=\"headerlink\" title=\"3.1 SYS\"></a>3.1 SYS</h3><ul>\n<li>ubuntu 22.04.3 server</li>\n<li>choose network bridging on vmbr0, it’s convenient and fast. also because of my simple network architecture.</li>\n</ul>\n<h3 id=\"3-2-Repository-Source\"><a href=\"#3-2-Repository-Source\" class=\"headerlink\" title=\"3.2 Repository Source\"></a>3.2 Repository Source</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">deb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy main restricted universe multiverse\n\ndeb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy-security main restricted universe multiverse\n\ndeb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy-updates main restricted universe multiverse\n\ndeb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy-backports main restricted universe multiverse<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"3-3-Install-containerd、nerdctl-make-this-vm-as-a-template\"><a href=\"#3-3-Install-containerd、nerdctl-make-this-vm-as-a-template\" class=\"headerlink\" title=\"3.3 Install containerd、nerdctl &amp; make this vm as a template\"></a>3.3 Install containerd、nerdctl &amp; make this vm as a template</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">apt</span> <span class=\"token function\">install</span> containerd\ncontainerd config default <span class=\"token operator\">></span> /etc/containerd/config.toml  <span class=\"token comment\"># generating a default configuration of containerd</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>Modify part of this file, like below example.</li>\n</ul>\n<pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">sandbox_image</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"registry.aliyuncs.com/google_containers/pause:3.8\"</span>\n<span class=\"token key property\">SystemdCgroup</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"</span><span class=\"token punctuation\">]</span>\n          <span class=\"token key property\">endpoint</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://bqr1dr1n.mirror.aliyuncs.com\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"</span><span class=\"token punctuation\">]</span>\n          <span class=\"token key property\">endpoint</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://registry.aliyuncs.com/google_containers\"</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>Install the nerdctl by binary package</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://download.fastgit.org/containerd/nerdctl/releases/download/v0.12.1/nerdctl-0.12.1-linux-amd64.tar.gz\n<span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /usr/local/containerd/bin/ <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">tar</span> <span class=\"token parameter variable\">-zxvf</span> nerdctl-0.12.1-linux-amd64.tar.gz nerdctl <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">mv</span> nerdctl /usr/local/containerd/bin/\n<span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /usr/local/containerd/bin/nerdctl /usr/local/bin/nerdctl<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"3-4-System-settings\"><a href=\"#3-4-System-settings\" class=\"headerlink\" title=\"3.4 System settings\"></a>3.4 System settings</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># ipv4 forward</span>\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /etc/modules-load.d/k8s.conf</span>\noverlay\nbr_netfilter\nEOF</span>\n\nmodprobe overlay\nmodprobe br_netfilter\n\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /etc/sysctl.d/k8s.conf</span>\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward                 = 1\nEOF</span>\n\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span>\n<span class=\"token function\">sysctl</span> net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward\n\n<span class=\"token comment\"># swap</span>\nswapoff <span class=\"token parameter variable\">-a</span>\n\n<span class=\"token function\">vim</span> /etc/fstab\n  <span class=\"token comment\"># /swap.img      none    swap    sw      0       0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>Transform this vm into template by Web UI of pve</li>\n</ul>\n<h2 id=\"4-Kubernetes\"><a href=\"#4-Kubernetes\" class=\"headerlink\" title=\"4. Kubernetes\"></a>4. Kubernetes</h2><h3 id=\"4-1-Install-kubeadm-kubelet-kubectl\"><a href=\"#4-1-Install-kubeadm-kubelet-kubectl\" class=\"headerlink\" title=\"4.1 Install kubeadm kubelet kubectl\"></a>4.1 Install kubeadm kubelet kubectl</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main <span class=\"token operator\">></span> /etc/apt/sources.list.d/kubernetes.list\n<span class=\"token function\">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class=\"token operator\">|</span> <span class=\"token punctuation\">\\</span>\n\tapt-key <span class=\"token function\">add</span> -\n<span class=\"token function\">apt-get</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> kubelet kubeadm kubectl\napt-mark hold kubelet kubeadm kubectl<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"4-2-generate-a-default-configuration-file-in-workspace-path-to-init-the-cluster\"><a href=\"#4-2-generate-a-default-configuration-file-in-workspace-path-to-init-the-cluster\" class=\"headerlink\" title=\"4.2 generate a default configuration file in workspace path to init the cluster\"></a>4.2 generate a default configuration file in workspace path to init the cluster</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">kubeadm config print init-defaults --component-configs KubeletConfiguration &gt; kubeadm.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<ul>\n<li>modify part of configuration file</li>\n</ul>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">localAPIEndpoint</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">advertiseAddress</span><span class=\"token punctuation\">:</span> 192.168.3.11  <span class=\"token comment\">#master IP</span>\n  <span class=\"token key atrule\">bindPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6443</span>\n<span class=\"token key atrule\">nodeRegistration</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">criSocket</span><span class=\"token punctuation\">:</span> unix<span class=\"token punctuation\">:</span>///var/run/containerd/containerd.sock\n  <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n    <span class=\"token comment\">#name: master1  # defaults to be node</span>\n  <span class=\"token key atrule\">taints</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiServer</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">timeoutForControlPlane</span><span class=\"token punctuation\">:</span> 4m0s\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kubeadm.k8s.io/v1beta3\n<span class=\"token key atrule\">certificatesDir</span><span class=\"token punctuation\">:</span> /etc/kubernetes/pki\n<span class=\"token key atrule\">clusterName</span><span class=\"token punctuation\">:</span> kubernetes\n<span class=\"token key atrule\">controllerManager</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token key atrule\">dns</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token key atrule\">etcd</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">local</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">dataDir</span><span class=\"token punctuation\">:</span> /var/lib/etcd\n<span class=\"token key atrule\">imageRepository</span><span class=\"token punctuation\">:</span> registry.aliyuncs.com/google_containers  <span class=\"token comment\">#changing into repository in china</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterConfiguration\n<span class=\"token key atrule\">kubernetesVersion</span><span class=\"token punctuation\">:</span> 1.28.0    <span class=\"token comment\"># specify the version of kube</span>\n<span class=\"token key atrule\">networking</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">dnsDomain</span><span class=\"token punctuation\">:</span> cluster.local\n  <span class=\"token key atrule\">podSubnet</span><span class=\"token punctuation\">:</span> 10.244.0.0/16    <span class=\"token comment\"># need to add</span>\n  <span class=\"token key atrule\">serviceSubnet</span><span class=\"token punctuation\">:</span> 10.96.0.0/12\n<span class=\"token key atrule\">scheduler</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kubeproxy.config.k8s.io/v1alpha1 <span class=\"token comment\"># add</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> KubeProxyConfiguration\n<span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> ipvs<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>init cluster</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo kubeadm init --config kubeadm-config.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<ul>\n<li>work nodes joining the cluster</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubeadm join 192.168.3.14:6443 --token n8orxj.f51riixygulit9yz \\\n        --discovery-token-ca-cert-hash sha256:c0af38d55001f6eaf09ca9248db5e048c492ee4b883f0534a54187eceb50a928<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>after all the work nodes joining the cluster, deploy the flannel</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://raw.githubusercontent.com/flannel-io/flannel/v0.20.1/Documentation/kube-flannel.yml\nkubectl apply <span class=\"token parameter variable\">-f</span> kube-flannel.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>check status of cluster</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubectl get nodes -A\nkubectl get pods -A<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h2 id=\"5-Fault\"><a href=\"#5-Fault\" class=\"headerlink\" title=\"5. Fault\"></a>5. Fault</h2><h3 id=\"5-1-kubectl-get-nodes\"><a href=\"#5-1-kubectl-get-nodes\" class=\"headerlink\" title=\"5.1 kubectl get nodes\"></a>5.1 kubectl get nodes</h3><ul>\n<li>descriobe</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">couldn't get current server API group list: Get <span class=\"token string\">\"http://localhost:8080/api?timeout=32s\"</span><span class=\"token builtin class-name\">:</span> dial tcp <span class=\"token number\">127.0</span>.0.1:8080: connect: connection refused\nThe connection to the server localhost:8080 was refused - did you specify the right <span class=\"token function\">host</span> or port?<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>solution: fogot to apply the config, it’s printed by the kubeadm init command</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mkdir -p $HOME&#x2F;.kube\nsudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config\nsudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"5-2-The-kubelet-is-not-running\"><a href=\"#5-2-The-kubelet-is-not-running\" class=\"headerlink\" title=\"5.2 The kubelet is not running\"></a>5.2 The kubelet is not running</h3><ul>\n<li>describe</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>kubelet-check<span class=\"token punctuation\">]</span> Initial <span class=\"token function\">timeout</span> of 40s passed.\n\nUnfortunately, an error has occurred:\n        timed out waiting <span class=\"token keyword\">for</span> the condition\n\nThis error is likely caused by:\n        - The kubelet is not running\n        - The kubelet is unhealthy due to a misconfiguration of the <span class=\"token function\">node</span> <span class=\"token keyword\">in</span> some way <span class=\"token punctuation\">(</span>required cgroups disabled<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>solution: changing the wrong advertiseAddress, supoose to be mine master IP.</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># in some  conditions, this setting may help. It controls the cgroup driver of kubelet</span>\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\ncgroupDriver: systemd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"5-3-coredns-pod-halting-on-creating-status\"><a href=\"#5-3-coredns-pod-halting-on-creating-status\" class=\"headerlink\" title=\"5.3 coredns pod halting on creating status.\"></a>5.3 coredns pod halting on creating status.</h3><ul>\n<li>describe</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">Warning  FailedCreatePodSandBox  42s   kubelet            Failed to create pod sandbox: rpc error: code <span class=\"token operator\">=</span> Unknown desc <span class=\"token operator\">=</span> failed to setup network <span class=\"token keyword\">for</span> sandbox <span class=\"token string\">\"03e2b9a1ceaf66beb681891dc276ea490d664822b43047f25d3b5d4a11e76eb0\"</span><span class=\"token builtin class-name\">:</span> plugin <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"flannel\"</span> failed <span class=\"token punctuation\">(</span>add<span class=\"token punctuation\">)</span>: <span class=\"token function\">open</span> /run/flannel/subnet.env: no such <span class=\"token function\">file</span> or directory<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<ul>\n<li>solutions: creating a file &amp;&amp; reset the cluster and reinstall the kube-flannel. ( worked in this case, solution of <code>work not ready</code>)(the file below maybe useless,it’s important to set <code>Podsubnet</code> in the init config file)</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span>  /run/flannel/subnet.env  <span class=\"token comment\">#  manual creating</span>\n\n<span class=\"token assign-left variable\">FLANNEL_NETWORK</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.0.0/16\n<span class=\"token assign-left variable\">FLANNEL_SUBNET</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.0.1/24\n<span class=\"token assign-left variable\">FLANNEL_MTU</span><span class=\"token operator\">=</span><span class=\"token number\">1450</span>\n<span class=\"token assign-left variable\">FLANNEL_IPMASQ</span><span class=\"token operator\">=</span>true<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"1-Computer-Parts\"><a href=\"#1-Computer-Parts\" class=\"headerlink\" title=\"1. Computer Parts\"></a>1. Computer Parts</h2><table>\n<thead>\n<tr>\n<th align=\"center\">配件</th>\n<th align=\"center\">规格</th>\n<th align=\"center\">价格</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">Motherboard</td>\n<td align=\"center\">华南x99双路8D4</td>\n<td align=\"center\">730含以下二者</td>\n</tr>\n<tr>\n<td align=\"center\">CPU</td>\n<td align=\"center\">E5-2680V4</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">Cooler</td>\n<td align=\"center\">寒冰A500四铜管</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">RAM</td>\n<td align=\"center\">闲鱼-镁光窄条2133-16G*4</td>\n<td align=\"center\">280</td>\n</tr>\n<tr>\n<td align=\"center\">GPU</td>\n<td align=\"center\">GTX750 4G 貌似全新</td>\n<td align=\"center\">335</td>\n</tr>\n<tr>\n<td align=\"center\">Chassis</td>\n<td align=\"center\">刀客360</td>\n<td align=\"center\">150</td>\n</tr>\n<tr>\n<td align=\"center\">Fan</td>\n<td align=\"center\">PDD-纯白*5</td>\n<td align=\"center\">48</td>\n</tr>\n<tr>\n<td align=\"center\">SSD</td>\n<td align=\"center\">BU KING 512G</td>\n<td align=\"center\">150</td>\n</tr>\n<tr>\n<td align=\"center\">Power</td>\n<td align=\"center\">华南U700双路电源600W</td>\n<td align=\"center\">243</td>\n</tr>\n<tr>\n<td align=\"center\">Tools</td>\n<td align=\"center\">硅脂、螺丝刀、网线</td>\n<td align=\"center\">25</td>\n</tr>\n</tbody></table>\n<h2 id=\"2-Install-PVE-System\"><a href=\"#2-Install-PVE-System\" class=\"headerlink\" title=\"2. Install PVE System\"></a>2. Install PVE System</h2><ul>\n<li>Ventoy</li>\n<li>proxmox-ve_8.0-2.iso</li>\n</ul>\n<h3 id=\"2-1-Disable-the-subscription-on-web-UI\"><a href=\"#2-1-Disable-the-subscription-on-web-UI\" class=\"headerlink\" title=\"2.1 Disable the subscription on web UI\"></a>2.1 Disable the subscription on web UI</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i_orig</span> <span class=\"token string\">\"s/data.status === 'Active'/true/g\"</span> /usr/share/pve-manager/js/pvemanagerlib.js\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i_orig</span> <span class=\"token string\">\"s/if (res === null || res === undefined || \\!res || res/if(/g\"</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i_orig</span> <span class=\"token string\">\"s/.data.status.toLowerCase() !== 'active'/false/g\"</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js\nsystemctl restart pveproxy<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-Network-Settings\"><a href=\"#2-2-Network-Settings\" class=\"headerlink\" title=\"2.2 Network Settings\"></a>2.2 Network Settings</h3><ul>\n<li><a href=\"https://www.bilibili.com/video/BV1xH4y1f7Ga/?spm_id_from=333.337.search-card.all.click&vd_source=154006e70f5c14d792db947270b63614\">reference</a></li>\n<li>pve host using a vitual NIC and bridging the network connection to a physical NIC<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> /etc/network/interfaces\nauto lo\niface lo inet loopback\niface enp6s0 inet manual    <span class=\"token comment\"># physical NIC</span>\n\nauto vmbr0               <span class=\"token comment\"># Vitrual NIC</span>\niface vmbr0 inet static\n        address <span class=\"token number\">192.168</span>.3.20/24\n        gateway <span class=\"token number\">192.168</span>.3.1\n        bridge-ports enp6s0     <span class=\"token comment\">#bridging</span>\n        bridge-stp off\n        bridge-fd <span class=\"token number\">0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl restart networking <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"2-3-Using-a-homeland-repository-source\"><a href=\"#2-3-Using-a-homeland-repository-source\" class=\"headerlink\" title=\"2.3  Using a homeland repository source\"></a>2.3 <a href=\"https://www.wunote.cn/article/10000\"> Using a homeland repository source</a></h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># modify the ubuntu software source</span>\n<span class=\"token function\">wget</span> https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bookworm.gpg <span class=\"token parameter variable\">-O</span> /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deb https://mirrors.ustc.edu.cn/proxmox/debian bookworm pve-no-subscription\"</span> <span class=\"token operator\">></span> /etc/apt/sources.list.d/pve-no-subscription.list\n\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s|^deb http://ftp.debian.org|deb https://mirrors.ustc.edu.cn|g'</span> /etc/apt/sources.list\n\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s|^deb http://security.debian.org|deb https://mirrors.ustc.edu.cn/debian-security|g'</span> /etc/apt/sources.list\n\n<span class=\"token comment\"># modify the ceph repository source</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-quincy bookworm no-subscription\"</span> <span class=\"token operator\">></span> /etc/apt/sources.list.d/ceph.list\n\n<span class=\"token comment\"># CT images source</span>\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s|http://download.proxmox.com|https://mirrors.ustc.edu.cn/proxmox|g'</span> /usr/share/perl5/PVE/APLInfo.pm\n\n<span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/^/#/'</span> /etc/apt/sources.list.d/pve-enterprise.list<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-Virtual-machine-on-pve-host\"><a href=\"#3-Virtual-machine-on-pve-host\" class=\"headerlink\" title=\"3. Virtual machine on pve host\"></a>3. Virtual machine on pve host</h2><h3 id=\"3-1-SYS\"><a href=\"#3-1-SYS\" class=\"headerlink\" title=\"3.1 SYS\"></a>3.1 SYS</h3><ul>\n<li>ubuntu 22.04.3 server</li>\n<li>choose network bridging on vmbr0, it’s convenient and fast. also because of my simple network architecture.</li>\n</ul>\n<h3 id=\"3-2-Repository-Source\"><a href=\"#3-2-Repository-Source\" class=\"headerlink\" title=\"3.2 Repository Source\"></a>3.2 Repository Source</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">deb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy main restricted universe multiverse\n\ndeb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy-security main restricted universe multiverse\n\ndeb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy-updates main restricted universe multiverse\n\ndeb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy-backports main restricted universe multiverse<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"3-3-Install-containerd、nerdctl-make-this-vm-as-a-template\"><a href=\"#3-3-Install-containerd、nerdctl-make-this-vm-as-a-template\" class=\"headerlink\" title=\"3.3 Install containerd、nerdctl &amp; make this vm as a template\"></a>3.3 Install containerd、nerdctl &amp; make this vm as a template</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">apt</span> <span class=\"token function\">install</span> containerd\ncontainerd config default <span class=\"token operator\">></span> /etc/containerd/config.toml  <span class=\"token comment\"># generating a default configuration of containerd</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>Modify part of this file, like below example.</li>\n</ul>\n<pre class=\"line-numbers language-toml\" data-language=\"toml\"><code class=\"language-toml\"><span class=\"token key property\">sandbox_image</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"registry.aliyuncs.com/google_containers/pause:3.8\"</span>\n<span class=\"token key property\">SystemdCgroup</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"</span><span class=\"token punctuation\">]</span>\n          <span class=\"token key property\">endpoint</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://bqr1dr1n.mirror.aliyuncs.com\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">[</span><span class=\"token table class-name\">plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"</span><span class=\"token punctuation\">]</span>\n          <span class=\"token key property\">endpoint</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://registry.aliyuncs.com/google_containers\"</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>Install the nerdctl by binary package</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://download.fastgit.org/containerd/nerdctl/releases/download/v0.12.1/nerdctl-0.12.1-linux-amd64.tar.gz\n<span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /usr/local/containerd/bin/ <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">tar</span> <span class=\"token parameter variable\">-zxvf</span> nerdctl-0.12.1-linux-amd64.tar.gz nerdctl <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">mv</span> nerdctl /usr/local/containerd/bin/\n<span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /usr/local/containerd/bin/nerdctl /usr/local/bin/nerdctl<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"3-4-System-settings\"><a href=\"#3-4-System-settings\" class=\"headerlink\" title=\"3.4 System settings\"></a>3.4 System settings</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># ipv4 forward</span>\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /etc/modules-load.d/k8s.conf</span>\noverlay\nbr_netfilter\nEOF</span>\n\nmodprobe overlay\nmodprobe br_netfilter\n\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /etc/sysctl.d/k8s.conf</span>\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward                 = 1\nEOF</span>\n\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span>\n<span class=\"token function\">sysctl</span> net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward\n\n<span class=\"token comment\"># swap</span>\nswapoff <span class=\"token parameter variable\">-a</span>\n\n<span class=\"token function\">vim</span> /etc/fstab\n  <span class=\"token comment\"># /swap.img      none    swap    sw      0       0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>Transform this vm into template by Web UI of pve</li>\n</ul>\n<h2 id=\"4-Kubernetes\"><a href=\"#4-Kubernetes\" class=\"headerlink\" title=\"4. Kubernetes\"></a>4. Kubernetes</h2><h3 id=\"4-1-Install-kubeadm-kubelet-kubectl\"><a href=\"#4-1-Install-kubeadm-kubelet-kubectl\" class=\"headerlink\" title=\"4.1 Install kubeadm kubelet kubectl\"></a>4.1 Install kubeadm kubelet kubectl</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main <span class=\"token operator\">></span> /etc/apt/sources.list.d/kubernetes.list\n<span class=\"token function\">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class=\"token operator\">|</span> <span class=\"token punctuation\">\\</span>\n\tapt-key <span class=\"token function\">add</span> -\n<span class=\"token function\">apt-get</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> kubelet kubeadm kubectl\napt-mark hold kubelet kubeadm kubectl<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"4-2-generate-a-default-configuration-file-in-workspace-path-to-init-the-cluster\"><a href=\"#4-2-generate-a-default-configuration-file-in-workspace-path-to-init-the-cluster\" class=\"headerlink\" title=\"4.2 generate a default configuration file in workspace path to init the cluster\"></a>4.2 generate a default configuration file in workspace path to init the cluster</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">kubeadm config print init-defaults --component-configs KubeletConfiguration &gt; kubeadm.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<ul>\n<li>modify part of configuration file</li>\n</ul>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">localAPIEndpoint</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">advertiseAddress</span><span class=\"token punctuation\">:</span> 192.168.3.11  <span class=\"token comment\">#master IP</span>\n  <span class=\"token key atrule\">bindPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6443</span>\n<span class=\"token key atrule\">nodeRegistration</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">criSocket</span><span class=\"token punctuation\">:</span> unix<span class=\"token punctuation\">:</span>///var/run/containerd/containerd.sock\n  <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n    <span class=\"token comment\">#name: master1  # defaults to be node</span>\n  <span class=\"token key atrule\">taints</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiServer</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">timeoutForControlPlane</span><span class=\"token punctuation\">:</span> 4m0s\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kubeadm.k8s.io/v1beta3\n<span class=\"token key atrule\">certificatesDir</span><span class=\"token punctuation\">:</span> /etc/kubernetes/pki\n<span class=\"token key atrule\">clusterName</span><span class=\"token punctuation\">:</span> kubernetes\n<span class=\"token key atrule\">controllerManager</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token key atrule\">dns</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token key atrule\">etcd</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">local</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">dataDir</span><span class=\"token punctuation\">:</span> /var/lib/etcd\n<span class=\"token key atrule\">imageRepository</span><span class=\"token punctuation\">:</span> registry.aliyuncs.com/google_containers  <span class=\"token comment\">#changing into repository in china</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterConfiguration\n<span class=\"token key atrule\">kubernetesVersion</span><span class=\"token punctuation\">:</span> 1.28.0    <span class=\"token comment\"># specify the version of kube</span>\n<span class=\"token key atrule\">networking</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">dnsDomain</span><span class=\"token punctuation\">:</span> cluster.local\n  <span class=\"token key atrule\">podSubnet</span><span class=\"token punctuation\">:</span> 10.244.0.0/16    <span class=\"token comment\"># need to add</span>\n  <span class=\"token key atrule\">serviceSubnet</span><span class=\"token punctuation\">:</span> 10.96.0.0/12\n<span class=\"token key atrule\">scheduler</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kubeproxy.config.k8s.io/v1alpha1 <span class=\"token comment\"># add</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> KubeProxyConfiguration\n<span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> ipvs<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>init cluster</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo kubeadm init --config kubeadm-config.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<ul>\n<li>work nodes joining the cluster</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubeadm join 192.168.3.14:6443 --token n8orxj.f51riixygulit9yz \\\n        --discovery-token-ca-cert-hash sha256:c0af38d55001f6eaf09ca9248db5e048c492ee4b883f0534a54187eceb50a928<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>after all the work nodes joining the cluster, deploy the flannel</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://raw.githubusercontent.com/flannel-io/flannel/v0.20.1/Documentation/kube-flannel.yml\nkubectl apply <span class=\"token parameter variable\">-f</span> kube-flannel.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>check status of cluster</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubectl get nodes -A\nkubectl get pods -A<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h2 id=\"5-Fault\"><a href=\"#5-Fault\" class=\"headerlink\" title=\"5. Fault\"></a>5. Fault</h2><h3 id=\"5-1-kubectl-get-nodes\"><a href=\"#5-1-kubectl-get-nodes\" class=\"headerlink\" title=\"5.1 kubectl get nodes\"></a>5.1 kubectl get nodes</h3><ul>\n<li>descriobe</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">couldn't get current server API group list: Get <span class=\"token string\">\"http://localhost:8080/api?timeout=32s\"</span><span class=\"token builtin class-name\">:</span> dial tcp <span class=\"token number\">127.0</span>.0.1:8080: connect: connection refused\nThe connection to the server localhost:8080 was refused - did you specify the right <span class=\"token function\">host</span> or port?<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>solution: fogot to apply the config, it’s printed by the kubeadm init command</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mkdir -p $HOME&#x2F;.kube\nsudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config\nsudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"5-2-The-kubelet-is-not-running\"><a href=\"#5-2-The-kubelet-is-not-running\" class=\"headerlink\" title=\"5.2 The kubelet is not running\"></a>5.2 The kubelet is not running</h3><ul>\n<li>describe</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>kubelet-check<span class=\"token punctuation\">]</span> Initial <span class=\"token function\">timeout</span> of 40s passed.\n\nUnfortunately, an error has occurred:\n        timed out waiting <span class=\"token keyword\">for</span> the condition\n\nThis error is likely caused by:\n        - The kubelet is not running\n        - The kubelet is unhealthy due to a misconfiguration of the <span class=\"token function\">node</span> <span class=\"token keyword\">in</span> some way <span class=\"token punctuation\">(</span>required cgroups disabled<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>solution: changing the wrong advertiseAddress, supoose to be mine master IP.</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># in some  conditions, this setting may help. It controls the cgroup driver of kubelet</span>\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\ncgroupDriver: systemd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"5-3-coredns-pod-halting-on-creating-status\"><a href=\"#5-3-coredns-pod-halting-on-creating-status\" class=\"headerlink\" title=\"5.3 coredns pod halting on creating status.\"></a>5.3 coredns pod halting on creating status.</h3><ul>\n<li>describe</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">Warning  FailedCreatePodSandBox  42s   kubelet            Failed to create pod sandbox: rpc error: code <span class=\"token operator\">=</span> Unknown desc <span class=\"token operator\">=</span> failed to setup network <span class=\"token keyword\">for</span> sandbox <span class=\"token string\">\"03e2b9a1ceaf66beb681891dc276ea490d664822b43047f25d3b5d4a11e76eb0\"</span><span class=\"token builtin class-name\">:</span> plugin <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"flannel\"</span> failed <span class=\"token punctuation\">(</span>add<span class=\"token punctuation\">)</span>: <span class=\"token function\">open</span> /run/flannel/subnet.env: no such <span class=\"token function\">file</span> or directory<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<ul>\n<li>solutions: creating a file &amp;&amp; reset the cluster and reinstall the kube-flannel. ( worked in this case, solution of <code>work not ready</code>)(the file below maybe useless,it’s important to set <code>Podsubnet</code> in the init config file)</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span>  /run/flannel/subnet.env  <span class=\"token comment\">#  manual creating</span>\n\n<span class=\"token assign-left variable\">FLANNEL_NETWORK</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.0.0/16\n<span class=\"token assign-left variable\">FLANNEL_SUBNET</span><span class=\"token operator\">=</span><span class=\"token number\">10.244</span>.0.1/24\n<span class=\"token assign-left variable\">FLANNEL_MTU</span><span class=\"token operator\">=</span><span class=\"token number\">1450</span>\n<span class=\"token assign-left variable\">FLANNEL_IPMASQ</span><span class=\"token operator\">=</span>true<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n"},{"title":"instant box","date":"2024-01-02T15:21:30.000Z","summary":"Instant Box 的测试使用，基于容器快速创建虚拟机容器并使用。","_content":"# Instant Box\n## 1. Introduce\nA project spins up temporary Linux systems with instant webshell access from any browser.\nIt can currently supports various versions of Ubuntu, CentOS, Arch Linux, Debian, Fedora and Alpine.\n## 2. Deployment\n```\n# docker-compose needed\nmkdir instantbox && cd $_\nbash <(curl -sSL https://raw.githubusercontent.com/instantbox/instantbox/master/init.sh)    # To create a  docker compose file，at the same time we can set ip & port here\ndocker-compose up -d  # deploy service\n```\n## 3.  Operation\n<pre>Run 'docker-compose up -d' then go to http://ip:8888 on your browser.\nWhen creating a new OS, the Docker engine will create a new container in host machine.\nNo persistent storage found.</pre>\n### 3.1 ssh into container\n- ubuntu\n\n```\napt install -y openssh-server\nssh-keygen -A    # 自动生成所有缺失的主机密钥文件\nvim ~/.ssh/authorized_keys   # 在目标机器需要登录的用户下，粘贴本机公钥（密码验证不成功）\n/usr/sbin/sshd     # 启动sshd\n宿主机 ssh 即可\n```\n### 3.2 Launch WEB Cli\n<pre>\nThe browser can only create one kind of system at the sametime\nClean the cache of browser or create a new incognito window, goes to console, create a new system in box.\nthen goes to eg URL: http://10.13.3.101:8888/console/container_ID(name)/\n</pre>\n\n## 4. Shut the service down\n<pre>\nWe're supposed to delete or purge the OS created before first, then purge the service container.\n</pre>","source":"_posts/instant-box.md","raw":"---\ntitle: instant box\ndate: 2024-01-02 23:21:30\ntags:\n  - demo test\nsummary: Instant Box 的测试使用，基于容器快速创建虚拟机容器并使用。\n---\n# Instant Box\n## 1. Introduce\nA project spins up temporary Linux systems with instant webshell access from any browser.\nIt can currently supports various versions of Ubuntu, CentOS, Arch Linux, Debian, Fedora and Alpine.\n## 2. Deployment\n```\n# docker-compose needed\nmkdir instantbox && cd $_\nbash <(curl -sSL https://raw.githubusercontent.com/instantbox/instantbox/master/init.sh)    # To create a  docker compose file，at the same time we can set ip & port here\ndocker-compose up -d  # deploy service\n```\n## 3.  Operation\n<pre>Run 'docker-compose up -d' then go to http://ip:8888 on your browser.\nWhen creating a new OS, the Docker engine will create a new container in host machine.\nNo persistent storage found.</pre>\n### 3.1 ssh into container\n- ubuntu\n\n```\napt install -y openssh-server\nssh-keygen -A    # 自动生成所有缺失的主机密钥文件\nvim ~/.ssh/authorized_keys   # 在目标机器需要登录的用户下，粘贴本机公钥（密码验证不成功）\n/usr/sbin/sshd     # 启动sshd\n宿主机 ssh 即可\n```\n### 3.2 Launch WEB Cli\n<pre>\nThe browser can only create one kind of system at the sametime\nClean the cache of browser or create a new incognito window, goes to console, create a new system in box.\nthen goes to eg URL: http://10.13.3.101:8888/console/container_ID(name)/\n</pre>\n\n## 4. Shut the service down\n<pre>\nWe're supposed to delete or purge the OS created before first, then purge the service container.\n</pre>","slug":"instant-box","published":1,"updated":"2024-04-20T03:18:37.505Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodjd001480rv846u9nlb","content":"<h1 id=\"Instant-Box\"><a href=\"#Instant-Box\" class=\"headerlink\" title=\"Instant Box\"></a>Instant Box</h1><h2 id=\"1-Introduce\"><a href=\"#1-Introduce\" class=\"headerlink\" title=\"1. Introduce\"></a>1. Introduce</h2><p>A project spins up temporary Linux systems with instant webshell access from any browser.<br>It can currently supports various versions of Ubuntu, CentOS, Arch Linux, Debian, Fedora and Alpine.</p>\n<h2 id=\"2-Deployment\"><a href=\"#2-Deployment\" class=\"headerlink\" title=\"2. Deployment\"></a>2. Deployment</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\"># docker-compose needed\nmkdir instantbox &amp;&amp; cd $_\nbash &lt;(curl -sSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;instantbox&#x2F;instantbox&#x2F;master&#x2F;init.sh)    # To create a  docker compose file，at the same time we can set ip &amp; port here\ndocker-compose up -d  # deploy service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"3-Operation\"><a href=\"#3-Operation\" class=\"headerlink\" title=\"3.  Operation\"></a>3.  Operation</h2><pre>Run 'docker-compose up -d' then go to http://ip:8888 on your browser.\nWhen creating a new OS, the Docker engine will create a new container in host machine.\nNo persistent storage found.</pre>\n<h3 id=\"3-1-ssh-into-container\"><a href=\"#3-1-ssh-into-container\" class=\"headerlink\" title=\"3.1 ssh into container\"></a>3.1 ssh into container</h3><ul>\n<li>ubuntu</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apt install -y openssh-server\nssh-keygen -A    # 自动生成所有缺失的主机密钥文件\nvim ~&#x2F;.ssh&#x2F;authorized_keys   # 在目标机器需要登录的用户下，粘贴本机公钥（密码验证不成功）\n&#x2F;usr&#x2F;sbin&#x2F;sshd     # 启动sshd\n宿主机 ssh 即可<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"3-2-Launch-WEB-Cli\"><a href=\"#3-2-Launch-WEB-Cli\" class=\"headerlink\" title=\"3.2 Launch WEB Cli\"></a>3.2 Launch WEB Cli</h3><pre>\nThe browser can only create one kind of system at the sametime\nClean the cache of browser or create a new incognito window, goes to console, create a new system in box.\nthen goes to eg URL: http://10.13.3.101:8888/console/container_ID(name)/\n</pre>\n\n<h2 id=\"4-Shut-the-service-down\"><a href=\"#4-Shut-the-service-down\" class=\"headerlink\" title=\"4. Shut the service down\"></a>4. Shut the service down</h2><pre>\nWe're supposed to delete or purge the OS created before first, then purge the service container.\n</pre>","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"Instant-Box\"><a href=\"#Instant-Box\" class=\"headerlink\" title=\"Instant Box\"></a>Instant Box</h1><h2 id=\"1-Introduce\"><a href=\"#1-Introduce\" class=\"headerlink\" title=\"1. Introduce\"></a>1. Introduce</h2><p>A project spins up temporary Linux systems with instant webshell access from any browser.<br>It can currently supports various versions of Ubuntu, CentOS, Arch Linux, Debian, Fedora and Alpine.</p>\n<h2 id=\"2-Deployment\"><a href=\"#2-Deployment\" class=\"headerlink\" title=\"2. Deployment\"></a>2. Deployment</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\"># docker-compose needed\nmkdir instantbox &amp;&amp; cd $_\nbash &lt;(curl -sSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;instantbox&#x2F;instantbox&#x2F;master&#x2F;init.sh)    # To create a  docker compose file，at the same time we can set ip &amp; port here\ndocker-compose up -d  # deploy service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"3-Operation\"><a href=\"#3-Operation\" class=\"headerlink\" title=\"3.  Operation\"></a>3.  Operation</h2><pre>Run 'docker-compose up -d' then go to http://ip:8888 on your browser.\nWhen creating a new OS, the Docker engine will create a new container in host machine.\nNo persistent storage found.</pre>\n<h3 id=\"3-1-ssh-into-container\"><a href=\"#3-1-ssh-into-container\" class=\"headerlink\" title=\"3.1 ssh into container\"></a>3.1 ssh into container</h3><ul>\n<li>ubuntu</li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apt install -y openssh-server\nssh-keygen -A    # 自动生成所有缺失的主机密钥文件\nvim ~&#x2F;.ssh&#x2F;authorized_keys   # 在目标机器需要登录的用户下，粘贴本机公钥（密码验证不成功）\n&#x2F;usr&#x2F;sbin&#x2F;sshd     # 启动sshd\n宿主机 ssh 即可<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"3-2-Launch-WEB-Cli\"><a href=\"#3-2-Launch-WEB-Cli\" class=\"headerlink\" title=\"3.2 Launch WEB Cli\"></a>3.2 Launch WEB Cli</h3><pre>\nThe browser can only create one kind of system at the sametime\nClean the cache of browser or create a new incognito window, goes to console, create a new system in box.\nthen goes to eg URL: http://10.13.3.101:8888/console/container_ID(name)/\n</pre>\n\n<h2 id=\"4-Shut-the-service-down\"><a href=\"#4-Shut-the-service-down\" class=\"headerlink\" title=\"4. Shut the service down\"></a>4. Shut the service down</h2><pre>\nWe're supposed to delete or purge the OS created before first, then purge the service container.\n</pre>"},{"title":"kube-prometheus-stack","author":"LC","toc":true,"date":"2024-04-30T15:15:54.000Z","img":null,"top":true,"cover":null,"password":null,"summary":"kube-prometheus-stack是prometheus监控k8s集群的套件，可以通过helm一键安装，同时带有监控的模板。","_content":"\n在 kube-prometheus-stack 中，prometheus 资源对象（crd 对象，而不是 prometheus 这个应用）需要对以下内容特别注意\nprometheus 对象的 yaml 部分内容   \n```\n  namespaceselector：\n    any: true\n  serviceMonitorSelector:\n    matchLabels:\n      release: kube-prometheus-stack   # 说明：servicemonitor的资源需要有这个标签，才能被控制器控制使用\n```\n\n书写一个 servicemonitor。\n```\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    objectset.rio.cattle.io/hash: f3ca87e2e941644e0d103f8e0d05b2e610db5092\n    release: kube-prometheus-stack\n  name: kube-prometheus-stack-rocketchat\n  namespace: kube-prom\nspec:\n  endpoints:\n    - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token\n      port: metrics\n  jobLabel: jobLabel\n  namespaceSelector:\n    matchNames:\n      - rocketchat\n  selector:\n    matchLabels:\n      app.kubernetes.io/instance: rocketchat\n      app.kubernetes.io/managed-by: Helm\n      app.kubernetes.io/name: rocketchat\n```\n\n书写服务自动发现。\n通过命令和文件创建的 secret\n```\nvim sd.yaml\nkubectl create secret generic kube-prometheus-stack-sd --from-file=./sd.yaml -n kube-prom\nsecret/kube-prometheus-stack-sd created\n```\n\n配置使用这个secret\n```\nprometheus:\n  prometheusspec:\n    additionalScrapeConfigsSecret: {}\n      enabled: false\n      name: kube-prometheus-stack-sd\n      key: sd.yaml\n```\n\nsd.yaml\n```\n- job_name: kubernetes-service-endpoints\n  kubernetes_sd_configs:\n    - role: endpoints\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape\n    - action: drop\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (.+?)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n      source_labels:\n        - __address__\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_app_(.+)\n      replacement: __param_$1\n    - action: replace\n      regex: __meta_kubernetes_service_label_(.+)\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_service_name\n      target_label: service\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n- job_name: kubernetes-service-endpoints-slow\n  kubernetes_sd_configs:\n    - role: endpoints\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (.+?)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n      source_labels:\n        - __address__\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_(.+)\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_service_name\n      target_label: service\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n  scrape_interval: 5m\n  scrape_timeout: 30s\n- honor_labels: true\n  job_name: kubernetes-pods\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape\n    - action: drop\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4})\n      replacement: '[$2]:$1'\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: replace\n      regex: (\\d+);((([0-9]+?)(\\.|$)){4})\n      replacement: $2:$1\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action：replace\n      source_labels:\n        - __meta_kubernetes_pod_label_release\n      target_labels: release\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n    - action: drop\n      regex: Pending|Succeeded|Failed|Completed\n      source_labels:\n        - __meta_kubernetes_pod_phase\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n- honor_labels: true\n  job_name: kubernetes-pods-slow\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4})\n      replacement: '[$2]:$1'\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: replace\n      regex: (\\d+);((([0-9]+?)(\\.|$)){4})\n      replacement: $2:$1\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action：replace\n      source_labels:\n        - __meta_kubernetes_pod_label_release\n      target_labels: release\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n    - action: drop\n      regex: Pending|Succeeded|Failed|Completed\n      source_labels:\n        - __meta_kubernetes_pod_phase\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n  scrape_interval: 5m\n  scrape_timeout: 30s\n```\n\n\n在 Prometheus 中， `relabel_config` 用于在抓取目标之前对目标的标签进行重写，这在服务发现和数据组织中非常有用。以下是 `relabel_config` 中可以使用的所有参数的详细介绍：\n\n1. **`action`**: 指定要执行的操作，可用的动作包括：\n   - `replace`: 替换标签的键或值。\n   - `keep`: 保留匹配正则表达式的实例，丢弃其他实例。\n   - `drop`: 丢弃匹配正则表达式的实例，保留其他实例。\n   - `labelmap`: 将一个标签映射到另一个标签，可以用于重命名或重组标签。\n   - `labeldrop`: 删除指定的标签。\n   - `labelkeep`: 仅保留指定的标签，删除其他所有标签。\n\n2. **`source_labels`**: 一个包含要进行重写的原始标签名的数组。对于`replace`动作，至少需要一个标签；对于`keep`、`drop`、`labeldrop`和`labelkeep`动作，通常需要指定要匹配的标签。\n\n3. **`regex`**: 一个正则表达式，用于匹配`source_labels`中的标签值。对于`replace`动作，它可以是一个固定的字符串或者正则表达式；对于`keep`和`drop`动作，它通常是一个用于匹配的正则表达式。\n\n4. **`target_label`**: 对于`replace`动作，这是要设置的新标签名。对于其他动作，这个字段不被使用。\n\n5. **`replacement`**: 对于`replace`动作，这是新标签的值。它可以使用正则表达式捕获组（如`$1`），以动态设置新值。\n\n6. **`separator`**: 对于`labelmap`动作，这是一个字符串，用于分隔复合标签中的各个部分。\n\n7. **`modulus`**: 对于`hashmod`动作，这是一个整数，表示将标签值映射到一个特定的基数。\n\n8. **`hash_mapping_file`**: 对于`hashmod`动作，这是一个文件路径，指定了一个包含标签值到特定基数映射的文件。\n\n9. **`labeldrop`**: 用于删除匹配正则表达式的标签。\n\n10. **`labelkeep`**: 用于保留匹配正则表达式的标签，删除其他所有标签。\n\n11. **`tmp_label_name`**: 一个临时标签名，用于在重写过程中存储中间结果。\n\n这些参数可以组合使用，以实现复杂的重写逻辑。例如，您可以先使用`labeldrop`删除不需要的标签，然后使用`replace`修改或添加新的标签，最后使用`labelmap`重命名标签以符合您的数据模型。\n\n`relabel_config`的使用非常灵活，可以根据您的具体需求进行调整。在实际应用中，您可能需要结合您的服务发现机制、数据模型以及Prometheus的配置来设计合适的`relabel_config`。","source":"_posts/kube-Prometheus-stack.md","raw":"---\ntitle: kube-prometheus-stack\nauthor: LC\ntoc: true\ndate: 2024-04-30 23:15:54\nimg:\ntop: true\ncover:\npassword:\nsummary: kube-prometheus-stack是prometheus监控k8s集群的套件，可以通过helm一键安装，同时带有监控的模板。\ncategories: kubernetes\ntags: [prometheus]\n---\n\n在 kube-prometheus-stack 中，prometheus 资源对象（crd 对象，而不是 prometheus 这个应用）需要对以下内容特别注意\nprometheus 对象的 yaml 部分内容   \n```\n  namespaceselector：\n    any: true\n  serviceMonitorSelector:\n    matchLabels:\n      release: kube-prometheus-stack   # 说明：servicemonitor的资源需要有这个标签，才能被控制器控制使用\n```\n\n书写一个 servicemonitor。\n```\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    objectset.rio.cattle.io/hash: f3ca87e2e941644e0d103f8e0d05b2e610db5092\n    release: kube-prometheus-stack\n  name: kube-prometheus-stack-rocketchat\n  namespace: kube-prom\nspec:\n  endpoints:\n    - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token\n      port: metrics\n  jobLabel: jobLabel\n  namespaceSelector:\n    matchNames:\n      - rocketchat\n  selector:\n    matchLabels:\n      app.kubernetes.io/instance: rocketchat\n      app.kubernetes.io/managed-by: Helm\n      app.kubernetes.io/name: rocketchat\n```\n\n书写服务自动发现。\n通过命令和文件创建的 secret\n```\nvim sd.yaml\nkubectl create secret generic kube-prometheus-stack-sd --from-file=./sd.yaml -n kube-prom\nsecret/kube-prometheus-stack-sd created\n```\n\n配置使用这个secret\n```\nprometheus:\n  prometheusspec:\n    additionalScrapeConfigsSecret: {}\n      enabled: false\n      name: kube-prometheus-stack-sd\n      key: sd.yaml\n```\n\nsd.yaml\n```\n- job_name: kubernetes-service-endpoints\n  kubernetes_sd_configs:\n    - role: endpoints\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape\n    - action: drop\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (.+?)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n      source_labels:\n        - __address__\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_app_(.+)\n      replacement: __param_$1\n    - action: replace\n      regex: __meta_kubernetes_service_label_(.+)\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_service_name\n      target_label: service\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n- job_name: kubernetes-service-endpoints-slow\n  kubernetes_sd_configs:\n    - role: endpoints\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (.+?)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n      source_labels:\n        - __address__\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_(.+)\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_service_name\n      target_label: service\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n  scrape_interval: 5m\n  scrape_timeout: 30s\n- honor_labels: true\n  job_name: kubernetes-pods\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape\n    - action: drop\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4})\n      replacement: '[$2]:$1'\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: replace\n      regex: (\\d+);((([0-9]+?)(\\.|$)){4})\n      replacement: $2:$1\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action：replace\n      source_labels:\n        - __meta_kubernetes_pod_label_release\n      target_labels: release\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n    - action: drop\n      regex: Pending|Succeeded|Failed|Completed\n      source_labels:\n        - __meta_kubernetes_pod_phase\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n- honor_labels: true\n  job_name: kubernetes-pods-slow\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4})\n      replacement: '[$2]:$1'\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: replace\n      regex: (\\d+);((([0-9]+?)(\\.|$)){4})\n      replacement: $2:$1\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action：replace\n      source_labels:\n        - __meta_kubernetes_pod_label_release\n      target_labels: release\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n    - action: drop\n      regex: Pending|Succeeded|Failed|Completed\n      source_labels:\n        - __meta_kubernetes_pod_phase\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n  scrape_interval: 5m\n  scrape_timeout: 30s\n```\n\n\n在 Prometheus 中， `relabel_config` 用于在抓取目标之前对目标的标签进行重写，这在服务发现和数据组织中非常有用。以下是 `relabel_config` 中可以使用的所有参数的详细介绍：\n\n1. **`action`**: 指定要执行的操作，可用的动作包括：\n   - `replace`: 替换标签的键或值。\n   - `keep`: 保留匹配正则表达式的实例，丢弃其他实例。\n   - `drop`: 丢弃匹配正则表达式的实例，保留其他实例。\n   - `labelmap`: 将一个标签映射到另一个标签，可以用于重命名或重组标签。\n   - `labeldrop`: 删除指定的标签。\n   - `labelkeep`: 仅保留指定的标签，删除其他所有标签。\n\n2. **`source_labels`**: 一个包含要进行重写的原始标签名的数组。对于`replace`动作，至少需要一个标签；对于`keep`、`drop`、`labeldrop`和`labelkeep`动作，通常需要指定要匹配的标签。\n\n3. **`regex`**: 一个正则表达式，用于匹配`source_labels`中的标签值。对于`replace`动作，它可以是一个固定的字符串或者正则表达式；对于`keep`和`drop`动作，它通常是一个用于匹配的正则表达式。\n\n4. **`target_label`**: 对于`replace`动作，这是要设置的新标签名。对于其他动作，这个字段不被使用。\n\n5. **`replacement`**: 对于`replace`动作，这是新标签的值。它可以使用正则表达式捕获组（如`$1`），以动态设置新值。\n\n6. **`separator`**: 对于`labelmap`动作，这是一个字符串，用于分隔复合标签中的各个部分。\n\n7. **`modulus`**: 对于`hashmod`动作，这是一个整数，表示将标签值映射到一个特定的基数。\n\n8. **`hash_mapping_file`**: 对于`hashmod`动作，这是一个文件路径，指定了一个包含标签值到特定基数映射的文件。\n\n9. **`labeldrop`**: 用于删除匹配正则表达式的标签。\n\n10. **`labelkeep`**: 用于保留匹配正则表达式的标签，删除其他所有标签。\n\n11. **`tmp_label_name`**: 一个临时标签名，用于在重写过程中存储中间结果。\n\n这些参数可以组合使用，以实现复杂的重写逻辑。例如，您可以先使用`labeldrop`删除不需要的标签，然后使用`replace`修改或添加新的标签，最后使用`labelmap`重命名标签以符合您的数据模型。\n\n`relabel_config`的使用非常灵活，可以根据您的具体需求进行调整。在实际应用中，您可能需要结合您的服务发现机制、数据模型以及Prometheus的配置来设计合适的`relabel_config`。","slug":"kube-Prometheus-stack","published":1,"updated":"2024-04-30T17:10:29.901Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodji001880rvaga190om","content":"<p>在 kube-prometheus-stack 中，prometheus 资源对象（crd 对象，而不是 prometheus 这个应用）需要对以下内容特别注意<br>prometheus 对象的 yaml 部分内容   </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">namespaceselector：\n  any: true\nserviceMonitorSelector:\n  matchLabels:\n    release: kube-prometheus-stack   # 说明：servicemonitor的资源需要有这个标签，才能被控制器控制使用<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>书写一个 servicemonitor。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apiVersion: monitoring.coreos.com&#x2F;v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    objectset.rio.cattle.io&#x2F;hash: f3ca87e2e941644e0d103f8e0d05b2e610db5092\n    release: kube-prometheus-stack\n  name: kube-prometheus-stack-rocketchat\n  namespace: kube-prom\nspec:\n  endpoints:\n    - bearerTokenFile: &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;token\n      port: metrics\n  jobLabel: jobLabel\n  namespaceSelector:\n    matchNames:\n      - rocketchat\n  selector:\n    matchLabels:\n      app.kubernetes.io&#x2F;instance: rocketchat\n      app.kubernetes.io&#x2F;managed-by: Helm\n      app.kubernetes.io&#x2F;name: rocketchat<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>书写服务自动发现。<br>通过命令和文件创建的 secret</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">vim sd.yaml\nkubectl create secret generic kube-prometheus-stack-sd --from-file&#x3D;.&#x2F;sd.yaml -n kube-prom\nsecret&#x2F;kube-prometheus-stack-sd created<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>配置使用这个secret</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">prometheus:\n  prometheusspec:\n    additionalScrapeConfigsSecret: &#123;&#125;\n      enabled: false\n      name: kube-prometheus-stack-sd\n      key: sd.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>sd.yaml</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: kubernetes-service-endpoints\n  kubernetes_sd_configs:\n    - role: endpoints\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape\n    - action: drop\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (.+?)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n      source_labels:\n        - __address__\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_app_(.+)\n      replacement: __param_$1\n    - action: replace\n      regex: __meta_kubernetes_service_label_(.+)\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_service_name\n      target_label: service\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n- job_name: kubernetes-service-endpoints-slow\n  kubernetes_sd_configs:\n    - role: endpoints\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (.+?)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n      source_labels:\n        - __address__\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_(.+)\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_service_name\n      target_label: service\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n  scrape_interval: 5m\n  scrape_timeout: 30s\n- honor_labels: true\n  job_name: kubernetes-pods\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape\n    - action: drop\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (\\d+);(([A-Fa-f0-9]&#123;1,4&#125;::?)&#123;1,7&#125;[A-Fa-f0-9]&#123;1,4&#125;)\n      replacement: &#39;[$2]:$1&#39;\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: replace\n      regex: (\\d+);((([0-9]+?)(\\.|$))&#123;4&#125;)\n      replacement: $2:$1\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action：replace\n      source_labels:\n        - __meta_kubernetes_pod_label_release\n      target_labels: release\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n    - action: drop\n      regex: Pending|Succeeded|Failed|Completed\n      source_labels:\n        - __meta_kubernetes_pod_phase\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n- honor_labels: true\n  job_name: kubernetes-pods-slow\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (\\d+);(([A-Fa-f0-9]&#123;1,4&#125;::?)&#123;1,7&#125;[A-Fa-f0-9]&#123;1,4&#125;)\n      replacement: &#39;[$2]:$1&#39;\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: replace\n      regex: (\\d+);((([0-9]+?)(\\.|$))&#123;4&#125;)\n      replacement: $2:$1\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action：replace\n      source_labels:\n        - __meta_kubernetes_pod_label_release\n      target_labels: release\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n    - action: drop\n      regex: Pending|Succeeded|Failed|Completed\n      source_labels:\n        - __meta_kubernetes_pod_phase\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n  scrape_interval: 5m\n  scrape_timeout: 30s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<p>在 Prometheus 中， <code>relabel_config</code> 用于在抓取目标之前对目标的标签进行重写，这在服务发现和数据组织中非常有用。以下是 <code>relabel_config</code> 中可以使用的所有参数的详细介绍：</p>\n<ol>\n<li><p><strong><code>action</code></strong>: 指定要执行的操作，可用的动作包括：</p>\n<ul>\n<li><code>replace</code>: 替换标签的键或值。</li>\n<li><code>keep</code>: 保留匹配正则表达式的实例，丢弃其他实例。</li>\n<li><code>drop</code>: 丢弃匹配正则表达式的实例，保留其他实例。</li>\n<li><code>labelmap</code>: 将一个标签映射到另一个标签，可以用于重命名或重组标签。</li>\n<li><code>labeldrop</code>: 删除指定的标签。</li>\n<li><code>labelkeep</code>: 仅保留指定的标签，删除其他所有标签。</li>\n</ul>\n</li>\n<li><p><strong><code>source_labels</code></strong>: 一个包含要进行重写的原始标签名的数组。对于<code>replace</code>动作，至少需要一个标签；对于<code>keep</code>、<code>drop</code>、<code>labeldrop</code>和<code>labelkeep</code>动作，通常需要指定要匹配的标签。</p>\n</li>\n<li><p><strong><code>regex</code></strong>: 一个正则表达式，用于匹配<code>source_labels</code>中的标签值。对于<code>replace</code>动作，它可以是一个固定的字符串或者正则表达式；对于<code>keep</code>和<code>drop</code>动作，它通常是一个用于匹配的正则表达式。</p>\n</li>\n<li><p><strong><code>target_label</code></strong>: 对于<code>replace</code>动作，这是要设置的新标签名。对于其他动作，这个字段不被使用。</p>\n</li>\n<li><p><strong><code>replacement</code></strong>: 对于<code>replace</code>动作，这是新标签的值。它可以使用正则表达式捕获组（如<code>$1</code>），以动态设置新值。</p>\n</li>\n<li><p><strong><code>separator</code></strong>: 对于<code>labelmap</code>动作，这是一个字符串，用于分隔复合标签中的各个部分。</p>\n</li>\n<li><p><strong><code>modulus</code></strong>: 对于<code>hashmod</code>动作，这是一个整数，表示将标签值映射到一个特定的基数。</p>\n</li>\n<li><p><strong><code>hash_mapping_file</code></strong>: 对于<code>hashmod</code>动作，这是一个文件路径，指定了一个包含标签值到特定基数映射的文件。</p>\n</li>\n<li><p><strong><code>labeldrop</code></strong>: 用于删除匹配正则表达式的标签。</p>\n</li>\n<li><p><strong><code>labelkeep</code></strong>: 用于保留匹配正则表达式的标签，删除其他所有标签。</p>\n</li>\n<li><p><strong><code>tmp_label_name</code></strong>: 一个临时标签名，用于在重写过程中存储中间结果。</p>\n</li>\n</ol>\n<p>这些参数可以组合使用，以实现复杂的重写逻辑。例如，您可以先使用<code>labeldrop</code>删除不需要的标签，然后使用<code>replace</code>修改或添加新的标签，最后使用<code>labelmap</code>重命名标签以符合您的数据模型。</p>\n<p><code>relabel_config</code>的使用非常灵活，可以根据您的具体需求进行调整。在实际应用中，您可能需要结合您的服务发现机制、数据模型以及Prometheus的配置来设计合适的<code>relabel_config</code>。</p>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<p>在 kube-prometheus-stack 中，prometheus 资源对象（crd 对象，而不是 prometheus 这个应用）需要对以下内容特别注意<br>prometheus 对象的 yaml 部分内容   </p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">namespaceselector：\n  any: true\nserviceMonitorSelector:\n  matchLabels:\n    release: kube-prometheus-stack   # 说明：servicemonitor的资源需要有这个标签，才能被控制器控制使用<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>书写一个 servicemonitor。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">apiVersion: monitoring.coreos.com&#x2F;v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    objectset.rio.cattle.io&#x2F;hash: f3ca87e2e941644e0d103f8e0d05b2e610db5092\n    release: kube-prometheus-stack\n  name: kube-prometheus-stack-rocketchat\n  namespace: kube-prom\nspec:\n  endpoints:\n    - bearerTokenFile: &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;token\n      port: metrics\n  jobLabel: jobLabel\n  namespaceSelector:\n    matchNames:\n      - rocketchat\n  selector:\n    matchLabels:\n      app.kubernetes.io&#x2F;instance: rocketchat\n      app.kubernetes.io&#x2F;managed-by: Helm\n      app.kubernetes.io&#x2F;name: rocketchat<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>书写服务自动发现。<br>通过命令和文件创建的 secret</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">vim sd.yaml\nkubectl create secret generic kube-prometheus-stack-sd --from-file&#x3D;.&#x2F;sd.yaml -n kube-prom\nsecret&#x2F;kube-prometheus-stack-sd created<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>配置使用这个secret</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">prometheus:\n  prometheusspec:\n    additionalScrapeConfigsSecret: &#123;&#125;\n      enabled: false\n      name: kube-prometheus-stack-sd\n      key: sd.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>sd.yaml</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: kubernetes-service-endpoints\n  kubernetes_sd_configs:\n    - role: endpoints\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape\n    - action: drop\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (.+?)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n      source_labels:\n        - __address__\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_app_(.+)\n      replacement: __param_$1\n    - action: replace\n      regex: __meta_kubernetes_service_label_(.+)\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_service_name\n      target_label: service\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n- job_name: kubernetes-service-endpoints-slow\n  kubernetes_sd_configs:\n    - role: endpoints\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (.+?)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n      source_labels:\n        - __address__\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_(.+)\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_service_name\n      target_label: service\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n  scrape_interval: 5m\n  scrape_timeout: 30s\n- honor_labels: true\n  job_name: kubernetes-pods\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape\n    - action: drop\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (\\d+);(([A-Fa-f0-9]&#123;1,4&#125;::?)&#123;1,7&#125;[A-Fa-f0-9]&#123;1,4&#125;)\n      replacement: &#39;[$2]:$1&#39;\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: replace\n      regex: (\\d+);((([0-9]+?)(\\.|$))&#123;4&#125;)\n      replacement: $2:$1\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action：replace\n      source_labels:\n        - __meta_kubernetes_pod_label_release\n      target_labels: release\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n    - action: drop\n      regex: Pending|Succeeded|Failed|Completed\n      source_labels:\n        - __meta_kubernetes_pod_phase\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n- honor_labels: true\n  job_name: kubernetes-pods-slow\n  kubernetes_sd_configs:\n    - role: pod\n  relabel_configs:\n    - action: keep\n      regex: true\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow\n    - action: replace\n      regex: (https?)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_scheme\n      target_label: __scheme__\n    - action: replace\n      regex: (.+)\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_path\n      target_label: __metrics_path__\n    - action: replace\n      regex: (\\d+);(([A-Fa-f0-9]&#123;1,4&#125;::?)&#123;1,7&#125;[A-Fa-f0-9]&#123;1,4&#125;)\n      replacement: &#39;[$2]:$1&#39;\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: replace\n      regex: (\\d+);((([0-9]+?)(\\.|$))&#123;4&#125;)\n      replacement: $2:$1\n      source_labels:\n        - __meta_kubernetes_pod_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_ip\n      target_label: __address__\n    - action: labelmap\n      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)\n      replacement: __param_$1\n    - action：replace\n      source_labels:\n        - __meta_kubernetes_pod_label_release\n      target_labels: release\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_namespace\n      target_label: namespace\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_name\n      target_label: pod\n    - action: drop\n      regex: Pending|Succeeded|Failed|Completed\n      source_labels:\n        - __meta_kubernetes_pod_phase\n    - action: replace\n      source_labels:\n        - __meta_kubernetes_pod_node_name\n      target_label: node\n  scrape_interval: 5m\n  scrape_timeout: 30s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<p>在 Prometheus 中， <code>relabel_config</code> 用于在抓取目标之前对目标的标签进行重写，这在服务发现和数据组织中非常有用。以下是 <code>relabel_config</code> 中可以使用的所有参数的详细介绍：</p>\n<ol>\n<li><p><strong><code>action</code></strong>: 指定要执行的操作，可用的动作包括：</p>\n<ul>\n<li><code>replace</code>: 替换标签的键或值。</li>\n<li><code>keep</code>: 保留匹配正则表达式的实例，丢弃其他实例。</li>\n<li><code>drop</code>: 丢弃匹配正则表达式的实例，保留其他实例。</li>\n<li><code>labelmap</code>: 将一个标签映射到另一个标签，可以用于重命名或重组标签。</li>\n<li><code>labeldrop</code>: 删除指定的标签。</li>\n<li><code>labelkeep</code>: 仅保留指定的标签，删除其他所有标签。</li>\n</ul>\n</li>\n<li><p><strong><code>source_labels</code></strong>: 一个包含要进行重写的原始标签名的数组。对于<code>replace</code>动作，至少需要一个标签；对于<code>keep</code>、<code>drop</code>、<code>labeldrop</code>和<code>labelkeep</code>动作，通常需要指定要匹配的标签。</p>\n</li>\n<li><p><strong><code>regex</code></strong>: 一个正则表达式，用于匹配<code>source_labels</code>中的标签值。对于<code>replace</code>动作，它可以是一个固定的字符串或者正则表达式；对于<code>keep</code>和<code>drop</code>动作，它通常是一个用于匹配的正则表达式。</p>\n</li>\n<li><p><strong><code>target_label</code></strong>: 对于<code>replace</code>动作，这是要设置的新标签名。对于其他动作，这个字段不被使用。</p>\n</li>\n<li><p><strong><code>replacement</code></strong>: 对于<code>replace</code>动作，这是新标签的值。它可以使用正则表达式捕获组（如<code>$1</code>），以动态设置新值。</p>\n</li>\n<li><p><strong><code>separator</code></strong>: 对于<code>labelmap</code>动作，这是一个字符串，用于分隔复合标签中的各个部分。</p>\n</li>\n<li><p><strong><code>modulus</code></strong>: 对于<code>hashmod</code>动作，这是一个整数，表示将标签值映射到一个特定的基数。</p>\n</li>\n<li><p><strong><code>hash_mapping_file</code></strong>: 对于<code>hashmod</code>动作，这是一个文件路径，指定了一个包含标签值到特定基数映射的文件。</p>\n</li>\n<li><p><strong><code>labeldrop</code></strong>: 用于删除匹配正则表达式的标签。</p>\n</li>\n<li><p><strong><code>labelkeep</code></strong>: 用于保留匹配正则表达式的标签，删除其他所有标签。</p>\n</li>\n<li><p><strong><code>tmp_label_name</code></strong>: 一个临时标签名，用于在重写过程中存储中间结果。</p>\n</li>\n</ol>\n<p>这些参数可以组合使用，以实现复杂的重写逻辑。例如，您可以先使用<code>labeldrop</code>删除不需要的标签，然后使用<code>replace</code>修改或添加新的标签，最后使用<code>labelmap</code>重命名标签以符合您的数据模型。</p>\n<p><code>relabel_config</code>的使用非常灵活，可以根据您的具体需求进行调整。在实际应用中，您可能需要结合您的服务发现机制、数据模型以及Prometheus的配置来设计合适的<code>relabel_config</code>。</p>\n"},{"title":"post img","date":"2024-03-09T13:36:00.000Z","summary":"hexo 图片渲染展示","_content":"## 1. 配置修改\n修改项目中的`_config.yml`文件\n```\npost_asset_folder: true  # 配置为true\nmarked:                  # 新增\n  prependRoot: true\n  postAsset: true\n```\n\n## 2. 测试\n奇怪，只能渲染网络链接的图片，不能渲染资源文件夹中的文件；完全按照官方说明配置\n后续准备使用图床, 选择了这个平台[mjj.today](https://mjj.today/)\n<!-- ![测试图片](post-img/img.jpg) -->\n\n\n<!-- {% asset_img 'https://images.pexels.com/photos/20440051/pexels-photo-20440051.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1' This is a test image %} -->\n\n![测试图床](https://images.pexels.com/photos/20440051/pexels-photo-20440051.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1)\n\n![ee074148edfc1f63b015446c40b02ef2.png](https://ice.frostsky.com/2024/03/09/ee074148edfc1f63b015446c40b02ef2.png)\n\n## 3. reference\n[reference 1](https://blog.csdn.net/2301_77285173/article/details/130189857)\n[reference 2](https://zhuanlan.zhihu.com/p/104996801)\n\n## 4. 测试嵌入视频\n这是直接使用b站视频分享中的嵌入代码，显示不友好\n```\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n```\n**效果**\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n\n**调整**\n```\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe>\n</div>\n```\n**调整效果**\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe>\n</div>\n\n","source":"_posts/post-img.md","raw":"---\ntitle: post img\ndate: 2024-03-09 21:36:00\ntags: hexo\nsummary: hexo 图片渲染展示\n---\n## 1. 配置修改\n修改项目中的`_config.yml`文件\n```\npost_asset_folder: true  # 配置为true\nmarked:                  # 新增\n  prependRoot: true\n  postAsset: true\n```\n\n## 2. 测试\n奇怪，只能渲染网络链接的图片，不能渲染资源文件夹中的文件；完全按照官方说明配置\n后续准备使用图床, 选择了这个平台[mjj.today](https://mjj.today/)\n<!-- ![测试图片](post-img/img.jpg) -->\n\n\n<!-- {% asset_img 'https://images.pexels.com/photos/20440051/pexels-photo-20440051.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1' This is a test image %} -->\n\n![测试图床](https://images.pexels.com/photos/20440051/pexels-photo-20440051.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1)\n\n![ee074148edfc1f63b015446c40b02ef2.png](https://ice.frostsky.com/2024/03/09/ee074148edfc1f63b015446c40b02ef2.png)\n\n## 3. reference\n[reference 1](https://blog.csdn.net/2301_77285173/article/details/130189857)\n[reference 2](https://zhuanlan.zhihu.com/p/104996801)\n\n## 4. 测试嵌入视频\n这是直接使用b站视频分享中的嵌入代码，显示不友好\n```\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n```\n**效果**\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n\n**调整**\n```\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe>\n</div>\n```\n**调整效果**\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe>\n</div>\n\n","slug":"post-img","published":1,"updated":"2024-04-20T03:18:37.505Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodjl001b80rv2p1xb523","content":"<h2 id=\"1-配置修改\"><a href=\"#1-配置修改\" class=\"headerlink\" title=\"1. 配置修改\"></a>1. 配置修改</h2><p>修改项目中的<code>_config.yml</code>文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">post_asset_folder: true  # 配置为true\nmarked:                  # 新增\n  prependRoot: true\n  postAsset: true<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-测试\"><a href=\"#2-测试\" class=\"headerlink\" title=\"2. 测试\"></a>2. 测试</h2><p>奇怪，只能渲染网络链接的图片，不能渲染资源文件夹中的文件；完全按照官方说明配置<br>后续准备使用图床, 选择了这个平台<a href=\"https://mjj.today/\">mjj.today</a></p>\n<!-- ![测试图片](post-img/img.jpg) -->\n\n\n<!--  -->\n\n<p><img src=\"https://images.pexels.com/photos/20440051/pexels-photo-20440051.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1\" alt=\"测试图床\"></p>\n<p><img src=\"https://ice.frostsky.com/2024/03/09/ee074148edfc1f63b015446c40b02ef2.png\" alt=\"ee074148edfc1f63b015446c40b02ef2.png\"></p>\n<h2 id=\"3-reference\"><a href=\"#3-reference\" class=\"headerlink\" title=\"3. reference\"></a>3. reference</h2><p><a href=\"https://blog.csdn.net/2301_77285173/article/details/130189857\">reference 1</a><br><a href=\"https://zhuanlan.zhihu.com/p/104996801\">reference 2</a></p>\n<h2 id=\"4-测试嵌入视频\"><a href=\"#4-测试嵌入视频\" class=\"headerlink\" title=\"4. 测试嵌入视频\"></a>4. 测试嵌入视频</h2><p>这是直接使用b站视频分享中的嵌入代码，显示不友好</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;iframe src&#x3D;&quot;&#x2F;&#x2F;player.bilibili.com&#x2F;player.html?aid&#x3D;552069936&amp;bvid&#x3D;BV1Hi4y117BB&amp;cid&#x3D;542945776&amp;p&#x3D;5&quot; scrolling&#x3D;&quot;no&quot; border&#x3D;&quot;0&quot; frameborder&#x3D;&quot;no&quot; framespacing&#x3D;&quot;0&quot; allowfullscreen&#x3D;&quot;true&quot;&gt; &lt;&#x2F;iframe&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><strong>效果</strong></p>\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n\n<p><strong>调整</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;div style&#x3D;&quot;position: relative; width: 100%; height: 0; padding-bottom: 75%;&quot;&gt;\n&lt;iframe src&#x3D;&quot;&#x2F;&#x2F;player.bilibili.com&#x2F;player.html?aid&#x3D;552069936&amp;bvid&#x3D;BV1Hi4y117BB&amp;cid&#x3D;542945776&amp;p&#x3D;5&quot; scrolling&#x3D;&quot;yes&quot; border&#x3D;&quot;0&quot; \nframeborder&#x3D;&quot;no&quot; framespacing&#x3D;&quot;0&quot; allowfullscreen&#x3D;&quot;true&quot; style&#x3D;&quot;position: absolute; width: 100%; height: 100%; left: 0; top: 0;&quot;&gt;\n&lt;&#x2F;iframe&gt;\n&lt;&#x2F;div&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><strong>调整效果</strong></p>\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe>\n</div>\n\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"1-配置修改\"><a href=\"#1-配置修改\" class=\"headerlink\" title=\"1. 配置修改\"></a>1. 配置修改</h2><p>修改项目中的<code>_config.yml</code>文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">post_asset_folder: true  # 配置为true\nmarked:                  # 新增\n  prependRoot: true\n  postAsset: true<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-测试\"><a href=\"#2-测试\" class=\"headerlink\" title=\"2. 测试\"></a>2. 测试</h2><p>奇怪，只能渲染网络链接的图片，不能渲染资源文件夹中的文件；完全按照官方说明配置<br>后续准备使用图床, 选择了这个平台<a href=\"https://mjj.today/\">mjj.today</a></p>\n<!-- ![测试图片](post-img/img.jpg) -->\n\n\n<!--  -->\n\n<p><img src=\"https://images.pexels.com/photos/20440051/pexels-photo-20440051.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1\" alt=\"测试图床\"></p>\n<p><img src=\"https://ice.frostsky.com/2024/03/09/ee074148edfc1f63b015446c40b02ef2.png\" alt=\"ee074148edfc1f63b015446c40b02ef2.png\"></p>\n<h2 id=\"3-reference\"><a href=\"#3-reference\" class=\"headerlink\" title=\"3. reference\"></a>3. reference</h2><p><a href=\"https://blog.csdn.net/2301_77285173/article/details/130189857\">reference 1</a><br><a href=\"https://zhuanlan.zhihu.com/p/104996801\">reference 2</a></p>\n<h2 id=\"4-测试嵌入视频\"><a href=\"#4-测试嵌入视频\" class=\"headerlink\" title=\"4. 测试嵌入视频\"></a>4. 测试嵌入视频</h2><p>这是直接使用b站视频分享中的嵌入代码，显示不友好</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;iframe src&#x3D;&quot;&#x2F;&#x2F;player.bilibili.com&#x2F;player.html?aid&#x3D;552069936&amp;bvid&#x3D;BV1Hi4y117BB&amp;cid&#x3D;542945776&amp;p&#x3D;5&quot; scrolling&#x3D;&quot;no&quot; border&#x3D;&quot;0&quot; frameborder&#x3D;&quot;no&quot; framespacing&#x3D;&quot;0&quot; allowfullscreen&#x3D;&quot;true&quot;&gt; &lt;&#x2F;iframe&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><strong>效果</strong></p>\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n\n<p><strong>调整</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;div style&#x3D;&quot;position: relative; width: 100%; height: 0; padding-bottom: 75%;&quot;&gt;\n&lt;iframe src&#x3D;&quot;&#x2F;&#x2F;player.bilibili.com&#x2F;player.html?aid&#x3D;552069936&amp;bvid&#x3D;BV1Hi4y117BB&amp;cid&#x3D;542945776&amp;p&#x3D;5&quot; scrolling&#x3D;&quot;yes&quot; border&#x3D;&quot;0&quot; \nframeborder&#x3D;&quot;no&quot; framespacing&#x3D;&quot;0&quot; allowfullscreen&#x3D;&quot;true&quot; style&#x3D;&quot;position: absolute; width: 100%; height: 100%; left: 0; top: 0;&quot;&gt;\n&lt;&#x2F;iframe&gt;\n&lt;&#x2F;div&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><strong>调整效果</strong></p>\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe>\n</div>\n\n"},{"title":"在hexo中展示思维导图","date":"2024-03-09T10:18:59.000Z","toc":true,"summary":"在博文中插入思维导图","_content":"### 1. 项目来源[此处](https://github.com/maxchang3/hexo-markmap)\n### 2. 效果展示\n\n{% markmap 600 100% %}\n- links\n- **inline** ~~text~~ *styles*\n- multiline\n  text\n- `inline code`\n- ```js\n  console.log('code block');\n  console.log('code block');\n  ```\n- KaTeX - $x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}$\n{% endmarkmap %}\n\n\n### 3. xmind2md\n\n[作者指路](https://github.com/EXKulo/xmind_markdown_converter)\n使用此程序：`python xmind2md.py -source {xmind的文件路径} -output {markdown的输出路径}` \\\n第一次在win电脑准备python环境，解决了py、pip的环境变量之后，`pip install xmind ` 出现这个问题：`python 报错 Missing dependencies for SOCKS support` \\\n这是我为浏览器设置的代理，$ENV:all_proxy == socks5://127.0.0.1:1234;设置环境变量为空发现也不能解决问题。 \\\n实际原因是：Python 本身在没有安装 pysocks 时并不支持 socks5 代理 \\\npip 不能install ，所以安装了miniconda，然后`conda install pysocks`；之后可以正常使用pip install\n\n### 4. 转换失败\n\n可惜源 xmind 文件来自更高的 xmind 软件，保存后不能使用python 引入的 xmind 包打开文件，所以没能成功转换为 md 文件；而他本身导出需要会员才能进行md保存。\n\n### 5. 破解版 xmind 测试\n\n导出成功，但是格式不能在此成功渲染出来\n","source":"_posts/在hexo中展示思维导图.md","raw":"---\ntitle: 在hexo中展示思维导图\ndate: 2024-03-09 18:18:59\ntags: hexo\ntoc: true\nsummary: 在博文中插入思维导图\n---\n### 1. 项目来源[此处](https://github.com/maxchang3/hexo-markmap)\n### 2. 效果展示\n\n{% markmap 600 100% %}\n- links\n- **inline** ~~text~~ *styles*\n- multiline\n  text\n- `inline code`\n- ```js\n  console.log('code block');\n  console.log('code block');\n  ```\n- KaTeX - $x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}$\n{% endmarkmap %}\n\n\n### 3. xmind2md\n\n[作者指路](https://github.com/EXKulo/xmind_markdown_converter)\n使用此程序：`python xmind2md.py -source {xmind的文件路径} -output {markdown的输出路径}` \\\n第一次在win电脑准备python环境，解决了py、pip的环境变量之后，`pip install xmind ` 出现这个问题：`python 报错 Missing dependencies for SOCKS support` \\\n这是我为浏览器设置的代理，$ENV:all_proxy == socks5://127.0.0.1:1234;设置环境变量为空发现也不能解决问题。 \\\n实际原因是：Python 本身在没有安装 pysocks 时并不支持 socks5 代理 \\\npip 不能install ，所以安装了miniconda，然后`conda install pysocks`；之后可以正常使用pip install\n\n### 4. 转换失败\n\n可惜源 xmind 文件来自更高的 xmind 软件，保存后不能使用python 引入的 xmind 包打开文件，所以没能成功转换为 md 文件；而他本身导出需要会员才能进行md保存。\n\n### 5. 破解版 xmind 测试\n\n导出成功，但是格式不能在此成功渲染出来\n","slug":"在hexo中展示思维导图","published":1,"updated":"2024-04-20T03:18:37.505Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodjo001e80rvg0ot62ue","content":"<h3 id=\"1-项目来源此处\"><a href=\"#1-项目来源此处\" class=\"headerlink\" title=\"1. 项目来源此处\"></a>1. 项目来源<a href=\"https://github.com/maxchang3/hexo-markmap\">此处</a></h3><h3 id=\"2-效果展示\"><a href=\"#2-效果展示\" class=\"headerlink\" title=\"2. 效果展示\"></a>2. 效果展示</h3>\n<div class=\"markmap-container\" style=\"height:600\">\n  <svg data=\"{&quot;t&quot;:&quot;root&quot;,&quot;d&quot;:0,&quot;v&quot;:&quot;&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[0,1]},&quot;v&quot;:&quot;links&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;&lt;strong&gt;inline&lt;/strong&gt; &lt;del&gt;text&lt;/del&gt; &lt;em&gt;styles&lt;/em&gt;&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[2,4]},&quot;v&quot;:&quot;multiline&lt;br&gt;\\ntext&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;&lt;code&gt;inline code&lt;/code&gt;&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[5,9]},&quot;v&quot;:&quot;&lt;pre class=\\&quot;language-js\\&quot;&gt;&lt;code class=\\&quot;language-js\\&quot;&gt;console&lt;span class=\\&quot;token punctuation\\&quot;&gt;.&lt;/span&gt;&lt;span class=\\&quot;token function\\&quot;&gt;log&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;(&lt;/span&gt;&lt;span class=\\&quot;token string\\&quot;&gt;&#39;code block&#39;&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;)&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;;&lt;/span&gt;\\nconsole&lt;span class=\\&quot;token punctuation\\&quot;&gt;.&lt;/span&gt;&lt;span class=\\&quot;token function\\&quot;&gt;log&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;(&lt;/span&gt;&lt;span class=\\&quot;token string\\&quot;&gt;&#39;code block&#39;&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;)&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;;&lt;/span&gt;\\n&lt;/code&gt;&lt;/pre&gt;\\n&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[9,10]},&quot;v&quot;:&quot;KaTeX - &lt;span class=\\&quot;katex\\&quot;&gt;&lt;span class=\\&quot;katex-mathml\\&quot;&gt;&lt;math xmlns=\\&quot;http://www.w3.org/1998/Math/MathML\\&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mo&gt;±&lt;/mo&gt;&lt;msqrt&gt;&lt;mrow&gt;&lt;msup&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mn&gt;4&lt;/mn&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/msqrt&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/mrow&gt;&lt;annotation encoding=\\&quot;application/x-tex\\&quot;&gt;x = {-b \\\\pm \\\\sqrt{b^2-4ac} \\\\over 2a}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=\\&quot;katex-html\\&quot; aria-hidden=\\&quot;true\\&quot;&gt;&lt;span class=\\&quot;base\\&quot;&gt;&lt;span class=\\&quot;strut\\&quot; style=\\&quot;height:0.43056em;vertical-align:0em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal\\&quot;&gt;x&lt;/span&gt;&lt;span class=\\&quot;mspace\\&quot; style=\\&quot;margin-right:0.2777777777777778em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mrel\\&quot;&gt;=&lt;/span&gt;&lt;span class=\\&quot;mspace\\&quot; style=\\&quot;margin-right:0.2777777777777778em;\\&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;base\\&quot;&gt;&lt;span class=\\&quot;strut\\&quot; style=\\&quot;height:1.384482em;vertical-align:-0.345em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mord\\&quot;&gt;&lt;span class=\\&quot;mord\\&quot;&gt;&lt;span class=\\&quot;mopen nulldelimiter\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mfrac\\&quot;&gt;&lt;span class=\\&quot;vlist-t vlist-t2\\&quot;&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:1.039482em;\\&quot;&gt;&lt;span style=\\&quot;top:-2.6550000000000002em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;sizing reset-size6 size3 mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;2&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;a&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\\&quot;top:-3.23em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;frac-line\\&quot; style=\\&quot;border-bottom-width:0.04em;\\&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\\&quot;top:-3.3939999999999997em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;sizing reset-size6 size3 mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;−&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;b&lt;/span&gt;&lt;span class=\\&quot;mbin mtight\\&quot;&gt;±&lt;/span&gt;&lt;span class=\\&quot;mord sqrt mtight\\&quot;&gt;&lt;span class=\\&quot;vlist-t vlist-t2\\&quot;&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:0.9221171428571429em;\\&quot;&gt;&lt;span class=\\&quot;svg-align\\&quot; style=\\&quot;top:-3em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mord mtight\\&quot; style=\\&quot;padding-left:0.833em;\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;b&lt;/span&gt;&lt;span class=\\&quot;msupsub\\&quot;&gt;&lt;span class=\\&quot;vlist-t\\&quot;&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:0.7463142857142857em;\\&quot;&gt;&lt;span style=\\&quot;top:-2.786em;margin-right:0.07142857142857144em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:2.5em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;sizing reset-size3 size1 mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;mbin mtight\\&quot;&gt;−&lt;/span&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;4&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;a&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;c&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\\&quot;top:-2.882117142857143em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;hide-tail mtight\\&quot; style=\\&quot;min-width:0.853em;height:1.08em;\\&quot;&gt;&lt;svg width=&#39;400em&#39; height=&#39;1.08em&#39; viewBox=&#39;0 0 400000 1080&#39; preserveAspectRatio=&#39;xMinYMin slice&#39;&gt;&lt;path d=&#39;M95,702\\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\\nc69,-144,104.5,-217.7,106.5,-221\\nl0 -0\\nc5.3,-9.3,12,-14,20,-14\\nH400000v40H845.2724\\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\\nM834 80h400000v40h-400000z&#39;/&gt;&lt;/svg&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;vlist-s\\&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:0.11788285714285718em;\\&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;vlist-s\\&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:0.345em;\\&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;mclose nulldelimiter\\&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&quot;}],&quot;p&quot;:{}}\"></svg>\n</div>\n\n\n\n<h3 id=\"3-xmind2md\"><a href=\"#3-xmind2md\" class=\"headerlink\" title=\"3. xmind2md\"></a>3. xmind2md</h3><p><a href=\"https://github.com/EXKulo/xmind_markdown_converter\">作者指路</a><br>使用此程序：<code>python xmind2md.py -source &#123;xmind的文件路径&#125; -output &#123;markdown的输出路径&#125;</code> <br>第一次在win电脑准备python环境，解决了py、pip的环境变量之后，<code>pip install xmind </code> 出现这个问题：<code>python 报错 Missing dependencies for SOCKS support</code> <br>这是我为浏览器设置的代理，$ENV:all_proxy &#x3D;&#x3D; socks5:&#x2F;&#x2F;127.0.0.1:1234;设置环境变量为空发现也不能解决问题。 <br>实际原因是：Python 本身在没有安装 pysocks 时并不支持 socks5 代理 <br>pip 不能install ，所以安装了miniconda，然后<code>conda install pysocks</code>；之后可以正常使用pip install</p>\n<h3 id=\"4-转换失败\"><a href=\"#4-转换失败\" class=\"headerlink\" title=\"4. 转换失败\"></a>4. 转换失败</h3><p>可惜源 xmind 文件来自更高的 xmind 软件，保存后不能使用python 引入的 xmind 包打开文件，所以没能成功转换为 md 文件；而他本身导出需要会员才能进行md保存。</p>\n<h3 id=\"5-破解版-xmind-测试\"><a href=\"#5-破解版-xmind-测试\" class=\"headerlink\" title=\"5. 破解版 xmind 测试\"></a>5. 破解版 xmind 测试</h3><p>导出成功，但是格式不能在此成功渲染出来</p>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h3 id=\"1-项目来源此处\"><a href=\"#1-项目来源此处\" class=\"headerlink\" title=\"1. 项目来源此处\"></a>1. 项目来源<a href=\"https://github.com/maxchang3/hexo-markmap\">此处</a></h3><h3 id=\"2-效果展示\"><a href=\"#2-效果展示\" class=\"headerlink\" title=\"2. 效果展示\"></a>2. 效果展示</h3>\n<div class=\"markmap-container\" style=\"height:600\">\n  <svg data=\"{&quot;t&quot;:&quot;root&quot;,&quot;d&quot;:0,&quot;v&quot;:&quot;&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[0,1]},&quot;v&quot;:&quot;links&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;&lt;strong&gt;inline&lt;/strong&gt; &lt;del&gt;text&lt;/del&gt; &lt;em&gt;styles&lt;/em&gt;&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[2,4]},&quot;v&quot;:&quot;multiline&lt;br&gt;\\ntext&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;&lt;code&gt;inline code&lt;/code&gt;&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[5,9]},&quot;v&quot;:&quot;&lt;pre class=\\&quot;language-js\\&quot;&gt;&lt;code class=\\&quot;language-js\\&quot;&gt;console&lt;span class=\\&quot;token punctuation\\&quot;&gt;.&lt;/span&gt;&lt;span class=\\&quot;token function\\&quot;&gt;log&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;(&lt;/span&gt;&lt;span class=\\&quot;token string\\&quot;&gt;&#39;code block&#39;&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;)&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;;&lt;/span&gt;\\nconsole&lt;span class=\\&quot;token punctuation\\&quot;&gt;.&lt;/span&gt;&lt;span class=\\&quot;token function\\&quot;&gt;log&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;(&lt;/span&gt;&lt;span class=\\&quot;token string\\&quot;&gt;&#39;code block&#39;&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;)&lt;/span&gt;&lt;span class=\\&quot;token punctuation\\&quot;&gt;;&lt;/span&gt;\\n&lt;/code&gt;&lt;/pre&gt;\\n&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[9,10]},&quot;v&quot;:&quot;KaTeX - &lt;span class=\\&quot;katex\\&quot;&gt;&lt;span class=\\&quot;katex-mathml\\&quot;&gt;&lt;math xmlns=\\&quot;http://www.w3.org/1998/Math/MathML\\&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mo&gt;±&lt;/mo&gt;&lt;msqrt&gt;&lt;mrow&gt;&lt;msup&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mn&gt;4&lt;/mn&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/msqrt&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/mrow&gt;&lt;annotation encoding=\\&quot;application/x-tex\\&quot;&gt;x = {-b \\\\pm \\\\sqrt{b^2-4ac} \\\\over 2a}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=\\&quot;katex-html\\&quot; aria-hidden=\\&quot;true\\&quot;&gt;&lt;span class=\\&quot;base\\&quot;&gt;&lt;span class=\\&quot;strut\\&quot; style=\\&quot;height:0.43056em;vertical-align:0em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal\\&quot;&gt;x&lt;/span&gt;&lt;span class=\\&quot;mspace\\&quot; style=\\&quot;margin-right:0.2777777777777778em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mrel\\&quot;&gt;=&lt;/span&gt;&lt;span class=\\&quot;mspace\\&quot; style=\\&quot;margin-right:0.2777777777777778em;\\&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;base\\&quot;&gt;&lt;span class=\\&quot;strut\\&quot; style=\\&quot;height:1.384482em;vertical-align:-0.345em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mord\\&quot;&gt;&lt;span class=\\&quot;mord\\&quot;&gt;&lt;span class=\\&quot;mopen nulldelimiter\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mfrac\\&quot;&gt;&lt;span class=\\&quot;vlist-t vlist-t2\\&quot;&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:1.039482em;\\&quot;&gt;&lt;span style=\\&quot;top:-2.6550000000000002em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;sizing reset-size6 size3 mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;2&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;a&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\\&quot;top:-3.23em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;frac-line\\&quot; style=\\&quot;border-bottom-width:0.04em;\\&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\\&quot;top:-3.3939999999999997em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;sizing reset-size6 size3 mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;−&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;b&lt;/span&gt;&lt;span class=\\&quot;mbin mtight\\&quot;&gt;±&lt;/span&gt;&lt;span class=\\&quot;mord sqrt mtight\\&quot;&gt;&lt;span class=\\&quot;vlist-t vlist-t2\\&quot;&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:0.9221171428571429em;\\&quot;&gt;&lt;span class=\\&quot;svg-align\\&quot; style=\\&quot;top:-3em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;mord mtight\\&quot; style=\\&quot;padding-left:0.833em;\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;b&lt;/span&gt;&lt;span class=\\&quot;msupsub\\&quot;&gt;&lt;span class=\\&quot;vlist-t\\&quot;&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:0.7463142857142857em;\\&quot;&gt;&lt;span style=\\&quot;top:-2.786em;margin-right:0.07142857142857144em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:2.5em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;sizing reset-size3 size1 mtight\\&quot;&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;mbin mtight\\&quot;&gt;−&lt;/span&gt;&lt;span class=\\&quot;mord mtight\\&quot;&gt;4&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;a&lt;/span&gt;&lt;span class=\\&quot;mord mathnormal mtight\\&quot;&gt;c&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\\&quot;top:-2.882117142857143em;\\&quot;&gt;&lt;span class=\\&quot;pstrut\\&quot; style=\\&quot;height:3em;\\&quot;&gt;&lt;/span&gt;&lt;span class=\\&quot;hide-tail mtight\\&quot; style=\\&quot;min-width:0.853em;height:1.08em;\\&quot;&gt;&lt;svg width=&#39;400em&#39; height=&#39;1.08em&#39; viewBox=&#39;0 0 400000 1080&#39; preserveAspectRatio=&#39;xMinYMin slice&#39;&gt;&lt;path d=&#39;M95,702\\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\\nc69,-144,104.5,-217.7,106.5,-221\\nl0 -0\\nc5.3,-9.3,12,-14,20,-14\\nH400000v40H845.2724\\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\\nM834 80h400000v40h-400000z&#39;/&gt;&lt;/svg&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;vlist-s\\&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:0.11788285714285718em;\\&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;vlist-s\\&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;vlist-r\\&quot;&gt;&lt;span class=\\&quot;vlist\\&quot; style=\\&quot;height:0.345em;\\&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\\&quot;mclose nulldelimiter\\&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&quot;}],&quot;p&quot;:{}}\"></svg>\n</div>\n\n\n\n<h3 id=\"3-xmind2md\"><a href=\"#3-xmind2md\" class=\"headerlink\" title=\"3. xmind2md\"></a>3. xmind2md</h3><p><a href=\"https://github.com/EXKulo/xmind_markdown_converter\">作者指路</a><br>使用此程序：<code>python xmind2md.py -source &#123;xmind的文件路径&#125; -output &#123;markdown的输出路径&#125;</code> <br>第一次在win电脑准备python环境，解决了py、pip的环境变量之后，<code>pip install xmind </code> 出现这个问题：<code>python 报错 Missing dependencies for SOCKS support</code> <br>这是我为浏览器设置的代理，$ENV:all_proxy &#x3D;&#x3D; socks5:&#x2F;&#x2F;127.0.0.1:1234;设置环境变量为空发现也不能解决问题。 <br>实际原因是：Python 本身在没有安装 pysocks 时并不支持 socks5 代理 <br>pip 不能install ，所以安装了miniconda，然后<code>conda install pysocks</code>；之后可以正常使用pip install</p>\n<h3 id=\"4-转换失败\"><a href=\"#4-转换失败\" class=\"headerlink\" title=\"4. 转换失败\"></a>4. 转换失败</h3><p>可惜源 xmind 文件来自更高的 xmind 软件，保存后不能使用python 引入的 xmind 包打开文件，所以没能成功转换为 md 文件；而他本身导出需要会员才能进行md保存。</p>\n<h3 id=\"5-破解版-xmind-测试\"><a href=\"#5-破解版-xmind-测试\" class=\"headerlink\" title=\"5. 破解版 xmind 测试\"></a>5. 破解版 xmind 测试</h3><p>导出成功，但是格式不能在此成功渲染出来</p>\n"},{"title":"这是一封信","date":"2023-10-18T12:20:39.000Z","summary":"嗨，终于等到你啦！","password":"e8f299ee24a7efd92a907d1d6dfa8d9deb8ce74ae0aa544fd0486627247ee875","_content":"\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"https://player.bilibili.com/player.html?/BV1zw4m1y73U/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=154006e70f5c14d792db947270b63614\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe></div>\n\n- 邹漂亮，龙美丽好想你呀。\n\n- 此后的你，便是我生命中的一系列的数字了。  \n\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"https://player.bilibili.com/player.html?/BV16p421y75B/?spm_id_from=333.1007.0.0&vd_source=154006e70f5c14d792db947270b63614\" scrolling=\"yes\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe></div>","source":"_posts/这是一封信.md","raw":"---\ntitle: 这是一封信\ndate: 2023-10-18 20:20:39\n# top: true\n# cover: true\ntags:\n  - Personal\ncategories:\n  - Personal\nsummary: 嗨，终于等到你啦！\npassword: 'e8f299ee24a7efd92a907d1d6dfa8d9deb8ce74ae0aa544fd0486627247ee875'\n#不知道有没进来看见源码的，看见这个就当个笑话吧，别当真。have a nice day！\n---\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"https://player.bilibili.com/player.html?/BV1zw4m1y73U/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=154006e70f5c14d792db947270b63614\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe></div>\n\n- 邹漂亮，龙美丽好想你呀。\n\n- 此后的你，便是我生命中的一系列的数字了。  \n\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"https://player.bilibili.com/player.html?/BV16p421y75B/?spm_id_from=333.1007.0.0&vd_source=154006e70f5c14d792db947270b63614\" scrolling=\"yes\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe></div>","slug":"这是一封信","published":1,"updated":"2024-05-04T03:56:46.552Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodjs001h80rvbq97b85r","content":"<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"https://player.bilibili.com/player.html?/BV1zw4m1y73U/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=154006e70f5c14d792db947270b63614\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe></div>\n\n<ul>\n<li><p>邹漂亮，龙美丽好想你呀。</p>\n</li>\n<li><p>此后的你，便是我生命中的一系列的数字了。</p>\n</li>\n</ul>\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"https://player.bilibili.com/player.html?/BV16p421y75B/?spm_id_from=333.1007.0.0&vd_source=154006e70f5c14d792db947270b63614\" scrolling=\"yes\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe></div>","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"https://player.bilibili.com/player.html?/BV1zw4m1y73U/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=154006e70f5c14d792db947270b63614\" scrolling=\"yes\" border=\"0\" \nframeborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe></div>\n\n<ul>\n<li><p>邹漂亮，龙美丽好想你呀。</p>\n</li>\n<li><p>此后的你，便是我生命中的一系列的数字了。</p>\n</li>\n</ul>\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n<iframe src=\"https://player.bilibili.com/player.html?/BV16p421y75B/?spm_id_from=333.1007.0.0&vd_source=154006e70f5c14d792db947270b63614\" scrolling=\"yes\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n</iframe></div>"},{"title":"bind-exporter","author":"LC","toc":true,"date":"2024-04-30T15:20:00.000Z","img":null,"top":null,"cover":null,"password":null,"summary":"bind9 DNS 指标导出","_content":"\n## 1. 安装\nbind9 服务器本机，下载二进制包，并移动到 `/usr/local/bin`\n```bash\ncurl -s https://api.github.com/repos/prometheus-community/bind_exporter/releases/latest | grep browser_download_url | grep linux-amd64 |  cut -d '\"' -f 4 | wget -qi -\ntar xvf bind_exporter*.tar.gz\nsudo mv bind_exporter-*/bind_exporter /usr/local/bin\n```\nbind9 开启指标暴露接口\n```bash\nsudo tee -a /etc/bind/named.conf.options<<EOF\nstatistics-channels {\n  inet 127.0.0.1 port 8053 allow { 127.0.0.1; };\n};\nEOF\n```\n\n## 2. Systemd 服务单元文件\n需要是运行在 dns local\n```bash\nsudo tee /etc/systemd/system/bind_exporter.service<<EOF\n[Unit]\nDescription=Prometheus\nDocumentation=https://github.com/digitalocean/bind_exporter\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=simple\nExecReload=/bin/kill -HUP \\$MAINPID\nExecStart=/usr/local/bin/bind_exporter \\\n  --bind.pid-file=/run/named/named.pid \\\n  --bind.timeout=20s \\\n  --web.listen-address=0.0.0.0:9153 \\\n  --web.telemetry-path=/metrics \\\n  --bind.stats-url=http://127.0.0.1:8053/ \\\n  --bind.stats-groups=server,view,tasks\n\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n## 3. service up\n```bash\nsudo systemctl daemon-reload\nsudo systemctl restart bind_exporter.service\nsudo systemctl enable --now bind_exporter\n```\n## 4. 问题\n指标数量少于官方指标，排查发现：url 指定错误的原因\n\n## 5. prometheus.yml\n需要对主从分别进行配置\n```\n  - job_name: 'DNS'\n    static_configs:\n      - targets: ['10.1.0.81:9153']\n        labels:\n          alias: dns-master\n      - targets: ['10.1.0.82:9153']\n        labels:\n          alias: dns-slave\n```\n","source":"_posts/metrics/bind-exporter.md","raw":"---\ntitle: bind-exporter\nauthor: LC\ntoc: true\ndate: 2024-04-30 23:20:00\nimg:\ntop:\ncover:\npassword:\nsummary: bind9 DNS 指标导出\ncategories: Opentelemetry\ntags: [metrics]\n---\n\n## 1. 安装\nbind9 服务器本机，下载二进制包，并移动到 `/usr/local/bin`\n```bash\ncurl -s https://api.github.com/repos/prometheus-community/bind_exporter/releases/latest | grep browser_download_url | grep linux-amd64 |  cut -d '\"' -f 4 | wget -qi -\ntar xvf bind_exporter*.tar.gz\nsudo mv bind_exporter-*/bind_exporter /usr/local/bin\n```\nbind9 开启指标暴露接口\n```bash\nsudo tee -a /etc/bind/named.conf.options<<EOF\nstatistics-channels {\n  inet 127.0.0.1 port 8053 allow { 127.0.0.1; };\n};\nEOF\n```\n\n## 2. Systemd 服务单元文件\n需要是运行在 dns local\n```bash\nsudo tee /etc/systemd/system/bind_exporter.service<<EOF\n[Unit]\nDescription=Prometheus\nDocumentation=https://github.com/digitalocean/bind_exporter\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=simple\nExecReload=/bin/kill -HUP \\$MAINPID\nExecStart=/usr/local/bin/bind_exporter \\\n  --bind.pid-file=/run/named/named.pid \\\n  --bind.timeout=20s \\\n  --web.listen-address=0.0.0.0:9153 \\\n  --web.telemetry-path=/metrics \\\n  --bind.stats-url=http://127.0.0.1:8053/ \\\n  --bind.stats-groups=server,view,tasks\n\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n## 3. service up\n```bash\nsudo systemctl daemon-reload\nsudo systemctl restart bind_exporter.service\nsudo systemctl enable --now bind_exporter\n```\n## 4. 问题\n指标数量少于官方指标，排查发现：url 指定错误的原因\n\n## 5. prometheus.yml\n需要对主从分别进行配置\n```\n  - job_name: 'DNS'\n    static_configs:\n      - targets: ['10.1.0.81:9153']\n        labels:\n          alias: dns-master\n      - targets: ['10.1.0.82:9153']\n        labels:\n          alias: dns-slave\n```\n","slug":"metrics/bind-exporter","published":1,"updated":"2024-04-30T16:21:31.448Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodjv001j80rv8bkj5s8a","content":"<h2 id=\"1-安装\"><a href=\"#1-安装\" class=\"headerlink\" title=\"1. 安装\"></a>1. 安装</h2><p>bind9 服务器本机，下载二进制包，并移动到 <code>/usr/local/bin</code></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> https://api.github.com/repos/prometheus-community/bind_exporter/releases/latest <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> browser_download_url <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> linux-amd64 <span class=\"token operator\">|</span>  <span class=\"token function\">cut</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'\"'</span> <span class=\"token parameter variable\">-f</span> <span class=\"token number\">4</span> <span class=\"token operator\">|</span> <span class=\"token function\">wget</span> <span class=\"token parameter variable\">-qi</span> -\n<span class=\"token function\">tar</span> xvf bind_exporter*.tar.gz\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> bind_exporter-*/bind_exporter /usr/local/bin<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>bind9 开启指标暴露接口</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> /etc/bind/named.conf.options<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\nstatistics-channels &#123;\n  inet 127.0.0.1 port 8053 allow &#123; 127.0.0.1; &#125;;\n&#125;;\nEOF</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-Systemd-服务单元文件\"><a href=\"#2-Systemd-服务单元文件\" class=\"headerlink\" title=\"2. Systemd 服务单元文件\"></a>2. Systemd 服务单元文件</h2><p>需要是运行在 dns local</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/systemd/system/bind_exporter.service<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\n[Unit]\nDescription=Prometheus\nDocumentation=https://github.com/digitalocean/bind_exporter\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=simple\nExecReload=/bin/kill -HUP \\<span class=\"token variable\">$MAINPID</span>\nExecStart=/usr/local/bin/bind_exporter \\\n  --bind.pid-file=/run/named/named.pid \\\n  --bind.timeout=20s \\\n  --web.listen-address=0.0.0.0:9153 \\\n  --web.telemetry-path=/metrics \\\n  --bind.stats-url=http://127.0.0.1:8053/ \\\n  --bind.stats-groups=server,view,tasks\n\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"3-service-up\"><a href=\"#3-service-up\" class=\"headerlink\" title=\"3. service up\"></a>3. service up</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl daemon-reload\n<span class=\"token function\">sudo</span> systemctl restart bind_exporter.service\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> bind_exporter<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"4-问题\"><a href=\"#4-问题\" class=\"headerlink\" title=\"4. 问题\"></a>4. 问题</h2><p>指标数量少于官方指标，排查发现：url 指定错误的原因</p>\n<h2 id=\"5-prometheus-yml\"><a href=\"#5-prometheus-yml\" class=\"headerlink\" title=\"5. prometheus.yml\"></a>5. prometheus.yml</h2><p>需要对主从分别进行配置</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: &#39;DNS&#39;\n  static_configs:\n    - targets: [&#39;10.1.0.81:9153&#39;]\n      labels:\n        alias: dns-master\n    - targets: [&#39;10.1.0.82:9153&#39;]\n      labels:\n        alias: dns-slave<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"1-安装\"><a href=\"#1-安装\" class=\"headerlink\" title=\"1. 安装\"></a>1. 安装</h2><p>bind9 服务器本机，下载二进制包，并移动到 <code>/usr/local/bin</code></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> https://api.github.com/repos/prometheus-community/bind_exporter/releases/latest <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> browser_download_url <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> linux-amd64 <span class=\"token operator\">|</span>  <span class=\"token function\">cut</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'\"'</span> <span class=\"token parameter variable\">-f</span> <span class=\"token number\">4</span> <span class=\"token operator\">|</span> <span class=\"token function\">wget</span> <span class=\"token parameter variable\">-qi</span> -\n<span class=\"token function\">tar</span> xvf bind_exporter*.tar.gz\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> bind_exporter-*/bind_exporter /usr/local/bin<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>bind9 开启指标暴露接口</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> /etc/bind/named.conf.options<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\nstatistics-channels &#123;\n  inet 127.0.0.1 port 8053 allow &#123; 127.0.0.1; &#125;;\n&#125;;\nEOF</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-Systemd-服务单元文件\"><a href=\"#2-Systemd-服务单元文件\" class=\"headerlink\" title=\"2. Systemd 服务单元文件\"></a>2. Systemd 服务单元文件</h2><p>需要是运行在 dns local</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/systemd/system/bind_exporter.service<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\n[Unit]\nDescription=Prometheus\nDocumentation=https://github.com/digitalocean/bind_exporter\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=simple\nExecReload=/bin/kill -HUP \\<span class=\"token variable\">$MAINPID</span>\nExecStart=/usr/local/bin/bind_exporter \\\n  --bind.pid-file=/run/named/named.pid \\\n  --bind.timeout=20s \\\n  --web.listen-address=0.0.0.0:9153 \\\n  --web.telemetry-path=/metrics \\\n  --bind.stats-url=http://127.0.0.1:8053/ \\\n  --bind.stats-groups=server,view,tasks\n\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"3-service-up\"><a href=\"#3-service-up\" class=\"headerlink\" title=\"3. service up\"></a>3. service up</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl daemon-reload\n<span class=\"token function\">sudo</span> systemctl restart bind_exporter.service\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> bind_exporter<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"4-问题\"><a href=\"#4-问题\" class=\"headerlink\" title=\"4. 问题\"></a>4. 问题</h2><p>指标数量少于官方指标，排查发现：url 指定错误的原因</p>\n<h2 id=\"5-prometheus-yml\"><a href=\"#5-prometheus-yml\" class=\"headerlink\" title=\"5. prometheus.yml\"></a>5. prometheus.yml</h2><p>需要对主从分别进行配置</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: &#39;DNS&#39;\n  static_configs:\n    - targets: [&#39;10.1.0.81:9153&#39;]\n      labels:\n        alias: dns-master\n    - targets: [&#39;10.1.0.82:9153&#39;]\n      labels:\n        alias: dns-slave<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n"},{"title":"kafka-exporter","author":"LC","toc":true,"date":"2024-04-30T15:20:00.000Z","img":null,"top":null,"cover":null,"password":null,"summary":"kafka 指标导出","_content":"\n并没有找到官方比较权威的指标获取工具，来自社区的应用各有所长，使用以下工具，各取其长\n## 1. kafka_exporter\n下载并执行，获取指标太少，弃用\n   \n```\nnohup kafka_exporter --kafka.server=10.8.0.88:9092 &\n```\n\n## 2. [jmx_exporter]( https://github.com/prometheus/jmx_exporter )\n### 下载 java-agent, 需要在每个节点配置\n```\nwget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.20.0/jmx_prometheus_javaagent-0.20.0.jar\n```\n### 运行方式\n#### Running the Standalone HTTP Server（未使用）\n#### Running the Java Agent（推荐使用）\n在 `kafka-server-start.sh` 头部增加代码声明，agent将和服务共同启动\n```\nexport KAFKA_JMX_OPTS=\"-javaagent:/usr/local/kafka/bin/jmx_prometheus_javaagent-0.20.0.jar=9990:/usr/local/kafka/config/kafka-jmx.yml\"\n```\n\n各节点 kafka 已经由 systemd 管理，此处执行 systemctl restart kafka 即可\n#### [此处是官方的jmx_exporter使用的 javaagents 配置文件模板](https://github.com/prometheus/jmx_exporter/blob/main/example_configs/kafka-kraft-3_0_0.yml) kafka-jmx.yml\n```yaml\nlowercaseOutputName: true\n\nrules:\n# Special cases and very specific rules\n- pattern : kafka.server<type=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)><>Value\n  name: kafka_server_$1_$2\n  type: GAUGE\n  labels:\n    clientId: \"$3\"\n    topic: \"$4\"\n    partition: \"$5\"\n- pattern : kafka.server<type=(.+), name=(.+), clientId=(.+), brokerHost=(.+), brokerPort=(.+)><>Value\n  name: kafka_server_$1_$2\n  type: GAUGE\n  labels:\n    clientId: \"$3\"\n    broker: \"$4:$5\"\n- pattern : kafka.coordinator.(\\w+)<type=(.+), name=(.+)><>Value\n  name: kafka_coordinator_$1_$2_$3\n  type: GAUGE\n# Kraft current state info metric rule\n- pattern: \"kafka.server<type=raft-metrics><>current-state: ([a-z]+)\"\n  name: kafka_server_raft_metrics_current_state_info\n  type: GAUGE\n  value: 1\n  labels:\n    \"state\": \"$1\"\n# Kraft specific rules for raft-metrics, raft-channel-metrics, broker-metadata-metrics\n- pattern: kafka.server<type=(.+)><>([a-z-]+)-total\n  name: kafka_server_$1_$2_total\n  type: COUNTER\n- pattern: kafka.server<type=(.+)><>([a-z-]+)\n  name: kafka_server_$1_$2\n  type: GAUGE\n\n# Generic per-second counters with 0-2 key/value pairs\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)PerSec\\w*, (.+)=(.+), (.+)=(.+)><>Count\n  name: kafka_$1_$2_$3_total\n  type: COUNTER\n  labels:\n    \"$4\": \"$5\"\n    \"$6\": \"$7\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)PerSec\\w*, (.+)=(.+)><>Count\n  name: kafka_$1_$2_$3_total\n  type: COUNTER\n  labels:\n    \"$4\": \"$5\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)PerSec\\w*><>Count\n  name: kafka_$1_$2_$3_total\n  type: COUNTER\n\n# Quota specific rules\n- pattern: kafka.server<type=(.+), user=(.+), client-id=(.+)><>([a-z-]+)\n  name: kafka_server_quota_$4\n  type: GAUGE\n  labels:\n    resource: \"$1\"\n    user: \"$2\"\n    clientId: \"$3\"\n- pattern: kafka.server<type=(.+), client-id=(.+)><>([a-z-]+)\n  name: kafka_server_quota_$3\n  type: GAUGE\n  labels:\n    resource: \"$1\"\n    clientId: \"$2\"\n- pattern: kafka.server<type=(.+), user=(.+)><>([a-z-]+)\n  name: kafka_server_quota_$3\n  type: GAUGE\n  labels:\n    resource: \"$1\"\n    user: \"$2\"\n\n# Generic gauges with 0-2 key/value pairs\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.+), (.+)=(.+)><>Value\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n    \"$6\": \"$7\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.+)><>Value\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)><>Value\n  name: kafka_$1_$2_$3\n  type: GAUGE\n\n# Emulate Prometheus 'Summary' metrics for the exported 'Histogram's.\n#\n# Note that these are missing the '_sum' metric!\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.+), (.+)=(.+)><>Count\n  name: kafka_$1_$2_$3_count\n  type: COUNTER\n  labels:\n    \"$4\": \"$5\"\n    \"$6\": \"$7\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.*), (.+)=(.+)><>(\\d+)thPercentile\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n    \"$6\": \"$7\"\n    quantile: \"0.$8\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.+)><>Count\n  name: kafka_$1_$2_$3_count\n  type: COUNTER\n  labels:\n    \"$4\": \"$5\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.*)><>(\\d+)thPercentile\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n    quantile: \"0.$6\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)><>Count\n  name: kafka_$1_$2_$3_count\n  type: COUNTER\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)><>(\\d+)thPercentile\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    quantile: \"0.$4\"\n\n# Generic gauges for MeanRate Percent\n# Ex) kafka.server<type=KafkaRequestHandlerPool, name=RequestHandlerAvgIdlePercent><>MeanRate\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)Percent\\w*><>MeanRate\n  name: kafka_$1_$2_$3_percent\n  type: GAUGE\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)Percent\\w*><>Value\n  name: kafka_$1_$2_$3_percent\n  type: GAUGE\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)Percent\\w*, (.+)=(.+)><>Value\n  name: kafka_$1_$2_$3_percent\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n```\n\n#### prometheus.yml\n```\n- job_name: \"kafka_jmx\"\n    metrics_path: /metrics\n    static_configs:\n      - targets: ['192.168.249.1:9990','192.168.249.2:9990','192.168.249.3:9990']\n```\n\n## 3. Kiminon 使用\n#### 可以二进制、docker、 helm 部署 kiminon; 可以监控多源; 运行后访问 IP:port/metrics\n\nCluster Dashboard: [https://grafana.com/grafana/dashboards/14012](https://grafana.com/grafana/dashboards/14012)\nConsumer Group Dashboard: [https://grafana.com/grafana/dashboards/14014](https://grafana.com/grafana/dashboards/14014)\nTopic Dashboard: [https://grafana.com/grafana/dashboards/14013](https://grafana.com/grafana/dashboards/14013)\n\n### 3.1 二进制使用\n#### 命令行试运行\n```bash\nwget https://github.com/redpanda-data/kminion/releases/download/v2.2.6/kminion_2.2.6_linux_amd64.tar.gz\ntar xvf kminion_2.2.6_linux_amd64.tar.gz kminion\nsudo mv kminion /usr/local/bin\n# 编写配置文件，并以环境变量的方式什么其路径\nexport CONFIG_FILEPATH=~/.kminion.yml\nkminon # 命令行运行\n```\n#### systemd 托管\n/etc/systemd/system/kminion.service\n```\n[Unit]\nDescription=kminion\nAfter=network.target\n\n[Service]\nType=simple\nExecStart=/usr/local/bin/kminion\nRestart=on-failure\nEnvironment=\"CONFIG_FILEPATH=/home/keyword/.kminion.yml\"\n\n[Install]\nWantedBy=multi-user.target\n```\n#### 配置文件 `/home/keyword/.kminion.yml`\n```yaml\nlogger:\n  # Valid values are: debug, info, warn, error, fatal, panic\n  level: info\n\nkafka:\n  brokers: [\"10.8.0.88:9092\",\"10.8.0.89:9092\",\"10.8.0.90:9092\"]\n  clientId: \"kminion\"\n  rackId: \"\"\n  tls:\n    enabled: false\n    caFilepath: \"\"\n    certFilepath: \"\"\n    keyFilepath: \"\"\n    # base64 encoded tls CA, cannot be set if 'caFilepath' is set\n    ca: \"\"\n    # base64 encoded tls cert, cannot be set if 'certFilepath' is set\n    cert: \"\"\n    # base64 encoded tls key, cannot be set if 'keyFilepath' is set\n    key: \"\"\n    passphrase: \"\"\n    insecureSkipTlsVerify: false\n\nminion:\n  consumerGroups:\n    # Enabled specifies whether consumer groups shall be scraped and exported or not.\n    enabled: true\n    # Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal\n    # __consumer_offsets topic. Both modes have their advantages and disadvantages.\n    # * adminApi:\n    #     - Useful for managed kafka clusters that do not provide access to the offsets topic.\n    # * offsetsTopic\n    #     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.\n    #     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the\n    #       size and throughput of the offsets topic.\n    scrapeMode: adminApi # Valid values: adminApi, offsetsTopic\n    # Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and\n    # you aren't interested in per partition lags you could choose \"topic\" where all partition lags will be summed\n    # and only topic lags will be exported.\n    granularity: partition\n    # AllowedGroups are regex strings of group ids that shall be exported\n    # You can specify allowed groups by providing literals like \"my-consumergroup-name\" or by providing regex expressions\n    # like \"/internal-.*/\".\n    allowedGroups: [ \".*\" ]\n    # IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups\n    # take precedence over allowed groups.\n    ignoredGroups: [ ]\n  topics:\n    # Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and\n    # you aren't interested in per partition metrics you could choose \"topic\".\n    granularity: partition\n    # AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.\n    # You can specify allowed topics by providing literals like \"my-topic-name\" or by providing regex expressions\n    # like \"/internal-.*/\".\n    allowedTopics: [ \".*\" ]\n    # IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics\n    # take precedence over allowed topics.\n    ignoredTopics: [ ]\n    # infoMetric is a configuration object for the kminion_kafka_topic_info metric\n    infoMetric:\n      # ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric\n      configKeys: [ \"cleanup.policy\" ]\n  logDirs:\n    # Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior\n    # to version 1.0.0 as describing log dirs was not supported back then.\n    enabled: true\n\n  # EndToEnd Metrics\n  # When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info\n  endToEnd:\n    enabled: true\n      #enabled: false\n    # How often to send end-to-end test messages\n    probeInterval: 100ms\n    topicManagement:\n      # You can disable topic management, without disabling the testing feature.\n      # Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic\n      enabled: true\n\n      # Name of the topic kminion uses to send its test messages\n      # You do *not* need to change this if you are running multiple kminion instances on the same cluster.\n      # Different instances are perfectly fine with sharing the same topic!\n      name: kminion-end-to-end\n\n      # How often kminion checks its topic to validate configuration, partition count, and partition assignments\n      reconciliationInterval: 10m\n\n      # Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)\n      # you may choose replication factor 1 or 3 most commonly.\n      replicationFactor: 1\n\n      # Rarely makes sense to change this, but maybe if you want some sort of cheap load test?\n      # By default (1) every broker gets one partition\n      partitionsPerBroker: 1\n\n    producer:\n      # This defines:\n      # - Maximum time to wait for an ack response after producing a message\n      # - Upper bound for histogram buckets in \"produce_latency_seconds\"\n      ackSla: 5s\n      # Can be to \"all\" (default) so kafka only reports an end-to-end test message as acknowledged if\n      # the message was written to all in-sync replicas of the partition.\n      # Or can be set to \"leader\" to only require to have written the message to its log.\n      requiredAcks: all\n\n    consumer:\n      # Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically\n      groupIdPrefix: kminion-end-to-end\n\n      # Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want\n      # KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.\n      deleteStaleConsumerGroups: false\n\n      # This defines:\n      # - Upper bound for histogram buckets in \"roundtrip_latency\"\n      # - Time limit beyond which a message is considered \"lost\" (failed the roundtrip)\n      roundtripSla: 20s\n\n      # - Upper bound for histogram buckets in \"commit_latency_seconds\"\n      # - Maximum time an offset commit is allowed to take before considering it failed\n      commitSla: 10s\n\nexporter:\n  host: \"10.8.0.88\"\n  port: 9095\n```\n\n#### prometheus.yml\n```\n- job_name: \"kafka_kminion\"\n    metrics_path: /metrics\n    static_configs:\n      - targets: ['10.8.0.88:9095']\n```\n\n### 3.2 使用 docker-compose\n#### docker-compose.yml\n```yaml TI:\"docker-compose.yml\"\nversion: '3'\n\nservices:\n  kminion:\n    image: vectorized/kminion:latest\n    container_name: kafka-minion\n    ports:\n      - 9095:8080\n    restart: unless-stopped\n    environment:\n      CONFIG_FILEPATH: /etc/kminion.yml\n    volumes:\n      - ./kminion.yml:/etc/kminion.yml\n```\n\n#### `kminion.yml` 配置文件使用内容如下\n```yaml\nlogger:\n  # Valid values are: debug, info, warn, error, fatal, panic\n  level: info\n\nkafka:\n  brokers: [\"10.8.0.88:9092\",\"10.8.0.89:9092\",\"10.8.0.90:9092\"]\n  clientId: \"kminion\"\n  rackId: \"\"\n  tls:\n    enabled: false\n    caFilepath: \"\"\n    certFilepath: \"\"\n    keyFilepath: \"\"\n    # base64 encoded tls CA, cannot be set if 'caFilepath' is set\n    ca: \"\"\n    # base64 encoded tls cert, cannot be set if 'certFilepath' is set\n    cert: \"\"\n    # base64 encoded tls key, cannot be set if 'keyFilepath' is set\n    key: \"\"\n    passphrase: \"\"\n    insecureSkipTlsVerify: false\n\n  sasl:\n    # Whether or not SASL authentication will be used for authentication\n    enabled: false\n    # Username to use for PLAIN or SCRAM mechanism\n    username: \"\"\n    # Password to use for PLAIN or SCRAM mechanism\n    password: \"\"\n    # Mechanism to use for SASL Authentication. Valid values are PLAIN, SCRAM-SHA-256, SCRAM-SHA-512, GSSAPI, OAUTHBEARER\n    mechanism: \"PLAIN\"\n    # GSSAPI / Kerberos config properties\n    gssapi:\n      authType: \"\"\n      keyTabPath: \"\"\n      kerberosConfigPath: \"\"\n      serviceName: \"\"\n      username: \"\"\n      password: \"\"\n      realm: \"\"\n      enableFast: true\n    # OAUTHBEARER config properties\n    oauth:\n      tokenEndpoint: \"\"\n      clientId: \"\"\n      clientSecret: \"\"\n      scope: \"\"\n\nminion:\n  consumerGroups:\n    # Enabled specifies whether consumer groups shall be scraped and exported or not.\n    enabled: true\n    # Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal\n    # __consumer_offsets topic. Both modes have their advantages and disadvantages.\n    # * adminApi:\n    #     - Useful for managed kafka clusters that do not provide access to the offsets topic.\n    # * offsetsTopic\n    #     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.\n    #     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the\n    #       size and throughput of the offsets topic.\n    scrapeMode: adminApi # Valid values: adminApi, offsetsTopic\n    # Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and\n    # you aren't interested in per partition lags you could choose \"topic\" where all partition lags will be summed\n    # and only topic lags will be exported.\n    granularity: partition\n    # AllowedGroups are regex strings of group ids that shall be exported\n    # You can specify allowed groups by providing literals like \"my-consumergroup-name\" or by providing regex expressions\n    # like \"/internal-.*/\".\n    allowedGroups: [ \".*\" ]\n    # IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups\n    # take precedence over allowed groups.\n    ignoredGroups: [ ]\n  topics:\n    # Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and\n    # you aren't interested in per partition metrics you could choose \"topic\".\n    granularity: partition\n    # AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.\n    # You can specify allowed topics by providing literals like \"my-topic-name\" or by providing regex expressions\n    # like \"/internal-.*/\".\n    allowedTopics: [ \".*\" ]\n    # IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics\n    # take precedence over allowed topics.\n    ignoredTopics: [ ]\n    # infoMetric is a configuration object for the kminion_kafka_topic_info metric\n    infoMetric:\n      # ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric\n      configKeys: [ \"cleanup.policy\" ]\n  logDirs:\n    # Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior\n    # to version 1.0.0 as describing log dirs was not supported back then.\n    enabled: true\n\n  # EndToEnd Metrics\n  # When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info\n  endToEnd:\n    enabled: true\n      #enabled: false\n    # How often to send end-to-end test messages\n    probeInterval: 100ms\n    topicManagement:\n      # You can disable topic management, without disabling the testing feature.\n      # Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic\n      enabled: true\n\n      # Name of the topic kminion uses to send its test messages\n      # You do *not* need to change this if you are running multiple kminion instances on the same cluster.\n      # Different instances are perfectly fine with sharing the same topic!\n      name: kminion-end-to-end\n\n      # How often kminion checks its topic to validate configuration, partition count, and partition assignments\n      reconciliationInterval: 10m\n\n      # Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)\n      # you may choose replication factor 1 or 3 most commonly.\n      replicationFactor: 1\n\n      # Rarely makes sense to change this, but maybe if you want some sort of cheap load test?\n      # By default (1) every broker gets one partition\n      partitionsPerBroker: 1\n\n    producer:\n      # This defines:\n      # - Maximum time to wait for an ack response after producing a message\n      # - Upper bound for histogram buckets in \"produce_latency_seconds\"\n      ackSla: 5s\n      # Can be to \"all\" (default) so kafka only reports an end-to-end test message as acknowledged if\n      # the message was written to all in-sync replicas of the partition.\n      # Or can be set to \"leader\" to only require to have written the message to its log.\n      requiredAcks: all\n\n    consumer:\n      # Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically\n      groupIdPrefix: kminion-end-to-end\n\n      # Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want\n      # KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.\n      deleteStaleConsumerGroups: false\n\n      # This defines:\n      # - Upper bound for histogram buckets in \"roundtrip_latency\"\n      # - Time limit beyond which a message is considered \"lost\" (failed the roundtrip)\n      roundtripSla: 20s\n\n      # - Upper bound for histogram buckets in \"commit_latency_seconds\"\n      # - Maximum time an offset commit is allowed to take before considering it failed\n      commitSla: 10s\n```","source":"_posts/metrics/kafka-exporter.md","raw":"---\ntitle: kafka-exporter\nauthor: LC\ntoc: true\ndate: 2024-04-30 23:20:00\nimg:\ntop:\ncover:\npassword:\nsummary: kafka 指标导出\ncategories: Opentelemetry\ntags: [metrics]\n---\n\n并没有找到官方比较权威的指标获取工具，来自社区的应用各有所长，使用以下工具，各取其长\n## 1. kafka_exporter\n下载并执行，获取指标太少，弃用\n   \n```\nnohup kafka_exporter --kafka.server=10.8.0.88:9092 &\n```\n\n## 2. [jmx_exporter]( https://github.com/prometheus/jmx_exporter )\n### 下载 java-agent, 需要在每个节点配置\n```\nwget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.20.0/jmx_prometheus_javaagent-0.20.0.jar\n```\n### 运行方式\n#### Running the Standalone HTTP Server（未使用）\n#### Running the Java Agent（推荐使用）\n在 `kafka-server-start.sh` 头部增加代码声明，agent将和服务共同启动\n```\nexport KAFKA_JMX_OPTS=\"-javaagent:/usr/local/kafka/bin/jmx_prometheus_javaagent-0.20.0.jar=9990:/usr/local/kafka/config/kafka-jmx.yml\"\n```\n\n各节点 kafka 已经由 systemd 管理，此处执行 systemctl restart kafka 即可\n#### [此处是官方的jmx_exporter使用的 javaagents 配置文件模板](https://github.com/prometheus/jmx_exporter/blob/main/example_configs/kafka-kraft-3_0_0.yml) kafka-jmx.yml\n```yaml\nlowercaseOutputName: true\n\nrules:\n# Special cases and very specific rules\n- pattern : kafka.server<type=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)><>Value\n  name: kafka_server_$1_$2\n  type: GAUGE\n  labels:\n    clientId: \"$3\"\n    topic: \"$4\"\n    partition: \"$5\"\n- pattern : kafka.server<type=(.+), name=(.+), clientId=(.+), brokerHost=(.+), brokerPort=(.+)><>Value\n  name: kafka_server_$1_$2\n  type: GAUGE\n  labels:\n    clientId: \"$3\"\n    broker: \"$4:$5\"\n- pattern : kafka.coordinator.(\\w+)<type=(.+), name=(.+)><>Value\n  name: kafka_coordinator_$1_$2_$3\n  type: GAUGE\n# Kraft current state info metric rule\n- pattern: \"kafka.server<type=raft-metrics><>current-state: ([a-z]+)\"\n  name: kafka_server_raft_metrics_current_state_info\n  type: GAUGE\n  value: 1\n  labels:\n    \"state\": \"$1\"\n# Kraft specific rules for raft-metrics, raft-channel-metrics, broker-metadata-metrics\n- pattern: kafka.server<type=(.+)><>([a-z-]+)-total\n  name: kafka_server_$1_$2_total\n  type: COUNTER\n- pattern: kafka.server<type=(.+)><>([a-z-]+)\n  name: kafka_server_$1_$2\n  type: GAUGE\n\n# Generic per-second counters with 0-2 key/value pairs\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)PerSec\\w*, (.+)=(.+), (.+)=(.+)><>Count\n  name: kafka_$1_$2_$3_total\n  type: COUNTER\n  labels:\n    \"$4\": \"$5\"\n    \"$6\": \"$7\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)PerSec\\w*, (.+)=(.+)><>Count\n  name: kafka_$1_$2_$3_total\n  type: COUNTER\n  labels:\n    \"$4\": \"$5\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)PerSec\\w*><>Count\n  name: kafka_$1_$2_$3_total\n  type: COUNTER\n\n# Quota specific rules\n- pattern: kafka.server<type=(.+), user=(.+), client-id=(.+)><>([a-z-]+)\n  name: kafka_server_quota_$4\n  type: GAUGE\n  labels:\n    resource: \"$1\"\n    user: \"$2\"\n    clientId: \"$3\"\n- pattern: kafka.server<type=(.+), client-id=(.+)><>([a-z-]+)\n  name: kafka_server_quota_$3\n  type: GAUGE\n  labels:\n    resource: \"$1\"\n    clientId: \"$2\"\n- pattern: kafka.server<type=(.+), user=(.+)><>([a-z-]+)\n  name: kafka_server_quota_$3\n  type: GAUGE\n  labels:\n    resource: \"$1\"\n    user: \"$2\"\n\n# Generic gauges with 0-2 key/value pairs\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.+), (.+)=(.+)><>Value\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n    \"$6\": \"$7\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.+)><>Value\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)><>Value\n  name: kafka_$1_$2_$3\n  type: GAUGE\n\n# Emulate Prometheus 'Summary' metrics for the exported 'Histogram's.\n#\n# Note that these are missing the '_sum' metric!\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.+), (.+)=(.+)><>Count\n  name: kafka_$1_$2_$3_count\n  type: COUNTER\n  labels:\n    \"$4\": \"$5\"\n    \"$6\": \"$7\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.*), (.+)=(.+)><>(\\d+)thPercentile\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n    \"$6\": \"$7\"\n    quantile: \"0.$8\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.+)><>Count\n  name: kafka_$1_$2_$3_count\n  type: COUNTER\n  labels:\n    \"$4\": \"$5\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+), (.+)=(.*)><>(\\d+)thPercentile\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n    quantile: \"0.$6\"\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)><>Count\n  name: kafka_$1_$2_$3_count\n  type: COUNTER\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)><>(\\d+)thPercentile\n  name: kafka_$1_$2_$3\n  type: GAUGE\n  labels:\n    quantile: \"0.$4\"\n\n# Generic gauges for MeanRate Percent\n# Ex) kafka.server<type=KafkaRequestHandlerPool, name=RequestHandlerAvgIdlePercent><>MeanRate\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)Percent\\w*><>MeanRate\n  name: kafka_$1_$2_$3_percent\n  type: GAUGE\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)Percent\\w*><>Value\n  name: kafka_$1_$2_$3_percent\n  type: GAUGE\n- pattern: kafka.(\\w+)<type=(.+), name=(.+)Percent\\w*, (.+)=(.+)><>Value\n  name: kafka_$1_$2_$3_percent\n  type: GAUGE\n  labels:\n    \"$4\": \"$5\"\n```\n\n#### prometheus.yml\n```\n- job_name: \"kafka_jmx\"\n    metrics_path: /metrics\n    static_configs:\n      - targets: ['192.168.249.1:9990','192.168.249.2:9990','192.168.249.3:9990']\n```\n\n## 3. Kiminon 使用\n#### 可以二进制、docker、 helm 部署 kiminon; 可以监控多源; 运行后访问 IP:port/metrics\n\nCluster Dashboard: [https://grafana.com/grafana/dashboards/14012](https://grafana.com/grafana/dashboards/14012)\nConsumer Group Dashboard: [https://grafana.com/grafana/dashboards/14014](https://grafana.com/grafana/dashboards/14014)\nTopic Dashboard: [https://grafana.com/grafana/dashboards/14013](https://grafana.com/grafana/dashboards/14013)\n\n### 3.1 二进制使用\n#### 命令行试运行\n```bash\nwget https://github.com/redpanda-data/kminion/releases/download/v2.2.6/kminion_2.2.6_linux_amd64.tar.gz\ntar xvf kminion_2.2.6_linux_amd64.tar.gz kminion\nsudo mv kminion /usr/local/bin\n# 编写配置文件，并以环境变量的方式什么其路径\nexport CONFIG_FILEPATH=~/.kminion.yml\nkminon # 命令行运行\n```\n#### systemd 托管\n/etc/systemd/system/kminion.service\n```\n[Unit]\nDescription=kminion\nAfter=network.target\n\n[Service]\nType=simple\nExecStart=/usr/local/bin/kminion\nRestart=on-failure\nEnvironment=\"CONFIG_FILEPATH=/home/keyword/.kminion.yml\"\n\n[Install]\nWantedBy=multi-user.target\n```\n#### 配置文件 `/home/keyword/.kminion.yml`\n```yaml\nlogger:\n  # Valid values are: debug, info, warn, error, fatal, panic\n  level: info\n\nkafka:\n  brokers: [\"10.8.0.88:9092\",\"10.8.0.89:9092\",\"10.8.0.90:9092\"]\n  clientId: \"kminion\"\n  rackId: \"\"\n  tls:\n    enabled: false\n    caFilepath: \"\"\n    certFilepath: \"\"\n    keyFilepath: \"\"\n    # base64 encoded tls CA, cannot be set if 'caFilepath' is set\n    ca: \"\"\n    # base64 encoded tls cert, cannot be set if 'certFilepath' is set\n    cert: \"\"\n    # base64 encoded tls key, cannot be set if 'keyFilepath' is set\n    key: \"\"\n    passphrase: \"\"\n    insecureSkipTlsVerify: false\n\nminion:\n  consumerGroups:\n    # Enabled specifies whether consumer groups shall be scraped and exported or not.\n    enabled: true\n    # Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal\n    # __consumer_offsets topic. Both modes have their advantages and disadvantages.\n    # * adminApi:\n    #     - Useful for managed kafka clusters that do not provide access to the offsets topic.\n    # * offsetsTopic\n    #     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.\n    #     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the\n    #       size and throughput of the offsets topic.\n    scrapeMode: adminApi # Valid values: adminApi, offsetsTopic\n    # Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and\n    # you aren't interested in per partition lags you could choose \"topic\" where all partition lags will be summed\n    # and only topic lags will be exported.\n    granularity: partition\n    # AllowedGroups are regex strings of group ids that shall be exported\n    # You can specify allowed groups by providing literals like \"my-consumergroup-name\" or by providing regex expressions\n    # like \"/internal-.*/\".\n    allowedGroups: [ \".*\" ]\n    # IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups\n    # take precedence over allowed groups.\n    ignoredGroups: [ ]\n  topics:\n    # Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and\n    # you aren't interested in per partition metrics you could choose \"topic\".\n    granularity: partition\n    # AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.\n    # You can specify allowed topics by providing literals like \"my-topic-name\" or by providing regex expressions\n    # like \"/internal-.*/\".\n    allowedTopics: [ \".*\" ]\n    # IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics\n    # take precedence over allowed topics.\n    ignoredTopics: [ ]\n    # infoMetric is a configuration object for the kminion_kafka_topic_info metric\n    infoMetric:\n      # ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric\n      configKeys: [ \"cleanup.policy\" ]\n  logDirs:\n    # Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior\n    # to version 1.0.0 as describing log dirs was not supported back then.\n    enabled: true\n\n  # EndToEnd Metrics\n  # When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info\n  endToEnd:\n    enabled: true\n      #enabled: false\n    # How often to send end-to-end test messages\n    probeInterval: 100ms\n    topicManagement:\n      # You can disable topic management, without disabling the testing feature.\n      # Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic\n      enabled: true\n\n      # Name of the topic kminion uses to send its test messages\n      # You do *not* need to change this if you are running multiple kminion instances on the same cluster.\n      # Different instances are perfectly fine with sharing the same topic!\n      name: kminion-end-to-end\n\n      # How often kminion checks its topic to validate configuration, partition count, and partition assignments\n      reconciliationInterval: 10m\n\n      # Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)\n      # you may choose replication factor 1 or 3 most commonly.\n      replicationFactor: 1\n\n      # Rarely makes sense to change this, but maybe if you want some sort of cheap load test?\n      # By default (1) every broker gets one partition\n      partitionsPerBroker: 1\n\n    producer:\n      # This defines:\n      # - Maximum time to wait for an ack response after producing a message\n      # - Upper bound for histogram buckets in \"produce_latency_seconds\"\n      ackSla: 5s\n      # Can be to \"all\" (default) so kafka only reports an end-to-end test message as acknowledged if\n      # the message was written to all in-sync replicas of the partition.\n      # Or can be set to \"leader\" to only require to have written the message to its log.\n      requiredAcks: all\n\n    consumer:\n      # Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically\n      groupIdPrefix: kminion-end-to-end\n\n      # Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want\n      # KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.\n      deleteStaleConsumerGroups: false\n\n      # This defines:\n      # - Upper bound for histogram buckets in \"roundtrip_latency\"\n      # - Time limit beyond which a message is considered \"lost\" (failed the roundtrip)\n      roundtripSla: 20s\n\n      # - Upper bound for histogram buckets in \"commit_latency_seconds\"\n      # - Maximum time an offset commit is allowed to take before considering it failed\n      commitSla: 10s\n\nexporter:\n  host: \"10.8.0.88\"\n  port: 9095\n```\n\n#### prometheus.yml\n```\n- job_name: \"kafka_kminion\"\n    metrics_path: /metrics\n    static_configs:\n      - targets: ['10.8.0.88:9095']\n```\n\n### 3.2 使用 docker-compose\n#### docker-compose.yml\n```yaml TI:\"docker-compose.yml\"\nversion: '3'\n\nservices:\n  kminion:\n    image: vectorized/kminion:latest\n    container_name: kafka-minion\n    ports:\n      - 9095:8080\n    restart: unless-stopped\n    environment:\n      CONFIG_FILEPATH: /etc/kminion.yml\n    volumes:\n      - ./kminion.yml:/etc/kminion.yml\n```\n\n#### `kminion.yml` 配置文件使用内容如下\n```yaml\nlogger:\n  # Valid values are: debug, info, warn, error, fatal, panic\n  level: info\n\nkafka:\n  brokers: [\"10.8.0.88:9092\",\"10.8.0.89:9092\",\"10.8.0.90:9092\"]\n  clientId: \"kminion\"\n  rackId: \"\"\n  tls:\n    enabled: false\n    caFilepath: \"\"\n    certFilepath: \"\"\n    keyFilepath: \"\"\n    # base64 encoded tls CA, cannot be set if 'caFilepath' is set\n    ca: \"\"\n    # base64 encoded tls cert, cannot be set if 'certFilepath' is set\n    cert: \"\"\n    # base64 encoded tls key, cannot be set if 'keyFilepath' is set\n    key: \"\"\n    passphrase: \"\"\n    insecureSkipTlsVerify: false\n\n  sasl:\n    # Whether or not SASL authentication will be used for authentication\n    enabled: false\n    # Username to use for PLAIN or SCRAM mechanism\n    username: \"\"\n    # Password to use for PLAIN or SCRAM mechanism\n    password: \"\"\n    # Mechanism to use for SASL Authentication. Valid values are PLAIN, SCRAM-SHA-256, SCRAM-SHA-512, GSSAPI, OAUTHBEARER\n    mechanism: \"PLAIN\"\n    # GSSAPI / Kerberos config properties\n    gssapi:\n      authType: \"\"\n      keyTabPath: \"\"\n      kerberosConfigPath: \"\"\n      serviceName: \"\"\n      username: \"\"\n      password: \"\"\n      realm: \"\"\n      enableFast: true\n    # OAUTHBEARER config properties\n    oauth:\n      tokenEndpoint: \"\"\n      clientId: \"\"\n      clientSecret: \"\"\n      scope: \"\"\n\nminion:\n  consumerGroups:\n    # Enabled specifies whether consumer groups shall be scraped and exported or not.\n    enabled: true\n    # Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal\n    # __consumer_offsets topic. Both modes have their advantages and disadvantages.\n    # * adminApi:\n    #     - Useful for managed kafka clusters that do not provide access to the offsets topic.\n    # * offsetsTopic\n    #     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.\n    #     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the\n    #       size and throughput of the offsets topic.\n    scrapeMode: adminApi # Valid values: adminApi, offsetsTopic\n    # Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and\n    # you aren't interested in per partition lags you could choose \"topic\" where all partition lags will be summed\n    # and only topic lags will be exported.\n    granularity: partition\n    # AllowedGroups are regex strings of group ids that shall be exported\n    # You can specify allowed groups by providing literals like \"my-consumergroup-name\" or by providing regex expressions\n    # like \"/internal-.*/\".\n    allowedGroups: [ \".*\" ]\n    # IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups\n    # take precedence over allowed groups.\n    ignoredGroups: [ ]\n  topics:\n    # Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and\n    # you aren't interested in per partition metrics you could choose \"topic\".\n    granularity: partition\n    # AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.\n    # You can specify allowed topics by providing literals like \"my-topic-name\" or by providing regex expressions\n    # like \"/internal-.*/\".\n    allowedTopics: [ \".*\" ]\n    # IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics\n    # take precedence over allowed topics.\n    ignoredTopics: [ ]\n    # infoMetric is a configuration object for the kminion_kafka_topic_info metric\n    infoMetric:\n      # ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric\n      configKeys: [ \"cleanup.policy\" ]\n  logDirs:\n    # Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior\n    # to version 1.0.0 as describing log dirs was not supported back then.\n    enabled: true\n\n  # EndToEnd Metrics\n  # When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info\n  endToEnd:\n    enabled: true\n      #enabled: false\n    # How often to send end-to-end test messages\n    probeInterval: 100ms\n    topicManagement:\n      # You can disable topic management, without disabling the testing feature.\n      # Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic\n      enabled: true\n\n      # Name of the topic kminion uses to send its test messages\n      # You do *not* need to change this if you are running multiple kminion instances on the same cluster.\n      # Different instances are perfectly fine with sharing the same topic!\n      name: kminion-end-to-end\n\n      # How often kminion checks its topic to validate configuration, partition count, and partition assignments\n      reconciliationInterval: 10m\n\n      # Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)\n      # you may choose replication factor 1 or 3 most commonly.\n      replicationFactor: 1\n\n      # Rarely makes sense to change this, but maybe if you want some sort of cheap load test?\n      # By default (1) every broker gets one partition\n      partitionsPerBroker: 1\n\n    producer:\n      # This defines:\n      # - Maximum time to wait for an ack response after producing a message\n      # - Upper bound for histogram buckets in \"produce_latency_seconds\"\n      ackSla: 5s\n      # Can be to \"all\" (default) so kafka only reports an end-to-end test message as acknowledged if\n      # the message was written to all in-sync replicas of the partition.\n      # Or can be set to \"leader\" to only require to have written the message to its log.\n      requiredAcks: all\n\n    consumer:\n      # Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically\n      groupIdPrefix: kminion-end-to-end\n\n      # Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want\n      # KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.\n      deleteStaleConsumerGroups: false\n\n      # This defines:\n      # - Upper bound for histogram buckets in \"roundtrip_latency\"\n      # - Time limit beyond which a message is considered \"lost\" (failed the roundtrip)\n      roundtripSla: 20s\n\n      # - Upper bound for histogram buckets in \"commit_latency_seconds\"\n      # - Maximum time an offset commit is allowed to take before considering it failed\n      commitSla: 10s\n```","slug":"metrics/kafka-exporter","published":1,"updated":"2024-04-30T16:26:28.695Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodjy001n80rv59l44mx3","content":"<p>并没有找到官方比较权威的指标获取工具，来自社区的应用各有所长，使用以下工具，各取其长</p>\n<h2 id=\"1-kafka-exporter\"><a href=\"#1-kafka-exporter\" class=\"headerlink\" title=\"1. kafka_exporter\"></a>1. kafka_exporter</h2><p>下载并执行，获取指标太少，弃用</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">nohup kafka_exporter --kafka.server&#x3D;10.8.0.88:9092 &amp;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"2-jmx-exporter\"><a href=\"#2-jmx-exporter\" class=\"headerlink\" title=\"2. jmx_exporter\"></a>2. <a href=\"https://github.com/prometheus/jmx_exporter\">jmx_exporter</a></h2><h3 id=\"下载-java-agent-需要在每个节点配置\"><a href=\"#下载-java-agent-需要在每个节点配置\" class=\"headerlink\" title=\"下载 java-agent, 需要在每个节点配置\"></a>下载 java-agent, 需要在每个节点配置</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">wget https:&#x2F;&#x2F;repo1.maven.org&#x2F;maven2&#x2F;io&#x2F;prometheus&#x2F;jmx&#x2F;jmx_prometheus_javaagent&#x2F;0.20.0&#x2F;jmx_prometheus_javaagent-0.20.0.jar<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h3 id=\"运行方式\"><a href=\"#运行方式\" class=\"headerlink\" title=\"运行方式\"></a>运行方式</h3><h4 id=\"Running-the-Standalone-HTTP-Server（未使用）\"><a href=\"#Running-the-Standalone-HTTP-Server（未使用）\" class=\"headerlink\" title=\"Running the Standalone HTTP Server（未使用）\"></a>Running the Standalone HTTP Server（未使用）</h4><h4 id=\"Running-the-Java-Agent（推荐使用）\"><a href=\"#Running-the-Java-Agent（推荐使用）\" class=\"headerlink\" title=\"Running the Java Agent（推荐使用）\"></a>Running the Java Agent（推荐使用）</h4><p>在 <code>kafka-server-start.sh</code> 头部增加代码声明，agent将和服务共同启动</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">export KAFKA_JMX_OPTS&#x3D;&quot;-javaagent:&#x2F;usr&#x2F;local&#x2F;kafka&#x2F;bin&#x2F;jmx_prometheus_javaagent-0.20.0.jar&#x3D;9990:&#x2F;usr&#x2F;local&#x2F;kafka&#x2F;config&#x2F;kafka-jmx.yml&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>各节点 kafka 已经由 systemd 管理，此处执行 systemctl restart kafka 即可</p>\n<h4 id=\"此处是官方的jmx-exporter使用的-javaagents-配置文件模板-kafka-jmx-yml\"><a href=\"#此处是官方的jmx-exporter使用的-javaagents-配置文件模板-kafka-jmx-yml\" class=\"headerlink\" title=\"此处是官方的jmx_exporter使用的 javaagents 配置文件模板 kafka-jmx.yml\"></a><a href=\"https://github.com/prometheus/jmx_exporter/blob/main/example_configs/kafka-kraft-3_0_0.yml\">此处是官方的jmx_exporter使用的 javaagents 配置文件模板</a> kafka-jmx.yml</h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">lowercaseOutputName</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n<span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n<span class=\"token comment\"># Special cases and very specific rules</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span> <span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> clientId=(.+)<span class=\"token punctuation\">,</span> topic=(.+)<span class=\"token punctuation\">,</span> partition=(.<span class=\"token important\">*)>&lt;>Value</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_$1_$2\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$3\"</span>\n    <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$4\"</span>\n    <span class=\"token key atrule\">partition</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span> <span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> clientId=(.+)<span class=\"token punctuation\">,</span> brokerHost=(.+)<span class=\"token punctuation\">,</span> brokerPort=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_$1_$2\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$3\"</span>\n    <span class=\"token key atrule\">broker</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$4:$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span> <span class=\"token punctuation\">:</span> kafka.coordinator.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_coordinator_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n<span class=\"token comment\"># Kraft current state info metric rule</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"kafka.server&lt;type=raft-metrics>&lt;>current-state: ([a-z]+)\"</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_raft_metrics_current_state_info\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"state\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$1\"</span>\n<span class=\"token comment\"># Kraft specific rules for raft-metrics, raft-channel-metrics, broker-metadata-metrics</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)<span class=\"token punctuation\">-</span>total\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_$1_$2_total\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_$1_$2\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n\n<span class=\"token comment\"># Generic per-second counters with 0-2 key/value pairs</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)PerSec\\w*<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_total\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">\"$6\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$7\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)PerSec\\w*<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_total\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)PerSec\\w<span class=\"token important\">*>&lt;>Count</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_total\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n\n<span class=\"token comment\"># Quota specific rules</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> user=(.+)<span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">-</span>id=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_quota_$4\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$1\"</span>\n    <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$2\"</span>\n    <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$3\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">-</span>id=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_quota_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$1\"</span>\n    <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$2\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> user=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_quota_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$1\"</span>\n    <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$2\"</span>\n\n<span class=\"token comment\"># Generic gauges with 0-2 key/value pairs</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">\"$6\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$7\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n\n<span class=\"token comment\"># Emulate Prometheus 'Summary' metrics for the exported 'Histogram's.</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># Note that these are missing the '_sum' metric!</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_count\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">\"$6\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$7\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.<span class=\"token important\">*)</span><span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(\\d+)thPercentile\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">\"$6\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$7\"</span>\n    <span class=\"token key atrule\">quantile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.$8\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_count\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.<span class=\"token important\">*)>&lt;>(\\d+)thPercentile</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">quantile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.$6\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_count\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(\\d+)thPercentile\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">quantile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.$4\"</span>\n\n<span class=\"token comment\"># Generic gauges for MeanRate Percent</span>\n<span class=\"token comment\"># Ex) kafka.server&lt;type=KafkaRequestHandlerPool, name=RequestHandlerAvgIdlePercent>&lt;>MeanRate</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)Percent\\w<span class=\"token important\">*>&lt;>MeanRate</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_percent\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)Percent\\w<span class=\"token important\">*>&lt;>Value</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_percent\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)Percent\\w*<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_percent\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"prometheus-yml\"><a href=\"#prometheus-yml\" class=\"headerlink\" title=\"prometheus.yml\"></a>prometheus.yml</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: &quot;kafka_jmx&quot;\n    metrics_path: &#x2F;metrics\n    static_configs:\n      - targets: [&#39;192.168.249.1:9990&#39;,&#39;192.168.249.2:9990&#39;,&#39;192.168.249.3:9990&#39;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-Kiminon-使用\"><a href=\"#3-Kiminon-使用\" class=\"headerlink\" title=\"3. Kiminon 使用\"></a>3. Kiminon 使用</h2><h4 id=\"可以二进制、docker、-helm-部署-kiminon-可以监控多源-运行后访问-IP-port-metrics\"><a href=\"#可以二进制、docker、-helm-部署-kiminon-可以监控多源-运行后访问-IP-port-metrics\" class=\"headerlink\" title=\"可以二进制、docker、 helm 部署 kiminon; 可以监控多源; 运行后访问 IP:port&#x2F;metrics\"></a>可以二进制、docker、 helm 部署 kiminon; 可以监控多源; 运行后访问 IP:port&#x2F;metrics</h4><p>Cluster Dashboard: <a href=\"https://grafana.com/grafana/dashboards/14012\">https://grafana.com/grafana/dashboards/14012</a><br>Consumer Group Dashboard: <a href=\"https://grafana.com/grafana/dashboards/14014\">https://grafana.com/grafana/dashboards/14014</a><br>Topic Dashboard: <a href=\"https://grafana.com/grafana/dashboards/14013\">https://grafana.com/grafana/dashboards/14013</a></p>\n<h3 id=\"3-1-二进制使用\"><a href=\"#3-1-二进制使用\" class=\"headerlink\" title=\"3.1 二进制使用\"></a>3.1 二进制使用</h3><h4 id=\"命令行试运行\"><a href=\"#命令行试运行\" class=\"headerlink\" title=\"命令行试运行\"></a>命令行试运行</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/redpanda-data/kminion/releases/download/v2.2.6/kminion_2.2.6_linux_amd64.tar.gz\n<span class=\"token function\">tar</span> xvf kminion_2.2.6_linux_amd64.tar.gz kminion\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> kminion /usr/local/bin\n<span class=\"token comment\"># 编写配置文件，并以环境变量的方式什么其路径</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CONFIG_FILEPATH</span><span class=\"token operator\">=~</span>/.kminion.yml\nkminon <span class=\"token comment\"># 命令行运行</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"systemd-托管\"><a href=\"#systemd-托管\" class=\"headerlink\" title=\"systemd 托管\"></a>systemd 托管</h4><p>&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;kminion.service</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">[Unit]\nDescription&#x3D;kminion\nAfter&#x3D;network.target\n\n[Service]\nType&#x3D;simple\nExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;kminion\nRestart&#x3D;on-failure\nEnvironment&#x3D;&quot;CONFIG_FILEPATH&#x3D;&#x2F;home&#x2F;keyword&#x2F;.kminion.yml&quot;\n\n[Install]\nWantedBy&#x3D;multi-user.target<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"配置文件-home-keyword-kminion-yml\"><a href=\"#配置文件-home-keyword-kminion-yml\" class=\"headerlink\" title=\"配置文件 /home/keyword/.kminion.yml\"></a>配置文件 <code>/home/keyword/.kminion.yml</code></h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">logger</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Valid values are: debug, info, warn, error, fatal, panic</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span> info\n\n<span class=\"token key atrule\">kafka</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">brokers</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"10.8.0.88:9092\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"10.8.0.89:9092\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"10.8.0.90:9092\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"kminion\"</span>\n  <span class=\"token key atrule\">rackId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token key atrule\">caFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">certFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">keyFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls CA, cannot be set if 'caFilepath' is set</span>\n    <span class=\"token key atrule\">ca</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls cert, cannot be set if 'certFilepath' is set</span>\n    <span class=\"token key atrule\">cert</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls key, cannot be set if 'keyFilepath' is set</span>\n    <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">passphrase</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">insecureSkipTlsVerify</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n<span class=\"token key atrule\">minion</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">consumerGroups</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Enabled specifies whether consumer groups shall be scraped and exported or not.</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token comment\"># Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal</span>\n    <span class=\"token comment\"># __consumer_offsets topic. Both modes have their advantages and disadvantages.</span>\n    <span class=\"token comment\"># * adminApi:</span>\n    <span class=\"token comment\">#     - Useful for managed kafka clusters that do not provide access to the offsets topic.</span>\n    <span class=\"token comment\"># * offsetsTopic</span>\n    <span class=\"token comment\">#     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.</span>\n    <span class=\"token comment\">#     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the</span>\n    <span class=\"token comment\">#       size and throughput of the offsets topic.</span>\n    <span class=\"token key atrule\">scrapeMode</span><span class=\"token punctuation\">:</span> adminApi <span class=\"token comment\"># Valid values: adminApi, offsetsTopic</span>\n    <span class=\"token comment\"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>\n    <span class=\"token comment\"># you aren't interested in per partition lags you could choose \"topic\" where all partition lags will be summed</span>\n    <span class=\"token comment\"># and only topic lags will be exported.</span>\n    <span class=\"token key atrule\">granularity</span><span class=\"token punctuation\">:</span> partition\n    <span class=\"token comment\"># AllowedGroups are regex strings of group ids that shall be exported</span>\n    <span class=\"token comment\"># You can specify allowed groups by providing literals like \"my-consumergroup-name\" or by providing regex expressions</span>\n    <span class=\"token comment\"># like \"/internal-.*/\".</span>\n    <span class=\"token key atrule\">allowedGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\".*\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups</span>\n    <span class=\"token comment\"># take precedence over allowed groups.</span>\n    <span class=\"token key atrule\">ignoredGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">topics</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>\n    <span class=\"token comment\"># you aren't interested in per partition metrics you could choose \"topic\".</span>\n    <span class=\"token key atrule\">granularity</span><span class=\"token punctuation\">:</span> partition\n    <span class=\"token comment\"># AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.</span>\n    <span class=\"token comment\"># You can specify allowed topics by providing literals like \"my-topic-name\" or by providing regex expressions</span>\n    <span class=\"token comment\"># like \"/internal-.*/\".</span>\n    <span class=\"token key atrule\">allowedTopics</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\".*\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics</span>\n    <span class=\"token comment\"># take precedence over allowed topics.</span>\n    <span class=\"token key atrule\">ignoredTopics</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># infoMetric is a configuration object for the kminion_kafka_topic_info metric</span>\n    <span class=\"token key atrule\">infoMetric</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric</span>\n      <span class=\"token key atrule\">configKeys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"cleanup.policy\"</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">logDirs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior</span>\n    <span class=\"token comment\"># to version 1.0.0 as describing log dirs was not supported back then.</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n  <span class=\"token comment\"># EndToEnd Metrics</span>\n  <span class=\"token comment\"># When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info</span>\n  <span class=\"token key atrule\">endToEnd</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token comment\">#enabled: false</span>\n    <span class=\"token comment\"># How often to send end-to-end test messages</span>\n    <span class=\"token key atrule\">probeInterval</span><span class=\"token punctuation\">:</span> 100ms\n    <span class=\"token key atrule\">topicManagement</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># You can disable topic management, without disabling the testing feature.</span>\n      <span class=\"token comment\"># Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic</span>\n      <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n      <span class=\"token comment\"># Name of the topic kminion uses to send its test messages</span>\n      <span class=\"token comment\"># You do *not* need to change this if you are running multiple kminion instances on the same cluster.</span>\n      <span class=\"token comment\"># Different instances are perfectly fine with sharing the same topic!</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kminion<span class=\"token punctuation\">-</span>end<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>end\n\n      <span class=\"token comment\"># How often kminion checks its topic to validate configuration, partition count, and partition assignments</span>\n      <span class=\"token key atrule\">reconciliationInterval</span><span class=\"token punctuation\">:</span> 10m\n\n      <span class=\"token comment\"># Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)</span>\n      <span class=\"token comment\"># you may choose replication factor 1 or 3 most commonly.</span>\n      <span class=\"token key atrule\">replicationFactor</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n      <span class=\"token comment\"># Rarely makes sense to change this, but maybe if you want some sort of cheap load test?</span>\n      <span class=\"token comment\"># By default (1) every broker gets one partition</span>\n      <span class=\"token key atrule\">partitionsPerBroker</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n    <span class=\"token key atrule\">producer</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># This defines:</span>\n      <span class=\"token comment\"># - Maximum time to wait for an ack response after producing a message</span>\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"produce_latency_seconds\"</span>\n      <span class=\"token key atrule\">ackSla</span><span class=\"token punctuation\">:</span> 5s\n      <span class=\"token comment\"># Can be to \"all\" (default) so kafka only reports an end-to-end test message as acknowledged if</span>\n      <span class=\"token comment\"># the message was written to all in-sync replicas of the partition.</span>\n      <span class=\"token comment\"># Or can be set to \"leader\" to only require to have written the message to its log.</span>\n      <span class=\"token key atrule\">requiredAcks</span><span class=\"token punctuation\">:</span> all\n\n    <span class=\"token key atrule\">consumer</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically</span>\n      <span class=\"token key atrule\">groupIdPrefix</span><span class=\"token punctuation\">:</span> kminion<span class=\"token punctuation\">-</span>end<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>end\n\n      <span class=\"token comment\"># Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want</span>\n      <span class=\"token comment\"># KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.</span>\n      <span class=\"token key atrule\">deleteStaleConsumerGroups</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n      <span class=\"token comment\"># This defines:</span>\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"roundtrip_latency\"</span>\n      <span class=\"token comment\"># - Time limit beyond which a message is considered \"lost\" (failed the roundtrip)</span>\n      <span class=\"token key atrule\">roundtripSla</span><span class=\"token punctuation\">:</span> 20s\n\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"commit_latency_seconds\"</span>\n      <span class=\"token comment\"># - Maximum time an offset commit is allowed to take before considering it failed</span>\n      <span class=\"token key atrule\">commitSla</span><span class=\"token punctuation\">:</span> 10s\n\n<span class=\"token key atrule\">exporter</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10.8.0.88\"</span>\n  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">9095</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"prometheus-yml-1\"><a href=\"#prometheus-yml-1\" class=\"headerlink\" title=\"prometheus.yml\"></a>prometheus.yml</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: &quot;kafka_kminion&quot;\n    metrics_path: &#x2F;metrics\n    static_configs:\n      - targets: [&#39;10.8.0.88:9095&#39;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-使用-docker-compose\"><a href=\"#3-2-使用-docker-compose\" class=\"headerlink\" title=\"3.2 使用 docker-compose\"></a>3.2 使用 docker-compose</h3><h4 id=\"docker-compose-yml\"><a href=\"#docker-compose-yml\" class=\"headerlink\" title=\"docker-compose.yml\"></a>docker-compose.yml</h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><div class=\"caption\"><span>TI:\"docker-compose.yml\"</span></div><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">kminion</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> vectorized/kminion<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> kafka<span class=\"token punctuation\">-</span>minion\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 9095<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">CONFIG_FILEPATH</span><span class=\"token punctuation\">:</span> /etc/kminion.yml\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./kminion.yml<span class=\"token punctuation\">:</span>/etc/kminion.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"kminion-yml-配置文件使用内容如下\"><a href=\"#kminion-yml-配置文件使用内容如下\" class=\"headerlink\" title=\"kminion.yml 配置文件使用内容如下\"></a><code>kminion.yml</code> 配置文件使用内容如下</h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">logger</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Valid values are: debug, info, warn, error, fatal, panic</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span> info\n\n<span class=\"token key atrule\">kafka</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">brokers</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"10.8.0.88:9092\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"10.8.0.89:9092\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"10.8.0.90:9092\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"kminion\"</span>\n  <span class=\"token key atrule\">rackId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token key atrule\">caFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">certFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">keyFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls CA, cannot be set if 'caFilepath' is set</span>\n    <span class=\"token key atrule\">ca</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls cert, cannot be set if 'certFilepath' is set</span>\n    <span class=\"token key atrule\">cert</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls key, cannot be set if 'keyFilepath' is set</span>\n    <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">passphrase</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">insecureSkipTlsVerify</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n  <span class=\"token key atrule\">sasl</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Whether or not SASL authentication will be used for authentication</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token comment\"># Username to use for PLAIN or SCRAM mechanism</span>\n    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># Password to use for PLAIN or SCRAM mechanism</span>\n    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># Mechanism to use for SASL Authentication. Valid values are PLAIN, SCRAM-SHA-256, SCRAM-SHA-512, GSSAPI, OAUTHBEARER</span>\n    <span class=\"token key atrule\">mechanism</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"PLAIN\"</span>\n    <span class=\"token comment\"># GSSAPI / Kerberos config properties</span>\n    <span class=\"token key atrule\">gssapi</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">authType</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">keyTabPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">kerberosConfigPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">realm</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">enableFast</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token comment\"># OAUTHBEARER config properties</span>\n    <span class=\"token key atrule\">oauth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">tokenEndpoint</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">clientSecret</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">scope</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n\n<span class=\"token key atrule\">minion</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">consumerGroups</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Enabled specifies whether consumer groups shall be scraped and exported or not.</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token comment\"># Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal</span>\n    <span class=\"token comment\"># __consumer_offsets topic. Both modes have their advantages and disadvantages.</span>\n    <span class=\"token comment\"># * adminApi:</span>\n    <span class=\"token comment\">#     - Useful for managed kafka clusters that do not provide access to the offsets topic.</span>\n    <span class=\"token comment\"># * offsetsTopic</span>\n    <span class=\"token comment\">#     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.</span>\n    <span class=\"token comment\">#     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the</span>\n    <span class=\"token comment\">#       size and throughput of the offsets topic.</span>\n    <span class=\"token key atrule\">scrapeMode</span><span class=\"token punctuation\">:</span> adminApi <span class=\"token comment\"># Valid values: adminApi, offsetsTopic</span>\n    <span class=\"token comment\"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>\n    <span class=\"token comment\"># you aren't interested in per partition lags you could choose \"topic\" where all partition lags will be summed</span>\n    <span class=\"token comment\"># and only topic lags will be exported.</span>\n    <span class=\"token key atrule\">granularity</span><span class=\"token punctuation\">:</span> partition\n    <span class=\"token comment\"># AllowedGroups are regex strings of group ids that shall be exported</span>\n    <span class=\"token comment\"># You can specify allowed groups by providing literals like \"my-consumergroup-name\" or by providing regex expressions</span>\n    <span class=\"token comment\"># like \"/internal-.*/\".</span>\n    <span class=\"token key atrule\">allowedGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\".*\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups</span>\n    <span class=\"token comment\"># take precedence over allowed groups.</span>\n    <span class=\"token key atrule\">ignoredGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">topics</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>\n    <span class=\"token comment\"># you aren't interested in per partition metrics you could choose \"topic\".</span>\n    <span class=\"token key atrule\">granularity</span><span class=\"token punctuation\">:</span> partition\n    <span class=\"token comment\"># AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.</span>\n    <span class=\"token comment\"># You can specify allowed topics by providing literals like \"my-topic-name\" or by providing regex expressions</span>\n    <span class=\"token comment\"># like \"/internal-.*/\".</span>\n    <span class=\"token key atrule\">allowedTopics</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\".*\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics</span>\n    <span class=\"token comment\"># take precedence over allowed topics.</span>\n    <span class=\"token key atrule\">ignoredTopics</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># infoMetric is a configuration object for the kminion_kafka_topic_info metric</span>\n    <span class=\"token key atrule\">infoMetric</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric</span>\n      <span class=\"token key atrule\">configKeys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"cleanup.policy\"</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">logDirs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior</span>\n    <span class=\"token comment\"># to version 1.0.0 as describing log dirs was not supported back then.</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n  <span class=\"token comment\"># EndToEnd Metrics</span>\n  <span class=\"token comment\"># When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info</span>\n  <span class=\"token key atrule\">endToEnd</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token comment\">#enabled: false</span>\n    <span class=\"token comment\"># How often to send end-to-end test messages</span>\n    <span class=\"token key atrule\">probeInterval</span><span class=\"token punctuation\">:</span> 100ms\n    <span class=\"token key atrule\">topicManagement</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># You can disable topic management, without disabling the testing feature.</span>\n      <span class=\"token comment\"># Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic</span>\n      <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n      <span class=\"token comment\"># Name of the topic kminion uses to send its test messages</span>\n      <span class=\"token comment\"># You do *not* need to change this if you are running multiple kminion instances on the same cluster.</span>\n      <span class=\"token comment\"># Different instances are perfectly fine with sharing the same topic!</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kminion<span class=\"token punctuation\">-</span>end<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>end\n\n      <span class=\"token comment\"># How often kminion checks its topic to validate configuration, partition count, and partition assignments</span>\n      <span class=\"token key atrule\">reconciliationInterval</span><span class=\"token punctuation\">:</span> 10m\n\n      <span class=\"token comment\"># Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)</span>\n      <span class=\"token comment\"># you may choose replication factor 1 or 3 most commonly.</span>\n      <span class=\"token key atrule\">replicationFactor</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n      <span class=\"token comment\"># Rarely makes sense to change this, but maybe if you want some sort of cheap load test?</span>\n      <span class=\"token comment\"># By default (1) every broker gets one partition</span>\n      <span class=\"token key atrule\">partitionsPerBroker</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n    <span class=\"token key atrule\">producer</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># This defines:</span>\n      <span class=\"token comment\"># - Maximum time to wait for an ack response after producing a message</span>\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"produce_latency_seconds\"</span>\n      <span class=\"token key atrule\">ackSla</span><span class=\"token punctuation\">:</span> 5s\n      <span class=\"token comment\"># Can be to \"all\" (default) so kafka only reports an end-to-end test message as acknowledged if</span>\n      <span class=\"token comment\"># the message was written to all in-sync replicas of the partition.</span>\n      <span class=\"token comment\"># Or can be set to \"leader\" to only require to have written the message to its log.</span>\n      <span class=\"token key atrule\">requiredAcks</span><span class=\"token punctuation\">:</span> all\n\n    <span class=\"token key atrule\">consumer</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically</span>\n      <span class=\"token key atrule\">groupIdPrefix</span><span class=\"token punctuation\">:</span> kminion<span class=\"token punctuation\">-</span>end<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>end\n\n      <span class=\"token comment\"># Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want</span>\n      <span class=\"token comment\"># KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.</span>\n      <span class=\"token key atrule\">deleteStaleConsumerGroups</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n      <span class=\"token comment\"># This defines:</span>\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"roundtrip_latency\"</span>\n      <span class=\"token comment\"># - Time limit beyond which a message is considered \"lost\" (failed the roundtrip)</span>\n      <span class=\"token key atrule\">roundtripSla</span><span class=\"token punctuation\">:</span> 20s\n\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"commit_latency_seconds\"</span>\n      <span class=\"token comment\"># - Maximum time an offset commit is allowed to take before considering it failed</span>\n      <span class=\"token key atrule\">commitSla</span><span class=\"token punctuation\">:</span> 10s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<p>并没有找到官方比较权威的指标获取工具，来自社区的应用各有所长，使用以下工具，各取其长</p>\n<h2 id=\"1-kafka-exporter\"><a href=\"#1-kafka-exporter\" class=\"headerlink\" title=\"1. kafka_exporter\"></a>1. kafka_exporter</h2><p>下载并执行，获取指标太少，弃用</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">nohup kafka_exporter --kafka.server&#x3D;10.8.0.88:9092 &amp;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"2-jmx-exporter\"><a href=\"#2-jmx-exporter\" class=\"headerlink\" title=\"2. jmx_exporter\"></a>2. <a href=\"https://github.com/prometheus/jmx_exporter\">jmx_exporter</a></h2><h3 id=\"下载-java-agent-需要在每个节点配置\"><a href=\"#下载-java-agent-需要在每个节点配置\" class=\"headerlink\" title=\"下载 java-agent, 需要在每个节点配置\"></a>下载 java-agent, 需要在每个节点配置</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">wget https:&#x2F;&#x2F;repo1.maven.org&#x2F;maven2&#x2F;io&#x2F;prometheus&#x2F;jmx&#x2F;jmx_prometheus_javaagent&#x2F;0.20.0&#x2F;jmx_prometheus_javaagent-0.20.0.jar<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h3 id=\"运行方式\"><a href=\"#运行方式\" class=\"headerlink\" title=\"运行方式\"></a>运行方式</h3><h4 id=\"Running-the-Standalone-HTTP-Server（未使用）\"><a href=\"#Running-the-Standalone-HTTP-Server（未使用）\" class=\"headerlink\" title=\"Running the Standalone HTTP Server（未使用）\"></a>Running the Standalone HTTP Server（未使用）</h4><h4 id=\"Running-the-Java-Agent（推荐使用）\"><a href=\"#Running-the-Java-Agent（推荐使用）\" class=\"headerlink\" title=\"Running the Java Agent（推荐使用）\"></a>Running the Java Agent（推荐使用）</h4><p>在 <code>kafka-server-start.sh</code> 头部增加代码声明，agent将和服务共同启动</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">export KAFKA_JMX_OPTS&#x3D;&quot;-javaagent:&#x2F;usr&#x2F;local&#x2F;kafka&#x2F;bin&#x2F;jmx_prometheus_javaagent-0.20.0.jar&#x3D;9990:&#x2F;usr&#x2F;local&#x2F;kafka&#x2F;config&#x2F;kafka-jmx.yml&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>各节点 kafka 已经由 systemd 管理，此处执行 systemctl restart kafka 即可</p>\n<h4 id=\"此处是官方的jmx-exporter使用的-javaagents-配置文件模板-kafka-jmx-yml\"><a href=\"#此处是官方的jmx-exporter使用的-javaagents-配置文件模板-kafka-jmx-yml\" class=\"headerlink\" title=\"此处是官方的jmx_exporter使用的 javaagents 配置文件模板 kafka-jmx.yml\"></a><a href=\"https://github.com/prometheus/jmx_exporter/blob/main/example_configs/kafka-kraft-3_0_0.yml\">此处是官方的jmx_exporter使用的 javaagents 配置文件模板</a> kafka-jmx.yml</h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">lowercaseOutputName</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n<span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n<span class=\"token comment\"># Special cases and very specific rules</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span> <span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> clientId=(.+)<span class=\"token punctuation\">,</span> topic=(.+)<span class=\"token punctuation\">,</span> partition=(.<span class=\"token important\">*)>&lt;>Value</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_$1_$2\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$3\"</span>\n    <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$4\"</span>\n    <span class=\"token key atrule\">partition</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span> <span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> clientId=(.+)<span class=\"token punctuation\">,</span> brokerHost=(.+)<span class=\"token punctuation\">,</span> brokerPort=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_$1_$2\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$3\"</span>\n    <span class=\"token key atrule\">broker</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$4:$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span> <span class=\"token punctuation\">:</span> kafka.coordinator.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_coordinator_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n<span class=\"token comment\"># Kraft current state info metric rule</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"kafka.server&lt;type=raft-metrics>&lt;>current-state: ([a-z]+)\"</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_raft_metrics_current_state_info\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"state\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$1\"</span>\n<span class=\"token comment\"># Kraft specific rules for raft-metrics, raft-channel-metrics, broker-metadata-metrics</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)<span class=\"token punctuation\">-</span>total\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_$1_$2_total\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_$1_$2\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n\n<span class=\"token comment\"># Generic per-second counters with 0-2 key/value pairs</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)PerSec\\w*<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_total\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">\"$6\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$7\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)PerSec\\w*<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_total\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)PerSec\\w<span class=\"token important\">*>&lt;>Count</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_total\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n\n<span class=\"token comment\"># Quota specific rules</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> user=(.+)<span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">-</span>id=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_quota_$4\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$1\"</span>\n    <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$2\"</span>\n    <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$3\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">-</span>id=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_quota_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$1\"</span>\n    <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$2\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=(.+)<span class=\"token punctuation\">,</span> user=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(<span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">-</span>z<span class=\"token punctuation\">-</span><span class=\"token punctuation\">]</span>+)\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_quota_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$1\"</span>\n    <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$2\"</span>\n\n<span class=\"token comment\"># Generic gauges with 0-2 key/value pairs</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">\"$6\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$7\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n\n<span class=\"token comment\"># Emulate Prometheus 'Summary' metrics for the exported 'Histogram's.</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># Note that these are missing the '_sum' metric!</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_count\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">\"$6\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$7\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.<span class=\"token important\">*)</span><span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(\\d+)thPercentile\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">\"$6\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$7\"</span>\n    <span class=\"token key atrule\">quantile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.$8\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_count\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">,</span> (.+)=(.<span class=\"token important\">*)>&lt;>(\\d+)thPercentile</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span>\n    <span class=\"token key atrule\">quantile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.$6\"</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_count\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>(\\d+)thPercentile\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">quantile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.$4\"</span>\n\n<span class=\"token comment\"># Generic gauges for MeanRate Percent</span>\n<span class=\"token comment\"># Ex) kafka.server&lt;type=KafkaRequestHandlerPool, name=RequestHandlerAvgIdlePercent>&lt;>MeanRate</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)Percent\\w<span class=\"token important\">*>&lt;>MeanRate</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_percent\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)Percent\\w<span class=\"token important\">*>&lt;>Value</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_percent\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.(\\w+)&lt;type=(.+)<span class=\"token punctuation\">,</span> name=(.+)Percent\\w*<span class=\"token punctuation\">,</span> (.+)=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_$1_$2_$3_percent\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">\"$4\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$5\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"prometheus-yml\"><a href=\"#prometheus-yml\" class=\"headerlink\" title=\"prometheus.yml\"></a>prometheus.yml</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: &quot;kafka_jmx&quot;\n    metrics_path: &#x2F;metrics\n    static_configs:\n      - targets: [&#39;192.168.249.1:9990&#39;,&#39;192.168.249.2:9990&#39;,&#39;192.168.249.3:9990&#39;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-Kiminon-使用\"><a href=\"#3-Kiminon-使用\" class=\"headerlink\" title=\"3. Kiminon 使用\"></a>3. Kiminon 使用</h2><h4 id=\"可以二进制、docker、-helm-部署-kiminon-可以监控多源-运行后访问-IP-port-metrics\"><a href=\"#可以二进制、docker、-helm-部署-kiminon-可以监控多源-运行后访问-IP-port-metrics\" class=\"headerlink\" title=\"可以二进制、docker、 helm 部署 kiminon; 可以监控多源; 运行后访问 IP:port&#x2F;metrics\"></a>可以二进制、docker、 helm 部署 kiminon; 可以监控多源; 运行后访问 IP:port&#x2F;metrics</h4><p>Cluster Dashboard: <a href=\"https://grafana.com/grafana/dashboards/14012\">https://grafana.com/grafana/dashboards/14012</a><br>Consumer Group Dashboard: <a href=\"https://grafana.com/grafana/dashboards/14014\">https://grafana.com/grafana/dashboards/14014</a><br>Topic Dashboard: <a href=\"https://grafana.com/grafana/dashboards/14013\">https://grafana.com/grafana/dashboards/14013</a></p>\n<h3 id=\"3-1-二进制使用\"><a href=\"#3-1-二进制使用\" class=\"headerlink\" title=\"3.1 二进制使用\"></a>3.1 二进制使用</h3><h4 id=\"命令行试运行\"><a href=\"#命令行试运行\" class=\"headerlink\" title=\"命令行试运行\"></a>命令行试运行</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/redpanda-data/kminion/releases/download/v2.2.6/kminion_2.2.6_linux_amd64.tar.gz\n<span class=\"token function\">tar</span> xvf kminion_2.2.6_linux_amd64.tar.gz kminion\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> kminion /usr/local/bin\n<span class=\"token comment\"># 编写配置文件，并以环境变量的方式什么其路径</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CONFIG_FILEPATH</span><span class=\"token operator\">=~</span>/.kminion.yml\nkminon <span class=\"token comment\"># 命令行运行</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"systemd-托管\"><a href=\"#systemd-托管\" class=\"headerlink\" title=\"systemd 托管\"></a>systemd 托管</h4><p>&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;kminion.service</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">[Unit]\nDescription&#x3D;kminion\nAfter&#x3D;network.target\n\n[Service]\nType&#x3D;simple\nExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;kminion\nRestart&#x3D;on-failure\nEnvironment&#x3D;&quot;CONFIG_FILEPATH&#x3D;&#x2F;home&#x2F;keyword&#x2F;.kminion.yml&quot;\n\n[Install]\nWantedBy&#x3D;multi-user.target<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h4 id=\"配置文件-home-keyword-kminion-yml\"><a href=\"#配置文件-home-keyword-kminion-yml\" class=\"headerlink\" title=\"配置文件 /home/keyword/.kminion.yml\"></a>配置文件 <code>/home/keyword/.kminion.yml</code></h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">logger</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Valid values are: debug, info, warn, error, fatal, panic</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span> info\n\n<span class=\"token key atrule\">kafka</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">brokers</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"10.8.0.88:9092\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"10.8.0.89:9092\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"10.8.0.90:9092\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"kminion\"</span>\n  <span class=\"token key atrule\">rackId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token key atrule\">caFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">certFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">keyFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls CA, cannot be set if 'caFilepath' is set</span>\n    <span class=\"token key atrule\">ca</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls cert, cannot be set if 'certFilepath' is set</span>\n    <span class=\"token key atrule\">cert</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls key, cannot be set if 'keyFilepath' is set</span>\n    <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">passphrase</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">insecureSkipTlsVerify</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n<span class=\"token key atrule\">minion</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">consumerGroups</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Enabled specifies whether consumer groups shall be scraped and exported or not.</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token comment\"># Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal</span>\n    <span class=\"token comment\"># __consumer_offsets topic. Both modes have their advantages and disadvantages.</span>\n    <span class=\"token comment\"># * adminApi:</span>\n    <span class=\"token comment\">#     - Useful for managed kafka clusters that do not provide access to the offsets topic.</span>\n    <span class=\"token comment\"># * offsetsTopic</span>\n    <span class=\"token comment\">#     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.</span>\n    <span class=\"token comment\">#     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the</span>\n    <span class=\"token comment\">#       size and throughput of the offsets topic.</span>\n    <span class=\"token key atrule\">scrapeMode</span><span class=\"token punctuation\">:</span> adminApi <span class=\"token comment\"># Valid values: adminApi, offsetsTopic</span>\n    <span class=\"token comment\"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>\n    <span class=\"token comment\"># you aren't interested in per partition lags you could choose \"topic\" where all partition lags will be summed</span>\n    <span class=\"token comment\"># and only topic lags will be exported.</span>\n    <span class=\"token key atrule\">granularity</span><span class=\"token punctuation\">:</span> partition\n    <span class=\"token comment\"># AllowedGroups are regex strings of group ids that shall be exported</span>\n    <span class=\"token comment\"># You can specify allowed groups by providing literals like \"my-consumergroup-name\" or by providing regex expressions</span>\n    <span class=\"token comment\"># like \"/internal-.*/\".</span>\n    <span class=\"token key atrule\">allowedGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\".*\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups</span>\n    <span class=\"token comment\"># take precedence over allowed groups.</span>\n    <span class=\"token key atrule\">ignoredGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">topics</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>\n    <span class=\"token comment\"># you aren't interested in per partition metrics you could choose \"topic\".</span>\n    <span class=\"token key atrule\">granularity</span><span class=\"token punctuation\">:</span> partition\n    <span class=\"token comment\"># AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.</span>\n    <span class=\"token comment\"># You can specify allowed topics by providing literals like \"my-topic-name\" or by providing regex expressions</span>\n    <span class=\"token comment\"># like \"/internal-.*/\".</span>\n    <span class=\"token key atrule\">allowedTopics</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\".*\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics</span>\n    <span class=\"token comment\"># take precedence over allowed topics.</span>\n    <span class=\"token key atrule\">ignoredTopics</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># infoMetric is a configuration object for the kminion_kafka_topic_info metric</span>\n    <span class=\"token key atrule\">infoMetric</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric</span>\n      <span class=\"token key atrule\">configKeys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"cleanup.policy\"</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">logDirs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior</span>\n    <span class=\"token comment\"># to version 1.0.0 as describing log dirs was not supported back then.</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n  <span class=\"token comment\"># EndToEnd Metrics</span>\n  <span class=\"token comment\"># When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info</span>\n  <span class=\"token key atrule\">endToEnd</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token comment\">#enabled: false</span>\n    <span class=\"token comment\"># How often to send end-to-end test messages</span>\n    <span class=\"token key atrule\">probeInterval</span><span class=\"token punctuation\">:</span> 100ms\n    <span class=\"token key atrule\">topicManagement</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># You can disable topic management, without disabling the testing feature.</span>\n      <span class=\"token comment\"># Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic</span>\n      <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n      <span class=\"token comment\"># Name of the topic kminion uses to send its test messages</span>\n      <span class=\"token comment\"># You do *not* need to change this if you are running multiple kminion instances on the same cluster.</span>\n      <span class=\"token comment\"># Different instances are perfectly fine with sharing the same topic!</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kminion<span class=\"token punctuation\">-</span>end<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>end\n\n      <span class=\"token comment\"># How often kminion checks its topic to validate configuration, partition count, and partition assignments</span>\n      <span class=\"token key atrule\">reconciliationInterval</span><span class=\"token punctuation\">:</span> 10m\n\n      <span class=\"token comment\"># Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)</span>\n      <span class=\"token comment\"># you may choose replication factor 1 or 3 most commonly.</span>\n      <span class=\"token key atrule\">replicationFactor</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n      <span class=\"token comment\"># Rarely makes sense to change this, but maybe if you want some sort of cheap load test?</span>\n      <span class=\"token comment\"># By default (1) every broker gets one partition</span>\n      <span class=\"token key atrule\">partitionsPerBroker</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n    <span class=\"token key atrule\">producer</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># This defines:</span>\n      <span class=\"token comment\"># - Maximum time to wait for an ack response after producing a message</span>\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"produce_latency_seconds\"</span>\n      <span class=\"token key atrule\">ackSla</span><span class=\"token punctuation\">:</span> 5s\n      <span class=\"token comment\"># Can be to \"all\" (default) so kafka only reports an end-to-end test message as acknowledged if</span>\n      <span class=\"token comment\"># the message was written to all in-sync replicas of the partition.</span>\n      <span class=\"token comment\"># Or can be set to \"leader\" to only require to have written the message to its log.</span>\n      <span class=\"token key atrule\">requiredAcks</span><span class=\"token punctuation\">:</span> all\n\n    <span class=\"token key atrule\">consumer</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically</span>\n      <span class=\"token key atrule\">groupIdPrefix</span><span class=\"token punctuation\">:</span> kminion<span class=\"token punctuation\">-</span>end<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>end\n\n      <span class=\"token comment\"># Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want</span>\n      <span class=\"token comment\"># KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.</span>\n      <span class=\"token key atrule\">deleteStaleConsumerGroups</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n      <span class=\"token comment\"># This defines:</span>\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"roundtrip_latency\"</span>\n      <span class=\"token comment\"># - Time limit beyond which a message is considered \"lost\" (failed the roundtrip)</span>\n      <span class=\"token key atrule\">roundtripSla</span><span class=\"token punctuation\">:</span> 20s\n\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"commit_latency_seconds\"</span>\n      <span class=\"token comment\"># - Maximum time an offset commit is allowed to take before considering it failed</span>\n      <span class=\"token key atrule\">commitSla</span><span class=\"token punctuation\">:</span> 10s\n\n<span class=\"token key atrule\">exporter</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10.8.0.88\"</span>\n  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">9095</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"prometheus-yml-1\"><a href=\"#prometheus-yml-1\" class=\"headerlink\" title=\"prometheus.yml\"></a>prometheus.yml</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: &quot;kafka_kminion&quot;\n    metrics_path: &#x2F;metrics\n    static_configs:\n      - targets: [&#39;10.8.0.88:9095&#39;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-使用-docker-compose\"><a href=\"#3-2-使用-docker-compose\" class=\"headerlink\" title=\"3.2 使用 docker-compose\"></a>3.2 使用 docker-compose</h3><h4 id=\"docker-compose-yml\"><a href=\"#docker-compose-yml\" class=\"headerlink\" title=\"docker-compose.yml\"></a>docker-compose.yml</h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><div class=\"caption\"><span>TI:\"docker-compose.yml\"</span></div><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">kminion</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> vectorized/kminion<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> kafka<span class=\"token punctuation\">-</span>minion\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 9095<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">CONFIG_FILEPATH</span><span class=\"token punctuation\">:</span> /etc/kminion.yml\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./kminion.yml<span class=\"token punctuation\">:</span>/etc/kminion.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"kminion-yml-配置文件使用内容如下\"><a href=\"#kminion-yml-配置文件使用内容如下\" class=\"headerlink\" title=\"kminion.yml 配置文件使用内容如下\"></a><code>kminion.yml</code> 配置文件使用内容如下</h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">logger</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Valid values are: debug, info, warn, error, fatal, panic</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span> info\n\n<span class=\"token key atrule\">kafka</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">brokers</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"10.8.0.88:9092\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"10.8.0.89:9092\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"10.8.0.90:9092\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"kminion\"</span>\n  <span class=\"token key atrule\">rackId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token key atrule\">caFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">certFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">keyFilepath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls CA, cannot be set if 'caFilepath' is set</span>\n    <span class=\"token key atrule\">ca</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls cert, cannot be set if 'certFilepath' is set</span>\n    <span class=\"token key atrule\">cert</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># base64 encoded tls key, cannot be set if 'keyFilepath' is set</span>\n    <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">passphrase</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">insecureSkipTlsVerify</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n  <span class=\"token key atrule\">sasl</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Whether or not SASL authentication will be used for authentication</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token comment\"># Username to use for PLAIN or SCRAM mechanism</span>\n    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># Password to use for PLAIN or SCRAM mechanism</span>\n    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token comment\"># Mechanism to use for SASL Authentication. Valid values are PLAIN, SCRAM-SHA-256, SCRAM-SHA-512, GSSAPI, OAUTHBEARER</span>\n    <span class=\"token key atrule\">mechanism</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"PLAIN\"</span>\n    <span class=\"token comment\"># GSSAPI / Kerberos config properties</span>\n    <span class=\"token key atrule\">gssapi</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">authType</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">keyTabPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">kerberosConfigPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">realm</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">enableFast</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token comment\"># OAUTHBEARER config properties</span>\n    <span class=\"token key atrule\">oauth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">tokenEndpoint</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">clientSecret</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n      <span class=\"token key atrule\">scope</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n\n<span class=\"token key atrule\">minion</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">consumerGroups</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Enabled specifies whether consumer groups shall be scraped and exported or not.</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token comment\"># Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal</span>\n    <span class=\"token comment\"># __consumer_offsets topic. Both modes have their advantages and disadvantages.</span>\n    <span class=\"token comment\"># * adminApi:</span>\n    <span class=\"token comment\">#     - Useful for managed kafka clusters that do not provide access to the offsets topic.</span>\n    <span class=\"token comment\"># * offsetsTopic</span>\n    <span class=\"token comment\">#     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.</span>\n    <span class=\"token comment\">#     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the</span>\n    <span class=\"token comment\">#       size and throughput of the offsets topic.</span>\n    <span class=\"token key atrule\">scrapeMode</span><span class=\"token punctuation\">:</span> adminApi <span class=\"token comment\"># Valid values: adminApi, offsetsTopic</span>\n    <span class=\"token comment\"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>\n    <span class=\"token comment\"># you aren't interested in per partition lags you could choose \"topic\" where all partition lags will be summed</span>\n    <span class=\"token comment\"># and only topic lags will be exported.</span>\n    <span class=\"token key atrule\">granularity</span><span class=\"token punctuation\">:</span> partition\n    <span class=\"token comment\"># AllowedGroups are regex strings of group ids that shall be exported</span>\n    <span class=\"token comment\"># You can specify allowed groups by providing literals like \"my-consumergroup-name\" or by providing regex expressions</span>\n    <span class=\"token comment\"># like \"/internal-.*/\".</span>\n    <span class=\"token key atrule\">allowedGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\".*\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups</span>\n    <span class=\"token comment\"># take precedence over allowed groups.</span>\n    <span class=\"token key atrule\">ignoredGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">topics</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>\n    <span class=\"token comment\"># you aren't interested in per partition metrics you could choose \"topic\".</span>\n    <span class=\"token key atrule\">granularity</span><span class=\"token punctuation\">:</span> partition\n    <span class=\"token comment\"># AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.</span>\n    <span class=\"token comment\"># You can specify allowed topics by providing literals like \"my-topic-name\" or by providing regex expressions</span>\n    <span class=\"token comment\"># like \"/internal-.*/\".</span>\n    <span class=\"token key atrule\">allowedTopics</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\".*\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics</span>\n    <span class=\"token comment\"># take precedence over allowed topics.</span>\n    <span class=\"token key atrule\">ignoredTopics</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># infoMetric is a configuration object for the kminion_kafka_topic_info metric</span>\n    <span class=\"token key atrule\">infoMetric</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric</span>\n      <span class=\"token key atrule\">configKeys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"cleanup.policy\"</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">logDirs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior</span>\n    <span class=\"token comment\"># to version 1.0.0 as describing log dirs was not supported back then.</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n  <span class=\"token comment\"># EndToEnd Metrics</span>\n  <span class=\"token comment\"># When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info</span>\n  <span class=\"token key atrule\">endToEnd</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token comment\">#enabled: false</span>\n    <span class=\"token comment\"># How often to send end-to-end test messages</span>\n    <span class=\"token key atrule\">probeInterval</span><span class=\"token punctuation\">:</span> 100ms\n    <span class=\"token key atrule\">topicManagement</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># You can disable topic management, without disabling the testing feature.</span>\n      <span class=\"token comment\"># Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic</span>\n      <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n      <span class=\"token comment\"># Name of the topic kminion uses to send its test messages</span>\n      <span class=\"token comment\"># You do *not* need to change this if you are running multiple kminion instances on the same cluster.</span>\n      <span class=\"token comment\"># Different instances are perfectly fine with sharing the same topic!</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kminion<span class=\"token punctuation\">-</span>end<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>end\n\n      <span class=\"token comment\"># How often kminion checks its topic to validate configuration, partition count, and partition assignments</span>\n      <span class=\"token key atrule\">reconciliationInterval</span><span class=\"token punctuation\">:</span> 10m\n\n      <span class=\"token comment\"># Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)</span>\n      <span class=\"token comment\"># you may choose replication factor 1 or 3 most commonly.</span>\n      <span class=\"token key atrule\">replicationFactor</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n      <span class=\"token comment\"># Rarely makes sense to change this, but maybe if you want some sort of cheap load test?</span>\n      <span class=\"token comment\"># By default (1) every broker gets one partition</span>\n      <span class=\"token key atrule\">partitionsPerBroker</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n    <span class=\"token key atrule\">producer</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># This defines:</span>\n      <span class=\"token comment\"># - Maximum time to wait for an ack response after producing a message</span>\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"produce_latency_seconds\"</span>\n      <span class=\"token key atrule\">ackSla</span><span class=\"token punctuation\">:</span> 5s\n      <span class=\"token comment\"># Can be to \"all\" (default) so kafka only reports an end-to-end test message as acknowledged if</span>\n      <span class=\"token comment\"># the message was written to all in-sync replicas of the partition.</span>\n      <span class=\"token comment\"># Or can be set to \"leader\" to only require to have written the message to its log.</span>\n      <span class=\"token key atrule\">requiredAcks</span><span class=\"token punctuation\">:</span> all\n\n    <span class=\"token key atrule\">consumer</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically</span>\n      <span class=\"token key atrule\">groupIdPrefix</span><span class=\"token punctuation\">:</span> kminion<span class=\"token punctuation\">-</span>end<span class=\"token punctuation\">-</span>to<span class=\"token punctuation\">-</span>end\n\n      <span class=\"token comment\"># Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want</span>\n      <span class=\"token comment\"># KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.</span>\n      <span class=\"token key atrule\">deleteStaleConsumerGroups</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n\n      <span class=\"token comment\"># This defines:</span>\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"roundtrip_latency\"</span>\n      <span class=\"token comment\"># - Time limit beyond which a message is considered \"lost\" (failed the roundtrip)</span>\n      <span class=\"token key atrule\">roundtripSla</span><span class=\"token punctuation\">:</span> 20s\n\n      <span class=\"token comment\"># - Upper bound for histogram buckets in \"commit_latency_seconds\"</span>\n      <span class=\"token comment\"># - Maximum time an offset commit is allowed to take before considering it failed</span>\n      <span class=\"token key atrule\">commitSla</span><span class=\"token punctuation\">:</span> 10s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>"},{"title":"mysqld-exporter","author":"LC","toc":true,"date":"2024-04-30T15:20:00.000Z","img":null,"top":null,"cover":null,"password":null,"summary":"mysql prometheus 指标导出","_content":"\n## 1.前置条件\n mysql 中准备暴露指标的用户和主机地址( exporter  ip)，并在相应表中必要授权\n```bash\nCREATE USER 'mysqld_exporter'@'10.1.0.81' IDENTIFIED BY 'keyword@2020';\nGRANT REPLICATION CLIENT, PROCESS ON *.* TO 'mysqld_exporter'@'10.1.0.81';\nGRANT SELECT ON performance_schema.* TO 'mysqld_exporter'@'10.1.0.81';\nFLUSH PRIVILEGES;\n```\n## 2. 配置 mysqld_exporter 用户\n```\ntee > .db.cnf << EOF\n[client]\nuser=mysqld_exporter\npassword=keyword@2020\nEOF\n```\n## 3. 下载\n```\nwget https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.1/mysqld_exporter-0.15.1.linux-amd64.tar.gz\ntar xvf mysqld_exporter-0.15.1.linux-amd64.tar.gz\nsudo mv mysqld_exporter-0.15.1.linux-amd64/mysqld_exporter /usr/local/bin/\n```\n## 4. 使用 systemd 管理\n```\nsudo tee > /etc/systemd/system/mysqld_exporter.service << EOF\n[Unit]\nDescription=mysql_exporter\nAfter=network.target\n\n[Service]\nType=simple\nExecStart=/usr/local/bin/mysqld_exporter --config.my-cnf=\"/home/keyword/mysql/.db.cnf\"\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable --now mysqld_exporter\n```\n## 5. 此时可以去访问默认的 9104/metrics\n```\n- job_name: 'mysqld_exporter'  \n  metrics_path: /metrics  \n  static_configs:  \n  - targets:\n    - 10.1.0.81:9104\n```\n\n## 6. 多源监测\n- 不用在每个 mysql 去安装 exporter\n- 在 .db.cnf 新增另一个数据库的监控专用用户信息; 保证服务端进行上述用户权限配置即可\n```ini\n[client]\nhost = 10.1.0.81\nport = 3306\nuser = mysqld_exporter\npassword = keyword@2020\n\n[client-db2]\nhost = 10.8.0.90\nport = 3306\nuser = mysqld_exporter\npassword = keyword@2020\n```\n\n>[!bug] 问题 1\n>Get \" http://10.8.0.90:3306/probe?auth_module=client-db2&target=10.8.0.90%3A3306\": dial tcp 10.8.0.90:3306: connect: connection refused\n\n>[!Solution] 解决\n> 1. mysql bind-address 未修改，仍然限定的是其本身回环地址，'/etc/mysql/mysql.conf.d/mysqld.cnf'\n> 2. mysql 中，创建用户并管理 client 服务器地址需要正确限定， user@client ip / 网段\n\n>[!bug] 问题 2\n>Get \" http://10.1.0.81:3306/probe?auth_module=client&target=10.1.0.81%3A3306\": net/http: HTTP/1.x transport connection broken: malformed HTTP status code \"'172.22.0.2'\"\\\n>修改 prometheus.yml 之后正常\n\n调整后的最终版本 prometheus.yml\n```Yaml TI：\"successful version\"\n  - job_name: 'multiple_mysql'\n    static_configs: #也可以将此替换为其他的服务发现配置\n      - targets:\n          - 10.1.0.81:3306  # mysql 1\n        labels:\n          modes: Master  # 自己定义的标签\n          auth_module: client  # 必须指定，值来源于用户信息的cnf文件中，如果多个数据库使用的用户相同，可以使用同一个auth配置\n      - targets:\n          - 10.8.0.90:3306  # mysql 2\n        labels:\n          modes: slave\n          auth_module: client-db2\n    relabel_configs:\n      # 核心是获取 `__parm_target` 就是 上面params抓取的target\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      # 配置后只有此 endpoint，是 exporter 的地址， target 将成为标签\n      - target_label: __address__\n        replacement: 10.1.0.81:9104\n      # 下面将把 auth_module 这个标签的值替换为__param_auth_module的值，__param_auth_module即上方static_configs下的params配置\n      - source_labels: [auth_module]\n        target_label: __param_auth_module\n      # 下面将删除 auth_module 这个标签\n      - action: labeldrop\n        regex: auth_module\n```\n\n## 7. reference\n   [技术分享 | mysqld\\_exporter 收集多个 MySQL 监控避坑 - 墨天轮](https://www.modb.pro/db/565900)","source":"_posts/metrics/mysqld-exporter.md","raw":"---\ntitle: mysqld-exporter\nauthor: LC\ntoc: true\ndate: 2024-04-30 23:20:00\nimg:\ntop:\ncover:\npassword:\nsummary: mysql prometheus 指标导出\ncategories: Opentelemetry\ntags: [metrics]\n---\n\n## 1.前置条件\n mysql 中准备暴露指标的用户和主机地址( exporter  ip)，并在相应表中必要授权\n```bash\nCREATE USER 'mysqld_exporter'@'10.1.0.81' IDENTIFIED BY 'keyword@2020';\nGRANT REPLICATION CLIENT, PROCESS ON *.* TO 'mysqld_exporter'@'10.1.0.81';\nGRANT SELECT ON performance_schema.* TO 'mysqld_exporter'@'10.1.0.81';\nFLUSH PRIVILEGES;\n```\n## 2. 配置 mysqld_exporter 用户\n```\ntee > .db.cnf << EOF\n[client]\nuser=mysqld_exporter\npassword=keyword@2020\nEOF\n```\n## 3. 下载\n```\nwget https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.1/mysqld_exporter-0.15.1.linux-amd64.tar.gz\ntar xvf mysqld_exporter-0.15.1.linux-amd64.tar.gz\nsudo mv mysqld_exporter-0.15.1.linux-amd64/mysqld_exporter /usr/local/bin/\n```\n## 4. 使用 systemd 管理\n```\nsudo tee > /etc/systemd/system/mysqld_exporter.service << EOF\n[Unit]\nDescription=mysql_exporter\nAfter=network.target\n\n[Service]\nType=simple\nExecStart=/usr/local/bin/mysqld_exporter --config.my-cnf=\"/home/keyword/mysql/.db.cnf\"\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable --now mysqld_exporter\n```\n## 5. 此时可以去访问默认的 9104/metrics\n```\n- job_name: 'mysqld_exporter'  \n  metrics_path: /metrics  \n  static_configs:  \n  - targets:\n    - 10.1.0.81:9104\n```\n\n## 6. 多源监测\n- 不用在每个 mysql 去安装 exporter\n- 在 .db.cnf 新增另一个数据库的监控专用用户信息; 保证服务端进行上述用户权限配置即可\n```ini\n[client]\nhost = 10.1.0.81\nport = 3306\nuser = mysqld_exporter\npassword = keyword@2020\n\n[client-db2]\nhost = 10.8.0.90\nport = 3306\nuser = mysqld_exporter\npassword = keyword@2020\n```\n\n>[!bug] 问题 1\n>Get \" http://10.8.0.90:3306/probe?auth_module=client-db2&target=10.8.0.90%3A3306\": dial tcp 10.8.0.90:3306: connect: connection refused\n\n>[!Solution] 解决\n> 1. mysql bind-address 未修改，仍然限定的是其本身回环地址，'/etc/mysql/mysql.conf.d/mysqld.cnf'\n> 2. mysql 中，创建用户并管理 client 服务器地址需要正确限定， user@client ip / 网段\n\n>[!bug] 问题 2\n>Get \" http://10.1.0.81:3306/probe?auth_module=client&target=10.1.0.81%3A3306\": net/http: HTTP/1.x transport connection broken: malformed HTTP status code \"'172.22.0.2'\"\\\n>修改 prometheus.yml 之后正常\n\n调整后的最终版本 prometheus.yml\n```Yaml TI：\"successful version\"\n  - job_name: 'multiple_mysql'\n    static_configs: #也可以将此替换为其他的服务发现配置\n      - targets:\n          - 10.1.0.81:3306  # mysql 1\n        labels:\n          modes: Master  # 自己定义的标签\n          auth_module: client  # 必须指定，值来源于用户信息的cnf文件中，如果多个数据库使用的用户相同，可以使用同一个auth配置\n      - targets:\n          - 10.8.0.90:3306  # mysql 2\n        labels:\n          modes: slave\n          auth_module: client-db2\n    relabel_configs:\n      # 核心是获取 `__parm_target` 就是 上面params抓取的target\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      # 配置后只有此 endpoint，是 exporter 的地址， target 将成为标签\n      - target_label: __address__\n        replacement: 10.1.0.81:9104\n      # 下面将把 auth_module 这个标签的值替换为__param_auth_module的值，__param_auth_module即上方static_configs下的params配置\n      - source_labels: [auth_module]\n        target_label: __param_auth_module\n      # 下面将删除 auth_module 这个标签\n      - action: labeldrop\n        regex: auth_module\n```\n\n## 7. reference\n   [技术分享 | mysqld\\_exporter 收集多个 MySQL 监控避坑 - 墨天轮](https://www.modb.pro/db/565900)","slug":"metrics/mysqld-exporter","published":1,"updated":"2024-04-30T16:26:12.675Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodk2001p80rvb1t70yha","content":"<h2 id=\"1-前置条件\"><a href=\"#1-前置条件\" class=\"headerlink\" title=\"1.前置条件\"></a>1.前置条件</h2><p> mysql 中准备暴露指标的用户和主机地址( exporter  ip)，并在相应表中必要授权</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">CREATE <span class=\"token environment constant\">USER</span> <span class=\"token string\">'mysqld_exporter'</span>@<span class=\"token string\">'10.1.0.81'</span> IDENTIFIED BY <span class=\"token string\">'keyword@2020'</span><span class=\"token punctuation\">;</span>\nGRANT REPLICATION CLIENT, PROCESS ON *.* TO <span class=\"token string\">'mysqld_exporter'</span>@<span class=\"token string\">'10.1.0.81'</span><span class=\"token punctuation\">;</span>\nGRANT SELECT ON performance_schema.* TO <span class=\"token string\">'mysqld_exporter'</span>@<span class=\"token string\">'10.1.0.81'</span><span class=\"token punctuation\">;</span>\nFLUSH PRIVILEGES<span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"2-配置-mysqld-exporter-用户\"><a href=\"#2-配置-mysqld-exporter-用户\" class=\"headerlink\" title=\"2. 配置 mysqld_exporter 用户\"></a>2. 配置 mysqld_exporter 用户</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">tee &gt; .db.cnf &lt;&lt; EOF\n[client]\nuser&#x3D;mysqld_exporter\npassword&#x3D;keyword@2020\nEOF<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"3-下载\"><a href=\"#3-下载\" class=\"headerlink\" title=\"3. 下载\"></a>3. 下载</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;mysqld_exporter&#x2F;releases&#x2F;download&#x2F;v0.15.1&#x2F;mysqld_exporter-0.15.1.linux-amd64.tar.gz\ntar xvf mysqld_exporter-0.15.1.linux-amd64.tar.gz\nsudo mv mysqld_exporter-0.15.1.linux-amd64&#x2F;mysqld_exporter &#x2F;usr&#x2F;local&#x2F;bin&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"4-使用-systemd-管理\"><a href=\"#4-使用-systemd-管理\" class=\"headerlink\" title=\"4. 使用 systemd 管理\"></a>4. 使用 systemd 管理</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo tee &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;mysqld_exporter.service &lt;&lt; EOF\n[Unit]\nDescription&#x3D;mysql_exporter\nAfter&#x3D;network.target\n\n[Service]\nType&#x3D;simple\nExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;mysqld_exporter --config.my-cnf&#x3D;&quot;&#x2F;home&#x2F;keyword&#x2F;mysql&#x2F;.db.cnf&quot;\nRestart&#x3D;on-failure\n\n[Install]\nWantedBy&#x3D;multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable --now mysqld_exporter<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"5-此时可以去访问默认的-9104-metrics\"><a href=\"#5-此时可以去访问默认的-9104-metrics\" class=\"headerlink\" title=\"5. 此时可以去访问默认的 9104&#x2F;metrics\"></a>5. 此时可以去访问默认的 9104&#x2F;metrics</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: &#39;mysqld_exporter&#39;  \n  metrics_path: &#x2F;metrics  \n  static_configs:  \n  - targets:\n    - 10.1.0.81:9104<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-多源监测\"><a href=\"#6-多源监测\" class=\"headerlink\" title=\"6. 多源监测\"></a>6. 多源监测</h2><ul>\n<li>不用在每个 mysql 去安装 exporter</li>\n<li>在 .db.cnf 新增另一个数据库的监控专用用户信息; 保证服务端进行上述用户权限配置即可<pre class=\"line-numbers language-ini\" data-language=\"ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">client</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token key attr-name\">host</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">10.1.0.81</span>\n<span class=\"token key attr-name\">port</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">3306</span>\n<span class=\"token key attr-name\">user</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">mysqld_exporter</span>\n<span class=\"token key attr-name\">password</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">keyword@2020</span>\n\n<span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">client-db2</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token key attr-name\">host</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">10.8.0.90</span>\n<span class=\"token key attr-name\">port</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">3306</span>\n<span class=\"token key attr-name\">user</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">mysqld_exporter</span>\n<span class=\"token key attr-name\">password</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">keyword@2020</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<blockquote>\n<p>[!bug] 问题 1<br>Get “ <a href=\"http://10.8.0.90:3306/probe?auth_module=client-db2&target=10.8.0.90:3306\">http://10.8.0.90:3306/probe?auth_module=client-db2&amp;target=10.8.0.90%3A3306</a>“: dial tcp 10.8.0.90:3306: connect: connection refused</p>\n</blockquote>\n<blockquote>\n<p>[!Solution] 解决</p>\n<ol>\n<li>mysql bind-address 未修改，仍然限定的是其本身回环地址，’&#x2F;etc&#x2F;mysql&#x2F;mysql.conf.d&#x2F;mysqld.cnf’</li>\n<li>mysql 中，创建用户并管理 client 服务器地址需要正确限定， user@client ip &#x2F; 网段</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>[!bug] 问题 2<br>Get “ <a href=\"http://10.1.0.81:3306/probe?auth_module=client&target=10.1.0.81:3306\">http://10.1.0.81:3306/probe?auth_module=client&amp;target=10.1.0.81%3A3306</a>“: net&#x2F;http: HTTP&#x2F;1.x transport connection broken: malformed HTTP status code “‘172.22.0.2’”<br>修改 prometheus.yml 之后正常</p>\n</blockquote>\n<p>调整后的最终版本 prometheus.yml</p>\n<pre class=\"line-numbers language-Yaml\" data-language=\"Yaml\"><div class=\"caption\"><span>TI：\"successful version\"</span></div><code class=\"language-Yaml\">- job_name: &#39;multiple_mysql&#39;\n  static_configs: #也可以将此替换为其他的服务发现配置\n    - targets:\n        - 10.1.0.81:3306  # mysql 1\n      labels:\n        modes: Master  # 自己定义的标签\n        auth_module: client  # 必须指定，值来源于用户信息的cnf文件中，如果多个数据库使用的用户相同，可以使用同一个auth配置\n    - targets:\n        - 10.8.0.90:3306  # mysql 2\n      labels:\n        modes: slave\n        auth_module: client-db2\n  relabel_configs:\n    # 核心是获取 &#96;__parm_target&#96; 就是 上面params抓取的target\n    - source_labels: [__address__]\n      target_label: __param_target\n    - source_labels: [__param_target]\n      target_label: instance\n    # 配置后只有此 endpoint，是 exporter 的地址， target 将成为标签\n    - target_label: __address__\n      replacement: 10.1.0.81:9104\n    # 下面将把 auth_module 这个标签的值替换为__param_auth_module的值，__param_auth_module即上方static_configs下的params配置\n    - source_labels: [auth_module]\n      target_label: __param_auth_module\n    # 下面将删除 auth_module 这个标签\n    - action: labeldrop\n      regex: auth_module<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"7-reference\"><a href=\"#7-reference\" class=\"headerlink\" title=\"7. reference\"></a>7. reference</h2><p>   <a href=\"https://www.modb.pro/db/565900\">技术分享 | mysqld_exporter 收集多个 MySQL 监控避坑 - 墨天轮</a></p>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"1-前置条件\"><a href=\"#1-前置条件\" class=\"headerlink\" title=\"1.前置条件\"></a>1.前置条件</h2><p> mysql 中准备暴露指标的用户和主机地址( exporter  ip)，并在相应表中必要授权</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">CREATE <span class=\"token environment constant\">USER</span> <span class=\"token string\">'mysqld_exporter'</span>@<span class=\"token string\">'10.1.0.81'</span> IDENTIFIED BY <span class=\"token string\">'keyword@2020'</span><span class=\"token punctuation\">;</span>\nGRANT REPLICATION CLIENT, PROCESS ON *.* TO <span class=\"token string\">'mysqld_exporter'</span>@<span class=\"token string\">'10.1.0.81'</span><span class=\"token punctuation\">;</span>\nGRANT SELECT ON performance_schema.* TO <span class=\"token string\">'mysqld_exporter'</span>@<span class=\"token string\">'10.1.0.81'</span><span class=\"token punctuation\">;</span>\nFLUSH PRIVILEGES<span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"2-配置-mysqld-exporter-用户\"><a href=\"#2-配置-mysqld-exporter-用户\" class=\"headerlink\" title=\"2. 配置 mysqld_exporter 用户\"></a>2. 配置 mysqld_exporter 用户</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">tee &gt; .db.cnf &lt;&lt; EOF\n[client]\nuser&#x3D;mysqld_exporter\npassword&#x3D;keyword@2020\nEOF<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"3-下载\"><a href=\"#3-下载\" class=\"headerlink\" title=\"3. 下载\"></a>3. 下载</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;mysqld_exporter&#x2F;releases&#x2F;download&#x2F;v0.15.1&#x2F;mysqld_exporter-0.15.1.linux-amd64.tar.gz\ntar xvf mysqld_exporter-0.15.1.linux-amd64.tar.gz\nsudo mv mysqld_exporter-0.15.1.linux-amd64&#x2F;mysqld_exporter &#x2F;usr&#x2F;local&#x2F;bin&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"4-使用-systemd-管理\"><a href=\"#4-使用-systemd-管理\" class=\"headerlink\" title=\"4. 使用 systemd 管理\"></a>4. 使用 systemd 管理</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">sudo tee &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;mysqld_exporter.service &lt;&lt; EOF\n[Unit]\nDescription&#x3D;mysql_exporter\nAfter&#x3D;network.target\n\n[Service]\nType&#x3D;simple\nExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;mysqld_exporter --config.my-cnf&#x3D;&quot;&#x2F;home&#x2F;keyword&#x2F;mysql&#x2F;.db.cnf&quot;\nRestart&#x3D;on-failure\n\n[Install]\nWantedBy&#x3D;multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable --now mysqld_exporter<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"5-此时可以去访问默认的-9104-metrics\"><a href=\"#5-此时可以去访问默认的-9104-metrics\" class=\"headerlink\" title=\"5. 此时可以去访问默认的 9104&#x2F;metrics\"></a>5. 此时可以去访问默认的 9104&#x2F;metrics</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">- job_name: &#39;mysqld_exporter&#39;  \n  metrics_path: &#x2F;metrics  \n  static_configs:  \n  - targets:\n    - 10.1.0.81:9104<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-多源监测\"><a href=\"#6-多源监测\" class=\"headerlink\" title=\"6. 多源监测\"></a>6. 多源监测</h2><ul>\n<li>不用在每个 mysql 去安装 exporter</li>\n<li>在 .db.cnf 新增另一个数据库的监控专用用户信息; 保证服务端进行上述用户权限配置即可<pre class=\"line-numbers language-ini\" data-language=\"ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">client</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token key attr-name\">host</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">10.1.0.81</span>\n<span class=\"token key attr-name\">port</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">3306</span>\n<span class=\"token key attr-name\">user</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">mysqld_exporter</span>\n<span class=\"token key attr-name\">password</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">keyword@2020</span>\n\n<span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">client-db2</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token key attr-name\">host</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">10.8.0.90</span>\n<span class=\"token key attr-name\">port</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">3306</span>\n<span class=\"token key attr-name\">user</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">mysqld_exporter</span>\n<span class=\"token key attr-name\">password</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">keyword@2020</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<blockquote>\n<p>[!bug] 问题 1<br>Get “ <a href=\"http://10.8.0.90:3306/probe?auth_module=client-db2&target=10.8.0.90:3306\">http://10.8.0.90:3306/probe?auth_module=client-db2&amp;target=10.8.0.90%3A3306</a>“: dial tcp 10.8.0.90:3306: connect: connection refused</p>\n</blockquote>\n<blockquote>\n<p>[!Solution] 解决</p>\n<ol>\n<li>mysql bind-address 未修改，仍然限定的是其本身回环地址，’&#x2F;etc&#x2F;mysql&#x2F;mysql.conf.d&#x2F;mysqld.cnf’</li>\n<li>mysql 中，创建用户并管理 client 服务器地址需要正确限定， user@client ip &#x2F; 网段</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>[!bug] 问题 2<br>Get “ <a href=\"http://10.1.0.81:3306/probe?auth_module=client&target=10.1.0.81:3306\">http://10.1.0.81:3306/probe?auth_module=client&amp;target=10.1.0.81%3A3306</a>“: net&#x2F;http: HTTP&#x2F;1.x transport connection broken: malformed HTTP status code “‘172.22.0.2’”<br>修改 prometheus.yml 之后正常</p>\n</blockquote>\n<p>调整后的最终版本 prometheus.yml</p>\n<pre class=\"line-numbers language-Yaml\" data-language=\"Yaml\"><div class=\"caption\"><span>TI：\"successful version\"</span></div><code class=\"language-Yaml\">- job_name: &#39;multiple_mysql&#39;\n  static_configs: #也可以将此替换为其他的服务发现配置\n    - targets:\n        - 10.1.0.81:3306  # mysql 1\n      labels:\n        modes: Master  # 自己定义的标签\n        auth_module: client  # 必须指定，值来源于用户信息的cnf文件中，如果多个数据库使用的用户相同，可以使用同一个auth配置\n    - targets:\n        - 10.8.0.90:3306  # mysql 2\n      labels:\n        modes: slave\n        auth_module: client-db2\n  relabel_configs:\n    # 核心是获取 &#96;__parm_target&#96; 就是 上面params抓取的target\n    - source_labels: [__address__]\n      target_label: __param_target\n    - source_labels: [__param_target]\n      target_label: instance\n    # 配置后只有此 endpoint，是 exporter 的地址， target 将成为标签\n    - target_label: __address__\n      replacement: 10.1.0.81:9104\n    # 下面将把 auth_module 这个标签的值替换为__param_auth_module的值，__param_auth_module即上方static_configs下的params配置\n    - source_labels: [auth_module]\n      target_label: __param_auth_module\n    # 下面将删除 auth_module 这个标签\n    - action: labeldrop\n      regex: auth_module<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"7-reference\"><a href=\"#7-reference\" class=\"headerlink\" title=\"7. reference\"></a>7. reference</h2><p>   <a href=\"https://www.modb.pro/db/565900\">技术分享 | mysqld_exporter 收集多个 MySQL 监控避坑 - 墨天轮</a></p>\n"},{"title":"redis-exporter","author":"LC","toc":true,"date":"2024-04-30T15:20:00.000Z","img":null,"top":null,"cover":null,"password":null,"summary":"redis 集群 prometheus 指标导出","_content":"\n## 1. 下载并解压二进制文件\n#### 在一个节点启用本工具即可\n```bash\nwget https://github.com/oliver006/redis_exporter/releases/download/v1.58.0/redis_exporter-v1.58.0.linux-amd64.tar.gz\ntar -xvf redis_exporter-v1.58.0.linux-amd64.tar.gz \nsudo mv redis_exporter-v1.58.0.linux-amd64/redis_exporter  /usr/local/bin/\n\nsudo tee -a /etc/systemd/system/redis_exporter.service << EOF\n[Unit]\nDescription=Redis Exporter\nAfter=network.target\n\n[Service]\ntype=forking\nExecStart=redis_exporter -redis.addr 10.8.0.88:6379 -redis.password keyword@2020 -web.listen-address 10.8.0.88:9121  # -redis.password 应该是配置中的 requirepass 的值\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable --now redis_exporter.service\n```\n\n## 2. 查看指标\n`curl 10.8.0.88:9121/metrics`\n\n## 3. Prometheus\n```yaml\n  - job_name: 'redis_exporter_targets'\n    static_configs:\n      - targets:\n        - redis://10.8.0.88:6379\n        - redis://10.8.0.88:6380\n        - redis://10.8.0.89:6379\n        - redis://10.8.0.89:6380\n        - redis://10.8.0.90:6379\n        - redis://10.8.0.90:6380\n    metrics_path: /scrape\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: 10.8.0.88:9121 #需要保留，此处为 exporter 地址\n```","source":"_posts/metrics/redis-exporter.md","raw":"---\ntitle: redis-exporter\nauthor: LC\ntoc: true\ndate: 2024-04-30 23:20:00\nimg:\ntop:\ncover:\npassword:\nsummary: redis 集群 prometheus 指标导出\ncategories: Opentelemetry\ntags: [metrics]\n---\n\n## 1. 下载并解压二进制文件\n#### 在一个节点启用本工具即可\n```bash\nwget https://github.com/oliver006/redis_exporter/releases/download/v1.58.0/redis_exporter-v1.58.0.linux-amd64.tar.gz\ntar -xvf redis_exporter-v1.58.0.linux-amd64.tar.gz \nsudo mv redis_exporter-v1.58.0.linux-amd64/redis_exporter  /usr/local/bin/\n\nsudo tee -a /etc/systemd/system/redis_exporter.service << EOF\n[Unit]\nDescription=Redis Exporter\nAfter=network.target\n\n[Service]\ntype=forking\nExecStart=redis_exporter -redis.addr 10.8.0.88:6379 -redis.password keyword@2020 -web.listen-address 10.8.0.88:9121  # -redis.password 应该是配置中的 requirepass 的值\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable --now redis_exporter.service\n```\n\n## 2. 查看指标\n`curl 10.8.0.88:9121/metrics`\n\n## 3. Prometheus\n```yaml\n  - job_name: 'redis_exporter_targets'\n    static_configs:\n      - targets:\n        - redis://10.8.0.88:6379\n        - redis://10.8.0.88:6380\n        - redis://10.8.0.89:6379\n        - redis://10.8.0.89:6380\n        - redis://10.8.0.90:6379\n        - redis://10.8.0.90:6380\n    metrics_path: /scrape\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: 10.8.0.88:9121 #需要保留，此处为 exporter 地址\n```","slug":"metrics/redis-exporter","published":1,"updated":"2024-04-30T16:28:35.975Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodk5001t80rv64z79km4","content":"<h2 id=\"1-下载并解压二进制文件\"><a href=\"#1-下载并解压二进制文件\" class=\"headerlink\" title=\"1. 下载并解压二进制文件\"></a>1. 下载并解压二进制文件</h2><h4 id=\"在一个节点启用本工具即可\"><a href=\"#在一个节点启用本工具即可\" class=\"headerlink\" title=\"在一个节点启用本工具即可\"></a>在一个节点启用本工具即可</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/oliver006/redis_exporter/releases/download/v1.58.0/redis_exporter-v1.58.0.linux-amd64.tar.gz\n<span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvf</span> redis_exporter-v1.58.0.linux-amd64.tar.gz \n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> redis_exporter-v1.58.0.linux-amd64/redis_exporter  /usr/local/bin/\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> /etc/systemd/system/redis_exporter.service <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\n[Unit]\nDescription=Redis Exporter\nAfter=network.target\n\n[Service]\ntype=forking\nExecStart=redis_exporter -redis.addr 10.8.0.88:6379 -redis.password keyword@2020 -web.listen-address 10.8.0.88:9121  # -redis.password 应该是配置中的 requirepass 的值\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF</span>\n\n<span class=\"token function\">sudo</span> systemctl daemon-reload\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> redis_exporter.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-查看指标\"><a href=\"#2-查看指标\" class=\"headerlink\" title=\"2. 查看指标\"></a>2. 查看指标</h2><p><code>curl 10.8.0.88:9121/metrics</code></p>\n<h2 id=\"3-Prometheus\"><a href=\"#3-Prometheus\" class=\"headerlink\" title=\"3. Prometheus\"></a>3. Prometheus</h2><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'redis_exporter_targets'</span>\n  <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.88<span class=\"token punctuation\">:</span><span class=\"token number\">6379</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.88<span class=\"token punctuation\">:</span><span class=\"token number\">6380</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.89<span class=\"token punctuation\">:</span><span class=\"token number\">6379</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.89<span class=\"token punctuation\">:</span><span class=\"token number\">6380</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.90<span class=\"token punctuation\">:</span><span class=\"token number\">6379</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.90<span class=\"token punctuation\">:</span><span class=\"token number\">6380</span>\n  <span class=\"token key atrule\">metrics_path</span><span class=\"token punctuation\">:</span> /scrape\n  <span class=\"token key atrule\">relabel_configs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__address__<span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __param_target\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__param_target<span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> instance\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __address__\n      <span class=\"token key atrule\">replacement</span><span class=\"token punctuation\">:</span> 10.8.0.88<span class=\"token punctuation\">:</span><span class=\"token number\">9121</span> <span class=\"token comment\">#需要保留，此处为 exporter 地址</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h2 id=\"1-下载并解压二进制文件\"><a href=\"#1-下载并解压二进制文件\" class=\"headerlink\" title=\"1. 下载并解压二进制文件\"></a>1. 下载并解压二进制文件</h2><h4 id=\"在一个节点启用本工具即可\"><a href=\"#在一个节点启用本工具即可\" class=\"headerlink\" title=\"在一个节点启用本工具即可\"></a>在一个节点启用本工具即可</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/oliver006/redis_exporter/releases/download/v1.58.0/redis_exporter-v1.58.0.linux-amd64.tar.gz\n<span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvf</span> redis_exporter-v1.58.0.linux-amd64.tar.gz \n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> redis_exporter-v1.58.0.linux-amd64/redis_exporter  /usr/local/bin/\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> /etc/systemd/system/redis_exporter.service <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\n[Unit]\nDescription=Redis Exporter\nAfter=network.target\n\n[Service]\ntype=forking\nExecStart=redis_exporter -redis.addr 10.8.0.88:6379 -redis.password keyword@2020 -web.listen-address 10.8.0.88:9121  # -redis.password 应该是配置中的 requirepass 的值\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF</span>\n\n<span class=\"token function\">sudo</span> systemctl daemon-reload\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> redis_exporter.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-查看指标\"><a href=\"#2-查看指标\" class=\"headerlink\" title=\"2. 查看指标\"></a>2. 查看指标</h2><p><code>curl 10.8.0.88:9121/metrics</code></p>\n<h2 id=\"3-Prometheus\"><a href=\"#3-Prometheus\" class=\"headerlink\" title=\"3. Prometheus\"></a>3. Prometheus</h2><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'redis_exporter_targets'</span>\n  <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.88<span class=\"token punctuation\">:</span><span class=\"token number\">6379</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.88<span class=\"token punctuation\">:</span><span class=\"token number\">6380</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.89<span class=\"token punctuation\">:</span><span class=\"token number\">6379</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.89<span class=\"token punctuation\">:</span><span class=\"token number\">6380</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.90<span class=\"token punctuation\">:</span><span class=\"token number\">6379</span>\n      <span class=\"token punctuation\">-</span> redis<span class=\"token punctuation\">:</span>//10.8.0.90<span class=\"token punctuation\">:</span><span class=\"token number\">6380</span>\n  <span class=\"token key atrule\">metrics_path</span><span class=\"token punctuation\">:</span> /scrape\n  <span class=\"token key atrule\">relabel_configs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__address__<span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __param_target\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__param_target<span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> instance\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __address__\n      <span class=\"token key atrule\">replacement</span><span class=\"token punctuation\">:</span> 10.8.0.88<span class=\"token punctuation\">:</span><span class=\"token number\">9121</span> <span class=\"token comment\">#需要保留，此处为 exporter 地址</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>"},{"title":"vault","author":"LC","toc":true,"date":"2024-04-30T15:15:54.000Z","img":null,"top":true,"cover":null,"password":null,"summary":"helm 单节点部署 vault 并配置指标导出","_content":"\n# 以下是在 kubernetes 集群的自动发现\n## vault helm chart\n### 保证 server.standalone  config 配置如下\n```\nconfig: |\n      ui = true\n\n      listener \"tcp\" {\n        tls_disable = 1\n        address = \"[::]:8200\"\n        cluster_address = \"[::]:8201\"\n        # Enable unauthenticated metrics access (necessary for Prometheus Operator)\n        telemetry {\n          unauthenticated_metrics_access = \"true\"\n        }\n      }\n      storage \"file\" {\n        path = \"/vault/data\"\n      }\n      # Example configuration for enabling Prometheus metrics in your config. 必须配置\n      telemetry {\n        prometheus_retention_time = \"3d\"\n        disable_hostname = true\n      }\n```\n### 需要开启 servicemonitor \n`serverTelemetry.serviceMonitor.enabled：true`\n\n验证 service： nextcloud-metrics 是否存在annotations： prometheus.io/scrape == true ；存在将可以自动发现\n\n### Debug\n服务成功发现，但是 prometheus targets 中报错 `server returned HTTP status 400 Bad Request` ，以下是集群内 curl 容器 api 的结果\n```\ncurl  10.42.169.106:8200/v1/sys/metrics/\n{\"errors\":[\"permission denied\"]}\n\ncurl  10.42.169.106:8200/v1/sys/metrics \n{\"Timestamp\":\"2024-04-15 03:07:50 +0000 UTC\",\"Gauges\":[{\"Name\":\"vault.core.active\",\"Value\":1,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.in_flight_requests\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.mount_table.num_entries\",\"Value\":1,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"false\",\"type\":\"auth\"}},{\"Name\":\"vault.core.mount_table.num_entries\",\"Value\":2,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"false\",\"type\":\"logical\"}},{\"Name\":\"vault.core.mount_table.num_entries\",\"Value\":1,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"true\",\"type\":\"logical\"}},{\"Name\":\"vault.core.mount_table.size\",\"Value\":253,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"false\",\"type\":\"auth\"}},{\"Name\":\"vault.core.mount_table.size\",\"Value\":447,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"false\",\"type\":\"logical\"}},{\"Name\":\"vault.core.mount_table.size\",\"Value\":302,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"true\",\"type\":\"logical\"}},{\"Name\":\"vault.core.performance_standby\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.dr.primary\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.dr.secondary\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.performance.primary\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.performance.secondary\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.write_undo_logs\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.unsealed\",\"Value\":1,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.expire.num_irrevocable_leases\",\"Value\":0,\"Labels\":{}},{\"Name\":\"vault.expire.num_leases\",\"Value\":0,\"Labels\":{}},{\"Name\":\"vault.runtime.alloc_bytes\",\"Value\":47050330,\"Labels\":{}},{\"Name\":\"vault.runtime.free_count\",\"Value\":115420530,\"Labels\":{}},{\"Name\":\"vault.runtime.heap_objects\",\"Value\":92536,\"Labels\":{}},{\"Name\":\"vault.runtime.malloc_count\",\"Value\":115513064,\"Labels\":{}},{\"Name\":\"vault.runtime.num_goroutines\",\"Value\":224,\"Labels\":{}},{\"Name\":\"vault.runtime.sys_bytes\",\"Value\":81191190,\"Labels\":{}},{\"Name\":\"vault.runtime.total_gc_pause_ns\",\"Value\":345062720,\"Labels\":{}},{\"Name\":\"vault.runtime.total_gc_runs\",\"Value\":2005,\"Labels\":{}}],\"Points\":[],\"Counters\":[{\"Name\":\"vault.audit.log_request_failure\",\"Count\":1,\"Rate\":0,\"Sum\":0,\"Min\":0,\"Max\":0,\"Mean\":0,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.audit.log_response_failure\",\"Count\":1,\"Rate\":0,\"Sum\":0,\"Min\":0,\"Max\":0,\"Mean\":0,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.cache.hit\",\"Count\":2,\"Rate\":0.2,\"Sum\":2,\"Min\":1,\"Max\":1,\"Mean\":1,\"Stddev\":0,\"Labels\":{}}],\"Samples\":[{\"Name\":\"vault.audit.log_request\",\"Count\":1,\"Rate\":0.00067349998280406,\"Sum\":0.0067349998280406,\"Min\":0.0067349998280406,\"Max\":0.0067349998280406,\"Mean\":0.0067349998280406,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.audit.log_response\",\"Count\":1,\"Rate\":0.00048179998993873595,\"Sum\":0.00481799989938736,\"Min\":0.00481799989938736,\"Max\":0.00481799989938736,\"Mean\":0.00481799989938736,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.barrier.get\",\"Count\":2,\"Rate\":0.007432200014591217,\"Sum\":0.07432200014591217,\"Min\":0.027681000530719757,\"Max\":0.04664099961519241,\"Mean\":0.037161000072956085,\"Stddev\":0.013406743923921348,\"Labels\":{}},{\"Name\":\"vault.core.check_token\",\"Count\":1,\"Rate\":0.01593659967184067,\"Sum\":0.15936599671840668,\"Min\":0.15936599671840668,\"Max\":0.15936599671840668,\"Mean\":0.15936599671840668,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.core.fetch_acl_and_token\",\"Count\":1,\"Rate\":0.014495299756526947,\"Sum\":0.14495299756526947,\"Min\":0.14495299756526947,\"Max\":0.14495299756526947,\"Mean\":0.14495299756526947,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.core.handle_request\",\"Count\":1,\"Rate\":0.019178299605846404,\"Sum\":0.19178299605846405,\"Min\":0.19178299605846405,\"Max\":0.19178299605846405,\"Mean\":0.19178299605846405,\"Stddev\":0,\"Labels\":{}}]}\n\ncurl  10.42.169.106:8200/v1/sys/metrics?format=\"prometheus\"\nprometheus is not enabled> \n```\n\n多次排查之后发现并无特别的问题，helm 部署之后多次修改调整 values 后，config 没有成功生效，其中的值没有成功传入容器。删除应用后重新安装转为正常。\n\n# 以下是将metrics暴露到集群外\n## 2. telemetry 授权\n### 2.1 在单节点配置文件部分添加这个块\n```\ntelemetry {\n        prometheus_retention_time = \"30s\"\n        disable_hostname = true\n}\n```\n2.2 为 prometheus 创建访问的 token\n- 权限\n```\nvault policy write prometheus-metrics - << EOF\npath \"/sys/metrics\" {\n  capabilities = [\"read\"]\n}\nEOF\n```\n- 创建具有权限的 token\n```\nvault token create \\\n  -field=token \\\n  -policy prometheus-metrics \\\n  > prometheus-token\n```\n\n将上方生成的 token 给予 prom。\n## 3. prometheus 的配置\n```bash\ncat > prometheus.yml << EOF\nscrape_configs:\n  - job_name: vault\n    metrics_path: /v1/sys/metrics\n    params:\n      format: ['prometheus']\n    scheme: http\n    authorization:\n      credentials_file: /etc/prometheus/prometheus-token #使用 token\n    static_configs:\n    - targets: ['10.8.0.151:8200']\nEOF\n```\nprom 热加载 `curl -X POST http://xxxx/-/reload`\n\n\n##  初次尝试时 helm 主要修改内容\n参考helm中 config 部分\nvalues.yaml \n```yaml TI:\"values\"\n\nglobal.datastorage:\n\nserver:\n  standalone:\n    config: >\n      ui = true\n      listener \"tcp\" {\n        tls_disable = 1\n        address = \"[::]:8200\"\n        cluster_address = \"[::]:8201\"\n        # Enable unauthenticated metrics access (necessary for Prometheus Operator)\n        telemetry {\n          unauthenticated_metrics_access = \"true\"\n          unauthenticated_in_flight_request_access = \"true\" #此项应该无关prom metrics\n        }\n      }\n\n      storage \"file\" {\n        path = \"/vault/data\"\n      }    \n\n      # Example configuration for enabling Prometheus metrics in your config; when post outside your cluster\n      telemetry {\n        prometheus_retention_time = \"3d\"\n        disable_hostname = true\n      }\n    enabled: 'true'\n  statefulSet:\n    annotations: {}\n    securityContext:\n      container: {}\n      pod: {}\n  terminationGracePeriodSeconds: 10\n  tolerations: []\n  topologySpreadConstraints: []\n  updateStrategyType: OnDelete\n  volumeMounts: null\n  volumes: null\nserverTelemetry:\n  prometheusRules:\n    enabled: true\n    rules: []\n    selectors: {}\n  serviceMonitor:\n    enabled: true\n    interval: 30s\n    scrapeTimeout: 10s\n    selectors: {}\n```\n\n- 当前只是 standalone 配置\n- server unseal 之后才能正常访问 UI\n\n>[!failure]\n> vault logs： `core: security barrier not initialized`\n> \n\n>[!info]\n> ```\n> / $ vault operator init #进入容器执行\nUnseal Key 1: D9apO9R7M9hL0PQaSByJ9pAEGy3EMIJZIrQDx+bHwhpy\nUnseal Key 2: 0ixkSa4BM7X8Tre4F1JQDCR06m/AEtRUPD6DwvfecwD+\nUnseal Key 3: 3y/sowvniDzofLE3AQnzvXujQSE894ocaQO61YTbU+r2\nUnseal Key 4: dhkVbYBR7xqdl/Q+/QvvU9PofKdXu+OiYseqRuH8N7eo\nUnseal Key 5: 5lP9+P6S/pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRo\n>\nInitial Root Token: hvs.UKtqCCot92t6cSlxsM7SW5br\n>\nVault initialized with 5 key shares and a key threshold of 3. Please securely\ndistribute the key shares printed above. When the Vault is re-sealed,\nrestarted, or stopped, you must supply at least 3 of these keys to unseal it\nbefore it can start servicing requests.\n>\nVault does not store the generated root key. Without at least 3 keys to\nreconstruct the root key, Vault will remain permanently sealed!\n>\nIt is possible to generate new unseal keys, provided you have a quorum of\nexisting unseal keys shares. See \"vault operator rekey\" for more information.\n> \n>/ $ vault operator unseal 5lP9+P6S/pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRo  # 利用上述key，重复执行3次即可解封vault，这个pod将正常\n> ```","source":"_posts/metrics/vault.md","raw":"---\ntitle: vault\nauthor: LC\ntoc: true\ndate: 2024-04-30 23:15:54\nimg:\ntop: true\ncover:\npassword:\nsummary: helm 单节点部署 vault 并配置指标导出\ncategories: kubernetes\ntags: ['vault','metrics']\n---\n\n# 以下是在 kubernetes 集群的自动发现\n## vault helm chart\n### 保证 server.standalone  config 配置如下\n```\nconfig: |\n      ui = true\n\n      listener \"tcp\" {\n        tls_disable = 1\n        address = \"[::]:8200\"\n        cluster_address = \"[::]:8201\"\n        # Enable unauthenticated metrics access (necessary for Prometheus Operator)\n        telemetry {\n          unauthenticated_metrics_access = \"true\"\n        }\n      }\n      storage \"file\" {\n        path = \"/vault/data\"\n      }\n      # Example configuration for enabling Prometheus metrics in your config. 必须配置\n      telemetry {\n        prometheus_retention_time = \"3d\"\n        disable_hostname = true\n      }\n```\n### 需要开启 servicemonitor \n`serverTelemetry.serviceMonitor.enabled：true`\n\n验证 service： nextcloud-metrics 是否存在annotations： prometheus.io/scrape == true ；存在将可以自动发现\n\n### Debug\n服务成功发现，但是 prometheus targets 中报错 `server returned HTTP status 400 Bad Request` ，以下是集群内 curl 容器 api 的结果\n```\ncurl  10.42.169.106:8200/v1/sys/metrics/\n{\"errors\":[\"permission denied\"]}\n\ncurl  10.42.169.106:8200/v1/sys/metrics \n{\"Timestamp\":\"2024-04-15 03:07:50 +0000 UTC\",\"Gauges\":[{\"Name\":\"vault.core.active\",\"Value\":1,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.in_flight_requests\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.mount_table.num_entries\",\"Value\":1,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"false\",\"type\":\"auth\"}},{\"Name\":\"vault.core.mount_table.num_entries\",\"Value\":2,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"false\",\"type\":\"logical\"}},{\"Name\":\"vault.core.mount_table.num_entries\",\"Value\":1,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"true\",\"type\":\"logical\"}},{\"Name\":\"vault.core.mount_table.size\",\"Value\":253,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"false\",\"type\":\"auth\"}},{\"Name\":\"vault.core.mount_table.size\",\"Value\":447,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"false\",\"type\":\"logical\"}},{\"Name\":\"vault.core.mount_table.size\",\"Value\":302,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\",\"local\":\"true\",\"type\":\"logical\"}},{\"Name\":\"vault.core.performance_standby\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.dr.primary\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.dr.secondary\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.performance.primary\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.performance.secondary\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.replication.write_undo_logs\",\"Value\":0,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.core.unsealed\",\"Value\":1,\"Labels\":{\"cluster\":\"vault-cluster-d79f20a5\"}},{\"Name\":\"vault.expire.num_irrevocable_leases\",\"Value\":0,\"Labels\":{}},{\"Name\":\"vault.expire.num_leases\",\"Value\":0,\"Labels\":{}},{\"Name\":\"vault.runtime.alloc_bytes\",\"Value\":47050330,\"Labels\":{}},{\"Name\":\"vault.runtime.free_count\",\"Value\":115420530,\"Labels\":{}},{\"Name\":\"vault.runtime.heap_objects\",\"Value\":92536,\"Labels\":{}},{\"Name\":\"vault.runtime.malloc_count\",\"Value\":115513064,\"Labels\":{}},{\"Name\":\"vault.runtime.num_goroutines\",\"Value\":224,\"Labels\":{}},{\"Name\":\"vault.runtime.sys_bytes\",\"Value\":81191190,\"Labels\":{}},{\"Name\":\"vault.runtime.total_gc_pause_ns\",\"Value\":345062720,\"Labels\":{}},{\"Name\":\"vault.runtime.total_gc_runs\",\"Value\":2005,\"Labels\":{}}],\"Points\":[],\"Counters\":[{\"Name\":\"vault.audit.log_request_failure\",\"Count\":1,\"Rate\":0,\"Sum\":0,\"Min\":0,\"Max\":0,\"Mean\":0,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.audit.log_response_failure\",\"Count\":1,\"Rate\":0,\"Sum\":0,\"Min\":0,\"Max\":0,\"Mean\":0,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.cache.hit\",\"Count\":2,\"Rate\":0.2,\"Sum\":2,\"Min\":1,\"Max\":1,\"Mean\":1,\"Stddev\":0,\"Labels\":{}}],\"Samples\":[{\"Name\":\"vault.audit.log_request\",\"Count\":1,\"Rate\":0.00067349998280406,\"Sum\":0.0067349998280406,\"Min\":0.0067349998280406,\"Max\":0.0067349998280406,\"Mean\":0.0067349998280406,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.audit.log_response\",\"Count\":1,\"Rate\":0.00048179998993873595,\"Sum\":0.00481799989938736,\"Min\":0.00481799989938736,\"Max\":0.00481799989938736,\"Mean\":0.00481799989938736,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.barrier.get\",\"Count\":2,\"Rate\":0.007432200014591217,\"Sum\":0.07432200014591217,\"Min\":0.027681000530719757,\"Max\":0.04664099961519241,\"Mean\":0.037161000072956085,\"Stddev\":0.013406743923921348,\"Labels\":{}},{\"Name\":\"vault.core.check_token\",\"Count\":1,\"Rate\":0.01593659967184067,\"Sum\":0.15936599671840668,\"Min\":0.15936599671840668,\"Max\":0.15936599671840668,\"Mean\":0.15936599671840668,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.core.fetch_acl_and_token\",\"Count\":1,\"Rate\":0.014495299756526947,\"Sum\":0.14495299756526947,\"Min\":0.14495299756526947,\"Max\":0.14495299756526947,\"Mean\":0.14495299756526947,\"Stddev\":0,\"Labels\":{}},{\"Name\":\"vault.core.handle_request\",\"Count\":1,\"Rate\":0.019178299605846404,\"Sum\":0.19178299605846405,\"Min\":0.19178299605846405,\"Max\":0.19178299605846405,\"Mean\":0.19178299605846405,\"Stddev\":0,\"Labels\":{}}]}\n\ncurl  10.42.169.106:8200/v1/sys/metrics?format=\"prometheus\"\nprometheus is not enabled> \n```\n\n多次排查之后发现并无特别的问题，helm 部署之后多次修改调整 values 后，config 没有成功生效，其中的值没有成功传入容器。删除应用后重新安装转为正常。\n\n# 以下是将metrics暴露到集群外\n## 2. telemetry 授权\n### 2.1 在单节点配置文件部分添加这个块\n```\ntelemetry {\n        prometheus_retention_time = \"30s\"\n        disable_hostname = true\n}\n```\n2.2 为 prometheus 创建访问的 token\n- 权限\n```\nvault policy write prometheus-metrics - << EOF\npath \"/sys/metrics\" {\n  capabilities = [\"read\"]\n}\nEOF\n```\n- 创建具有权限的 token\n```\nvault token create \\\n  -field=token \\\n  -policy prometheus-metrics \\\n  > prometheus-token\n```\n\n将上方生成的 token 给予 prom。\n## 3. prometheus 的配置\n```bash\ncat > prometheus.yml << EOF\nscrape_configs:\n  - job_name: vault\n    metrics_path: /v1/sys/metrics\n    params:\n      format: ['prometheus']\n    scheme: http\n    authorization:\n      credentials_file: /etc/prometheus/prometheus-token #使用 token\n    static_configs:\n    - targets: ['10.8.0.151:8200']\nEOF\n```\nprom 热加载 `curl -X POST http://xxxx/-/reload`\n\n\n##  初次尝试时 helm 主要修改内容\n参考helm中 config 部分\nvalues.yaml \n```yaml TI:\"values\"\n\nglobal.datastorage:\n\nserver:\n  standalone:\n    config: >\n      ui = true\n      listener \"tcp\" {\n        tls_disable = 1\n        address = \"[::]:8200\"\n        cluster_address = \"[::]:8201\"\n        # Enable unauthenticated metrics access (necessary for Prometheus Operator)\n        telemetry {\n          unauthenticated_metrics_access = \"true\"\n          unauthenticated_in_flight_request_access = \"true\" #此项应该无关prom metrics\n        }\n      }\n\n      storage \"file\" {\n        path = \"/vault/data\"\n      }    \n\n      # Example configuration for enabling Prometheus metrics in your config; when post outside your cluster\n      telemetry {\n        prometheus_retention_time = \"3d\"\n        disable_hostname = true\n      }\n    enabled: 'true'\n  statefulSet:\n    annotations: {}\n    securityContext:\n      container: {}\n      pod: {}\n  terminationGracePeriodSeconds: 10\n  tolerations: []\n  topologySpreadConstraints: []\n  updateStrategyType: OnDelete\n  volumeMounts: null\n  volumes: null\nserverTelemetry:\n  prometheusRules:\n    enabled: true\n    rules: []\n    selectors: {}\n  serviceMonitor:\n    enabled: true\n    interval: 30s\n    scrapeTimeout: 10s\n    selectors: {}\n```\n\n- 当前只是 standalone 配置\n- server unseal 之后才能正常访问 UI\n\n>[!failure]\n> vault logs： `core: security barrier not initialized`\n> \n\n>[!info]\n> ```\n> / $ vault operator init #进入容器执行\nUnseal Key 1: D9apO9R7M9hL0PQaSByJ9pAEGy3EMIJZIrQDx+bHwhpy\nUnseal Key 2: 0ixkSa4BM7X8Tre4F1JQDCR06m/AEtRUPD6DwvfecwD+\nUnseal Key 3: 3y/sowvniDzofLE3AQnzvXujQSE894ocaQO61YTbU+r2\nUnseal Key 4: dhkVbYBR7xqdl/Q+/QvvU9PofKdXu+OiYseqRuH8N7eo\nUnseal Key 5: 5lP9+P6S/pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRo\n>\nInitial Root Token: hvs.UKtqCCot92t6cSlxsM7SW5br\n>\nVault initialized with 5 key shares and a key threshold of 3. Please securely\ndistribute the key shares printed above. When the Vault is re-sealed,\nrestarted, or stopped, you must supply at least 3 of these keys to unseal it\nbefore it can start servicing requests.\n>\nVault does not store the generated root key. Without at least 3 keys to\nreconstruct the root key, Vault will remain permanently sealed!\n>\nIt is possible to generate new unseal keys, provided you have a quorum of\nexisting unseal keys shares. See \"vault operator rekey\" for more information.\n> \n>/ $ vault operator unseal 5lP9+P6S/pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRo  # 利用上述key，重复执行3次即可解封vault，这个pod将正常\n> ```","slug":"metrics/vault","published":1,"updated":"2024-04-30T16:55:55.751Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodk9001w80rva016eqku","content":"<h1 id=\"以下是在-kubernetes-集群的自动发现\"><a href=\"#以下是在-kubernetes-集群的自动发现\" class=\"headerlink\" title=\"以下是在 kubernetes 集群的自动发现\"></a>以下是在 kubernetes 集群的自动发现</h1><h2 id=\"vault-helm-chart\"><a href=\"#vault-helm-chart\" class=\"headerlink\" title=\"vault helm chart\"></a>vault helm chart</h2><h3 id=\"保证-server-standalone-config-配置如下\"><a href=\"#保证-server-standalone-config-配置如下\" class=\"headerlink\" title=\"保证 server.standalone  config 配置如下\"></a>保证 server.standalone  config 配置如下</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">config: |\n      ui &#x3D; true\n\n      listener &quot;tcp&quot; &#123;\n        tls_disable &#x3D; 1\n        address &#x3D; &quot;[::]:8200&quot;\n        cluster_address &#x3D; &quot;[::]:8201&quot;\n        # Enable unauthenticated metrics access (necessary for Prometheus Operator)\n        telemetry &#123;\n          unauthenticated_metrics_access &#x3D; &quot;true&quot;\n        &#125;\n      &#125;\n      storage &quot;file&quot; &#123;\n        path &#x3D; &quot;&#x2F;vault&#x2F;data&quot;\n      &#125;\n      # Example configuration for enabling Prometheus metrics in your config. 必须配置\n      telemetry &#123;\n        prometheus_retention_time &#x3D; &quot;3d&quot;\n        disable_hostname &#x3D; true\n      &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"需要开启-servicemonitor\"><a href=\"#需要开启-servicemonitor\" class=\"headerlink\" title=\"需要开启 servicemonitor\"></a>需要开启 servicemonitor</h3><p><code>serverTelemetry.serviceMonitor.enabled：true</code></p>\n<p>验证 service： nextcloud-metrics 是否存在annotations： prometheus.io&#x2F;scrape &#x3D;&#x3D; true ；存在将可以自动发现</p>\n<h3 id=\"Debug\"><a href=\"#Debug\" class=\"headerlink\" title=\"Debug\"></a>Debug</h3><p>服务成功发现，但是 prometheus targets 中报错 <code>server returned HTTP status 400 Bad Request</code> ，以下是集群内 curl 容器 api 的结果</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">curl  10.42.169.106:8200&#x2F;v1&#x2F;sys&#x2F;metrics&#x2F;\n&#123;&quot;errors&quot;:[&quot;permission denied&quot;]&#125;\n\ncurl  10.42.169.106:8200&#x2F;v1&#x2F;sys&#x2F;metrics \n&#123;&quot;Timestamp&quot;:&quot;2024-04-15 03:07:50 +0000 UTC&quot;,&quot;Gauges&quot;:[&#123;&quot;Name&quot;:&quot;vault.core.active&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.in_flight_requests&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.num_entries&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;auth&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.num_entries&quot;,&quot;Value&quot;:2,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.num_entries&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;true&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.size&quot;,&quot;Value&quot;:253,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;auth&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.size&quot;,&quot;Value&quot;:447,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.size&quot;,&quot;Value&quot;:302,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;true&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.performance_standby&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.dr.primary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.dr.secondary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.performance.primary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.performance.secondary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.write_undo_logs&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.unsealed&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.expire.num_irrevocable_leases&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.expire.num_leases&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.alloc_bytes&quot;,&quot;Value&quot;:47050330,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.free_count&quot;,&quot;Value&quot;:115420530,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.heap_objects&quot;,&quot;Value&quot;:92536,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.malloc_count&quot;,&quot;Value&quot;:115513064,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.num_goroutines&quot;,&quot;Value&quot;:224,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.sys_bytes&quot;,&quot;Value&quot;:81191190,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.total_gc_pause_ns&quot;,&quot;Value&quot;:345062720,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.total_gc_runs&quot;,&quot;Value&quot;:2005,&quot;Labels&quot;:&#123;&#125;&#125;],&quot;Points&quot;:[],&quot;Counters&quot;:[&#123;&quot;Name&quot;:&quot;vault.audit.log_request_failure&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0,&quot;Sum&quot;:0,&quot;Min&quot;:0,&quot;Max&quot;:0,&quot;Mean&quot;:0,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.audit.log_response_failure&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0,&quot;Sum&quot;:0,&quot;Min&quot;:0,&quot;Max&quot;:0,&quot;Mean&quot;:0,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.cache.hit&quot;,&quot;Count&quot;:2,&quot;Rate&quot;:0.2,&quot;Sum&quot;:2,&quot;Min&quot;:1,&quot;Max&quot;:1,&quot;Mean&quot;:1,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;],&quot;Samples&quot;:[&#123;&quot;Name&quot;:&quot;vault.audit.log_request&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.00067349998280406,&quot;Sum&quot;:0.0067349998280406,&quot;Min&quot;:0.0067349998280406,&quot;Max&quot;:0.0067349998280406,&quot;Mean&quot;:0.0067349998280406,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.audit.log_response&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.00048179998993873595,&quot;Sum&quot;:0.00481799989938736,&quot;Min&quot;:0.00481799989938736,&quot;Max&quot;:0.00481799989938736,&quot;Mean&quot;:0.00481799989938736,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.barrier.get&quot;,&quot;Count&quot;:2,&quot;Rate&quot;:0.007432200014591217,&quot;Sum&quot;:0.07432200014591217,&quot;Min&quot;:0.027681000530719757,&quot;Max&quot;:0.04664099961519241,&quot;Mean&quot;:0.037161000072956085,&quot;Stddev&quot;:0.013406743923921348,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.check_token&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.01593659967184067,&quot;Sum&quot;:0.15936599671840668,&quot;Min&quot;:0.15936599671840668,&quot;Max&quot;:0.15936599671840668,&quot;Mean&quot;:0.15936599671840668,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.fetch_acl_and_token&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.014495299756526947,&quot;Sum&quot;:0.14495299756526947,&quot;Min&quot;:0.14495299756526947,&quot;Max&quot;:0.14495299756526947,&quot;Mean&quot;:0.14495299756526947,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.handle_request&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.019178299605846404,&quot;Sum&quot;:0.19178299605846405,&quot;Min&quot;:0.19178299605846405,&quot;Max&quot;:0.19178299605846405,&quot;Mean&quot;:0.19178299605846405,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;]&#125;\n\ncurl  10.42.169.106:8200&#x2F;v1&#x2F;sys&#x2F;metrics?format&#x3D;&quot;prometheus&quot;\nprometheus is not enabled&gt; <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>多次排查之后发现并无特别的问题，helm 部署之后多次修改调整 values 后，config 没有成功生效，其中的值没有成功传入容器。删除应用后重新安装转为正常。</p>\n<h1 id=\"以下是将metrics暴露到集群外\"><a href=\"#以下是将metrics暴露到集群外\" class=\"headerlink\" title=\"以下是将metrics暴露到集群外\"></a>以下是将metrics暴露到集群外</h1><h2 id=\"2-telemetry-授权\"><a href=\"#2-telemetry-授权\" class=\"headerlink\" title=\"2. telemetry 授权\"></a>2. telemetry 授权</h2><h3 id=\"2-1-在单节点配置文件部分添加这个块\"><a href=\"#2-1-在单节点配置文件部分添加这个块\" class=\"headerlink\" title=\"2.1 在单节点配置文件部分添加这个块\"></a>2.1 在单节点配置文件部分添加这个块</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">telemetry &#123;\n        prometheus_retention_time &#x3D; &quot;30s&quot;\n        disable_hostname &#x3D; true\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p>2.2 为 prometheus 创建访问的 token</p>\n<ul>\n<li>权限<pre class=\"line-numbers language-none\"><code class=\"language-none\">vault policy write prometheus-metrics - &lt;&lt; EOF\npath &quot;&#x2F;sys&#x2F;metrics&quot; &#123;\n  capabilities &#x3D; [&quot;read&quot;]\n&#125;\nEOF<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>创建具有权限的 token<pre class=\"line-numbers language-none\"><code class=\"language-none\">vault token create \\\n  -field&#x3D;token \\\n  -policy prometheus-metrics \\\n  &gt; prometheus-token<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<p>将上方生成的 token 给予 prom。</p>\n<h2 id=\"3-prometheus-的配置\"><a href=\"#3-prometheus-的配置\" class=\"headerlink\" title=\"3. prometheus 的配置\"></a>3. prometheus 的配置</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">></span> prometheus.yml <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\nscrape_configs:\n  - job_name: vault\n    metrics_path: /v1/sys/metrics\n    params:\n      format: ['prometheus']\n    scheme: http\n    authorization:\n      credentials_file: /etc/prometheus/prometheus-token #使用 token\n    static_configs:\n    - targets: ['10.8.0.151:8200']\nEOF</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>prom 热加载 <code>curl -X POST http://xxxx/-/reload</code></p>\n<h2 id=\"初次尝试时-helm-主要修改内容\"><a href=\"#初次尝试时-helm-主要修改内容\" class=\"headerlink\" title=\"初次尝试时 helm 主要修改内容\"></a>初次尝试时 helm 主要修改内容</h2><p>参考helm中 config 部分<br>values.yaml </p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><div class=\"caption\"><span>TI:\"values\"</span></div><code class=\"language-yaml\">\n<span class=\"token key atrule\">global.datastorage</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">standalone</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n      ui = true\n      listener \"tcp\" &#123;\n        tls_disable = 1\n        address = \"[::]:8200\"\n        cluster_address = \"[::]:8201\"\n        # Enable unauthenticated metrics access (necessary for Prometheus Operator)\n        telemetry &#123;\n          unauthenticated_metrics_access = \"true\"\n          unauthenticated_in_flight_request_access = \"true\" #此项应该无关prom metrics\n        &#125;\n      &#125;</span>\n\n      storage \"file\" <span class=\"token punctuation\">&#123;</span>\n        path = \"/vault/data\"\n      <span class=\"token punctuation\">&#125;</span>    \n\n      <span class=\"token comment\"># Example configuration for enabling Prometheus metrics in your config; when post outside your cluster</span>\n      telemetry <span class=\"token punctuation\">&#123;</span>\n        prometheus_retention_time = \"3d\"\n        disable_hostname = true\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n  <span class=\"token key atrule\">statefulSet</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">container</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n      <span class=\"token key atrule\">pod</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token key atrule\">terminationGracePeriodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token key atrule\">tolerations</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">topologySpreadConstraints</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">updateStrategyType</span><span class=\"token punctuation\">:</span> OnDelete\n  <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\n<span class=\"token key atrule\">serverTelemetry</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">prometheusRules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">selectors</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token key atrule\">serviceMonitor</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 30s\n    <span class=\"token key atrule\">scrapeTimeout</span><span class=\"token punctuation\">:</span> 10s\n    <span class=\"token key atrule\">selectors</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>当前只是 standalone 配置</li>\n<li>server unseal 之后才能正常访问 UI</li>\n</ul>\n<blockquote>\n<p>[!failure]<br>vault logs： <code>core: security barrier not initialized</code></p>\n</blockquote>\n<blockquote>\n<p>[!info]</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F; $ vault operator init #进入容器执行\nUnseal Key 1: D9apO9R7M9hL0PQaSByJ9pAEGy3EMIJZIrQDx+bHwhpy\nUnseal Key 2: 0ixkSa4BM7X8Tre4F1JQDCR06m&#x2F;AEtRUPD6DwvfecwD+\nUnseal Key 3: 3y&#x2F;sowvniDzofLE3AQnzvXujQSE894ocaQO61YTbU+r2\nUnseal Key 4: dhkVbYBR7xqdl&#x2F;Q+&#x2F;QvvU9PofKdXu+OiYseqRuH8N7eo\nUnseal Key 5: 5lP9+P6S&#x2F;pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRo\n\nInitial Root Token: hvs.UKtqCCot92t6cSlxsM7SW5br\n\nVault initialized with 5 key shares and a key threshold of 3. Please securely\ndistribute the key shares printed above. When the Vault is re-sealed,\nrestarted, or stopped, you must supply at least 3 of these keys to unseal it\nbefore it can start servicing requests.\n\nVault does not store the generated root key. Without at least 3 keys to\nreconstruct the root key, Vault will remain permanently sealed!\n\nIt is possible to generate new unseal keys, provided you have a quorum of\nexisting unseal keys shares. See &quot;vault operator rekey&quot; for more information.\n\n&gt;&#x2F; $ vault operator unseal 5lP9+P6S&#x2F;pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRo  # 利用上述key，重复执行3次即可解封vault，这个pod将正常<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<h1 id=\"以下是在-kubernetes-集群的自动发现\"><a href=\"#以下是在-kubernetes-集群的自动发现\" class=\"headerlink\" title=\"以下是在 kubernetes 集群的自动发现\"></a>以下是在 kubernetes 集群的自动发现</h1><h2 id=\"vault-helm-chart\"><a href=\"#vault-helm-chart\" class=\"headerlink\" title=\"vault helm chart\"></a>vault helm chart</h2><h3 id=\"保证-server-standalone-config-配置如下\"><a href=\"#保证-server-standalone-config-配置如下\" class=\"headerlink\" title=\"保证 server.standalone  config 配置如下\"></a>保证 server.standalone  config 配置如下</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">config: |\n      ui &#x3D; true\n\n      listener &quot;tcp&quot; &#123;\n        tls_disable &#x3D; 1\n        address &#x3D; &quot;[::]:8200&quot;\n        cluster_address &#x3D; &quot;[::]:8201&quot;\n        # Enable unauthenticated metrics access (necessary for Prometheus Operator)\n        telemetry &#123;\n          unauthenticated_metrics_access &#x3D; &quot;true&quot;\n        &#125;\n      &#125;\n      storage &quot;file&quot; &#123;\n        path &#x3D; &quot;&#x2F;vault&#x2F;data&quot;\n      &#125;\n      # Example configuration for enabling Prometheus metrics in your config. 必须配置\n      telemetry &#123;\n        prometheus_retention_time &#x3D; &quot;3d&quot;\n        disable_hostname &#x3D; true\n      &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"需要开启-servicemonitor\"><a href=\"#需要开启-servicemonitor\" class=\"headerlink\" title=\"需要开启 servicemonitor\"></a>需要开启 servicemonitor</h3><p><code>serverTelemetry.serviceMonitor.enabled：true</code></p>\n<p>验证 service： nextcloud-metrics 是否存在annotations： prometheus.io&#x2F;scrape &#x3D;&#x3D; true ；存在将可以自动发现</p>\n<h3 id=\"Debug\"><a href=\"#Debug\" class=\"headerlink\" title=\"Debug\"></a>Debug</h3><p>服务成功发现，但是 prometheus targets 中报错 <code>server returned HTTP status 400 Bad Request</code> ，以下是集群内 curl 容器 api 的结果</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">curl  10.42.169.106:8200&#x2F;v1&#x2F;sys&#x2F;metrics&#x2F;\n&#123;&quot;errors&quot;:[&quot;permission denied&quot;]&#125;\n\ncurl  10.42.169.106:8200&#x2F;v1&#x2F;sys&#x2F;metrics \n&#123;&quot;Timestamp&quot;:&quot;2024-04-15 03:07:50 +0000 UTC&quot;,&quot;Gauges&quot;:[&#123;&quot;Name&quot;:&quot;vault.core.active&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.in_flight_requests&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.num_entries&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;auth&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.num_entries&quot;,&quot;Value&quot;:2,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.num_entries&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;true&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.size&quot;,&quot;Value&quot;:253,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;auth&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.size&quot;,&quot;Value&quot;:447,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.size&quot;,&quot;Value&quot;:302,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;true&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.performance_standby&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.dr.primary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.dr.secondary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.performance.primary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.performance.secondary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.write_undo_logs&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.unsealed&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.expire.num_irrevocable_leases&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.expire.num_leases&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.alloc_bytes&quot;,&quot;Value&quot;:47050330,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.free_count&quot;,&quot;Value&quot;:115420530,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.heap_objects&quot;,&quot;Value&quot;:92536,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.malloc_count&quot;,&quot;Value&quot;:115513064,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.num_goroutines&quot;,&quot;Value&quot;:224,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.sys_bytes&quot;,&quot;Value&quot;:81191190,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.total_gc_pause_ns&quot;,&quot;Value&quot;:345062720,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.total_gc_runs&quot;,&quot;Value&quot;:2005,&quot;Labels&quot;:&#123;&#125;&#125;],&quot;Points&quot;:[],&quot;Counters&quot;:[&#123;&quot;Name&quot;:&quot;vault.audit.log_request_failure&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0,&quot;Sum&quot;:0,&quot;Min&quot;:0,&quot;Max&quot;:0,&quot;Mean&quot;:0,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.audit.log_response_failure&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0,&quot;Sum&quot;:0,&quot;Min&quot;:0,&quot;Max&quot;:0,&quot;Mean&quot;:0,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.cache.hit&quot;,&quot;Count&quot;:2,&quot;Rate&quot;:0.2,&quot;Sum&quot;:2,&quot;Min&quot;:1,&quot;Max&quot;:1,&quot;Mean&quot;:1,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;],&quot;Samples&quot;:[&#123;&quot;Name&quot;:&quot;vault.audit.log_request&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.00067349998280406,&quot;Sum&quot;:0.0067349998280406,&quot;Min&quot;:0.0067349998280406,&quot;Max&quot;:0.0067349998280406,&quot;Mean&quot;:0.0067349998280406,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.audit.log_response&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.00048179998993873595,&quot;Sum&quot;:0.00481799989938736,&quot;Min&quot;:0.00481799989938736,&quot;Max&quot;:0.00481799989938736,&quot;Mean&quot;:0.00481799989938736,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.barrier.get&quot;,&quot;Count&quot;:2,&quot;Rate&quot;:0.007432200014591217,&quot;Sum&quot;:0.07432200014591217,&quot;Min&quot;:0.027681000530719757,&quot;Max&quot;:0.04664099961519241,&quot;Mean&quot;:0.037161000072956085,&quot;Stddev&quot;:0.013406743923921348,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.check_token&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.01593659967184067,&quot;Sum&quot;:0.15936599671840668,&quot;Min&quot;:0.15936599671840668,&quot;Max&quot;:0.15936599671840668,&quot;Mean&quot;:0.15936599671840668,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.fetch_acl_and_token&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.014495299756526947,&quot;Sum&quot;:0.14495299756526947,&quot;Min&quot;:0.14495299756526947,&quot;Max&quot;:0.14495299756526947,&quot;Mean&quot;:0.14495299756526947,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.handle_request&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.019178299605846404,&quot;Sum&quot;:0.19178299605846405,&quot;Min&quot;:0.19178299605846405,&quot;Max&quot;:0.19178299605846405,&quot;Mean&quot;:0.19178299605846405,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;]&#125;\n\ncurl  10.42.169.106:8200&#x2F;v1&#x2F;sys&#x2F;metrics?format&#x3D;&quot;prometheus&quot;\nprometheus is not enabled&gt; <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>多次排查之后发现并无特别的问题，helm 部署之后多次修改调整 values 后，config 没有成功生效，其中的值没有成功传入容器。删除应用后重新安装转为正常。</p>\n<h1 id=\"以下是将metrics暴露到集群外\"><a href=\"#以下是将metrics暴露到集群外\" class=\"headerlink\" title=\"以下是将metrics暴露到集群外\"></a>以下是将metrics暴露到集群外</h1><h2 id=\"2-telemetry-授权\"><a href=\"#2-telemetry-授权\" class=\"headerlink\" title=\"2. telemetry 授权\"></a>2. telemetry 授权</h2><h3 id=\"2-1-在单节点配置文件部分添加这个块\"><a href=\"#2-1-在单节点配置文件部分添加这个块\" class=\"headerlink\" title=\"2.1 在单节点配置文件部分添加这个块\"></a>2.1 在单节点配置文件部分添加这个块</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">telemetry &#123;\n        prometheus_retention_time &#x3D; &quot;30s&quot;\n        disable_hostname &#x3D; true\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<p>2.2 为 prometheus 创建访问的 token</p>\n<ul>\n<li>权限<pre class=\"line-numbers language-none\"><code class=\"language-none\">vault policy write prometheus-metrics - &lt;&lt; EOF\npath &quot;&#x2F;sys&#x2F;metrics&quot; &#123;\n  capabilities &#x3D; [&quot;read&quot;]\n&#125;\nEOF<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n<li>创建具有权限的 token<pre class=\"line-numbers language-none\"><code class=\"language-none\">vault token create \\\n  -field&#x3D;token \\\n  -policy prometheus-metrics \\\n  &gt; prometheus-token<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<p>将上方生成的 token 给予 prom。</p>\n<h2 id=\"3-prometheus-的配置\"><a href=\"#3-prometheus-的配置\" class=\"headerlink\" title=\"3. prometheus 的配置\"></a>3. prometheus 的配置</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">></span> prometheus.yml <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\nscrape_configs:\n  - job_name: vault\n    metrics_path: /v1/sys/metrics\n    params:\n      format: ['prometheus']\n    scheme: http\n    authorization:\n      credentials_file: /etc/prometheus/prometheus-token #使用 token\n    static_configs:\n    - targets: ['10.8.0.151:8200']\nEOF</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>prom 热加载 <code>curl -X POST http://xxxx/-/reload</code></p>\n<h2 id=\"初次尝试时-helm-主要修改内容\"><a href=\"#初次尝试时-helm-主要修改内容\" class=\"headerlink\" title=\"初次尝试时 helm 主要修改内容\"></a>初次尝试时 helm 主要修改内容</h2><p>参考helm中 config 部分<br>values.yaml </p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><div class=\"caption\"><span>TI:\"values\"</span></div><code class=\"language-yaml\">\n<span class=\"token key atrule\">global.datastorage</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">standalone</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n      ui = true\n      listener \"tcp\" &#123;\n        tls_disable = 1\n        address = \"[::]:8200\"\n        cluster_address = \"[::]:8201\"\n        # Enable unauthenticated metrics access (necessary for Prometheus Operator)\n        telemetry &#123;\n          unauthenticated_metrics_access = \"true\"\n          unauthenticated_in_flight_request_access = \"true\" #此项应该无关prom metrics\n        &#125;\n      &#125;</span>\n\n      storage \"file\" <span class=\"token punctuation\">&#123;</span>\n        path = \"/vault/data\"\n      <span class=\"token punctuation\">&#125;</span>    \n\n      <span class=\"token comment\"># Example configuration for enabling Prometheus metrics in your config; when post outside your cluster</span>\n      telemetry <span class=\"token punctuation\">&#123;</span>\n        prometheus_retention_time = \"3d\"\n        disable_hostname = true\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span>\n  <span class=\"token key atrule\">statefulSet</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n    <span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">container</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n      <span class=\"token key atrule\">pod</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token key atrule\">terminationGracePeriodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token key atrule\">tolerations</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">topologySpreadConstraints</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">updateStrategyType</span><span class=\"token punctuation\">:</span> OnDelete\n  <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\n<span class=\"token key atrule\">serverTelemetry</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">prometheusRules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">selectors</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token key atrule\">serviceMonitor</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 30s\n    <span class=\"token key atrule\">scrapeTimeout</span><span class=\"token punctuation\">:</span> 10s\n    <span class=\"token key atrule\">selectors</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>当前只是 standalone 配置</li>\n<li>server unseal 之后才能正常访问 UI</li>\n</ul>\n<blockquote>\n<p>[!failure]<br>vault logs： <code>core: security barrier not initialized</code></p>\n</blockquote>\n<blockquote>\n<p>[!info]</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#x2F; $ vault operator init #进入容器执行\nUnseal Key 1: D9apO9R7M9hL0PQaSByJ9pAEGy3EMIJZIrQDx+bHwhpy\nUnseal Key 2: 0ixkSa4BM7X8Tre4F1JQDCR06m&#x2F;AEtRUPD6DwvfecwD+\nUnseal Key 3: 3y&#x2F;sowvniDzofLE3AQnzvXujQSE894ocaQO61YTbU+r2\nUnseal Key 4: dhkVbYBR7xqdl&#x2F;Q+&#x2F;QvvU9PofKdXu+OiYseqRuH8N7eo\nUnseal Key 5: 5lP9+P6S&#x2F;pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRo\n\nInitial Root Token: hvs.UKtqCCot92t6cSlxsM7SW5br\n\nVault initialized with 5 key shares and a key threshold of 3. Please securely\ndistribute the key shares printed above. When the Vault is re-sealed,\nrestarted, or stopped, you must supply at least 3 of these keys to unseal it\nbefore it can start servicing requests.\n\nVault does not store the generated root key. Without at least 3 keys to\nreconstruct the root key, Vault will remain permanently sealed!\n\nIt is possible to generate new unseal keys, provided you have a quorum of\nexisting unseal keys shares. See &quot;vault operator rekey&quot; for more information.\n\n&gt;&#x2F; $ vault operator unseal 5lP9+P6S&#x2F;pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRo  # 利用上述key，重复执行3次即可解封vault，这个pod将正常<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote>\n"},{"title":"四千周","author":"LC","toc":true,"date":"2024-05-03T13:20:50.000Z","img":null,"top":null,"cover":null,"password":null,"summary":"书摘","_content":"\n第一遍：\n\n1. 你越是努力管理时间，希望实现完全的掌控，挣脱生活中不可避免的不如意，你的人生就会有越多的压力、空虚和挫败感。你越是直面有限性，与之合作而非对抗，你的人生就越充满效率、意义和乐趣。我认为焦虑感不会完全消失，我们甚至也无法全然接纳自己的有限性。但我知道，没有任何时间管理技巧比直面事实更有效。\n\n2. 时间原本是你用来充分享受人生的工具，现在反倒让你感觉似乎错失了更多的人生。\n\n3. 每一个选择都会有无数的牺牲，时间总是即将耗尽。未来哪怕一刻也不能被寄予全部的指望\n\n4. 我们为影响未来所做的努力并非问题所在，问题是--所有焦虑的根源--我们在当下的一刻就感觉需要知道这些努力最后会有结果。\n\n5. 你的问题是无法回答的，因为你想知道如何生活。每个人都有自己的生活，没有唯一且明确的方法......个人的路是你为自己铺的路，它从来没有什么规定，你事先也不知道，你一步步前行，路就会自然出现在脚下。\n\n6. 人这一辈子太短，短到荒唐，短到可怕，短到没有礼貌；但这不是你一直绝望的理由，也不是活在焦虑和恐慌中，殚精竭虑地过完有限时间的理由。应该开始为可能实现的事情努力。","source":"_posts/四千周/四千周.md","raw":"---\ntitle: 四千周\nauthor: LC\ntoc: true\ndate: 2024-05-03 21:20:50\nimg:\ntop:\ncover:\npassword:\nsummary: 书摘\ncategories: personal\ntags: excerpts\n---\n\n第一遍：\n\n1. 你越是努力管理时间，希望实现完全的掌控，挣脱生活中不可避免的不如意，你的人生就会有越多的压力、空虚和挫败感。你越是直面有限性，与之合作而非对抗，你的人生就越充满效率、意义和乐趣。我认为焦虑感不会完全消失，我们甚至也无法全然接纳自己的有限性。但我知道，没有任何时间管理技巧比直面事实更有效。\n\n2. 时间原本是你用来充分享受人生的工具，现在反倒让你感觉似乎错失了更多的人生。\n\n3. 每一个选择都会有无数的牺牲，时间总是即将耗尽。未来哪怕一刻也不能被寄予全部的指望\n\n4. 我们为影响未来所做的努力并非问题所在，问题是--所有焦虑的根源--我们在当下的一刻就感觉需要知道这些努力最后会有结果。\n\n5. 你的问题是无法回答的，因为你想知道如何生活。每个人都有自己的生活，没有唯一且明确的方法......个人的路是你为自己铺的路，它从来没有什么规定，你事先也不知道，你一步步前行，路就会自然出现在脚下。\n\n6. 人这一辈子太短，短到荒唐，短到可怕，短到没有礼貌；但这不是你一直绝望的理由，也不是活在焦虑和恐慌中，殚精竭虑地过完有限时间的理由。应该开始为可能实现的事情努力。","slug":"四千周/四千周","published":1,"updated":"2024-05-03T13:46:19.907Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clvrkodkb001z80rvhvga198k","content":"<p>第一遍：</p>\n<ol>\n<li><p>你越是努力管理时间，希望实现完全的掌控，挣脱生活中不可避免的不如意，你的人生就会有越多的压力、空虚和挫败感。你越是直面有限性，与之合作而非对抗，你的人生就越充满效率、意义和乐趣。我认为焦虑感不会完全消失，我们甚至也无法全然接纳自己的有限性。但我知道，没有任何时间管理技巧比直面事实更有效。</p>\n</li>\n<li><p>时间原本是你用来充分享受人生的工具，现在反倒让你感觉似乎错失了更多的人生。</p>\n</li>\n<li><p>每一个选择都会有无数的牺牲，时间总是即将耗尽。未来哪怕一刻也不能被寄予全部的指望</p>\n</li>\n<li><p>我们为影响未来所做的努力并非问题所在，问题是–所有焦虑的根源–我们在当下的一刻就感觉需要知道这些努力最后会有结果。</p>\n</li>\n<li><p>你的问题是无法回答的，因为你想知道如何生活。每个人都有自己的生活，没有唯一且明确的方法……个人的路是你为自己铺的路，它从来没有什么规定，你事先也不知道，你一步步前行，路就会自然出现在脚下。</p>\n</li>\n<li><p>人这一辈子太短，短到荒唐，短到可怕，短到没有礼貌；但这不是你一直绝望的理由，也不是活在焦虑和恐慌中，殚精竭虑地过完有限时间的理由。应该开始为可能实现的事情努力。</p>\n</li>\n</ol>\n","site":{"data":{"friends":[{"avatar":"http://image.luokangyuan.com/4027734.jpeg","name":"闪烁之狐","introduction":"编程界大佬，技术牛，人还特别好，不懂的都可以请教大佬","url":"https://blinkfox.github.io/","title":"前去学习"}]}},"excerpt":"","more":"<p>第一遍：</p>\n<ol>\n<li><p>你越是努力管理时间，希望实现完全的掌控，挣脱生活中不可避免的不如意，你的人生就会有越多的压力、空虚和挫败感。你越是直面有限性，与之合作而非对抗，你的人生就越充满效率、意义和乐趣。我认为焦虑感不会完全消失，我们甚至也无法全然接纳自己的有限性。但我知道，没有任何时间管理技巧比直面事实更有效。</p>\n</li>\n<li><p>时间原本是你用来充分享受人生的工具，现在反倒让你感觉似乎错失了更多的人生。</p>\n</li>\n<li><p>每一个选择都会有无数的牺牲，时间总是即将耗尽。未来哪怕一刻也不能被寄予全部的指望</p>\n</li>\n<li><p>我们为影响未来所做的努力并非问题所在，问题是–所有焦虑的根源–我们在当下的一刻就感觉需要知道这些努力最后会有结果。</p>\n</li>\n<li><p>你的问题是无法回答的，因为你想知道如何生活。每个人都有自己的生活，没有唯一且明确的方法……个人的路是你为自己铺的路，它从来没有什么规定，你事先也不知道，你一步步前行，路就会自然出现在脚下。</p>\n</li>\n<li><p>人这一辈子太短，短到荒唐，短到可怕，短到没有礼貌；但这不是你一直绝望的理由，也不是活在焦虑和恐慌中，殚精竭虑地过完有限时间的理由。应该开始为可能实现的事情努力。</p>\n</li>\n</ol>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"clvrkodg4000180rv2a3n85rn","category_id":"clvrkodgx000480rvcmmchmtj","_id":"clvrkodi3000h80rvegxu3sci"},{"post_id":"clvrkodhl000f80rv78ql8get","category_id":"clvrkodhg000c80rvhjb3gcbg","_id":"clvrkodir000m80rvbvgr9ha0"},{"post_id":"clvrkodgq000380rv7i7oe3sm","category_id":"clvrkodhg000c80rvhjb3gcbg","_id":"clvrkodj2000q80rv4f1lemqs"},{"post_id":"clvrkodh3000780rv54tffd6x","category_id":"clvrkodhg000c80rvhjb3gcbg","_id":"clvrkodj4000u80rv0a6m7y58"},{"post_id":"clvrkodha000980rv1zn8h8ro","category_id":"clvrkodhg000c80rvhjb3gcbg","_id":"clvrkodj8000z80rvhnms4ir3"},{"post_id":"clvrkodid000k80rvalov32lx","category_id":"clvrkodj3000t80rv6h2waavy","_id":"clvrkodji001580rv9228b8ut"},{"post_id":"clvrkodiu000p80rv12bw1rmf","category_id":"clvrkodj8001080rv75ae7lzg","_id":"clvrkodjo001d80rvg4mkdcvu"},{"post_id":"clvrkodji001880rvaga190om","category_id":"clvrkodj8001080rv75ae7lzg","_id":"clvrkodju001i80rv4nuqavcu"},{"post_id":"clvrkodj2000s80rva1m48x51","category_id":"clvrkodji001780rv6i13f4pz","_id":"clvrkodjx001k80rv8ys5hh6h"},{"post_id":"clvrkodj4000x80rvd2ndeage","category_id":"clvrkodjr001f80rv6mp1fzpm","_id":"clvrkodk4001q80rv3p7y0rbc"},{"post_id":"clvrkodj7000y80rv2e8e2mq0","category_id":"clvrkodjy001l80rvd72f2wlq","_id":"clvrkodka001x80rv63gcfuuj"},{"post_id":"clvrkodj9001180rvgbo6g22v","category_id":"clvrkodk4001r80rvcih20c9k","_id":"clvrkodke002180rvfl3db04j"},{"post_id":"clvrkodk9001w80rva016eqku","category_id":"clvrkodj8001080rv75ae7lzg","_id":"clvrkodkg002480rvbwsp4t6g"},{"post_id":"clvrkodjs001h80rvbq97b85r","category_id":"clvrkodka001y80rvgas160rs","_id":"clvrkodki002680rvgc5qarv3"},{"post_id":"clvrkodjv001j80rv8bkj5s8a","category_id":"clvrkodke002280rv5rgi9beh","_id":"clvrkodkl002c80rv7c9xgs0v"},{"post_id":"clvrkodjy001n80rv59l44mx3","category_id":"clvrkodke002280rv5rgi9beh","_id":"clvrkodkn002g80rvdczs1q4e"},{"post_id":"clvrkodk2001p80rvb1t70yha","category_id":"clvrkodke002280rv5rgi9beh","_id":"clvrkodkt002k80rv6rdn1lr5"},{"post_id":"clvrkodk5001t80rv64z79km4","category_id":"clvrkodke002280rv5rgi9beh","_id":"clvrkodl1002m80rvhzbgesbx"},{"post_id":"clvrkodkb001z80rvhvga198k","category_id":"clvrkodkt002j80rv4hwc8086","_id":"clvrkodl5002p80rv3cip4tmk"}],"PostTag":[{"post_id":"clvrkodg4000180rv2a3n85rn","tag_id":"clvrkodh0000580rv3qn910dc","_id":"clvrkodhk000e80rv1wnv95a9"},{"post_id":"clvrkodgq000380rv7i7oe3sm","tag_id":"clvrkodhh000d80rvc93m4njs","_id":"clvrkodj2000r80rv9zgp2qvy"},{"post_id":"clvrkodgq000380rv7i7oe3sm","tag_id":"clvrkodi3000j80rv3q9p4fv7","_id":"clvrkodj4000v80rvg3wr0nee"},{"post_id":"clvrkodj7000y80rv2e8e2mq0","tag_id":"clvrkodhh000d80rvc93m4njs","_id":"clvrkodjd001380rvh0k48mbj"},{"post_id":"clvrkodh3000780rv54tffd6x","tag_id":"clvrkodit000o80rvgtsvbgif","_id":"clvrkodji001680rvfme28n0n"},{"post_id":"clvrkodh3000780rv54tffd6x","tag_id":"clvrkodj4000w80rv9d00gs2t","_id":"clvrkodjl001a80rv7yon5xy4"},{"post_id":"clvrkodha000980rv1zn8h8ro","tag_id":"clvrkodjc001280rv7shr55zc","_id":"clvrkodjo001c80rv74r151mx"},{"post_id":"clvrkodhe000b80rvd698huxd","tag_id":"clvrkodjl001980rvbmic8ojz","_id":"clvrkodk2001o80rvbx085fhp"},{"post_id":"clvrkodhe000b80rvd698huxd","tag_id":"clvrkodjs001g80rv0s8scffc","_id":"clvrkodk5001s80rv3drr5bct"},{"post_id":"clvrkodhl000f80rv78ql8get","tag_id":"clvrkodjy001m80rveqxo0vs5","_id":"clvrkodk8001v80rvb5li9rmu"},{"post_id":"clvrkodi1000g80rv7g7jh63t","tag_id":"clvrkodk7001u80rvfl4x9rjm","_id":"clvrkodkg002580rvca8sfhtw"},{"post_id":"clvrkodi1000g80rv7g7jh63t","tag_id":"clvrkodjs001g80rv0s8scffc","_id":"clvrkodkj002780rv9wx5hom4"},{"post_id":"clvrkodid000k80rvalov32lx","tag_id":"clvrkodkg002380rvamrbacmn","_id":"clvrkodkj002a80rv9hjf3gog"},{"post_id":"clvrkodiu000p80rv12bw1rmf","tag_id":"clvrkodkj002980rvauex723i","_id":"clvrkodkm002e80rv4ijl1c36"},{"post_id":"clvrkodj2000s80rva1m48x51","tag_id":"clvrkodkl002d80rvexws662q","_id":"clvrkodkt002i80rve3kb3mgp"},{"post_id":"clvrkodj4000x80rvd2ndeage","tag_id":"clvrkodks002h80rvh1j59bg4","_id":"clvrkodl5002o80rv159h20d8"},{"post_id":"clvrkodj4000x80rvd2ndeage","tag_id":"clvrkodkx002l80rvblaf371h","_id":"clvrkodl5002q80rvfkm3fr4n"},{"post_id":"clvrkodj9001180rvgbo6g22v","tag_id":"clvrkodl1002n80rv9pfwg8y1","_id":"clvrkodl5002s80rv0u6ucjy7"},{"post_id":"clvrkodjd001480rv846u9nlb","tag_id":"clvrkodl5002r80rv518r1jng","_id":"clvrkodl8002u80rv4ttf8k6r"},{"post_id":"clvrkodji001880rvaga190om","tag_id":"clvrkodl5002t80rvg4wx2d8t","_id":"clvrkodl9002w80rv62ch142i"},{"post_id":"clvrkodjl001b80rv2p1xb523","tag_id":"clvrkodks002h80rvh1j59bg4","_id":"clvrkodlb002y80rve38abczj"},{"post_id":"clvrkodjo001e80rvg0ot62ue","tag_id":"clvrkodks002h80rvh1j59bg4","_id":"clvrkodlc003080rvfpa8dhz2"},{"post_id":"clvrkodjs001h80rvbq97b85r","tag_id":"clvrkodlb002z80rvh4jpfxpn","_id":"clvrkodld003280rv6stw9f2a"},{"post_id":"clvrkodjv001j80rv8bkj5s8a","tag_id":"clvrkodld003180rv7u302qjh","_id":"clvrkodlh003480rvfpf1cfq9"},{"post_id":"clvrkodjy001n80rv59l44mx3","tag_id":"clvrkodld003180rv7u302qjh","_id":"clvrkodlj003680rv2njlbyvo"},{"post_id":"clvrkodk2001p80rvb1t70yha","tag_id":"clvrkodld003180rv7u302qjh","_id":"clvrkodlj003880rv79e46s8p"},{"post_id":"clvrkodk5001t80rv64z79km4","tag_id":"clvrkodld003180rv7u302qjh","_id":"clvrkodlm003a80rv6wdi3zl2"},{"post_id":"clvrkodk9001w80rva016eqku","tag_id":"clvrkodlm003980rvd8pq4dou","_id":"clvrkodln003d80rv6pn97w3v"},{"post_id":"clvrkodk9001w80rva016eqku","tag_id":"clvrkodld003180rv7u302qjh","_id":"clvrkodln003e80rv73jjdbix"},{"post_id":"clvrkodkb001z80rvhvga198k","tag_id":"clvrkodln003c80rvas8oe0gq","_id":"clvrkodln003f80rvbg36bswj"}],"Tag":[{"name":"personal","_id":"clvrkodh0000580rv3qn910dc"},{"name":"DNS","_id":"clvrkodhh000d80rvc93m4njs"},{"name":"Ubuntu","_id":"clvrkodi3000j80rv3q9p4fv7"},{"name":"FRP","_id":"clvrkodit000o80rvgtsvbgif"},{"name":"IngressRoute","_id":"clvrkodj4000w80rv9d00gs2t"},{"name":"debug","_id":"clvrkodjc001280rv7shr55zc"},{"name":"Virtualization","_id":"clvrkodjl001980rvbmic8ojz"},{"name":"Docker","_id":"clvrkodjs001g80rv0s8scffc"},{"name":"OpenLDAP","_id":"clvrkodjy001m80rveqxo0vs5"},{"name":"Overleaf","_id":"clvrkodk7001u80rvfl4x9rjm"},{"name":"helm","_id":"clvrkodkg002380rvamrbacmn"},{"name":"cert-manager","_id":"clvrkodkj002980rvauex723i"},{"name":"clickhouse","_id":"clvrkodkl002d80rvexws662q"},{"name":"hexo","_id":"clvrkodks002h80rvh1j59bg4"},{"name":"blog","_id":"clvrkodkx002l80rvblaf371h"},{"name":"DIY","_id":"clvrkodl1002n80rv9pfwg8y1"},{"name":"demo test","_id":"clvrkodl5002r80rv518r1jng"},{"name":"prometheus","_id":"clvrkodl5002t80rvg4wx2d8t"},{"name":"Personal","_id":"clvrkodlb002z80rvh4jpfxpn"},{"name":"metrics","_id":"clvrkodld003180rv7u302qjh"},{"name":"vault","_id":"clvrkodlm003980rvd8pq4dou"},{"name":"excerpts","_id":"clvrkodln003c80rvas8oe0gq"}]}}