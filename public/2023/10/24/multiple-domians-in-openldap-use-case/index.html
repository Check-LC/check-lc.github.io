<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Multiple Domians in OpenLdap Use Case, BLOG">
    <meta name="description" content="记录自己踩坑 OpenLDAP 在多域中的使用，以及集成应用且跨域实现用户登录的测试，内容来源网络。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Multiple Domians in OpenLdap Use Case | BLOG</title>
    <link rel="icon" type="image/png" href="/ops_blog/favicon.png">
    
    <style>
        body{
            background-image: url(medias/images/03.jpg);
            background-repeat:no-repeat;
            background-size: 100% 100%;
            background-attachment:fixed;
        }
    </style>



    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/ops_blog/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/ops_blog/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/ops_blog/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/ops_blog/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/ops_blog/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/ops_blog/css/matery.css">
<link rel="stylesheet" type="text/css" href="/ops_blog/css/my.css">
<link rel="stylesheet" type="text/css" href="/ops_blog/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/ops_blog/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/ops_blog/css/post.css">




    



    <script src="/ops_blog/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/ops_blog/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/ops_blog/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/ops_blog/" class="waves-effect waves-light">
                    
                    <img src="/ops_blog/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">BLOG</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/ops_blog/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/ops_blog/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/ops_blog/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/ops_blog/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/ops_blog/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/ops_blog/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">BLOG</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/ops_blog/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/ops_blog/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/ops_blog/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/ops_blog/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/ops_blog/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Check-LC/ops_blog" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Check-LC/ops_blog" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/ops_blog/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/ops_blog/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/ops_blog/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Multiple Domians in OpenLdap Use Case</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/ops_blog/tags/OpenLDAP/">
                                <span class="chip bg-color">OpenLDAP</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/ops_blog/categories/ops/" class="post-category">
                                ops
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-10-24
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-10-24
                </div>
                

                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="一、-概念"><a href="#一、-概念" class="headerlink" title="一、 概念"></a>一、 概念</h1><p><a target="_blank" rel="noopener" href="https://www.openldap.org/doc/admin26/guide.html">官方手册</a></p>
<h2 id="1-1-常用属性"><a href="#1-1-常用属性" class="headerlink" title="1.1 常用属性"></a>1.1 常用属性</h2><ul>
<li>DN：Distinguished Name，LDAP记录项的标识，有唯一性，例如：dc:”cn&#x3D;admin,ou&#x3D;developer,dc&#x3D;163,dc&#x3D;com”  </li>
<li>dc&#x3D; DomainComponent 为域组件，域名的一部分</li>
<li>cn&#x3D;CommonName 为记录名，表示一个实体，最长到80个字符，可以为中文；</li>
<li>ou&#x3D;OrganizationUnit 为组织单位，用于分类，最多四级，每级最长32字符，可以为中文；</li>
<li>uid&#x3D;User id 为用户的唯一标识</li>
<li>c&#x3D;Country 为国家名，可选，为2个字符长</li>
<li>o&#x3D;Organization 为组织名，可选，可以3—64个字符长</li>
</ul>
<h1 id="二、-安装和配置-LDAP"><a href="#二、-安装和配置-LDAP" class="headerlink" title="二、 安装和配置 LDAP"></a>二、 安装和配置 LDAP</h1><h2 id="2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务"><a href="#2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务" class="headerlink" title="2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)"></a>2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install  -y slapd ldap-utils</span><br></pre></td></tr></table></figure>
<h2 id="2-2-重新配置-OpenLDAP，创建-base-dn"><a href="#2-2-重新配置-OpenLDAP，创建-base-dn" class="headerlink" title="2.2  重新配置 OpenLDAP，创建 base dn"></a>2.2  重新配置 OpenLDAP，创建 base dn</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg-reconfigure slapd   # 主要配置密码 (密码在下一步重置，便于配置连接)，DNS domain name(即 LDAP 服务中的 base dn)</span><br><span class="line"></span><br><span class="line">	 说明：</span><br><span class="line">	第一步回答 No</span><br><span class="line">	第二步填写域名，比如 mycompany.com</span><br><span class="line">	第三步填写组织名，比如 Company</span><br><span class="line">	第四步填写管理员密码，比如 secret；第五步确认管理员密码</span><br><span class="line">	第六步选择使用的数据库后端，比如 MDB</span><br><span class="line">	第七步选择在清除 slapd 时是否移除数据库，比如 Yes</span><br><span class="line">	第八步选择是否移除旧数据库，比如 Yes</span><br></pre></td></tr></table></figure>
<p><img src="/ops_blog/attachments/Pasted%20image%2020230823163910.png" alt="|1425"></p>
<h2 id="2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码"><a href="#2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码" class="headerlink" title="2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码"></a>2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slappasswd</span><br><span class="line">	&#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure>
<h2 id="2-4-修改admin用户的ldif文件"><a href="#2-4-修改admin用户的ldif文件" class="headerlink" title="2.4 修改admin用户的ldif文件"></a>2.4 修改admin用户的ldif文件</h2><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/slapd.d/cn\=config/olcDatabase\=\&#123;1\&#125;mdb.ldif</span><br><span class="line">	olcDatabase: &#123;1&#125;mdb</span><br><span class="line">	olcSuffix: dc=example,dc=top</span><br><span class="line">	olcRootDN: cn=admin,dc=example,dc=top</span><br><span class="line">	olcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure>
<ul>
<li>olcDatabase: 定义使用的后端数据存储格式,遵循默认</li>
<li>olcSuffix: 设置 LDAP 服务的根</li>
<li>olcRootDN: 设置管理员用户的 dn</li>
<li>olcRootPW: 管理员用户的密码，由上一步生成</li>
<li>修改后重启服务<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo slaptest -u   # 检查配置文件</span><br><span class="line">sudo systemctl enable slapd  --now</span><br><span class="line"></span><br><span class="line">sudo slapcat        # 输出看到当前数据库内容</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2-5-简单结构展示"><a href="#2-5-简单结构展示" class="headerlink" title="2.5 简单结构展示"></a>2.5 简单结构展示</h2><p>略</p>
<h2 id="2-6-创建base-dn"><a href="#2-6-创建base-dn" class="headerlink" title="2.6 创建base dn"></a>2.6 创建base dn</h2><ul>
<li><p>查看LDAP服务器的根目录信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapsearch -x -LLL -b &#x27;&#x27; -s base &#x27;(objectclass=*)&#x27;</span><br><span class="line">	dn:</span><br><span class="line">	objectClass: top</span><br><span class="line">	objectClass: OpenLDAProotDSE</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-</span><br><span class="line">dn: dc=example,dc=top</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: domain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: o=example,dc=example,dc=top</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: organization</span><br><span class="line">o: example</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapmodify -x -D &quot;cn=admin,dc=example,dc=top&quot; -w example@2020  -f organization.ldif</span><br></pre></td></tr></table></figure>

<h2 id="2-7-创建多个-DIT-base-dn"><a href="#2-7-创建多个-DIT-base-dn" class="headerlink" title="2.7 创建多个 DIT + base dn"></a>2.7 创建多个 DIT + base dn</h2><ul>
<li><p>为新的库，准备存储路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir  /var/lib/ldap2</span><br><span class="line">chown openldap:openldap  /var/lib/ldap2</span><br><span class="line">vim /etc/apparmor.d/usr.sbin.slapd</span><br><span class="line">		# the databases and logs</span><br><span class="line">		/var/lib/ldap2/ r,</span><br><span class="line">		/var/lib/ldap2/** rwk,</span><br><span class="line">		</span><br><span class="line">		# lock file</span><br><span class="line">		/var/lib/ldap2/alock kw,</span><br><span class="line"></span><br><span class="line">sudo systemctl  reload  apparmor </span><br></pre></td></tr></table></figure>
</li>
<li><p>准备 ldif 文件，创建新的 DIT（&#x2F;etc&#x2F;ldap&#x2F;domian2.ldif）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;2&#125;mdb,cn=config</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: olcDatabaseConfig</span><br><span class="line">objectClass: olcMdbConfig</span><br><span class="line">olcDbDirectory: /var/lib/ldap2/</span><br><span class="line">olcDatabase: &#123;2&#125;Mdb</span><br><span class="line">olcDbIndex: objectClass eq</span><br><span class="line">olcDbIndex: cn,uid eq</span><br><span class="line">olcDbIndex: uidNumber,gidNumber eq</span><br><span class="line">olcDbIndex: member,memberUid eq</span><br><span class="line">olcLastMod: TRUE</span><br><span class="line">olcMonitoring: TRUE</span><br><span class="line">olcDBNoSync: TRUE</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write by anonymous auth by * non</span><br><span class="line"> e</span><br><span class="line">olcAccess: &#123;1&#125;to attrs=shadowLastChange by self write by * read</span><br><span class="line">olcSuffix: dc=example,dc=tech</span><br><span class="line">olcRootDN: cn=admin,dc=example,dc=tech</span><br><span class="line">olcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo  ldapmodify -Y EXTERNAL -H ldapi:/// -f domian2.ldif</span><br></pre></td></tr></table></figure>

<ul>
<li>设置管理员<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-</span><br><span class="line">dn: cn=admin,dc=example,dc=tech</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: admin</span><br><span class="line">userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br><span class="line">==========================</span><br><span class="line"># 以下是playbook中模板文件</span><br><span class="line">-</span><br><span class="line">dn: cn=admin,&#123;&#123; item.base_dn &#125;&#125;  </span><br><span class="line">changetype: add  </span><br><span class="line">objectClass: simpleSecurityObject  </span><br><span class="line">objectClass: organizationalRole  </span><br><span class="line">cn: admin  </span><br><span class="line">userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapadd -x -D &quot;cn=admin,dc=example,dc=tech&quot; -w example@2020 -f basedn2.ldif</span><br></pre></td></tr></table></figure>

<h3 id="2-7-1-多-DIT-管理"><a href="#2-7-1-多-DIT-管理" class="headerlink" title="2.7.1 多 DIT 管理"></a>2.7.1 多 DIT 管理</h3><ul>
<li><p>查询服务器的域</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://10.13.3.107 -b &quot;&quot; -s base namingContexts</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置一个全权限的 acl ，跨域访问，相应的用户已经提前创建</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">让这个dn 用户: cn=user.tech,dc=example,dc=tech ;  可以阅读这个base dn : dc=example,dc=top 下的所有条目.</span><br><span class="line">对应关系：数据库----&#123;1&#125;mdb  存储的base dn 是 dc=example,dc=top 。即，对谁的访问则将 acl 添加在谁的库下  </span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=example,dc=top&quot; by dn.base=&quot;cn=user.tech,dc=example,dc=tech&quot; read</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapmodify   -Y   EXTERNAL   -H   ldapi:///   -f  xxx</span><br></pre></td></tr></table></figure>
<ul>
<li><p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">root@example-sys-test-06:/etc/ldap/example# ldapsearch -x -b &quot;dc=example,dc=top&quot; -D &quot;cn=user.tech,dc=example,dc=tech&quot; -w example@2020</span><br><span class="line">		# extended LDIF</span><br><span class="line">		#</span><br><span class="line">		# LDAPv3</span><br><span class="line">		# base &lt;dc=example,dc=top&gt; with scope subtree</span><br><span class="line">		# filter: (objectclass=*)</span><br><span class="line">		# requesting: ALL</span><br><span class="line">		#</span><br><span class="line">		</span><br><span class="line">		# example.top</span><br><span class="line">		dn: dc=example,dc=top</span><br><span class="line">		objectClass: top</span><br><span class="line">		objectClass: domain</span><br><span class="line">		dc: example</span><br><span class="line">		</span><br><span class="line">		# admin, example.top</span><br><span class="line">		dn: cn=admin,dc=example,dc=top</span><br><span class="line">		objectClass: simpleSecurityObject</span><br><span class="line">		objectClass: organizationalRole</span><br><span class="line">		cn: admin</span><br><span class="line">		</span><br><span class="line">		# search result</span><br><span class="line">		search: 2</span><br><span class="line">		result: 0 Success</span><br><span class="line">		</span><br><span class="line">		# numResponses: 3</span><br><span class="line">		# numEntries: 2</span><br><span class="line">root@example-sys-test-06:/etc/ldap/example# ldapsearch -x -b &quot;dc=example,dc=tech&quot; -D &quot;cn=admin,dc=example,dc=top&quot; -w example@2020</span><br><span class="line">		# extended LDIF</span><br><span class="line">		#</span><br><span class="line">		# LDAPv3</span><br><span class="line">		# base &lt;dc=example,dc=tech&gt; with scope subtree</span><br><span class="line">		# filter: (objectclass=*)</span><br><span class="line">		# requesting: ALL</span><br><span class="line">		#</span><br><span class="line">		</span><br><span class="line">		# search result</span><br><span class="line">		search: 2</span><br><span class="line">		result: 32 No such object</span><br><span class="line">		</span><br><span class="line">		# numResponses: 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试的日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 fd=12 ACCEPT from IP=127.0.0.1:59834 (IP=0.0.0.0:389)</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 BIND dn=&quot;cn=user.tech,dc=example,dc=tech&quot; method=128</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 BIND dn=&quot;cn=user.tech,dc=example,dc=tech&quot; mech=SIMPLE ssf=0</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 RESULT tag=97 err=0 text=</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=1 SRCH base=&quot;dc=example,dc=top&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=1 SEARCH RESULT tag=101 err=0 nentries=2 text=</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=2 UNBIND</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 fd=12 closed</span><br><span class="line">=================</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 fd=12 ACCEPT from IP=127.0.0.1:34916 (IP=0.0.0.0:389)</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; method=128</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; mech=SIMPLE ssf=0</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 RESULT tag=97 err=0 text=</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=1 SRCH base=&quot;dc=example,dc=tech&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=1 SEARCH RESULT tag=101 err=32 nentries=0 text=</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=2 UNBIND</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 fd=12 closed</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="三、-web管理器配置"><a href="#三、-web管理器配置" class="headerlink" title="三、 web管理器配置"></a>三、 web管理器配置</h1><h2 id="3-1-安装-LAM-便于-CA-验证，连接-ldaps"><a href="#3-1-安装-LAM-便于-CA-验证，连接-ldaps" class="headerlink" title="3.1 安装  LAM (便于 CA 验证，连接 ldaps)"></a>3.1 安装  LAM (便于 CA 验证，连接 ldaps)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install ldap-account-manager</span><br></pre></td></tr></table></figure>
<p>访问 <a target="_blank" rel="noopener" href="http://ip/lam">http://ip/lam</a> ，lam的所有配置都可以在web端配置，不需要去服务器上修改一行代码</p>
<h3 id="3-1-1-LAM-configuration"><a href="#3-1-1-LAM-configuration" class="headerlink" title="3.1.1 LAM configuration"></a>3.1.1 LAM configuration</h3><h3 id="3-1-2-Profile-Setting"><a href="#3-1-2-Profile-Setting" class="headerlink" title="3.1.2  Profile Setting"></a>3.1.2  Profile Setting</h3><ul>
<li><p>Edit general settings 来编辑通用配置，<strong>默认密码 lam</strong>，进入之后能配置证书  </p>
</li>
<li><p>Edit server profiles 来编辑服务器配置，最好先编辑服务器配置</p>
</li>
<li><p>Security settings，管理登录用户，可以是固定的DN列表，也可以是LAM可以搜索LDAP以查找与给定用户名匹配的DN</p>
</li>
<li><p>Note：<br>未加密的LDAP连接或TLS加密连接使用ldap：&#x2F;&#x2F;  ( 通过端口389连接)。<br>LDAP+SSL（LDAPS）加密连接使用ldaps：&#x2F;&#x2F;   (636)。TLS不能与ldaps：&#x2F;&#x2F;组合使用。  </p>
</li>
<li><p>显示的标签，二者均保留可以正常使用 tree view进行编辑  </p>
</li>
<li><p>控制账户类显示的模块  </p>
</li>
<li><p>“Models setting” 页面配置 该记录需要的具体信息，勾选剔除  </p>
</li>
<li><p>tree view编辑更高效</p>
</li>
</ul>
<h3 id="3-1-3-反向代理-LAM-web-ui"><a href="#3-1-3-反向代理-LAM-web-ui" class="headerlink" title="3.1.3 反向代理 LAM web ui"></a>3.1.3 反向代理 LAM web ui</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">upstream lam &#123;</span><br><span class="line">  server 10.13.3.108:8001;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name lam.example.net;</span><br><span class="line">  return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  server_name lam.example.net;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  ssl_certificate webmin/tls_ca.pem;</span><br><span class="line">  ssl_certificate_key webmin/tls_key.pem;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">     proxy_pass http://lam/;</span><br><span class="line">     proxy_set_header Host $host;</span><br><span class="line">     proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">#     proxy_set_header X-Forwarded-Proto &quot;https&quot;;</span><br><span class="line">     proxy_read_timeout 1800s;</span><br><span class="line">     proxy_http_version 1.1;</span><br><span class="line">     proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">     proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-安装-phpldapadmin"><a href="#3-2-安装-phpldapadmin" class="headerlink" title="3.2 安装 phpldapadmin"></a>3.2 安装 phpldapadmin</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Setting up php8.1 (8.1.2-1ubuntu2.14)                       # 版本信息，配置文件完整，存在证书认证并可以指定路径</span><br><span class="line">Setting up php (2:8.1+92ubuntu1) </span><br><span class="line">Setting up phpldapadmin (1.2.6.3-0.2)                                       </span><br></pre></td></tr></table></figure>
<h3 id="3-2-1-安装"><a href="#3-2-1-安装" class="headerlink" title="3.2.1 安装"></a>3.2.1 安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apt-get install phpldapadmin -y</span><br><span class="line">nano /etc/phpldapadmin/config.php</span><br><span class="line">	$servers-&gt;setValue(&#x27;server&#x27;,&#x27;name&#x27;,&#x27;My LDAP Server&#x27;);                      # 辨识，区分的作用</span><br><span class="line">	$servers-&gt;setValue(&#x27;server&#x27;,&#x27;host&#x27;,&#x27;69.87.216.102&#x27;);                              #  修改ip为服务器 ip</span><br><span class="line">	$servers-&gt;;setValue(&#x27;server&#x27;,&#x27;base&#x27;,array(&#x27;dc=example,dc=com&#x27;));                    # 修改 array 内容为需求的根</span><br><span class="line">	$servers-&gt;setValue(&#x27;login&#x27;,&#x27;auth_type&#x27;,&#x27;session&#x27;);                                              </span><br><span class="line">	$servers-&gt;setValue(&#x27;login&#x27;,&#x27;bind_id&#x27;,&#x27;cn=admin,dc=example,dc=com&#x27;);           #   绑定登录帐号admin，相应修改 dn 号即可</span><br><span class="line">	$servers-&gt;setValue(&#x27;auto_number&#x27;,&#x27;min&#x27;,array(&#x27;uidNumber&#x27;=&gt;10000,&#x27;gidNumber&#x27;=&gt;10000));   # 规定 uid，gid 数字表示的起始范围</span><br></pre></td></tr></table></figure>
<h3 id="3-2-2-为-phpLDAPadmin-配置-Apache"><a href="#3-2-2-为-phpLDAPadmin-配置-Apache" class="headerlink" title="3.2.2 为 phpLDAPadmin 配置 Apache"></a>3.2.2 为 phpLDAPadmin 配置 Apache</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a2dissite 000-default.conf        # 禁用默认的 Apache 虚拟主机配置文件</span><br><span class="line">systemctl restart apache2          </span><br></pre></td></tr></table></figure>

<h1 id="四、-主从架构-弃用，此配置需要在从服务器拉取-refresh"><a href="#四、-主从架构-弃用，此配置需要在从服务器拉取-refresh" class="headerlink" title="四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)"></a>四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)</h1><p><a target="_blank" rel="noopener" href="https://darkdark.top/ch5-replication.html">模式介绍</a></p>
<h2 id="4-1-master-加载同步模块"><a href="#4-1-master-加载同步模块" class="headerlink" title="4.1 master 加载同步模块"></a>4.1 master 加载同步模块</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/ldap/mod_syncprov.ldif</span><br><span class="line">		dn: cn=module,cn=config</span><br><span class="line">		objectClass: olcModuleList</span><br><span class="line">		cn: module</span><br><span class="line">		olcModulePath: /usr/lib/ldap</span><br><span class="line">		olcModuleLoad: syncprov.la          # 此配置和上一句配置，实际是在请求这个路径的文件，/usr/lib/ldap/syncprov.la，不确定的可以用 find 查找</span><br><span class="line"></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f ./mod_syncprov.ldif</span><br></pre></td></tr></table></figure>
<h2 id="4-2-同步设置"><a href="#4-2-同步设置" class="headerlink" title="4.2 同步设置"></a>4.2 同步设置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@example-sys-test-06:/etc/ldap# cat syncprov.ldif </span><br><span class="line">		dn: olcOverlay=syncprov,olcDatabase=&#123;1&#125;mdb,cn=config       # 此处需要确认自己的数据库是什么样的，&#123;2&#125;hdb--旧版本默认 / &#123;1&#125;mdb--新版本默认</span><br><span class="line">		objectClass: olcOverlayConfig</span><br><span class="line">		objectClass: olcSyncProvConfig</span><br><span class="line">		olcOverlay: syncprov</span><br><span class="line">		olcSpCheckpoint: 100 10</span><br><span class="line">		olcSpSessionLog: 100</span><br><span class="line"></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f ./syncprov.ldif                             # 修改并应用条目到 LDAP 服务  -Y EXTERNAL    将使用服务器配置的外部身份验证方法进行身份验证，而不是使用用户名和密码; -H 指定服务器连接; -f 指定文件</span><br></pre></td></tr></table></figure>
<h2 id="4-3-从服务器配置"><a href="#4-3-从服务器配置" class="headerlink" title="4.3 从服务器配置"></a>4.3 从服务器配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@example-sys-test-07:/etc/ldap# cat syncrepl.ldif</span><br><span class="line">		dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">		changetype: modify</span><br><span class="line">		add: olcSyncRepl</span><br><span class="line">		olcSyncRepl: rid=002</span><br><span class="line">		  provider=ldap://10.13.3.106:389/        # 此处开始与上一行有缩进</span><br><span class="line">		  bindmethod=simple</span><br><span class="line">		  binddn=&quot;cn=admin,dc=example,dc=top&quot;</span><br><span class="line">		  credentials=example@2020      </span><br><span class="line">		  searchbase=&quot;dc=example,dc=top&quot;</span><br><span class="line">		  scope=sub</span><br><span class="line">		  schemachecking=on</span><br><span class="line">		  type=refreshAndPersist</span><br><span class="line">		  retry=&quot;5 5 300 +&quot;</span><br><span class="line">		  attrs=&quot;*,+&quot;</span><br><span class="line">		  interval=00:00:00:3</span><br><span class="line"></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/syncrepl.ldif</span><br></pre></td></tr></table></figure>
<ul>
<li>运行中，修改主服务器内数据后，对从服务器u做刷新，可以看到是否同步</li>
</ul>
<p>参数说明：</p>
<ul>
<li>provider 为ldap master&#x2F;slave的地址 ;</li>
<li>binddn：为域的基本信息，注这里一定要用管理员进行登录，否则同步不到用户的密码。</li>
<li>credentials: ldap管理员的密码</li>
<li>searchbase：选择要同步的独立域，根节点</li>
<li>scope：设置所有的条目匹配</li>
<li>schemachecking：设置同步更新时间检测</li>
<li>type：同步模式为refreshAndPersist， refreshOnly 模式下后续操作由客户端轮询完成</li>
<li>retry:同步更新重试次数和时间刚开始的5秒重试5次，以后每300秒重试一次</li>
<li>attrs:复制全部属性</li>
<li>interval 这里设置更新时间，这里为3秒一次，倒数第二个是分钟 以此类推。</li>
</ul>
<h1 id="四、-镜像复制"><a href="#四、-镜像复制" class="headerlink" title="四、 镜像复制"></a>四、 镜像复制</h1><p><a target="_blank" rel="noopener" href="https://darkdark.top/ch5-replication.html">模式介绍</a></p>
<h2 id="4-1-ldap-example-top下编辑-mirrorsync-ldif"><a href="#4-1-ldap-example-top下编辑-mirrorsync-ldif" class="headerlink" title="4.1 ldap.example.top下编辑 mirrorsync.ldif"></a>4.1 ldap.example.top下编辑 mirrorsync.ldif</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=module,cn=config         # 此段配置加载s ync 模块</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">cn: module</span><br><span class="line">olcModulePath: /usr/lib/ldap</span><br><span class="line">olcModuleLoad: syncprov.la     # 此配置和上一句，实际是在请求这个路径的文件，/usr/lib/ldap/syncprov.la，不确定的可 find 查找</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: olcOverlay=syncprov,olcDatabase=&#123;1&#125;mdb,cn=config        </span><br><span class="line">	 # 此处需确认自己的数据库，&#123;2&#125;hdb--为旧版本默认 / &#123;1&#125;mdb--为新版本默认。路径 /etc/ldap/slapd.d/cn\=config/olcDatabase\=\&#123;1\&#125;mdb.ldif</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcSyncProvConfig</span><br><span class="line">olcOverlay: syncprov</span><br><span class="line">olcSpSessionLog: 100</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcServerID</span><br><span class="line">olcServerID: 0                                        # 标识本机的 server id</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config      # 以下配置用于开启复制，指定主服务器</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcSyncRepl</span><br><span class="line">olcSyncRepl: rid=000                             # 标识唯一的 replica id</span><br><span class="line">  provider=ldaps://ldap01.example.top       # 看上述记录介绍参数</span><br><span class="line">  bindmethod=simple</span><br><span class="line">  binddn=&quot;cn=admin,dc=example,dc=top&quot;</span><br><span class="line">  credentials=example@2020</span><br><span class="line">  searchbase=&quot;dc=example,dc=top&quot;</span><br><span class="line">  tls_reqcert=allow</span><br><span class="line">  scope=sub</span><br><span class="line">  schemachecking=on</span><br><span class="line">  type=refreshAndPersist</span><br><span class="line">  retry=&quot;30 5 300 3&quot;</span><br><span class="line">  interval=00:00:05:00</span><br><span class="line">-</span><br><span class="line">add: olcMirrorMode                        # 开启 mirror mode</span><br><span class="line">olcMirrorMode: TRUE</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-2-ldap01-example-top下编辑-mirrorsync-ldif"><a href="#4-2-ldap01-example-top下编辑-mirrorsync-ldif" class="headerlink" title="4.2 ldap01.example.top下编辑 mirrorsync.ldif"></a>4.2 ldap01.example.top下编辑 mirrorsync.ldif</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=module,cn=config</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">cn: module</span><br><span class="line">olcModulePath: /usr/lib/ldap</span><br><span class="line">olcModuleLoad: syncprov.la</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: olcOverlay=syncprov,olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcSyncProvConfig</span><br><span class="line">olcOverlay: syncprov</span><br><span class="line">olcSpSessionLog: 100</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcServerID</span><br><span class="line">olcServerID: 1</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcSyncRepl</span><br><span class="line">olcSyncRepl: rid=001</span><br><span class="line">  provider=ldaps://ldap.example.top</span><br><span class="line">  bindmethod=simple</span><br><span class="line">  binddn=&quot;cn=admin,dc=example,dc=top&quot;</span><br><span class="line">  credentials=example@2020</span><br><span class="line">  searchbase=&quot;dc=example,dc=top&quot;</span><br><span class="line">  tls_reqcert=allow</span><br><span class="line">  scope=sub</span><br><span class="line">  schemachecking=on</span><br><span class="line">  type=refreshAndPersist</span><br><span class="line">  retry=&quot;30 5 300 3&quot;</span><br><span class="line">  interval=00:00:05:00</span><br><span class="line">-</span><br><span class="line">add: olcMirrorMode</span><br><span class="line">olcMirrorMode: TRUE</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="4-3-加载配置"><a href="#4-3-加载配置" class="headerlink" title="4.3 加载配置"></a>4.3 加载配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f mirrorsync.ldif</span><br></pre></td></tr></table></figure>

<h1 id="五、-TLS加密（自签名-权威证书）"><a href="#五、-TLS加密（自签名-权威证书）" class="headerlink" title="五、 TLS加密（自签名+权威证书）"></a>五、 TLS加密（自签名+权威证书）</h1><p>（自签名证书加密连接 nextcloud 失败，考虑采用 权威证书或stunnel）</p>
<h2 id="5-1-CA中心创建证书"><a href="#5-1-CA中心创建证书" class="headerlink" title="5.1 CA中心创建证书"></a>5.1 CA中心创建证书</h2><ul>
<li><p>此时使用LDAP 主服务器 作为 CA 中心，自签名</p>
</li>
<li><p>安装 gnutls-bin 和 ssl-cert 包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gnutls-bin ssl-cert</span><br></pre></td></tr></table></figure></li>
<li><p>为证书授权中心创建私钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-privkey --bits 4096 --outfile /etc/ssl/private/mycakey.pem</span><br></pre></td></tr></table></figure></li>
<li><p>创建模板文件来定义CA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/ssl/ca.info</span><br><span class="line">	 cn = example (example company)  </span><br><span class="line">	 ca</span><br><span class="line">	 cert_signing_key</span><br><span class="line">	 expiration_days = 3650</span><br></pre></td></tr></table></figure></li>
<li><p>创建自签名 CA (根)证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-self-signed \</span><br><span class="line">--load-privkey /etc/ssl/private/mycakey.pem \</span><br><span class="line">--template /etc/ssl/ca.info \</span><br><span class="line">--outfile /usr/local/share/ca-certificates/mycacert.crt</span><br></pre></td></tr></table></figure></li>
<li><p>Note：<br>  <code>--outfile</code>路径是正确的，将CA证书写入<code>/usr/local/share/ca-certificates</code>。<br>  <strong>update-ca-certificates</strong> 将从这里获取受信任的本地CA。如果要从<code>/usr/share/ca-certificates</code>获取CA，需要调用<code>dpkg-reconfigure ca-certificates</code></p>
</li>
<li><p>将新的 CA 根证书添加到受信任 CA 列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-ca-certificates     # 会创建一个/etc/ssl/certs/mycacert.pem符号链接，指向/usr/local/share/ca-certificates中的真实文件</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="5-2-创建-LDAP-服务的服务器私钥与证书"><a href="#5-2-创建-LDAP-服务的服务器私钥与证书" class="headerlink" title="5.2 创建 LDAP 服务的服务器私钥与证书"></a>5.2 创建 LDAP 服务的服务器私钥与证书</h2><ul>
<li><p>创建私钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-privkey \</span><br><span class="line">--bits 2048 \</span><br><span class="line">--outfile /etc/ldap/ldap01_slapd_key.pem</span><br></pre></td></tr></table></figure></li>
<li><p>服务器信息文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/etc/ssl/ldap01.info</span><br><span class="line">	organization = example</span><br><span class="line">	cn = ldap01.example.top                     # 服务器证书的DN必须使用CN属性来命名服务器，并且CN必须携带服务器的完全限定域名，dns 需要有 A 记录解析</span><br><span class="line">	tls_www_server</span><br><span class="line">	encryption_key</span><br><span class="line">	signing_key</span><br><span class="line">	expiration_days = 365</span><br><span class="line">证书有效期为1年，仅对_`ldap01`_主机名有效</span><br></pre></td></tr></table></figure></li>
<li><p>创建LDAP服务器的证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-certificate \</span><br><span class="line">--load-privkey /etc/ldap/ldap01_slapd_key.pem \</span><br><span class="line">--load-ca-certificate /etc/ssl/certs/mycacert.pem \</span><br><span class="line">--load-ca-privkey /etc/ssl/private/mycakey.pem \</span><br><span class="line">--template /etc/ssl/ldap01.info \</span><br><span class="line">--outfile /etc/ldap/ldap01_slapd_cert.pem</span><br></pre></td></tr></table></figure></li>
<li><p>调整权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chgrp openldap /etc/ldap/ldap01_slapd_key.pem</span><br><span class="line">sudo chmod 0640 /etc/ldap/ldap01_slapd_key.pem</span><br></pre></td></tr></table></figure></li>
<li><p>ca根证书加入到受信列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp   cacertificatefile  /usr/local/share/ca-certificates/mycacert.crt</span><br><span class="line">sudo update-ca-certificates</span><br></pre></td></tr></table></figure>
</li>
<li><p>对LDAP服务配置证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=config</span><br><span class="line">add: olcTLSCACertificateFile</span><br><span class="line">olcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem</span><br><span class="line">-</span><br><span class="line">add: olcTLSCertificateFile</span><br><span class="line">olcTLSCertificateFile: /etc/ldap/ldap01_slapd_cert.pem</span><br><span class="line">-</span><br><span class="line">add: olcTLSCertificateKeyFile</span><br><span class="line">olcTLSCertificateKeyFile: /etc/ldap/ldap01_slapd_key.pem</span><br></pre></td></tr></table></figure></li>
<li><p>配置slapd-config数据库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif </span><br></pre></td></tr></table></figure></li>
<li><p>报错调整，更改<code>certinfo.ldif</code>，将<code>add</code>改成了<code>replace</code>，可以解决以下问题。修改后再次执行<code>ldapmodify</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif </span><br><span class="line">	SASL/EXTERNAL authentication started SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth </span><br><span class="line">	SASL SSF: 0 </span><br><span class="line">	modifying entry &quot;cn=config&quot; ldap_modify: Inappropriate matching (18) </span><br><span class="line">	additional info: modify/add: olcTLSCACertificateFile: no equality matching rule</span><br></pre></td></tr></table></figure></li>
<li><p>增添配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/ldap.conf</span><br><span class="line">	# LDAP Defaults</span><br><span class="line">	# See ldap.conf(5) for details</span><br><span class="line">	# This file should be world readable but not world writable.	</span><br><span class="line">	BASE       dc=example,dc=top                                                      # LDAP服务的基础DN</span><br><span class="line">	URI ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用</span><br><span class="line">	#SIZELIMIT  12                                                                      # 搜索结果的数量限制</span><br><span class="line">	#TIMELIMIT  15                                                                     # 最长搜索时间</span><br><span class="line">	#DEREF              never                                                            # 指定对别名的处理方式</span><br><span class="line">	# TLS certificates (needed for GnuTLS)</span><br><span class="line">	TLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径</span><br><span class="line">	TLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书</span><br></pre></td></tr></table></figure></li>
<li><p>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/default/slapd</span><br><span class="line">	SLAPD_SERVICES=&quot;ldap:/// ldapi:/// ldaps:///&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>测试启动 TLS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapwhoami -x -ZZ -H ldap://ldap01.example.com</span><br><span class="line">anonymous</span><br></pre></td></tr></table></figure></li>
<li><p>测试连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapwhoami -x -H ldaps://ldap01.example.com</span><br><span class="line">anonymous</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器"><a href="#5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器" class="headerlink" title="5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器"></a>5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器</h2><ul>
<li>指定目录保存<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir ldap02-ssl</span><br><span class="line">cd ldap02-ssl</span><br><span class="line">certtool --generate-privkey \</span><br><span class="line">--bits 2048 \</span><br><span class="line">--outfile ldap02_slapd_key.pem</span><br></pre></td></tr></table></figure></li>
<li>编辑信息文件ldap02.info<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">organization = example</span><br><span class="line">cn = ldap02.example.top                      </span><br><span class="line">tls_www_server</span><br><span class="line">encryption_key</span><br><span class="line">signing_key</span><br><span class="line">expiration_days = 365</span><br></pre></td></tr></table></figure></li>
<li>创建证书<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-certificate \</span><br><span class="line">--load-privkey ldap02_slapd_key.pem \</span><br><span class="line">--load-ca-certificate /etc/ssl/certs/mycacert.pem \</span><br><span class="line">--load-ca-privkey /etc/ssl/private/mycakey.pem \</span><br><span class="line">--template ldap02.info \</span><br><span class="line">--outfile ldap02_slapd_cert.pem</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/ssl/certs/mycacert.pem .</span><br><span class="line">scp -r ldap02-ssl user@ldap02_ip:</span><br></pre></td></tr></table></figure>
<ul>
<li>从服务器中安装证书<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ldap02_slapd_cert.pem ldap02_slapd_key.pem /etc/ldap</span><br><span class="line">sudo chgrp openldap /etc/ldap/ldap02_slapd_key.pem</span><br><span class="line">sudo chmod 0640 /etc/ldap/ldap02_slapd_key.pem</span><br><span class="line">sudo cp mycacert.pem /usr/local/share/ca-certificates/mycacert.crt</span><br><span class="line">sudo update-ca-certificates</span><br></pre></td></tr></table></figure></li>
<li>对LDAP服务配置证书 <code>./certinfo.ldif </code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=config</span><br><span class="line">add: olcTLSCACertificateFile</span><br><span class="line">olcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem</span><br><span class="line">-</span><br><span class="line">add: olcTLSCertificateFile</span><br><span class="line">olcTLSCertificateFile: /etc/ldap/ldap02_slapd_cert.pem</span><br><span class="line">-</span><br><span class="line">add: olcTLSCertificateKeyFile</span><br><span class="line">olcTLSCertificateKeyFile: /etc/ldap/ldap02_slapd_key.pem</span><br></pre></td></tr></table></figure></li>
<li>配置slapd-config数据库：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif </span><br></pre></td></tr></table></figure></li>
<li>增添配置文件<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/ldap.conf</span><br><span class="line">	BASE       dc=example,dc=top                                                      # LDAP服务的基础DN</span><br><span class="line">	URI ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用</span><br><span class="line">	#SIZELIMIT  12                                                                      # 搜索结果的数量限制</span><br><span class="line">	#TIMELIMIT  15                                                                     # 最长搜索时间</span><br><span class="line">	#DEREF              never                                                            # 指定对别名的处理方式</span><br><span class="line">	# TLS certificates (needed for GnuTLS)</span><br><span class="line">	TLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径</span><br><span class="line">	TLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书</span><br></pre></td></tr></table></figure></li>
<li>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/default/slapd</span><br><span class="line">	SLAPD_SERVICES=&quot;ldap:/// ldapi:/// ldaps:///&quot;</span><br></pre></td></tr></table></figure></li>
<li>测试启动 TLS<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapwhoami -x -ZZ -H ldap://ldap02.example.top</span><br><span class="line">anonymous</span><br></pre></td></tr></table></figure></li>
<li>测试连接<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapwhoami -x -H ldaps://ldap02.example.top</span><br><span class="line">anonymous</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="5-4-使用合法证书"><a href="#5-4-使用合法证书" class="headerlink" title="5.4 使用合法证书"></a>5.4 使用合法证书</h2><ul>
<li><p>将新的 CA 根证书添加到受信任 CA 列表（客户端需要）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo   cp   _.example.top-chain.pem   /usr/local/share/ca-certificates/mycacert.crt</span><br><span class="line">sudo update-ca-certificates</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备服务器证书和私钥（服务端）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ls /etc/ldap</span><br><span class="line">	certinfo.ldif   _.example.top-crt.pem   _.example.top-key.pem</span><br><span class="line">sudo chgrp openldap /etc/ldap/_.example.top-key.pem</span><br><span class="line">sudo chmod 0640 /etc/ldap/_.example.top-key.pem</span><br></pre></td></tr></table></figure>
</li>
<li><p>certinfo.ldif</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcTLSCACertificateFile</span><br><span class="line">olcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem</span><br><span class="line">-</span><br><span class="line">replace: olcTLSCertificateFile</span><br><span class="line">olcTLSCertificateFile: /etc/ldap/_.example.top-crt.pem</span><br><span class="line">-</span><br><span class="line">replace: olcTLSCertificateKeyFile</span><br><span class="line">olcTLSCertificateKeyFile: /etc/ldap/_.example.top-key.pem</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapadd  -Y   EXTERNAL  -H  ldapi:///   -f    certinfo.ldif</span><br></pre></td></tr></table></figure>


<ul>
<li>增添配置文件，这是作为客户端连接 ldap 服务器使用的配置<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/ldap.conf</span><br><span class="line">	BASE       dc=example,dc=top                                                      # LDAP服务的基础DN</span><br><span class="line">	#URI ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用</span><br><span class="line">	#SIZELIMIT  12                                                                      # 搜索结果的数量限制</span><br><span class="line">	#TIMELIMIT  15                                                                     # 最长搜索时间</span><br><span class="line">	#DEREF              never                                                            # 指定对别名的处理方式</span><br><span class="line">	# TLS certificates (needed for GnuTLS)</span><br><span class="line">	TLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径，必需</span><br><span class="line">	TLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书</span><br></pre></td></tr></table></figure></li>
<li>启用 ldaps，重启 slapd<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/default/slapd</span><br><span class="line">	SLAPD_SERVICES=&quot;ldap:/// ldapi:/// ldaps:///&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="5-5-使用-nextcloud-测试加密连接"><a href="#5-5-使用-nextcloud-测试加密连接" class="headerlink" title="5.5 使用 nextcloud 测试加密连接"></a>5.5 使用 nextcloud 测试加密连接</h2><ul>
<li>docker 安装 nexcloud，登录 UI ，点击账户，选择应用  </li>
<li>开启 LDAP 集成  </li>
<li>设置连接  </li>
<li>ldaps连接(严格一致才是tls加密，nextcloud应该只信任权威证书)</li>
<li>明文传输</li>
</ul>
<h2 id="5-6-stunnel-加密连接应用-例：phpldapadmin"><a href="#5-6-stunnel-加密连接应用-例：phpldapadmin" class="headerlink" title="5.6 stunnel 加密连接应用(例：phpldapadmin)"></a>5.6 stunnel 加密连接应用(例：phpldapadmin)</h2><p>链路： ldap user ui  —- stunnel client  accept  —-  stunnel client connect  —- stunnel server accept  —- stunnel server connect —-ldap server port</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt install -y stunnel4</span><br><span class="line">vim /etc/default/stunnel4</span><br><span class="line">	ENABLED=1</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># stunnel 服务端</span><br><span class="line">	cert = /etc/stunnel/stunnel.pem</span><br><span class="line">	key = /etc/stunnel/stunnel-key.pem</span><br><span class="line">	verify = 3</span><br><span class="line">	client = no</span><br><span class="line">	debug = 6</span><br><span class="line">	pid = /var/run/stunnel4/stunnel4.pid</span><br><span class="line">	</span><br><span class="line">	[ldap]</span><br><span class="line">	accept = 10.13.3.106:6360                # 监听 stunnel 服务的流量，客户端（是指stunnel 客户端）将连接此目标并发送流量到这里</span><br><span class="line">	connect = 10.13.3.106:389                # 转发到 stunnel 加密连接的服务的端口</span><br><span class="line">	CAfile = /etc/stunnel/stunnel.pem</span><br><span class="line"></span><br><span class="line"># stunnel 客户端</span><br><span class="line">	cert = /etc/stunnel/stunnel.pem</span><br><span class="line">	key = /etc/stunnel/stunnel-key.pem</span><br><span class="line">	verify = 3</span><br><span class="line">	client = yes</span><br><span class="line">	debug = 6</span><br><span class="line">	setuid = stunnel4</span><br><span class="line">	setgid = stunnel4</span><br><span class="line">	pid = /var/run/stunnel4/stunnel4.pid</span><br><span class="line">	</span><br><span class="line">	[ldap]</span><br><span class="line">	accept = 10.13.3.107:389                # 监听 stunnel 服务的流量，客户端（是指ldap的客户端）将连接此目标并发送流量到这里</span><br><span class="line">	connect = 10.13.3.106:6360              # 加密连接并转发到 stunnel 的服务端</span><br><span class="line">	CAfile = /etc/stunnel/stunnel.pem</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/phpldapadmin/config.php</span><br><span class="line">	$servers-&gt;setValue(&#x27;server&#x27;,&#x27;host&#x27;,&#x27;69.87.216.102&#x27;);  # 指向 stunnel 客户端，和他本地监听的端口</span><br><span class="line">	$servers-&gt;setValue(&#x27;server&#x27;,&#x27;port&#x27;,389);	</span><br></pre></td></tr></table></figure>
<h1 id="六、-其他模块"><a href="#六、-其他模块" class="headerlink" title="六、 其他模块"></a>六、 其他模块</h1><h2 id="6-1-日志模块"><a href="#6-1-日志模块" class="headerlink" title="6.1 日志模块"></a>6.1 日志模块</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/loglevel.ldif</span><br><span class="line">	dn: cn=config</span><br><span class="line">	changetype: modify</span><br><span class="line">	replace: olcLogLevel</span><br><span class="line">	olcLogLevel: stats</span><br><span class="line"></span><br><span class="line">ldapmodify  -Y  EXTERNAL  -H  ldapi:///  -f  loglevel.ldif               # 日志在/var/log/syslog | grep slapd , 比默认的级别详细</span><br></pre></td></tr></table></figure>
<h2 id="6-2-member-of"><a href="#6-2-member-of" class="headerlink" title="6.2 member of"></a>6.2 member of</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/refint.ldif</span><br><span class="line">	# enable_refint.ldif</span><br><span class="line">	dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">	changetype: modify</span><br><span class="line">	add: olcModuleLoad</span><br><span class="line">	olcModuleLoad: refint.la</span><br><span class="line">	-</span><br><span class="line">	dn: olcOverlay=refint,olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">	changetype: add</span><br><span class="line">	objectClass: olcOverlayConfig</span><br><span class="line">	objectClass: olcRefintConfig</span><br><span class="line">	olcOverlay: refint</span><br><span class="line"></span><br><span class="line">ldapadd -Q -Y EXTERNAL -H ldapi:// -f refint.ldif</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/memberof.ldif</span><br><span class="line">	dn: cn=module,cn=config</span><br><span class="line">	changetype: add</span><br><span class="line">	cn: module</span><br><span class="line">	objectClass: olcModuleList</span><br><span class="line">	olcModulePath: /usr/lib/ldap</span><br><span class="line">	</span><br><span class="line">	dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">	changetype: modify</span><br><span class="line">	add: olcModuleLoad</span><br><span class="line">	olcModuleLoad: memberof.la</span><br><span class="line">	</span><br><span class="line">	dn: olcOverlay=memberof,olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">	changetype: add</span><br><span class="line">	objectClass: olcConfig</span><br><span class="line">	objectClass: olcMemberOf</span><br><span class="line">	objectClass: olcOverlayConfig</span><br><span class="line">	objectClass: top</span><br><span class="line">	olcOverlay: memberof</span><br><span class="line">	olcMemberOfDangling: ignore</span><br><span class="line">	olcMemberOfRefInt: TRUE</span><br><span class="line">	olcMemberOfGroupOC: groupOfNames</span><br><span class="line">	olcMemberOfMemberAD: member</span><br><span class="line">	olcMemberOfMemberOfAD: memberOf</span><br><span class="line"></span><br><span class="line">ldapmodify -Y EXTERNAL -H ldapi:/// -f memberof.ldif</span><br></pre></td></tr></table></figure>

<h2 id="6-3-Self-Service-Password-自助密码管理（需要反代设置-链接不能正常进入）"><a href="#6-3-Self-Service-Password-自助密码管理（需要反代设置-链接不能正常进入）" class="headerlink" title="6.3 Self Service Password 自助密码管理（需要反代设置+链接不能正常进入）"></a>6.3 Self Service Password 自助密码管理（需要反代设置+链接不能正常进入）</h2><ul>
<li><p>跨域权限设置修改密码的权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下列权限可以使得 &quot;admin,example,net&quot; 对这个域 &quot;dc=example,dc=tech&quot; 做用户添加、属性修改</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange by dn=&quot;cn=admin,dc=example,dc=net&quot; write by anonymous auth by self write by * none</span><br><span class="line">olcAccess: &#123;1&#125;to dn.subtree=&quot;dc=example,dc=tech&quot; by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write</span><br></pre></td></tr></table></figure>
</li>
<li><p>ssp.conf.php  成功版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$debug = false;</span><br><span class="line">$keyphrase = &quot;example&quot;;</span><br><span class="line">$use_sms = false;</span><br><span class="line">$use_questions = false;</span><br><span class="line">$lang = &quot;cn,zh-CN&quot;;</span><br><span class="line">$use_change = true;</span><br><span class="line"></span><br><span class="line"># LDAP</span><br><span class="line"></span><br><span class="line">$ldap_url = &quot;ldaps://ldap01.example.net/&quot;;</span><br><span class="line">$ldap_starttls = false;</span><br><span class="line">$ldap_binddn = &quot;cn=admin,dc=example,dc=net&quot;;</span><br><span class="line">$ldap_bindpw = &#x27;example@2020&#x27;;</span><br><span class="line">$ldap_base = &quot;dc=example,dc=net&quot;;</span><br><span class="line">$ldap_base = &quot;dc=example,dc=tech&quot;;</span><br><span class="line"></span><br><span class="line">$ldap_login_attribute = &quot;uid&quot;;</span><br><span class="line">$ldap_fullname_attribute = &quot;cn&quot;;</span><br><span class="line">$ldap_filter = &quot;(&amp;(objectClass=person)($ldap_login_attribute=&#123;login&#125;))&quot;;</span><br><span class="line">$ldap_use_exop_passwd = false;</span><br><span class="line">$ldap_use_ppolicy_control = false;</span><br><span class="line">$TLS_REQCERT = &quot;allow&quot;;</span><br><span class="line"></span><br><span class="line"># email</span><br><span class="line">$mail_attributes = array( &quot;mail&quot;, &quot;gosaMailAlternateAddress&quot;, &quot;proxyAddresses&quot; );</span><br><span class="line">$mail_address_use_ldap = true;</span><br><span class="line">$mail_from = &quot;x.z@example.net&quot;;</span><br><span class="line">$mail_from_name = &quot;密码自主修改服务&quot;;</span><br><span class="line">$mail_signature = &quot;英博智云&quot;;</span><br><span class="line">$notify_on_change = false;</span><br><span class="line">$mail_protocol = &#x27;smtp&#x27;;</span><br><span class="line">$mail_smtp_host = &#x27;smtphz.qiye.163.com&#x27;;</span><br><span class="line">$mail_smtp_auth = true;</span><br><span class="line">$mail_smtp_user = &quot;x.z@example.net&quot;;</span><br><span class="line">$mail_smtp_pass = &#x27;uKLMbr2mUp3CDEXC&#x27;;</span><br><span class="line">$mail_smtp_port = 465;</span><br><span class="line">$mail_smtp_timeout = 30;</span><br><span class="line">$mail_smtp_keepalive = false;</span><br><span class="line">$mail_smtp_secure = &#x27;ssl&#x27;;</span><br><span class="line">$mail_smtp_autotls = false;</span><br><span class="line">$mail_smtp_options = array();</span><br><span class="line">$mail_contenttype = &#x27;text/plain&#x27;;</span><br><span class="line">$mail_wordwrap = 0;</span><br><span class="line">$mail_charset = &#x27;utf-8&#x27;;</span><br><span class="line">$mail_priority = 3;</span><br><span class="line"></span><br><span class="line"># password policy</span><br><span class="line">$pwd_min_length = 6;</span><br><span class="line">$pwd_max_length = 14;</span><br><span class="line">$pwd_min_lower = 1;</span><br><span class="line">$pwd_min_upper = 1;</span><br><span class="line">$pwd_min_digit = 1;</span><br><span class="line">$pwd_min_special = 1;</span><br><span class="line">$pwd_special_chars = &quot;^a-zA-Z0-9&quot;;</span><br><span class="line">$pwd_complexity = 4;</span><br><span class="line">$pwd_no_reuse = true;</span><br><span class="line">$pwd_forbidden_words = array(&quot;example&quot;, &quot;example&quot;, &quot;example&quot;, &quot;password&quot;);</span><br><span class="line">$pwd_show_policy_pos = &quot;above&quot;;</span><br><span class="line">$pwd_show_policy = &quot;onerror&quot;;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8000:80 \</span><br><span class="line">&gt; --restart=always \</span><br><span class="line">&gt; --name sspass \</span><br><span class="line">&gt; -v /home/example/sspasswd/conf.php:/var/www/conf/config.inc.local.php \</span><br><span class="line">&gt; -itd docker.io/ltbproject/self-service-password</span><br></pre></td></tr></table></figure>

<h3 id="6-3-1-不能进入修改链接-Token-is-not-valid"><a href="#6-3-1-不能进入修改链接-Token-is-not-valid" class="headerlink" title="6.3.1 不能进入修改链接 Token is not valid"></a>6.3.1 不能进入修改链接 Token is not valid</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">注释了这两项</span><br><span class="line">#$use_tokens = true;</span><br><span class="line">#$crypt_tokens = true;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-2-反向代理"><a href="#6-3-2-反向代理" class="headerlink" title="6.3.2 反向代理"></a>6.3.2 反向代理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">upstream ssp &#123;</span><br><span class="line">  server 10.13.3.108:8000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name ssp.example.net;</span><br><span class="line">    return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl ;</span><br><span class="line">    server_name ssp.example.net;</span><br><span class="line">    ssl_certificate webmin/tls_ca.pem;</span><br><span class="line">    ssl_certificate_key webmin/tls_key.pem;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">      proxy_pass http://ssp;</span><br><span class="line">      proxy_set_header Host $host;</span><br><span class="line">      proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">      proxy_set_header X-Forwarded-Proto &quot;https&quot;;</span><br><span class="line">      proxy_read_timeout 1800s;</span><br><span class="line">      proxy_http_version 1.1;</span><br><span class="line">      proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">      proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="6-4-LDAP-对目录信息的数据做备份还原和迁移"><a href="#6-4-LDAP-对目录信息的数据做备份还原和迁移" class="headerlink" title="6.4 LDAP 对目录信息的数据做备份还原和迁移"></a>6.4 LDAP 对目录信息的数据做备份还原和迁移</h2><h3 id="6-4-1-备份"><a href="#6-4-1-备份" class="headerlink" title="6.4.1 备份"></a>6.4.1 备份</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo slapcat -n 3 -l ./back3.ldif           # -n 指定数据库编号，数字对应各个dit的数据库编号( 配置数据库----olcDatabase=&#123;0&#125;config.ldif; 目录信息数据库----olcDatabase=&#123;1&#125;mdb.ldif )</span><br></pre></td></tr></table></figure>

<h3 id="6-4-2-恢复"><a href="#6-4-2-恢复" class="headerlink" title="6.4.2 恢复"></a>6.4.2 恢复</h3><p>原服务器上恢复，服务需要暂停</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop slapd</span><br></pre></td></tr></table></figure>

<p>配置目录一般位于 <code>/etc/openldap/slapd.d</code>，将原有配置删除，然后使用 <code>slapadd</code> 导入新的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf /etc/ldap/slapd.d/*</span><br><span class="line">$ slapadd  -n  0  -F  /etc/ldap/slapd.d  -l  ./config.2021-09-18.ldif</span><br><span class="line">$ chown -R openldap:openldap /etc/ldap/slapd.d</span><br></pre></td></tr></table></figure>

<p>数据目录一般位于 <code>/var/lib/ldap-*</code>，模拟时，将原有数据删除，然后使用 <code>slapadd</code> 导入新的数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rm  -rf  /var/lib/ldap-example/*         # 定制了不同的dit有不同的目录分别存储不同domain的内容，注意，导入前目录必需首先存在，且权属 openldap:openldap。</span><br><span class="line">$ slapadd -n 1 -F /etc/openldap/slapd.d -l ./data.2021-09-18.ldif</span><br><span class="line">$ chown -R openldap:openldap  /var/lib/ldap-example</span><br><span class="line">$ systemctl start slapd</span><br></pre></td></tr></table></figure>
<h3 id="6-4-3-openldap的迁移"><a href="#6-4-3-openldap的迁移" class="headerlink" title="6.4.3 openldap的迁移"></a>6.4.3 openldap的迁移</h3><p>playbook 新建的服务器，执行恢复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slapadd -n 1 -F /etc/openldap/slapd.d -l ./data.2021-09-18.ldif</span><br><span class="line"></span><br><span class="line">#如果导入失败，或者数据已存在，删除rm -rf /var/lib/ldap/*  重新导入</span><br></pre></td></tr></table></figure>


<h1 id="七、-命令资料"><a href="#七、-命令资料" class="headerlink" title="七、 命令资料"></a>七、 命令资料</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jenyzhang/article/details/56487627">以下来自此处</a><br>ldap<br>    |-slapd             目录服务的主要程序<br>    |-slurpd           目录服务进行复制的程序<br>    |-slapadd           向目录中添加数据<br>    |-slapcat           把目录中的条目导出成ldif文件<br>    |-slapindex         重建目录的索引<br>    |-ldapcompare       对目录的条目的属性进行比较<br>    |-ldapadd           向目录服务中添加条目<br>    |-ldapdelete        删除目录中的条目<br>    |-ldapmodify        更新目录中条目的值<br>    |-ldapmodrdn        更改条目的DN<br>    |-ldappasswd        更改条目的密码<br>    |-ldapsearch        对目录进行查询</p>
</blockquote>
<blockquote>
<p>ldapadd<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -h   目录服务的地址<br>      -w   绑定DN的密码<br>      -f   使用ldif文件进行条目添加的文件<br>      例子<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -f &#x2F;root&#x2F;test.ldif<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret (这样写就是在命令行添加条目)  </p>
</blockquote>
<p>       </p>
<blockquote>
<p>ldapsearch<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -w   绑定DN的密码<br>      -b   指定要查询的根节点<br>      -H   制定要查询的服务器<br>      -s   指定搜索范围的类型<br>     例子<br>        ldapsearch -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -b “dc&#x3D;starxing,dc&#x3D;com”<br>       使用简单认证，用 “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” 进行绑定，<br>       要查询的根是 “dc&#x3D;starxing,dc&#x3D;com”。这样会把绑定的用户能访问”dc&#x3D;starxing,dc&#x3D;com”下的所有数据显示出来。<br>       ldapsearch -x -W -D “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -b “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -h troy.osdn.zzti.edu.cn<br>       ldapsearch -b “dc&#x3D;canon-is,dc&#x3D;jp” -H ldaps:&#x2F;&#x2F;192.168.0.92:636<br>       (需要修改openldap客户端的配置文件ldap.conf,参考：<a target="_blank" rel="noopener" href="http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm">http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm</a>)</p>
</blockquote>
<blockquote>
<p>ldapdelete <br>      ldapdelete -x -D “cn&#x3D;Manager,dc&#x3D;test,dc&#x3D;com” -w secret “uid&#x3D;test1,ou&#x3D;People,dc&#x3D;test,dc&#x3D;com”<br>      ldapdelete -x -D ‘cn&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secert ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’<br>      这样就可以删除’uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’记录了，应该注意一点，其下有子条目的不能删除<br>   例子2 acl-dele.ldif<br>       dn: olcDatabase&#x3D;{3}mdb,cn&#x3D;config<br>       delete: olcAccess<br>       olcAccess: {2}<br>       olcAccess: {3}<br>       olcAccess: {4}<br>   ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f acl-dele.ldif</p>
</blockquote>
<blockquote>
<p>ldappasswd<br>    -x   进行简单认证<br>    -D   用来绑定服务器的DN<br>    -w   绑定DN的密码<br>    -S   提示的输入密码<br>    -s pass 把密码设置为pass<br>    -a pass 设置old passwd为pass<br>    -A   提示的设置old passwd<br>    -H   是指要绑定的服务器<br>    -I   使用sasl会话方式<br>   例子<br>    ldappasswd -x -D ‘cm&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secret ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’ -S<br>       New password:<br>       Re-enter new password:<br>       就可以更改密码了，如果原来记录中没有密码，将会自动生成一个userPassword。<br>  <br> <br>ldapmodify<br>     -a 添加新的条目.缺省的是修改存在的条目.<br>     -C 自动追踪引用.<br>     -c 出错后继续执行程序并不中止.缺省情况下出错的立即停止.比如如果你的ldif 文件内的某个条目在<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/mysql" title="MySQL知识库">数据库</a>内并不存在,缺省情况下程序立即退出,但如果使用了该参数,程序忽略该错误继续执行.<br>     -n 用于调试到服务器的通讯.但并不实际执行搜索.服务器关闭时,返回错误；服务器<br>       打开时,常和-v 参数一起<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/softwaretest" title="软件测试知识库">测试</a>到服务器是否是一条通路.<br>     -v 运行在详细模块.在标准输出中打出一些比较详细的信息.比如:连接到服务器的<br>       ip 地址和端口号等.<br>     -M  打开 manage DSA IT 控制. -MM 把该控制设置为重要的.<br>     -f file 从文件内读取条目的修改信息而不是从标准输入读取.<br>    -x 使用简单认证.<br>    -D binddn 指定搜索的用户名(一般为一dn 值).<br>    -W 指定了该参数,系统将弹出一提示入用户的密码.它和-w 参数相对使用.<br>    -w bindpasswd 直接指定用户的密码. 它和-W 参数相对使用.<br>    -H ldapuri 指定连接到服务器uri(ip 地址和端口号,常见格式为 ldap:&#x2F;&#x2F;hostname:port ).如果使用了-H 就不能使用-h 和-p 参数.<br>    -h ldaphost 指定要连接的主机的名称&#x2F;ip 地址.它和-p 一起使用<br>    -p ldapport 指定要连接目录服务器的端口号.它和-h 一起使用，如果使用了-h 和-p 参数就不能使用-H 参数.<br>    -Z 使用StartTLS 扩展操作.如果使用-ZZ,命令强制使用StartTLS 握手成功.<br>    -V 启用证书认证功能,目录服务器使用客户端证书进行身份验证,必须与-ZZ 强制启用<br>       TLS 方式配合使用,并且匿名绑定到目录服务器.<br>    -e 设置客户端证书文件,例: -e cert&#x2F;client.crt<br>    -E 设置客户端证书私钥文件,例: -E cert&#x2F;client.key<br>   例子<br>   ldapmodify -x -D “cn&#x3D;root,dc&#x3D;it,dc&#x3D;com” -W -f modify.ldif    #   将modify.ldif中的记录更新原有的记录。</p>
</blockquote>
<h1 id="八、-参考链接"><a href="#八、-参考链接" class="headerlink" title="八、 参考链接"></a>八、 参考链接</h1><p><a target="_blank" rel="noopener" href="https://github.com/jt6562/LDAP-read-notes/blob/master/ldap-guide/OpenLDAP%E7%AE%A1%E7%90%86%E5%91%98%E6%89%8B%E5%86%8C.md">指南</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kevingrace/p/5773974.html">知识总结</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/js1314/p/12887893.html">参考1</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1932586">参考2</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011607971/article/details/121126289?spm=1001.2014.3001.5501#t3">参考3</a><br><a target="_blank" rel="noopener" href="https://ubuntu.com/server/docs/service-ldap-with-tls">Ubuntu wiki</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shu-sheng/p/14450815.html">tls参考1</a><br><a target="_blank" rel="noopener" href="https://hmli.ustc.edu.cn/doc/linux/ubuntu-ldap/ubuntu-ldap.html#id14">tls参考2</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/643010354">tls参考3</a>  </p>
<h1 id="九、问题："><a href="#九、问题：" class="headerlink" title="九、问题："></a>九、问题：</h1><h2 id="9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果"><a href="#9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果" class="headerlink" title="9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果"></a>9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果</h2><h2 id="9-2-日志功能开启失败"><a href="#9-2-日志功能开启失败" class="headerlink" title="9.2 日志功能开启失败"></a>9.2 日志功能开启失败</h2><pre><code>已经调整日志级别，在系统日志中查看并grep
</code></pre>
<h2 id="9-3-证书缺失-只能使用ldap01-这个信息查询）"><a href="#9-3-证书缺失-只能使用ldap01-这个信息查询）" class="headerlink" title="9.3 证书缺失(只能使用ldap01,这个信息查询）"></a>9.3 证书缺失(只能使用ldap01,这个信息查询）</h2><pre><code>采取使用权威证书
</code></pre>
<h2 id="9-4-重启slap报错-tls-init-failed"><a href="#9-4-重启slap报错-tls-init-failed" class="headerlink" title="9.4 重启slap报错 tls init   failed"></a>9.4 重启slap报错 tls init   failed</h2><pre><code>解决办法：重新生成证书
</code></pre>
<h2 id="9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code"><a href="#9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code" class="headerlink" title="9.5 报错 ldap_start_tls: Connect error (-11)    \n    additional info: (unknown error code)"></a>9.5 报错 ldap_start_tls: Connect error (-11)    \n    additional info: (unknown error code)</h2><pre><code>可能是由于服务器证书的通用名（Common Name）字段是否与主机名不一致，请检查主机名和服务器证书
</code></pre>
<h2 id="9-6-连接问题"><a href="#9-6-连接问题" class="headerlink" title="9.6 连接问题"></a>9.6 连接问题</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldaps://ldap.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W            # 在服务器本机执行此查询的报错。但是在另一个机器可以成功查询</span><br><span class="line">	ldap_sasl_bind(SIMPLE): Can&#x27;t contact LDAP server (-1)                                 # 配置 ldap.conf 之后成功解决并有输出</span><br></pre></td></tr></table></figure>

<h2 id="9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”"><a href="#9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”" class="headerlink" title="9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”"></a>9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 首先尝试重新部署，发现执行镜像复制的剧本之前可以正常创建所有的条目</span><br><span class="line">    解决：在mirror mode 开启时，需要指定相应的数据库</span><br><span class="line">2.  shadow context; no update referral  根本原因是需要检查权限</span><br></pre></td></tr></table></figure>

<h1 id="十、-验证"><a href="#十、-验证" class="headerlink" title="十、 验证"></a>十、 验证</h1><h2 id="10-1-检测连接命令："><a href="#10-1-检测连接命令：" class="headerlink" title="10.1 检测连接命令："></a>10.1 检测连接命令：</h2><p> ldaps:&#x2F;&#x2F;    —-ldap over ssl  使用636 ，从连接开始加密   ;        ldap:&#x2F;&#x2F;           —ldap_start_tls(-ZZ参数):    使用389，从传输开始加密</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldaps://ldap01.example.top:636 -D &quot;cn=admin,dc=example,dc=top&quot; -W -b &quot;dc=example,dc=top&quot; -s sub &quot;(objectClass=person)&quot;</span><br><span class="line"></span><br><span class="line">ldapsearch -H ldap://10.13.3.106  -D &quot;cn=admin,dc=example,dc=top&quot; -W -b &quot;dc=example,dc=top&quot; -s sub &quot;(objectClass=person)&quot;</span><br><span class="line"></span><br><span class="line">ldapsearch -H ldap://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W -b &quot;dc=example,dc=top&quot; -s sub &quot;(objectClass=person)&quot;</span><br></pre></td></tr></table></figure>
<h2 id="10-2-验证和日志"><a href="#10-2-验证和日志" class="headerlink" title="10.2 验证和日志"></a>10.2 验证和日志</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldap://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W   -ZZ      #  启用了tls功能 ，-ZZ 参数，仍然是 389 端口，连接后在传输过程中加密</span><br><span class="line">	</span><br><span class="line">	Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 fd=14 ACCEPT from IP=10.13.3.107:60674 (IP=0.0.0.0:389)</span><br><span class="line">	Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 EXT oid=1.3.6.1.4.1.1466.20037</span><br><span class="line">	Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 STARTTLS</span><br><span class="line">	Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 RESULT oid= err=0 text=</span><br><span class="line">	Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 fd=14 TLS established tls_ssf=256 ssf=256</span><br><span class="line">	Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; method=128</span><br><span class="line">	Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; mech=SIMPLE ssf=0</span><br><span class="line">	Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 RESULT tag=97 err=0 text=</span><br><span class="line">	Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=2 SRCH base=&quot;dc=example,dc=top&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">	Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=2 SEARCH RESULT tag=101 err=0 nentries=6 text=</span><br><span class="line">	Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=3 UNBIND</span><br><span class="line">	Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 fd=14 closed</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldap://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W        # 明文传输</span><br><span class="line">	</span><br><span class="line">	Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 fd=14 ACCEPT from IP=10.13.3.107:37760 (IP=0.0.0.0:389)</span><br><span class="line">	Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; method=128</span><br><span class="line">	Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; mech=SIMPLE ssf=0</span><br><span class="line">	Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 RESULT tag=97 err=0 text=</span><br><span class="line">	Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=1 SRCH base=&quot;dc=example,dc=top&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">	Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=1 SEARCH RESULT tag=101 err=0 nentries=6 text=</span><br><span class="line">	Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=2 UNBIND</span><br><span class="line">	Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 fd=14 closed</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldaps://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W        # 从连接就开始加密</span><br><span class="line"></span><br><span class="line">	Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 ACCEPT from IP=10.13.3.107:58726 (IP=0.0.0.0:636)</span><br><span class="line">	Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 TLS established tls_ssf=256 ssf=256</span><br><span class="line">	Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; method=128</span><br><span class="line">	Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; mech=SIMPLE ssf=0</span><br><span class="line">	Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 RESULT tag=97 err=0 text=</span><br><span class="line">	Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=1 SRCH base=&quot;dc=example,dc=top&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">	Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=1 SEARCH RESULT tag=101 err=0 nentries=6 text=</span><br><span class="line">	Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=2 UNBIND</span><br><span class="line">	Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 closed</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldaps://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W -ZZ</span><br><span class="line">	ldap_start_tls: Operations error (1)</span><br><span class="line">        additional info: TLS already started</span><br><span class="line"></span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 ACCEPT from IP=10.13.3.107:39894 (IP=0.0.0.0:636)</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 TLS established tls_ssf=256 ssf=256</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 EXT oid=1.3.6.1.4.1.1466.20037</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 STARTTLS</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 RESULT oid= err=1 text=TLS already started                # 证明二者冲突，不能同时开启</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=1 UNBIND</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 closed</span><br></pre></td></tr></table></figure>



<h1 id="十一、应用测试"><a href="#十一、应用测试" class="headerlink" title="十一、应用测试"></a>十一、应用测试</h1><ul>
<li><p>建立 ldap 管理帐号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=admin,dc=xxx,dc=xx </span><br><span class="line">changetype: add  </span><br><span class="line">objectClass: simpleSecurityObject  </span><br><span class="line">objectClass: organizationalRole  </span><br><span class="line">cn: admin  </span><br><span class="line">userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi  </span><br><span class="line">  </span><br><span class="line">-  </span><br><span class="line">dn: cn=reader,dc=xxx2,dc=xx2  </span><br><span class="line">changetype: add  </span><br><span class="line">objectClass: simpleSecurityObject  </span><br><span class="line">objectClass: organizationalRole  </span><br><span class="line">cn: admin  </span><br><span class="line">userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure>
</li>
<li><p>详细的公司架构 ldif</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"># Generated by LDAP Account Manager on 2023-10-24 03:08:40</span><br><span class="line"># version: 1</span><br><span class="line"></span><br><span class="line">dn: dc=example,dc=net</span><br><span class="line">dc: example</span><br><span class="line">objectclass: top</span><br><span class="line">objectclass: domain</span><br><span class="line"></span><br><span class="line">dn: cn=admin,dc=example,dc=net</span><br><span class="line">cn: admin</span><br><span class="line">objectclass: simpleSecurityObject</span><br><span class="line">objectclass: organizationalRole</span><br><span class="line">userpassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br><span class="line"></span><br><span class="line">dn: ou=example-bod,dc=example,dc=net</span><br><span class="line">objectclass: organizationalUnit</span><br><span class="line">ou: example-bod</span><br><span class="line"></span><br><span class="line">dn: cn=example-bod-admin,ou=example-bod,dc=example,dc=net</span><br><span class="line">cn: example-bod-admin</span><br><span class="line">member: cn=y.z,ou=example-bod,dc=example,dc=net</span><br><span class="line">objectclass: groupOfNames</span><br><span class="line"></span><br><span class="line">dn: cn=y.z,ou=example-bod,dc=example,dc=net</span><br><span class="line">cn: y.z</span><br><span class="line">departmentnumber: 1</span><br><span class="line">displayname:: 6YOR5769</span><br><span class="line">mail: y.z@example.net</span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">sn: Zheng</span><br><span class="line">title:: 6JGj5LqL6ZW/</span><br><span class="line">uid: 10000</span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs</span><br><span class="line"></span><br><span class="line">dn: ou=example-bus,dc=example,dc=net</span><br><span class="line">objectclass: organizationalUnit</span><br><span class="line">ou: example-bus</span><br><span class="line"></span><br><span class="line">dn: cn=example-bus-admin,ou=example-bus,dc=example,dc=net</span><br><span class="line">cn: example-bus-admin</span><br><span class="line">member: cn=m.z,ou=example-bus,dc=example,dc=net</span><br><span class="line">objectclass: groupOfNames</span><br><span class="line"></span><br><span class="line">dn: cn=m.z,ou=example-bus,dc=example,dc=net</span><br><span class="line">cn: m.z</span><br><span class="line">departmentnumber: 1</span><br><span class="line">displayname:: 5a2Z6ZOt5rOT</span><br><span class="line">mail: m.z@example.net</span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">sn: Sun</span><br><span class="line">title:: 6LSi5Yqh</span><br><span class="line">uid: 10003</span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs</span><br><span class="line"></span><br><span class="line">dn: ou=example-dev,dc=example,dc=net</span><br><span class="line">objectclass: organizationalUnit</span><br><span class="line">ou: example-dev</span><br><span class="line"></span><br><span class="line">dn: cn=c.z,ou=example-dev,dc=example,dc=net</span><br><span class="line">cn: c.z</span><br><span class="line">departmentnumber: 1</span><br><span class="line">displayname:: 6ZmI5oiQ</span><br><span class="line">mail: c.z@example.net</span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">sn: Chen</span><br><span class="line">title:: UHl0aG9u5byA5Y+R5bel56iL5biI</span><br><span class="line">uid: 10002</span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs</span><br><span class="line"></span><br><span class="line">dn: cn=example-dev-admin,ou=example-dev,dc=example,dc=net</span><br><span class="line">cn: example-dev-admin</span><br><span class="line">member: cn=c.z,ou=example-dev,dc=example,dc=net</span><br><span class="line">objectclass: groupOfNames</span><br><span class="line"></span><br><span class="line">dn: cn=example-dev-senior,ou=example-dev,dc=example,dc=net</span><br><span class="line">cn: example-dev-senior</span><br><span class="line">member: cn=f.z,ou=example-dev,dc=example,dc=net</span><br><span class="line">member: cn=j.z,ou=example-dev,dc=example,dc=net</span><br><span class="line">objectclass: groupOfNames</span><br><span class="line"></span><br><span class="line">dn: cn=f.z,ou=example-dev,dc=example,dc=net</span><br><span class="line">cn: f.z</span><br><span class="line">departmentnumber: 1</span><br><span class="line">displayname:: 5p2O5pmT5Yek</span><br><span class="line">mail: f.z@example.net</span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">sn: Li</span><br><span class="line">title:: UHl0aG9u5byA5Y+R5bel56iL5biI</span><br><span class="line">uid: 10006</span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs</span><br><span class="line"></span><br><span class="line">dn: cn=j.z,ou=example-dev,dc=example,dc=net</span><br><span class="line">cn: j.z</span><br><span class="line">departmentnumber: 1</span><br><span class="line">displayname:: 572X57uq5Yab</span><br><span class="line">mail: j.z@example.net</span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">sn: Luo</span><br><span class="line">title:: UHl0aG9u5byA5Y+R5bel56iL5biI</span><br><span class="line">uid: 10007</span><br><span class="line">userpassword: &#123;SSHA&#125;/2+Coei5Fje+th7mOJgu43Ms3hBia2Qu</span><br><span class="line"></span><br><span class="line">dn: ou=example-ops,dc=example,dc=net</span><br><span class="line">objectclass: organizationalUnit</span><br><span class="line">ou: ops</span><br><span class="line">ou: example-ops</span><br><span class="line"></span><br><span class="line">dn: cn=b.z,ou=example-ops,dc=example,dc=net</span><br><span class="line">cn: b.z</span><br><span class="line">departmentnumber: 1</span><br><span class="line">displayname:: 5ZSQ5paM5pyd</span><br><span class="line">mail: b.z@example.net</span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">sn: Tang</span><br><span class="line">title:: 6L+Q57u05bel56iL5biI</span><br><span class="line">uid: 10004</span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs</span><br><span class="line"></span><br><span class="line">dn: cn=example-ops-admin,ou=example-ops,dc=example,dc=net</span><br><span class="line">cn: example-ops-admin</span><br><span class="line">member: cn=b.z,ou=example-ops,dc=example,dc=net</span><br><span class="line">objectclass: groupOfNames</span><br><span class="line"></span><br><span class="line">dn: ou=example-rob,dc=example,dc=net</span><br><span class="line">objectclass: organizationalUnit</span><br><span class="line">ou: example-rob</span><br><span class="line"></span><br><span class="line">dn: ou=example-sys,dc=example,dc=net</span><br><span class="line">objectclass: organizationalUnit</span><br><span class="line">ou: example-sys</span><br><span class="line"></span><br><span class="line">dn: cn=x.z,ou=example-sys,dc=example,dc=net</span><br><span class="line">cn: x.z</span><br><span class="line">departmentnumber: 1</span><br><span class="line">displayname:: 6b6Z6LaF</span><br><span class="line">mail: x.z@example.net</span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">sn: Long</span><br><span class="line">title:: 6L+Q57u05bel56iL5biI</span><br><span class="line">uid: 10005</span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs</span><br><span class="line"></span><br><span class="line">dn: cn=example-sys-admin,ou=example-sys,dc=example,dc=net</span><br><span class="line">cn: example-sys-admin</span><br><span class="line">member: cn=z.z,ou=example-sys,dc=example,dc=net</span><br><span class="line">objectclass: groupOfNames</span><br><span class="line"></span><br><span class="line">dn: cn=example-sys-junior,ou=example-sys,dc=example,dc=net</span><br><span class="line">cn: example-sys-junior</span><br><span class="line">member: cn=x.z,ou=example-sys,dc=example,dc=net</span><br><span class="line">objectclass: groupOfNames</span><br><span class="line"></span><br><span class="line">dn: cn=z.z,ou=example-sys,dc=example,dc=net</span><br><span class="line">cn: z.z</span><br><span class="line">departmentnumber: 1</span><br><span class="line">displayname:: 6LCi5bu6</span><br><span class="line">mail: z.z@example.net</span><br><span class="line">objectclass: inetOrgPerson</span><br><span class="line">sn: Xie</span><br><span class="line">title:: 57O757uf6L+Q57u05bel56iL5biI</span><br><span class="line">uid: 10001</span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs</span><br><span class="line"></span><br><span class="line">dn: cn=reader,dc=example,dc=net</span><br><span class="line">cn: reader</span><br><span class="line">objectclass: simpleSecurityObject</span><br><span class="line">objectclass: organizationalRole</span><br><span class="line">userpassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 reader acl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=example,dc=top&quot; by dn.base=&quot;cn=reader,dc=example,dc=net&quot; read</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;4&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=test,dc=com&quot; by dn.base=&quot;cn=reader,dc=example,dc=net&quot; read</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 admin acl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;3&#125;to dn.subtree=&quot;cn=xxx,ou=xxx,dc=example,dc=top&quot; by dn.base=&quot;cn=admin,dc=example,dc=net&quot;  write</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;4&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;3&#125;to dn.subtree=&quot;cn=xxx,ou=xxx,dc=test,dc=com&quot; by dn.base=&quot;cn=admin,dc=example,dc=net&quot;  write</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据库内 ACL 顺序</p>
</li>
<li><p>此例是使用 dn 直接限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write by anonymous auth  by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write  by * none   # 此后ldapmodify 命令使用这个用户授权连接修改</span><br><span class="line">olcAccess: &#123;1&#125;to attrs=shadowLastChange by self write by * read</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;cn=example-sys-admin,ou=example-sys,dc=example,dc=tech&quot; by dn.base=&quot;cn=reader,dc=example,dc=net&quot; read by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write    # 如果没有此条将不能在 lam 中被 admin 管理</span><br><span class="line"> olcAccess: &#123;3&#125;to dn.subtree=&quot;dc=example,dc=tech&quot; by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write      # 此条优先级最低</span><br></pre></td></tr></table></figure></li>
<li><p>初次测试连接 conflunce 的acl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write by anonymous auth by * none</span><br><span class="line">olcAccess: &#123;1&#125;to attrs=shadowLastChange by self write by * read</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=example,dc=net&quot; by dn.base=&quot;cn=reader,dc=test,dc=com&quot; read</span><br></pre></td></tr></table></figure></li>
<li><p>连接 acl 之后的过滤案例<br>‘(&amp;(objectclass&#x3D;inetorgperson)(|(cn&#x3D;x.z)(cn&#x3D;z.z))’  过滤出指定用户—-在用户模式设置。<br>‘(&amp;(objectclass&#x3D;groupOfNames)(|(cn&#x3D;example-sys-junior)(cn&#x3D;example-sys-admin)))’ 过滤指定组—-在组模式设置（在ldap中创建的组 objectclass 是groupOfNames，利用的是memberof属性）</p>
</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/ops_blog/about" rel="external nofollow noreferrer">LC</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://check-lc.github.io/ops_blog/ops_blog/2023/10/24/multiple-domians-in-openldap-use-case/">https://check-lc.github.io/ops_blog/ops_blog/2023/10/24/multiple-domians-in-openldap-use-case/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/ops_blog/about" target="_blank">LC</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/ops_blog/tags/OpenLDAP/">
                                    <span class="chip bg-color">OpenLDAP</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/ops_blog/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/ops_blog/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/ops_blog/2023/11/27/homelab-pc/">
                    <div class="card-image">
                        
                        
                        <img src="/ops_blog/medias/featureimages/21.jpg" class="responsive-img" alt="homelab pc">
                        
                        <span class="card-title">homelab pc</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Got a new way to write blog in english. Write the version 1 of this easy in chinese, then translating the texts into English. this one is about the  prepare of testing environments on my homelab PC. By the way, hope one day I'll know more professional words.
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-11-27
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/ops_blog/categories/Hardware/" class="post-category">
                                    Hardware
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/ops_blog/tags/DIY/">
                        <span class="chip bg-color">DIY</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/ops_blog/2023/10/18/zhe-shi-yi-feng-xin/">
                    <div class="card-image">
                        
                        
                        <img src="/ops_blog/medias/featureimages/10.jpg" class="responsive-img" alt="这是一封信">
                        
                        <span class="card-title">这是一封信</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            嗨，终于等到你啦！
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-10-18
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/ops_blog/categories/Personal/" class="post-category">
                                    Personal
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/ops_blog/tags/mylove/">
                        <span class="chip bg-color">mylove</span>
                    </a>
                    
                    <a href="/ops_blog/tags/Personal/">
                        <span class="chip bg-color">Personal</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: BLOG<br />'
            + '文章作者: LC<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/ops_blog/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/ops_blog/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/ops_blog/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/ops_blog/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/ops_blog/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/ops_blog/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='false'
        >
        </meting-js>
    </div>
</div>

<script src="/ops_blog/libs/aplayer/APlayer.min.js"></script>
<script src="/ops_blog/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2023</span>
            
            <a href="/ops_blog/about" target="_blank">LC</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2023";
                        var startMonth = "10";
                        var startDate = "7";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis"><!--















--></div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/ops_blog/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/ops_blog/libs/materialize/materialize.min.js"></script>
    <script src="/ops_blog/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/ops_blog/libs/aos/aos.js"></script>
    <script src="/ops_blog/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/ops_blog/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/ops_blog/js/matery.js"></script>

    

    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/ops_blog/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/ops_blog/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/ops_blog/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/ops_blog/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
