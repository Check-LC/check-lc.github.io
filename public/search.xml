<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>instant box</title>
      <link href="/ops_blog/2024/01/02/instant-box/"/>
      <url>/ops_blog/2024/01/02/instant-box/</url>
      
        <content type="html"><![CDATA[<h1 id="Instant-Box"><a href="#Instant-Box" class="headerlink" title="Instant Box"></a>Instant Box</h1><h2 id="1-Introduce"><a href="#1-Introduce" class="headerlink" title="1. Introduce"></a>1. Introduce</h2><p>A project spins up temporary Linux systems with instant webshell access from any browser.<br>It can currently supports various versions of Ubuntu, CentOS, Arch Linux, Debian, Fedora and Alpine.</p><h2 id="2-Deployment"><a href="#2-Deployment" class="headerlink" title="2. Deployment"></a>2. Deployment</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># docker-compose needed</span><br><span class="line">mkdir instantbox &amp;&amp; cd $_</span><br><span class="line">bash &lt;(curl -sSL https://raw.githubusercontent.com/instantbox/instantbox/master/init.sh)    # To create a  docker compose file，at the same time we can set ip &amp; port here</span><br><span class="line">docker-compose up -d  # deploy service</span><br></pre></td></tr></table></figure><h2 id="3-Operation"><a href="#3-Operation" class="headerlink" title="3.  Operation"></a>3.  Operation</h2><pre>Run 'docker-compose up -d' then go to http://ip:8888 on your browser.When creating a new OS, the Docker engine will create a new container in host machine.No persistent storage found.</pre><h3 id="3-1-ssh-into-container"><a href="#3-1-ssh-into-container" class="headerlink" title="3.1 ssh into container"></a>3.1 ssh into container</h3><ul><li>ubuntu</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt install -y openssh-server</span><br><span class="line">ssh-keygen -A    # 自动生成所有缺失的主机密钥文件</span><br><span class="line">vim ~/.ssh/authorized_keys   # 在目标机器需要登录的用户下，粘贴本机公钥（密码验证不成功）</span><br><span class="line">/usr/sbin/sshd     # 启动sshd</span><br><span class="line">宿主机 ssh 即可</span><br></pre></td></tr></table></figure><h3 id="3-2-Launch-WEB-Cli"><a href="#3-2-Launch-WEB-Cli" class="headerlink" title="3.2 Launch WEB Cli"></a>3.2 Launch WEB Cli</h3><pre>The browser can only create one kind of system at the sametimeClean the cache of browser or create a new incognito window, goes to console, create a new system in box.then goes to eg URL: http://10.13.3.101:8888/console/container_ID(name)/</pre><h2 id="4-Shut-the-service-down"><a href="#4-Shut-the-service-down" class="headerlink" title="4. Shut the service down"></a>4. Shut the service down</h2><pre>We're supposed to delete or purge the OS created before first, then purge the service container.</pre>]]></content>
      
      
      
        <tags>
            
            <tag> demo test </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>At the end of 2023</title>
      <link href="/ops_blog/2024/01/01/at-the-end-of-2023/"/>
      <url>/ops_blog/2024/01/01/at-the-end-of-2023/</url>
      
        <content type="html"><![CDATA[<h1 id="2023-的结束"><a href="#2023-的结束" class="headerlink" title="2023 的结束"></a>2023 的结束</h1><ol><li>失：2023-10-2 和邹漂亮分开了，2018-1-13 我们在一起。很想念，很亏欠，很遗憾，自己不够优秀，落下太远了。她确实值得更优秀的人生。</li><li>得：一份工作和一个决定。 </li><li>之后的话就等到薪酬到手有1w再考虑下一段感情吧，换房之后再考虑结婚吧，存款在10w以上再考虑生小孩吧。</li></ol><hr><p>|1月|结束k8s基础部分|<br>|2月|monitor|<br>|3月|cicd|<br>|4月|简历投递并约面试|<br>|5月|主要找工作|<br>|6月|找到工作！！！|<br>|1-6|如果辞职就一定要先拿到驾照|</p>]]></content>
      
      
      <categories>
          
          <category> summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> personal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS server</title>
      <link href="/ops_blog/2023/12/25/dns-server/"/>
      <url>/ops_blog/2023/12/25/dns-server/</url>
      
        <content type="html"><![CDATA[<h1 id="一、DNS-主服务器"><a href="#一、DNS-主服务器" class="headerlink" title="一、DNS 主服务器"></a>一、DNS 主服务器</h1><ul><li>手动更新源，并安装bind9.18  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:isc/bind</span><br><span class="line">apt update</span><br><span class="line">sudo apt install -y  bind9 bind9-utils</span><br></pre></td></tr></table></figure></li></ul><h2 id="1-1-相关文件"><a href="#1-1-相关文件" class="headerlink" title="1.1 相关文件"></a>1.1 相关文件</h2><p><a href="https://cshihong.github.io/2018/10/15/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E4%B8%8E%E9%85%8D%E7%BD%AE/">references</a><br><code>/etc/bind/named.conf</code>:  主配置文件，包含 bind 服务器的全局设置和引用其他配置文件的指令<br><code>/etc/bind/named.conf.default-zones</code>:  定义了默认的区域（zone），如  localhost 、反向解析等<br><code>/etc/bind/named.conf.local</code>:  用于配置本地区域（zone）和其他定制区域的文件<br><code>/etc/bind/named.conf.options</code>:  包含bind服务器的全局选项设置，如监听地址、转发器等  </p><h2 id="1-2-配置"><a href="#1-2-配置" class="headerlink" title="1.2 配置"></a>1.2 配置</h2><h3 id="1-2-1-解析方式"><a href="#1-2-1-解析方式" class="headerlink" title="1.2.1  解析方式"></a>1.2.1  解析方式</h3><table><thead><tr><th align="center">方式</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center">正向</td><td align="center">域名–&gt;IP</td></tr><tr><td align="center">反向</td><td align="center">IP–&gt;域名</td></tr></tbody></table><h3 id="1-2-2-DNS记录类型"><a href="#1-2-2-DNS记录类型" class="headerlink" title="1.2.2  DNS记录类型"></a>1.2.2  DNS记录类型</h3><ul><li>A 记录：将域名指向一个 ipv4  </li><li>AAAA 记录：将主机名解析到一个指定的 IPv6  </li><li>CNAME 记录：别名解析，指将不同的域名都转到一个域名记录上，由这个域名记录统一解析管理，即当前解析的域名是另一个域名的跳转  </li><li>NS 记录：域名服务记录，用来指定该域名由哪个 DNS 服务器来解析，一般设置为多个，一个为主，其余为辅，且只能写域名的形式  </li><li>PTR 记录：反向解析，主要用于 IP 解析为 FQDN  </li><li>MX 记录： 邮件交换记录  </li><li>TXT 记录： 指某个主机名或域名的说明，通常用来做SPF记录（反垃圾邮件）</li></ul><h3 id="1-2-3-目录结构（需要修改部分）"><a href="#1-2-3-目录结构（需要修改部分）" class="headerlink" title="1.2.3  目录结构（需要修改部分）"></a>1.2.3  目录结构（需要修改部分）</h3><p>&#x2F;etc&#x2F;bind<br>├── example<br>│   ├── db.zones<br>│   └── reverse.zones<br>├── named.conf<br>└──named.conf.options   </p><h3 id="1-2-4-配置文件"><a href="#1-2-4-配置文件" class="headerlink" title="1.2.4  配置文件"></a>1.2.4  配置文件</h3><ul><li>&#x2F;etc&#x2F;bind&#x2F;named.conf  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include &quot;/etc/bind/named.conf.options&quot;;</span><br><span class="line">include &quot;/etc/bind/named.conf.local&quot;;</span><br><span class="line"># include &quot;/etc/bind/named.conf.default-zones&quot;;       # 在视图使用时注释掉的</span><br><span class="line">include &quot;/etc/bind/example/sec-trust-anchors.conf&quot;;     #  在 dnssec 功能中需要做的引入</span><br></pre></td></tr></table></figure></li><li>&#x2F;etc&#x2F;bind&#x2F;named.conf.options</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">tls doh &#123;</span><br><span class="line">   key-file <span class="string">&quot;/etc/bind/example/cert/key.pem&quot;</span>;</span><br><span class="line">   cert-file <span class="string">&quot;/etc/bind/example/cert/ca.pem&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">http dns-over-https &#123;</span><br><span class="line">    endpoints &#123;<span class="string">&quot;/dns-query&quot;</span>;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        directory <span class="string">&quot;/var/cache/bind&quot;</span>;</span><br><span class="line">        listen-on port 53 &#123; localhost; &#125;;</span><br><span class="line">        listen-on port 443 tls doh http dns-over-https  &#123; localhost; &#125;;     <span class="comment"># 配合上述 tls  http 开启 DOH</span></span><br><span class="line">        recursion <span class="literal">true</span>;                <span class="comment"># 否则会出现不能解析 wan 网域名</span></span><br><span class="line">        forwarders &#123;</span><br><span class="line">            8.8.8.8;</span><br><span class="line">            223.5.5.5;</span><br><span class="line">        &#125;;</span><br><span class="line">        forward  first;</span><br><span class="line">        version  <span class="string">&quot;hiden version&quot;</span>;</span><br><span class="line">        allow-transfer &#123; 10.13.3.107; &#125;;</span><br><span class="line">        allow-query &#123;</span><br><span class="line">          example;</span><br><span class="line">          company;</span><br><span class="line">        &#125;;</span><br><span class="line">        auth-nxdomain <span class="literal">true</span>;</span><br><span class="line">        dnssec-validation <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">    10.10.6.0/24;</span><br><span class="line">    10.13.3.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl <span class="string">&quot;company&quot;</span> &#123;</span><br><span class="line">    10.10.6.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  match-clients &#123; example; &#125;;</span><br><span class="line">  zone <span class="string">&quot;example.net&quot;</span> IN  &#123;</span><br><span class="line">       <span class="built_in">type</span> master;</span><br><span class="line">       file <span class="string">&quot;/etc/bind/example/example.db.zones&quot;</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  zone <span class="string">&quot;13.10.in-addr.arpa.&quot;</span> IN  &#123;</span><br><span class="line">       <span class="built_in">type</span> master;</span><br><span class="line">       file <span class="string">&quot;/etc/bind/example/example.reverse.zones&quot;</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view <span class="string">&quot;company&quot;</span> &#123;</span><br><span class="line">  match-clients &#123; company; &#125;;</span><br><span class="line">  zone <span class="string">&quot;company.com&quot;</span> IN  &#123;</span><br><span class="line">       <span class="built_in">type</span> master;</span><br><span class="line">       file <span class="string">&quot;/etc/bind/example/company.db.zones&quot;</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>视图使用主要参考本章<a href="##3.3-%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE%E7%AE%A1%E7%90%86%EF%BC%8C%E6%99%BA%E8%83%BDDNS">智能视图使用</a></p><ul><li>&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$TTL 10M</span><br><span class="line">@       IN      SOA     example.top. admin.example.top. (</span><br><span class="line">                                   1   ; serial</span><br><span class="line">                                1200   ; refresh </span><br><span class="line">                                900    ; retry </span><br><span class="line">                                900    ; expire</span><br><span class="line">                               1200 )  ; minimum </span><br><span class="line">@        IN      NS      nameserver</span><br><span class="line">nameserver   IN  A       10.13.3.107</span><br><span class="line">nameserver  IN  A       10.13.3.109    </span><br><span class="line">test         IN  A       10.13.3.109</span><br><span class="line">k8s          IN  A       10.13.3.110</span><br></pre></td></tr></table></figure><ul><li><p>反向区域解析文件 &#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.reverse.zones  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$TTL 10M</span><br><span class="line">@       IN      SOA     example.net.  admin.example.net. (</span><br><span class="line">                                  1   ; serial</span><br><span class="line">                                24h   ; refresh</span><br><span class="line">                                15m   ; retry</span><br><span class="line">                                1d    ; expire</span><br><span class="line">                                5m  ; minimum</span><br><span class="line">)</span><br><span class="line">       IN      NS      nameserver.      # 不能缺省这个&quot;.&quot;</span><br><span class="line"></span><br><span class="line">107.3  IN    PTR    ldap.example.net.</span><br></pre></td></tr></table></figure></li><li><p>测试  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dig   目标域名   @namserver    +short</span><br><span class="line">dig   目标ip   -x   +short</span><br><span class="line">nslookup</span><br></pre></td></tr></table></figure></li></ul><h3 id="1-2-5-参数介绍"><a href="#1-2-5-参数介绍" class="headerlink" title="1.2.5  参数介绍"></a>1.2.5  参数介绍</h3><p>allow-update { none; };  定义允许执行动态 DNS 更新的客户端<br>allow-transfer { xx ; } 允许 xx 地址从您的 DNS 服务器复制数据<br>forward first; 优先选择转发到的 DNS 服务器<br>forwarders {}; 转发器，转发到另外的 DNS<br>recursion yes; 启用递归查询<br>dnssec-validation no; 禁用 BIND9 服务器上的 DNSSEC 验证，此时返回的数据或许有准确度的问题<br>auth-nxdomain no; 符合 RFC1035  </p><ol><li>Refresh（刷新）：Refresh 指定了 DNS 服务器应从主服务器获取区域数据的频率。最佳的 Refresh 时间取决于你的特定需求，通常在几小时到一天之间。较短的 Refresh 时间可以更快地更新数据，但会增加主服务器的负载。  </li><li>Retry（重试）：Retry 指定了 DNS 服务器在未能联系到主服务器时应进行的重试间隔。最佳的 Retry 时间通常在几分钟到一小时之间，取决于网络的可靠性和延迟。较短的 Retry 时间可以更快地恢复到主服务器，但会增加 DNS 查询负载。  </li><li>Expire（过期）：Expire 指定了区域数据在主服务器不可用时的最大存储时间。最佳的 Expire 时间通常在几天到一周之间。较短的 Expire 时间可以更快地更新过期的数据，但会增加 DNS 查询的负载。  </li><li>Minimum TTL（最小生存时间）：Minimum TTL 指定了 DNS 解析器或缓存服务器应保留解析结果的最小时间。最佳的 Minimum TTL 时间取决于你的特定需求，通常在几分钟到一天之间。较短的 Minimum TTL 时间可以更快地更新解析结果，但会增加 DNS 查询的负载。</li></ol><hr><h1 id="二、DNS-从服务器"><a href="#二、DNS-从服务器" class="headerlink" title="二、DNS 从服务器"></a>二、DNS 从服务器</h1><h2 id="2-1-配置"><a href="#2-1-配置" class="headerlink" title="2.1  配置"></a>2.1  配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/bind/named.conf</span><br><span class="line">同于 master 即可</span><br></pre></td></tr></table></figure><ul><li><p>&#x2F;etc&#x2F;bind&#x2F;named.conf.options</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">tls doh &#123;</span><br><span class="line">   key-file &quot;/etc/bind/example/cert/key.pem&quot;;</span><br><span class="line">   cert-file &quot;/etc/bind/example/cert/ca.pem&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">http dns-over-https &#123;</span><br><span class="line">    endpoints &#123;&quot;/dns-query&quot;;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        directory &quot;/var/cache/bind&quot;;</span><br><span class="line">        listen-on port 53 &#123; localhost; &#125;;</span><br><span class="line">        listen-on port 443 tls doh http default &#123; localhost; &#125;;</span><br><span class="line">        recursion true;</span><br><span class="line">        forwarders &#123;</span><br><span class="line">            8.8.8.8;</span><br><span class="line">            223.5.5.5;</span><br><span class="line">        &#125;;</span><br><span class="line">        forward  first;</span><br><span class="line">        version  &quot;hiden version&quot;;</span><br><span class="line">        allow-query &#123;</span><br><span class="line">          example;</span><br><span class="line">          company;</span><br><span class="line">        &#125;;</span><br><span class="line">        auth-nxdomain true;</span><br><span class="line">        dnssec-validation false;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl &quot;example&quot; &#123;</span><br><span class="line">    10.10.6.0/24;</span><br><span class="line">    10.13.3.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl &quot;company&quot; &#123;</span><br><span class="line">    10.10.6.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view &quot;example&quot; &#123;</span><br><span class="line">  match-clients &#123; example; &#125;;</span><br><span class="line">  zone &quot;example.net&quot; IN  &#123;</span><br><span class="line">       type slave;</span><br><span class="line">       file &quot;/etc/bind/example/example.db.zones.signed&quot;;</span><br><span class="line">       masters &#123; 10.13.3.106; &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  zone &quot;3.13.10.in-addr.arpa.&quot; IN  &#123;</span><br><span class="line">       type slave;</span><br><span class="line">       masters &#123; 10.13.3.106; &#125;;</span><br><span class="line">       file &quot;/etc/bind/example/example.reverse.zones&quot;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view &quot;company&quot; &#123;</span><br><span class="line">  match-clients &#123; company; &#125;;</span><br><span class="line">  zone &quot;company.com&quot; IN  &#123;</span><br><span class="line">       type slave;</span><br><span class="line">       masters &#123; 10.13.3.106; &#125;;</span><br><span class="line">       file &quot;/etc/bind/example/company.db.zones&quot;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>&#x2F;etc&#x2F; apparmor.d&#x2F;usr.sbin.named  设置可写。dumping master file: &#x2F;etc&#x2F;bind&#x2F;example&#x2F;tmp-80LUGLiqE4: open: permission denied  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/bind/example/** rw,</span><br><span class="line"></span><br><span class="line">systemctl reload apparmor.service</span><br></pre></td></tr></table></figure></li></ul><h2 id="2-2-测试记录同步"><a href="#2-2-测试记录同步" class="headerlink" title="2.2 测试记录同步"></a>2.2 测试记录同步</h2><ul><li>修改主服务器，解析记录，测试从服务器的同步情况  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 10M</span><br><span class="line">@       IN      SOA     example.top.  admin.example.top. (</span><br><span class="line">                                   2   ; serial   [[每次需要修改版本号]]</span><br><span class="line">                                1200   ; refresh </span><br><span class="line">                                900    ; retry </span><br><span class="line">                                900    ; expire</span><br><span class="line">                               1200 )  ; minimum </span><br><span class="line">@        IN      NS      nameserver</span><br><span class="line">@        IN      NS      nameserver2              [[较版本1新增]]</span><br><span class="line">nameserver   IN  A       10.13.3.107</span><br><span class="line">nameserver2  IN  A       10.13.3.109              [[较版本1新增]]</span><br><span class="line">test         IN  A       10.13.3.109</span><br><span class="line">k8s          IN  A       10.13.3.110</span><br><span class="line">me           IN  A       10.10.6.1               [[较版本1新增]]</span><br></pre></td></tr></table></figure></li></ul><p><strong>热加载</strong>新增的配置，每次修改记录时，需要同步修改<em><strong>版本号</strong></em>，slave 才能同步成功  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo rndc reload     # 主服务器执行即可</span><br><span class="line">dig -t a me.example.top @10.13.3.109</span><br></pre></td></tr></table></figure><ul><li>当从服务器有解析文件的，解析记录仍会向主服务器请求，主服务器宕机，从服务器缓存过期之后，也仍不能加载并实施解析区域记录文件  </li><li>同一个网段在多个acl下，将不能正常解析。</li></ul><h2 id="2-3-测试公网域名"><a href="#2-3-测试公网域名" class="headerlink" title="2.3 测试公网域名"></a>2.3 测试公网域名</h2><ul><li>此時公网域名成功解析得到的是保留ip地址，ping 域名不能成功—-因为公司的 ip 做了加密  </li><li>不能成功解析则无记录返回</li></ul><hr><h1 id="三、-安全"><a href="#三、-安全" class="headerlink" title="三、 安全"></a>三、 安全</h1><h2 id="3-1-功能同于bind-chroot"><a href="#3-1-功能同于bind-chroot" class="headerlink" title="3.1 功能同于bind-chroot"></a>3.1 功能同于bind-chroot</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/apparmor.d/usr.sbin.named</span><br><span class="line"># 检查是否存在，否则增加以下内容</span><br><span class="line">  /etc/bind/** r,</span><br><span class="line">  /var/lib/bind/** rw,</span><br><span class="line">  /var/lib/bind/ rw,</span><br><span class="line">  /var/cache/bind/** lrw,</span><br><span class="line">  /var/cache/bind/ rw,</span><br><span class="line">  /var/log/named/** rw,</span><br><span class="line">  /var/log/named/ rw,</span><br></pre></td></tr></table></figure><h2 id="3-2-开启DNSSEC验证，参考"><a href="#3-2-开启DNSSEC验证，参考" class="headerlink" title="3.2 开启DNSSEC验证，参考"></a>3.2 开启DNSSEC验证，<a href="https://www.cnblogs.com/anpengapple/p/5879363.html">参考</a></h2><ul><li><p>作用：对域名进行签名认证，保证域名的完整性和正确性，不会被修改  </p></li><li><p>在新增的 dnssec_keys 目录中生成密钥  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo dnssec-keygen -f KSK -a RSASHA256 -b 2048 -n ZONE example.net.</span><br><span class="line">sudo dnssec-keygen -a RSASHA256  -b 2048 -n ZONE example.net.</span><br><span class="line"></span><br><span class="line"># 查看本域应用所需的密钥文件  </span><br><span class="line">ls </span><br><span class="line">Kexample.net.+008+16296.key   Kexample.net.+008+16296.private   Kexample.net.+008+23579.key  Kexample.net.+008+23579.private</span><br></pre></td></tr></table></figure></li><li><p>将前面生成的两个公钥添加到区域配置文件末尾  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$TTL 10M</span><br><span class="line">@       IN      SOA     example.net.  admin.example.net. (</span><br><span class="line">                                  1   ; serial</span><br><span class="line">                                24h   ; refresh</span><br><span class="line">                                15m   ; retry</span><br><span class="line">                                1d    ; expire</span><br><span class="line">                                5m )  ; minimum</span><br><span class="line"></span><br><span class="line">@        IN      NS      nameserver</span><br><span class="line"></span><br><span class="line">nameserver       IN      A       10.13.3.106</span><br><span class="line">ldap   IN  A   10.13.3.107</span><br><span class="line">test   IN  A   10.13.3.105</span><br><span class="line"></span><br><span class="line">$INCLUDE  &quot;/etc/bind/example/dnssec_keys/Kexample.net.+008+23579.key&quot;</span><br><span class="line">$INCLUDE  &quot;/etc/bind/example/dnssec_keys/Kexample.net.+008+16296.key&quot;</span><br></pre></td></tr></table></figure></li><li><p>对区域文件签名，会生成一个新的zones.sigend. 如果新增了解析记录，需要再次加密  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnssec-signzone -K /etc/bind/example/dnssec_keys/ -o example.net. /etc/bind/example/example.db.zones</span><br><span class="line"> -K  指定密钥文件路径    -o  域名   路径是区域解析文件路径</span><br></pre></td></tr></table></figure></li><li><p>改动引用解析文件路径的位置  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">view &quot;example&quot; &#123;</span><br><span class="line">  match-clients &#123; example; &#125;;</span><br><span class="line">  zone &quot;example.net&quot; IN  &#123;</span><br><span class="line">       type master;</span><br><span class="line">       file &quot;/etc/bind/example/example.db.zones.signed&quot;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>生成信任锚文件 &#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf  </p></li><li><p>这里面的两条内容是刚才生成的两个密钥的内容。用公钥比较方便（也就是.key的文件）。注意复制的时候去掉“IN”和“DNSKEY”这两个词，以及后面的key要加引号  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">trusted-keys &#123;</span><br><span class="line">   example.net.   256 3 8  <span class="string">&quot;AwEAAb+3BGqXqE/WwDICGRONYv1w4savuaD4cJ/VRL6xGg2b54OilEWE WMzUAOw4B/sPyKZDG/XTnaW4mD756l/swRuq9kO/sktgu4ZP4onmqeFM sdMTTmxesp6Q6ebqAPNzQfKyZwqX6Iq00qGslUmxr5FSOLWjGoze8afm TxbPW6Hi7JQ85mJ+TkpUNa+ymDS4qKi87rSi8NQTDbsZ0wH7+zX1TBOP jeUI/JsxD/bu1kD97AP9u2Sd4D8U0vyN8fN4LIIKfA5vurPaWPfQIM8r I0KQueAHdNLOPjaEWcKg/rBHFWZPxIeQGM8D2VXwkdPL5fefC59wONhK ys2RMqv3DIM=&quot;</span>;</span><br><span class="line">  example.net.   257 3 8 <span class="string">&quot;AwEAAbZo3hpm+0+32jgrTXog3CCUTTctP3LoBx1F0nbpoEBkWN1CA//O 7fzNY08pwblkKKW/LkYiQNQEQq50ThouV9UJ+CFRf/Fju6ggIpWpNjsu 8c2+zROZdJ9d2T6JnVTYPo1Iyn8ufn0hFjPRrwdvfQKSmnI9ZRx2eRFc ZFJpqNTj2LwzqoEKrbOn4oywqTWJL1Hyjv8e/kBojy7BghKWYnTGlpha 9CSin17qUQCY+o0qMzmezq+/AbxhdJwV9KYHWzWvNZjyyjBLyxwwsV4F shgmXm2tTuW5gPrnbfzaP+R/cElzl03mtjmJ//g5wWMMV8QKemBpbNoR ajzYYhhocWk=&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>引入此信任锚文件 &#x2F;etc&#x2F;bind&#x2F;name.conf  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include &quot;/etc/bind/example/sec-trust-anchors.conf&quot;;</span><br></pre></td></tr></table></figure></li><li><p>重启服务  </p></li><li><p>验证  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dig +dnssec  test.example.net  @10.13.3.106</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; +dnssec test.example.net @10.13.3.106</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 28767</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags: do; udp: 1232</span><br><span class="line">; COOKIE: 0d6b52d25063b09401000000655592b51d0f8f6c0b072961 (good)</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;test.example.net.                        IN      A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">test.example.net.         600     IN      A       10.13.3.105</span><br><span class="line">test.example.net.         600     IN      RRSIG   A 8 3 600 20231216022642 20231116022642 16296 example.net. iUSB+maT6y22ySZdEZHElShHCVDbmjnHez39eosniP1wqvquyadVydlT lZ3XZbUMNTV3WrZhLEjuGaVwNajvAqeY07IPCivpr+VCuIPXccONBwZE 3ZRX5B2PcGnrhMWupH+jcoT5NTy5pAEdm5JXbtJljFyJk1XxQVhanzJO /TY7YMJWWDbj3WnywkEPQyP5UYExl4Y0E3BPUX/J4xuCspTovQhqo6BM HaC3XFMG1Li9CbHcfNkUjVtdi8oQmAdM6lMqFTz5KNpIRppqhEukcD9o w9slLc1vpjDwqzO7xPls8S9WbzMeHzHNbIrPcv88MQWUAIVyqodbhOvj 8ZKlgg==</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 10.13.3.106#53(10.13.3.106)</span><br><span class="line">;; WHEN: Thu Nov 16 11:55:33 CST 2023</span><br><span class="line">;; MSG SIZE  rcvd: 384</span><br></pre></td></tr></table></figure></li><li><p>问题：  </p></li><li><p>配置后，每个客户端需要添加信任锚文件以作签名验证  </p></li><li><p>这个签名后的zone可以被伪造，使用dig命令输出的文件修改伪造</p></li></ul><h2 id="3-3-创建视图管理，智能DNS"><a href="#3-3-创建视图管理，智能DNS" class="headerlink" title="3.3 创建视图管理，智能DNS"></a>3.3 创建视图管理，智能DNS</h2><p><a href="https://www.cnblogs.com/anpengapple/p/5879350.html">参考1</a><br><a href="https://www.cnblogs.com/etangyushan/p/4335521.html">参考2</a><br><a href="http://www.hangdaowangluo.com/archives/1633">参考3</a><br><a href="https://www.server-world.info/en/note?os=Ubuntu_20.04&p=dns&f=5">ubuntu案例</a>  </p><ul><li>vim  &#x2F;etc&#x2F;bind&#x2F;named.conf</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&quot;/etc/bind/named.conf.options&quot;</span>;</span><br><span class="line">include <span class="string">&quot;/etc/bind/named.conf.local&quot;</span>;</span><br><span class="line"><span class="comment"># include &quot;/etc/bind/named.conf.default-zones&quot;;</span></span><br></pre></td></tr></table></figure><ul><li>cat  &#x2F;etc&#x2F;bind&#x2F;named.conf.options</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        directory &quot;/var/cache/bind&quot;;</span><br><span class="line">        listen-on port 53 &#123; localhost; &#125;;</span><br><span class="line">        recursion yes;        # 允许递归才能在智能dns解析万网域名</span><br><span class="line">        forwarders &#123;</span><br><span class="line">          223.5.5.5;</span><br><span class="line">        &#125;;</span><br><span class="line">        forward  first;</span><br><span class="line">        version  &quot;hiden version&quot;;   # 隐藏版本</span><br><span class="line">        allow-transfer &#123; 10.13.3.106; &#125;;</span><br><span class="line">        allow-query &#123; </span><br><span class="line">          example;</span><br><span class="line">          company;</span><br><span class="line">        &#125;;</span><br><span class="line">        auth-nxdomain true;</span><br><span class="line">        dnssec-validation false; # dns安全拓展的选项</span><br><span class="line">&#125;;</span><br><span class="line"># 此处定义目标ip地址段，划分可访问的域</span><br><span class="line">acl &quot;example&quot; &#123;</span><br><span class="line">    10.13.3.0/24;</span><br><span class="line">    10.10.6.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">acl &quot;company&quot; &#123;</span><br><span class="line">    10.10.6.0/24;</span><br><span class="line">&#125;;</span><br><span class="line"># 此处制定目标ip可以访问的域名的解析区域</span><br><span class="line">view &quot;example&quot; &#123;</span><br><span class="line">  match-clients &#123; example; &#125;;</span><br><span class="line">  include &quot;/etc/bind/example/example.views&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">view &quot;company&quot; &#123;</span><br><span class="line">  match-clients &#123; company; &#125;;</span><br><span class="line">  include &quot;/etc/bind/example/company.views&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>views 文件中指定区域解析文件，eg：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zone <span class="string">&quot;example.net&quot;</span> IN &#123;                                          <span class="comment"># 此处域名和 zones 文件中的域名一致</span></span><br><span class="line">      <span class="built_in">type</span> master;</span><br><span class="line">      file <span class="string">&quot;/etc/bind/example/example.net.zones&quot;</span>;</span><br><span class="line">   &#125;;</span><br><span class="line">zone <span class="string">&quot;3.13.10.in-addr.arpa.&quot;</span> IN &#123;                         <span class="comment"># 此处格式固定，设计反向解析的ip的网络位，和zones文件中的主机位结合成为完整ip地址</span></span><br><span class="line">      <span class="built_in">type</span> master;</span><br><span class="line">      file <span class="string">&quot;/etc/bind/example/example.net.reverse.zones&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone <span class="string">&quot;example.top&quot;</span> IN &#123;                              <span class="comment"># 配置此 dns 向 10.13.3.101 这个转发器请求解析 example.top 的域名。在全局 options 配置转发没有成功，选择了此方案。</span></span><br><span class="line">      <span class="built_in">type</span> forward;</span><br><span class="line">      forwarders &#123;10.13.3.101;&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><p>正向区域解析文件  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 10M</span><br><span class="line">@       IN      SOA     example.net.  admin.example.net. (</span><br><span class="line">                                  1   ; serial</span><br><span class="line">                                24h   ; refresh</span><br><span class="line">                                15m   ; retry</span><br><span class="line">                                1d    ; expire</span><br><span class="line">                                5m  ; minimum</span><br><span class="line">) </span><br><span class="line">@        IN      NS      nameserver</span><br><span class="line"></span><br><span class="line">nameserver       IN      A       10.13.3.106</span><br><span class="line"></span><br><span class="line">ldap   IN  A   10.13.3.107</span><br><span class="line">test   IN  A   10.13.3.105</span><br></pre></td></tr></table></figure></li><li><p>反向区域解析文件  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$TTL 10M</span><br><span class="line">@       IN      SOA     example.net.  admin.example.net. (</span><br><span class="line">                                  1   ; serial</span><br><span class="line">                                24h   ; refresh</span><br><span class="line">                                15m   ; retry</span><br><span class="line">                                1d    ; expire</span><br><span class="line">                                5m  ; minimum</span><br><span class="line">)</span><br><span class="line">       IN      NS      nameserver.      # 不能缺省这个&quot;.&quot;</span><br><span class="line"></span><br><span class="line">107  IN    PTR    ldap.example.net.</span><br></pre></td></tr></table></figure></li><li><p>测试   </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dig   目标域名   @namserver    +short</span><br><span class="line">dig   目标ip   -x   +short</span><br><span class="line">nslookup</span><br></pre></td></tr></table></figure></li></ul><h2 id="3-4-加密"><a href="#3-4-加密" class="headerlink" title="3.4 加密"></a>3.4 加密</h2><p><a href="https://runtufenxiang.com/6186/">知名公共DoT&#x2F;DoH加密DNS服务器</a><br><a href="https://devblog.rayonnant.net/creating-a-dot-and-doh-server-using-nginx-and-bind/">配置</a><br><a href="https://dididudu998.github.io/2022/02/15/configure-doh-bind.html">bind9 tls &#x2F; https</a>网络层的问题是DoT使用853的端口，很容易被封锁，而DoH使用443端口，一般不会被封锁    </p><h3 id="3-4-1-DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）"><a href="#3-4-1-DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）" class="headerlink" title="3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）"></a>3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">tls mycert &#123;</span><br><span class="line">    cert-file &quot;/etc/bind/example/cert.pem&quot;;</span><br><span class="line">    key-file &quot;/etc/bind/example/key.pem&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">    directory &quot;/var/cache/bind&quot;;</span><br><span class="line">    listen-on port 853 tls mycert &#123; localhost; &#125;;</span><br><span class="line">    forward  first;</span><br><span class="line">    forwarders &#123;</span><br><span class="line">            223.5.5.5;</span><br><span class="line">            120.53.53.53;</span><br><span class="line">    &#125;;</span><br><span class="line">    allow-query &#123; 10.13.3.0/24;&#125;;</span><br><span class="line">    auth-nxdomain true;</span><br><span class="line">    allow-update &#123; none; &#125;;</span><br><span class="line">  //  allow-transfer &#123; 10.13.3.106; &#125;;</span><br><span class="line">    version  &quot;hiden version&quot;;</span><br><span class="line">    recursion false;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;example.net&quot;&#123;</span><br><span class="line">   type master;</span><br><span class="line">   file &quot;/etc/bind/example/example.net.zones&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>客户端修改dns地址步骤如下：  </li><li>&#x2F;etc&#x2F;resolv.conf  是软链接，指向了&#x2F;run&#x2F;systemd&#x2F;resolve&#x2F;stub-resolv.conf。直接修改内容会被覆盖，没有意义  </li><li>vim &#x2F;etc&#x2F;systemd&#x2F;resolved.conf  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Resolve]</span><br><span class="line">DNS=10.13.3.106</span><br><span class="line">[[FallbackDNS]]=</span><br><span class="line">DNSOverTLS=opportunistic  # 或者yes</span><br></pre></td></tr></table></figure></li><li>systemctl restart systemd-resolved.service   </li><li>mv &#x2F;etc&#x2F;resolv.conf   &#x2F;etc&#x2F;resolv.conf.bak  </li><li>ln -s &#x2F;run&#x2F;systemd&#x2F;resolve&#x2F;resolv.conf &#x2F;etc&#x2F;</li></ul><h3 id="3-4-2-问题"><a href="#3-4-2-问题" class="headerlink" title="3.4.2 问题"></a>3.4.2 问题</h3><ul><li><p>以上配置之后，使用特定命令发现 DOT 是成功的，例如  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">resolvectl query mee.example.net</span><br><span class="line">mee.example.net: 10.10.6.1                       -- link: ens160</span><br><span class="line"></span><br><span class="line">-- Information acquired via protocol DNS in 1.7ms.</span><br><span class="line">-- Data is authenticated: no</span><br><span class="line"></span><br><span class="line">dig +tls mee.example.net</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu &lt;&lt;&gt;&gt; +tls mee.example.net</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 52275</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 1232</span><br><span class="line">; COOKIE: 174ae084d3aed77f01000000655474d3fbb4902501bc69cb (good)</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;mee.example.net.                 IN      A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">mee.example.net.          600     IN      A       10.10.6.1</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 10.13.3.106#853(10.13.3.106) (TLS)</span><br><span class="line">;; WHEN: Wed Nov 15 15:35:47 CST 2023</span><br><span class="line">;; MSG SIZE  rcvd: 86</span><br><span class="line">以上访问了dns服务器853端口，所以返回正常解析</span><br></pre></td></tr></table></figure></li><li><p>普通解析会失败  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dig mee.example.net  （nslookup ssh  ping）</span><br><span class="line">;; communications error to 10.13.3.106#53: connection refused</span><br><span class="line">;; communications error to 10.13.3.106#53: connection refused</span><br><span class="line">;; communications error to 10.13.3.106#53: connection refused</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu &lt;&lt;&gt;&gt; mee.example.net</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; no servers could be reached</span><br></pre></td></tr></table></figure></li><li><p>因此，仍然开启 53 端口，二者同时可以使用，但是如果需要特定的方式使用DNSOverTLS ，那么以目前在服务器上的使用上来看，使用是没有意义的。  </p></li><li><p>在服务器使用 53，在浏览器使用自建 DOH，是适宜的</p></li></ul><h3 id="3-4-3-DOH-加密和转发"><a href="#3-4-3-DOH-加密和转发" class="headerlink" title="3.4.3  DOH 加密和转发"></a>3.4.3  DOH 加密和转发</h3><ul><li><p>配置  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tls doh &#123;</span><br><span class="line">   key-file &quot;/etc/bind/example/cert/key.pem&quot;;</span><br><span class="line">   cert-file &quot;/etc/bind/example/cert/ca.pem&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">http dns-over-https &#123;</span><br><span class="line">    endpoints &#123;&quot;/dns-query&quot;;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        listen-on port 443 tls doh http default &#123; localhost; &#125;;</span><br><span class="line">......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>检测  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">dig +https  test.example.net  @10.13.3.106 A</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu &lt;&lt;&gt;&gt; +https test.example.net @10.13.3.106 A</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 15036</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 1232</span><br><span class="line">; COOKIE: dcdab07360fe04b2010000006555c9c6572491f7e49a2f35 (good)</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;test.example.net.                        IN      A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">test.example.net.         600     IN      A       10.13.3.105</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 10.13.3.106#443(10.13.3.106) (HTTPS)</span><br><span class="line">;; WHEN: Thu Nov 16 15:50:30 CST 2023</span><br><span class="line">;; MSG SIZE  rcvd: 87</span><br></pre></td></tr></table></figure></li><li><p>使用<br>此时在客户端使用 DOH ，浏览器设置 use secure dns ，custom url ： <a href="https://nameserver.example.net/dns-query">https://nameserver.example.net/dns-query</a><br>在客户端其他程序的使用中，仍然会访问 dns 的 53 端口</p></li></ul><h2 id="3-5-其他安全实践"><a href="#3-5-其他安全实践" class="headerlink" title="3.5 其他安全实践"></a>3.5 其他安全实践</h2><ul><li>下列参考<a href="https://www.secpulse.com/archives/52634.html">来源</a>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">隐藏BIND版本号</span><br><span class="line">限定哪台主机能够发起区域传输</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">version  &quot;hiden version&quot;;                             #  隐藏版本信息</span><br><span class="line">allow-transfer &#123; 221.236.9.9; &#125;;    #  指定允许某从服务器进行区域传输到该服务器，此配置一般在主服务器配置</span><br></pre></td></tr></table></figure><h1 id="四、web-管理以及反向代理"><a href="#四、web-管理以及反向代理" class="headerlink" title="四、web 管理以及反向代理"></a>四、web 管理以及反向代理</h1><p><a href="https://www.mmcloud.com/2863.html">安装 webmin工具</a><br><a href="https://devpress.csdn.net/cloud/6304db5f7e6682346619cf4b.html">使用ngingx反代</a>  </p><ul><li>路径nginx&#x2F;conf.d&#x2F;webmin.conf   （检查443、80端口，确认dns地址和解析记录）  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">upstream webmin &#123;</span><br><span class="line">  server 10.13.3.107:10000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name webmin.example.net;</span><br><span class="line">  return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  server_name webmin.example.net;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  ssl_certificate webmin/tls_ca.pem;</span><br><span class="line">  ssl_certificate_key webmin/tls_key.pem;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass      https://webmin;</span><br><span class="line">    proxy_redirect  off;</span><br><span class="line">    proxy_set_header   Host             $host:$server_port;</span><br><span class="line">    proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto &quot;https&quot;;</span><br><span class="line">    proxy_connect_timeout      10;</span><br><span class="line">    proxy_send_timeout         10;</span><br><span class="line">    proxy_read_timeout         10;</span><br><span class="line">    proxy_buffer_size          128k;</span><br><span class="line">    proxy_buffers              32 32k;</span><br><span class="line">    proxy_busy_buffers_size    256k;</span><br><span class="line">    proxy_temp_file_write_size 256k;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="五、bind9-18-nginx-反向代理"><a href="#五、bind9-18-nginx-反向代理" class="headerlink" title="五、bind9.18  nginx 反向代理"></a>五、bind9.18  nginx 反向代理</h1><p><a href="https://www.infvie.com/ops-notes/nginx-udp-dns.html">反向代理参考</a>  </p>]]></content>
      
      
      <categories>
          
          <category> ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The First time using Helm Charts</title>
      <link href="/ops_blog/2023/12/04/the-first-time-using-helm-charts/"/>
      <url>/ops_blog/2023/12/04/the-first-time-using-helm-charts/</url>
      
        <content type="html"><![CDATA[<h2 id="一、ldap-account-manager"><a href="#一、ldap-account-manager" class="headerlink" title="一、ldap-account-manager"></a>一、ldap-account-manager</h2><h3 id="1-1-Repo-URL"><a href="#1-1-Repo-URL" class="headerlink" title="1.1 Repo URL"></a>1.1 Repo URL</h3><ul><li><a href="https://gabibbo97.github.io/charts/">https://gabibbo97.github.io/charts/</a></li><li>Set image tag:8.3 in the chart.yaml</li></ul><h3 id="1-2-Values-Modify—-values-yaml"><a href="#1-2-Values-Modify—-values-yaml" class="headerlink" title="1.2 Values Modify—-values.yaml"></a>1.2 Values Modify—-values.yaml</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">extraEnv:</span><br><span class="line">  LAM_SKIP_PRECONFIGURE: false</span><br><span class="line">  LDAP_DOMAIN: example.net;ibswufe.com</span><br><span class="line">  LDAP_BASE_DN: dc=example,dc=net;dc=ibswufe,dc=com</span><br><span class="line">  LDAP_SERVER: ldaps://ldap01.example.net</span><br><span class="line">  LDAP_USER: cn=administrator,dc=example,dc=net</span><br><span class="line">  LAM_LANG: zh_CN</span><br><span class="line">  LAM_PASSWORD: lam</span><br></pre></td></tr></table></figure><h2 id="二、-self-service-password"><a href="#二、-self-service-password" class="headerlink" title="二、 self-service-password"></a>二、 self-service-password</h2><h3 id="2-1-Repo-URL"><a href="#2-1-Repo-URL" class="headerlink" title="2.1 Repo URL"></a>2.1 Repo URL</h3><ul><li><a href="https://ygqygq2.github.io/charts/">https://ygqygq2.github.io/charts/</a></li><li>Set image tag:5.3.3 to pull the latest one</li></ul><h3 id="2-2-Charts-Using"><a href="#2-2-Charts-Using" class="headerlink" title="2.2 Charts Using"></a>2.2 Charts Using</h3><h4 id="2-2-1-ENV-Setting-ConfigMap"><a href="#2-2-1-ENV-Setting-ConfigMap" class="headerlink" title="2.2.1 ENV Setting ConfigMap"></a>2.2.1 ENV Setting ConfigMap</h4><ul><li>So confused about why cannot make it effective when I  using  the ConfigMap settings In the values.yaml to  cover the default php configurations of this soft.</li><li>So that , Using a ConfigMap Data to  define the container environment variables of this chart.</li><li>env-config.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">self-service-password-env</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">USE_QUESTIONS:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line"><span class="attr">LDAP_BINDDN:</span> <span class="string">&quot;cn=exampleadmin,dc=example,dc=net&quot;</span></span><br><span class="line"><span class="attr">SECRETEKEY:</span> <span class="string">&quot;example&quot;</span></span><br><span class="line"><span class="attr">DEFAULT_ACTION:</span> <span class="string">&quot;sendtoken&quot;</span></span><br><span class="line"><span class="attr">LANG:</span> <span class="string">&quot;cn,zh-CN&quot;</span></span><br><span class="line"><span class="attr">IS_BEHIND_PROXY:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line"><span class="attr">SITE_URL:</span> <span class="string">&quot;https://ssp.example.net/index.php&quot;</span></span><br><span class="line"><span class="attr">LDAP_SERVER:</span> <span class="string">&quot;ldap://10.13.3.107&quot;</span></span><br><span class="line"><span class="attr">LDAP_BASE_SEARCH:</span> <span class="string">&quot;ou=example,dc=example,dc=net&quot;</span></span><br><span class="line"><span class="attr">LDAP_LOGIN_ATTRIBUTE:</span> <span class="string">&quot;cn&quot;</span></span><br><span class="line"><span class="attr">LOGO:</span> <span class="string">images/mnt/ltb-logo.png</span>                                  <span class="comment"># 共享存储，挂载在容器中的/www/ssp/images/mnt</span></span><br><span class="line"><span class="attr">BACKGROUND_IMAGE:</span> <span class="string">images/mnt/background.jpg</span></span><br><span class="line"><span class="attr">MAIL_FROM_NAME:</span> <span class="string">&quot;密码自主修改服务&quot;</span></span><br><span class="line"><span class="attr">MAIL_SIGNATURE:</span> <span class="string">&quot;如有疑问,请联系运维同事,英博智云.&quot;</span></span><br><span class="line"><span class="attr">MAIL_USE_LDAP:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line"><span class="attr">NOTIFY_ON_CHANGE:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line"><span class="attr">SMTP_AUTH_ON:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line"><span class="attr">SMTP_HOST:</span> <span class="string">&quot;smtphz.qiye.163.com&quot;</span></span><br><span class="line"><span class="attr">MAIL_FROM:</span> <span class="string">&quot;chao.long@example.net&quot;</span></span><br><span class="line"><span class="attr">SMTP_USER:</span> <span class="string">&quot;chao.long@example.net&quot;</span></span><br><span class="line"><span class="attr">SMTP_SECURE_TYPE:</span> <span class="string">&#x27;ssl&#x27;</span></span><br><span class="line"><span class="attr">SMTP_PORT:</span> <span class="string">&#x27;465&#x27;</span></span><br><span class="line"><span class="attr">SMTP_AUTOTLS:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line"><span class="attr">PASSWORD_DIFFERENT_LOGIN:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line"><span class="attr">PASSWORD_MAX_LENGTH:</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line"><span class="attr">PASSWORD_MIN_LENGTH:</span> <span class="string">&#x27;8&#x27;</span></span><br><span class="line"><span class="attr">PASSWORD_MIN_LOWERCASE:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line"><span class="attr">PASSWORD_MIN_SPECIAL:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line"><span class="attr">PASSWORD_MIN_UPPERCASE:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line"><span class="attr">PASSWORD_COMPLEXITY:</span> <span class="string">&#x27;4&#x27;</span></span><br><span class="line"><span class="attr">PASSWORD_NO_REUSE:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">PASSWORD_SHOW_POLICY:</span> <span class="string">&quot;always&quot;</span></span><br><span class="line"><span class="attr">PASSWORD_SPECIAL_CHARACTERS:</span> <span class="string">&quot;^a-zA-Z0-9&quot;</span></span><br></pre></td></tr></table></figure><ul><li>add a field <code>envFrom</code>  under the <code>env</code> in templates&#x2F;deployment-statefulset.yaml</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">env:</span><br><span class="line">&#123;&#123; toYaml .Values.env | indent 12 &#125;&#125;</span><br><span class="line">envFrom:</span><br><span class="line">- configMapRef:</span><br><span class="line">    name: self-service-password-env</span><br></pre></td></tr></table></figure><h4 id="2-2-2-Secret"><a href="#2-2-2-Secret" class="headerlink" title="2.2.2 Secret"></a>2.2.2 Secret</h4><ul><li>there are two variables need to been encrypted</li><li>values.secret</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">secret:</span><br><span class="line">  enabled: true</span><br><span class="line">  mountPath: /etc/secret-volume</span><br><span class="line">  subPath: &quot;&quot;</span><br><span class="line">  readOnly: true</span><br><span class="line">  data:</span><br><span class="line">    ldap_bindpass: &quot;example@2020&quot;</span><br><span class="line">    smtp_pass: &quot;WaLxeu3pvsQaqd7X&quot;</span><br></pre></td></tr></table></figure><h4 id="2-2-3-values-env"><a href="#2-2-3-values-env" class="headerlink" title="2.2.3 values.env"></a>2.2.3 values.env</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">env:</span><br><span class="line">  - name: LDAP_BINDPASS</span><br><span class="line">    valueFrom:</span><br><span class="line">      secretKeyRef:</span><br><span class="line">        name: self-service-password</span><br><span class="line">        key: ldap_bindpass</span><br><span class="line">  - name: SMTP_PASS</span><br><span class="line">    valueFrom:</span><br><span class="line">      secretKeyRef:</span><br><span class="line">        name: self-service-password</span><br><span class="line">        key: smtp_pass</span><br></pre></td></tr></table></figure><h4 id="2-2-4-persistentVolume"><a href="#2-2-4-persistentVolume" class="headerlink" title="2.2.4 persistentVolume"></a>2.2.4 persistentVolume</h4><ul><li>create  pv &amp; pvc resources under this namespace，mount the volume ，name: self-service-password</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">persistentVolume:   # 是否存储持久化</span><br><span class="line">  enabled: true</span><br><span class="line">  storageClass: &quot;-&quot;</span><br><span class="line">  accessMode: ReadWriteOnce</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">  size: 1Gi  # 大小</span><br><span class="line">  existingClaim: &#123;&#125;  # 使用已存在的pvc</span><br><span class="line">  mountPaths:</span><br><span class="line">   - name: data-storage</span><br><span class="line">     mountPath: /www/ssp/images/mnt  # 容器内路径，将新建 mnt</span><br><span class="line">     subPath: ssp-nfs                               # pv 中挂载点下的子目录</span><br></pre></td></tr></table></figure><ul><li>pv.yaml</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: self-service-password</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 1Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  nfs:</span><br><span class="line">    path: /home/example/nfs # 指定nfs的挂载点</span><br><span class="line">    server: 10.13.3.108</span><br></pre></td></tr></table></figure><ul><li>Post  test，reverse proxy by nginx using Nodeport。Setting the dns resolving，take a visit of this site。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">upstream ssp &#123;</span><br><span class="line">  server 10.13.3.109:32337;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name ssp.example.net;</span><br><span class="line">    return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl ;</span><br><span class="line">    server_name ssp.example.net;</span><br><span class="line">    ssl_certificate tls/tls_ca.pem; </span><br><span class="line">    ssl_certificate_key tls/tls_key.pem;</span><br><span class="line">    location / &#123;</span><br><span class="line">      proxy_pass http://ssp;</span><br><span class="line">      proxy_set_header Host $host;</span><br><span class="line">      proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">      proxy_set_header X-Forwarded-Proto &quot;https&quot;;</span><br><span class="line">      proxy_read_timeout 1800s;</span><br><span class="line">      proxy_http_version 1.1;</span><br><span class="line">      proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">      proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>charts correction<br><code>utcook.fullname</code>   change into–&gt; <code>self-service-password.fullname</code></li></ul><h3 id="三、To-Do-List"><a href="#三、To-Do-List" class="headerlink" title="三、To Do List"></a>三、To Do List</h3><p>Learn more about：</p><ul><li>storageclass</li><li>traefik ingress</li></ul>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> helm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Failed to Post Blog</title>
      <link href="/ops_blog/2023/12/01/failed-to-post-blog/"/>
      <url>/ops_blog/2023/12/01/failed-to-post-blog/</url>
      
        <content type="html"><![CDATA[<p>Just because of the wrong layout of lines under the <code>summary</code>.<br>The texts of a new line should be recognized.</p>]]></content>
      
      
      <categories>
          
          <category> ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>homelab pc</title>
      <link href="/ops_blog/2023/11/27/homelab-pc/"/>
      <url>/ops_blog/2023/11/27/homelab-pc/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Computer-Parts"><a href="#1-Computer-Parts" class="headerlink" title="1. Computer Parts"></a>1. Computer Parts</h2><table><thead><tr><th align="center">配件</th><th align="center">规格</th><th align="center">价格</th></tr></thead><tbody><tr><td align="center">Motherboard</td><td align="center">华南x99双路8D4</td><td align="center">730含以下二者</td></tr><tr><td align="center">CPU</td><td align="center">E5-2680V4</td><td align="center"></td></tr><tr><td align="center">Cooler</td><td align="center">寒冰A500四铜管</td><td align="center"></td></tr><tr><td align="center">RAM</td><td align="center">闲鱼-镁光窄条2133-16G*4</td><td align="center">280</td></tr><tr><td align="center">GPU</td><td align="center">GTX750 4G 貌似全新</td><td align="center">335</td></tr><tr><td align="center">Chassis</td><td align="center">刀客360</td><td align="center">150</td></tr><tr><td align="center">Fan</td><td align="center">PDD-纯白*5</td><td align="center">48</td></tr><tr><td align="center">SSD</td><td align="center">BU KING 512G</td><td align="center">150</td></tr><tr><td align="center">Power</td><td align="center">华南U700双路电源600W</td><td align="center">243</td></tr><tr><td align="center">Tools</td><td align="center">硅脂、螺丝刀、网线</td><td align="center">25</td></tr></tbody></table><h2 id="2-Install-PVE-System"><a href="#2-Install-PVE-System" class="headerlink" title="2. Install PVE System"></a>2. Install PVE System</h2><ul><li>Ventoy</li><li>proxmox-ve_8.0-2.iso</li></ul><h3 id="2-1-Disable-the-subscription-on-web-UI"><a href="#2-1-Disable-the-subscription-on-web-UI" class="headerlink" title="2.1 Disable the subscription on web UI"></a>2.1 Disable the subscription on web UI</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sed -i_orig <span class="string">&quot;s/data.status === &#x27;Active&#x27;/true/g&quot;</span> /usr/share/pve-manager/js/pvemanagerlib.js</span><br><span class="line">sed -i_orig <span class="string">&quot;s/if (res === null || res === undefined || \!res || res/if(/g&quot;</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js</span><br><span class="line">sed -i_orig <span class="string">&quot;s/.data.status.toLowerCase() !== &#x27;active&#x27;/false/g&quot;</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js</span><br><span class="line">systemctl restart pveproxy</span><br></pre></td></tr></table></figure><h3 id="2-2-Network-Settings"><a href="#2-2-Network-Settings" class="headerlink" title="2.2 Network Settings"></a>2.2 Network Settings</h3><ul><li><a href="https://www.bilibili.com/video/BV1xH4y1f7Ga/?spm_id_from=333.337.search-card.all.click&vd_source=154006e70f5c14d792db947270b63614">reference</a></li><li>pve host using a vitual NIC and bridging the network connection to a physical NIC<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/network/interfaces</span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line">iface enp6s0 inet manual    # physical NIC</span><br><span class="line"></span><br><span class="line">auto vmbr0               # Vitrual NIC</span><br><span class="line">iface vmbr0 inet static</span><br><span class="line">        address 192.168.3.20/24</span><br><span class="line">        gateway 192.168.3.1</span><br><span class="line">        bridge-ports enp6s0     #bridging</span><br><span class="line">        bridge-stp off</span><br><span class="line">        bridge-fd 0</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart networking </span><br></pre></td></tr></table></figure></li></ul><h3 id="2-3-Using-a-homeland-repository-source"><a href="#2-3-Using-a-homeland-repository-source" class="headerlink" title="2.3  Using a homeland repository source"></a>2.3 <a href="https://www.wunote.cn/article/10000"> Using a homeland repository source</a></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">modify the ubuntu software <span class="built_in">source</span></span></span><br><span class="line">wget https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg</span><br><span class="line"></span><br><span class="line">echo &quot;deb https://mirrors.ustc.edu.cn/proxmox/debian bookworm pve-no-subscription&quot; &gt; /etc/apt/sources.list.d/pve-no-subscription.list</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s|^deb http://ftp.debian.org|deb https://mirrors.ustc.edu.cn|g&#x27; /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s|^deb http://security.debian.org|deb https://mirrors.ustc.edu.cn/debian-security|g&#x27; /etc/apt/sources.list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">modify the ceph repository <span class="built_in">source</span></span></span><br><span class="line">echo &quot;deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-quincy bookworm no-subscription&quot; &gt; /etc/apt/sources.list.d/ceph.list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CT images <span class="built_in">source</span></span></span><br><span class="line">sed -i &#x27;s|http://download.proxmox.com|https://mirrors.ustc.edu.cn/proxmox|g&#x27; /usr/share/perl5/PVE/APLInfo.pm</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s/^/#/&#x27; /etc/apt/sources.list.d/pve-enterprise.list</span><br></pre></td></tr></table></figure><h2 id="3-Virtual-machine-on-pve-host"><a href="#3-Virtual-machine-on-pve-host" class="headerlink" title="3. Virtual machine on pve host"></a>3. Virtual machine on pve host</h2><h3 id="3-1-SYS"><a href="#3-1-SYS" class="headerlink" title="3.1 SYS"></a>3.1 SYS</h3><ul><li>ubuntu 22.04.3 server</li><li>choose network bridging on vmbr0, it’s convenient and fast. also because of my simple network architecture.</li></ul><h3 id="3-2-Repository-Source"><a href="#3-2-Repository-Source" class="headerlink" title="3.2 Repository Source"></a>3.2 Repository Source</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">deb https://mirrors.ustc.edu.cn/ubuntu/ jammy main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb https://mirrors.ustc.edu.cn/ubuntu/ jammy-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb https://mirrors.ustc.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb https://mirrors.ustc.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure><h3 id="3-3-Install-containerd、nerdctl-make-this-vm-as-a-template"><a href="#3-3-Install-containerd、nerdctl-make-this-vm-as-a-template" class="headerlink" title="3.3 Install containerd、nerdctl &amp; make this vm as a template"></a>3.3 Install containerd、nerdctl &amp; make this vm as a template</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml  # generating a default configuration of containerd</span><br></pre></td></tr></table></figure><ul><li>Modify part of this file, like below example.</li></ul><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sandbox_image</span> = <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.8&quot;</span></span><br><span class="line"><span class="attr">SystemdCgroup</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span></span><br><span class="line">        <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span></span><br><span class="line">          <span class="attr">endpoint</span> = [<span class="string">&quot;https://bqr1dr1n.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">        <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;k8s.gcr.io&quot;]</span></span><br><span class="line">          <span class="attr">endpoint</span> = [<span class="string">&quot;https://registry.aliyuncs.com/google_containers&quot;</span>]</span><br></pre></td></tr></table></figure><ul><li>Install the nerdctl by binary package</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.fastgit.org/containerd/nerdctl/releases/download/v0.12.1/nerdctl-0.12.1-linux-amd64.tar.gz</span><br><span class="line">mkdir -p /usr/local/containerd/bin/ &amp;&amp; tar -zxvf nerdctl-0.12.1-linux-amd64.tar.gz nerdctl &amp;&amp; mv nerdctl /usr/local/containerd/bin/</span><br><span class="line">ln -s /usr/local/containerd/bin/nerdctl /usr/local/bin/nerdctl</span><br></pre></td></tr></table></figure><h3 id="3-4-System-settings"><a href="#3-4-System-settings" class="headerlink" title="3.4 System settings"></a>3.4 System settings</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ipv4 forward</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">modprobe overlay</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables  = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sysctl --system</span><br><span class="line">sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward</span><br><span class="line"></span><br><span class="line"><span class="comment"># swap</span></span><br><span class="line">swapoff -a</span><br><span class="line"></span><br><span class="line">vim /etc/fstab</span><br><span class="line">  <span class="comment"># /swap.img      none    swap    sw      0       0</span></span><br></pre></td></tr></table></figure><ul><li>Transform this vm into template by Web UI of pve</li></ul><h2 id="4-Kubernetes"><a href="#4-Kubernetes" class="headerlink" title="4. Kubernetes"></a>4. Kubernetes</h2><h3 id="4-1-Install-kubeadm-kubelet-kubectl"><a href="#4-1-Install-kubeadm-kubelet-kubectl" class="headerlink" title="4.1 Install kubeadm kubelet kubectl"></a>4.1 Install kubeadm kubelet kubectl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main &gt; /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | \</span><br><span class="line">apt-key add -</span><br><span class="line">apt-get update &amp;&amp; apt-get install -y kubelet kubeadm kubectl</span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure><h3 id="4-2-generate-a-default-configuration-file-in-workspace-path-to-init-the-cluster"><a href="#4-2-generate-a-default-configuration-file-in-workspace-path-to-init-the-cluster" class="headerlink" title="4.2 generate a default configuration file in workspace path to init the cluster"></a>4.2 generate a default configuration file in workspace path to init the cluster</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print init-defaults --component-configs KubeletConfiguration &gt; kubeadm.yaml</span><br></pre></td></tr></table></figure><ul><li>modify part of configuration file</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">192.168</span><span class="number">.3</span><span class="number">.11</span>  <span class="comment">#master IP</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">unix:///var/run/containerd/containerd.sock</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="comment">#name: master1  # defaults to be node</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.aliyuncs.com/google_containers</span>  <span class="comment">#changing into repository in china</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.28</span><span class="number">.0</span>    <span class="comment"># specify the version of kube</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span>    <span class="comment"># need to add</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span> <span class="comment"># add</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">ipvs</span></span><br></pre></td></tr></table></figure><ul><li>init cluster</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure><ul><li>work nodes joining the cluster</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.3.14:6443 --token n8orxj.f51riixygulit9yz \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:c0af38d55001f6eaf09ca9248db5e048c492ee4b883f0534a54187eceb50a928</span><br></pre></td></tr></table></figure><ul><li>after all the work nodes joining the cluster, deploy the flannel</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/flannel-io/flannel/v0.20.1/Documentation/kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><ul><li>check status of cluster</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes -A</span><br><span class="line">kubectl get pods -A</span><br></pre></td></tr></table></figure><h2 id="5-Fault"><a href="#5-Fault" class="headerlink" title="5. Fault"></a>5. Fault</h2><h3 id="5-1-kubectl-get-nodes"><a href="#5-1-kubectl-get-nodes" class="headerlink" title="5.1 kubectl get nodes"></a>5.1 kubectl get nodes</h3><ul><li>descriobe</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">couldn&#x27;t get current server API group list: Get &quot;http://localhost:8080/api?timeout=32s&quot;: dial tcp 127.0.0.1:8080: connect: connection refused</span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure><ul><li>solution: fogot to apply the config, it’s printed by the kubeadm init command</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure><h3 id="5-2-The-kubelet-is-not-running"><a href="#5-2-The-kubelet-is-not-running" class="headerlink" title="5.2 The kubelet is not running"></a>5.2 The kubelet is not running</h3><ul><li>describe</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[kubelet-check] Initial timeout of 40s passed.</span><br><span class="line"></span><br><span class="line">Unfortunately, an error has occurred:</span><br><span class="line">        timed out waiting for the condition</span><br><span class="line"></span><br><span class="line">This error is likely caused by:</span><br><span class="line">        - The kubelet is not running</span><br><span class="line">        - The kubelet is unhealthy due to a misconfiguration of the node in some way (required cgroups disabled)</span><br></pre></td></tr></table></figure><ul><li>solution: changing the wrong advertiseAddress, supoose to be mine master IP.</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">in</span> some  conditions, this setting may <span class="built_in">help</span>. It controls the cgroup driver of kubelet</span></span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">cgroupDriver: systemd</span><br></pre></td></tr></table></figure><h3 id="5-3-coredns-pod-halting-on-creating-status"><a href="#5-3-coredns-pod-halting-on-creating-status" class="headerlink" title="5.3 coredns pod halting on creating status."></a>5.3 coredns pod halting on creating status.</h3><ul><li>describe</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning  FailedCreatePodSandBox  42s   kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox &quot;03e2b9a1ceaf66beb681891dc276ea490d664822b43047f25d3b5d4a11e76eb0&quot;: plugin type=&quot;flannel&quot; failed (add): open /run/flannel/subnet.env: no such file or directory</span><br></pre></td></tr></table></figure><ul><li>solutions: creating a file &amp;&amp; reset the cluster and reinstall the kube-flannel. ( worked in this case, solution of <code>work not ready</code>)(the file below maybe useless,it’s important to set <code>Podsubnet</code> in the init config file)</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat  /run/flannel/subnet.env  #  manual creating</span><br><span class="line"></span><br><span class="line">FLANNEL_NETWORK=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.0.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=true</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hardware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DIY </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Multiple Domians in OpenLdap Use Case</title>
      <link href="/ops_blog/2023/10/24/multiple-domians-in-openldap-use-case/"/>
      <url>/ops_blog/2023/10/24/multiple-domians-in-openldap-use-case/</url>
      
        <content type="html"><![CDATA[<h1 id="OpenLDAP"><a href="#OpenLDAP" class="headerlink" title="OpenLDAP"></a>OpenLDAP</h1><h2 id="一、-概念"><a href="#一、-概念" class="headerlink" title="一、 概念"></a>一、 概念</h2><p><a href="https://www.openldap.org/doc/admin26/guide.html">官方手册</a></p><h3 id="1-1-常用属性"><a href="#1-1-常用属性" class="headerlink" title="1.1 常用属性"></a>1.1 常用属性</h3><ul><li>DN：Distinguished Name，LDAP记录项的标识，有唯一性，例如：dc:”cn&#x3D;admin,ou&#x3D;developer,dc&#x3D;163,dc&#x3D;com”  </li><li>dc&#x3D; DomainComponent 为域组件，域名的一部分</li><li>cn&#x3D;CommonName 为记录名，表示一个实体，最长到80个字符，可以为中文；</li><li>ou&#x3D;OrganizationUnit 为组织单位，用于分类，最多四级，每级最长32字符，可以为中文；</li><li>uid&#x3D;User id 为用户的唯一标识</li><li>c&#x3D;Country 为国家名，可选，为2个字符长</li><li>o&#x3D;Organization 为组织名，可选，可以3—64个字符长</li></ul><h2 id="二、-手动安装和配置-LDAP"><a href="#二、-手动安装和配置-LDAP" class="headerlink" title="二、 手动安装和配置 LDAP"></a>二、 手动安装和配置 LDAP</h2><h3 id="2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务"><a href="#2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务" class="headerlink" title="2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)"></a>2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install  -y slapd ldap-utils</span><br></pre></td></tr></table></figure><h3 id="2-2-重新配置-OpenLDAP，创建-base-dn"><a href="#2-2-重新配置-OpenLDAP，创建-base-dn" class="headerlink" title="2.2  重新配置 OpenLDAP，创建 base dn"></a>2.2  重新配置 OpenLDAP，创建 base dn</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg-reconfigure slapd   # 主要配置密码 (密码在下一步重置，便于配置连接)，DNS domain name(即 LDAP 服务中的 base dn)</span><br><span class="line"></span><br><span class="line"> 说明：</span><br><span class="line">第一步回答 No</span><br><span class="line">第二步填写域名，比如 mycompany.com</span><br><span class="line">第三步填写组织名，比如 Company</span><br><span class="line">第四步填写管理员密码，比如 secret；第五步确认管理员密码</span><br><span class="line">第六步选择使用的数据库后端，比如 MDB</span><br><span class="line">第七步选择在清除 slapd 时是否移除数据库，比如 Yes</span><br><span class="line">第八步选择是否移除旧数据库，比如 Yes</span><br></pre></td></tr></table></figure><h3 id="2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码"><a href="#2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码" class="headerlink" title="2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码"></a>2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slappasswd</span><br><span class="line">&#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure><ul><li>通过数据库修改admin用户的ldif文件<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/slapd.d/cn\=config/olcDatabase\=\&#123;1\&#125;mdb.ldif</span><br><span class="line">olcDatabase: &#123;1&#125;mdb</span><br><span class="line">olcSuffix: dc=example,dc=top</span><br><span class="line">olcRootDN: cn=admin,dc=example,dc=top</span><br><span class="line">olcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure></li><li>olcDatabase: 定义使用的后端数据存储格式,遵循默认</li><li>olcSuffix: 设置 LDAP 服务的根</li><li>olcRootDN: 设置管理员用户的 dn</li><li>olcRootPW: 管理员用户的密码</li><li>修改后重启服务<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo slaptest -u   # 检查配置文件</span><br><span class="line">sudo systemctl enable slapd  --now</span><br><span class="line"></span><br><span class="line">sudo slapcat        # 输出看到当前数据库内容</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-4-正确的修改olcRootPW-管理员用户的密码"><a href="#2-4-正确的修改olcRootPW-管理员用户的密码" class="headerlink" title="2.4 正确的修改olcRootPW: 管理员用户的密码"></a>2.4 正确的修改olcRootPW: 管理员用户的密码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcRootPW</span><br><span class="line">olcRootPW: example2020  # 保存在数据库文件中的时候将会被加密</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapmodify -Y EXTERNAL -H ldapi:/// -f passmodify.ldif</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">同时进入web ui，修改admin账户的密码，如果不修改两个密码都能管理域，二者修改一致之后，才是新的管理密码生效</span><br></pre></td></tr></table></figure><h3 id="2-5-简单结构展示"><a href="#2-5-简单结构展示" class="headerlink" title="2.5 简单结构展示"></a>2.5 简单结构展示</h3><p>略</p><h3 id="2-6-创建base-dn"><a href="#2-6-创建base-dn" class="headerlink" title="2.6 创建base dn"></a>2.6 创建base dn</h3><h4 id="2-6-1-查看LDAP服务器的根目录信息"><a href="#2-6-1-查看LDAP服务器的根目录信息" class="headerlink" title="2.6.1 查看LDAP服务器的根目录信息"></a>2.6.1 查看LDAP服务器的根目录信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapsearch -x -LLL -b &#x27;&#x27; -s base &#x27;(objectclass=*)&#x27;</span><br><span class="line">dn:</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: OpenLDAProotDSE</span><br></pre></td></tr></table></figure><h4 id="2-6-2-基于-ldif-文件直接创建，不使用图形化交互。创建之后，对这个-base-dn-设置管理员的密码"><a href="#2-6-2-基于-ldif-文件直接创建，不使用图形化交互。创建之后，对这个-base-dn-设置管理员的密码" class="headerlink" title="2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码"></a>2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-</span><br><span class="line">dn: dc=example,dc=top</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: domain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: o=example,dc=example,dc=top</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: organization</span><br><span class="line">o: example</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapmodify -x -D &quot;cn=admin,dc=example,dc=top&quot; -w example@2020  -f organization.ldif</span><br></pre></td></tr></table></figure><h3 id="2-7-创建多个-DIT-base-dn-（可以考虑尝试后端用-mysql-做数据库）"><a href="#2-7-创建多个-DIT-base-dn-（可以考虑尝试后端用-mysql-做数据库）" class="headerlink" title="2.7 创建多个 DIT + base dn （可以考虑尝试后端用 mysql 做数据库）"></a>2.7 创建多个 DIT + base dn （可以考虑尝试后端用 <code>mysql</code> 做数据库）</h3><h4 id="2-7-1-为新的库，准备存储路径，并通过apparmor做权限限制"><a href="#2-7-1-为新的库，准备存储路径，并通过apparmor做权限限制" class="headerlink" title="2.7.1 为新的库，准备存储路径，并通过apparmor做权限限制"></a>2.7.1 为新的库，准备存储路径，并通过<code>apparmor</code>做权限限制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir  /var/lib/ldap2</span><br><span class="line">chown openldap:openldap  /var/lib/ldap2</span><br><span class="line">vim /etc/apparmor.d/usr.sbin.slapd</span><br><span class="line"># the databases and logs</span><br><span class="line">/var/lib/ldap2/ r,</span><br><span class="line">/var/lib/ldap2/** rwk,</span><br><span class="line"></span><br><span class="line"># lock file</span><br><span class="line">/var/lib/ldap2/alock kw,</span><br><span class="line"></span><br><span class="line">sudo systemctl  reload  apparmor </span><br></pre></td></tr></table></figure><h4 id="2-7-2-准备-ldif-文件，创建新的-DIT（可以自定义路径）"><a href="#2-7-2-准备-ldif-文件，创建新的-DIT（可以自定义路径）" class="headerlink" title="2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）"></a>2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;2&#125;mdb,cn=config</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: olcDatabaseConfig</span><br><span class="line">objectClass: olcMdbConfig</span><br><span class="line">olcDbDirectory: /var/lib/ldap2/</span><br><span class="line">olcDatabase: &#123;2&#125;Mdb</span><br><span class="line">olcDbIndex: objectClass eq</span><br><span class="line">olcDbIndex: cn,uid eq</span><br><span class="line">olcDbIndex: uidNumber,gidNumber eq</span><br><span class="line">olcDbIndex: member,memberUid eq</span><br><span class="line">olcLastMod: TRUE</span><br><span class="line">olcMonitoring: TRUE</span><br><span class="line">olcDBNoSync: TRUE</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write by anonymous auth by * non</span><br><span class="line"> e</span><br><span class="line">olcAccess: &#123;1&#125;to attrs=shadowLastChange by self write by * read</span><br><span class="line">olcSuffix: dc=example,dc=tech</span><br><span class="line">olcRootDN: cn=admin,dc=example,dc=tech</span><br><span class="line">olcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo  ldapmodify -Y EXTERNAL -H ldapi:/// -f domian2.ldif</span><br></pre></td></tr></table></figure><h4 id="2-7-3-新增并设置管理员"><a href="#2-7-3-新增并设置管理员" class="headerlink" title="2.7.3 新增并设置管理员"></a>2.7.3 新增并设置管理员</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-</span><br><span class="line">dn: cn=admin,dc=example,dc=tech</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: admin</span><br><span class="line">userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br><span class="line">==========================</span><br><span class="line"># 以下是playbook中模板文件</span><br><span class="line">-</span><br><span class="line">dn: cn=admin,&#123;&#123; item.base_dn &#125;&#125;  </span><br><span class="line">changetype: add  </span><br><span class="line">objectClass: simpleSecurityObject  </span><br><span class="line">objectClass: organizationalRole  </span><br><span class="line">cn: admin  </span><br><span class="line">userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapadd -x -D &quot;cn=admin,dc=example,dc=tech&quot; -w example@2020 -f basedn2.ldif</span><br></pre></td></tr></table></figure><h4 id="2-7-4-多-DIT-跨域-ACL"><a href="#2-7-4-多-DIT-跨域-ACL" class="headerlink" title="2.7.4 多 DIT 跨域 ACL"></a>2.7.4 多 DIT 跨域 ACL</h4><ul><li><p>查询服务器的域</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://10.13.3.107 -b &quot;&quot; -s base namingContexts</span><br></pre></td></tr></table></figure></li><li><p>设置一个全权限的 acl ，跨域访问，相应的用户需已经提前创建</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">让这个dn 用户: cn=user.tech,dc=example,dc=tech ;  可以阅读这个base dn : dc=example,dc=top 下的所有条目.</span><br><span class="line">对应关系：数据库----&#123;1&#125;mdb  存储的数据是来自 dn: dc=example,dc=top 。即，对谁的访问则将 acl 添加在谁的库下  </span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=example,dc=top&quot; by dn.base=&quot;cn=user.tech,dc=example,dc=tech&quot; read</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapmodify   -Y   EXTERNAL   -H   ldapi:///   -f  xxx</span><br></pre></td></tr></table></figure><h4 id="2-7-5-测试"><a href="#2-7-5-测试" class="headerlink" title="2.7.5 测试"></a>2.7.5 测试</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">root@example-sys-test-06:/etc/ldap/example# ldapsearch -x -b &quot;dc=example,dc=top&quot; -D &quot;cn=user.tech,dc=example,dc=tech&quot; -w example@2020</span><br><span class="line"># extended LDIF</span><br><span class="line">#</span><br><span class="line"># LDAPv3</span><br><span class="line"># base &lt;dc=example,dc=top&gt; with scope subtree</span><br><span class="line"># filter: (objectclass=*)</span><br><span class="line"># requesting: ALL</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># example.top</span><br><span class="line">dn: dc=example,dc=top</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: domain</span><br><span class="line">dc: example</span><br><span class="line"></span><br><span class="line"># admin, example.top</span><br><span class="line">dn: cn=admin,dc=example,dc=top</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: admin</span><br><span class="line"></span><br><span class="line"># search result</span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"></span><br><span class="line"># numResponses: 3</span><br><span class="line"># numEntries: 2</span><br><span class="line">root@example-sys-test-06:/etc/ldap/example# ldapsearch -x -b &quot;dc=example,dc=tech&quot; -D &quot;cn=admin,dc=example,dc=top&quot; -w example@2020</span><br><span class="line"># extended LDIF</span><br><span class="line">#</span><br><span class="line"># LDAPv3</span><br><span class="line"># base &lt;dc=example,dc=tech&gt; with scope subtree</span><br><span class="line"># filter: (objectclass=*)</span><br><span class="line"># requesting: ALL</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># search result</span><br><span class="line">search: 2</span><br><span class="line">result: 32 No such object</span><br><span class="line"></span><br><span class="line"># numResponses: 1</span><br></pre></td></tr></table></figure><ul><li>测试的日志<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 fd=12 ACCEPT from IP=127.0.0.1:59834 (IP=0.0.0.0:389)</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 BIND dn=&quot;cn=user.tech,dc=example,dc=tech&quot; method=128</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 BIND dn=&quot;cn=user.tech,dc=example,dc=tech&quot; mech=SIMPLE ssf=0</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=0 RESULT tag=97 err=0 text=</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=1 SRCH base=&quot;dc=example,dc=top&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=1 SEARCH RESULT tag=101 err=0 nentries=2 text=</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 op=2 UNBIND</span><br><span class="line">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn=1097 fd=12 closed</span><br><span class="line">=================</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 fd=12 ACCEPT from IP=127.0.0.1:34916 (IP=0.0.0.0:389)</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; method=128</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; mech=SIMPLE ssf=0</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=0 RESULT tag=97 err=0 text=</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=1 SRCH base=&quot;dc=example,dc=tech&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=1 SEARCH RESULT tag=101 err=32 nentries=0 text=</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 op=2 UNBIND</span><br><span class="line">Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn=1098 fd=12 closed</span><br></pre></td></tr></table></figure></li></ul><h2 id="三、-web管理器配置"><a href="#三、-web管理器配置" class="headerlink" title="三、 web管理器配置"></a>三、 web管理器配置</h2><h3 id="3-1-安装-LAM-（用于管理的Web-UI）"><a href="#3-1-安装-LAM-（用于管理的Web-UI）" class="headerlink" title="3.1 安装  LAM （用于管理的Web UI）"></a>3.1 安装  LAM （用于管理的Web UI）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install ldap-account-manager</span><br></pre></td></tr></table></figure><p>访问 <a href="http://ip/lam">http://ip/lam</a> ，lam的所有配置都可以在web端配置，不需要去服务器上修改一行代码</p><h4 id="3-1-1-LAM-configuration-helm-安装的主要修改内容"><a href="#3-1-1-LAM-configuration-helm-安装的主要修改内容" class="headerlink" title="3.1.1 LAM configuration (helm 安装的主要修改内容)"></a>3.1.1 LAM configuration (<a href="https://check-lc.github.io/ops_blog/2023/12/04/the-first-time-using-helm-charts/">helm 安装的主要修改内容</a>)</h4><pre>主要内容：  LDAP_DOMAIN: example.net;ibexample.com  LDAP_BASE_DN: dc=example,dc=net;dc=ibexample,dc=com  LDAP_SERVER: ldaps://ldap01.example.net  LDAP_USER: cn=administrator,dc=example,dc=net  LAM_LANG: zh_CN  LAM_PASSWORD: lam</pre><ul><li><p>tree view编辑更高效</p></li><li><p>如果选择 docker 安装镜像：ghcr.io&#x2F;ldapaccountmanager&#x2F;lam:8.4@sha256:283726bd23510f1c3bfbdcbfe861e6599e070616543aed02e9756075c97a9938</p></li></ul><h4 id="3-1-3-Nginx反向代理-LAM-Web-UI"><a href="#3-1-3-Nginx反向代理-LAM-Web-UI" class="headerlink" title="3.1.3 Nginx反向代理 LAM Web UI"></a>3.1.3 Nginx反向代理 LAM Web UI</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">upstream lam &#123;</span><br><span class="line">  server 10.13.3.108:8001;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name lam.example.net;</span><br><span class="line">  return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  server_name lam.example.net;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  ssl_certificate webmin/tls_ca.pem;</span><br><span class="line">  ssl_certificate_key webmin/tls_key.pem;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">     proxy_pass http://lam/;</span><br><span class="line">     proxy_set_header Host $host;</span><br><span class="line">     proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">#     proxy_set_header X-Forwarded-Proto &quot;https&quot;;</span><br><span class="line">     proxy_read_timeout 1800s;</span><br><span class="line">     proxy_http_version 1.1;</span><br><span class="line">     proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">     proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-测试-phpldapadmin"><a href="#3-2-测试-phpldapadmin" class="headerlink" title="3.2 测试 phpldapadmin"></a>3.2 测试 phpldapadmin</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Setting up php8.1 (8.1.2-1ubuntu2.14)                       # 版本信息，配置文件完整，存在证书认证并可以指定路径</span><br><span class="line">Setting up php (2:8.1+92ubuntu1) </span><br><span class="line">Setting up phpldapadmin (1.2.6.3-0.2)                                       </span><br></pre></td></tr></table></figure><h4 id="3-2-1-安装"><a href="#3-2-1-安装" class="headerlink" title="3.2.1 安装"></a>3.2.1 安装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apt-get install phpldapadmin -y</span><br><span class="line">nano /etc/phpldapadmin/config.php</span><br><span class="line">$servers-&gt;setValue(&#x27;server&#x27;,&#x27;name&#x27;,&#x27;My LDAP Server&#x27;);                      # 辨识，区分的作用</span><br><span class="line">$servers-&gt;setValue(&#x27;server&#x27;,&#x27;host&#x27;,&#x27;69.87.216.102&#x27;);                              #  修改ip为服务器 ip</span><br><span class="line">$servers-&gt;;setValue(&#x27;server&#x27;,&#x27;base&#x27;,array(&#x27;dc=example,dc=com&#x27;));                    # 修改 array 内容为需求的根</span><br><span class="line">$servers-&gt;setValue(&#x27;login&#x27;,&#x27;auth_type&#x27;,&#x27;session&#x27;);                                              </span><br><span class="line">$servers-&gt;setValue(&#x27;login&#x27;,&#x27;bind_id&#x27;,&#x27;cn=admin,dc=example,dc=com&#x27;);           #   绑定登录帐号admin，相应修改 dn 号即可</span><br><span class="line">$servers-&gt;setValue(&#x27;auto_number&#x27;,&#x27;min&#x27;,array(&#x27;uidNumber&#x27;=&gt;10000,&#x27;gidNumber&#x27;=&gt;10000));   # 规定 uid，gid 数字表示的起始范围</span><br></pre></td></tr></table></figure><h4 id="3-2-2-为-phpLDAPadmin-配置-Apache"><a href="#3-2-2-为-phpLDAPadmin-配置-Apache" class="headerlink" title="3.2.2 为 phpLDAPadmin 配置 Apache"></a>3.2.2 为 phpLDAPadmin 配置 Apache</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a2dissite 000-default.conf        # 禁用默认的 Apache 虚拟主机配置文件</span><br><span class="line">systemctl restart apache2          </span><br></pre></td></tr></table></figure><h2 id="四、-主从架构-弃用，此配置需要在从服务器拉取-refresh"><a href="#四、-主从架构-弃用，此配置需要在从服务器拉取-refresh" class="headerlink" title="四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)"></a>四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)</h2><p><a href="https://darkdark.top/ch5-replication.html">模式介绍</a></p><h3 id="4-1-master-加载同步模块"><a href="#4-1-master-加载同步模块" class="headerlink" title="4.1 master 加载同步模块"></a>4.1 master 加载同步模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/ldap/mod_syncprov.ldif</span><br><span class="line">dn: cn=module,cn=config</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">cn: module</span><br><span class="line">olcModulePath: /usr/lib/ldap</span><br><span class="line">olcModuleLoad: syncprov.la          # 此配置和上一句配置，实际是在请求这个路径的文件，/usr/lib/ldap/syncprov.la，不确定的可以用 find 查找</span><br><span class="line"></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f ./mod_syncprov.ldif</span><br></pre></td></tr></table></figure><h3 id="4-2-同步设置"><a href="#4-2-同步设置" class="headerlink" title="4.2 同步设置"></a>4.2 同步设置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@example-sys-test-06:/etc/ldap# cat syncprov.ldif </span><br><span class="line">dn: olcOverlay=syncprov,olcDatabase=&#123;1&#125;mdb,cn=config       # 此处需要确认自己的数据库是什么样的，&#123;2&#125;hdb--旧版本默认 / &#123;1&#125;mdb--新版本默认</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcSyncProvConfig</span><br><span class="line">olcOverlay: syncprov</span><br><span class="line">olcSpCheckpoint: 100 10</span><br><span class="line">olcSpSessionLog: 100</span><br><span class="line"></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f ./syncprov.ldif                             # 修改并应用条目到 LDAP 服务  -Y EXTERNAL    将使用服务器配置的外部身份验证方法进行身份验证，而不是使用用户名和密码; -H 指定服务器连接; -f 指定文件</span><br></pre></td></tr></table></figure><h3 id="4-3-从服务器配置"><a href="#4-3-从服务器配置" class="headerlink" title="4.3 从服务器配置"></a>4.3 从服务器配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@example-sys-test-07:/etc/ldap# cat syncrepl.ldif</span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcSyncRepl</span><br><span class="line">olcSyncRepl: rid=002</span><br><span class="line">  provider=ldap://10.13.3.106:389/        # 此处开始与上一行有缩进</span><br><span class="line">  bindmethod=simple</span><br><span class="line">  binddn=&quot;cn=admin,dc=example,dc=top&quot;</span><br><span class="line">  credentials=example@2020      </span><br><span class="line">  searchbase=&quot;dc=example,dc=top&quot;</span><br><span class="line">  scope=sub</span><br><span class="line">  schemachecking=on</span><br><span class="line">  type=refreshAndPersist</span><br><span class="line">  retry=&quot;5 5 300 +&quot;</span><br><span class="line">  attrs=&quot;*,+&quot;</span><br><span class="line">  interval=00:00:00:3</span><br><span class="line"></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/syncrepl.ldif</span><br></pre></td></tr></table></figure><ul><li>运行中，修改主服务器内数据后，对从服务器u做刷新，可以看到是否同步</li></ul><p>参数说明：</p><ul><li>provider 为ldap master&#x2F;slave的地址 ;</li><li>binddn：为域的基本信息，注这里一定要用管理员进行登录，否则同步不到用户的密码。</li><li>credentials: ldap管理员的密码</li><li>searchbase：选择要同步的独立域，根节点</li><li>scope：设置所有的条目匹配</li><li>schemachecking：设置同步更新时间检测</li><li>type：同步模式为refreshAndPersist， refreshOnly 模式下后续操作由客户端轮询完成</li><li>retry:同步更新重试次数和时间刚开始的5秒重试5次，以后每300秒重试一次</li><li>attrs:复制全部属性</li><li>interval 这里设置更新时间，这里为3秒一次，倒数第二个是分钟 以此类推。</li></ul><h2 id="四、-镜像复制（互为主从）"><a href="#四、-镜像复制（互为主从）" class="headerlink" title="四、 镜像复制（互为主从）"></a>四、 镜像复制（互为主从）</h2><p><a href="https://darkdark.top/ch5-replication.html">模式介绍</a></p><h3 id="4-1-为某域编辑-mirrorsync-ldif"><a href="#4-1-为某域编辑-mirrorsync-ldif" class="headerlink" title="4.1 为某域编辑 mirrorsync.ldif"></a>4.1 为某域编辑 mirrorsync.ldif</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=module,cn=config         # 此段配置加载s ync 模块</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">cn: module</span><br><span class="line">olcModulePath: /usr/lib/ldap</span><br><span class="line">olcModuleLoad: syncprov.la     # 此配置和上一句，实际是在请求这个路径的文件，/usr/lib/ldap/syncprov.la，不确定的可 find 查找</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: olcOverlay=syncprov,olcDatabase=&#123;1&#125;mdb,cn=config        </span><br><span class="line"> # 此处需确认自己的数据库，&#123;2&#125;hdb--为旧版本默认 / &#123;1&#125;mdb--为新版本默认。路径 /etc/ldap/slapd.d/cn\=config/olcDatabase\=\&#123;1\&#125;mdb.ldif</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcSyncProvConfig</span><br><span class="line">olcOverlay: syncprov</span><br><span class="line">olcSpSessionLog: 100</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcServerID</span><br><span class="line">olcServerID: 0                                        # 用于标识本机的 server id</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config      # 以下配置用于开启复制，指定主服务器</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcSyncRepl</span><br><span class="line">olcSyncRepl: rid=000                             # 标识唯一的 replica id</span><br><span class="line">  provider=ldaps://ldap01.example.top       # 看上述记录介绍参数</span><br><span class="line">  bindmethod=simple</span><br><span class="line">  binddn=&quot;cn=admin,dc=example,dc=top&quot;</span><br><span class="line">  credentials=example@2020</span><br><span class="line">  searchbase=&quot;dc=example,dc=top&quot;</span><br><span class="line">  tls_reqcert=allow</span><br><span class="line">  scope=sub</span><br><span class="line">  schemachecking=on</span><br><span class="line">  type=refreshAndPersist</span><br><span class="line">  retry=&quot;30 5 300 3&quot;</span><br><span class="line">  interval=00:00:05:00</span><br><span class="line">-</span><br><span class="line">add: olcMirrorMode                        # 开启 mirror mode</span><br><span class="line">olcMirrorMode: TRUE</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-2-ldap01-example-top下编辑-mirrorsync-ldif"><a href="#4-2-ldap01-example-top下编辑-mirrorsync-ldif" class="headerlink" title="4.2 ldap01.example.top下编辑 mirrorsync.ldif"></a>4.2 ldap01.example.top下编辑 mirrorsync.ldif</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=module,cn=config</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">cn: module</span><br><span class="line">olcModulePath: /usr/lib/ldap</span><br><span class="line">olcModuleLoad: syncprov.la</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: olcOverlay=syncprov,olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcSyncProvConfig</span><br><span class="line">olcOverlay: syncprov</span><br><span class="line">olcSpSessionLog: 100</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcServerID</span><br><span class="line">olcServerID: 1</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcSyncRepl</span><br><span class="line">olcSyncRepl: rid=001</span><br><span class="line">  provider=ldaps://ldap.example.top</span><br><span class="line">  bindmethod=simple</span><br><span class="line">  binddn=&quot;cn=admin,dc=example,dc=top&quot;</span><br><span class="line">  credentials=example@2020</span><br><span class="line">  searchbase=&quot;dc=example,dc=top&quot;</span><br><span class="line">  tls_reqcert=allow</span><br><span class="line">  scope=sub</span><br><span class="line">  schemachecking=on</span><br><span class="line">  type=refreshAndPersist</span><br><span class="line">  retry=&quot;30 5 300 3&quot;</span><br><span class="line">  interval=00:00:05:00</span><br><span class="line">-</span><br><span class="line">add: olcMirrorMode</span><br><span class="line">olcMirrorMode: TRUE</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="4-2-1-加载配置"><a href="#4-2-1-加载配置" class="headerlink" title="4.2.1 加载配置"></a>4.2.1 加载配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f mirrorsync.ldif</span><br></pre></td></tr></table></figure><h2 id="五、-TLS加密（自签名-权威证书）"><a href="#五、-TLS加密（自签名-权威证书）" class="headerlink" title="五、 TLS加密（自签名&#x2F;权威证书）"></a>五、 TLS加密（自签名&#x2F;权威证书）</h2><p>（自签名证书加密连接 nextcloud 失败，使用不便，采用 权威证书（多域合一）或stunnel）</p><h3 id="5-1-CA中心创建证书"><a href="#5-1-CA中心创建证书" class="headerlink" title="5.1 CA中心创建证书"></a>5.1 CA中心创建证书</h3><pre><code>此时使用LDAP 主服务器 作为 CA 中心，自签名</code></pre><ul><li><p>安装 gnutls-bin 和 ssl-cert 包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gnutls-bin ssl-cert</span><br></pre></td></tr></table></figure></li><li><p>为证书授权中心创建私钥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-privkey --bits 4096 --outfile /etc/ssl/private/mycakey.pem</span><br></pre></td></tr></table></figure></li><li><p>创建模板文件来定义CA</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/ssl/ca.info</span><br><span class="line"> cn = example (example company)  </span><br><span class="line"> ca</span><br><span class="line"> cert_signing_key</span><br><span class="line"> expiration_days = 3650</span><br></pre></td></tr></table></figure></li><li><p>创建自签名 CA (根)证书</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-self-signed \</span><br><span class="line">--load-privkey /etc/ssl/private/mycakey.pem \</span><br><span class="line">--template /etc/ssl/ca.info \</span><br><span class="line">--outfile /usr/local/share/ca-certificates/mycacert.crt</span><br></pre></td></tr></table></figure></li><li><p>Note：<br>  <code>--outfile</code>路径是正确的，将CA证书写入<code>/usr/local/share/ca-certificates</code>。<br>  <strong>update-ca-certificates</strong> 将从这里获取受信任的本地CA。如果要从<code>/usr/share/ca-certificates</code>获取CA，需要调用<code>dpkg-reconfigure ca-certificates</code></p></li><li><p>将新的 CA 根证书添加到受信任 CA 列表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-ca-certificates     # 会创建一个/etc/ssl/certs/mycacert.pem符号链接，指向/usr/local/share/ca-certificates中的真实文件</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-2-创建-LDAP-服务的服务器私钥与证书"><a href="#5-2-创建-LDAP-服务的服务器私钥与证书" class="headerlink" title="5.2 创建 LDAP 服务的服务器私钥与证书"></a>5.2 创建 LDAP 服务的服务器私钥与证书</h3><ul><li><p>创建私钥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-privkey \</span><br><span class="line">--bits 2048 \</span><br><span class="line">--outfile /etc/ldap/ldap01_slapd_key.pem</span><br></pre></td></tr></table></figure></li><li><p>服务器信息文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/etc/ssl/ldap01.info</span><br><span class="line">organization = example</span><br><span class="line">cn = ldap01.example.top                     # 服务器证书的DN必须使用CN属性来命名服务器，并且CN必须携带服务器的完全限定域名，dns 需要有 A 记录解析</span><br><span class="line">tls_www_server</span><br><span class="line">encryption_key</span><br><span class="line">signing_key</span><br><span class="line">expiration_days = 365</span><br><span class="line">证书有效期为1年，仅对_`ldap01`_主机名有效</span><br></pre></td></tr></table></figure></li><li><p>创建LDAP服务器的证书</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-certificate \</span><br><span class="line">--load-privkey /etc/ldap/ldap01_slapd_key.pem \</span><br><span class="line">--load-ca-certificate /etc/ssl/certs/mycacert.pem \</span><br><span class="line">--load-ca-privkey /etc/ssl/private/mycakey.pem \</span><br><span class="line">--template /etc/ssl/ldap01.info \</span><br><span class="line">--outfile /etc/ldap/ldap01_slapd_cert.pem</span><br></pre></td></tr></table></figure></li><li><p>调整权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chgrp openldap /etc/ldap/ldap01_slapd_key.pem</span><br><span class="line">sudo chmod 0640 /etc/ldap/ldap01_slapd_key.pem</span><br></pre></td></tr></table></figure></li><li><p>ca根证书加入到受信列表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp   cacertificatefile  /usr/local/share/ca-certificates/mycacert.crt</span><br><span class="line">sudo update-ca-certificates</span><br></pre></td></tr></table></figure></li><li><p>对LDAP服务配置证书</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=config</span><br><span class="line">add: olcTLSCACertificateFile</span><br><span class="line">olcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem</span><br><span class="line">-</span><br><span class="line">add: olcTLSCertificateFile</span><br><span class="line">olcTLSCertificateFile: /etc/ldap/ldap01_slapd_cert.pem</span><br><span class="line">-</span><br><span class="line">add: olcTLSCertificateKeyFile</span><br><span class="line">olcTLSCertificateKeyFile: /etc/ldap/ldap01_slapd_key.pem</span><br></pre></td></tr></table></figure></li><li><p>配置slapd-config数据库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif </span><br></pre></td></tr></table></figure></li><li><p>报错调整，更改<code>certinfo.ldif</code>，将<code>add</code>改成了<code>replace</code>，可以解决以下问题。修改后再次执行<code>ldapmodify</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif </span><br><span class="line">SASL/EXTERNAL authentication started SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth </span><br><span class="line">SASL SSF: 0 </span><br><span class="line">modifying entry &quot;cn=config&quot; ldap_modify: Inappropriate matching (18) </span><br><span class="line">additional info: modify/add: olcTLSCACertificateFile: no equality matching rule</span><br></pre></td></tr></table></figure></li><li><p>ldap-client增添配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/ldap.conf</span><br><span class="line"># LDAP Defaults</span><br><span class="line"># See ldap.conf(5) for details</span><br><span class="line"># This file should be world readable but not world writable.</span><br><span class="line">BASE       dc=example,dc=top                                                      # LDAP服务的基础DN</span><br><span class="line">URI ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用</span><br><span class="line">[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制</span><br><span class="line">[[TIMELIMIT]]  15                                                                     # 最长搜索时间</span><br><span class="line">[[DEREF]]              never                                                            # 指定对别名的处理方式</span><br><span class="line"># TLS certificates (needed for GnuTLS)</span><br><span class="line">TLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径</span><br><span class="line">TLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书</span><br></pre></td></tr></table></figure></li><li><p>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/default/slapd</span><br><span class="line">SLAPD_SERVICES=&quot;ldap:/// ldapi:/// ldaps:///&quot;</span><br></pre></td></tr></table></figure></li><li><p>测试启动 TLS</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapwhoami -x -ZZ -H ldap://ldap01.example.com</span><br><span class="line">anonymous</span><br></pre></td></tr></table></figure></li><li><p>测试连接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapwhoami -x -H ldaps://ldap01.example.com</span><br><span class="line">anonymous</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器"><a href="#5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器" class="headerlink" title="5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器"></a>5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器</h3><ul><li>指定目录保存<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir ldap02-ssl</span><br><span class="line">cd ldap02-ssl</span><br><span class="line">certtool --generate-privkey \</span><br><span class="line">--bits 2048 \</span><br><span class="line">--outfile ldap02_slapd_key.pem</span><br></pre></td></tr></table></figure></li><li>编辑信息文件ldap02.info<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">organization = example</span><br><span class="line">cn = ldap02.example.top                      </span><br><span class="line">tls_www_server</span><br><span class="line">encryption_key</span><br><span class="line">signing_key</span><br><span class="line">expiration_days = 365</span><br></pre></td></tr></table></figure></li><li>创建证书<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo certtool --generate-certificate \</span><br><span class="line">--load-privkey ldap02_slapd_key.pem \</span><br><span class="line">--load-ca-certificate /etc/ssl/certs/mycacert.pem \</span><br><span class="line">--load-ca-privkey /etc/ssl/private/mycakey.pem \</span><br><span class="line">--template ldap02.info \</span><br><span class="line">--outfile ldap02_slapd_cert.pem</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/ssl/certs/mycacert.pem .</span><br><span class="line">scp -r ldap02-ssl user@ldap02_ip:</span><br></pre></td></tr></table></figure><ul><li>从服务器中安装证书<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ldap02_slapd_cert.pem ldap02_slapd_key.pem /etc/ldap</span><br><span class="line">sudo chgrp openldap /etc/ldap/ldap02_slapd_key.pem</span><br><span class="line">sudo chmod 0640 /etc/ldap/ldap02_slapd_key.pem</span><br><span class="line">sudo cp mycacert.pem /usr/local/share/ca-certificates/mycacert.crt</span><br><span class="line">sudo update-ca-certificates</span><br></pre></td></tr></table></figure></li><li>对LDAP服务配置证书 <code>./certinfo.ldif </code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=config</span><br><span class="line">add: olcTLSCACertificateFile</span><br><span class="line">olcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem</span><br><span class="line">-</span><br><span class="line">add: olcTLSCertificateFile</span><br><span class="line">olcTLSCertificateFile: /etc/ldap/ldap02_slapd_cert.pem</span><br><span class="line">-</span><br><span class="line">add: olcTLSCertificateKeyFile</span><br><span class="line">olcTLSCertificateKeyFile: /etc/ldap/ldap02_slapd_key.pem</span><br></pre></td></tr></table></figure></li><li>配置slapd-config数据库：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif </span><br></pre></td></tr></table></figure></li><li>增添配置文件<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/ldap.conf</span><br><span class="line">BASE       dc=example,dc=top                                                      # LDAP服务的基础DN</span><br><span class="line">URI ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用</span><br><span class="line">[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制</span><br><span class="line">[[TIMELIMIT]]  15                                                                     # 最长搜索时间</span><br><span class="line">[[DEREF]]              never                                                            # 指定对别名的处理方式</span><br><span class="line"># TLS certificates (needed for GnuTLS)</span><br><span class="line">TLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径</span><br><span class="line">TLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书</span><br></pre></td></tr></table></figure></li><li>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/default/slapd</span><br><span class="line">SLAPD_SERVICES=&quot;ldap:/// ldapi:/// ldaps:///&quot;</span><br></pre></td></tr></table></figure></li><li>测试启动 TLS<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapwhoami -x -ZZ -H ldap://ldap02.example.top</span><br><span class="line">anonymous</span><br></pre></td></tr></table></figure></li><li>测试连接<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapwhoami -x -H ldaps://ldap02.example.top</span><br><span class="line">anonymous</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-4-使用合法证书"><a href="#5-4-使用合法证书" class="headerlink" title="5.4 使用合法证书"></a>5.4 使用合法证书</h3><ul><li><p>将新的 CA 根证书添加到受信任 CA 列表（客户端操作，权威证书按理不需要拷贝，未测试）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo   cp   _.example.top-chain.pem   /usr/local/share/ca-certificates/mycacert.crt</span><br><span class="line">sudo update-ca-certificates</span><br></pre></td></tr></table></figure></li><li><p>准备服务器证书和私钥（服务端）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ls /etc/ldap</span><br><span class="line">certinfo.ldif   _.example.top-crt.pem   _.example.top-key.pem</span><br><span class="line">sudo chgrp openldap /etc/ldap/_.example.top-key.pem</span><br><span class="line">sudo chmod 0640 /etc/ldap/_.example.top-key.pem</span><br></pre></td></tr></table></figure></li><li><p>certinfo.ldif</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcTLSCACertificateFile</span><br><span class="line">olcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem</span><br><span class="line">-</span><br><span class="line">replace: olcTLSCertificateFile</span><br><span class="line">olcTLSCertificateFile: /etc/ldap/_.example.top-crt.pem</span><br><span class="line">-</span><br><span class="line">replace: olcTLSCertificateKeyFile</span><br><span class="line">olcTLSCertificateKeyFile: /etc/ldap/_.example.top-key.pem</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldapadd  -Y   EXTERNAL  -H  ldapi:///   -f    certinfo.ldif</span><br></pre></td></tr></table></figure><ul><li>增添配置文件，这是客户端需要连接 ldap 服务器使用的配置。可以忽略。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/ldap.conf</span><br><span class="line">BASE       dc=example,dc=top                                                      # LDAP服务的基础DN</span><br><span class="line">[[URI]] ldap://localhost:389 ldaps://localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用</span><br><span class="line">[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制</span><br><span class="line">[[TIMELIMIT]]  15                                                                     # 最长搜索时间</span><br><span class="line">[[DEREF]]              never                                                            # 指定对别名的处理方式</span><br><span class="line"># TLS certificates (needed for GnuTLS)</span><br><span class="line">TLS_CACERT  /etc/ssl/certs/ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径，必需</span><br><span class="line">TLS_REQCERT allow                                                      # &quot;demand&quot;，表示需要验证服务器的证书</span><br></pre></td></tr></table></figure></li><li>启用 ldaps，重启 slapd<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/default/slapd</span><br><span class="line">SLAPD_SERVICES=&quot;ldap:/// ldapi:/// ldaps:///&quot;</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-5-使用-nextcloud-测试加密连接"><a href="#5-5-使用-nextcloud-测试加密连接" class="headerlink" title="5.5 使用 nextcloud 测试加密连接"></a>5.5 使用 nextcloud 测试加密连接</h3><ul><li><p>docker 安装 nexcloud，登录 UI ，右上角点击账户，选择应用</p></li><li><p>应用捆绑包，启用 LDAP user and group backend</p></li><li><p>设置连接</p></li><li><p>ldaps连接(严格一致才是tls加密，nextcloud应该只信任权威证书)</p></li><li><p>明文传输</p></li></ul><h3 id="5-6-stunnel-加密传输两个应用的数据-例：phpldapadmin"><a href="#5-6-stunnel-加密传输两个应用的数据-例：phpldapadmin" class="headerlink" title="5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)"></a>5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)</h3><p>链路： ldap user ui  —- stunnel client  accept  —-  stunnel client connect  —- stunnel server accept  —- stunnel server connect —-ldap server port</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt install -y stunnel4</span><br><span class="line">vim /etc/default/stunnel4</span><br><span class="line">ENABLED=1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># stunnel 服务端</span><br><span class="line">cert = /etc/stunnel/stunnel.pem</span><br><span class="line">key = /etc/stunnel/stunnel-key.pem</span><br><span class="line">verify = 3</span><br><span class="line">client = no</span><br><span class="line">debug = 6</span><br><span class="line">pid = /var/run/stunnel4/stunnel4.pid</span><br><span class="line"></span><br><span class="line">[ldap]</span><br><span class="line">accept = 10.13.3.106:6360                # 监听 stunnel 服务的流量，客户端（是指stunnel 客户端）将连接此目标并发送流量到这里</span><br><span class="line">connect = 10.13.3.106:389                # 转发到 stunnel 加密连接的服务的端口</span><br><span class="line">CAfile = /etc/stunnel/stunnel.pem</span><br><span class="line"></span><br><span class="line"># stunnel 客户端</span><br><span class="line">cert = /etc/stunnel/stunnel.pem</span><br><span class="line">key = /etc/stunnel/stunnel-key.pem</span><br><span class="line">verify = 3</span><br><span class="line">client = yes</span><br><span class="line">debug = 6</span><br><span class="line">setuid = stunnel4</span><br><span class="line">setgid = stunnel4</span><br><span class="line">pid = /var/run/stunnel4/stunnel4.pid</span><br><span class="line"></span><br><span class="line">[ldap]</span><br><span class="line">accept = 10.13.3.107:389                # 监听 stunnel 服务的流量，客户端（是指ldap的客户端）将连接此目标并发送流量到这里</span><br><span class="line">connect = 10.13.3.106:6360              # 加密连接并转发到 stunnel 的服务端</span><br><span class="line">CAfile = /etc/stunnel/stunnel.pem</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/phpldapadmin/config.php</span><br><span class="line">$servers-&gt;setValue(&#x27;server&#x27;,&#x27;host&#x27;,&#x27;69.87.216.102&#x27;);  # 指向 stunnel 客户端，和他本地监听的端口</span><br><span class="line">$servers-&gt;setValue(&#x27;server&#x27;,&#x27;port&#x27;,389);</span><br></pre></td></tr></table></figure><h2 id="六、-其他模块"><a href="#六、-其他模块" class="headerlink" title="六、 其他模块"></a>六、 其他模块</h2><h3 id="6-1-日志模块"><a href="#6-1-日志模块" class="headerlink" title="6.1 日志模块"></a>6.1 日志模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/loglevel.ldif</span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcLogLevel</span><br><span class="line">olcLogLevel: stats</span><br><span class="line"></span><br><span class="line">ldapmodify  -Y  EXTERNAL  -H  ldapi:///  -f  loglevel.ldif               # 日志在/var/log/syslog | grep slapd , 比默认的级别详细</span><br></pre></td></tr></table></figure><h3 id="6-2-memberOf-开启"><a href="#6-2-memberOf-开启" class="headerlink" title="6.2 memberOf 开启"></a>6.2 memberOf 开启</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/refint.ldif</span><br><span class="line"># enable_refint.ldif</span><br><span class="line">dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcModuleLoad</span><br><span class="line">olcModuleLoad: refint.la</span><br><span class="line">-</span><br><span class="line">dn: olcOverlay=refint,olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcRefintConfig</span><br><span class="line">olcOverlay: refint</span><br><span class="line"></span><br><span class="line">ldapadd -Q -Y EXTERNAL -H ldapi:// -f refint.ldif</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/etc/ldap/memberof.ldif</span><br><span class="line">dn: cn=module,cn=config</span><br><span class="line">changetype: add</span><br><span class="line">cn: module</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">olcModulePath: /usr/lib/ldap</span><br><span class="line"></span><br><span class="line">dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcModuleLoad</span><br><span class="line">olcModuleLoad: memberof.la</span><br><span class="line"></span><br><span class="line">dn: olcOverlay=memberof,olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: olcConfig</span><br><span class="line">objectClass: olcMemberOf</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: top</span><br><span class="line">olcOverlay: memberof</span><br><span class="line">olcMemberOfDangling: ignore</span><br><span class="line">olcMemberOfRefInt: TRUE</span><br><span class="line">olcMemberOfGroupOC: groupOfNames</span><br><span class="line">olcMemberOfMemberAD: member</span><br><span class="line">olcMemberOfMemberOfAD: memberOf</span><br><span class="line"></span><br><span class="line">ldapmodify -Y EXTERNAL -H ldapi:/// -f memberof.ldif</span><br></pre></td></tr></table></figure><ul><li>为条目添加此属性：LDIF文件中先创建用户的dn，然后创建目标组的dn，在创建组的时候将关联的用户写在member属性中</li></ul><h3 id="6-3-Self-Service-Password-自助密码管理"><a href="#6-3-Self-Service-Password-自助密码管理" class="headerlink" title="6.3 Self Service Password 自助密码管理"></a>6.3 Self Service Password 自助密码管理</h3><ul><li>容器部署，解决 php 依赖准备繁琐</li><li>镜像 ltbproject&#x2F;self-service-password:1.5.3</li><li>为 admin 用户设置修改密码的权限<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下列权限可以使得 &quot;admin,example,net&quot; 对这个域 &quot;dc=example,dc=tech&quot; 做用户添加、属性修改</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange by dn=&quot;cn=admin,dc=example,dc=net&quot; write by anonymous auth by self write by * none</span><br><span class="line">olcAccess: &#123;1&#125;to dn.subtree=&quot;dc=example,dc=tech&quot; by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write</span><br></pre></td></tr></table></figure></li><li>需要对企业邮箱帐号开启设置-帐号与安全-客户端设置-客户端授权密码</li><li>ssp.conf.php  成功配置版本，并映射到容器： &#x2F;home&#x2F;example&#x2F;sspasswd&#x2F;conf.php:&#x2F;var&#x2F;www&#x2F;conf&#x2F;config.inc.local.php<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$debug</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$keyphrase</span> = <span class="string">&quot;example&quot;</span>;</span><br><span class="line"><span class="variable">$use_sms</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$use_questions</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$lang</span> = <span class="string">&quot;cn,zh-CN&quot;</span>;</span><br><span class="line"><span class="variable">$use_change</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">#$reset_url = $_SERVER[&#x27;HTTP_X_FORWARDED_PROTO&#x27;] . &quot;://&quot; . $_SERVER[&#x27;HTTP_X_FORWARDED_HOST&#x27;] . $_SERVER[&#x27;SCRIPT_NAME&#x27;];</span></span><br><span class="line"><span class="variable">$reset_url</span> = <span class="string">&quot;https://ssp.example.net&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_HOST&#x27;</span>] . <span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>];</span><br><span class="line"><span class="variable">$show_menu</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$logo</span> = <span class="string">&quot;images/logo.png&quot;</span>;                <span class="comment"># 这两项在配置前，需要确保图片映射路径在容器内部的 /var/www/html/images 下</span></span><br><span class="line"><span class="variable">$background_image</span> = <span class="string">&quot;images/back.png&quot;</span>;</span><br><span class="line"><span class="variable">$default_action</span> = <span class="string">&quot;sendtoken&quot;</span>;        <span class="comment"># 默认展示在首页的修改密码的方式</span></span><br><span class="line"><span class="variable">$show_menu</span> = <span class="literal">false</span>;              <span class="comment"># 关闭顶部的修改方式选择菜单</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LDAP</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ldap_url</span> = <span class="string">&quot;ldap://10.13.3.107/&quot;</span>;</span><br><span class="line"><span class="variable">$ldap_starttls</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$ldap_binddn</span> = <span class="string">&quot;cn=admin,dc=example,dc=net&quot;</span>;</span><br><span class="line"><span class="variable">$ldap_bindpw</span> = <span class="string">&#x27;example@2020&#x27;</span>;</span><br><span class="line"><span class="comment">#$ldap_bindpw = &quot;&#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi&quot;;</span></span><br><span class="line"><span class="variable">$ldap_base</span> = <span class="string">&quot;dc=example,dc=net&quot;</span>;</span><br><span class="line"><span class="comment">#$ldap_base = &quot;dc=example,dc=tech&quot;;    # 在这里同时书写两个，只会生效后一个域, 使用两个实例连接 ldap 服务</span></span><br><span class="line"><span class="variable">$ldap_fullname_attribute</span> = <span class="string">&quot;cn&quot;</span>;</span><br><span class="line"><span class="variable">$ldap_filter</span> = <span class="string">&quot;(&amp;(objectClass=inetOrgPerson)(<span class="subst">$ldap_fullname_attribute</span>=&#123;login&#125;))&quot;</span>;</span><br><span class="line"><span class="variable">$ldap_use_exop_passwd</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$ldap_use_ppolicy_control</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$TLS_REQCERT</span> = <span class="string">&quot;allow&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># email</span></span><br><span class="line"><span class="variable">$mail_attributes</span> = <span class="keyword">array</span>(<span class="string">&quot;mail&quot;</span>, <span class="string">&quot;gosaMailAlternateAddress&quot;</span>, <span class="string">&quot;proxyAddresses&quot;</span>);</span><br><span class="line"><span class="variable">$mail_address_use_ldap</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$mail_from</span> = <span class="string">&quot;user5@example.net&quot;</span>;</span><br><span class="line"><span class="variable">$mail_from_name</span> = <span class="string">&quot;密码自主修改服务&quot;</span>;</span><br><span class="line"><span class="variable">$mail_signature</span> = <span class="string">&quot;如有疑问,请联系运维同事,英博智云.&quot;</span>;</span><br><span class="line"><span class="variable">$notify_on_change</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$mail_protocol</span> = <span class="string">&#x27;smtp&#x27;</span>;</span><br><span class="line"><span class="variable">$mail_smtp_host</span> = <span class="string">&#x27;smtphz.qiye.163.com&#x27;</span>;</span><br><span class="line"><span class="variable">$mail_smtp_auth</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$mail_smtp_user</span> = <span class="string">&quot;user5@example.net&quot;</span>;</span><br><span class="line"><span class="variable">$mail_smtp_pass</span> = <span class="string">&#x27;TdhYDdgvN7Hpky5a&#x27;</span>;</span><br><span class="line"><span class="variable">$mail_smtp_port</span> = <span class="number">465</span>;</span><br><span class="line"><span class="variable">$mail_smtp_timeout</span> = <span class="number">30</span>;</span><br><span class="line"><span class="variable">$mail_smtp_keepalive</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$mail_smtp_secure</span> = <span class="string">&#x27;ssl&#x27;</span>;</span><br><span class="line"><span class="variable">$mail_smtp_autotls</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$mail_smtp_options</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$mail_contenttype</span> = <span class="string">&#x27;text/plain&#x27;</span>;</span><br><span class="line"><span class="variable">$mail_wordwrap</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$mail_charset</span> = <span class="string">&#x27;utf-8&#x27;</span>;</span><br><span class="line"><span class="variable">$mail_priority</span> = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># password policy</span></span><br><span class="line"><span class="variable">$hash</span> = <span class="string">&quot;SSHA&quot;</span>; <span class="comment"># 修改的用户密码传递过程中会采取这里指定的加密</span></span><br><span class="line"><span class="variable">$pwd_min_length</span> = <span class="number">8</span>;</span><br><span class="line"><span class="variable">$pwd_max_length</span> = <span class="number">20</span>;</span><br><span class="line"><span class="variable">$pwd_min_lower</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$pwd_min_upper</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$pwd_min_digit</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$pwd_min_special</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$pwd_special_chars</span> = <span class="string">&quot;^a-zA-Z0-9&quot;</span>;</span><br><span class="line"><span class="variable">$pwd_complexity</span> = <span class="number">4</span>;</span><br><span class="line"><span class="variable">$pwd_no_reuse</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$pwd_forbidden_words</span> = <span class="keyword">array</span>(<span class="string">&quot;example&quot;</span>, <span class="string">&quot;example&quot;</span>, <span class="string">&quot;example&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line"><span class="variable">$pwd_show_policy_pos</span> = <span class="string">&quot;above&quot;</span>;</span><br><span class="line"><span class="variable">$pwd_show_policy</span> = <span class="string">&quot;onerror&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8000:80 \</span><br><span class="line">&gt; --restart=always \</span><br><span class="line">&gt; --name sspass \</span><br><span class="line">&gt; -v /home/example/sspasswd/conf.php:/var/www/conf/config.inc.local.php \</span><br><span class="line">&gt; -itd docker.io/ltbproject/self-service-password</span><br></pre></td></tr></table></figure><h4 id="6-3-1-不能进入修改链接-Token-is-not-valid"><a href="#6-3-1-不能进入修改链接-Token-is-not-valid" class="headerlink" title="6.3.1 不能进入修改链接 Token is not valid"></a>6.3.1 不能进入修改链接 Token is not valid</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">注释了这两项</span><br><span class="line">#$use_tokens = true;</span><br><span class="line">#$crypt_tokens = true;</span><br></pre></td></tr></table></figure><h4 id="6-3-2-反向代理-Self-Service-Password"><a href="#6-3-2-反向代理-Self-Service-Password" class="headerlink" title="6.3.2 反向代理 Self Service Password"></a>6.3.2 反向代理 Self Service Password</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">upstream ssp &#123;</span><br><span class="line">  server 10.13.3.108:8000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name ssp.example.net;</span><br><span class="line">    return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl ;</span><br><span class="line">    server_name ssp.example.net;</span><br><span class="line">    ssl_certificate webmin/tls_ca.pem;</span><br><span class="line">    ssl_certificate_key webmin/tls_key.pem;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">      proxy_pass http://ssp;</span><br><span class="line">      proxy_set_header Host $host;</span><br><span class="line">      proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">      proxy_set_header X-Forwarded-Proto &quot;https&quot;;</span><br><span class="line">      proxy_read_timeout 1800s;</span><br><span class="line">      proxy_http_version 1.1;</span><br><span class="line">      proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">      proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-4-LDAP-对目录信息的数据做备份还原和迁移"><a href="#6-4-LDAP-对目录信息的数据做备份还原和迁移" class="headerlink" title="6.4 LDAP 对目录信息的数据做备份还原和迁移"></a>6.4 LDAP 对目录信息的数据做备份还原和迁移</h3><h4 id="6-4-1-备份"><a href="#6-4-1-备份" class="headerlink" title="6.4.1 备份"></a>6.4.1 备份</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo slapcat -n 3 -l ./back3.ldif           # -n 指定数据库编号，数字对应各个dit的数据库编号( 配置数据库----olcDatabase=&#123;0&#125;config.ldif; 目录信息数据库----olcDatabase=&#123;1&#125;mdb.ldif )</span><br></pre></td></tr></table></figure><h4 id="6-4-2-恢复"><a href="#6-4-2-恢复" class="headerlink" title="6.4.2 恢复"></a>6.4.2 恢复</h4><p>原服务器上恢复，服务需要暂停</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop slapd</span><br></pre></td></tr></table></figure><p>配置目录一般位于 <code>/etc/openldap/slapd.d</code>，将原有配置删除，然后使用 <code>slapadd</code> 导入新的配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf /etc/ldap/slapd.d/*</span><br><span class="line">$ slapadd  -n  0  -F  /etc/ldap/slapd.d  -l  ./config.2021-09-18.ldif</span><br><span class="line">$ chown -R openldap:openldap /etc/ldap/slapd.d</span><br></pre></td></tr></table></figure><p>数据目录一般位于 <code>/var/lib/ldap-*</code>，模拟时，将原有数据删除，然后使用 <code>slapadd</code> 导入新的数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rm  -rf  /var/lib/ldap-example/*         # 定制了不同的$default_action = &quot;sendtoken&quot;;</span><br><span class="line">$show_menu = false;dit有不同的目录分别存储不同domain的内容，注意，导入前目录必需首先存在，且权属 openldap:openldap。</span><br><span class="line">$ slapadd -n 1 -F /etc/openldap/slapd.d -l ./data.2021-09-18.ldif</span><br><span class="line">$ chown -R openldap:openldap  /var/lib/ldap-example</span><br><span class="line">$ systemctl start slapd</span><br></pre></td></tr></table></figure><h4 id="6-4-3-openldap的迁移"><a href="#6-4-3-openldap的迁移" class="headerlink" title="6.4.3 openldap的迁移"></a>6.4.3 openldap的迁移</h4><p>playbook 新建的服务器，执行恢复</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slapadd -n 1 -F /etc/openldap/slapd.d -l ./data.2021-09-18.ldif</span><br><span class="line"></span><br><span class="line">[[如果导入失败，或者数据已存在，删除rm]] -rf /var/lib/ldap/*  重新导入</span><br></pre></td></tr></table></figure><h2 id="七、-命令资料"><a href="#七、-命令资料" class="headerlink" title="七、 命令资料"></a>七、 命令资料</h2><blockquote><p><a href="https://blog.csdn.net/jenyzhang/article/details/56487627">来自此处</a><br>ldap<br>    |-slapd             目录服务的主要程序<br>    |-slurpd           目录服务进行复制的程序<br>    |-slapadd           向目录中添加数据<br>    |-slapcat           把目录中的条目导出成ldif文件<br>    |-slapindex         重建目录的索引<br>    |-ldapcompare       对目录的条目的属性进行比较<br>    |-ldapadd           向目录服务中添加条目<br>    |-ldapdelete        删除目录中的条目<br>    |-ldapmodify        更新目录中条目的值<br>    |-ldapmodrdn        更改条目的DN<br>    |-ldappasswd        更改条目的密码<br>    |-ldapsearch        对目录进行查询</p></blockquote><blockquote><p>ldapadd<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -h   目录服务的地址<br>      -w   绑定DN的密码<br>      -f   使用ldif文件进行条目添加的文件        </p></blockquote><ul><li>例子<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -f &#x2F;root&#x2F;test.ldif<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret (这样写就是在命令行添加条目)</li></ul><p>       </p><blockquote><p>ldapsearch<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -w   绑定DN的密码<br>      -b   指定要查询的根节点<br>      -H   制定要查询的服务器<br>      -s   指定搜索范围的类型     </p></blockquote><ul><li>例子<br>   ldapsearch -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -b “dc&#x3D;starxing,dc&#x3D;com”<br>       使用简单认证，用 “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” 进行绑定，<br>       要查询的根是 “dc&#x3D;starxing,dc&#x3D;com”。这样会把绑定的用户能访问”dc&#x3D;starxing,dc&#x3D;com”下的所有数据显示出来。<br> ldapsearch -x -W -D “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -b “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -h troy.osdn.zzti.edu.cn<br>   ldapsearch -b “dc&#x3D;canon-is,dc&#x3D;jp” -H ldaps:&#x2F;&#x2F;192.168.0.92:636<br> (需要修改openldap客户端的配置文件ldap.conf,参考：<a href="http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm">http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm</a>)</li></ul><blockquote><p>ldapdelete <br>      ldapdelete -x -D “cn&#x3D;Manager,dc&#x3D;test,dc&#x3D;com” -w secret “uid&#x3D;test1,ou&#x3D;People,dc&#x3D;test,dc&#x3D;com”<br>      ldapdelete -x -D ‘cn&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secert ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’<br>      这样就可以删除’uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’记录了，应该注意一点，其下有子条目的不能删除  </p></blockquote><ul><li><p>例子1  递归删除所有：<br>ldapdelete -x -D ‘cn&#x3D;administrator,dc&#x3D;example,dc&#x3D;net’ -w example@2020 -r “ou&#x3D;example,dc&#x3D;example,dc&#x3D;net”</p></li><li><p>例子2  删除一个acl策略。acl-dele.ldif<br> dn: olcDatabase&#x3D;{3}mdb,cn&#x3D;config<br> delete: olcAccess<br> olcAccess: {2}<br> olcAccess: {3}<br> olcAccess: {4}<br> ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f acl-dele.ldif</p></li></ul><blockquote><p>ldappasswd<br>    -x   进行简单认证<br>    -D   用来绑定服务器的DN<br>    -w   绑定DN的密码<br>    -S   提示的输入密码<br>    -s pass 把密码设置为pass<br>    -a pass 设置old passwd为pass<br>    -A   提示的设置old passwd<br>    -H   是指要绑定的服务器<br>    -I   使用sasl会话方式      </p></blockquote><ul><li>例子<br>    ldappasswd -x -D ‘cm&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secret ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’ -S<br>       New password:<br>       Re-enter new password:<br>       就可以更改密码了，如果原来记录中没有密码，将会自动生成一个userPassword。</li></ul><p>    </p><blockquote><p>ldapmodify<br>     -a 添加新的条目.缺省的是修改存在的条目.<br>     -C 自动追踪引用.<br>     -c 出错后继续执行程序并不中止.缺省情况下出错的立即停止.比如如果你的ldif 文件内的某个条目在<a href="http://lib.csdn.net/base/mysql" title="MySQL知识库">数据库</a>内并不存在,缺省情况下程序立即退出,但如果使用了该参数,程序忽略该错误继续执行.<br>     -n 用于调试到服务器的通讯.但并不实际执行搜索.服务器关闭时,返回错误；服务器<br>       打开时,常和-v 参数一起<a href="http://lib.csdn.net/base/softwaretest" title="软件测试知识库">测试</a>到服务器是否是一条通路.<br>     -v 运行在详细模块.在标准输出中打出一些比较详细的信息.比如:连接到服务器的<br>       ip 地址和端口号等.<br>     -M  打开 manage DSA IT 控制. -MM 把该控制设置为重要的.<br>     -f file 从文件内读取条目的修改信息而不是从标准输入读取.<br>    -x 使用简单认证.<br>    -D binddn 指定搜索的用户名(一般为一dn 值).<br>    -W 指定了该参数,系统将弹出一提示入用户的密码.它和-w 参数相对使用.<br>    -w bindpasswd 直接指定用户的密码. 它和-W 参数相对使用.<br>    -H ldapuri 指定连接到服务器uri(ip 地址和端口号,常见格式为 ldap:&#x2F;&#x2F;hostname:port ).如果使用了-H 就不能使用-h 和-p 参数.<br>    -h ldaphost 指定要连接的主机的名称&#x2F;ip 地址.它和-p 一起使用<br>    -p ldapport 指定要连接目录服务器的端口号.它和-h 一起使用，如果使用了-h 和-p 参数就不能使用-H 参数.<br>    -Z 使用StartTLS 扩展操作.如果使用-ZZ,命令强制使用StartTLS 握手成功.<br>    -V 启用证书认证功能,目录服务器使用客户端证书进行身份验证,必须与-ZZ 强制启用<br>       TLS 方式配合使用,并且匿名绑定到目录服务器.<br>    -e 设置客户端证书文件,例: -e cert&#x2F;client.crt<br>    -E 设置客户端证书私钥文件,例: -E cert&#x2F;client.key  </p></blockquote><ul><li>例子<br>ldapmodify -x -D “cn&#x3D;root,dc&#x3D;it,dc&#x3D;com” -W -f modify.ldif    #   将modify.ldif中的记录更新原有的记录。</li></ul><h2 id="八、-参考链接"><a href="#八、-参考链接" class="headerlink" title="八、 参考链接"></a>八、 参考链接</h2><p><a href="https://github.com/jt6562/LDAP-read-notes/blob/master/ldap-guide/OpenLDAP%E7%AE%A1%E7%90%86%E5%91%98%E6%89%8B%E5%86%8C.md">指南</a><br><a href="https://www.cnblogs.com/kevingrace/p/5773974.html">知识总结</a><br><a href="https://www.cnblogs.com/js1314/p/12887893.html">参考1</a><br><a href="https://cloud.tencent.com/developer/article/1932586">参考2</a><br><a href="https://blog.csdn.net/u011607971/article/details/121126289?spm=1001.2014.3001.5501#t3">参考3</a><br><a href="https://ubuntu.com/server/docs/service-ldap-with-tls">Ubuntu wiki</a><br><a href="https://www.cnblogs.com/shu-sheng/p/14450815.html">tls参考1</a><br><a href="https://hmli.ustc.edu.cn/doc/linux/ubuntu-ldap/ubuntu-ldap.html#id14">tls参考2</a><br><a href="https://zhuanlan.zhihu.com/p/643010354">tls参考3</a></p><h2 id="九、问题："><a href="#九、问题：" class="headerlink" title="九、问题："></a>九、问题：</h2><h3 id="9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果"><a href="#9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果" class="headerlink" title="9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果"></a>9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果</h3><h3 id="9-2-日志功能开启失败"><a href="#9-2-日志功能开启失败" class="headerlink" title="9.2 日志功能开启失败"></a>9.2 日志功能开启失败</h3><pre><code>已经调整日志级别，在系统日志中查看并grep</code></pre><h3 id="9-3-证书缺失-只能使用ldap01-这个信息查询）"><a href="#9-3-证书缺失-只能使用ldap01-这个信息查询）" class="headerlink" title="9.3 证书缺失(只能使用ldap01,这个信息查询）"></a>9.3 证书缺失(只能使用ldap01,这个信息查询）</h3><pre><code>采取使用权威证书</code></pre><h3 id="9-4-重启slap报错-tls-init-failed"><a href="#9-4-重启slap报错-tls-init-failed" class="headerlink" title="9.4 重启slap报错 tls init   failed"></a>9.4 重启slap报错 tls init   failed</h3><pre><code>解决办法：重新生成证书</code></pre><h3 id="9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code"><a href="#9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code" class="headerlink" title="9.5 报错 ldap_start_tls: Connect error (-11)    \n    additional info: (unknown error code)"></a>9.5 报错 ldap_start_tls: Connect error (-11)    \n    additional info: (unknown error code)</h3><pre><code>可能是由于服务器证书的通用名（Common Name）字段是否与主机名不一致，请检查主机名和服务器证书</code></pre><h3 id="9-6-连接问题"><a href="#9-6-连接问题" class="headerlink" title="9.6 连接问题"></a>9.6 连接问题</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldaps://ldap.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W            # 在服务器本机执行此查询的报错。但是在另一个机器可以成功查询</span><br><span class="line">ldap_sasl_bind(SIMPLE): Can&#x27;t contact LDAP server (-1)                                 # 配置 ldap.conf 之后成功解决并有输出 tls=demand/allow----作用是证书检查</span><br></pre></td></tr></table></figure><h3 id="9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”"><a href="#9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”" class="headerlink" title="9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”"></a>9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 首先尝试重新部署，发现执行镜像复制的剧本之前可以正常创建所有的条目</span><br><span class="line">    解决：在mirror mode 开启时，需要指定相应的数据库</span><br><span class="line">2.  shadow context; no update referral  根本原因是需要检查权限</span><br></pre></td></tr></table></figure><h3 id="9-8-使用的脚本一致，测试环境和生产环境结果不一致-主要是不能长时间正常保持客户端连接并查询"><a href="#9-8-使用的脚本一致，测试环境和生产环境结果不一致-主要是不能长时间正常保持客户端连接并查询" class="headerlink" title="9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询"></a>9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询</h3><ul><li>脚本中的组织信息ldif文件有问题，经测试不影响。</li><li>memberOf，属性不可单独添加，通过 groupofNames 指定 member 之后会自动关联。已经修正使用方式，结果未改变。</li><li>2204 系统和 2004 系统的slapd版本不一致（并没有影响）。</li><li>将orgnization的任务和前一部分拆分，否则会出现读取不到 rootdn（手动测试是成功的）（然而脚本中修改后并没有解决这个问题）。</li><li>将organization拆分，在此之前重启服务，未解决。</li><li>将organization拆分，在此之前先重启虚拟机。（有效、怀疑是服务中某些连接的状态在ansible执行中没有更新）（仍然失效了，经过一夜之后失效）。</li><li>另一台2204主机安装正常使用，怀疑虚拟机系统问题。</li></ul><h2 id="十、-验证"><a href="#十、-验证" class="headerlink" title="十、 验证"></a>十、 验证</h2><h3 id="10-1-检测连接命令："><a href="#10-1-检测连接命令：" class="headerlink" title="10.1 检测连接命令："></a>10.1 检测连接命令：</h3><p> ldaps:&#x2F;&#x2F;    —-ldap over ssl  使用636 ，从连接开始加密   ;        ldap:&#x2F;&#x2F;           —ldap_start_tls(-ZZ参数):    使用389，从传输开始加密</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldaps://ldap01.example.top:636 -D &quot;cn=admin,dc=example,dc=top&quot; -W -b &quot;dc=example,dc=top&quot; -s sub &quot;(objectClass=person)&quot;</span><br><span class="line"></span><br><span class="line">ldapsearch -H ldap://10.13.3.106  -D &quot;cn=admin,dc=example,dc=top&quot; -W -b &quot;dc=example,dc=top&quot; -s sub &quot;(objectClass=person)&quot;</span><br><span class="line"></span><br><span class="line">ldapsearch -H ldap://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W -b &quot;dc=example,dc=top&quot; -s sub &quot;(objectClass=person)&quot;</span><br></pre></td></tr></table></figure><h3 id="10-2-验证和日志"><a href="#10-2-验证和日志" class="headerlink" title="10.2 验证和日志"></a>10.2 验证和日志</h3><p>tag 101 应表明在查询; tag 97 是在认证</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldap://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W   -ZZ      #  启用了tls功能 ，-ZZ 参数，仍然是 389 端口，连接后在传输过程中加密</span><br><span class="line"></span><br><span class="line">Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 fd=14 ACCEPT from IP=10.13.3.107:60674 (IP=0.0.0.0:389)</span><br><span class="line">Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 EXT oid=1.3.6.1.4.1.1466.20037</span><br><span class="line">Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 STARTTLS</span><br><span class="line">Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 op=0 RESULT oid= err=0 text=</span><br><span class="line">Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn=1240 fd=14 TLS established tls_ssf=256 ssf=256</span><br><span class="line">Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; method=128</span><br><span class="line">Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; mech=SIMPLE ssf=0</span><br><span class="line">Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=1 RESULT tag=97 err=0 text=</span><br><span class="line">Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=2 SRCH base=&quot;dc=example,dc=top&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=2 SEARCH RESULT tag=101 err=0 nentries=6 text=</span><br><span class="line">Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 op=3 UNBIND</span><br><span class="line">Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn=1240 fd=14 closed</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldap://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W        # 明文传输</span><br><span class="line"></span><br><span class="line">Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 fd=14 ACCEPT from IP=10.13.3.107:37760 (IP=0.0.0.0:389)</span><br><span class="line">Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; method=128</span><br><span class="line">Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; mech=SIMPLE ssf=0</span><br><span class="line">Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=0 RESULT tag=97 err=0 text=</span><br><span class="line">Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=1 SRCH base=&quot;dc=example,dc=top&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=1 SEARCH RESULT tag=101 err=0 nentries=6 text=</span><br><span class="line">Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 op=2 UNBIND</span><br><span class="line">Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn=1246 fd=14 closed</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldaps://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W        # 从连接就开始加密</span><br><span class="line"></span><br><span class="line">Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 ACCEPT from IP=10.13.3.107:58726 (IP=0.0.0.0:636)</span><br><span class="line">Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 TLS established tls_ssf=256 ssf=256</span><br><span class="line">Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; method=128</span><br><span class="line">Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 BIND dn=&quot;cn=admin,dc=example,dc=top&quot; mech=SIMPLE ssf=0</span><br><span class="line">Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=0 RESULT tag=97 err=0 text=</span><br><span class="line">Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=1 SRCH base=&quot;dc=example,dc=top&quot; scope=2 deref=0 filter=&quot;(objectClass=*)&quot;</span><br><span class="line">Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=1 SEARCH RESULT tag=101 err=0 nentries=6 text=</span><br><span class="line">Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 op=2 UNBIND</span><br><span class="line">Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn=1247 fd=14 closed</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldaps://ldap01.example.top  -D &quot;cn=admin,dc=example,dc=top&quot; -W -ZZ</span><br><span class="line">ldap_start_tls: Operations error (1)</span><br><span class="line">        additional info: TLS already started</span><br><span class="line"></span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 ACCEPT from IP=10.13.3.107:39894 (IP=0.0.0.0:636)</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 TLS established tls_ssf=256 ssf=256</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 EXT oid=1.3.6.1.4.1.1466.20037</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 STARTTLS</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=0 RESULT oid= err=1 text=TLS already started                # 证明二者冲突，不能同时开启</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 op=1 UNBIND</span><br><span class="line">Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn=1248 fd=14 closed</span><br></pre></td></tr></table></figure><h2 id="十一、应用服务"><a href="#十一、应用服务" class="headerlink" title="十一、应用服务"></a>十一、应用服务</h2><h3 id="11-1-建立-ldap-管理-只读帐号"><a href="#11-1-建立-ldap-管理-只读帐号" class="headerlink" title="11.1 建立 ldap 管理&#x2F;只读帐号"></a>11.1 建立 ldap 管理&#x2F;只读帐号</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=admin,dc=xxx,dc=xx </span><br><span class="line">changetype: add  </span><br><span class="line">objectClass: simpleSecurityObject  </span><br><span class="line">objectClass: organizationalRole  </span><br><span class="line">cn: admin  </span><br><span class="line">userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi  </span><br><span class="line">  </span><br><span class="line">-  </span><br><span class="line">dn: cn=reader,dc=xxx2,dc=xx2  </span><br><span class="line">changetype: add  </span><br><span class="line">objectClass: simpleSecurityObject  </span><br><span class="line">objectClass: organizationalRole  </span><br><span class="line">cn: admin  </span><br><span class="line">userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi</span><br></pre></td></tr></table></figure><h3 id="11-2-详细的公司架构-ldif"><a href="#11-2-详细的公司架构-ldif" class="headerlink" title="11.2 详细的公司架构 ldif"></a>11.2 详细的公司架构 ldif</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">dn: ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: organizationalUnit  </span><br><span class="line">ou: example  </span><br><span class="line">  </span><br><span class="line">dn: ou=example-bod,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: organizationalUnit  </span><br><span class="line">ou: example-bod  </span><br><span class="line">  </span><br><span class="line">dn: cn=user1,ou=example-bod,ou=example,dc=example,dc=net  </span><br><span class="line">cn: user1  </span><br><span class="line">departmentnumber: 1  </span><br><span class="line">displayname: Zheng Yu  </span><br><span class="line">mail: user1@example.net  </span><br><span class="line">objectclass: inetOrgPerson  </span><br><span class="line">sn: Zheng  </span><br><span class="line">title: President  </span><br><span class="line">uid: 10000  </span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  </span><br><span class="line">  </span><br><span class="line">dn: cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net  </span><br><span class="line">cn: example-bod-admin  </span><br><span class="line">member: cn=user1,ou=example-bod,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: groupOfNames  </span><br><span class="line">  </span><br><span class="line">dn: ou=example-bus,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: organizationalUnit  </span><br><span class="line">ou: example-bus  </span><br><span class="line">  </span><br><span class="line">dn: cn=user8,ou=example-bus,ou=example,dc=example,dc=net  </span><br><span class="line">cn: user8  </span><br><span class="line">departmentnumber: 2  </span><br><span class="line">displayname: Sun Minghong  </span><br><span class="line">mail: user8@example.net  </span><br><span class="line">objectclass: inetOrgPerson  </span><br><span class="line">sn: Sun  </span><br><span class="line">title: Financial Manager  </span><br><span class="line">uid: 10001  </span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  </span><br><span class="line">  </span><br><span class="line">dn: cn=example-bus-admin,ou=example-bus,ou=example,dc=example,dc=net  </span><br><span class="line">cn: example-bus-admin  </span><br><span class="line">member: cn=user8,ou=example-bus,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: groupOfNames  </span><br><span class="line">  </span><br><span class="line">dn: ou=example-sys,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: organizationalUnit  </span><br><span class="line">ou: example-sys  </span><br><span class="line">  </span><br><span class="line">dn: cn=user2,ou=example-sys,ou=example,dc=example,dc=net  </span><br><span class="line">cn: user2  </span><br><span class="line">departmentnumber: 3  </span><br><span class="line">displayname: Xie Jian  </span><br><span class="line">mail: user2@example.net  </span><br><span class="line">objectclass: inetOrgPerson  </span><br><span class="line">sn: Xie  </span><br><span class="line">title: Senior Systems Engineer  </span><br><span class="line">uid: 10002  </span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  </span><br><span class="line">  </span><br><span class="line">dn: cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net  </span><br><span class="line">cn: example-sys-admin  </span><br><span class="line">member: cn=user2,ou=example-sys,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: groupOfNames  </span><br><span class="line">  </span><br><span class="line">dn: cn=user5,ou=example-sys,ou=example,dc=example,dc=net  </span><br><span class="line">cn: user5  </span><br><span class="line">departmentnumber: 3  </span><br><span class="line">displayname: Long Chao  </span><br><span class="line">mail: user5@example.net  </span><br><span class="line">objectclass: inetOrgPerson  </span><br><span class="line">sn: Long  </span><br><span class="line">title: System Engineer  </span><br><span class="line">uid: 10003  </span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  </span><br><span class="line">  </span><br><span class="line">dn: cn=example-sys-junior,ou=example-sys,ou=example,dc=example,dc=net  </span><br><span class="line">cn: example-sys-junior  </span><br><span class="line">member: cn=user5,ou=example-sys,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: groupOfNames  </span><br><span class="line">  </span><br><span class="line">dn: ou=example-ops,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: organizationalUnit  </span><br><span class="line">ou: example-ops  </span><br><span class="line">  </span><br><span class="line">dn: cn=user6.tang,ou=example-ops,ou=example,dc=example,dc=net  </span><br><span class="line">cn: user6.tang  </span><br><span class="line">departmentnumber: 4  </span><br><span class="line">displayname: Tang Binchao  </span><br><span class="line">mail: user6.tang@example.net  </span><br><span class="line">objectclass: inetOrgPerson  </span><br><span class="line">sn: Tang  </span><br><span class="line">title: System Engineer  </span><br><span class="line">uid: 10004  </span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  </span><br><span class="line">  </span><br><span class="line">dn: cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net  </span><br><span class="line">cn: example-ops-admin  </span><br><span class="line">member: cn=user6.tang,ou=example-ops,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: groupOfNames  </span><br><span class="line">  </span><br><span class="line">dn: ou=example-dev,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: organizationalUnit  </span><br><span class="line">ou: example-dev  </span><br><span class="line">  </span><br><span class="line">dn: cn=user3,ou=example-dev,ou=example,dc=example,dc=net  </span><br><span class="line">cn: user3  </span><br><span class="line">departmentnumber: 5  </span><br><span class="line">displayname: Chen Cheng  </span><br><span class="line">mail: user3@example.net  </span><br><span class="line">objectclass: inetOrgPerson  </span><br><span class="line">sn: Chen  </span><br><span class="line">title: Senior Development Engineer  </span><br><span class="line">uid: 10005  </span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  </span><br><span class="line">  </span><br><span class="line">dn: cn=example-dev-admin,ou=example-dev,ou=example,dc=example,dc=net  </span><br><span class="line">cn: example-dev-admin  </span><br><span class="line">member: cn=user3,ou=example-dev,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: groupOfNames  </span><br><span class="line">  </span><br><span class="line">dn: cn=user4.li,ou=example-dev,ou=example,dc=example,dc=net  </span><br><span class="line">cn: user4.li  </span><br><span class="line">departmentnumber: 5  </span><br><span class="line">displayname: Li user4  </span><br><span class="line">mail: user4.li@example.net  </span><br><span class="line">objectclass: inetOrgPerson  </span><br><span class="line">sn: Li  </span><br><span class="line">title: Development Engineer  </span><br><span class="line">uid: 10006  </span><br><span class="line">userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs  </span><br><span class="line">  </span><br><span class="line">dn: cn=user7,ou=example-dev,ou=example,dc=example,dc=net  </span><br><span class="line">cn: user7  </span><br><span class="line">departmentnumber: 5  </span><br><span class="line">displayname: Luo Xujun  </span><br><span class="line">mail: user7@example.net  </span><br><span class="line">objectclass: inetOrgPerson  </span><br><span class="line">sn: Luo  </span><br><span class="line">title: Development Engineer  </span><br><span class="line">uid: 10007  </span><br><span class="line">userpassword: &#123;SSHA&#125;/2+Coei5Fje+th7mOJgu43Ms3hBia2Qu  </span><br><span class="line">  </span><br><span class="line">dn: cn=example-dev-senior,ou=example-dev,ou=example,dc=example,dc=net  </span><br><span class="line">cn: example-dev-senior  </span><br><span class="line">member: cn=user4.li,ou=example-dev,ou=example,dc=example,dc=net  </span><br><span class="line">member: cn=user7,ou=example-dev,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: groupOfNames  </span><br><span class="line">  </span><br><span class="line">dn: ou=example-rob,ou=example,dc=example,dc=net  </span><br><span class="line">objectclass: organizationalUnit  </span><br><span class="line">ou: example-rob</span><br></pre></td></tr></table></figure><h3 id="11-3-第一版-ACL"><a href="#11-3-第一版-ACL" class="headerlink" title="11.3 第一版 ACL"></a>11.3 第一版 ACL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;ou=example,dc=example,dc=net&quot; filter=&quot;(&amp;(objectClass=inetOrgPerson)(|(memberOf=cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net)(memberOf=cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net)(memberOf=cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net)))&quot; by dn.base=&quot;cn=exampleread,dc=ibexample,dc=com&quot; read</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;4&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write by dn.base=&quot;cn=exampleadmin,dc=example,dc=net&quot; write  by anonymous auth  by * none</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=ibexample,dc=com&quot; by dn.base=&quot;cn=exampleadmin,dc=example,dc=net&quot; write by dn.base=&quot;cn=exampleread,dc=ibexample,dc=com&quot; read</span><br></pre></td></tr></table></figure><h3 id="11-4-最终的acl（写两个域、读两个域、reader-example-可以读取某些admin组，实现映射到example域下集成的应用）"><a href="#11-4-最终的acl（写两个域、读两个域、reader-example-可以读取某些admin组，实现映射到example域下集成的应用）" class="headerlink" title="11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）"></a>11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）</h3><ul><li><p>添加</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=example,dc=net&quot; by dn.base=&quot;cn=exampleread,dc=example,dc=net&quot; read</span><br><span class="line">olcAccess: &#123;3&#125;to dn.subtree=&quot;dc=example,dc=net&quot; filter=&quot;(&amp;(objectClass=inetOrgPerson)(|(memberOf=cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net)(memberOf=cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net)(memberOf=cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net)))&quot; by dn.base=&quot;cn=exampleread,dc=ibexample,dc=com&quot; read</span><br><span class="line"> </span><br><span class="line">dn: olcDatabase=&#123;2&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write by dn.base=&quot;cn=exampleadmin,dc=example,dc=net&quot; write  by anonymous auth  by * none</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=ibexample,dc=com&quot; by dn.base=&quot;cn=exampleadmin,dc=example,dc=net&quot; write by dn.base=&quot;cn=exampleread,dc=ibexample,dc=com&quot; read by dn.base=&quot;cn=exampleread,dc=example,dc=net&quot; read</span><br></pre></td></tr></table></figure></li><li><p>删除</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">delete: olcAccess</span><br><span class="line">olcAccess: &#123;2&#125;to..........</span><br><span class="line">olcAccess: &#123;3&#125;to........</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">ldapmodify -Y EXTERNAL -H ldapi:/// -f acl-dele.ldif</span><br></pre></td></tr></table></figure></li><li><p>数据库内 ACL 顺序测试，{}里面是优先级，生效在前（涉及范围大的 ACL 应书写在前）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write by anonymous auth  by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write  by * none   </span><br><span class="line">olcAccess: &#123;1&#125;to attrs=shadowLastChange by self write by * read</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;cn=example-sys-admin,ou=example-sys,dc=example,dc=tech&quot; by dn.base=&quot;cn=reader,dc=example,dc=net&quot; read by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write    # 如果没有此条acl,该条目将不能在 lam 中被 admin 管理</span><br><span class="line"> olcAccess: &#123;3&#125;to dn.subtree=&quot;dc=example,dc=tech&quot; by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write      # 此条优先级最低</span><br></pre></td></tr></table></figure></li></ul><h2 id="十二、集成其他应用"><a href="#十二、集成其他应用" class="headerlink" title="十二、集成其他应用"></a>十二、集成其他应用</h2><h3 id="12-1-conflunce"><a href="#12-1-conflunce" class="headerlink" title="12.1  conflunce"></a>12.1  conflunce</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write by anonymous auth by * none</span><br><span class="line">olcAccess: &#123;1&#125;to attrs=shadowLastChange by self write by * read</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=example,dc=net&quot; by dn.base=&quot;cn=reader,dc=ibexample,dc=com&quot; read</span><br></pre></td></tr></table></figure><h4 id="12-1-1-连接-之后的-acl-过滤案例"><a href="#12-1-1-连接-之后的-acl-过滤案例" class="headerlink" title="12.1.1 连接 之后的 acl 过滤案例"></a>12.1.1 连接 之后的 acl 过滤案例</h4><p>‘(&amp;(objectclass&#x3D;inetorgperson)(|(cn&#x3D;user5)(cn&#x3D;user2)))’  过滤出指定用户—-在用户模式设置。</p><p>‘(&amp;(objectclass&#x3D;groupOfNames)(|(cn&#x3D;example-sys-junior)(cn&#x3D;example-sys-admin)))’ 过滤指定组—-在组模式设置（在ldap中创建的组 objectclass 是groupOfNames）</p><h4 id="12-1-2-更详细的-acl-需求"><a href="#12-1-2-更详细的-acl-需求" class="headerlink" title="12.1.2 更详细的 acl 需求"></a>12.1.2 更详细的 acl 需求</h4><ul><li><p>example</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write  by anonymous auth  by * none</span><br><span class="line">olcAccess: &#123;1&#125;to attrs=shadowLastChange by self write by * read</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=example,dc=net&quot; filter=&quot;(&amp;(objectClass=inetOrg</span><br><span class="line"> Person)(|(memberOf=cn=example-bod-admin,ou=example-bod,ou=example,dc=example,dc=net</span><br><span class="line"> )(memberOf=cn=example-sys-admin,ou=example-sys,ou=example,dc=example,dc=net)(member</span><br><span class="line"> Of=cn=example-ops-admin,ou=example-ops,ou=example,dc=example,dc=net)))&quot; by dn.base=</span><br><span class="line"> &quot;cn=reader,dc=ibexample,dc=com&quot; read  by dn.base= &quot;cn=reader,dc=example,dc=net&quot; read</span><br><span class="line"></span><br><span class="line">search时，必须要具体到用户层级，例如nextcloud，需要指定基础用户树如下</span><br><span class="line"></span><br><span class="line">cn=user2,ou=example-sys,ou=example,dc=example,dc=net</span><br><span class="line">cn=user1,ou=example-bod,ou=example,dc=example,dc=net</span><br><span class="line">cn=user6.tang,ou=example-ops,ou=example,dc=example,dc=net</span><br><span class="line">dc=ibexample,dc=com</span><br></pre></td></tr></table></figure></li><li><p>example</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword by self write by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write  by anonymous auth  by * none</span><br><span class="line">olcAccess: &#123;1&#125;to attrs=shadowLastChange by self write by * read</span><br><span class="line">olcAccess: &#123;2&#125;to dn.subtree=&quot;dc=ibexample,dc=com&quot; by dn.base=&quot;cn=admin,dc=example,dc=net&quot; write by dn.base=&quot;cn=reader,dc=ibexample,dc=com&quot; read</span><br></pre></td></tr></table></figure></li></ul><h3 id="12-2-集成-vault"><a href="#12-2-集成-vault" class="headerlink" title="12.2 集成 vault"></a>12.2 集成 vault</h3><ul><li>过滤特定用户<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(objectClass=inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;=&#123;&#123;.Username&#125;&#125;)(|(cn=user2)(cn=user1)(cn=%s)))</span><br></pre></td></tr></table></figure></li><li>过滤某个组<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(objectClass=inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;=&#123;&#123;.Username&#125;&#125;)(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net))</span><br></pre></td></tr></table></figure></li><li>过滤多个组<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(objectclass=inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;=&#123;&#123;.Username&#125;&#125;)(|(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net)(memberof=CN=example-dev-admin,OU=example-dev,OU=example,DC=example,DC=net)))</span><br></pre></td></tr></table></figure></li><li>过滤特定用户和特定组<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(objectclass=inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;=&#123;&#123;.Username&#125;&#125;)(|(|(cn=user4.li))(|(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net)(memberof=CN=example-dev-admin,OU=example-dev,OU=example,DC=example,DC=net))(cn=%s)))</span><br></pre></td></tr></table></figure></li><li>错误<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(objectClass=inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;=&#123;&#123;.Username&#125;&#125;)(|(cn=user2)(cn=user1))(cn=%s))  会失败</span><br><span class="line"></span><br><span class="line">以下 1 条，写在group filter的时候会出现不能过滤，所有人都可以登录</span><br><span class="line">(&amp;(objectclass=inetOrgPerson)(|(memberof=CN=example-sys-admin,OU=example-sys,OU=example,DC=example,DC=net)(memberof=CN=example-dev-admin,OU=example-dev,OU=example,DC=example,DC=net)))</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenLDAP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>这是一封信</title>
      <link href="/ops_blog/2023/10/18/zhe-shi-yi-feng-xin/"/>
      <url>/ops_blog/2023/10/18/zhe-shi-yi-feng-xin/</url>
      
        <content type="html"><![CDATA[<ul><li><p>邹漂亮，龙美丽好想你呀。</p></li><li><p>此后的你，便是我生命中的一系列的数字了。  </p></li><li><p>2023-10-2、2018-1-13、6月初二、15902317498、968746</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Personal </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mylove </tag>
            
            <tag> Personal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>deploy_hexo</title>
      <link href="/ops_blog/2023/10/15/deploy-hexo/"/>
      <url>/ops_blog/2023/10/15/deploy-hexo/</url>
      
        <content type="html"><![CDATA[<h2 id="1-安装-node-js、npm"><a href="#1-安装-node-js、npm" class="headerlink" title="1. 安装 node.js、npm"></a>1. 安装 node.js、npm</h2><ul><li>过程如此，但是包需要重新找，网页通过这个链接去官网然后复制下载链接即可，不然会安装hexo失败</li><li>由于node.js默认配置了npm，所以不用单独下载和配置npm了，只要node.js安装成功，那么是直接可以使用npm命令来下载moudle的<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://nodejs.org/dist/v12.16.1/node-v12.16.1-linux-x64.tar.xz</span><br><span class="line">tar tvf ./node-v12.16.1-linux-x64.tar.xz    # 查看压缩结构</span><br><span class="line">tar xvf ./node-v12.16.1-linux-x64.tar.xz -C /usr/local/</span><br><span class="line">ln -s /usr/local/node-v12.16.1-linux-x64/bin/node /usr/bin/node</span><br><span class="line">ln -s /usr/local/node-v12.16.1-linux-x64/bin/npm /usr/bin/npm</span><br></pre></td></tr></table></figure></li></ul><h2 id="2-安装-hexo-并初始化"><a href="#2-安装-hexo-并初始化" class="headerlink" title="2. 安装 hexo 并初始化"></a>2. 安装 hexo 并初始化</h2><ul><li>个人执行初始化失败，检查发现原因是hexo版本和nodejs版本不兼容，升级nodejs<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br><span class="line">ln -s /usr/local/node-v12.16.1-linux-x64/bin/hexo /usr/local/bin/hexo</span><br><span class="line">hexo init blog  # 这需要是一个你自己设计好的路径下的空文件夹</span><br><span class="line">hexo server  # 测试运行本工具，发布在本服务器4000端口</span><br></pre></td></tr></table></figure></li></ul><h2 id="3-hexo-主题"><a href="#3-hexo-主题" class="headerlink" title="3. hexo 主题"></a>3. hexo 主题</h2><p>因为某个站长接触到hexo，然后再对比之后觉得这个站点框架比较好，所以选择这个hexo，并直接根据这个帖子使用了这个<a href="http://blinkfox.com/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao">主题</a></p><h2 id="4-上传-github"><a href="#4-上传-github" class="headerlink" title="4. 上传 github"></a>4. 上传 github</h2><ul><li>同步到 github 远程仓库的步骤，请找专项的帖子，略</li><li>有个坑，themes 下的主题文件夹因为是 git clone 到这个路径的，其中有 ‘.git’ 目录信息，不能正常上传，<a href="https://blog.csdn.net/liaoweilin0529/article/details/113650333">解决办法</a>来源于这位</li></ul><h2 id="5-部署到-gh-pages-分支"><a href="#5-部署到-gh-pages-分支" class="headerlink" title="5. 部署到 gh-pages 分支"></a>5. 部署到 gh-pages 分支</h2><ul><li>借助了 hexo 的脚本和工具，将实现前端代码存在gh-pages分支，利用 github 的 pages 功能即可发布这个站点。源码和前端代码分别存在 main 和 gh-pages 分支</li><li>一键部署的<a href="https://hexo.io/zh-cn/docs/one-command-deployment.html">参考</a></li><li>再次测试图片应该放张图片的，但是github可以渲染，博客不能。。。。。。作为下一步需要搞懂的地方</li></ul><h2 id="6-访问"><a href="#6-访问" class="headerlink" title="6. 访问"></a>6. 访问</h2><p>去 action 查看url</p><h2 id="7-测试维护和书写流程"><a href="#7-测试维护和书写流程" class="headerlink" title="7. 测试维护和书写流程"></a>7. 测试维护和书写流程</h2><ul><li>新建一篇blog<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new &quot;filename&quot;</span><br></pre></td></tr></table></figure></li></ul><p>测试过程：<br>这是一篇测试用的帖子，学习使用 hexo、书写帖子、发布内容<br>目前出现的问题是没有内容<br>需要搞懂书写之后，应该怎么样推送或者命令发布<br>测试1，修改然后 clean &amp;&amp; deploy，然后push<br>测试2，先push 然后deploy<br>还要修改音乐模块<br>同步之后修改不成功<br>测试这次修改的流程，直接push—-main分支已经变化，但是gh-pages没有部署成功<br>修改+ clean + deploy —-网页已经变化，gh-pages变化，main分支代码无变化<br>修改+ clean + deploy  + push —- 完整的正常流程（源代码在main分支保存并修改，deploy将生成前端代码并发布到gh-pages）</p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> blog </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/ops_blog/2023/10/14/hello-world/"/>
      <url>/ops_blog/2023/10/14/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
